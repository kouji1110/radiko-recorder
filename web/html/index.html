<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>éŒ²éŸ³ãã‚“ - radikoéŒ²éŸ³ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="icon" href="img/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon">

    <!-- Eruda ãƒ‡ãƒãƒƒã‚°ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆã‚¹ãƒãƒ›ç”¨ï¼‰ -->
    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script>eruda.init();</script>

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 10px;
            margin: 0;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        header {
            background: #2c3e50;
            color: white;
            padding: 10px 15px;
        }

        header h1 {
            font-size: 1.2em;
            margin: 0;
        }

        header p {
            font-size: 0.75em;
            opacity: 0.9;
            margin: 0;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            padding: 0 15px;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 0.9em;
            font-weight: 600;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #495057;
            background: #e9ecef;
        }

        .tab.active {
            color: #2c3e50;
            border-bottom-color: #2c3e50;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .settings {
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 12px;
            margin-bottom: 10px;
            align-items: center;
        }

        .settings-grid .setting-group:nth-child(2) {
            grid-column: 1 / -1;
        }

        .setting-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .setting-group label {
            font-weight: 600;
            color: #495057;
            font-size: 0.75em;
            white-space: nowrap;
        }

        .setting-group input,
        .setting-group select {
            padding: 4px 8px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .setting-group input:focus,
        .setting-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 4px 12px;
            border: none;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .content {
            padding: 10px;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #6c757d;
            font-size: 1.2em;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #f5c6cb;
        }

        .program-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 6px;
        }

        .station-column {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            overflow: hidden;
        }

        .station-header {
            background: #667eea;
            color: white;
            padding: 6px 8px;
            font-weight: 700;
            font-size: 0.85em;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .station-programs {
            max-height: 600px;
            overflow-y: auto;
        }

        .program-card {
            background: white;
            border-bottom: 1px solid #f0f0f0;
            padding: 4px 6px;
            transition: background 0.1s;
            cursor: pointer;
        }

        .program-card:last-child {
            border-bottom: none;
        }

        .program-card:hover {
            background: #f8f9fa;
        }

        .program-card.now-playing {
            background: #fff9e6;
            border-left: 3px solid #ffc107;
        }

        .program-time {
            color: #667eea;
            font-weight: 700;
            font-size: 0.7em;
            margin-bottom: 2px;
        }

        .program-title {
            color: #212529;
            font-size: 0.8em;
            font-weight: 600;
            margin-bottom: 2px;
            line-height: 1.2;
        }

        .program-detail {
            color: #6c757d;
            font-size: 0.7em;
            margin-bottom: 3px;
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .program-actions {
            display: flex;
            gap: 2px;
            margin-top: 3px;
        }

        .btn-action {
            flex: 1;
            padding: 2px 4px;
            border: none;
            border-radius: 3px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.1s;
            font-size: 0.65em;
            white-space: nowrap;
        }

        .btn-cron {
            background: #28a745;
            color: white;
        }

        .btn-cron:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-download {
            background: #007bff;
            color: white;
        }

        .btn-download:hover {
            background: #0069d9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
        }

        .btn-at {
            background: #ffc107;
            color: #212529;
        }

        .btn-at:hover {
            background: #e0a800;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 193, 7, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease-out;
            overflow-y: auto;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºä¸­ã¯èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç„¡åŠ¹åŒ– */
        body.modal-open {
            overflow: hidden;
            position: fixed;
            width: 100%;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: white;
            padding: 0;
            border-radius: 16px;
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            overflow: hidden;
            animation: modalSlide 0.3s ease-out;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            position: relative;
            z-index: 10000;
            display: flex;
            flex-direction: column;
        }

        @keyframes modalSlide {
            from {
                transform: scale(0.95);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 28px;
            border-bottom: 1px solid #e9ecef;
            background: white;
            flex-shrink: 0;
        }

        .modal-header h2 {
            color: #212529;
            font-size: 1.3em;
            font-weight: 600;
            margin: 0;
        }

        .modal-close {
            background: #f8f9fa;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #6c757d;
            padding: 0;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .modal-close:hover {
            background: #e9ecef;
            color: #212529;
            transform: rotate(90deg);
        }

        .modal-body {
            overflow-y: auto;
            padding: 28px;
            flex: 1;
        }

        .command-box {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
            word-break: break-all;
            color: #495057;
        }

        /* ã‚³ãƒãƒ³ãƒ‰è¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆç•ªçµ„è©³ç´°ä»¥å¤–ï¼‰ */
        .command-box.command-display {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 16px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            padding: 20px 24px;
            border-top: 1px solid #e9ecef;
            background: #ffffff;
            flex-shrink: 0;
            flex-wrap: wrap;
        }

        .btn-execute {
            flex: 1;
            min-width: 140px;
            background: #27ae60;
            color: white;
            padding: 12px 20px;
            font-size: 0.95em;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            cursor: pointer;
        }

        .btn-execute:hover {
            background: #229954;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }

        .btn-execute:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .btn-execute:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            opacity: 0.6;
        }

        .btn-copy {
            flex: 1;
            min-width: 120px;
            background: #3498db;
            color: white;
            padding: 12px 20px;
            font-size: 0.95em;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            cursor: pointer;
        }

        .btn-copy:hover {
            background: #2980b9;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }

        .btn-copy:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .btn-close {
            flex: 0.8;
            min-width: 100px;
            background: #95a5a6;
            color: white;
            padding: 12px 20px;
            font-size: 0.95em;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            cursor: pointer;
        }

        .btn-close:hover {
            background: #7f8c8d;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }

        .btn-close:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* cronç™»éŒ²ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #registerCronBtn {
            flex: 1;
            min-width: 140px;
            background: #27ae60;
            color: white;
            padding: 12px 20px;
            font-size: 0.95em;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            cursor: pointer;
        }

        #registerCronBtn:hover {
            background: #229954;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }

        #registerCronBtn:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* ã‚¹ãƒãƒ›å¯¾å¿œ */
        @media (max-width: 600px) {
            .modal-actions {
                flex-wrap: wrap;
                padding: 15px;
                gap: 8px;
            }

            .btn-execute,
            .btn-copy,
            .btn-close,
            #registerCronBtn {
                min-width: calc(50% - 4px);
                padding: 10px 15px;
            }

            .btn-close {
                flex: 1;
                min-width: 100%;
            }
        }

        /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤ºç”¨CSS */
        #timelineView {
            background: #f8f9fa;
            min-height: 600px;
            overflow-x: auto;
            overflow-y: auto;
        }

        #timelineContainer {
            display: grid;
            gap: 0;
            background: white;
            min-width: max-content;
            width: max-content;
        }

        .timeline-time-column {
            position: sticky;
            left: 0;
            background: #2c3e50;
            color: white;
            z-index: 10;
            border-right: 2px solid #34495e;
        }

        .timeline-time-cell {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9em;
            border-bottom: 1px solid #34495e;
        }

        .timeline-station-header {
            position: sticky;
            top: 0;
            background: #ecf0f1;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 0.9em;
            color: #2c3e50;
            border-bottom: 2px solid #bdc3c7;
            z-index: 5;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            height: 52px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timeline-station-column {
            border-right: 1px solid #dee2e6;
            position: relative;
        }

        .timeline-program-cell {
            border-bottom: 1px solid #ecf0f1;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }

        .timeline-program-card {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 6px 8px;
            margin: 2px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: box-shadow 0.2s, height 0.3s;
            cursor: pointer;
        }

        .timeline-program-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        }

        .timeline-program-card.hover-expanded {
            z-index: 100;
            height: auto !important;
            overflow: visible;
        }

        .timeline-program-card.expanded {
            z-index: 200;
            transform: scale(1.5);
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            background: white;
            max-width: 300px;
            padding: 10px 12px;
        }

        .timeline-program-title {
            font-size: 0.9em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 2px;
            line-height: 1.3;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .timeline-program-card.narrow .timeline-program-title {
            -webkit-line-clamp: 1;
            font-size: 0.75em;
            line-height: 1.2;
        }

        .timeline-program-card.expanded .timeline-program-title {
            -webkit-line-clamp: unset;
            white-space: normal;
            font-size: 1em;
        }

        .timeline-program-time {
            font-size: 0.75em;
            color: #6c757d;
            white-space: nowrap;
            font-weight: 500;
        }

        .timeline-program-card.narrow .timeline-program-time {
            font-size: 0.7em;
        }

        .timeline-expand-hint {
            position: absolute;
            bottom: 2px;
            right: 4px;
            font-size: 0.7em;
            color: #3498db;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .timeline-program-card.narrow:hover .timeline-expand-hint {
            opacity: 1;
        }

        footer {
            background: #f8f9fa;
            padding: 6px;
            text-align: center;
            color: #6c757d;
            font-size: 0.7em;
            border-top: 1px solid #e9ecef;
        }

        /* ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§éè¡¨ç¤ºï¼‰ */
        .hamburger-menu {
            display: none;
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            padding: 8px;
            z-index: 1001;
        }

        .mobile-menu {
            display: none;
            position: fixed;
            top: 0;
            left: -100%;
            width: 80%;
            max-width: 300px;
            height: 100vh;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.3);
            z-index: 1000;
            transition: left 0.3s ease;
            overflow-y: auto;
        }

        .mobile-menu.active {
            left: 0;
        }

        .mobile-menu-header {
            background: #2c3e50;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mobile-menu-header h2 {
            margin: 0;
            font-size: 1.2em;
        }

        .mobile-menu-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mobile-menu-items {
            padding: 0;
            margin: 0;
            list-style: none;
        }

        .mobile-menu-item {
            border-bottom: 1px solid #e9ecef;
        }

        .mobile-menu-item button {
            width: 100%;
            padding: 15px 20px;
            background: none;
            border: none;
            text-align: left;
            font-size: 1em;
            cursor: pointer;
            color: #495057;
            transition: background 0.2s;
        }

        .mobile-menu-item button:hover {
            background: #f8f9fa;
        }

        .mobile-menu-item.active button {
            background: #ecf0f1;
            color: #2c3e50;
            font-weight: 600;
        }

        .menu-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .menu-overlay.active {
            display: block;
        }

        /* ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œãƒœã‚¿ãƒ³ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆPCè¡¨ç¤ºï¼‰ v2 */
        .file-actions-desktop {
            display: flex !important;
            gap: 8px;
            justify-content: center;
            align-items: center;
        }

        .file-actions-mobile {
            display: none !important;
        }

        @media (max-width: 480px) {
            body {
                padding: 0;
            }

            .container {
                border-radius: 0;
            }

            header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                position: sticky;
                top: 0;
                z-index: 200;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }

            header h1 {
                font-size: 1.2em;
            }

            header p {
                font-size: 0.7em;
            }

            /* ã‚¿ãƒ–ã‚’éè¡¨ç¤ºã«ã—ã¦ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º */
            .tabs {
                display: none;
            }

            .menu-toggle {
                display: block;
            }

            .mobile-menu {
                display: block;
            }

            /* æ”¾é€å±€ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã®ä½ç½®èª¿æ•´ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼åˆ†ï¼‰ */
            #stationSelector {
                top: 60px !important; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã•åˆ† */
            }

            /* è¨­å®šã‚¨ãƒªã‚¢ã®ã‚¹ãƒãƒ›å¯¾å¿œ */
            .settings {
                padding: 10px;
            }

            /* æ—¥ä»˜é¸æŠã®ã‚¹ãƒãƒ›å¯¾å¿œ: ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã€pickerã‚’è¡¨ç¤º */
            #dateButtons {
                display: none !important;
            }

            #datePicker {
                display: block !important;
                width: 100%;
            }

            /* è¨­å®šã‚°ãƒªãƒƒãƒ‰ã®ã‚¹ãƒãƒ›å¯¾å¿œ */
            .settings-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                align-items: end;
            }

            /* ã‚¨ãƒªã‚¢é¸æŠã¨æ—¥ä»˜ã‚’1è¡Œç›®ã«é…ç½® */
            .settings-grid .setting-group:nth-child(1) {
                grid-column: 1;
            }

            .settings-grid .setting-group:nth-child(2) {
                grid-column: 2;
            }

            /* æ¤œç´¢ã‚’2è¡Œç›®ã«é…ç½® */
            .settings-grid .setting-group:nth-child(3) {
                grid-column: 1 / -1;
            }

            /* è©³ç´°è¨­å®šãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º */
            .settings-grid .setting-group:nth-child(4) {
                display: none !important;
            }

            .setting-group {
                display: flex;
                flex-direction: column;
                gap: 4px;
            }

            .setting-group label {
                font-size: 0.75em;
                font-weight: 600;
                color: #495057;
                min-height: 16px;
                line-height: 16px;
            }

            .setting-group input,
            .setting-group select {
                width: 100%;
                padding: 8px;
                font-size: 0.9em;
                border: 1px solid #dee2e6;
                border-radius: 4px;
                height: 38px;
                box-sizing: border-box;
            }

            /* æ—¥ä»˜ãƒ”ãƒƒã‚«ãƒ¼ã®é«˜ã•ã‚’æƒãˆã‚‹ */
            #datePicker {
                height: 38px !important;
                box-sizing: border-box !important;
            }

            /* ã‚¨ãƒªã‚¢é¸æŠã®ãƒ©ãƒ™ãƒ«ã‚’çŸ­ã */
            .setting-group:nth-child(1) label::before {
                content: "ã‚¨ãƒªã‚¢:";
            }

            .setting-group:nth-child(1) label {
                font-size: 0;
            }

            .setting-group:nth-child(1) label::before {
                font-size: 0.75em;
            }

            /* æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒ•ãƒ«ãƒ¯ã‚¤ãƒ‰ã« */
            #searchKeyword {
                width: 100% !important;
            }

            .setting-group:nth-child(3) > div {
                width: 100%;
            }

            /* ãƒœã‚¿ãƒ³ã®ã‚¹ãƒãƒ›å¯¾å¿œ */
            .btn {
                padding: 10px 12px;
                font-size: 0.85em;
            }

            #fetchBtn, #searchAllBtn {
                display: block;
                width: 100%;
                margin: 8px 0 0 0 !important;
            }

            #fetchBtn {
                margin-top: 12px !important;
            }

            /* ã‚¹ãƒãƒ›ç”¨æ”¾é€å±€é¸æŠã‚’è¡¨ç¤º - DISABLED */

            /* ç•ªçµ„ã‚«ãƒ¼ãƒ‰ã®ã‚¹ãƒãƒ›å¯¾å¿œ - DISABLED */

            /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚³ãƒ³ãƒ†ãƒŠã®é«˜ã•åˆ¶é™ã‚’è§£é™¤ */
            .station-programs {
                max-height: none !important;
                overflow-y: visible !important;
            }

            .program-card {
                font-size: 1em;
                padding: 12px;
                margin-bottom: 2px;
                border-radius: 6px;
                border: 1px solid #e9ecef;
                box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            }

            .program-card:hover {
                background: white;
            }

            .program-card.now-playing {
                border-left: 4px solid #ffc107;
                background: #fff9e6;
            }

            .program-time {
                font-size: 0.85em;
                margin-bottom: 6px;
            }

            .program-title {
                font-size: 0.95em;
                margin-bottom: 10px;
                line-height: 1.4;
            }

            /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ç•ªçµ„è©³ç´°ã‚’éè¡¨ç¤º */
            .program-detail {
                display: none;
            }

            .program-actions {
                gap: 6px;
                flex-wrap: nowrap;
            }

            .btn-action {
                flex: 1;
                padding: 10px 8px;
                font-size: 0.8em;
                min-height: 40px;
                border-radius: 6px;
            }

            /* radikoãƒœã‚¿ãƒ³ã®ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ– */
            .program-actions a {
                min-width: 40px !important;
                min-height: 40px !important;
                width: 40px !important;
                height: 40px !important;
                padding: 0 !important;
                display: inline-flex !important;
                align-items: center !important;
                justify-content: center !important;
                border-radius: 6px !important;
            }

            .program-actions a img {
                width: 24px !important;
                height: 24px !important;
            }

            /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ãƒãƒ›å¯¾å¿œ */
            .modal-content {
                width: 95%;
                max-width: 95%;
                padding: 15px;
                margin: 10px;
            }

            .modal-header h2 {
                font-size: 1.1em;
            }

            .command-box {
                font-size: 0.75em;
                padding: 10px;
            }

            /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¹ãƒãƒ›å¯¾å¿œ */
            table {
                font-size: 0.8em;
            }

            th, td {
                padding: 8px 6px !important;
            }

            /* éŒ²éŸ³æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®ã‚¹ãƒãƒ›å¯¾å¿œ */
            #filesTab .content > div {
                padding: 10px !important;
            }

            #filesTab h2 {
                font-size: 1.1em !important;
            }

            #fileFilter {
                font-size: 0.9em !important;
                min-width: 100% !important;
            }

            /* ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ– - ã‚«ãƒ¼ãƒ‰å‹ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
            #filesList table {
                display: block;
            }

            #filesList thead {
                display: none;
            }

            #filesList tbody {
                display: block;
            }

            #filesList tbody tr {
                display: flex !important;
                flex-direction: row !important;
                align-items: center !important;
                gap: 12px !important;
                padding: 12px !important;
                margin-bottom: 8px !important;
                border: 1px solid #e9ecef !important;
                border-radius: 8px !important;
                background: white !important;
                box-shadow: 0 1px 3px rgba(0,0,0,0.08) !important;
            }

            #filesList tbody tr:hover {
                background: #f8f9fa !important;
            }

            /* ã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯åˆ—ï¼ˆ.artwork-columnã‚¯ãƒ©ã‚¹ã§æŒ‡å®šï¼‰ */
            #filesList tbody tr td.artwork-column {
                flex-shrink: 0 !important;
                padding: 0 !important;
            }

            #filesList tbody tr td.artwork-column img,
            #filesList tbody tr td.artwork-column > div {
                width: 48px !important;
                height: 48px !important;
                font-size: 28px !important;
                display: block !important;
            }

            /* ãƒ•ã‚¡ã‚¤ãƒ«ååˆ— - artworkåˆ—ã®æ¬¡ */
            #filesList tbody tr td.artwork-column + td {
                flex: 1 !important;
                min-width: 0 !important;
                display: flex !important;
                flex-direction: column !important;
                gap: 4px !important;
                padding: 0 !important;
            }

            /* ãƒ•ã‚¡ã‚¤ãƒ«åãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒ•ãƒ«è¡¨ç¤ºï¼ˆã‚¹ãƒãƒ›ï¼‰ */
            #filesList tbody tr td.artwork-column + td .file-name-text {
                white-space: normal !important;
                overflow: visible !important;
                text-overflow: clip !important;
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
                word-break: normal !important;
                line-height: 1.3 !important;
            }

            /* å†ç”Ÿé€²æ—ã‚’è¡¨ç¤ºï¼ˆãƒ¢ãƒã‚¤ãƒ«ã§ã‚‚è¦‹ãˆã‚‹ã‚ˆã†ã«ï¼‰ */
            #filesList tbody tr td.artwork-column + td > div:nth-child(2) {
                display: flex !important;
            }

            /* ãƒ¢ãƒã‚¤ãƒ«ç”¨æƒ…å ±ã‚’è¡¨ç¤ºï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ååˆ—ã®.mobile-infoï¼‰ */
            #filesList tbody tr td.artwork-column + td .mobile-info {
                display: block !important;
            }

            /* ä»–ã®å…¨ã¦ã®åˆ—ã‚’éè¡¨ç¤ºï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã€æ”¾é€æ—¥ã€ã‚µã‚¤ã‚ºã€æ›´æ–°æ—¥æ™‚ï¼‰ */
            #filesList tbody tr td:not(.artwork-column):not(.artwork-column + td):not(:last-child) {
                display: none !important;
            }

            /* æ“ä½œãƒœã‚¿ãƒ³ï¼ˆâ‹®ï¼‰ã‚’å³ç«¯ã«é…ç½® */
            #filesList tbody tr td:last-child {
                flex-shrink: 0;
            }

            #filesList tbody tr td:last-child button {
                font-size: 1.5em;
                padding: 4px 8px;
                background: transparent;
                border: none;
                color: #6c757d;
            }

            /* ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ– */
            #filesHeaderSection {
                /* æ¨ªä¸¦ã³ã‚’ç¶­æŒã—ã¦ãƒœã‚¿ãƒ³ã‚’å³å´ã«é…ç½® */
            }

            #filesHeaderSection h2 {
                font-size: 1em !important;
            }

            #filesHeaderButtons {
                width: 100% !important;
                gap: 6px !important;
            }

            #filesHeaderButtons button {
                flex: 1 !important;
                padding: 8px 4px !important;
                font-size: 0.7em !important;
                min-width: 0 !important;
            }

            /* ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®ãƒœã‚¿ãƒ³ç¾¤ã‚’ç¸¦ä¸¦ã³ã« */
            #filesList > div:first-child > div:first-child {
                flex-direction: column !important;
                align-items: stretch !important;
            }

            #filesList > div:first-child > div:first-child > * {
                width: 100% !important;
                margin: 4px 0 !important;
            }

            #filesList > div:first-child > div:nth-child(2) {
                flex-direction: column !important;
                align-items: stretch !important;
            }

            /* é¸æŠé–¢é€£ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’éè¡¨ç¤º */
            .file-selection-controls {
                display: none !important;
            }

            #filesList > div:first-child > div:nth-child(2) > button,
            #filesList > div:first-child > div:nth-child(2) > label {
                width: 100% !important;
                margin: 4px 0 !important;
                justify-content: center;
            }

            /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã‚«ãƒ¼ãƒ‰å½¢å¼ã« */
            #filesList table {
                display: block;
            }

            #filesList thead {
                display: none;
            }

            #filesList tbody {
                display: block;
            }

            #filesList tr {
                display: block;
                margin-bottom: 8px;
                border: 1px solid #dee2e6;
                border-radius: 6px;
                padding: 8px;
                background: white;
            }

            #filesList td {
                display: block;
                padding: 2px 0 !important;
                border: none !important;
                text-align: left !important;
            }

            /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼ˆé¸æŠï¼‰ã‚’éè¡¨ç¤º */
            #filesList td:first-child {
                display: none !important;
            }

            /* gapèª¿æ•´ï¼ˆã‚ˆã‚Šç‹­ãï¼‰ */
            #filesList tbody tr {
                gap: 10px !important;
            }

            /* ã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ã‚µã‚¤ã‚ºã‚’å°ã•ã */
            #filesList tbody tr td:nth-child(2) img,
            #filesList tbody tr td:nth-child(2) > div {
                width: 44px;
                height: 44px;
                font-size: 26px;
            }

            /* æ“ä½œãƒœã‚¿ãƒ³ã‚µã‚¤ã‚ºèª¿æ•´ */
            #filesList tbody tr td:last-child button {
                font-size: 1.3em;
                text-align: left !important;
            }

            #filesList td:last-child > div {
                display: flex !important;
                flex-direction: row !important;
                gap: 6px !important;
                justify-content: flex-start !important;
                align-items: center !important;
            }

            #filesList td:last-child button,
            #filesList td:last-child a {
                flex: 0 0 auto;
                text-align: center;
                padding: 4px !important;
                font-size: 0.8em !important;
            }

            /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³å†…ã®ç”»åƒã‚¢ã‚¤ã‚³ãƒ³ã‚’å°ã•ã */
            #filesList td:last-child button img,
            #filesList td:last-child a img {
                width: 18px !important;
                height: 18px !important;
            }

            /* è©³ç´°è¨­å®šã®ã‚¹ãƒãƒ›å¯¾å¿œ */
            #advancedSettings {
                padding: 10px;
            }

            /* éŸ³å£°ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¹ãƒãƒ›å¯¾å¿œ */
            .speed-btn {
                padding: 6px 10px !important;
                font-size: 0.75em !important;
            }

            /* ã‚«ãƒƒãƒˆç·¨é›†ãƒ‘ãƒãƒ«ã®ã‚¹ãƒãƒ›å¯¾å¿œ */
            #audioPlayerModal .modal-content {
                max-width: 95% !important;
            }

            #editPanel > div:first-child {
                flex-direction: column !important;
            }

            #editPanel button {
                font-size: 0.8em !important;
                padding: 10px 8px !important;
            }

            /* ã‚«ãƒƒãƒˆç·¨é›†ãƒ‘ãƒãƒ«ã‚’ã‚¹ãƒãƒ›ã§ã¯éè¡¨ç¤º */
            #editPanelContainer {
                display: none !important;
            }

            /* ã‚¹ãƒãƒ›ã§ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
            #audioPlayerModal .modal-content {
                padding: 0 !important;
                max-height: 90vh !important;
                overflow: hidden !important;
            }

            #audioPlayerModal .modal-content > div:last-child {
                padding: 15px !important;
                max-height: calc(90vh - 50px);
                overflow-y: auto;
            }

            /* ã‚¢ãƒ«ãƒãƒ ã‚¢ãƒ¼ãƒˆã‚’å°ã•ã */
            #audioPlayerModal .modal-content > div:last-child > div:first-child > div:first-child {
                width: 150px !important;
                height: 150px !important;
                margin-bottom: 10px !important;
            }

            #audioPlayerModal .modal-content > div:last-child > div:first-child > div:first-child > span {
                font-size: 60px !important;
            }

            /* ã‚¿ã‚¤ãƒˆãƒ«ã‚’å°ã•ã */
            #audioPlayerTitle {
                font-size: 0.9em !important;
                margin-bottom: 10px !important;
            }

            /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚’å°‘ã—å°ã•ã */
            #audioPlayerModal button[onclick*="skipAudio(-30)"],
            #audioPlayerModal button[onclick*="skipAudio(30)"] {
                width: 40px !important;
                height: 40px !important;
                font-size: 0.7em !important;
            }

            #audioPlayerModal button[onclick*="skipAudio(-10)"],
            #audioPlayerModal button[onclick*="skipAudio(10)"] {
                width: 45px !important;
                height: 45px !important;
                font-size: 0.8em !important;
            }

            #audioPlayerModal #playPauseBtn {
                width: 60px !important;
                height: 60px !important;
                font-size: 24px !important;
            }

            /* ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒ»é€Ÿåº¦ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
            #audioPlayerModal .modal-content > div:last-child > div:nth-child(4),
            #audioPlayerModal .modal-content > div:last-child > div:nth-child(5) {
                padding: 8px !important;
                margin-bottom: 8px !important;
            }

            #audioPlayerModal .modal-content label {
                font-size: 0.8em !important;
                min-width: 60px !important;
            }

            /* é€Ÿåº¦ãƒœã‚¿ãƒ³ã‚’å°ã•ã */
            #audioPlayerModal .speed-btn {
                padding: 3px 8px !important;
                font-size: 0.75em !important;
            }

            /* ãƒ•ãƒƒã‚¿ãƒ¼ã®ã‚¹ãƒãƒ›å¯¾å¿œ */
            footer {
                font-size: 0.65em;
                padding: 8px;
            }
        }

        /* ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
        #progressBar::-webkit-slider-thumb {
            appearance: none;
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.4);
            transition: all 0.2s;
        }

        #progressBar::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.6);
        }

        #progressBar::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.4);
            transition: all 0.2s;
        }

        #progressBar::-moz-range-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.6);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>ğŸ“» éŒ²éŸ³ãã‚“</h1>
                <p>å…¨å›½47éƒ½é“åºœçœŒã®ãƒ©ã‚¸ã‚ªç•ªçµ„ã‚’æ¤œç´¢ãƒ»éŒ²éŸ³äºˆç´„</p>
            </div>
            <button class="menu-toggle" onclick="toggleMobileMenu()">â˜°</button>
        </header>

        <!-- ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
        <div class="menu-overlay" id="menuOverlay" onclick="closeMobileMenu()"></div>
        <nav class="mobile-menu" id="mobileMenu">
            <div class="mobile-menu-header">
                <h2>ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
                <button class="mobile-menu-close" onclick="closeMobileMenu()">Ã—</button>
            </div>
            <ul class="mobile-menu-items">
                <li class="mobile-menu-item active" data-tab="search">
                    <button onclick="switchTabMobile('search')">ğŸ“» ç•ªçµ„æ¤œç´¢</button>
                </li>
                <li class="mobile-menu-item" data-tab="files">
                    <button onclick="switchTabMobile('files')">ğŸ“ éŒ²éŸ³æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«</button>
                </li>
                <li class="mobile-menu-item" data-tab="at">
                    <button onclick="switchTabMobile('at')">â±ï¸ ç•ªçµ„äºˆç´„ç®¡ç†</button>
                </li>
                <li class="mobile-menu-item" data-tab="cron">
                    <button onclick="switchTabMobile('cron')">â° å®šæœŸéŒ²éŸ³ç®¡ç†</button>
                </li>
                <li class="mobile-menu-item" data-tab="admin">
                    <button onclick="switchTabMobile('admin')">ğŸ”§ ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
                </li>
                <li class="mobile-menu-item" style="border-top: 2px solid #dee2e6; margin-top: 10px;">
                    <button onclick="logout()" style="color: #dc3545;">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </li>
            </ul>
        </nav>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('search')">ğŸ“» ç•ªçµ„æ¤œç´¢</button>
            <button class="tab" onclick="switchTab('files')">ğŸ“ éŒ²éŸ³æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«</button>
            <button class="tab" onclick="switchTab('at')">â±ï¸ ç•ªçµ„äºˆç´„ç®¡ç†</button>
            <button class="tab" onclick="switchTab('cron')">â° å®šæœŸéŒ²éŸ³ç®¡ç†</button>
            <button class="tab" onclick="switchTab('admin')">ğŸ”§ ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
        </div>

        <!-- ç•ªçµ„æ¤œç´¢ã‚¿ãƒ– -->
        <div id="searchTab" class="tab-content active">
            <div class="settings">
            <div class="settings-grid">
                <div class="setting-group">
                    <label for="areaId">ã‚¨ãƒªã‚¢ã‚’é¸æŠ:</label>
                    <select id="areaId">
                        <option value="JP1">åŒ—æµ·é“</option>
                        <option value="JP2">é’æ£®çœŒ</option>
                        <option value="JP3">å²©æ‰‹çœŒ</option>
                        <option value="JP4">å®®åŸçœŒ</option>
                        <option value="JP5">ç§‹ç”°çœŒ</option>
                        <option value="JP6">å±±å½¢çœŒ</option>
                        <option value="JP7">ç¦å³¶çœŒ</option>
                        <option value="JP8">èŒ¨åŸçœŒ</option>
                        <option value="JP9">æ ƒæœ¨çœŒ</option>
                        <option value="JP10">ç¾¤é¦¬çœŒ</option>
                        <option value="JP11">åŸ¼ç‰çœŒ</option>
                        <option value="JP12">åƒè‘‰çœŒ</option>
                        <option value="JP13">æ±äº¬éƒ½</option>
                        <option value="JP14">ç¥å¥ˆå·çœŒ</option>
                        <option value="JP15">æ–°æ½ŸçœŒ</option>
                        <option value="JP16">å¯Œå±±çœŒ</option>
                        <option value="JP17">çŸ³å·çœŒ</option>
                        <option value="JP18">ç¦äº•çœŒ</option>
                        <option value="JP19">å±±æ¢¨çœŒ</option>
                        <option value="JP20">é•·é‡çœŒ</option>
                        <option value="JP21">å²é˜œçœŒ</option>
                        <option value="JP22">é™å²¡çœŒ</option>
                        <option value="JP23">æ„›çŸ¥çœŒ</option>
                        <option value="JP24">ä¸‰é‡çœŒ</option>
                        <option value="JP25">æ»‹è³€çœŒ</option>
                        <option value="JP26">äº¬éƒ½åºœ</option>
                        <option value="JP27">å¤§é˜ªåºœ</option>
                        <option value="JP28">å…µåº«çœŒ</option>
                        <option value="JP29">å¥ˆè‰¯çœŒ</option>
                        <option value="JP30">å’Œæ­Œå±±çœŒ</option>
                        <option value="JP31">é³¥å–çœŒ</option>
                        <option value="JP32">å³¶æ ¹çœŒ</option>
                        <option value="JP33">å²¡å±±çœŒ</option>
                        <option value="JP34">åºƒå³¶çœŒ</option>
                        <option value="JP35">å±±å£çœŒ</option>
                        <option value="JP36">å¾³å³¶çœŒ</option>
                        <option value="JP37">é¦™å·çœŒ</option>
                        <option value="JP38">æ„›åª›çœŒ</option>
                        <option value="JP39">é«˜çŸ¥çœŒ</option>
                        <option value="JP40">ç¦å²¡çœŒ</option>
                        <option value="JP41">ä½è³€çœŒ</option>
                        <option value="JP42">é•·å´çœŒ</option>
                        <option value="JP43">ç†Šæœ¬çœŒ</option>
                        <option value="JP44">å¤§åˆ†çœŒ</option>
                        <option value="JP45">å®®å´çœŒ</option>
                        <option value="JP46">é¹¿å…å³¶çœŒ</option>
                        <option value="JP47">æ²–ç¸„çœŒ</option>
                    </select>
                </div>

                <div class="setting-group">
                    <div id="dateButtons" style="display: flex; gap: 4px; flex-wrap: wrap;">
                        <!-- æ—¥ä»˜ãƒœã‚¿ãƒ³ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                    </div>
                    <!-- ã‚¹ãƒãƒ›ç”¨ã®æ—¥ä»˜ãƒ”ãƒƒã‚«ãƒ¼ -->
                    <input type="date" id="datePicker" style="display: none; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 0.9em;">
                    <input type="hidden" id="targetDate" value="">
                </div>

                <div class="setting-group">
                    <label for="searchKeyword">çµã‚Šè¾¼ã¿:</label>
                    <div style="position: relative; display: inline-block;">
                        <input type="text" id="searchKeyword" placeholder="ç•ªçµ„åã§ãƒ•ã‚£ãƒ«ã‚¿" style="width: 150px; padding-right: 25px;">
                        <button id="clearSearchBtn" onclick="clearSearchKeyword()"
                                style="position: absolute; right: 4px; top: 50%; transform: translateY(-50%); background: transparent; border: none; color: #999; cursor: pointer; padding: 2px 6px; font-size: 1.1em; display: none;"
                                onmouseover="this.style.color='#333'" onmouseout="this.style.color='#999'">
                            Ã—
                        </button>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                <button id="fetchBtn" class="btn btn-primary">ç•ªçµ„è¡¨ã‚’æ›´æ–°</button>
                <button id="searchAllBtn" class="btn btn-primary">å…¨ã‚¨ãƒªã‚¢ã‹ã‚‰æ¤œç´¢</button>

                <div style="margin-left: auto; display: flex; gap: 8px; align-items: center;">
                    <span style="font-size: 0.9em; font-weight: 600; color: #495057;">è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰:</span>
                    <button id="listViewBtn" onclick="switchViewMode('list')" class="btn" style="background: #27ae60; color: white; min-width: 100px;">ğŸ“‹ ãƒªã‚¹ãƒˆ</button>
                    <button id="timelineViewBtn" onclick="switchViewMode('timeline')" class="btn" style="background: #95a5a6; color: white; min-width: 120px;">ğŸ“º ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</button>
                </div>
            </div>
        </div>

            <div class="content">
                <div id="loading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>ç•ªçµ„è¡¨ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
                <div id="error" class="error" style="display: none;"></div>
                <div id="searchInfo" style="padding: 8px; font-size: 0.85em; color: #6c757d; display: none;"></div>

                <!-- å…¨ã‚¨ãƒªã‚¢æ¤œç´¢çµæœè¡¨ç¤ºä¸­ã®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
                <div id="searchResultsIndicator" style="display: none; padding: 12px; background: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 6px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.1em;">ğŸ”</span>
                            <span style="font-weight: 600; color: #0056b3;">å…¨ã‚¨ãƒªã‚¢æ¤œç´¢çµæœã‚’è¡¨ç¤ºä¸­</span>
                        </div>
                        <button onclick="returnToAreaPrograms()" class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.85em; white-space: nowrap;">
                            â† ç•ªçµ„è¡¨ã«æˆ»ã‚‹
                        </button>
                    </div>
                </div>

                <!-- ã‚¹ãƒãƒ›ç”¨ã®æ”¾é€å±€é¸æŠ -->
                <div id="stationSelector" style="display: none; padding: 10px; background: #f8f9fa; border-bottom: 2px solid #dee2e6; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <label for="mobileStationSelect" style="font-size: 0.85em; font-weight: 600; color: #495057; display: block; margin-bottom: 6px;">ğŸ“» æ”¾é€å±€ã‚’é¸æŠ:</label>
                    <select id="mobileStationSelect" style="width: 100%; padding: 10px; font-size: 0.9em; border: 1px solid #dee2e6; border-radius: 4px;">
                        <option value="">-- æ”¾é€å±€ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>
                    </select>
                </div>

                <!-- ãƒªã‚¹ãƒˆè¡¨ç¤º -->
                <div id="programList" class="program-list"></div>

                <!-- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤º -->
                <div id="timelineView" style="display: none; overflow-x: auto; overflow-y: auto;">
                    <div id="timelineContainer"></div>
                </div>
            </div>
        </div>

        <!-- éŒ²éŸ³æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ãƒ– -->
        <div id="filesTab" class="tab-content">
            <div class="content">
                <div style="padding: 12px; background: white;">
                    <div id="filesHeaderSection" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid #e9ecef;">
                        <h2 style="margin: 0; font-size: 1.1em; color: #212529; font-weight: 600;">ğŸ“ éŒ²éŸ³ãƒ•ã‚¡ã‚¤ãƒ«</h2>
                        <div style="position: relative;">
                            <button onclick="toggleFilesMenu(event)"
                                    style="padding: 5px 12px; background: white; color: #495057; border: 1.5px solid #dee2e6; border-radius: 6px; cursor: pointer; font-size: 1em; transition: all 0.2s;"
                                    onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                                â‹®
                            </button>
                            <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ -->
                            <div id="filesMenuDropdown" style="display: none; position: absolute; right: 0; top: calc(100% + 4px); background: white; border: 1px solid #dee2e6; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; min-width: 180px;">
                                <div style="padding: 4px 0;">
                                    <button onclick="loadRecordedFiles(); toggleFilesMenu();"
                                            style="width: 100%; text-align: left; padding: 10px 16px; background: none; border: none; cursor: pointer; font-size: 0.9em; color: #212529; transition: background 0.2s; display: flex; align-items: center; gap: 8px;"
                                            onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='none'">
                                        <span>ğŸ”„</span><span>æ›´æ–°</span>
                                    </button>
                                    <button onclick="showCreateFolderModal(); toggleFilesMenu();"
                                            style="width: 100%; text-align: left; padding: 10px 16px; background: none; border: none; cursor: pointer; font-size: 0.9em; color: #212529; transition: background 0.2s; display: flex; align-items: center; gap: 8px;"
                                            onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='none'">
                                        <span>ğŸ“‚</span><span>æ–°è¦ãƒ•ã‚©ãƒ«ãƒ€</span>
                                    </button>
                                    <div style="height: 1px; background: #e9ecef; margin: 4px 0;"></div>
                                    <button onclick="clearAllBookmarks(); toggleFilesMenu();"
                                            style="width: 100%; text-align: left; padding: 10px 16px; background: none; border: none; cursor: pointer; font-size: 0.9em; color: #212529; transition: background 0.2s; display: flex; align-items: center; gap: 8px;"
                                            onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='none'">
                                        <span>ğŸ—‘ï¸</span><span>å†ç”Ÿå±¥æ­´ãƒªã‚»ãƒƒãƒˆ</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆã¨æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
                    <div id="breadcrumb" style="display: none; margin-bottom: 10px;">
                        <button onclick="navigateUp()"
                                style="display: flex; align-items: center; gap: 10px; width: 100%; padding: 10px 12px; background: #f8f9fa; color: #495057; border: 1px solid #dee2e6; border-radius: 6px; cursor: pointer; font-size: 0.9em; transition: all 0.2s;"
                                onmouseover="this.style.background='#e9ecef'"
                                onmouseout="this.style.background='#f8f9fa'">
                            <span style="font-size: 1.2em; color: #667eea;">â†</span>
                            <div style="flex: 1; text-align: left;">
                                <div id="breadcrumbPath" style="font-size: 0.75em; color: #6c757d; margin-bottom: 2px; display: flex; align-items: center; gap: 4px; flex-wrap: wrap;">
                                    <!-- ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                                </div>
                                <div style="font-size: 0.9em; color: #212529; font-weight: 600;">ä¸Šã®éšå±¤ã¸</div>
                            </div>
                        </button>
                    </div>

                    <div id="filesLoading" class="loading" style="display: none;">
                        <div class="spinner"></div>
                        <p>ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                    <div id="filesList"></div>
                </div>
            </div>
        </div>

        <!-- cronç®¡ç†ã‚¿ãƒ– -->
        <div id="cronTab" class="tab-content">
            <div class="content">
                <div style="padding: 15px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e9ecef;">
                        <h2 style="margin: 0; font-size: 1.3em; color: #212529;">â° å®šæœŸéŒ²éŸ³ç®¡ç†</h2>
                        <button class="btn btn-primary" onclick="loadCronJobs()" style="padding: 6px 16px; font-size: 0.9em;">ğŸ”„ æ›´æ–°</button>
                    </div>
                    <div id="cronLoading" class="loading" style="display: none;">
                        <div class="spinner"></div>
                        <p>cronä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                    <div id="cronList"></div>
                </div>
            </div>
        </div>

        <!-- atäºˆç´„ã‚¿ãƒ– -->
        <div id="atTab" class="tab-content">
            <div class="content">
                <div style="padding: 15px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e9ecef;">
                        <h2 style="margin: 0; font-size: 1.3em; color: #212529;">â±ï¸ ç•ªçµ„äºˆç´„ç®¡ç†</h2>
                        <button class="btn btn-primary" onclick="loadAtJobs()" style="padding: 6px 16px; font-size: 0.9em;">ğŸ”„ æ›´æ–°</button>
                    </div>
                    <div id="atLoading" class="loading" style="display: none;">
                        <div class="spinner"></div>
                        <p>atäºˆç´„ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                    <div id="atList"></div>
                </div>
            </div>
        </div>

        <!-- ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¿ãƒ– -->
        <div id="adminTab" class="tab-content">
            <div class="content">
                <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ç”»é¢ -->
                <div id="adminAuth" style="padding: 40px; background: white; text-align: center;">
                    <h2 style="margin-bottom: 20px; color: #212529;">ğŸ” ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
                    <p style="margin-bottom: 20px; color: #6c757d;">ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                    <div style="max-width: 300px; margin: 0 auto;">
                        <input type="password" id="adminPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
                               style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; margin-bottom: 15px;"
                               onkeypress="if(event.key==='Enter') authenticateAdmin()">
                        <button onclick="authenticateAdmin()"
                                style="width: 100%; padding: 10px 20px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em;">
                            ãƒ­ã‚°ã‚¤ãƒ³
                        </button>
                    </div>
                </div>

                <!-- ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼æœ¬ä½“ï¼ˆèªè¨¼å¾Œã«è¡¨ç¤ºï¼‰ -->
                <div id="adminPanel" style="display: none; padding: 15px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e9ecef;">
                        <h2 style="margin: 0; font-size: 1.3em; color: #212529;">ğŸ”§ ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
                        <button onclick="logoutAdmin()" style="padding: 6px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                    </div>

                    <!-- è©³ç´°è¨­å®š -->
                    <div style="margin-bottom: 25px; padding: 15px; border: 1px solid #e9ecef; border-radius: 4px; background: #f8f9fa;">
                        <h3 style="margin: 0 0 15px 0; font-size: 1.1em; color: #212529;">âš™ï¸ è©³ç´°è¨­å®š</h3>
                        <div style="display: grid; gap: 15px;">
                            <div>
                                <label for="proxyUrl" style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057; font-size: 0.9em;">ãƒ—ãƒ­ã‚­ã‚·URL</label>
                                <input type="text" id="proxyUrl" value="" placeholder="ç©ºæ¬„ã§OKï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: /apiï¼‰" style="width: 100%; max-width: 400px; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                <p style="margin: 5px 0 0 0; color: #6c757d; font-size: 0.85em;">radikoãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã®URLã€‚é€šå¸¸ã¯å¤‰æ›´ä¸è¦ã§ã™ã€‚</p>
                            </div>

                            <div>
                                <label for="scriptPath" style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057; font-size: 0.9em;">myradikoã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ‘ã‚¹</label>
                                <input type="text" id="scriptPath" value="/app/script/myradiko" placeholder="/app/script/myradiko" style="width: 100%; max-width: 400px; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                <p style="margin: 5px 0 0 0; color: #6c757d; font-size: 0.85em;">myradikoéŒ²éŸ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ‘ã‚¹ã€‚ç’°å¢ƒã«å¿œã˜ã¦å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚</p>
                            </div>
                        </div>
                    </div>

                    <!-- DBç•ªçµ„è¡¨ä¸€æ‹¬æ›´æ–° -->
                    <div style="margin-bottom: 25px; padding: 15px; border: 1px solid #e9ecef; border-radius: 4px;">
                        <h3 style="margin: 0 0 10px 0; font-size: 1.1em; color: #212529;">ğŸ“Š DBç•ªçµ„è¡¨ä¸€æ‹¬æ›´æ–°</h3>
                        <p style="margin: 0 0 10px 0; color: #6c757d; font-size: 0.9em;">å…¨ã‚¨ãƒªã‚¢ã®ç•ªçµ„è¡¨ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å–å¾—ãƒ»æ›´æ–°ã—ã¾ã™ï¼ˆæ·±å¤œãƒãƒƒãƒå‡¦ç†ç›¸å½“ï¼‰</p>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="updateDays" style="padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                <option value="1">ä»Šæ—¥ã®ã¿</option>
                                <option value="2">2æ—¥åˆ† (ä»Šæ—¥+æ˜æ—¥)</option>
                                <option value="3" selected>3æ—¥åˆ†</option>
                                <option value="7">7æ—¥åˆ†</option>
                            </select>
                            <button onclick="updateAllPrograms()" class="btn btn-primary" style="background: #007bff;">
                                ğŸ”„ ä¸€æ‹¬æ›´æ–°é–‹å§‹ (é€²æ—è¡¨ç¤º)
                            </button>
                        </div>
                        <p style="margin: 10px 0 0 0; color: #6c757d; font-size: 0.85em;">
                            âš ï¸ é€²æ—ã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‹ã„ãŸã¾ã¾ã«ã—ã¦ãã ã•ã„ã€‚<br>
                            ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œã™ã‚‹å ´åˆã¯ã€æ·±å¤œ3æ™‚ã®è‡ªå‹•å®Ÿè¡Œã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚
                        </p>
                        <div id="updateProgress" style="margin-top: 10px; display: none;">
                            <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
                            <div style="margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span id="updateProgressText" style="font-weight: 600; color: #495057; font-size: 0.9em;">æº–å‚™ä¸­...</span>
                                    <span id="updateProgressPercent" style="font-weight: 600; color: #007bff; font-size: 0.9em;">0%</span>
                                </div>
                                <div style="width: 100%; height: 24px; background: #e9ecef; border-radius: 12px; overflow: hidden; position: relative;">
                                    <div id="updateProgressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #007bff, #0056b3); transition: width 0.3s ease; display: flex; align-items: center; justify-content: center;">
                                        <span id="updateProgressBarText" style="color: white; font-size: 0.8em; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.3);"></span>
                                    </div>
                                </div>
                                <div style="margin-top: 5px; font-size: 0.85em; color: #6c757d;" id="updateProgressDetail">å¾…æ©Ÿä¸­...</div>
                            </div>
                            <!-- çµ±è¨ˆæƒ…å ± -->
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px;">
                                <div style="background: #d4edda; padding: 8px; border-radius: 4px; text-align: center; border: 1px solid #c3e6cb;">
                                    <div style="font-size: 0.75em; color: #155724; font-weight: 600;">âœ… æˆåŠŸ</div>
                                    <div style="font-size: 1.2em; font-weight: bold; color: #155724;" id="updateSuccessCount">0</div>
                                </div>
                                <div style="background: #f8d7da; padding: 8px; border-radius: 4px; text-align: center; border: 1px solid #f5c6cb;">
                                    <div style="font-size: 0.75em; color: #721c24; font-weight: 600;">âŒ ã‚¨ãƒ©ãƒ¼</div>
                                    <div style="font-size: 1.2em; font-weight: bold; color: #721c24;" id="updateErrorCount">0</div>
                                </div>
                                <div style="background: #fff3cd; padding: 8px; border-radius: 4px; text-align: center; border: 1px solid #ffeaa7;">
                                    <div style="font-size: 0.75em; color: #856404; font-weight: 600;">âš ï¸ è­¦å‘Š</div>
                                    <div style="font-size: 1.2em; font-weight: bold; color: #856404;" id="updateWarningCount">0</div>
                                </div>
                            </div>
                            <!-- ãƒ­ã‚°è¡¨ç¤º -->
                            <details open style="margin-bottom: 10px;">
                                <summary style="cursor: pointer; padding: 8px; background: #e9ecef; border-radius: 4px; font-weight: 600; user-select: none;">
                                    ğŸ“‹ è©³ç´°ãƒ­ã‚°
                                </summary>
                                <div style="background: #212529; color: #e9ecef; padding: 12px; border-radius: 4px; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.8em; max-height: 300px; overflow-y: auto; margin-top: 5px; line-height: 1.6;" id="updateLog"></div>
                            </details>
                        </div>
                    </div>

                    <!-- æ‰‹å‹•ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ -->
                    <div style="margin-bottom: 25px; padding: 15px; border: 1px solid #e9ecef; border-radius: 4px;">
                        <h3 style="margin: 0 0 10px 0; font-size: 1.1em; color: #212529;">âš¡ æ‰‹å‹•myradikoã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ</h3>
                        <p style="margin: 0 0 10px 0; color: #6c757d; font-size: 0.9em;">ç•ªçµ„è¡¨ã‚’çµŒç”±ã›ãšã«ç›´æ¥éŒ²éŸ³ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™</p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <div style="grid-column: 1 / -1;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057; font-size: 0.9em;">ç•ªçµ„å</label>
                                <input type="text" id="manualTitle" placeholder="ä¾‹: ãƒ©ã‚¸ã‚ªãƒ‹ãƒ¥ãƒ¼ã‚¹" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057; font-size: 0.9em;">ã‚¨ãƒªã‚¢</label>
                                <select id="manualArea" onchange="updateManualStations()" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                    <option value="">ã‚¨ãƒªã‚¢ã‚’é¸æŠ</option>
                                    <option value="JP13">æ±äº¬éƒ½</option>
                                    <option value="JP14">ç¥å¥ˆå·çœŒ</option>
                                    <option value="JP27">å¤§é˜ªåºœ</option>
                                    <option value="JP1">åŒ—æµ·é“</option>
                                    <option value="JP2">é’æ£®çœŒ</option>
                                    <option value="JP3">å²©æ‰‹çœŒ</option>
                                    <option value="JP4">å®®åŸçœŒ</option>
                                    <option value="JP5">ç§‹ç”°çœŒ</option>
                                    <option value="JP6">å±±å½¢çœŒ</option>
                                    <option value="JP7">ç¦å³¶çœŒ</option>
                                    <option value="JP8">èŒ¨åŸçœŒ</option>
                                    <option value="JP9">æ ƒæœ¨çœŒ</option>
                                    <option value="JP10">ç¾¤é¦¬çœŒ</option>
                                    <option value="JP11">åŸ¼ç‰çœŒ</option>
                                    <option value="JP12">åƒè‘‰çœŒ</option>
                                    <option value="JP15">æ–°æ½ŸçœŒ</option>
                                    <option value="JP16">å¯Œå±±çœŒ</option>
                                    <option value="JP17">çŸ³å·çœŒ</option>
                                    <option value="JP18">ç¦äº•çœŒ</option>
                                    <option value="JP19">å±±æ¢¨çœŒ</option>
                                    <option value="JP20">é•·é‡çœŒ</option>
                                    <option value="JP21">å²é˜œçœŒ</option>
                                    <option value="JP22">é™å²¡çœŒ</option>
                                    <option value="JP23">æ„›çŸ¥çœŒ</option>
                                    <option value="JP24">ä¸‰é‡çœŒ</option>
                                    <option value="JP25">æ»‹è³€çœŒ</option>
                                    <option value="JP26">äº¬éƒ½åºœ</option>
                                    <option value="JP28">å…µåº«çœŒ</option>
                                    <option value="JP29">å¥ˆè‰¯çœŒ</option>
                                    <option value="JP30">å’Œæ­Œå±±çœŒ</option>
                                    <option value="JP31">é³¥å–çœŒ</option>
                                    <option value="JP32">å³¶æ ¹çœŒ</option>
                                    <option value="JP33">å²¡å±±çœŒ</option>
                                    <option value="JP34">åºƒå³¶çœŒ</option>
                                    <option value="JP35">å±±å£çœŒ</option>
                                    <option value="JP36">å¾³å³¶çœŒ</option>
                                    <option value="JP37">é¦™å·çœŒ</option>
                                    <option value="JP38">æ„›åª›çœŒ</option>
                                    <option value="JP39">é«˜çŸ¥çœŒ</option>
                                    <option value="JP40">ç¦å²¡çœŒ</option>
                                    <option value="JP41">ä½è³€çœŒ</option>
                                    <option value="JP42">é•·å´çœŒ</option>
                                    <option value="JP43">ç†Šæœ¬çœŒ</option>
                                    <option value="JP44">å¤§åˆ†çœŒ</option>
                                    <option value="JP45">å®®å´çœŒ</option>
                                    <option value="JP46">é¹¿å…å³¶çœŒ</option>
                                    <option value="JP47">æ²–ç¸„çœŒ</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057; font-size: 0.9em;">æ”¾é€å±€</label>
                                <select id="manualStation" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                    <option value="">ã¾ãšã‚¨ãƒªã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057; font-size: 0.9em;">ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚åˆ»ï¼ˆäºˆç´„å®Ÿè¡Œæ™‚é–“ï¼‰</label>
                                <input type="datetime-local" id="manualExecuteTime" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                <small style="color: #6c757d; font-size: 0.8em;">at ã‚³ãƒãƒ³ãƒ‰ã§ã“ã®æ™‚åˆ»ã«å®Ÿè¡Œã•ã‚Œã¾ã™</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057; font-size: 0.9em;">éŒ²éŸ³é–‹å§‹æ—¥æ™‚</label>
                                <input type="datetime-local" id="manualStart" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                <small style="color: #6c757d; font-size: 0.8em;">å®Ÿéš›ã«éŒ²éŸ³ãŒé–‹å§‹ã•ã‚Œã‚‹æ™‚åˆ»</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057; font-size: 0.9em;">éŒ²éŸ³çµ‚äº†æ—¥æ™‚</label>
                                <input type="datetime-local" id="manualEnd" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                <small style="color: #6c757d; font-size: 0.8em;">æ—¥ä»˜ã‚’è·¨ãå ´åˆã‚‚æŒ‡å®šå¯èƒ½</small>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button onclick="executeManualCommand()" class="btn btn-primary" style="background: #dc3545; color: white;">
                                â–¶ï¸ å³åº§ã«å®Ÿè¡Œ
                            </button>
                            <button onclick="scheduleManualCommand()" class="btn" style="background: #007bff; color: white;">
                                â° atäºˆç´„ï¼ˆã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚åˆ»ã«å®Ÿè¡Œï¼‰
                            </button>
                            <button onclick="copyManualCommand()" class="btn" style="background: #6c757d; color: white;">
                                ğŸ“‹ ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
                            </button>
                        </div>
                        <div id="manualCommandPreview" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; font-family: monospace; font-size: 0.85em; display: none; white-space: pre-wrap;"></div>
                        <div id="manualOutput" style="margin-top: 10px; display: none;">
                            <div style="background: #212529; color: #0f0; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 0.85em; max-height: 300px; overflow-y: auto; white-space: pre-wrap;" id="manualLog"></div>
                        </div>
                    </div>

                    <!-- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®š -->
                    <div style="margin-bottom: 25px; padding: 15px; border: 1px solid #e9ecef; border-radius: 4px;">
                        <h3 style="margin: 0 0 10px 0; font-size: 1.1em; color: #212529;">ğŸ¨ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®š</h3>
                        <p style="margin: 0 0 15px 0; color: #6c757d; font-size: 0.9em;">
                            ã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ãŒç™»éŒ²ã•ã‚Œã¦ã„ãªã„ç•ªçµ„ã§è¡¨ç¤ºã•ã‚Œã‚‹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”»åƒã‚’è¨­å®šã§ãã¾ã™
                        </p>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="flex-shrink: 0;">
                                <img id="defaultArtworkPreview" src="" alt="Default Artwork"
                                     style="width: 120px; height: 120px; border-radius: 8px; object-fit: cover; box-shadow: 0 2px 8px rgba(0,0,0,0.2);"
                                     onerror="this.src='img/jacket.png'">
                            </div>
                            <div style="flex: 1;">
                                <button onclick="openDefaultArtworkUpload()" class="btn btn-primary" style="background: #667eea;">
                                    ğŸ“¤ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”»åƒã‚’å¤‰æ›´
                                </button>
                                <div style="margin-top: 8px; font-size: 0.85em; color: #6c757d;">
                                    æ¨å¥¨ã‚µã‚¤ã‚º: 512Ã—512pxä»¥ä¸Š
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ãã®ä»–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
                    <div style="margin-bottom: 25px; padding: 15px; border: 1px solid #e9ecef; border-radius: 4px;">
                        <h3 style="margin: 0 0 10px 0; font-size: 1.1em; color: #212529;">ğŸ› ï¸ ãã®ä»–ã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹</h3>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="cleanupOldData()" class="btn" style="background: #ffc107; color: #212529;">
                                ğŸ—‘ï¸ å¤ã„DB ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
                            </button>
                            <button onclick="checkDiskSpace()" class="btn" style="background: #6c757d; color: white;">
                                ğŸ’¾ ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ç¢ºèª
                            </button>
                            <button onclick="viewDbStatus()" class="btn" style="background: #20c997; color: white;">
                                ğŸ“ˆ DBçµ±è¨ˆæƒ…å ±
                            </button>
                        </div>
                        <div id="maintenanceOutput" style="margin-top: 10px; display: none;">
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 0.85em; max-height: 300px; overflow-y: auto; white-space: pre-wrap;" id="maintenanceLog"></div>
                        </div>
                    </div>

                    <!-- DBç®¡ç† -->
                    <div style="margin-bottom: 25px; padding: 15px; border: 1px solid #e9ecef; border-radius: 4px;">
                        <h3 style="margin: 0 0 10px 0; font-size: 1.1em; color: #212529;">ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†</h3>
                        <p style="margin: 0 0 10px 0; color: #6c757d; font-size: 0.9em;">éŒ²éŸ³ãƒ•ã‚¡ã‚¤ãƒ«ãƒ¬ã‚³ãƒ¼ãƒ‰ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã¨ç®¡ç†</p>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="cleanupOrphanedRecords()" class="btn" style="background: #e74c3c; color: white;">
                                ğŸ§¹ å­¤ç«‹ãƒ¬ã‚³ãƒ¼ãƒ‰å‰Šé™¤
                            </button>
                            <button onclick="checkOrphanedFiles()" class="btn" style="background: #3498db; color: white;">
                                ğŸ” å­¤ç«‹ãƒ•ã‚¡ã‚¤ãƒ«æ¤œå‡º
                            </button>
                            <button onclick="showDbRecords()" class="btn" style="background: #9b59b6; color: white;">
                                ğŸ“‹ ãƒ¬ã‚³ãƒ¼ãƒ‰ä¸€è¦§è¡¨ç¤º
                            </button>
                            <button onclick="batchUpdateMetadata()" class="btn" style="background: #27ae60; color: white;">
                                ğŸµ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬æ›´æ–°
                            </button>
                        </div>
                        <div id="dbManagementOutput" style="margin-top: 10px; display: none;">
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 0.85em; max-height: 400px; overflow-y: auto; white-space: pre-wrap;" id="dbManagementLog"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- atäºˆç´„ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="atEditModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3 style="margin: 0; color: #212529;">ğŸ“ äºˆç´„å†…å®¹ã®ç·¨é›†</h3>
                    <button onclick="closeAtEditModal()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: #6c757d;">&times;</button>
                </div>
                <div class="modal-body" style="padding: 20px;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">ç•ªçµ„å</label>
                        <input type="text" id="editAtTitle" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">ã‚¨ãƒªã‚¢</label>
                            <select id="editAtArea" onchange="updateEditAtStations()" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                <option value="">ã‚¨ãƒªã‚¢ã‚’é¸æŠ</option>
                                <option value="JP13">æ±äº¬éƒ½</option>
                                <option value="JP14">ç¥å¥ˆå·çœŒ</option>
                                <option value="JP27">å¤§é˜ªåºœ</option>
                                <option value="JP28">å…µåº«çœŒ</option>
                                <option value="JP1">åŒ—æµ·é“</option>
                                <option value="JP2">é’æ£®çœŒ</option>
                                <option value="JP3">å²©æ‰‹çœŒ</option>
                                <option value="JP4">å®®åŸçœŒ</option>
                                <option value="JP5">ç§‹ç”°çœŒ</option>
                                <option value="JP6">å±±å½¢çœŒ</option>
                                <option value="JP7">ç¦å³¶çœŒ</option>
                                <option value="JP8">èŒ¨åŸçœŒ</option>
                                <option value="JP9">æ ƒæœ¨çœŒ</option>
                                <option value="JP10">ç¾¤é¦¬çœŒ</option>
                                <option value="JP11">åŸ¼ç‰çœŒ</option>
                                <option value="JP12">åƒè‘‰çœŒ</option>
                                <option value="JP15">æ–°æ½ŸçœŒ</option>
                                <option value="JP16">å¯Œå±±çœŒ</option>
                                <option value="JP17">çŸ³å·çœŒ</option>
                                <option value="JP18">ç¦äº•çœŒ</option>
                                <option value="JP19">å±±æ¢¨çœŒ</option>
                                <option value="JP20">é•·é‡çœŒ</option>
                                <option value="JP21">å²é˜œçœŒ</option>
                                <option value="JP22">é™å²¡çœŒ</option>
                                <option value="JP23">æ„›çŸ¥çœŒ</option>
                                <option value="JP24">ä¸‰é‡çœŒ</option>
                                <option value="JP25">æ»‹è³€çœŒ</option>
                                <option value="JP26">äº¬éƒ½åºœ</option>
                                <option value="JP29">å¥ˆè‰¯çœŒ</option>
                                <option value="JP30">å’Œæ­Œå±±çœŒ</option>
                                <option value="JP31">é³¥å–çœŒ</option>
                                <option value="JP32">å³¶æ ¹çœŒ</option>
                                <option value="JP33">å²¡å±±çœŒ</option>
                                <option value="JP34">åºƒå³¶çœŒ</option>
                                <option value="JP35">å±±å£çœŒ</option>
                                <option value="JP36">å¾³å³¶çœŒ</option>
                                <option value="JP37">é¦™å·çœŒ</option>
                                <option value="JP38">æ„›åª›çœŒ</option>
                                <option value="JP39">é«˜çŸ¥çœŒ</option>
                                <option value="JP40">ç¦å²¡çœŒ</option>
                                <option value="JP41">ä½è³€çœŒ</option>
                                <option value="JP42">é•·å´çœŒ</option>
                                <option value="JP43">ç†Šæœ¬çœŒ</option>
                                <option value="JP44">å¤§åˆ†çœŒ</option>
                                <option value="JP45">å®®å´çœŒ</option>
                                <option value="JP46">é¹¿å…å³¶çœŒ</option>
                                <option value="JP47">æ²–ç¸„çœŒ</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">æ”¾é€å±€</label>
                            <select id="editAtStation" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                <option value="">ã¾ãšã‚¨ãƒªã‚¢ã‚’é¸æŠ</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">éŒ²éŸ³é–‹å§‹æ—¥æ™‚</label>
                        <input type="datetime-local" id="editAtStartTime" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                        <small style="color: #6c757d; font-size: 0.85em;">å®Ÿéš›ã«éŒ²éŸ³ãŒé–‹å§‹ã•ã‚Œã‚‹æ™‚åˆ»</small>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">éŒ²éŸ³çµ‚äº†æ—¥æ™‚</label>
                        <input type="datetime-local" id="editAtEndTime" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                        <small style="color: #6c757d; font-size: 0.85em;">æ—¥ä»˜ã‚’è·¨ãå ´åˆã‚‚æŒ‡å®šå¯èƒ½</small>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚åˆ»ï¼ˆäºˆç´„å®Ÿè¡Œæ™‚é–“ï¼‰</label>
                        <div style="display: flex; gap: 8px; align-items: flex-start;">
                            <input type="datetime-local" id="editAtExecuteTime" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                            <button onclick="setExecuteTimeToEndPlus5()" style="padding: 8px 12px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; font-size: 0.9em;">
                                çµ‚äº†+5åˆ†
                            </button>
                        </div>
                        <small style="color: #6c757d; font-size: 0.85em;">atã‚³ãƒãƒ³ãƒ‰ã§ã“ã®æ™‚åˆ»ã«å®Ÿè¡Œã•ã‚Œã¾ã™</small>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">ğŸ“ ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€</label>
                        <select id="editAtFolder" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                            <option value="">ğŸ“ ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ«ãƒ€ï¼ˆãƒ•ã‚©ãƒ«ãƒ€æŒ‡å®šãªã—ï¼‰</option>
                        </select>
                        <small style="color: #6c757d; font-size: 0.85em;">éŒ²éŸ³å¾Œã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ãŸãƒ•ã‚©ãƒ«ãƒ€ã«è‡ªå‹•çš„ã«ç§»å‹•ã—ã¾ã™</small>
                    </div>
                    <input type="hidden" id="editAtJobId">
                </div>
                <div class="modal-actions">
                    <button class="btn btn-action btn-execute" onclick="saveAtEdit()">
                        <span style="font-size: 1.3em; display: block; margin-bottom: 2px;">ğŸ’¾</span>
                        <span style="font-size: 0.85em;">ä¿å­˜</span>
                    </button>
                    <button class="btn btn-action btn-close" onclick="closeAtEditModal()">
                        <span style="font-size: 1.3em; display: block; margin-bottom: 2px;">âœ•</span>
                        <span style="font-size: 0.85em;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>
                    </button>
                </div>
            </div>
        </div>

        <footer>
            <p>&copy; 2025 éŒ²éŸ³ãã‚“ | Powered by radiko API</p>
        </footer>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">ã‚³ãƒãƒ³ãƒ‰</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="command-box" id="commandBox"></div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-action btn-execute" id="executeBtn" onclick="executeCommand()" style="display: none;">
                    <span style="font-size: 1.3em; display: block; margin-bottom: 2px;">â–¶ï¸</span>
                    <span style="font-size: 0.85em;">å®Ÿè¡Œ</span>
                </button>
                <button class="btn btn-action" id="registerCronBtn" style="display: none;">
                    <span style="font-size: 1.3em; display: block; margin-bottom: 2px;">â°</span>
                    <span style="font-size: 0.85em;">cronç™»éŒ²</span>
                </button>
                <button class="btn btn-action btn-copy" onclick="copyCommand(event)">
                    <span style="font-size: 1.3em; display: block; margin-bottom: 2px;">ğŸ“‹</span>
                    <span style="font-size: 0.85em;">ã‚³ãƒ”ãƒ¼</span>
                </button>
                <button class="btn btn-action btn-close" onclick="closeModal()">
                    <span style="font-size: 1.3em; display: block; margin-bottom: 2px;">âœ•</span>
                    <span style="font-size: 0.85em;">é–‰ã˜ã‚‹</span>
                </button>
            </div>
        </div>
    </div>

    <!-- cronãƒ­ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="cronLogModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>ğŸ“‹ cronãƒ­ã‚°</h2>
                <button class="modal-close" onclick="closeCronLogModal()">&times;</button>
            </div>
            <div style="margin-bottom: 15px;">
                <div style="padding: 10px; background: #f8f9fa; border-radius: 4px; font-size: 0.85em; color: #6c757d;">
                    cronã®å®Ÿè¡Œå±¥æ­´ã¨ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚æœ€æ–°100è¡Œã¾ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
                </div>
            </div>
            <div id="cronLogContent" style="max-height: 500px; overflow-y: auto; background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 0.8em; line-height: 1.6;">
                <div style="text-align: center; color: #888;">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-action" onclick="loadCronLogs()" style="background: #6c757d; color: white;">ğŸ”„ æ›´æ–°</button>
                <button class="btn btn-action btn-close" onclick="closeCronLogModal()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆãƒ»ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="folderModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="folderModalTitle">ğŸ“‚ æ–°è¦ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ</h2>
                <button class="modal-close" onclick="closeFolderModal()">&times;</button>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #495057;">ãƒ•ã‚©ãƒ«ãƒ€å <span style="color: #dc3545;">*</span></label>
                <input type="text" id="folderName" placeholder="ä¾‹: ãŠæ°—ã«å…¥ã‚Šã€ãƒ‹ãƒ¥ãƒ¼ã‚¹ã€éŸ³æ¥½..." style="width: 100%; padding: 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 0.95em;">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #495057;">ã‚«ãƒ©ãƒ¼ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="selectFolderColor('#667eea')" class="folder-color-btn" data-color="#667eea" style="width: 40px; height: 40px; border: 2px solid #dee2e6; border-radius: 8px; background: #667eea; cursor: pointer; transition: all 0.2s;"></button>
                    <button onclick="selectFolderColor('#764ba2')" class="folder-color-btn" data-color="#764ba2" style="width: 40px; height: 40px; border: 2px solid #dee2e6; border-radius: 8px; background: #764ba2; cursor: pointer; transition: all 0.2s;"></button>
                    <button onclick="selectFolderColor('#f093fb')" class="folder-color-btn" data-color="#f093fb" style="width: 40px; height: 40px; border: 2px solid #dee2e6; border-radius: 8px; background: #f093fb; cursor: pointer; transition: all 0.2s;"></button>
                    <button onclick="selectFolderColor('#fa709a')" class="folder-color-btn" data-color="#fa709a" style="width: 40px; height: 40px; border: 2px solid #dee2e6; border-radius: 8px; background: #fa709a; cursor: pointer; transition: all 0.2s;"></button>
                    <button onclick="selectFolderColor('#fee140')" class="folder-color-btn" data-color="#fee140" style="width: 40px; height: 40px; border: 2px solid #dee2e6; border-radius: 8px; background: #fee140; cursor: pointer; transition: all 0.2s;"></button>
                    <button onclick="selectFolderColor('#30cfd0')" class="folder-color-btn" data-color="#30cfd0" style="width: 40px; height: 40px; border: 2px solid #dee2e6; border-radius: 8px; background: #30cfd0; cursor: pointer; transition: all 0.2s;"></button>
                    <button onclick="selectFolderColor('#a8edea')" class="folder-color-btn" data-color="#a8edea" style="width: 40px; height: 40px; border: 2px solid #dee2e6; border-radius: 8px; background: #a8edea; cursor: pointer; transition: all 0.2s;"></button>
                    <button onclick="selectFolderColor('#6c757d')" class="folder-color-btn" data-color="#6c757d" style="width: 40px; height: 40px; border: 2px solid #dee2e6; border-radius: 8px; background: #6c757d; cursor: pointer; transition: all 0.2s;"></button>
                </div>
                <input type="hidden" id="selectedFolderColor" value="">
            </div>
            <div class="modal-actions">
                <button class="btn btn-action btn-primary" onclick="saveFolderModal()">ä¿å­˜</button>
                <button class="btn btn-action btn-close" onclick="closeFolderModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <!-- ãƒ•ã‚¡ã‚¤ãƒ«ç§»å‹•ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="moveFileModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç§»å‹•</h2>
                <button class="modal-close" onclick="closeMoveFileModal()">&times;</button>
            </div>
            <div style="margin-bottom: 15px;">
                <div style="padding: 10px; background: #f8f9fa; border-radius: 4px; font-size: 0.9em; color: #495057;">
                    <strong id="moveFileName"></strong> ã‚’ç§»å‹•ã—ã¾ã™
                </div>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #495057;">ç§»å‹•å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ</label>
                <div id="folderList" style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px;">
                    <!-- ãƒ•ã‚©ãƒ«ãƒ€ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-action btn-close" onclick="closeMoveFileModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <!-- ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="audioPlayerModal" class="modal">
        <div class="modal-content" style="max-width: 500px; padding: 0; touch-action: manipulation;">
            <div class="modal-header" style="padding: 12px 50px 12px 20px; border-bottom: 1px solid #e9ecef; position: relative; touch-action: manipulation;">
                <button class="modal-close" onclick="closeAudioPlayer()" style="position: absolute; right: 10px; top: 10px; background: #f8f9fa; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; border: none; cursor: pointer; color: #6c757d; transition: all 0.2s; z-index: 10001;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">&times;</button>
            </div>
            <div style="padding: 20px; touch-action: manipulation;">
                <!-- ã‚¢ãƒ«ãƒãƒ ã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ -->
                <div style="text-align: center; margin-bottom: 20px; touch-action: manipulation;">
                    <img src="img/jacket.png" alt="Artwork" style="width: 200px; height: 200px; margin: 0 auto 15px; border-radius: 20px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3); object-fit: cover; display: block; touch-action: manipulation;">
                    <h3 id="audioPlayerTitle" style="font-size: 1.1em; font-weight: 600; color: #2d3436; margin: 0; line-height: 1.4; padding: 0 10px;">å†ç”Ÿä¸­</h3>
                </div>

                <!-- éè¡¨ç¤ºã®ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªè¦ç´ ï¼ˆã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ä½¿ç”¨ï¼‰ -->
                <audio id="audioPlayer" style="display: none;"
                       preload="auto"
                       ontimeupdate="updatePlaybackPosition()"
                       onloadedmetadata="loadBookmark()"
                       onvolumechange="saveVolume()"
                       onplay="updatePlayPauseButton(); if ('mediaSession' in navigator) { navigator.mediaSession.playbackState = 'playing'; } console.log('â–¶ï¸ [Audio] onplay - playbackState: playing');"
                       onpause="updatePlayPauseButton(); if ('mediaSession' in navigator) { navigator.mediaSession.playbackState = 'paused'; } console.log('â¸ï¸ [Audio] onpause - playbackState: paused');"
                       onended="updatePlayPauseButton(); if ('mediaSession' in navigator) { navigator.mediaSession.playbackState = 'none'; } console.log('â¹ï¸ [Audio] onended - playbackState: none');">
                    <source id="audioSource" src="" type="audio/mpeg">
                </audio>

                <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.75em; color: #6c757d;">
                        <span id="currentTime">0:00</span>
                        <span id="totalDuration">0:00</span>
                    </div>
                    <input type="range" id="progressBar" min="0" max="100" value="0"
                           oninput="seekAudio(this.value)"
                           style="width: 100%; height: 6px; border-radius: 3px; background: linear-gradient(to right, #667eea 0%, #667eea 0%, #e9ecef 0%, #e9ecef 100%); outline: none; -webkit-appearance: none; cursor: pointer; touch-action: manipulation;">
                </div>

                <!-- å†ç”Ÿã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
                <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px;">
                    <button onclick="skipAudio(-30)" style="width: 45px; height: 45px; background: #f8f9fa; border: none; border-radius: 50%; cursor: pointer; font-size: 0.75em; font-weight: 600; color: #667eea; transition: all 0.2s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='#e9ecef'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='#f8f9fa'; this.style.transform='scale(1)'">
                        -30s
                    </button>
                    <button onclick="skipAudio(-10)" style="width: 50px; height: 50px; background: #f8f9fa; border: none; border-radius: 50%; cursor: pointer; font-size: 0.85em; font-weight: 600; color: #667eea; transition: all 0.2s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='#e9ecef'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='#f8f9fa'; this.style.transform='scale(1)'">
                        -10s
                    </button>
                    <button id="playPauseBtn" onclick="togglePlayPause()" style="width: 70px; height: 70px; background: transparent; border: none; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; padding: 0;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        <img id="playPauseImg" src="img/palyer_play.png" alt="å†ç”Ÿ" style="width: 100%; height: 100%; display: block;">
                    </button>
                    <button onclick="skipAudio(10)" style="width: 50px; height: 50px; background: #f8f9fa; border: none; border-radius: 50%; cursor: pointer; font-size: 0.85em; font-weight: 600; color: #764ba2; transition: all 0.2s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='#e9ecef'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='#f8f9fa'; this.style.transform='scale(1)'">
                        +10s
                    </button>
                    <button onclick="skipAudio(30)" style="width: 45px; height: 45px; background: #f8f9fa; border: none; border-radius: 50%; cursor: pointer; font-size: 0.75em; font-weight: 600; color: #764ba2; transition: all 0.2s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='#e9ecef'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='#f8f9fa'; this.style.transform='scale(1)'">
                        +30s
                    </button>
                </div>

                <!-- ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
                <div style="padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label style="font-size: 0.85em; color: #495057; font-weight: 600; min-width: 80px;">ğŸ”Š éŸ³é‡:</label>
                        <input type="range" id="volumeControl" min="0" max="100" value="100"
                               oninput="changeVolume(this.value)"
                               style="flex: 1; cursor: pointer; touch-action: manipulation; -webkit-appearance: none;">
                        <span id="volumeValue" style="min-width: 50px; font-size: 0.9em; font-weight: 600; color: #667eea;">100%</span>
                    </div>
                </div>

                <!-- å†ç”Ÿé€Ÿåº¦ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
                <div style="padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <label style="font-size: 0.85em; color: #495057; font-weight: 600; min-width: 80px;">âš¡ å†ç”Ÿé€Ÿåº¦:</label>
                        <input type="range" id="playbackRate" min="0.5" max="2.0" step="0.1" value="1.0"
                               oninput="changePlaybackRate(this.value)"
                               style="flex: 1; cursor: pointer; touch-action: manipulation; -webkit-appearance: none;">
                        <span id="playbackRateValue" style="min-width: 50px; font-size: 0.9em; font-weight: 600; color: #667eea;">1.0x</span>
                    </div>
                    <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                        <button onclick="setPlaybackRate(0.5)" class="speed-btn" style="padding: 4px 10px; background: white; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; font-size: 0.8em; transition: all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='white'">0.5x</button>
                        <button onclick="setPlaybackRate(0.75)" class="speed-btn" style="padding: 4px 10px; background: white; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; font-size: 0.8em; transition: all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='white'">0.75x</button>
                        <button onclick="setPlaybackRate(1.0)" class="speed-btn" style="padding: 4px 10px; background: white; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; font-size: 0.8em; transition: all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='white'">1.0x</button>
                        <button onclick="setPlaybackRate(1.25)" class="speed-btn" style="padding: 4px 10px; background: white; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; font-size: 0.8em; transition: all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='white'">1.25x</button>
                        <button onclick="setPlaybackRate(1.5)" class="speed-btn" style="padding: 4px 10px; background: white; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; font-size: 0.8em; transition: all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='white'">1.5x</button>
                        <button onclick="setPlaybackRate(2.0)" class="speed-btn" style="padding: 4px 10px; background: white; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; font-size: 0.8em; transition: all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='white'">2.0x</button>
                    </div>
                </div>

                <!-- ã‚«ãƒƒãƒˆç·¨é›†ãƒ‘ãƒãƒ« -->
                <div id="editPanelContainer" style="padding: 12px; background: linear-gradient(135deg, #ffeaa715, #ff6b6b15); border-radius: 8px; margin-bottom: 10px; border: 2px solid #ffe8e8;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                        <label style="font-size: 0.85em; color: #d63031; font-weight: 600;">âœ‚ï¸ ã‚«ãƒƒãƒˆç·¨é›†</label>
                        <button id="toggleEditPanel" onclick="toggleEditPanel()" style="padding: 3px 8px; background: white; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; font-size: 0.75em; color: #6c757d;">
                            è¡¨ç¤º/éè¡¨ç¤º
                        </button>
                    </div>
                    <div id="editPanel" style="display: none;">
                        <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                            <button onclick="markStartTime()" style="flex: 1; padding: 8px; background: #00b894; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#00a383'" onmouseout="this.style.background='#00b894'">
                                ğŸ“ é–‹å§‹ä½ç½®
                            </button>
                            <button onclick="markEndTime()" style="flex: 1; padding: 8px; background: #0984e3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#0770c9'" onmouseout="this.style.background='#0984e3'">
                                ğŸ“ çµ‚äº†ä½ç½®
                            </button>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 4px; margin-bottom: 10px; font-size: 0.85em;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="color: #6c757d;">é–‹å§‹:</span>
                                <span id="audioEditStartTime" style="font-weight: 600; color: #00b894;">æœªè¨­å®š</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="color: #6c757d;">çµ‚äº†:</span>
                                <span id="audioEditEndTime" style="font-weight: 600; color: #0984e3;">æœªè¨­å®š</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #6c757d;">ç¯„å›²:</span>
                                <span id="editDuration" style="font-weight: 600; color: #d63031;">--</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="executeEdit('remove')" style="flex: 1; padding: 10px; background: #d63031; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#c0251f'" onmouseout="this.style.background='#d63031'">
                                ğŸ—‘ï¸ ç¯„å›²ã‚’å‰Šé™¤
                            </button>
                            <button onclick="executeEdit('extract')" style="flex: 1; padding: 10px; background: #fdcb6e; color: #2d3436; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#fcbb4b'" onmouseout="this.style.background='#fdcb6e'">
                                ğŸ“¥ ç¯„å›²ã‚’æŠ½å‡º
                            </button>
                        </div>
                        <div style="margin-top: 8px; padding: 8px; background: #fff3cd; border-radius: 4px; font-size: 0.75em; color: #856404;">
                            ğŸ’¡ ç¯„å›²å‰Šé™¤: CMãªã©ä¸è¦éƒ¨åˆ†ã‚’é™¤å» / ç¯„å›²æŠ½å‡º: æŒ‡å®šéƒ¨åˆ†ã®ã¿ä¿å­˜
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- cronç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="cronEditModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>â° äºˆç´„ã‚’ç·¨é›†</h2>
                <button class="modal-close" onclick="closeCronEditModal()">&times;</button>
            </div>
            <div class="modal-body">
            <!-- ç•ªçµ„æƒ…å ± -->
            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #495057;">ğŸ“º ç•ªçµ„æƒ…å ±</label>
                <div style="margin-bottom: 10px;">
                    <label style="font-size: 0.85em; color: #6c757d;">ç•ªçµ„å</label>
                    <input type="text" id="editProgramTitle" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                </div>
                <div style="font-size: 0.85em; color: #6c757d;" id="editProgramStation">æ”¾é€å±€</div>
            </div>

            <!-- éŒ²éŸ³æ™‚é–“è¨­å®š -->
            <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #495057;">ğŸ“¡ éŒ²éŸ³æ™‚é–“</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label style="font-size: 0.85em; color: #6c757d;">é–‹å§‹æ™‚åˆ» (HH:MM)</label>
                            <input type="time" id="editStartTime" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="font-size: 0.85em; color: #6c757d;">çµ‚äº†æ™‚åˆ» (HH:MM)</label>
                            <input type="time" id="editEndTime" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°è¨­å®š -->
            <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #495057;">â° å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                        <div>
                            <label style="font-size: 0.85em; color: #6c757d;">åˆ† (0-59)</label>
                            <input type="number" id="editMinute" min="0" max="59" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="font-size: 0.85em; color: #6c757d;">æ™‚ (0-23)</label>
                            <input type="number" id="editHour" min="0" max="23" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="font-size: 0.85em; color: #6c757d;">å®Ÿè¡Œé »åº¦</label>
                            <select id="editDayOfWeek" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                                <option value="*">æ¯æ—¥</option>
                                <option value="0">æ—¥æ›œæ—¥</option>
                                <option value="1">æœˆæ›œæ—¥</option>
                                <option value="2">ç«æ›œæ—¥</option>
                                <option value="3">æ°´æ›œæ—¥</option>
                                <option value="4">æœ¨æ›œæ—¥</option>
                                <option value="5">é‡‘æ›œæ—¥</option>
                                <option value="6">åœŸæ›œæ—¥</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div style="padding: 10px; background: #e7f3ff; border-radius: 4px; border-left: 4px solid #667eea;">
                    <div style="font-size: 0.9em; color: #0056b3; font-weight: 600;" id="cronPreview">
                        å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°: -
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #495057;">ğŸ“ ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€</label>
                <select id="editCronFolder" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                    <option value="">ğŸ“ ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ«ãƒ€ï¼ˆãƒ•ã‚©ãƒ«ãƒ€æŒ‡å®šãªã—ï¼‰</option>
                </select>
                <div style="font-size: 0.8em; color: #6c757d; margin-top: 5px;">
                    ğŸ’¡ éŒ²éŸ³å¾Œã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ãŸãƒ•ã‚©ãƒ«ãƒ€ã«è‡ªå‹•çš„ã«ç§»å‹•ã—ã¾ã™
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #495057;">ğŸ¯ å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰</label>
                <textarea id="editCommandPreview" style="width: 100%; min-height: 120px; font-family: 'Courier New', monospace; font-size: 0.85em; color: #495057; background: #f8f9fa; padding: 12px; border: 1px solid #dee2e6; border-radius: 4px; resize: vertical; line-height: 1.6;" placeholder="cronã‚³ãƒãƒ³ãƒ‰"></textarea>
                <div style="font-size: 0.8em; color: #6c757d; margin-top: 5px;">
                    ğŸ’¡ ã‚³ãƒãƒ³ãƒ‰ã‚’ç›´æ¥ç·¨é›†ã§ãã¾ã™ã€‚éŒ²éŸ³æ™‚é–“ã‚’ç´°ã‹ãèª¿æ•´ã—ãŸã„å ´åˆãªã©ã«ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
                </div>
            </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-action btn-execute" onclick="saveCronEdit()">
                    <span style="font-size: 1.3em; display: block; margin-bottom: 2px;">ğŸ’¾</span>
                    <span style="font-size: 0.85em;">ä¿å­˜</span>
                </button>
                <button class="btn btn-action btn-close" onclick="closeCronEditModal()">
                    <span style="font-size: 1.3em; display: block; margin-bottom: 2px;">âœ•</span>
                    <span style="font-size: 0.85em;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ãƒªãƒãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="renameModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>âœï¸ ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å¤‰æ›´</h2>
                <button class="modal-close" onclick="closeRenameModal()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #495057;">ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«å</label>
                    <div id="renameCurrentName" style="padding: 10px; background: #f8f9fa; border-radius: 4px; color: #6c757d; font-size: 0.9em; word-break: break-all;"></div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="renameNewName" style="display: block; font-weight: 600; margin-bottom: 8px; color: #495057;">æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«å</label>
                    <input type="text" id="renameNewName" style="width: 100%; padding: 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 0.9em;">
                    <div style="margin-top: 6px; font-size: 0.8em; color: #6c757d;">
                        ğŸ’¡ æ‹¡å¼µå­ï¼ˆ.mp3ãªã©ï¼‰ã¯è‡ªå‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-action btn-copy" onclick="executeRename()">
                    <span style="font-size: 1.3em; display: block; margin-bottom: 2px;">âœï¸</span>
                    <span style="font-size: 0.85em;">å¤‰æ›´</span>
                </button>
                <button class="btn btn-action btn-close" onclick="closeRenameModal()">
                    <span style="font-size: 1.3em; display: block; margin-bottom: 2px;">âœ•</span>
                    <span style="font-size: 0.85em;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="artworkUploadModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>ğŸ¨ ã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ç™»éŒ²</h2>
                <button class="modal-close" onclick="closeArtworkUploadModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #495057;">ç•ªçµ„ã‚¿ã‚¤ãƒˆãƒ«</label>
                    <input type="text" id="artworkTitle" style="width: 100%; padding: 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 0.9em;">
                    <div style="margin-top: 6px; font-size: 0.8em; color: #6c757d;">
                        ğŸ’¡ åŒã˜ã‚¿ã‚¤ãƒˆãƒ«ã®ç•ªçµ„ã«åŒã˜ã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #495057;">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
                    <input type="text" id="artworkArtist" placeholder="å‡ºæ¼”è€…ã‚„ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£å" style="width: 100%; padding: 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 0.9em;">
                    <div style="margin-top: 6px; font-size: 0.8em; color: #6c757d;">
                        ğŸ’¡ MP3ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆæƒ…å ±ã¨ã—ã¦åŸ‹ã‚è¾¼ã¾ã‚Œã¾ã™
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #495057;">ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«</label>
                    <input type="file" id="artworkFile" accept="image/*" style="width: 100%; padding: 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 0.9em;">
                    <div style="margin-top: 6px; font-size: 0.8em; color: #6c757d;">
                        å¯¾å¿œå½¢å¼: JPEG, PNG, GIF, WebP
                    </div>
                </div>
                <div id="artworkCropArea" style="display: none; margin-top: 15px;">
                    <div style="position: relative; display: inline-block; max-width: 100%; background: #f8f9fa; border-radius: 8px; overflow: hidden;">
                        <canvas id="artworkCanvas" style="max-width: 100%; display: block;"></canvas>
                        <div id="cropBox" style="position: absolute; border: 2px solid #fff; box-shadow: 0 0 0 9999px rgba(0,0,0,0.5); cursor: move; display: none;">
                            <div style="position: absolute; width: 8px; height: 8px; background: #fff; border: 1px solid #667eea; top: -4px; left: -4px; cursor: nwse-resize;" data-handle="nw"></div>
                            <div style="position: absolute; width: 8px; height: 8px; background: #fff; border: 1px solid #667eea; top: -4px; right: -4px; cursor: nesw-resize;" data-handle="ne"></div>
                            <div style="position: absolute; width: 8px; height: 8px; background: #fff; border: 1px solid #667eea; bottom: -4px; left: -4px; cursor: nesw-resize;" data-handle="sw"></div>
                            <div style="position: absolute; width: 8px; height: 8px; background: #fff; border: 1px solid #667eea; bottom: -4px; right: -4px; cursor: nwse-resize;" data-handle="se"></div>
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.8em; color: #6c757d; text-align: center;">
                        ğŸ’¡ ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•ã€å››éš…ã®ãƒãƒ³ãƒ‰ãƒ«ã§ã‚µã‚¤ã‚ºèª¿æ•´
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-action btn-copy" id="artworkUploadBtn" onclick="uploadArtwork()">
                    <span style="font-size: 1.3em; display: block; margin-bottom: 2px;">ğŸ“¤</span>
                    <span style="font-size: 0.85em;">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</span>
                </button>
                <button class="btn btn-action btn-close" onclick="closeArtworkUploadModal()">
                    <span style="font-size: 1.3em; display: block; margin-bottom: 2px;">âœ•</span>
                    <span style="font-size: 0.85em;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // èªè¨¼ãƒã‚§ãƒƒã‚¯
        // ========================================
        (async function checkAuth() {
            try {
                const response = await fetch('/auth/check', {
                    credentials: 'include'
                });
                const data = await response.json();

                if (!data.logged_in) {
                    // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                    window.location.href = '/login.html';
                }
            } catch (error) {
                console.error('Auth check error:', error);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                window.location.href = '/login.html';
            }
        })();

        let currentCommand = '';
        let currentProgramData = null;
        let allProgramsData = [];
        let areaPrograms = null; // ã‚¨ãƒªã‚¢ç•ªçµ„è¡¨ã‚’ä¿å­˜ï¼ˆå…¨ã‚¨ãƒªã‚¢æ¤œç´¢ã‹ã‚‰æˆ»ã‚‹ãŸã‚ï¼‰
        let currentAreaId = null; // ç¾åœ¨ã®ã‚¨ãƒªã‚¢ID
        let eventSource = null;
        let currentEditingCron = { original: '', commandPart: '' };
        let currentStationMap = null; // ã‚¹ãƒãƒ›ç”¨: ç¾åœ¨ã®æ”¾é€å±€ãƒãƒƒãƒ—ã‚’ä¿æŒ
        let currentProgramList = null; // ã‚¹ãƒãƒ›ç”¨: ç¾åœ¨ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãƒªã‚¹ãƒˆè¦ç´ ã‚’ä¿æŒ
        // ç•ªçµ„è¡¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆã‚¨ãƒªã‚¢ID + æ—¥ä»˜ã‚’ã‚­ãƒ¼ã«ã™ã‚‹ï¼‰
        // å„ã‚¨ãƒ³ãƒˆãƒªã¯ { data: [...], timestamp: Date } ã®å½¢å¼
        const programCache = new Map();
        const CACHE_EXPIRE_MS = 30 * 60 * 1000; // 30åˆ†ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœŸé™åˆ‡ã‚Œ
        let selectedFolderId = null; // éŒ²éŸ³æ™‚ã«æŒ‡å®šã™ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ID

        // ãƒ•ã‚©ãƒ«ãƒ€é¸æŠUIã‚’ç”Ÿæˆ
        async function generateFolderSelectHtml() {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                const response = await fetch(`${baseUrl}/folders`);
                const data = await response.json();

                if (response.ok && data.folders) {
                    let html = `
                        <div style="margin-bottom: 20px;">
                            <div style="font-weight: 600; margin-bottom: 8px; font-size: 0.9em; color: #6c757d;">ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</div>
                            <select id="targetFolderSelect" style="width: 100%; padding: 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 0.95em;">
                                <option value="">ğŸ“ ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ«ãƒ€ï¼ˆãƒ•ã‚©ãƒ«ãƒ€æŒ‡å®šãªã—ï¼‰</option>
                    `;

                    data.folders.forEach(folder => {
                        const icon = folder.icon || 'ğŸ“';
                        const color = folder.color ? ` style="color: ${folder.color}"` : '';
                        html += `<option value="${folder.id}"${color}>${icon} ${folder.name}</option>`;
                    });

                    html += `
                            </select>
                            <div style="font-size: 0.85em; color: #6c757d; margin-top: 5px;">éŒ²éŸ³å¾Œã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ãŸãƒ•ã‚©ãƒ«ãƒ€ã«è‡ªå‹•çš„ã«ç§»å‹•ã—ã¾ã™</div>
                        </div>
                    `;

                    return html;
                } else {
                    return '';
                }
            } catch (err) {
                console.error('Error loading folders:', err);
                return '';
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«åã‚µãƒ‹ã‚¿ã‚¤ã‚ºé–¢æ•°ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ã‚’ã‚¢ãƒ³ãƒ€ãƒ¼ãƒãƒ¼ã«ã€å…¨è§’è¨˜å·ã‚’åŠè§’ã«ï¼‰
        function sanitizeFilename(title) {
            if (!title) return title;

            // ã‚¹ãƒšãƒ¼ã‚¹ã‚’ã‚¢ãƒ³ãƒ€ãƒ¼ãƒãƒ¼ã«
            let sanitized = title.replace(/ /g, '_').replace(/ã€€/g, '_');

            // å…¨è§’æ‹¬å¼§ãƒ»è¨˜å·ã‚’åŠè§’ã«
            const replacements = {
                'ï¼ˆ': '(',
                'ï¼‰': ')',
                'ã€Œ': '[',
                'ã€': ']',
                'ï¼š': ':',
                'ï¼': '!',
                'ï¼Ÿ': '?',
                'ï¼»': '[',
                'ï¼½': ']'
            };

            for (const [oldChar, newChar] of Object.entries(replacements)) {
                sanitized = sanitized.replace(new RegExp(oldChar, 'g'), newChar);
            }

            return sanitized;
        }

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥é–¢é€£ã®é–¢æ•°ï¼ˆäº’æ›æ€§ã®ãŸã‚ç©ºå®Ÿè£…ã‚’æ®‹ã™ï¼‰
        async function loadCacheFromStorage() {
            console.log('â„¹ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯ã‚µãƒ¼ãƒãƒ¼å´DBã§ç®¡ç†ã•ã‚Œã¦ã„ã¾ã™');
        }

        async function saveCacheToStorage() {
            console.log('â„¹ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯ã‚µãƒ¼ãƒãƒ¼å´DBã§ç®¡ç†ã•ã‚Œã¦ã„ã¾ã™');
        }

        // å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ã™ã‚‹é–¢æ•°
        function clearOldCache() {
            console.log('ğŸ§¹ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–‹å§‹');
            console.log(`ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‰ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ•°: ${programCache.size}ä»¶`);

            const now = new Date();
            const today = new Date(now);

            // æœ5æ™‚æœªæº€ã®å ´åˆã¯å‰æ—¥ã¨ã—ã¦æ‰±ã†
            if (today.getHours() < 5) {
                today.setDate(today.getDate() - 1);
            }

            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            console.log(`åŸºæº–æ—¥: ${todayStr} (æœ5æ™‚åŸºæº–)`);

            // éå»7æ—¥é–“ã‹ã‚‰æœªæ¥7æ—¥é–“ã¾ã§ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿æŒï¼ˆè¨ˆ15æ—¥é–“ï¼‰
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const sevenDaysAgoStr = `${sevenDaysAgo.getFullYear()}-${String(sevenDaysAgo.getMonth() + 1).padStart(2, '0')}-${String(sevenDaysAgo.getDate()).padStart(2, '0')}`;

            const sevenDaysLater = new Date(today);
            sevenDaysLater.setDate(sevenDaysLater.getDate() + 7);
            const sevenDaysLaterStr = `${sevenDaysLater.getFullYear()}-${String(sevenDaysLater.getMonth() + 1).padStart(2, '0')}-${String(sevenDaysLater.getDate()).padStart(2, '0')}`;
            console.log(`ä¿æŒæœŸé–“: ${sevenDaysAgoStr} ã€œ ${sevenDaysLaterStr}`);

            // å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€ã¾ãŸã¯æœŸé™åˆ‡ã‚Œã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤
            const keysToDelete = [];
            programCache.forEach((value, key) => {
                // ã‚­ãƒ¼ã®å½¢å¼: "JP27_2025-01-23" ã¾ãŸã¯ "JP27_now"
                const parts = key.split('_');
                if (parts.length === 2) {
                    const date = parts[1];

                    // ä¿æŒæœŸé–“å¤–ã®æ—¥ä»˜ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯å‰Šé™¤
                    if (date !== 'now' && (date < sevenDaysAgoStr || date > sevenDaysLaterStr)) {
                        console.log(`  å‰Šé™¤ç†ç”±: ä¿æŒæœŸé–“å¤– - ${key} (ä¿æŒæœŸé–“: ${sevenDaysAgoStr} ã€œ ${sevenDaysLaterStr})`);
                        keysToDelete.push({ key, reason: 'ä¿æŒæœŸé–“å¤–' });
                        return;
                    }

                    // æœŸé™åˆ‡ã‚Œï¼ˆ30åˆ†ä»¥ä¸ŠçµŒéï¼‰ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚å‰Šé™¤
                    if (!isCacheValid(value)) {
                        const age = Math.floor((Date.now() - value.timestamp) / 60000);
                        console.log(`  å‰Šé™¤ç†ç”±: æœŸé™åˆ‡ã‚Œ - ${key} (${age}åˆ†çµŒé)`);
                        keysToDelete.push({ key, reason: `æœŸé™åˆ‡ã‚Œ(${age}åˆ†)` });
                        return;
                    }

                    // æœ‰åŠ¹ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥
                    const age = Math.floor((Date.now() - value.timestamp) / 60000);
                    console.log(`  ä¿æŒ: ${key} (${age}åˆ†çµŒé, æœ‰åŠ¹æœŸé™å†…)`);
                }
            });

            keysToDelete.forEach(item => {
                programCache.delete(item.key);
                console.log(`âŒ å‰Šé™¤: ${item.key} (${item.reason})`);
            });

            if (keysToDelete.length > 0) {
                console.log(`âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†: ${keysToDelete.length}ä»¶å‰Šé™¤`);
                // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¾Œã«localStorageã‚’æ›´æ–°
                saveCacheToStorage();
            } else {
                console.log('âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—: å‰Šé™¤å¯¾è±¡ãªã—');
            }
            console.log(`ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¾Œã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ•°: ${programCache.size}ä»¶`);
        }

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•°
        function isCacheValid(cacheEntry) {
            if (!cacheEntry || !cacheEntry.timestamp) {
                return false;
            }
            const now = Date.now();
            const age = now - cacheEntry.timestamp;
            return age < CACHE_EXPIRE_MS;
        }

        // ç•ªçµ„æ¤œç´¢ã‚¿ãƒ–ã®åˆæœŸåŒ–ï¼ˆæœ¬æ—¥ã®ç¾åœ¨æ™‚åˆ»ã®ç•ªçµ„ã‚’è¡¨ç¤ºï¼‰
        function initializeSearchTab() {
            // æœ¬æ—¥ã®æ—¥ä»˜ã‚’è¨­å®š
            const today = new Date();
            const dateStr = today.toISOString().slice(0, 10);
            document.getElementById('targetDate').value = dateStr;

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¨ãƒªã‚¢ãŒé¸æŠã•ã‚Œã¦ã„ã‚Œã°ç•ªçµ„ã‚’å–å¾—
            const areaId = document.getElementById('areaId').value;
            if (areaId) {
                fetchPrograms();
            }
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tabName) {
            // å…¨ã¦ã®ã‚¿ãƒ–ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // ç¾åœ¨ã®ã‚¿ãƒ–ã‚’localStorageã«ä¿å­˜
            localStorage.setItem('currentTab', tabName);

            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            if (tabName === 'search') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('searchTab').classList.add('active');
                // ç•ªçµ„æ¤œç´¢ã‚¿ãƒ–ã‚’é–‹ã„ãŸæ™‚ã«æœ¬æ—¥ã®ç•ªçµ„ã‚’è‡ªå‹•è¡¨ç¤ºï¼ˆåˆå›ã®ã¿ï¼‰
                if (!document.getElementById('searchTab').dataset.initialized) {
                    initializeSearchTab();
                    document.getElementById('searchTab').dataset.initialized = 'true';
                }
            } else if (tabName === 'files') {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('filesTab').classList.add('active');
                // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ãƒ–ã‚’é–‹ã„ãŸæ™‚ã«è‡ªå‹•èª­ã¿è¾¼ã¿
                loadRecordedFiles();
            } else if (tabName === 'at') {
                document.querySelectorAll('.tab')[2].classList.add('active');
                document.getElementById('atTab').classList.add('active');
                // atäºˆç´„ã‚¿ãƒ–ã‚’é–‹ã„ãŸæ™‚ã«è‡ªå‹•èª­ã¿è¾¼ã¿
                loadAtJobs();
            } else if (tabName === 'cron') {
                document.querySelectorAll('.tab')[3].classList.add('active');
                document.getElementById('cronTab').classList.add('active');
                // cronã‚¿ãƒ–ã‚’é–‹ã„ãŸæ™‚ã«è‡ªå‹•èª­ã¿è¾¼ã¿
                loadCronJobs();
            } else if (tabName === 'admin') {
                document.querySelectorAll('.tab')[4].classList.add('active');
                document.getElementById('adminTab').classList.add('active');
                // ç®¡ç†ã‚¿ãƒ–ã‚’é–‹ã„ãŸæ™‚ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ã‚’èª­ã¿è¾¼ã¿
                loadDefaultArtworkPreview();
            }
        }

        // ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const overlay = document.getElementById('menuOverlay');
            menu.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        // ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
        function closeMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const overlay = document.getElementById('menuOverlay');
            menu.classList.remove('active');
            overlay.classList.remove('active');
        }

        // ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã‚¿ãƒ–ã‚’åˆ‡ã‚Šæ›¿ãˆ
        function switchTabMobile(tabName) {
            // ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.mobile-menu-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.mobile-menu-item[data-tab="${tabName}"]`).classList.add('active');

            // æ—¢å­˜ã®ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆé–¢æ•°ã‚’å‘¼ã³å‡ºã—
            switchTab(tabName);

            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
            closeMobileMenu();
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½
        async function logout() {
            if (!confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch('/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæˆåŠŸ - ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                    window.location.href = '/login.html';
                } else {
                    alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('Logout error:', error);
                alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ä»Šæ—¥ã®æ—¥ä»˜ã¨ã‚¨ãƒªã‚¢ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’è¨­å®š
        document.addEventListener('DOMContentLoaded', async function() {
            // æ—§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
            if (localStorage.getItem('radikoCache')) {
                console.log('ğŸ—‘ï¸ æ—§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤');
                localStorage.removeItem('radikoCache');
            }

            // IndexedDBãŒã‚ã‚Œã°å‰Šé™¤
            try {
                indexedDB.deleteDatabase('RadikoCacheDB');
                console.log('ğŸ—‘ï¸ æ—§IndexedDBã‚’å‰Šé™¤');
            } catch (err) {
                console.log('â„¹ï¸ IndexedDBå‰Šé™¤ã‚¹ã‚­ãƒƒãƒ—');
            }

            console.log('âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚·ã‚¹ãƒ†ãƒ : ã‚µãƒ¼ãƒãƒ¼å´DBä½¿ç”¨')

            // ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‚¿ãƒ–ã‚’å¾©å…ƒ
            const savedTab = localStorage.getItem('currentTab');
            if (savedTab) {
                switchTab(savedTab);
            }

            // æ—¥æœ¬æ™‚é–“ã§ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—ï¼ˆæœ5æ™‚ã‚’æ—¥ä»˜ã®å¤‰ã‚ã‚Šç›®ã¨ã™ã‚‹ï¼‰
            const now = new Date();
            const today = new Date(now);

            // æœ5æ™‚æœªæº€ã®å ´åˆã¯å‰æ—¥ã¨ã—ã¦æ‰±ã†
            if (today.getHours() < 5) {
                today.setDate(today.getDate() - 1);
            }

            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;

            document.getElementById('targetDate').value = dateStr;

            // éå»7æ—¥é–“ + ä»Šæ—¥ + æœªæ¥7æ—¥é–“ã®æ—¥ä»˜ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆï¼ˆè¨ˆ15æ—¥é–“ï¼‰
            const dateButtonsContainer = document.getElementById('dateButtons');
            const dayLabels = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];

            for (let i = -7; i <= 7; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() + i);

                const btnYear = date.getFullYear();
                const btnMonth = String(date.getMonth() + 1).padStart(2, '0');
                const btnDay = String(date.getDate()).padStart(2, '0');
                const btnDateStr = `${btnYear}-${btnMonth}-${btnDay}`;
                const dayOfWeek = dayLabels[date.getDay()];

                const button = document.createElement('button');
                button.type = 'button';

                // ä»Šæ—¥ã®å ´åˆã¯ã€Œä»Šæ—¥ã€ã¨è¡¨ç¤º
                if (i === 0) {
                    button.textContent = `ä»Šæ—¥ ${btnMonth}/${btnDay}(${dayOfWeek})`;
                } else {
                    button.textContent = `${btnMonth}/${btnDay}(${dayOfWeek})`;
                }

                button.dataset.date = btnDateStr;

                // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
                if (i === 0) {
                    button.style.cssText = 'padding: 4px 8px; border: 1px solid #667eea; background: #667eea; color: white; border-radius: 4px; font-size: 0.8em; cursor: pointer; transition: all 0.15s;';
                } else {
                    button.style.cssText = 'padding: 4px 8px; border: 1px solid #ced4da; background: #f8f9fa; color: #6c757d; border-radius: 4px; font-size: 0.8em; cursor: pointer; transition: all 0.15s;';
                }

                button.addEventListener('click', async function() {
                    // ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
                    dateButtonsContainer.querySelectorAll('button').forEach(btn => {
                        btn.style.cssText = 'padding: 4px 8px; border: 1px solid #ced4da; background: #f8f9fa; color: #6c757d; border-radius: 4px; font-size: 0.8em; cursor: pointer; transition: all 0.15s;';
                    });

                    // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
                    this.style.cssText = 'padding: 4px 8px; border: 1px solid #667eea; background: #667eea; color: white; border-radius: 4px; font-size: 0.8em; cursor: pointer; transition: all 0.15s;';

                    // éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«æ—¥ä»˜ã‚’è¨­å®š
                    document.getElementById('targetDate').value = this.dataset.date;

                    // ç•ªçµ„è¡¨ã‚’è‡ªå‹•å–å¾—
                    await fetchPrograms();
                });

                dateButtonsContainer.appendChild(button);

                // ä»Šæ—¥ã®ãƒœã‚¿ãƒ³ã®å ´åˆã€åˆæœŸè¡¨ç¤ºç”¨ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¿å­˜
                if (i === 0) {
                    // DOMContentLoadedå®Œäº†å¾Œã«è‡ªå‹•ã§ç•ªçµ„è¡¨ã‚’å–å¾—
                    setTimeout(() => {
                        button.click();
                    }, 100);
                }
            }

            // ã‚¨ãƒªã‚¢ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’å¤§é˜ªã«è¨­å®š
            document.getElementById('areaId').value = 'JP27';

            // ã‚¹ãƒãƒ›ç”¨date pickerã®åˆæœŸå€¤ã¨ç¯„å›²ã‚’è¨­å®š
            const datePicker = document.getElementById('datePicker');
            datePicker.value = dateStr;

            // é¸æŠå¯èƒ½ãªæ—¥ä»˜ç¯„å›²ã‚’è¨­å®šï¼ˆéå»7æ—¥ï½æœªæ¥7æ—¥ï¼‰
            const minDate = new Date(today);
            minDate.setDate(minDate.getDate() - 7);
            const maxDate = new Date(today);
            maxDate.setDate(maxDate.getDate() + 7);

            const minDateStr = `${minDate.getFullYear()}-${String(minDate.getMonth() + 1).padStart(2, '0')}-${String(minDate.getDate()).padStart(2, '0')}`;
            const maxDateStr = `${maxDate.getFullYear()}-${String(maxDate.getMonth() + 1).padStart(2, '0')}-${String(maxDate.getDate()).padStart(2, '0')}`;

            datePicker.min = minDateStr;
            datePicker.max = maxDateStr;

            datePicker.addEventListener('change', async function() {
                // é¸æŠã•ã‚ŒãŸæ—¥ä»˜ã‚’éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®š
                document.getElementById('targetDate').value = this.value;

                // ç•ªçµ„è¡¨ã‚’è‡ªå‹•å–å¾—
                await fetchPrograms();
            });

            // audioPlayerã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
            const audioPlayer = document.getElementById('audioPlayer');
            if (audioPlayer) {
                // play/pause/endedã‚¤ãƒ™ãƒ³ãƒˆã¯HTMLå±æ€§ã§å‡¦ç†ï¼ˆplaybackStateæ›´æ–°ã®ãŸã‚ï¼‰
                // ã“ã“ã§ã¯ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã®ã¿
                audioPlayer.addEventListener('play', () => {
                    console.log('â–¶ï¸ [Audio Event] play');
                });
                audioPlayer.addEventListener('pause', () => {
                    console.log('â¸ï¸ [Audio Event] pause');
                });
                audioPlayer.addEventListener('ended', () => {
                    console.log('â¹ï¸ [Audio Event] ended');
                });
                audioPlayer.addEventListener('error', (e) => {
                    console.error('âŒ [Audio Event] error:', e);
                    console.error('Error details:', audioPlayer.error);
                });
                audioPlayer.addEventListener('stalled', () => {
                    console.warn('âš ï¸ [Audio Event] stalled - playback stopped due to lack of data');
                    console.log('ğŸ“Š [Stalled Debug] paused:', audioPlayer.paused, 'readyState:', audioPlayer.readyState, 'networkState:', audioPlayer.networkState);

                    // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ¶é™ã«ã‚ˆã‚‹åœæ­¢ã®å¯èƒ½æ€§
                    // æ¡ä»¶ã«é–¢ä¿‚ãªãã€å†ç”Ÿã‚’è©¦ã¿ã‚‹
                    if (!audioPlayer.paused) {
                        console.log('ğŸ”„ [Audio Recovery] Attempting to resume after stall...');
                        console.log('ğŸ”„ [Audio Recovery] Will retry in 2 seconds...');
                        setTimeout(() => {
                            console.log('ğŸ”„ [Audio Recovery] Retrying now...');
                            console.log('ğŸ“Š [Recovery Debug] paused:', audioPlayer.paused, 'readyState:', audioPlayer.readyState);

                            // pausedã§ãªã‘ã‚Œã°å†ç”Ÿã‚’è©¦ã¿ã‚‹ï¼ˆreadyStateã«é–¢ä¿‚ãªãï¼‰
                            if (!audioPlayer.paused) {
                                console.log('ğŸ”„ [Audio Recovery] Calling play()...');
                                audioPlayer.play().then(() => {
                                    console.log('âœ… [Audio Recovery] Play succeeded');
                                }).catch(err => {
                                    console.error('âŒ [Audio Recovery] Play failed:', err);
                                    // play()ãŒå¤±æ•—ã—ãŸã‚‰load()ã—ã¦ã‹ã‚‰å†è©¦è¡Œ
                                    console.log('ğŸ”„ [Audio Recovery] Trying load() + play()...');
                                    audioPlayer.load();
                                    setTimeout(() => {
                                        audioPlayer.play().catch(err2 => {
                                            console.error('âŒ [Audio Recovery] Second attempt failed:', err2);
                                        });
                                    }, 500);
                                });
                            } else {
                                console.log('â„¹ï¸ [Audio Recovery] Audio is paused, skipping recovery');
                            }
                        }, 2000);
                    } else {
                        console.log('â„¹ï¸ [Stalled] Audio is already paused, no recovery needed');
                    }
                });
                audioPlayer.addEventListener('waiting', () => {
                    console.log('â³ [Audio Event] waiting - buffering...');
                });
                audioPlayer.addEventListener('playing', () => {
                    console.log('â–¶ï¸ [Audio Event] playing - playback started after pause/waiting');
                });
                audioPlayer.addEventListener('loadstart', () => {
                    console.log('ğŸ“¥ [Audio Event] loadstart - started loading');
                });
                audioPlayer.addEventListener('loadeddata', () => {
                    console.log('ğŸ“¦ [Audio Event] loadeddata - first frame loaded');
                });
                console.log('âœ… Audio player event listeners initialized');
            }
        });

        // ã€Œç•ªçµ„è¡¨ã‚’å–å¾—ã€ãƒœã‚¿ãƒ³ã¯å¼·åˆ¶æ›´æ–°
        document.getElementById('fetchBtn').addEventListener('click', () => fetchPrograms(true));
        document.getElementById('searchAllBtn').addEventListener('click', searchAllAreas);

        // ã‚¨ãƒªã‚¢é¸æŠå¤‰æ›´æ™‚ã«è‡ªå‹•å–å¾—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ©ç”¨ï¼‰
        document.getElementById('areaId').addEventListener('change', () => fetchPrograms(false));

        // æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›æ™‚ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        document.getElementById('searchKeyword').addEventListener('input', function() {
            // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
            const clearBtn = document.getElementById('clearSearchBtn');
            if (clearBtn) {
                clearBtn.style.display = this.value ? 'block' : 'none';
            }

            // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆ
            const timelineBtn = document.getElementById('timelineViewBtn');
            if (this.value.trim()) {
                // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ä¸­ã¯ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                timelineBtn.disabled = true;
                timelineBtn.style.opacity = '0.5';
                timelineBtn.style.cursor = 'not-allowed';
            } else {
                // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°è§£é™¤æ™‚ã¯æœ‰åŠ¹åŒ–
                timelineBtn.disabled = false;
                timelineBtn.style.opacity = '1';
                timelineBtn.style.cursor = 'pointer';
            }

            if (allProgramsData.length > 0) {
                displayPrograms(allProgramsData);
            }
        });

        // æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªã‚¢
        function clearSearchKeyword() {
            const searchInput = document.getElementById('searchKeyword');
            const clearBtn = document.getElementById('clearSearchBtn');

            searchInput.value = '';
            if (clearBtn) {
                clearBtn.style.display = 'none';
            }

            // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            const timelineBtn = document.getElementById('timelineViewBtn');
            timelineBtn.disabled = false;
            timelineBtn.style.opacity = '1';
            timelineBtn.style.cursor = 'pointer';

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’æ›´æ–°
            if (allProgramsData.length > 0) {
                displayPrograms(allProgramsData);
            }
        }

        // å…¨ã‚¨ãƒªã‚¢æ¤œç´¢çµæœã‹ã‚‰å…ƒã®ç•ªçµ„è¡¨ã«æˆ»ã‚‹
        function returnToAreaPrograms() {
            // æ¤œç´¢çµæœã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’éè¡¨ç¤º
            document.getElementById('searchResultsIndicator').style.display = 'none';

            // ä¿å­˜ã•ã‚ŒãŸã‚¨ãƒªã‚¢ç•ªçµ„è¡¨ãŒã‚ã‚‹å ´åˆã¯å¾©å…ƒ
            if (areaPrograms && areaPrograms.length > 0) {
                displayPrograms(areaPrograms);
            } else {
                // ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯å†å–å¾—
                fetchPrograms(false);
            }
        }

        async function fetchPrograms(forceRefresh = false) {
            const areaId = document.getElementById('areaId').value;
            const proxyUrl = document.getElementById('proxyUrl').value;
            const targetDate = document.getElementById('targetDate').value;

            if (!areaId) {
                showError('ã‚¨ãƒªã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const programList = document.getElementById('programList');
            const fetchBtn = document.getElementById('fetchBtn');
            const timelineView = document.getElementById('timelineView');

            loading.style.display = 'block';
            error.style.display = 'none';
            programList.innerHTML = '';
            fetchBtn.disabled = true;

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã¯ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’éè¡¨ç¤º
            const isTimelineMode = timelineView.style.display !== 'none';
            if (isTimelineMode) {
                timelineView.style.display = 'none';
            }

            // å…¨ã‚¨ãƒªã‚¢æ¤œç´¢çµæœã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’éè¡¨ç¤ºï¼ˆé€šå¸¸ã®ç•ªçµ„è¡¨å–å¾—æ™‚ï¼‰
            document.getElementById('searchResultsIndicator').style.display = 'none';

            try {
                // DB APIã‹ã‚‰ç•ªçµ„è¡¨ã‚’å–å¾—
                const baseApiUrl = proxyUrl.trim() || '';
                const dateStr = targetDate ? targetDate.replace(/-/g, '') : new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const forceParam = forceRefresh ? '?force=true' : '';
                const apiUrl = `${baseApiUrl}/api/programs/area/${areaId}/date/${dateStr}${forceParam}`;

                console.log('ğŸ“¡ Fetching from DB API:', apiUrl, forceRefresh ? '(å¼·åˆ¶æ›´æ–°)' : '');
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'ç•ªçµ„è¡¨ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                console.log(`âœ… Loaded ${data.count} programs from DB`);

                // DB APIã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å½¢å¼ã«å¤‰æ›
                const allPrograms = data.programs.map(prog => ({
                    stationId: prog.stationId,
                    stationName: prog.stationName,
                    title: prog.title,
                    ft: new Date(prog.ft),
                    to: new Date(prog.to),
                    desc: prog.desc || 'èª¬æ˜ãªã—',
                    pfm: prog.pfm || '',
                    info: prog.info || '',
                    url: prog.url || ''
                }));

                // æ™‚åˆ»é †ã«ã‚½ãƒ¼ãƒˆ
                allPrograms.sort((a, b) => a.ft - b.ft);

                // ã‚¨ãƒªã‚¢ç•ªçµ„è¡¨ã‚’ä¿å­˜
                areaPrograms = allPrograms;
                currentAreaId = areaId;

                displayPrograms(allPrograms);

                // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã ã£ãŸå ´åˆã¯å†è¡¨ç¤º
                if (isTimelineMode) {
                    timelineView.style.display = 'block';
                }

            } catch (err) {
                showError(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${err.message}`);
            } finally {
                loading.style.display = 'none';
                fetchBtn.disabled = false;
            }
        }

        function parseRadikoTime(timeStr) {
            const year = parseInt(timeStr.substring(0, 4), 10);
            const month = parseInt(timeStr.substring(4, 6), 10) - 1;
            const day = parseInt(timeStr.substring(6, 8), 10);
            const hour = parseInt(timeStr.substring(8, 10), 10);
            const minute = parseInt(timeStr.substring(10, 12), 10);
            const second = parseInt(timeStr.substring(12, 14), 10);
            return new Date(year, month, day, hour, minute, second);
        }

        function formatDateTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hour = String(date.getHours()).padStart(2, '0');
            const minute = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day} ${hour}:${minute}`;
        }

        function displayPrograms(programs) {
            const programList = document.getElementById('programList');
            programList.innerHTML = '';
            allProgramsData = programs;

            if (programs.length === 0) {
                programList.innerHTML = '<p class="loading">ç•ªçµ„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';
                return;
            }

            // æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const searchKeyword = document.getElementById('searchKeyword').value.trim().toLowerCase();
            const searchInfo = document.getElementById('searchInfo');
            let filteredPrograms = programs;

            if (searchKeyword) {
                filteredPrograms = programs.filter(prog =>
                    prog.title.toLowerCase().includes(searchKeyword) ||
                    (prog.pfm && prog.pfm.toLowerCase().includes(searchKeyword)) ||
                    (prog.desc && prog.desc.toLowerCase().includes(searchKeyword))
                );

                searchInfo.textContent = `ã€Œ${searchKeyword}ã€ã®æ¤œç´¢çµæœ: ${filteredPrograms.length}ä»¶ / å…¨${programs.length}ä»¶`;
                searchInfo.style.display = 'block';
            } else {
                searchInfo.style.display = 'none';
            }

            if (filteredPrograms.length === 0) {
                const noResultMsg = document.createElement('p');
                noResultMsg.className = 'loading';
                noResultMsg.style.gridColumn = '1 / -1';
                noResultMsg.textContent = `ã€Œ${searchKeyword}ã€ã«ä¸€è‡´ã™ã‚‹ç•ªçµ„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`;
                programList.appendChild(noResultMsg);
                return;
            }

            // æ—¥ä»˜ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼ˆæœ5æ™‚ã‚’æ—¥ä»˜ã®å¤‰ã‚ã‚Šç›®ã¨ã™ã‚‹ï¼‰
            const dateMap = new Map();
            filteredPrograms.forEach((prog, index) => {
                prog._index = programs.indexOf(prog); // å…ƒã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¿å­˜
                const progDate = new Date(prog.ft);

                // æœ5æ™‚æœªæº€ã®ç•ªçµ„ã¯å‰æ—¥ã¨ã—ã¦æ‰±ã†
                const displayDate = new Date(progDate);
                if (displayDate.getHours() < 5) {
                    displayDate.setDate(displayDate.getDate() - 1);
                }

                const dateKey = `${displayDate.getFullYear()}-${String(displayDate.getMonth() + 1).padStart(2, '0')}-${String(displayDate.getDate()).padStart(2, '0')}`;

                if (!dateMap.has(dateKey)) {
                    dateMap.set(dateKey, {
                        date: displayDate,
                        programs: []
                    });
                }
                dateMap.get(dateKey).programs.push(prog);
            });

            // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
            const sortedDates = Array.from(dateMap.keys()).sort();

            // æ—¥ä»˜ã”ã¨ã«è¡¨ç¤º
            sortedDates.forEach(dateKey => {
                const dateGroup = dateMap.get(dateKey);
                const programDate = dateGroup.date;
                const year = programDate.getFullYear();
                const month = programDate.getMonth() + 1;
                const day = programDate.getDate();
                const dayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][programDate.getDay()];

                // æ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼
                const dateHeaderElement = document.createElement('div');
                dateHeaderElement.style.cssText = 'grid-column: 1 / -1; padding: 15px 20px; margin-bottom: 20px; margin-top: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); text-align: center;';
                dateHeaderElement.innerHTML = `
                    <div style="font-size: 1.3em; font-weight: bold; margin-bottom: 5px;">
                        ğŸ“… ${year}å¹´${month}æœˆ${day}æ—¥ï¼ˆ${dayOfWeek}ï¼‰
                    </div>
                    <div style="font-size: 0.9em; opacity: 0.95;">
                        ${dateGroup.programs.length}ä»¶ã®ç•ªçµ„
                    </div>
                `;
                programList.appendChild(dateHeaderElement);

                // ã“ã®æ—¥ä»˜ã®ç•ªçµ„ã‚’æ”¾é€å±€ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
                const stationMap = new Map();
                dateGroup.programs.forEach(prog => {
                    if (!stationMap.has(prog.stationId)) {
                        stationMap.set(prog.stationId, {
                            name: prog.stationName,
                            id: prog.stationId,
                            programs: []
                        });
                    }
                    stationMap.get(prog.stationId).programs.push(prog);
                });

                displayStations(stationMap, programList);
            });

            // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºä¸­ã®å ´åˆã¯æ›´æ–°
            const timelineView = document.getElementById('timelineView');
            if (timelineView && timelineView.style.display !== 'none') {
                renderTimelineView(allProgramsData);
            }
        }

        // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰æ‹¡å¤§ãƒˆã‚°ãƒ«
        let expandedCard = null;

        function toggleCardExpansion(card) {
            // æ—¢ã«åˆ¥ã®ã‚«ãƒ¼ãƒ‰ãŒæ‹¡å¤§ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å…ƒã«æˆ»ã™
            if (expandedCard && expandedCard !== card) {
                expandedCard.classList.remove('expanded');
            }

            // ã“ã®ã‚«ãƒ¼ãƒ‰ã‚’ãƒˆã‚°ãƒ«
            card.classList.toggle('expanded');

            if (card.classList.contains('expanded')) {
                expandedCard = card;
                // æ‹¡å¤§æ™‚ã¯å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
                setTimeout(() => {
                    document.addEventListener('click', closeExpandedCard);
                }, 10);
            } else {
                expandedCard = null;
                document.removeEventListener('click', closeExpandedCard);
            }
        }

        function closeExpandedCard(e) {
            if (expandedCard && !expandedCard.contains(e.target)) {
                expandedCard.classList.remove('expanded');
                expandedCard = null;
                document.removeEventListener('click', closeExpandedCard);
            }
        }

        // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        function switchViewMode(mode) {
            const listView = document.getElementById('programList');
            const timelineView = document.getElementById('timelineView');
            const listBtn = document.getElementById('listViewBtn');
            const timelineBtn = document.getElementById('timelineViewBtn');
            const searchKeyword = document.getElementById('searchKeyword');
            const searchAllBtn = document.getElementById('searchAllBtn');

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ä¸­ã¯ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã§ããªã„
            if (mode === 'timeline' && searchKeyword.value.trim()) {
                alert('ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ä¸­ã¯ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤ºã§ãã¾ã›ã‚“ã€‚\nçµã‚Šè¾¼ã¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            if (mode === 'timeline') {
                listView.style.display = 'none';
                timelineView.style.display = 'block';
                listBtn.style.background = '#95a5a6';
                timelineBtn.style.background = '#27ae60';

                // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯æ¤œç´¢æ©Ÿèƒ½ã‚’ç„¡åŠ¹åŒ–
                searchKeyword.disabled = true;
                searchKeyword.style.opacity = '0.5';
                searchAllBtn.disabled = true;
                searchAllBtn.style.opacity = '0.5';

                // æ¤œç´¢çµæœã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’éè¡¨ç¤ºï¼ˆã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã¯æ¤œç´¢éå¯¾å¿œï¼‰
                document.getElementById('searchResultsIndicator').style.display = 'none';

                // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ“ãƒ¥ãƒ¼ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                if (allProgramsData && allProgramsData.length > 0) {
                    renderTimelineView(allProgramsData);
                }
            } else {
                listView.style.display = 'grid';
                timelineView.style.display = 'none';
                listBtn.style.background = '#27ae60';
                timelineBtn.style.background = '#95a5a6';

                // ãƒªã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚ã¯æ¤œç´¢æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–
                searchKeyword.disabled = false;
                searchKeyword.style.opacity = '1';
                searchAllBtn.disabled = false;
                searchAllBtn.style.opacity = '1';
            }
        }

        // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ“ãƒ¥ãƒ¼ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderTimelineView(programs) {
            const timelineContainer = document.getElementById('timelineContainer');
            timelineContainer.innerHTML = '';

            if (programs.length === 0) {
                timelineContainer.innerHTML = '<p style="padding: 40px; text-align: center; color: #6c757d;">ç•ªçµ„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const searchKeyword = document.getElementById('searchKeyword').value.trim().toLowerCase();
            let filteredPrograms = programs;

            if (searchKeyword) {
                filteredPrograms = programs.filter(prog =>
                    prog.title.toLowerCase().includes(searchKeyword) ||
                    (prog.pfm && prog.pfm.toLowerCase().includes(searchKeyword)) ||
                    (prog.desc && prog.desc.toLowerCase().includes(searchKeyword))
                );
            }

            if (filteredPrograms.length === 0) {
                timelineContainer.innerHTML = `<p style="padding: 40px; text-align: center; color: #6c757d;">ã€Œ${searchKeyword}ã€ã«ä¸€è‡´ã™ã‚‹ç•ªçµ„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>`;
                return;
            }

            // æ”¾é€å±€ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const stationMap = new Map();
            filteredPrograms.forEach(prog => {
                if (!stationMap.has(prog.stationId)) {
                    stationMap.set(prog.stationId, {
                        name: prog.stationName,
                        id: prog.stationId,
                        programs: []
                    });
                }
                stationMap.get(prog.stationId).programs.push(prog);
            });

            // ã‚°ãƒªãƒƒãƒ‰ã®åˆ—æ•°ã‚’è¨­å®šï¼ˆæ™‚åˆ»åˆ— + æ”¾é€å±€åˆ—ï¼‰
            const stationCount = stationMap.size;
            timelineContainer.style.gridTemplateColumns = `80px repeat(${stationCount}, 200px)`;

            // æ™‚é–“ç¯„å›²ã‚’è¨ˆç®—ï¼ˆ5:00-29:00ï¼‰
            const startHour = 5;
            const endHour = 29; // ç¿Œæ—¥5æ™‚
            const hours = [];
            for (let h = startHour; h <= endHour; h++) {
                hours.push(h);
            }

            // æ™‚åˆ»è»¸ã‚«ãƒ©ãƒ ã‚’ä½œæˆ
            const timeColumn = document.createElement('div');
            timeColumn.className = 'timeline-time-column';

            // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆç©ºï¼‰
            const timeHeader = document.createElement('div');
            timeHeader.className = 'timeline-station-header';
            timeHeader.style.background = '#2c3e50';
            timeHeader.textContent = 'æ™‚åˆ»';
            timeColumn.appendChild(timeHeader);

            // æ™‚åˆ»ã‚»ãƒ«ã‚’è¿½åŠ 
            hours.forEach(hour => {
                const timeCell = document.createElement('div');
                timeCell.className = 'timeline-time-cell';
                const displayHour = hour >= 24 ? hour - 24 : hour;
                timeCell.textContent = `${String(displayHour).padStart(2, '0')}:00`;
                timeColumn.appendChild(timeCell);
            });

            timelineContainer.appendChild(timeColumn);

            // å„æ”¾é€å±€ã®ã‚«ãƒ©ãƒ ã‚’ä½œæˆ
            Array.from(stationMap.values()).forEach(station => {
                const stationColumn = document.createElement('div');
                stationColumn.style.position = 'relative';

                // æ”¾é€å±€ãƒ˜ãƒƒãƒ€ãƒ¼
                const stationHeader = document.createElement('div');
                stationHeader.className = 'timeline-station-header';
                stationHeader.textContent = station.name;
                stationHeader.title = `${station.name} (${station.id})`;
                stationColumn.appendChild(stationHeader);

                // å„æ™‚é–“å¸¯ã®ã‚»ãƒ«
                hours.forEach(hour => {
                    const hourCell = document.createElement('div');
                    hourCell.style.height = '60px';
                    hourCell.style.position = 'relative';
                    hourCell.style.borderBottom = '1px solid #e9ecef';
                    hourCell.style.background = '#fafafa';
                    stationColumn.appendChild(hourCell);
                });

                // ç•ªçµ„ã‚«ãƒ¼ãƒ‰ã‚’é…ç½®
                station.programs.forEach(prog => {
                    const startTime = new Date(prog.ft);
                    const endTime = new Date(prog.to);

                    // é–‹å§‹æ™‚åˆ»ã‚’5æ™‚åŸºæº–ã«å¤‰æ›
                    let progStartHour = startTime.getHours();
                    const progStartMinute = startTime.getMinutes();

                    // 0-4æ™‚ã®ç•ªçµ„ã¯24-28æ™‚ã¨ã—ã¦æ‰±ã†
                    if (progStartHour < 5) {
                        progStartHour += 24;
                    }

                    // 5æ™‚ã‹ã‚‰ã®ç›¸å¯¾ä½ç½®ã‚’è¨ˆç®—
                    const minutesFromStart = (progStartHour - startHour) * 60 + progStartMinute;
                    const topPosition = minutesFromStart; // 1åˆ† = 1px

                    // ç•ªçµ„ã®é•·ã•ã‚’è¨ˆç®—
                    const durationMinutes = (endTime - startTime) / 1000 / 60;
                    const height = Math.max(durationMinutes, 15); // æœ€å°15px

                    // è¡¨ç¤ºç¯„å›²å†…ã®ã¿è¡¨ç¤º
                    if (progStartHour >= startHour && progStartHour < endHour) {
                        const programCard = document.createElement('div');
                        programCard.className = 'timeline-program-card';

                        // é«˜ã•ãŒ30pxæœªæº€ã®å ´åˆã¯narrowã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                        if (height < 30) {
                            programCard.classList.add('narrow');
                        }

                        programCard.style.top = `${topPosition + 52}px`; // ãƒ˜ãƒƒãƒ€ãƒ¼åˆ†ã‚ªãƒ•ã‚»ãƒƒãƒˆ
                        programCard.style.height = `${height - 4}px`;
                        programCard.style.cursor = 'pointer';

                        const startTimeStr = `${String(startTime.getHours()).padStart(2, '0')}:${String(startTime.getMinutes()).padStart(2, '0')}`;
                        const endTimeStr = `${String(endTime.getHours()).padStart(2, '0')}:${String(endTime.getMinutes()).padStart(2, '0')}`;

                        programCard.innerHTML = `
                            <div class="timeline-program-time">
                                ${startTimeStr}-${endTimeStr}
                            </div>
                            <div class="timeline-program-title">
                                ${prog.title}
                            </div>
                            ${height < 30 ? '<span class="timeline-expand-hint">ğŸ”</span>' : ''}
                        `;

                        // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ - è©³ç´°è¡¨ç¤º
                        programCard.onclick = (e) => {
                            e.stopPropagation();
                            showProgramDetail(prog);
                        };

                        // ãƒ›ãƒãƒ¼æ™‚ã«ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã‚’æ¤œå‡ºã—ã¦æ‹¡å¤§
                        let hoverTimer;
                        programCard.addEventListener('mouseenter', () => {
                            hoverTimer = setTimeout(() => {
                                // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é«˜ã•ã¨è¡¨ç¤ºé«˜ã•ã‚’æ¯”è¼ƒ
                                if (programCard.scrollHeight > programCard.clientHeight) {
                                    programCard.classList.add('hover-expanded');
                                }
                            }, 800); // 0.8ç§’å¾Œã«åˆ¤å®š
                        });

                        programCard.addEventListener('mouseleave', () => {
                            clearTimeout(hoverTimer);
                            programCard.classList.remove('hover-expanded');
                        });

                        // å³ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯é•·æŠ¼ã—ã§æ‹¡å¤§è¡¨ç¤ºï¼ˆç‹­ã„ã‚«ãƒ¼ãƒ‰ã®å ´åˆï¼‰
                        if (height < 30) {
                            let longPressTimer;

                            programCard.addEventListener('contextmenu', (e) => {
                                e.preventDefault();
                                toggleCardExpansion(programCard);
                            });

                            programCard.addEventListener('touchstart', (e) => {
                                longPressTimer = setTimeout(() => {
                                    toggleCardExpansion(programCard);
                                }, 500);
                            });

                            programCard.addEventListener('touchend', () => {
                                clearTimeout(longPressTimer);
                            });

                            programCard.addEventListener('touchmove', () => {
                                clearTimeout(longPressTimer);
                            });
                        }

                        stationColumn.appendChild(programCard);
                    }
                });

                timelineContainer.appendChild(stationColumn);
            });
        }

        function displayStations(stationMap, programList) {
            // ã‚¹ãƒãƒ›åˆ¤å®šï¼ˆ768pxä»¥ä¸‹ï¼‰
            const isMobile = window.innerWidth <= 768;
            const mobileStationSelect = document.getElementById('mobileStationSelect');
            const stationSelector = document.getElementById('stationSelector');

            if (isMobile && mobileStationSelect) {
                // æ”¾é€å±€ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’è¡¨ç¤º
                if (stationSelector) {
                    stationSelector.style.display = 'block';
                }

                // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
                currentStationMap = stationMap;
                currentProgramList = programList;

                // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ï¼ˆæœ€åˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ä»¥å¤–ï¼‰
                while (mobileStationSelect.options.length > 1) {
                    mobileStationSelect.remove(1);
                }

                // æ”¾é€å±€ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
                const stationArray = Array.from(stationMap.values());
                stationArray.forEach(station => {
                    const option = document.createElement('option');
                    option.value = station.id;
                    option.textContent = station.name;
                    mobileStationSelect.appendChild(option);
                });

                // æœ€åˆã®æ”¾é€å±€ã‚’è‡ªå‹•é¸æŠ
                if (stationArray.length > 0) {
                    const firstStationId = stationArray[0].id;
                    mobileStationSelect.value = firstStationId;

                    // å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ ï¼ˆåˆå›ã®ã¿ï¼‰
                    if (!mobileStationSelect.dataset.initialized) {
                        mobileStationSelect.addEventListener('change', function() {
                            const selectedStationId = this.value;
                            if (selectedStationId && currentStationMap && currentProgramList) {
                                // é¸æŠã•ã‚ŒãŸæ”¾é€å±€ã®ã¿ã‚’è¡¨ç¤º
                                displaySelectedStation(currentStationMap, currentProgramList, selectedStationId);
                            }
                        });
                        mobileStationSelect.dataset.initialized = 'true';
                    }

                    // åˆå›è¡¨ç¤º: æœ€åˆã®æ”¾é€å±€ã‚’è¡¨ç¤º
                    displaySelectedStation(stationMap, programList, firstStationId);
                    return; // ã‚¹ãƒãƒ›ã®å ´åˆã¯ã“ã“ã§çµ‚äº†
                }
            } else {
                // PCæ™‚ã¯æ”¾é€å±€ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’éè¡¨ç¤º
                if (stationSelector) {
                    stationSelector.style.display = 'none';
                }
            }

            // PCç”¨: å„æ”¾é€å±€ã®åˆ—ã‚’ä½œæˆ
            stationMap.forEach((station, stationId) => {
                const column = document.createElement('div');
                column.className = 'station-column';

                const header = document.createElement('div');
                header.className = 'station-header';
                header.textContent = `${station.name} (${station.id})`;
                column.appendChild(header);

                const programsContainer = document.createElement('div');
                programsContainer.className = 'station-programs';

                const now = new Date();
                let nowPlayingCard = null;

                // æ™‚åˆ»é †ã«ã‚½ãƒ¼ãƒˆ
                station.programs.sort((a, b) => a.ft - b.ft);

                station.programs.forEach(prog => {
                    const card = document.createElement('div');
                    card.className = 'program-card';

                    // æ”¾é€ä¸­ã®ç•ªçµ„ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                    if (prog.ft <= now && prog.to > now) {
                        card.classList.add('now-playing');
                        nowPlayingCard = card;
                    }

                    const startTime = `${String(prog.ft.getHours()).padStart(2, '0')}:${String(prog.ft.getMinutes()).padStart(2, '0')}`;
                    const endTime = `${String(prog.to.getHours()).padStart(2, '0')}:${String(prog.to.getMinutes()).padStart(2, '0')}`;

                    // ç•ªçµ„ãŒçµ‚äº†ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    const isPastProgram = prog.to < now;
                    const isFutureProgram = prog.ft > now;

                    // radikoã‚¿ã‚¤ãƒ ã‚·ãƒ•ãƒˆæœŸé–“ãƒã‚§ãƒƒã‚¯ï¼ˆæ”¾é€çµ‚äº†å¾Œ7æ—¥ä»¥å†…ï¼‰
                    const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    const isWithinTimeshift = prog.to >= sevenDaysAgo && prog.to < now;

                    // radikoã®URL
                    const radikoTime = formatRadikoUrl(prog.ft);
                    const radikoUrl = `https://radiko.jp/#!/ts/${prog.stationId}/${radikoTime}`;

                    // ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
                    let buttonsHtml = '';

                    // çµ‚äº†æ¸ˆã¿ç•ªçµ„ã‹ã¤ã‚¿ã‚¤ãƒ ã‚·ãƒ•ãƒˆæœŸé–“å†…ï¼šãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
                    if (isWithinTimeshift) {
                        buttonsHtml += `<button class="btn-action btn-download" onclick='event.stopPropagation(); showDownloadCommandByIndex(${prog._index})'>DL</button>`;
                    }

                    // æœªæ¥ã®ç•ªçµ„ã¾ãŸã¯æ”¾é€ä¸­ã®ç•ªçµ„ï¼šäºˆç´„ãƒœã‚¿ãƒ³
                    if (!isPastProgram) {
                        buttonsHtml += `<button class="btn-action btn-at" onclick='event.stopPropagation(); showAtCommandByIndex(${prog._index})'>äºˆç´„</button>`;
                    }

                    // å®šæœŸéŒ²éŸ³ãƒœã‚¿ãƒ³ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰
                    buttonsHtml += `<button class="btn-action btn-cron" onclick='event.stopPropagation(); showCronCommandByIndex(${prog._index})'>å®šæœŸ</button>`;

                    // radikoãƒœã‚¿ãƒ³ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰
                    buttonsHtml += `<a href="${radikoUrl}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()" style="background: white; border: 1px solid #ddd; padding: 3px; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; line-height: 1; border-radius: 4px; width: 24px; height: 24px;" title="radikoã§è´ã"><img src="img/radiko.png" alt="radiko" style="width: 18px; height: 18px; display: block;"></a>`;

                    card.innerHTML = `
                        <div class="program-time">${startTime} - ${endTime}</div>
                        <div class="program-title" style="color: #2c3e50; font-weight: 500;">${prog.title}</div>
                        ${prog.pfm ? `<div class="program-detail">${prog.pfm}</div>` : ''}
                        <div class="program-actions">
                            ${buttonsHtml}
                        </div>
                    `;

                    // ã‚«ãƒ¼ãƒ‰å…¨ä½“ã‚’ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«
                    card.style.cursor = 'pointer';
                    card.onclick = () => showProgramDetailByIndex(prog._index);

                    programsContainer.appendChild(card);
                });

                column.appendChild(programsContainer);
                programList.appendChild(column);

                // å„æ”¾é€å±€ã®ã‚³ãƒ³ãƒ†ãƒŠå†…ã§æ”¾é€ä¸­ã®ç•ªçµ„ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                if (nowPlayingCard) {
                    setTimeout(() => {
                        // station-programs ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ã®ä½ç½®ã‚’è¨ˆç®—
                        const containerTop = programsContainer.offsetTop;
                        const cardTop = nowPlayingCard.offsetTop;
                        const scrollPosition = cardTop - containerTop - 20; // 20pxã®ä½™ç™½

                        programsContainer.scrollTop = scrollPosition;
                    }, 100);
                }
            });
        }

        // ã‚¹ãƒãƒ›ç”¨: é¸æŠã•ã‚ŒãŸæ”¾é€å±€ã®ã¿ã‚’è¡¨ç¤º
        function displaySelectedStation(stationMap, programList, selectedStationId) {
            // æ—¢å­˜ã®å†…å®¹ã‚’ã‚¯ãƒªã‚¢
            programList.innerHTML = '';

            // é¸æŠã•ã‚ŒãŸæ”¾é€å±€ã‚’å–å¾—
            const selectedStation = stationMap.get(selectedStationId);
            if (!selectedStation) return;

            const column = document.createElement('div');
            column.className = 'station-column';

            const programsContainer = document.createElement('div');
            programsContainer.className = 'station-programs';

            const now = new Date();
            let nowPlayingCard = null;

            // æ™‚åˆ»é †ã«ã‚½ãƒ¼ãƒˆ
            selectedStation.programs.sort((a, b) => a.ft - b.ft);

            selectedStation.programs.forEach(prog => {
                const card = document.createElement('div');
                card.className = 'program-card';

                // æ”¾é€ä¸­ã®ç•ªçµ„ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                if (prog.ft <= now && prog.to > now) {
                    card.classList.add('now-playing');
                    nowPlayingCard = card;
                }

                const startTime = `${String(prog.ft.getHours()).padStart(2, '0')}:${String(prog.ft.getMinutes()).padStart(2, '0')}`;
                const endTime = `${String(prog.to.getHours()).padStart(2, '0')}:${String(prog.to.getMinutes()).padStart(2, '0')}`;

                // ç•ªçµ„ãŒçµ‚äº†ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const isPastProgram = prog.to < now;
                const isFutureProgram = prog.ft > now;

                // radikoã®URL
                const radikoTime = formatRadikoUrl(prog.ft);
                const radikoUrl = `https://radiko.jp/#!/ts/${prog.stationId}/${radikoTime}`;

                // ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
                let buttonsHtml = '';

                // çµ‚äº†æ¸ˆã¿ç•ªçµ„ï¼šãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
                if (isPastProgram) {
                    buttonsHtml += `<button class="btn-action btn-download" onclick='event.stopPropagation(); showDownloadCommandByIndex(${prog._index})'>DL</button>`;
                }

                // æœªæ¥ã®ç•ªçµ„ã¾ãŸã¯æ”¾é€ä¸­ã®ç•ªçµ„ï¼šäºˆç´„ãƒœã‚¿ãƒ³
                if (!isPastProgram) {
                    buttonsHtml += `<button class="btn-action btn-at" onclick='event.stopPropagation(); showAtCommandByIndex(${prog._index})'>äºˆç´„</button>`;
                }

                // å®šæœŸéŒ²éŸ³ãƒœã‚¿ãƒ³ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰
                buttonsHtml += `<button class="btn-action btn-cron" onclick='event.stopPropagation(); showCronCommandByIndex(${prog._index})'>å®šæœŸ</button>`;

                // radikoãƒœã‚¿ãƒ³ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰
                buttonsHtml += `<a href="${radikoUrl}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()" style="background: white; border: 1px solid #ddd; padding: 3px; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; line-height: 1; border-radius: 4px; width: 24px; height: 24px;" title="radikoã§è´ã"><img src="img/radiko.png" alt="radiko" style="width: 18px; height: 18px; display: block;"></a>`;

                card.innerHTML = `
                    <div class="program-time">${startTime} - ${endTime}</div>
                    <div class="program-title" style="color: #2c3e50; font-weight: 500;">${prog.title}</div>
                    ${prog.pfm ? `<div class="program-detail">${prog.pfm}</div>` : ''}
                    <div class="program-actions">
                        ${buttonsHtml}
                    </div>
                `;

                // ã‚«ãƒ¼ãƒ‰å…¨ä½“ã‚’ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«
                card.style.cursor = 'pointer';
                card.onclick = () => showProgramDetailByIndex(prog._index);

                programsContainer.appendChild(card);
            });

            column.appendChild(programsContainer);
            programList.appendChild(column);

            // æ”¾é€ä¸­ã®ç•ªçµ„ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            if (nowPlayingCard) {
                setTimeout(() => {
                    nowPlayingCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            }
        }

        function showCronCommandByIndex(index) {
            showCronCommand(allProgramsData[index]);
        }

        function showDownloadCommandByIndex(index) {
            showDownloadCommand(allProgramsData[index]);
        }

        function showAtCommandByIndex(index) {
            showAtCommand(allProgramsData[index]);
        }

        function showProgramDetailByIndex(index) {
            showProgramDetail(allProgramsData[index]);
        }

        function cleanupDescription(text) {
            if (!text) return '';

            // &nbsp;ã‚’é€šå¸¸ã®ã‚¹ãƒšãƒ¼ã‚¹ã«å¤‰æ›
            let cleaned = text.replace(/&nbsp;/gi, ' ');

            // é€£ç¶šã™ã‚‹<br>ã‚’1ã¤ã®æ”¹è¡Œã«å¤‰æ›
            cleaned = cleaned.replace(/(<br\s*\/?>)+/gi, '\n');

            // é€£ç¶šã™ã‚‹ç©ºè¡Œã‚’1ã¤ã«
            cleaned = cleaned.replace(/\n{3,}/g, '\n\n');

            // é€£ç¶šã™ã‚‹ã‚¹ãƒšãƒ¼ã‚¹ã‚’1ã¤ã«
            cleaned = cleaned.replace(/ {2,}/g, ' ');

            // å‰å¾Œã®ç©ºç™½ã‚’å‰Šé™¤
            cleaned = cleaned.trim();

            return cleaned;
        }

        function showProgramDetail(prog) {
            // ftã¨toã‚’Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ï¼ˆæ–‡å­—åˆ—ã®å ´åˆï¼‰
            const ftDate = typeof prog.ft === 'string' ? new Date(prog.ft) : prog.ft;
            const toDate = typeof prog.to === 'string' ? new Date(prog.to) : prog.to;

            const startTime = `${String(ftDate.getHours()).padStart(2, '0')}:${String(ftDate.getMinutes()).padStart(2, '0')}`;
            const endTime = `${String(toDate.getHours()).padStart(2, '0')}:${String(toDate.getMinutes()).padStart(2, '0')}`;
            const dateStr = `${ftDate.getFullYear()}/${ftDate.getMonth() + 1}/${ftDate.getDate()}`;
            const duration = Math.round((toDate - ftDate) / 60000); // åˆ†å˜ä½

            // radikoã®ç•ªçµ„ãƒšãƒ¼ã‚¸URLï¼ˆç§’ã¾ã§å«ã‚€14æ¡å½¢å¼ï¼‰
            const radikoTime = formatRadikoUrl(ftDate);
            const radikoUrl = `https://radiko.jp/#!/ts/${prog.stationId}/${radikoTime}`;

            // ç•ªçµ„èª¬æ˜ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            const cleanDesc = cleanupDescription(prog.desc);

            let detailHtml = `
                <div style="line-height: 1.7;">
                    <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
                    <h2 style="font-size: 1.6em; font-weight: 700; color: #2c3e50; margin: 0 0 20px 0; line-height: 1.4; letter-spacing: -0.02em;">${prog.title}</h2>

                    <!-- åŸºæœ¬æƒ…å ±ãƒãƒ¼ -->
                    <div style="display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #e9ecef; font-size: 0.9em; color: #6c757d;">
                        <div>
                            <span style="font-weight: 600;">${dateStr}</span>
                            <span style="margin: 0 8px;">|</span>
                            <span>${startTime}ã€œ${endTime}</span>
                        </div>
                        <div>
                            <span style="font-weight: 600;">æ”¾é€æ™‚é–“</span>
                            <span style="margin-left: 8px;">${duration}åˆ†</span>
                        </div>
                    </div>

                    <!-- æ”¾é€å±€æƒ…å ± -->
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-weight: 600; color: #2c3e50; font-size: 1.05em;">ğŸ“» ${prog.stationName}</div>
                        <a href="${radikoUrl}" target="_blank" rel="noopener noreferrer"
                           style="margin-left: auto; padding: 8px 16px; background: #3498db; color: white; text-decoration: none; border-radius: 6px; font-size: 0.85em; font-weight: 600; transition: background 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                           onmouseover="this.style.background='#2980b9'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 3px 6px rgba(0,0,0,0.15)'"
                           onmouseout="this.style.background='#3498db'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                            radikoã§è´ã
                        </a>
                    </div>
            `;

            // ç•ªçµ„æ¦‚è¦ã‚»ã‚¯ã‚·ãƒ§ãƒ³
            if (cleanDesc && cleanDesc !== 'èª¬æ˜ãªã—') {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = cleanDesc;

                detailHtml += `
                    <div style="margin-bottom: 28px;">
                        <h3 style="font-size: 1.05em; font-weight: 600; color: #2c3e50; margin: 0 0 12px 0;">ç•ªçµ„æ¦‚è¦</h3>
                        <div style="color: #495057; font-size: 0.95em; line-height: 1.9; white-space: pre-line;">${tempDiv.innerHTML}</div>
                    </div>
                `;
            }

            if (prog.pfm) {
                const cleanPfm = cleanupDescription(prog.pfm);
                detailHtml += `
                    <div style="margin-bottom: 28px;">
                        <h3 style="font-size: 1.05em; font-weight: 600; color: #2c3e50; margin: 0 0 12px 0;">å‡ºæ¼”è€…</h3>
                        <div style="color: #495057; font-size: 0.95em; line-height: 1.9; white-space: pre-line;">${cleanPfm}</div>
                    </div>
                `;
            }

            if (prog.url) {
                detailHtml += `
                    <div style="margin-bottom: 28px;">
                        <h3 style="font-size: 1.05em; font-weight: 600; color: #2c3e50; margin: 0 0 12px 0;">é–¢é€£ãƒªãƒ³ã‚¯</h3>
                        <div style="word-break: break-all;">
                            <a href="${prog.url}" target="_blank" style="color: #3498db; text-decoration: none; font-size: 0.9em; font-weight: 500;"
                               onmouseover="this.style.textDecoration='underline'"
                               onmouseout="this.style.textDecoration='none'">
                                ğŸ”— ç•ªçµ„ãƒšãƒ¼ã‚¸ã‚’é–‹ã
                            </a>
                        </div>
                    </div>
                `;
            }

            if (prog.info) {
                const cleanInfo = cleanupDescription(prog.info);
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = cleanInfo;

                detailHtml += `
                    <div style="margin-bottom: 28px;">
                        <h3 style="font-size: 1.05em; font-weight: 600; color: #2c3e50; margin: 0 0 12px 0;">ãã®ä»–æƒ…å ±</h3>
                        <div style="color: #6c757d; font-size: 0.9em; line-height: 1.8; white-space: pre-line;">${tempDiv.innerHTML}</div>
                    </div>
                `;
            }

            detailHtml += '</div>';

            currentCommand = ''; // ã‚³ãƒãƒ³ãƒ‰ã¯ã‚¯ãƒªã‚¢ã™ã‚‹
            const commandBox = document.getElementById('commandBox');
            commandBox.className = 'command-box'; // command-displayã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
            document.getElementById('modalTitle').textContent = 'ç•ªçµ„è©³ç´°';
            commandBox.innerHTML = detailHtml;

            // ãƒœã‚¿ãƒ³ã‚’å…¨ã¦éè¡¨ç¤ºã«ã™ã‚‹
            document.getElementById('executeBtn').style.display = 'none';
            document.getElementById('registerCronBtn').style.display = 'none';
            document.querySelector('.btn-copy').style.display = 'none';
            // å…¨ã¦ã®é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
            document.querySelectorAll('.modal-actions .btn-close').forEach(btn => btn.style.display = 'none');

            document.getElementById('modal').classList.add('active');
        }

        async function showCronCommand(prog) {
            const scriptPath = document.getElementById('scriptPath').value;
            const startTime = new Date(prog.ft);
            const endTime = new Date(prog.to);

            // cronå®Ÿè¡Œæ™‚åˆ»ï¼ˆç•ªçµ„çµ‚äº†ã®5åˆ†å¾Œï¼‰
            const cronExecTime = new Date(prog.to);
            cronExecTime.setMinutes(cronExecTime.getMinutes() + 5);
            const minute = cronExecTime.getMinutes();
            const hour = cronExecTime.getHours();
            const dayOfWeek = cronExecTime.getDay();

            // é–‹å§‹æ™‚åˆ»ã¨çµ‚äº†æ™‚åˆ»ï¼ˆæ™‚åˆ†ã®ã¿ã€ç•ªçµ„è¡¨é€šã‚Šï¼‰
            const startHHMM = `${String(startTime.getHours()).padStart(2, '0')}${String(startTime.getMinutes()).padStart(2, '0')}`;
            const endHHMM = `${String(endTime.getHours()).padStart(2, '0')}${String(endTime.getMinutes()).padStart(2, '0')}`;

            // éŒ²éŸ³é–‹å§‹æ—¥ã¨cronå®Ÿè¡Œæ—¥ã®æ—¥ä»˜ã‚’æ¯”è¼ƒ
            // éŒ²éŸ³é–‹å§‹æ—¥ãŒcronå®Ÿè¡Œæ—¥ã¨ç•°ãªã‚‹å ´åˆã€é–‹å§‹æ—¥ã¯cronå®Ÿè¡Œæ—¥ã®å‰æ—¥
            const startDateForCron = `${startTime.getFullYear()}-${String(startTime.getMonth()+1).padStart(2,'0')}-${String(startTime.getDate()).padStart(2,'0')}`;
            const cronExecDateStr = `${cronExecTime.getFullYear()}-${String(cronExecTime.getMonth()+1).padStart(2,'0')}-${String(cronExecTime.getDate()).padStart(2,'0')}`;
            const endDateForCron = `${endTime.getFullYear()}-${String(endTime.getMonth()+1).padStart(2,'0')}-${String(endTime.getDate()).padStart(2,'0')}`;

            // é–‹å§‹æ—¥ãŒcronå®Ÿè¡Œæ—¥ã¨ç•°ãªã‚‹å ´åˆ
            const startNeedsYesterday = startDateForCron !== cronExecDateStr;
            // çµ‚äº†æ—¥ãŒcronå®Ÿè¡Œæ—¥ã¨ç•°ãªã‚‹å ´åˆ
            const endNeedsYesterday = endDateForCron !== cronExecDateStr;

            // æ—¥ä»˜è¨ˆç®—ã®éƒ¨åˆ†
            let startDateCalc = '';
            if (startNeedsYesterday) {
                // cronå®Ÿè¡Œæ—¥ã®å‰æ—¥ã‚’éŒ²éŸ³é–‹å§‹æ—¥ã¨ã™ã‚‹
                startDateCalc = '\`date -d yesterday +\\%Y\\%m\\%d\`';
            } else {
                // cronå®Ÿè¡Œæ—¥ã¨åŒã˜æ—¥ã‚’éŒ²éŸ³é–‹å§‹æ—¥ã¨ã™ã‚‹
                startDateCalc = '\`date +\\%Y\\%m\\%d\`';
            }

            // éŒ²éŸ³çµ‚äº†æ—¥ã®è¨ˆç®—
            let endDateCalc = '';
            if (endNeedsYesterday) {
                // cronå®Ÿè¡Œæ—¥ã®å‰æ—¥ã‚’éŒ²éŸ³çµ‚äº†æ—¥ã¨ã™ã‚‹
                endDateCalc = '\`date -d yesterday +\\%Y\\%m\\%d\`';
            } else {
                // cronå®Ÿè¡Œæ—¥ã¨åŒã˜æ—¥ã‚’éŒ²éŸ³çµ‚äº†æ—¥ã¨ã™ã‚‹
                endDateCalc = '\`date +\\%Y\\%m\\%d\`';
            }

            // ã‚¿ã‚¤ãƒˆãƒ«ã‚’ã‚µãƒ‹ã‚¿ã‚¤ã‚ºï¼ˆã‚¹ãƒšãƒ¼ã‚¹ã‚’ã‚¢ãƒ³ãƒ€ãƒ¼ãƒãƒ¼ã«ã€å…¨è§’è¨˜å·ã‚’åŠè§’ã«ï¼‰
            const safeTitle = sanitizeFilename(prog.title);

            // cronã‚³ãƒãƒ³ãƒ‰ï¼ˆå‹•çš„ãªæ—¥ä»˜ã‚’ä½¿ç”¨ã€ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã—ãŸã‚¿ã‚¤ãƒˆãƒ«ã‚’ä½¿ç”¨ï¼‰
            const command = `${minute} ${hour} * * ${dayOfWeek} ${scriptPath} "${safeTitle}" "${prog.stationId}" "${prog.stationId}" "${startDateCalc}${startHHMM}" "${endDateCalc}${endHHMM}" "" "" "" >> /tmp/myradiko_output.log 2>&1`;

            currentCommand = command;
            currentProgramData = prog; // ãƒ—ãƒ­ã‚°ãƒ©ãƒ æƒ…å ±ã‚’ä¿å­˜
            document.getElementById('modalTitle').textContent = `å®šæœŸéŒ²éŸ³ - ${prog.title}`;

            // ç•ªçµ„æƒ…å ±ã‚’è¦‹ã‚„ã™ãè¡¨ç¤º
            const startDateStr = `${startTime.getFullYear()}/${String(startTime.getMonth() + 1).padStart(2, '0')}/${String(startTime.getDate()).padStart(2, '0')}`;
            const startTimeStr = `${String(startTime.getHours()).padStart(2, '0')}:${String(startTime.getMinutes()).padStart(2, '0')}`;
            const endTimeStr = `${String(endTime.getHours()).padStart(2, '0')}:${String(endTime.getMinutes()).padStart(2, '0')}`;

            const durationMinutes = Math.floor((endTime - startTime) / 60000);
            const durationHours = Math.floor(durationMinutes / 60);
            const durationMins = durationMinutes % 60;
            const durationStr = durationHours > 0 ? `${durationHours}æ™‚é–“${durationMins}åˆ†` : `${durationMins}åˆ†`;

            // å®Ÿè¡Œæ™‚åˆ»ã®èª¬æ˜
            const execTimeStr = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
            const daysOfWeekJp = ['æ—¥æ›œæ—¥', 'æœˆæ›œæ—¥', 'ç«æ›œæ—¥', 'æ°´æ›œæ—¥', 'æœ¨æ›œæ—¥', 'é‡‘æ›œæ—¥', 'åœŸæ›œæ—¥'];
            const daysOfWeekShort = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            const dayLabel = daysOfWeekJp[dayOfWeek];
            const dayShort = daysOfWeekShort[dayOfWeek];

            // ãƒ•ã‚©ãƒ«ãƒ€é¸æŠUIã‚’å–å¾—
            const folderSelectHtml = await generateFolderSelectHtml();

            const commandBoxContent = `
                <div style="line-height: 1.7;">
                    <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
                    <h3 style="font-size: 1.4em; font-weight: 600; color: #212529; margin: 0 0 16px 0; line-height: 1.4;">${prog.title}</h3>

                    <!-- åŸºæœ¬æƒ…å ± -->
                    <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px 16px; margin-bottom: 20px; font-size: 0.95em; color: #495057;">
                        <div style="font-weight: 500;">æ”¾é€å±€</div>
                        <div>${prog.stationName || prog.stationId}</div>
                        <div style="font-weight: 500;">æ”¾é€æ—¥æ™‚</div>
                        <div>æ¯é€±${dayLabel} ${startTimeStr} - ${endTimeStr} (${durationStr})</div>
                        <div style="font-weight: 500;">å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°</div>
                        <div>æ¯é€±${dayLabel} ${execTimeStr} ï¼ˆç•ªçµ„çµ‚äº†5åˆ†å¾Œï¼‰</div>
                    </div>

                    <!-- ãƒ•ã‚©ãƒ«ãƒ€é¸æŠ -->
                    ${folderSelectHtml}

                    <!-- cronã‚³ãƒãƒ³ãƒ‰ -->
                    <div style="margin-bottom: 20px;">
                        <div style="font-weight: 600; margin-bottom: 8px; font-size: 0.9em; color: #6c757d;">cronã‚³ãƒãƒ³ãƒ‰</div>
                        <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 12px; font-family: 'Courier New', monospace; font-size: 0.85em; color: #495057; word-break: break-all; line-height: 1.6;">
                            ${command}
                        </div>
                    </div>

                    <div style="background: #fff3e0; border-left: 4px solid #ff9800; padding: 12px; border-radius: 4px;">
                        <div style="color: #e65100; font-size: 0.9em; display: flex; align-items: center; gap: 8px;">
                            <span>ğŸ’¡</span>
                            <span>ã€Œcronç™»éŒ²ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€æ¯é€±è‡ªå‹•ã§éŒ²éŸ³ãŒå®Ÿè¡Œã•ã‚Œã¾ã™</span>
                        </div>
                    </div>
                </div>
            `;

            const commandBox = document.getElementById('commandBox');
            commandBox.className = 'command-box command-display'; // ã‚³ãƒãƒ³ãƒ‰è¡¨ç¤ºç”¨ã‚¹ã‚¿ã‚¤ãƒ«è¿½åŠ 
            commandBox.innerHTML = commandBoxContent;
            document.getElementById('executeBtn').style.display = 'none';

            // cronç™»éŒ²ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            const registerBtn = document.getElementById('registerCronBtn');
            if (registerBtn) {
                registerBtn.style.display = 'inline-block';
                registerBtn.onclick = () => {
                    // é¸æŠã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€ã‚’å–å¾—
                    const folderSelect = document.getElementById('targetFolderSelect');
                    const selectedFolder = folderSelect ? folderSelect.value : '';

                    // ãƒ•ã‚©ãƒ«ãƒ€ã‚’å«ã‚ãŸã‚³ãƒãƒ³ãƒ‰ã‚’å†ç”Ÿæˆ
                    const commandWithFolder = `${minute} ${hour} * * ${dayOfWeek} ${scriptPath} "${safeTitle}" "${prog.stationId}" "${prog.stationId}" "${startDateCalc}${startHHMM}" "${endDateCalc}${endHHMM}" "" "${selectedFolder}" "" >> /tmp/myradiko_output.log 2>&1`;

                    addCronJob(commandWithFolder, prog.title, prog.stationName);
                };
            }

            document.getElementById('modal').classList.add('active');
        }

        async function showDownloadCommand(prog) {
            console.log('showDownloadCommand called with prog:', prog);
            const scriptPath = document.getElementById('scriptPath').value;

            if (!prog || !prog.to || !prog.ft) {
                console.error('Invalid prog data:', prog);
                alert('ç•ªçµ„ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™ã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                return;
            }

            const endTime = new Date(prog.to);
            endTime.setMinutes(endTime.getMinutes() + 5);

            const startStr = formatRadikoTime(new Date(prog.ft));
            const endStr = formatRadikoTime(endTime);

            const command = `${scriptPath} -s ${startStr} -e ${endStr} -i ${prog.stationId}`;

            currentCommand = command;
            currentProgramData = prog; // å®Ÿè¡Œç”¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            document.getElementById('modalTitle').textContent = `ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ - ${prog.title}`;

            // ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
            const fileCheck = await checkFileExists(prog);

            let commandBoxContent = command;

            if (fileCheck && fileCheck.exists) {
                const proxyUrl = document.getElementById('proxyUrl').value;
                const baseUrl = proxyUrl.trim() || '';
                const downloadUrl = `${baseUrl}/download/${fileCheck.path}`;

                commandBoxContent = `
                    <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <div style="color: #856404; font-weight: bold; margin-bottom: 8px; font-size: 1.1em;">âš ï¸ ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ—¢ã«éŒ²éŸ³æ¸ˆã¿ã§ã™</div>
                        <div style="color: #856404; font-size: 0.9em; margin-bottom: 10px;">ãƒ•ã‚¡ã‚¤ãƒ«å: ${fileCheck.filename}</div>
                        <a href="${downloadUrl}" download="${fileCheck.filename}"
                           style="display: inline-block; padding: 8px 16px; background: #667eea; color: white; text-decoration: none; border-radius: 4px; font-weight: 600; font-size: 0.9em;">
                            ğŸ“¥ æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                        </a>
                    </div>
                    <div style="font-family: 'Courier New', monospace; background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 0.9em; color: #6c757d;">
                        ${command}
                    </div>
                    <div style="margin-top: 10px; font-size: 0.85em; color: #856404;">
                        â€» ã€Œå®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™
                    </div>
                `;
            } else {
                // ç•ªçµ„æƒ…å ±ã‚’è¦‹ã‚„ã™ãè¡¨ç¤º
                const startTime = new Date(prog.ft);
                const endTime = new Date(prog.to);

                const startDateStr = `${startTime.getFullYear()}/${String(startTime.getMonth() + 1).padStart(2, '0')}/${String(startTime.getDate()).padStart(2, '0')}`;
                const startTimeStr = `${String(startTime.getHours()).padStart(2, '0')}:${String(startTime.getMinutes()).padStart(2, '0')}`;
                const endTimeStr = `${String(endTime.getHours()).padStart(2, '0')}:${String(endTime.getMinutes()).padStart(2, '0')}`;

                const durationMinutes = Math.floor((endTime - startTime) / 60000);
                const durationHours = Math.floor(durationMinutes / 60);
                const durationMins = durationMinutes % 60;
                const durationStr = durationHours > 0 ? `${durationHours}æ™‚é–“${durationMins}åˆ†` : `${durationMins}åˆ†`;

                // ãƒ•ã‚©ãƒ«ãƒ€é¸æŠUIã‚’å–å¾—
                const folderSelectHtml = await generateFolderSelectHtml();

                commandBoxContent = `
                    <div style="line-height: 1.7;">
                        <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
                        <h3 style="font-size: 1.4em; font-weight: 600; color: #212529; margin: 0 0 16px 0; line-height: 1.4;">${prog.title}</h3>

                        <!-- åŸºæœ¬æƒ…å ± -->
                        <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px 16px; margin-bottom: 20px; font-size: 0.95em; color: #495057;">
                            <div style="font-weight: 500;">æ”¾é€å±€</div>
                            <div>${prog.stationName || prog.stationId}</div>
                            <div style="font-weight: 500;">æ”¾é€æ—¥æ™‚</div>
                            <div>${startDateStr} ${startTimeStr} - ${endTimeStr} (${durationStr})</div>
                        </div>

                        <!-- ãƒ•ã‚©ãƒ«ãƒ€é¸æŠ -->
                        ${folderSelectHtml}

                        <!-- éŒ²éŸ³ã‚³ãƒãƒ³ãƒ‰ -->
                        <div style="margin-bottom: 20px;">
                            <div style="font-weight: 600; margin-bottom: 8px; font-size: 0.9em; color: #6c757d;">éŒ²éŸ³ã‚³ãƒãƒ³ãƒ‰</div>
                            <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 12px; font-family: 'Courier New', monospace; font-size: 0.85em; color: #495057; word-break: break-all; line-height: 1.6;">
                                ${command}
                            </div>
                        </div>

                        <div style="background: #e7f3ff; border-left: 4px solid #2196f3; padding: 12px; border-radius: 4px;">
                            <div style="color: #1976d2; font-size: 0.9em; display: flex; align-items: center; gap: 8px;">
                                <span>ğŸ’¡</span>
                                <span>ã€Œå®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ã“ã®ç•ªçµ„ã®éŒ²éŸ³ã‚’ã™ãã«é–‹å§‹ã—ã¾ã™</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            const commandBox = document.getElementById('commandBox');
            commandBox.className = 'command-box command-display'; // ã‚³ãƒãƒ³ãƒ‰è¡¨ç¤ºç”¨ã‚¹ã‚¿ã‚¤ãƒ«è¿½åŠ 
            commandBox.innerHTML = commandBoxContent;
            document.getElementById('executeBtn').style.display = 'inline-block';
            document.getElementById('modal').classList.add('active');
        }

        async function showAtCommand(prog) {
            const scriptPath = document.getElementById('scriptPath').value;
            const startTime = new Date(prog.ft);
            const endTime = new Date(prog.to);

            // atå®Ÿè¡Œæ™‚åˆ»ï¼ˆç•ªçµ„çµ‚äº†ã®5åˆ†å¾Œï¼‰
            const atExecTime = new Date(prog.to);
            atExecTime.setMinutes(atExecTime.getMinutes() + 5);

            // é–‹å§‹æ™‚åˆ»ã¨çµ‚äº†æ™‚åˆ»ï¼ˆYYYYMMDDHHmmå½¢å¼ï¼‰
            const startStr = formatRadikoTime(startTime);
            const endStr = formatRadikoTime(endTime);

            // atå®Ÿè¡Œæ™‚åˆ»
            const atTime = `${String(atExecTime.getHours()).padStart(2, '0')}:${String(atExecTime.getMinutes()).padStart(2, '0')} ${atExecTime.getFullYear()}-${String(atExecTime.getMonth() + 1).padStart(2, '0')}-${String(atExecTime.getDate()).padStart(2, '0')}`;

            // ã‚¿ã‚¤ãƒˆãƒ«ã‚’ã‚µãƒ‹ã‚¿ã‚¤ã‚ºï¼ˆã‚¹ãƒšãƒ¼ã‚¹ã‚’ã‚¢ãƒ³ãƒ€ãƒ¼ãƒãƒ¼ã«ã€å…¨è§’è¨˜å·ã‚’åŠè§’ã«ï¼‰
            const safeTitle = sanitizeFilename(prog.title);

            // cronã¨åŒã˜å½¢å¼ã®ã‚³ãƒãƒ³ãƒ‰ï¼ˆã‚µãƒ‹ã‚¿ã‚¤ã‚ºã—ãŸã‚¿ã‚¤ãƒˆãƒ«ã‚’ä½¿ç”¨ï¼‰
            const command = `echo '${scriptPath} "${safeTitle}" "${prog.stationId}" "${prog.stationId}" "${startStr}" "${endStr}" "" "" "" >> /tmp/myradiko_output.log 2>&1' | at ${atTime}`;

            currentCommand = command;
            currentProgramData = prog; // å®Ÿè¡Œç”¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            document.getElementById('modalTitle').textContent = `äºˆç´„ - ${prog.title}`;

            // ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
            const fileCheck = await checkFileExists(prog);

            let commandBoxContent = command;

            if (fileCheck && fileCheck.exists) {
                const proxyUrl = document.getElementById('proxyUrl').value;
                const baseUrl = proxyUrl.trim() || '';
                const downloadUrl = `${baseUrl}/download/${fileCheck.path}`;

                commandBoxContent = `
                    <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <div style="color: #856404; font-weight: bold; margin-bottom: 8px; font-size: 1.1em;">âš ï¸ ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ—¢ã«éŒ²éŸ³æ¸ˆã¿ã§ã™</div>
                        <div style="color: #856404; font-size: 0.9em; margin-bottom: 10px;">ãƒ•ã‚¡ã‚¤ãƒ«å: ${fileCheck.filename}</div>
                        <a href="${downloadUrl}" download="${fileCheck.filename}"
                           style="display: inline-block; padding: 8px 16px; background: #667eea; color: white; text-decoration: none; border-radius: 4px; font-weight: 600; font-size: 0.9em;">
                            ğŸ“¥ æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                        </a>
                    </div>
                    <div style="font-family: 'Courier New', monospace; background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 0.9em; color: #6c757d;">
                        ${command}
                    </div>
                    <div style="margin-top: 10px; font-size: 0.85em; color: #856404;">
                        â€» ã€Œå®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™
                    </div>
                `;
            } else {
                // ç•ªçµ„æƒ…å ±ã‚’è¦‹ã‚„ã™ãè¡¨ç¤º
                const startDateStr = `${startTime.getFullYear()}/${String(startTime.getMonth() + 1).padStart(2, '0')}/${String(startTime.getDate()).padStart(2, '0')}`;
                const startTimeStr = `${String(startTime.getHours()).padStart(2, '0')}:${String(startTime.getMinutes()).padStart(2, '0')}`;
                const endTimeStr = `${String(endTime.getHours()).padStart(2, '0')}:${String(endTime.getMinutes()).padStart(2, '0')}`;

                const durationMinutes = Math.floor((endTime - startTime) / 60000);
                const durationHours = Math.floor(durationMinutes / 60);
                const durationMins = durationMinutes % 60;
                const durationStr = durationHours > 0 ? `${durationHours}æ™‚é–“${durationMins}åˆ†` : `${durationMins}åˆ†`;

                // å®Ÿè¡Œäºˆå®šæ™‚åˆ»
                const execTimeStr = `${String(atExecTime.getHours()).padStart(2, '0')}:${String(atExecTime.getMinutes()).padStart(2, '0')}`;
                const execDateStr = `${atExecTime.getFullYear()}/${String(atExecTime.getMonth() + 1).padStart(2, '0')}/${String(atExecTime.getDate()).padStart(2, '0')}`;

                // æ›œæ—¥ã‚’å–å¾—
                const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
                const weekday = weekdays[atExecTime.getDay()];

                // ãƒ•ã‚©ãƒ«ãƒ€é¸æŠUIã‚’å–å¾—
                const folderSelectHtml = await generateFolderSelectHtml();

                commandBoxContent = `
                    <div style="line-height: 1.7;">
                        <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
                        <h3 style="font-size: 1.4em; font-weight: 600; color: #212529; margin: 0 0 16px 0; line-height: 1.4;">${prog.title}</h3>

                        <!-- åŸºæœ¬æƒ…å ± -->
                        <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px 16px; margin-bottom: 20px; font-size: 0.95em; color: #495057;">
                            <div style="font-weight: 500;">æ”¾é€å±€</div>
                            <div>${prog.stationName || prog.stationId}</div>
                            <div style="font-weight: 500;">æ”¾é€æ—¥æ™‚</div>
                            <div>${startDateStr} ${startTimeStr} - ${endTimeStr} (${durationStr})</div>
                            <div style="font-weight: 500;">å®Ÿè¡Œäºˆå®šæ™‚åˆ»</div>
                            <div>${execDateStr} (${weekday}) ${execTimeStr} ï¼ˆç•ªçµ„çµ‚äº†5åˆ†å¾Œï¼‰</div>
                        </div>

                        <!-- ãƒ•ã‚©ãƒ«ãƒ€é¸æŠ -->
                        ${folderSelectHtml}

                        <!-- äºˆç´„ã‚³ãƒãƒ³ãƒ‰ -->
                        <div style="margin-bottom: 20px;">
                            <div style="font-weight: 600; margin-bottom: 8px; font-size: 0.9em; color: #6c757d;">äºˆç´„ã‚³ãƒãƒ³ãƒ‰</div>
                            <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 12px; font-family: 'Courier New', monospace; font-size: 0.85em; color: #495057; word-break: break-all; line-height: 1.6;">
                                ${command}
                            </div>
                        </div>

                        <div style="background: #e7f3ff; border-left: 4px solid #2196f3; padding: 12px; border-radius: 4px;">
                            <div style="color: #1976d2; font-size: 0.9em; display: flex; align-items: center; gap: 8px;">
                                <span>ğŸ’¡</span>
                                <span>ã€Œå®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€æŒ‡å®šæ™‚åˆ»ã«è‡ªå‹•ã§éŒ²éŸ³ãŒé–‹å§‹ã•ã‚Œã¾ã™</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            const commandBox = document.getElementById('commandBox');
            commandBox.className = 'command-box command-display'; // ã‚³ãƒãƒ³ãƒ‰è¡¨ç¤ºç”¨ã‚¹ã‚¿ã‚¤ãƒ«è¿½åŠ 
            commandBox.innerHTML = commandBoxContent;
            document.getElementById('executeBtn').style.display = 'inline-block';
            document.getElementById('modal').classList.add('active');
        }

        function formatRadikoTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hour = String(date.getHours()).padStart(2, '0');
            const minute = String(date.getMinutes()).padStart(2, '0');
            // rec_radiko_ts.shã¯12æ¡ï¼ˆç§’ãªã—ï¼‰ã‚’æœŸå¾…
            return `${year}${month}${day}${hour}${minute}`;
        }

        function formatRadikoUrl(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hour = String(date.getHours()).padStart(2, '0');
            const minute = String(date.getMinutes()).padStart(2, '0');
            const second = String(date.getSeconds()).padStart(2, '0');
            // radikoã®URLã¯14æ¡ï¼ˆç§’ã¾ã§å«ã‚€ï¼‰ã‚’æœŸå¾…
            return `${year}${month}${day}${hour}${minute}${second}`;
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            document.getElementById('registerCronBtn').style.display = 'none';
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
        }

        async function executeCommand() {
            if (!currentProgramData) {
                alert('å®Ÿè¡Œå¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            const prog = currentProgramData;

            // éŒ²éŸ³ã¯ç•ªçµ„é–‹å§‹ã‹ã‚‰çµ‚äº†ã¾ã§
            const startTime = new Date(prog.ft);
            const endTime = new Date(prog.to);
            const startStr = formatRadikoTime(startTime);
            const endStr = formatRadikoTime(endTime);

            // atå®Ÿè¡Œæ™‚åˆ»ã¯ç•ªçµ„çµ‚äº†ã®5åˆ†å¾Œ
            const atExecTime = new Date(prog.to);
            atExecTime.setMinutes(atExecTime.getMinutes() + 5);

            // currentCommandã‹ã‚‰atäºˆç´„ã‹ã©ã†ã‹ã‚’åˆ¤å®š
            const isAtCommand = currentCommand.includes('| at ');

            const executeBtn = document.getElementById('executeBtn');
            executeBtn.disabled = true;
            executeBtn.innerHTML = '<span style="font-size: 1.3em; display: block; margin-bottom: 2px;">â³</span><span style="font-size: 0.85em;">å®Ÿè¡Œä¸­...</span>';

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            // atäºˆç´„ã®å ´åˆ
            if (isAtCommand) {
                const scriptPath = document.getElementById('scriptPath').value;
                const atTime = `${String(atExecTime.getHours()).padStart(2, '0')}:${String(atExecTime.getMinutes()).padStart(2, '0')} ${atExecTime.getFullYear()}-${String(atExecTime.getMonth() + 1).padStart(2, '0')}-${String(atExecTime.getDate()).padStart(2, '0')}`;

                // é¸æŠã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€ã‚’å–å¾—
                const folderSelect = document.getElementById('targetFolderSelect');
                const selectedFolder = folderSelect ? folderSelect.value : '';

                try {
                    const response = await fetch(`${baseUrl}/schedule-at`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            script_path: scriptPath,
                            title: prog.title,
                            start_time: startStr,
                            end_time: endStr,
                            station_id: prog.stationId,
                            at_time: atTime,
                            folder: selectedFolder
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        // æ›œæ—¥ã‚’å–å¾—
                        const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
                        const weekday = weekdays[atExecTime.getDay()];
                        const execDateStr = `${atExecTime.getFullYear()}/${String(atExecTime.getMonth() + 1).padStart(2, '0')}/${String(atExecTime.getDate()).padStart(2, '0')}`;
                        const execTimeStr = `${String(atExecTime.getHours()).padStart(2, '0')}:${String(atExecTime.getMinutes()).padStart(2, '0')}`;

                        alert(`ğŸ‰ äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\nğŸ“» ç•ªçµ„: ${prog.title}\nğŸ“¡ æ”¾é€å±€: ${prog.stationName || prog.stationId}\nâ° éŒ²éŸ³é–‹å§‹äºˆå®š: ${execDateStr} (${weekday}) ${execTimeStr}\n\næŒ‡å®šã—ãŸæ™‚åˆ»ã«è‡ªå‹•ã§éŒ²éŸ³ãŒé–‹å§‹ã•ã‚Œã¾ã™ã€‚\näºˆç´„ã®ç¢ºèªã¯ã€Œäºˆç´„ç®¡ç†ã€ã‚¿ãƒ–ã‹ã‚‰è¡Œãˆã¾ã™ã€‚`);
                        closeModal();

                        // äºˆç´„ç®¡ç†ã‚¿ãƒ–ã‚’è‡ªå‹•çš„ã«é–‹ã
                        setTimeout(() => {
                            document.querySelector('[onclick*="showAtJobsTab"]')?.click();
                        }, 300);
                    } else {
                        alert(`âŒ äºˆç´„ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ\n\nã‚¨ãƒ©ãƒ¼å†…å®¹:\n${data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'}\n\næ™‚åˆ»è¨­å®šã‚’ç¢ºèªã—ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚`);
                    }
                } catch (err) {
                    console.error('at schedule error:', err);
                    alert(`âŒ äºˆç´„ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ\n\nã‚¨ãƒ©ãƒ¼å†…å®¹:\n${err.message}\n\nãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚`);
                } finally {
                    executeBtn.disabled = false;
                    executeBtn.innerHTML = '<span style="font-size: 1.3em; display: block; margin-bottom: 2px;">â–¶ï¸</span><span style="font-size: 0.85em;">å®Ÿè¡Œ</span>';
                }
                return;
            }

            // å³æ™‚å®Ÿè¡Œï¼ˆDLï¼‰ã®å ´åˆ
            // é¸æŠã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€ã‚’å–å¾—ï¼ˆHTMLã‚’æ›¸ãæ›ãˆã‚‹å‰ã«ï¼ï¼‰
            const folderSelect = document.getElementById('targetFolderSelect');
            const selectedFolder = folderSelect ? folderSelect.value : '';
            console.log('ğŸ“ DLéŒ²éŸ³ - folderSelect element:', folderSelect);
            console.log('ğŸ“ DLéŒ²éŸ³ - selectedFolder value:', selectedFolder);

            const commandBox = document.getElementById('commandBox');
            commandBox.innerHTML = `
                <div style="background: #ffffff; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; margin-top: 15px;">
                    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                        <div id="statusIcon" style="font-size: 2em;">â³</div>
                        <div style="flex: 1;">
                            <div id="statusTitle" style="font-weight: 600; font-size: 1.1em; color: #212529; margin-bottom: 5px;">éŒ²éŸ³ã‚’æº–å‚™ä¸­...</div>
                            <div id="statusMessage" style="color: #6c757d; font-size: 0.9em;">myradikoã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™</div>
                        </div>
                    </div>

                    <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
                    <div style="background: #e9ecef; height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 15px;">
                        <div id="progressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s;"></div>
                    </div>

                    <!-- è©³ç´°ãƒ­ã‚°ï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¯èƒ½ï¼‰ -->
                    <details style="margin-top: 15px;">
                        <summary style="cursor: pointer; padding: 8px; background: #f8f9fa; border-radius: 4px; font-weight: 600; user-select: none; color: #495057;">
                            ğŸ“‹ è©³ç´°ãƒ­ã‚°ã‚’è¡¨ç¤º
                        </summary>
                        <div style="background: #212529; color: #e9ecef; padding: 15px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 0.85em; max-height: 300px; overflow-y: auto; margin-top: 10px; line-height: 1.6;" id="logContent"></div>
                    </details>
                </div>
            `;

            // éŒ²éŸ³æ™‚é–“ã‚’è¨ˆç®—ï¼ˆç§’å˜ä½ï¼‰
            const totalDurationSeconds = Math.floor((endTime - startTime) / 1000);
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦ä¿å­˜
            window.recordingTotalDuration = totalDurationSeconds;

            // POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã§å®Ÿè¡Œ
            const response = await fetch(`${baseUrl}/execute`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    title: prog.title,
                    rss: prog.stationId,
                    station: prog.stationId,
                    start_time: startStr,
                    end_time: endStr,
                    folder: selectedFolder
                })
            });

            if (!response.ok) {
                addLog('error', `ã‚¨ãƒ©ãƒ¼: ${response.statusText}`);
                executeBtn.disabled = false;
                executeBtn.innerHTML = '<span style="font-size: 1.3em; display: block; margin-bottom: 2px;">â–¶ï¸</span><span style="font-size: 0.85em;">å®Ÿè¡Œ</span>';
                return;
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');

                // æœ€å¾Œã®è¡Œã¯ä¸å®Œå…¨ãªå¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ä¿æŒ
                buffer = lines.pop() || '';

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const jsonStr = line.substring(6).trim();
                            if (jsonStr) {
                                const data = JSON.parse(jsonStr);
                                addLog(data.type, data.message, data.file);

                                if (data.type === 'success' || data.type === 'error') {
                                    executeBtn.disabled = false;
                                    executeBtn.innerHTML = '<span style="font-size: 1.3em; display: block; margin-bottom: 2px;">â–¶ï¸</span><span style="font-size: 0.85em;">å®Ÿè¡Œ</span>';

                                    // æˆåŠŸæ™‚ã¯ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’æ›´æ–°
                                    if (data.type === 'success') {
                                        setTimeout(() => loadRecordedFiles(), 1000);
                                    }
                                }
                            }
                        } catch (e) {
                            console.error('JSON parse error:', e, 'Line:', line);
                        }
                    }
                }
            }
        }

        function addLog(type, message, file) {
            const logContent = document.getElementById('logContent');
            const statusIcon = document.getElementById('statusIcon');
            const statusTitle = document.getElementById('statusTitle');
            const statusMessage = document.getElementById('statusMessage');
            const progressBar = document.getElementById('progressBar');

            // ffmpegã®time=ã‚’è§£æã—ã¦é€²æ—ã‚’è¨ˆç®—
            const timeMatch = message.match(/time=(\d{2}):(\d{2}):(\d{2}\.\d+)/);
            if (timeMatch && window.recordingTotalDuration) {
                const hours = parseInt(timeMatch[1]);
                const minutes = parseInt(timeMatch[2]);
                const seconds = parseFloat(timeMatch[3]);
                const currentSeconds = hours * 3600 + minutes * 60 + seconds;

                // é€²æ—ç‡ã‚’è¨ˆç®—ï¼ˆ0-100%ï¼‰
                const progressPercent = Math.min(100, Math.round((currentSeconds / window.recordingTotalDuration) * 100));

                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’æ›´æ–°
                if (progressBar) {
                    progressBar.style.width = `${progressPercent}%`;
                }

                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
                if (statusTitle) statusTitle.textContent = 'éŒ²éŸ³ä¸­...';
                if (statusMessage) {
                    const remainingSeconds = Math.max(0, window.recordingTotalDuration - currentSeconds);
                    const remainingMinutes = Math.floor(remainingSeconds / 60);
                    const remainingSecondsOnly = Math.floor(remainingSeconds % 60);
                    statusMessage.textContent = `é€²æ—: ${progressPercent}% (æ®‹ã‚Šç´„${remainingMinutes}åˆ†${remainingSecondsOnly}ç§’)`;
                }
            }

            // è©³ç´°ãƒ­ã‚°ã«è¿½åŠ 
            if (logContent) {
                const logLine = document.createElement('div');
                logLine.style.marginBottom = '4px';

                if (type === 'error') {
                    logLine.style.color = '#f48771';
                } else if (type === 'success') {
                    logLine.style.color = '#4ec9b0';
                } else {
                    logLine.style.color = '#d4d4d4';
                }

                logLine.textContent = message;
                logContent.appendChild(logLine);

                // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                logContent.scrollTop = logContent.scrollHeight;
            }

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’æ›´æ–°
            if (type === 'info') {
                if (statusIcon) statusIcon.textContent = 'â³';
                // time=ãŒã‚ã‚‹å ´åˆã¯ä¸Šã§æ—¢ã«æ›´æ–°ã•ã‚Œã¦ã„ã‚‹ã®ã§ã‚¹ã‚­ãƒƒãƒ—
                if (!timeMatch) {
                    if (statusTitle) statusTitle.textContent = 'éŒ²éŸ³ä¸­...';
                    if (statusMessage) statusMessage.textContent = message;
                    if (progressBar) progressBar.style.width = '10%';
                }
            } else if (type === 'success') {
                if (statusIcon) statusIcon.textContent = 'âœ…';
                if (statusTitle) statusTitle.textContent = 'éŒ²éŸ³å®Œäº†ï¼';
                if (statusMessage) statusMessage.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸ';
                if (progressBar) {
                    progressBar.style.width = '100%';
                    progressBar.style.background = 'linear-gradient(90deg, #4caf50, #45a049)';
                }
            } else if (type === 'error') {
                if (statusIcon) statusIcon.textContent = 'âŒ';
                if (statusTitle) statusTitle.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                if (statusMessage) statusMessage.textContent = message;
                if (progressBar) {
                    progressBar.style.background = 'linear-gradient(90deg, #e57373, #ef5350)';
                }
            }

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ï¼ˆæˆåŠŸæ™‚ï¼‰
            if (file && type === 'success') {
                const proxyUrl = document.getElementById('proxyUrl').value;
                const baseUrl = proxyUrl.trim() || '';
                const downloadUrl = `${baseUrl}/download/${file}`;
                const filename = file.split('/').pop();

                // commandBoxã®ä¸­ã«å¤§ããªãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
                const commandBox = document.getElementById('commandBox');
                const downloadSection = document.createElement('div');
                downloadSection.style.marginTop = '15px';
                downloadSection.style.padding = '20px';
                downloadSection.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                downloadSection.style.borderRadius = '8px';
                downloadSection.style.textAlign = 'center';
                downloadSection.innerHTML = `
                    <div style="color: white; font-size: 1.1em; font-weight: 600; margin-bottom: 10px;">
                        ğŸ‰ éŒ²éŸ³ãŒå®Œäº†ã—ã¾ã—ãŸï¼
                    </div>
                    <div style="color: rgba(255,255,255,0.9); font-size: 0.9em; margin-bottom: 15px;">
                        ãƒ•ã‚¡ã‚¤ãƒ«: ${filename.replace(/\.(mp3|m4a|aac|wav)$/i, '')}
                    </div>
                    <a href="${downloadUrl}" download="${filename}"
                       style="display: inline-block; padding: 12px 24px; background: white; color: #667eea; text-decoration: none; font-weight: 600; border-radius: 6px; font-size: 1em; cursor: pointer; transition: all 0.2s;"
                       onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';"
                       onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                        ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </a>
                `;
                commandBox.querySelector('div').appendChild(downloadSection);
            }
        }

        async function copyCommand(event) {
            try {
                await navigator.clipboard.writeText(currentCommand);
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
                btn.style.background = '#28a745';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            } catch (err) {
                alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
            }
        }

        async function searchAllAreas() {
            const searchKeyword = document.getElementById('searchKeyword').value.trim();
            const proxyUrl = document.getElementById('proxyUrl').value;

            if (!searchKeyword) {
                showError('æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const programList = document.getElementById('programList');
            const fetchBtn = document.getElementById('fetchBtn');
            const searchAllBtn = document.getElementById('searchAllBtn');

            loading.style.display = 'block';
            loading.querySelector('p').textContent = 'æ¤œç´¢ä¸­...';
            error.style.display = 'none';
            programList.innerHTML = '';
            fetchBtn.disabled = true;
            searchAllBtn.disabled = true;

            try {
                // ã‚µãƒ¼ãƒãƒ¼å´DBæ¤œç´¢APIã‚’å‘¼ã³å‡ºã™
                // proxyUrlãŒ'/api'ã®å ´åˆã€'/api/programs/search'ã«ãªã‚‹
                // proxyUrlãŒç©ºã®å ´åˆã€'/api/programs/search'ã«ãªã‚‹
                const baseApiUrl = proxyUrl.trim() || '';
                const searchUrl = `${baseApiUrl}/api/programs/search?keyword=${encodeURIComponent(searchKeyword)}`;

                console.log('ğŸ” Searching via API:', searchUrl);

                const response = await fetch(searchUrl);

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Unknown error');
                }

                console.log(`âœ… Found ${data.count} programs from API`);

                // APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å½¢å¼ã‚’ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å½¢å¼ã«å¤‰æ›
                const allPrograms = data.programs.map(prog => ({
                    areaId: prog.areaId,
                    stationId: prog.stationId,
                    stationName: prog.stationName,
                    title: prog.title,
                    ft: new Date(prog.ft),
                    to: new Date(prog.to),
                    desc: prog.desc || 'èª¬æ˜ãªã—',
                    pfm: prog.pfm || '',
                    info: prog.info || '',
                    url: prog.url || ''
                }));

                if (allPrograms.length === 0) {
                    showError(`ã€Œ${searchKeyword}ã€ã«ä¸€è‡´ã™ã‚‹ç•ªçµ„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`);
                } else {
                    // é‡è¤‡ã‚’é™¤å»ï¼ˆåŒã˜æ”¾é€å±€IDã¨é–‹å§‹æ™‚åˆ»ã®çµ„ã¿åˆã‚ã›ï¼‰
                    const uniquePrograms = [];
                    const seen = new Set();

                    allPrograms.forEach(prog => {
                        const key = `${prog.stationId}_${prog.ft.getTime()}`;
                        if (!seen.has(key)) {
                            seen.add(key);
                            uniquePrograms.push(prog);
                        }
                    });

                    uniquePrograms.sort((a, b) => a.ft - b.ft);
                    displayPrograms(uniquePrograms);

                    // å…¨ã‚¨ãƒªã‚¢æ¤œç´¢çµæœã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’è¡¨ç¤º
                    document.getElementById('searchResultsIndicator').style.display = 'block';
                }

            } catch (err) {
                showError(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${err.message}`);
                fetchBtn.disabled = false;
                searchAllBtn.disabled = false;
            } finally {
                loading.style.display = 'none';
                loading.querySelector('p').textContent = 'ç•ªçµ„è¡¨ã‚’èª­ã¿è¾¼ã¿ä¸­...';
                // æ¤œç´¢çµæœè¡¨ç¤ºä¸­ã¯fetchBtnã‚’ç„¡åŠ¹åŒ–ã—ãŸã¾ã¾ï¼ˆé€šå¸¸ã®ç•ªçµ„è¡¨å–å¾—æ™‚ã«æœ‰åŠ¹åŒ–ã•ã‚Œã‚‹ï¼‰
                searchAllBtn.disabled = false;
            }
        }

        function showError(message) {
            const error = document.getElementById('error');
            error.textContent = message;
            error.style.display = 'block';
        }

        // éŒ²éŸ³æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
        let allRecordedFiles = [];
        let currentSort = { column: 'modified', direction: 'desc' };
        let currentPage = 1;
        const itemsPerPage = 50;
        let filterText = '';

        // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰æ”¾é€æ—¥ã‚’æŠ½å‡ºã™ã‚‹é–¢æ•°
        function extractBroadcastDate(filename) {
            // ãƒ‘ã‚¿ãƒ¼ãƒ³1: YYYY.MM.DD å½¢å¼ï¼ˆä¾‹: 2025.10.26ï¼‰
            let match = filename.match(/(\d{4})\.(\d{2})\.(\d{2})/);
            if (match) {
                return `${match[1]}-${match[2]}-${match[3]}`;
            }

            // ãƒ‘ã‚¿ãƒ¼ãƒ³2: YYYYMMDD å½¢å¼ï¼ˆä¾‹: 20251026ï¼‰
            match = filename.match(/(\d{4})(\d{2})(\d{2})/);
            if (match) {
                return `${match[1]}-${match[2]}-${match[3]}`;
            }

            // ãƒ‘ã‚¿ãƒ¼ãƒ³3: YYYY-MM-DD å½¢å¼ï¼ˆä¾‹: 2025-10-26ï¼‰
            match = filename.match(/(\d{4})-(\d{2})-(\d{2})/);
            if (match) {
                return `${match[1]}-${match[2]}-${match[3]}`;
            }

            return null; // æ—¥ä»˜ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
        function toggleFilesMenu(event) {
            if (event) event.stopPropagation();
            const menu = document.getElementById('filesMenuDropdown');
            if (menu.style.display === 'none' || menu.style.display === '') {
                // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
                menu.style.display = 'block';

                // å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰é–‰ã˜ã‚‹
                setTimeout(() => {
                    document.addEventListener('click', closeFilesMenuOnClickOutside);
                }, 0);
            } else {
                menu.style.display = 'none';
                document.removeEventListener('click', closeFilesMenuOnClickOutside);
            }
        }

        function closeFilesMenuOnClickOutside(e) {
            const menu = document.getElementById('filesMenuDropdown');
            if (menu && !menu.contains(e.target) && !e.target.closest('[onclick*="toggleFilesMenu"]')) {
                menu.style.display = 'none';
                document.removeEventListener('click', closeFilesMenuOnClickOutside);
            }
        }

        async function loadRecordedFiles() {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            const filesLoading = document.getElementById('filesLoading');
            const filesList = document.getElementById('filesList');

            filesLoading.style.display = 'block';
            filesList.innerHTML = '';

            try {
                // ãƒ•ã‚©ãƒ«ãƒ€æƒ…å ±ã‚’å–å¾—
                await loadFolders();

                // ç¾åœ¨ã®ãƒ•ã‚©ãƒ«ãƒ€ã«å¿œã˜ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
                let url;
                if (currentFolderId !== null) {
                    url = `${baseUrl}/folders/${currentFolderId}/files`;
                } else {
                    url = `${baseUrl}/files`;
                }

                const response = await fetch(url);
                if (!response.ok) {
                    console.error('Failed to load recorded files:', response.statusText);
                    filesLoading.style.display = 'none';
                    filesList.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 40px; font-size: 0.95em;">ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
                    return;
                }

                const data = await response.json();
                allRecordedFiles = data.files || [];

                // ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆã‚’æ›´æ–°
                updateBreadcrumb();

                filesLoading.style.display = 'none';

                // ç¾åœ¨ã®ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€ã‚’å–å¾—
                const currentFolders = allFolders.filter(f => f.parent_id === currentFolderId);

                // ãƒ«ãƒ¼ãƒˆç”»é¢ã§ä½•ã‚‚ãªã„å ´åˆã®ã¿ç©ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                if (currentFolderId === null && currentFolders.length === 0 && allRecordedFiles.length === 0) {
                    filesList.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px;">
                            <div style="font-size: 3em; margin-bottom: 15px;">ğŸ“­</div>
                            <div style="color: #6c757d; font-size: 1.1em; font-weight: 500;">ãƒ•ã‚©ãƒ«ãƒ€ã¨ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“</div>
                            <div style="color: #adb5bd; font-size: 0.9em; margin-top: 8px;">ğŸ“‚ æ–°è¦ãƒ•ã‚©ãƒ«ãƒ€ãƒœã‚¿ãƒ³ã§ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã§ãã¾ã™</div>
                        </div>
                    `;
                    return;
                }

                currentPage = 1;
                renderFilesList();

            } catch (err) {
                console.error('Error loading recorded files:', err);
                filesLoading.style.display = 'none';
                filesList.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 40px; font-size: 0.95em;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
            }
        }

        async function scanExistingFiles() {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            const confirmed = confirm('æ—¢å­˜ã®éŒ²éŸ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦DBã«ç™»éŒ²ã—ã¾ã™ã€‚\n\nå‡¦ç†ã«ã¯æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚\nç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ');
            if (!confirmed) return;

            const filesLoading = document.getElementById('filesLoading');
            const filesList = document.getElementById('filesList');

            filesLoading.style.display = 'block';
            filesList.innerHTML = '<div style="text-align: center; padding: 40px; font-size: 0.95em; color: #667eea;">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­...</div>';

            try {
                const response = await fetch(`${baseUrl}/files/scan`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`ã‚¹ã‚­ãƒ£ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.success) {
                    alert(`âœ… ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†ï¼\n\næ–°è¦ç™»éŒ²: ${data.registered}ä»¶\næ›´æ–°: ${data.updated}ä»¶\nåˆè¨ˆ: ${data.total}ä»¶\n${data.errors && data.errors.length > 0 ? `\nã‚¨ãƒ©ãƒ¼: ${data.errors.length}ä»¶` : ''}`);
                    // ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                    await loadRecordedFiles();
                } else {
                    throw new Error(data.error || 'ã‚¹ã‚­ãƒ£ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

            } catch (err) {
                console.error('Error scanning files:', err);
                filesLoading.style.display = 'none';
                alert(`âŒ ã‚¹ã‚­ãƒ£ãƒ³ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ\n\n${err.message}`);
                filesList.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 40px; font-size: 0.95em;">ã‚¹ã‚­ãƒ£ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }

        function renderFilesList() {
            const filesList = document.getElementById('filesList');
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            // æ¤œç´¢å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹çŠ¶æ…‹ã‚’ä¿å­˜
            const oldFilterInput = document.getElementById('fileFilter');
            let shouldRestoreFocus = false;
            let savedSelectionStart = 0;
            let savedSelectionEnd = 0;
            if (oldFilterInput && document.activeElement === oldFilterInput) {
                shouldRestoreFocus = true;
                savedSelectionStart = oldFilterInput.selectionStart;
                savedSelectionEnd = oldFilterInput.selectionEnd;
            }

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let filteredFiles = allRecordedFiles.filter(file => {
                if (!filterText) return true;
                return file.name.toLowerCase().includes(filterText.toLowerCase());
            });

            // è¡¨ç¤ºç”¨ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜ï¼ˆprogram_infoå«ã‚€ï¼‰
            currentDisplayedFiles = filteredFiles;

            // ã‚½ãƒ¼ãƒˆ
            filteredFiles.sort((a, b) => {
                let valA, valB;
                if (currentSort.column === 'name') {
                    valA = a.name;
                    valB = b.name;
                } else if (currentSort.column === 'size') {
                    valA = a.size;
                    valB = b.size;
                } else if (currentSort.column === 'modified') {
                    valA = a.modified;
                    valB = b.modified;
                } else if (currentSort.column === 'broadcast') {
                    // æ”¾é€æ—¥ã§ã‚½ãƒ¼ãƒˆ
                    const dateA = extractBroadcastDate(a.name);
                    const dateB = extractBroadcastDate(b.name);
                    // æ—¥ä»˜ãŒãªã„å ´åˆã¯æœ€å¾Œã«ã‚½ãƒ¼ãƒˆ
                    if (!dateA && !dateB) return 0;
                    if (!dateA) return 1;
                    if (!dateB) return -1;
                    valA = dateA;
                    valB = dateB;
                }

                if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
            const totalPages = Math.ceil(filteredFiles.length / itemsPerPage);
            const startIdx = (currentPage - 1) * itemsPerPage;
            const endIdx = startIdx + itemsPerPage;
            const pageFiles = filteredFiles.slice(startIdx, endIdx);

            const totalSize = (filteredFiles.reduce((sum, f) => sum + f.size, 0) / 1024 / 1024 / 1024).toFixed(2);

            let html = `
                <div style="margin-bottom: 10px;">
                    <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                        <input type="text" id="fileFilter" placeholder="ğŸ” æ¤œç´¢..." value="${filterText}"
                               style="flex: 1; padding: 6px 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.85em;">
                        <div style="padding: 6px 10px; background: #f8f9fa; border-radius: 4px; font-size: 0.8em; color: #495057; white-space: nowrap;">
                            <strong>${filteredFiles.length}</strong>ä»¶
                        </div>
                    </div>
                    <div class="file-selection-controls" style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 0.85em;">
                            <input type="checkbox" id="selectAllFiles" onchange="toggleSelectAll(this.checked)"
                                   style="width: 14px; height: 14px; cursor: pointer;">
                            <span>å…¨é¸æŠ</span>
                        </label>
                        <button id="deleteSelectedBtn" onclick="deleteSelectedFiles()" disabled
                                style="padding: 6px 12px; background: white; color: #dc3545; border: 1px solid #dee2e6; border-radius: 4px; font-size: 0.8em; cursor: pointer; transition: background 0.2s; white-space: nowrap;"
                                onmouseover="if(!this.disabled) this.style.background='#fff5f5'" onmouseout="if(!this.disabled) this.style.background='white'">
                            ğŸ—‘ï¸ å‰Šé™¤
                        </button>
                        <button id="downloadSelectedBtn" onclick="downloadSelectedFiles()" disabled
                                style="padding: 6px 12px; background: white; color: #495057; border: 1px solid #dee2e6; border-radius: 4px; font-size: 0.8em; cursor: pointer; transition: background 0.2s; white-space: nowrap;"
                                onmouseover="if(!this.disabled) this.style.background='#f8f9fa'" onmouseout="if(!this.disabled) this.style.background='white'">
                            ğŸ“¦ ZIP
                        </button>
                        <span id="selectedCount" style="padding: 6px 10px; background: #f8f9fa; border-radius: 4px; font-size: 0.8em; color: #495057; display: none;">
                            <strong id="selectedCountNum">0</strong>ä»¶é¸æŠ
                        </span>
                    </div>
                </div>

                <div style="overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                        <thead>
                            <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                <th style="padding: 12px; text-align: center; width: 40px;"></th>
                                <th class="artwork-column" style="padding: 12px; text-align: center; width: 60px;"></th>
                                <th onclick="sortFiles('name')" style="padding: 12px; text-align: left; cursor: pointer; user-select: none; white-space: nowrap;"
                                    onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                                    ãƒ•ã‚¡ã‚¤ãƒ«å ${currentSort.column === 'name' ? (currentSort.direction === 'asc' ? 'â–²' : 'â–¼') : ''}
                                </th>
                                <th onclick="sortFiles('broadcast')" style="padding: 12px; text-align: center; cursor: pointer; user-select: none; white-space: nowrap; width: 120px;"
                                    onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                                    æ”¾é€æ—¥ ${currentSort.column === 'broadcast' ? (currentSort.direction === 'asc' ? 'â–²' : 'â–¼') : ''}
                                </th>
                                <th onclick="sortFiles('size')" style="padding: 12px; text-align: right; cursor: pointer; user-select: none; white-space: nowrap; width: 100px;"
                                    onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                                    ã‚µã‚¤ã‚º ${currentSort.column === 'size' ? (currentSort.direction === 'asc' ? 'â–²' : 'â–¼') : ''}
                                </th>
                                <th onclick="sortFiles('modified')" style="padding: 12px; text-align: center; cursor: pointer; user-select: none; white-space: nowrap; width: 140px;"
                                    onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                                    æ›´æ–°æ—¥æ™‚ ${currentSort.column === 'modified' ? (currentSort.direction === 'asc' ? 'â–²' : 'â–¼') : ''}
                                </th>
                                <th style="padding: 12px; text-align: center; width: 200px;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆã§ç§»å‹•ã§ãã‚‹ãŸã‚ã€ä¸€è¦§å†…ã®ã€Œä¸Šã®éšå±¤ã¸ã€è¡Œã¯ä¸è¦

            // ç¾åœ¨ã®ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€ã‚’è¡¨ç¤º
            const currentFolders = allFolders.filter(f => f.parent_id === currentFolderId);
            currentFolders.forEach((folder) => {
                html += `
                    <tr style="background: #fafbfc; border-bottom: 1px solid #dee2e6; cursor: pointer; transition: background 0.2s;"
                        onmouseover="this.style.background='#f1f3f5'"
                        onmouseout="this.style.background='#fafbfc'"
                        onclick="navigateToFolder(${folder.id})">
                        <td style="padding: 12px; text-align: center;"></td>
                        <td class="artwork-column" style="padding: 12px; text-align: center;">
                            <img src="img/folder.png" alt="Folder"
                                 style="width: 40px; height: 40px; border-radius: 4px; object-fit: cover;">
                        </td>
                        <td style="padding: 12px;">
                            <div style="font-weight: 600; color: #212529; font-size: 0.95em;">
                                ${folder.name}
                            </div>
                        </td>
                        <td style="padding: 12px; text-align: center; color: #adb5bd;">â€”</td>
                        <td style="padding: 12px; text-align: right; color: #adb5bd;">â€”</td>
                        <td style="padding: 12px; text-align: center; color: #adb5bd;">â€”</td>
                        <td style="padding: 12px; text-align: center;">
                            <div class="file-actions-desktop" style="display: flex; gap: 6px; justify-content: center;">
                                <button onclick='event.stopPropagation(); editFolder(${folder.id})'
                                        title="ãƒ•ã‚©ãƒ«ãƒ€ç·¨é›†"
                                        style="padding: 6px 12px; background: white; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; transition: all 0.2s; font-size: 13px; color: #495057;"
                                        onmouseover="this.style.background='#f8f9fa'"
                                        onmouseout="this.style.background='white'">
                                    âœï¸
                                </button>
                                <button onclick='event.stopPropagation(); deleteFolder(${folder.id}, "${folder.name.replace(/'/g, "\\'")}")'
                                        title="ãƒ•ã‚©ãƒ«ãƒ€å‰Šé™¤"
                                        style="padding: 6px 12px; background: white; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; transition: all 0.2s; font-size: 13px; color: #dc3545;"
                                        onmouseover="this.style.background='#fff5f5'"
                                        onmouseout="this.style.background='white'">
                                    ğŸ—‘ï¸
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            pageFiles.forEach((file, idx) => {
                // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼
                if (!file || !file.path || !file.name) {
                    console.warn('Invalid file data:', file);
                    return;
                }

                const fileSize = (file.size / 1024 / 1024).toFixed(1);
                // file.modifiedã¯æ–‡å­—åˆ—ï¼ˆISOå½¢å¼ï¼‰ã¾ãŸã¯Unixã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ä¸¡æ–¹å¯¾å¿œ
                const modDate = typeof file.modified === 'string' ? new Date(file.modified) : new Date(file.modified * 1000);
                const dateStr = `${modDate.getMonth() + 1}/${modDate.getDate()} ${String(modDate.getHours()).padStart(2, '0')}:${String(modDate.getMinutes()).padStart(2, '0')}`;

                // ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
                const bookmarkKey = `bookmark_${file.path}`;
                const durationKey = `duration_${file.path}`;
                const savedTime = localStorage.getItem(bookmarkKey);
                const savedDuration = localStorage.getItem(durationKey);
                const hasBookmark = savedTime !== null;

                // æ™‚é–“è¡¨ç¤ºã‚’ä½œæˆ (HH:MM:SS / HH:MM:SS)
                const formatTimeDisplay = (seconds) => {
                    const h = Math.floor(seconds / 3600);
                    const m = Math.floor((seconds % 3600) / 60);
                    const s = Math.floor(seconds % 60);
                    if (h > 0) {
                        return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                    } else {
                        return `${m}:${s.toString().padStart(2, '0')}`;
                    }
                };

                const currentTime = hasBookmark ? parseFloat(savedTime) : 0;
                const duration = savedDuration ? parseFloat(savedDuration) : 0;

                // durationãŒ0ã®å ´åˆã¯ã€Œå–å¾—ä¸­...ã€ã¨è¡¨ç¤ºã—ã€éåŒæœŸã§é•·ã•ã‚’å–å¾—
                let progressText = '';
                if (duration > 0) {
                    progressText = `${formatTimeDisplay(currentTime)} / ${formatTimeDisplay(duration)}`;
                } else {
                    progressText = '<span class="duration-loading" data-filepath="' + file.path + '">å–å¾—ä¸­...</span>';
                }

                // é€²æ—ç‡ã‚’è¨ˆç®—
                let progressPercent = 0;
                if (duration > 0) {
                    progressPercent = Math.round((currentTime / duration) * 100);
                }

                // SVGå††ã‚°ãƒ©ãƒ•ã‚’ç”Ÿæˆï¼ˆä¸­å¤®å¡—ã‚Šã¤ã¶ã—ã‚¹ã‚¿ã‚¤ãƒ«ã€æ•°å­—ãªã—ï¼‰
                const outerRadius = 10;
                const innerRadius = 5;
                const strokeWidth = outerRadius - innerRadius;
                const radius = (outerRadius + innerRadius) / 2;
                const circumference = 2 * Math.PI * radius;
                const strokeDashoffset = circumference - (progressPercent / 100) * circumference;

                const progressCircle = `
                    <svg width="20" height="20" viewBox="0 0 24 24" style="margin-right: 6px; flex-shrink: 0;">
                        <circle cx="12" cy="12" r="${radius}" fill="none" stroke="#e9ecef" stroke-width="${strokeWidth}"></circle>
                        <circle cx="12" cy="12" r="${radius}" fill="none" stroke="#667eea" stroke-width="${strokeWidth}"
                                stroke-dasharray="${circumference}" stroke-dashoffset="${strokeDashoffset}"
                                transform="rotate(-90 12 12)"></circle>
                    </svg>
                `;

                // ã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯URLã‚’å–å¾—
                const programTitle = extractProgramTitle(file.name);
                const artworkUrl = `${baseUrl}/artwork/${encodeURIComponent(programTitle)}`;

                html += `
                    <tr data-filepath="${file.path.replace(/"/g, '&quot;')}" style="border-bottom: 1px solid #f0f0f0; transition: background 0.2s; cursor: pointer;"
                        onclick="toggleFileSelection('${file.path.replace(/'/g, "\\'")}')"
                        onmouseover="if(!this.classList.contains('selected')) this.style.background='#f8f9fa'"
                        onmouseout="if(!this.classList.contains('selected')) this.style.background='white'">
                        <td style="padding: 10px 12px; text-align: center;" onclick="event.stopPropagation()">
                            <input type="checkbox" class="file-checkbox" value="${file.path}" onchange="updateSelectedCount()"
                                   style="width: 16px; height: 16px; cursor: pointer;">
                        </td>
                        <td class="artwork-column" style="padding: 8px; text-align: center;" onclick="event.stopPropagation(); playAudioByIndex(${startIdx + idx})">
                            <div style="position: relative;">
                                <img src="${artworkUrl}" alt="Artwork"
                                     style="width: 40px; height: 40px; border-radius: 4px; object-fit: cover; box-shadow: 0 1px 3px rgba(0,0,0,0.2); cursor: pointer; transition: transform 0.2s;"
                                     onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'"
                                     onerror="this.src='img/jacket.png'">
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.6); border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s;"
                                     onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0'">
                                    <span style="color: white; font-size: 12px;">â–¶</span>
                                </div>
                            </div>
                        </td>
                        <td style="padding: 10px 12px;" onclick="event.stopPropagation(); playAudioByIndex(${startIdx + idx})" title="ã‚¯ãƒªãƒƒã‚¯ã§å†ç”Ÿ">
                            <div class="file-name-text" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 800px; ${hasBookmark ? 'color: #1976d2; font-weight: 500;' : ''} cursor: pointer; transition: color 0.2s;"
                                 onmouseover="this.style.color='#667eea'" onmouseout="this.style.color='${hasBookmark ? '#1976d2' : '#212529'}'">
                                ${file.name.replace(/\.(mp3|m4a|aac|wav)$/i, '')}
                            </div>
                            <div style="font-size: 0.75em; color: #667eea; margin-top: 3px; display: flex; align-items: center;">
                                ${progressCircle}
                                <span>${progressText}</span>
                            </div>
                            <div class="mobile-info" style="font-size: 0.75em; color: #6c757d; margin-top: 4px; display: none;">
                                ğŸ“… ${extractBroadcastDate(file.name) || 'ä¸æ˜'} â€¢ ğŸ’¾ ${fileSize} MB
                            </div>
                        </td>
                        <td style="padding: 10px 12px; text-align: center; color: #6c757d;">
                            ${extractBroadcastDate(file.name) || '<span style="color: #999;">ä¸æ˜</span>'}
                        </td>
                        <td style="padding: 10px 12px; text-align: right; color: #6c757d;">${fileSize} MB</td>
                        <td style="padding: 10px 12px; text-align: center; color: #6c757d; font-size: 0.85em;">${dateStr}</td>
                        <td style="padding: 10px 12px; text-align: center;" onclick="event.stopPropagation()">
                            <button data-file-idx="${idx}"
                                    data-file-path="${file.path.replace(/"/g, '&quot;')}"
                                    data-file-name="${file.name.replace(/"/g, '&quot;')}"
                                    data-has-bookmark="${hasBookmark}"
                                    onclick='toggleFileMenu(event, ${idx}, "${file.path.replace(/'/g, "\\'")}", "${file.name.replace(/'/g, "\\'")}", ${hasBookmark})'
                                    style="padding: 8px 12px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; cursor: pointer; transition: all 0.15s; font-size: 18px; font-weight: bold; color: #495057;"
                                    onmouseover="this.style.background='#e9ecef'; this.style.borderColor='#adb5bd'"
                                    onmouseout="this.style.background='#f8f9fa'; this.style.borderColor='#dee2e6'">
                                â‹®
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
            if (totalPages > 1) {
                html += `
                    <div style="margin-top: 15px; display: flex; justify-content: center; align-items: center; gap: 8px; flex-wrap: wrap;">
                        <button onclick="currentPage = 1; renderFilesList();" ${currentPage === 1 ? 'disabled' : ''}
                                style="padding: 6px 12px; background: ${currentPage === 1 ? '#e9ecef' : '#667eea'}; color: ${currentPage === 1 ? '#6c757d' : 'white'}; border: none; border-radius: 4px; cursor: ${currentPage === 1 ? 'not-allowed' : 'pointer'};">
                            â‰ª
                        </button>
                        <button onclick="if(currentPage > 1) { currentPage--; renderFilesList(); }" ${currentPage === 1 ? 'disabled' : ''}
                                style="padding: 6px 12px; background: ${currentPage === 1 ? '#e9ecef' : '#667eea'}; color: ${currentPage === 1 ? '#6c757d' : 'white'}; border: none; border-radius: 4px; cursor: ${currentPage === 1 ? 'not-allowed' : 'pointer'};">
                            ï¼œ
                        </button>
                        <span style="padding: 6px 12px; color: #495057; font-size: 0.9em;">
                            ${currentPage} / ${totalPages}
                        </span>
                        <button onclick="if(currentPage < ${totalPages}) { currentPage++; renderFilesList(); }" ${currentPage === totalPages ? 'disabled' : ''}
                                style="padding: 6px 12px; background: ${currentPage === totalPages ? '#e9ecef' : '#667eea'}; color: ${currentPage === totalPages ? '#6c757d' : 'white'}; border: none; border-radius: 4px; cursor: ${currentPage === totalPages ? 'not-allowed' : 'pointer'};">
                            ï¼
                        </button>
                        <button onclick="currentPage = ${totalPages}; renderFilesList();" ${currentPage === totalPages ? 'disabled' : ''}
                                style="padding: 6px 12px; background: ${currentPage === totalPages ? '#e9ecef' : '#667eea'}; color: ${currentPage === totalPages ? '#6c757d' : 'white'}; border: none; border-radius: 4px; cursor: ${currentPage === totalPages ? 'not-allowed' : 'pointer'};">
                            â‰«
                        </button>
                    </div>
                `;
            }

            filesList.innerHTML = html;

            // æ¤œç´¢å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã¨ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’å¾©å…ƒ
            const fileFilterInput = document.getElementById('fileFilter');
            if (fileFilterInput && shouldRestoreFocus) {
                setTimeout(() => {
                    fileFilterInput.focus();
                    fileFilterInput.setSelectionRange(savedSelectionStart, savedSelectionEnd);
                }, 0);
            }

            // æ¤œç´¢å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’è¨­å®šï¼ˆ1å›ã®ã¿ï¼‰
            if (fileFilterInput && !fileFilterInput.dataset.listenerAdded) {
                fileFilterInput.dataset.listenerAdded = 'true';

                let isComposing = false;

                // IMEå¤‰æ›ä¸­ãƒ•ãƒ©ã‚°ã‚’ç®¡ç†
                fileFilterInput.addEventListener('compositionstart', function() {
                    isComposing = true;
                });

                fileFilterInput.addEventListener('compositionend', function(e) {
                    isComposing = false;
                    // IMEç¢ºå®šæ™‚ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å®Ÿè¡Œ
                    filterText = e.target.value;
                    currentPage = 1;
                    renderFilesList();
                });

                fileFilterInput.addEventListener('input', function(e) {
                    // IMEå¤‰æ›ä¸­ã¯å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
                    if (isComposing) return;

                    filterText = e.target.value;
                    currentPage = 1;
                    renderFilesList();
                });
            }

            // æœªå–å¾—ã®éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®é•·ã•ã‚’éåŒæœŸã§å–å¾—
            loadAudioDurations();
        }

        async function loadAudioDurations() {
            const loadingElements = document.querySelectorAll('.duration-loading');
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            const formatTimeDisplay = (seconds) => {
                const h = Math.floor(seconds / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                const s = Math.floor(seconds % 60);
                if (h > 0) {
                    return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                } else {
                    return `${m}:${s.toString().padStart(2, '0')}`;
                }
            };

            loadingElements.forEach(async (element) => {
                const filepath = element.getAttribute('data-filepath');
                const durationKey = `duration_${filepath}`;

                // æ—¢ã«localStorageã«ã‚ã‚‹å ´åˆã¯è¡¨ç¤ºã ã‘æ›´æ–°
                const cachedDuration = localStorage.getItem(durationKey);
                if (cachedDuration) {
                    const duration = parseFloat(cachedDuration);
                    element.textContent = `0:00 / ${formatTimeDisplay(duration)}`;
                    return;
                }

                try {
                    // Audioè¦ç´ ã‚’ä½¿ã£ã¦éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®é•·ã•ã‚’å–å¾—
                    const audio = new Audio();
                    audio.src = `${baseUrl}/stream/${filepath}`;

                    audio.addEventListener('loadedmetadata', () => {
                        const duration = audio.duration;
                        if (duration && !isNaN(duration) && isFinite(duration)) {
                            // localStorageã«ä¿å­˜
                            localStorage.setItem(durationKey, duration.toString());

                            // è¡¨ç¤ºã‚’æ›´æ–°
                            element.textContent = `0:00 / ${formatTimeDisplay(duration)}`;
                        }
                    });

                    audio.addEventListener('error', () => {
                        element.textContent = '0:00';
                    });
                } catch (err) {
                    console.error('Duration load error:', err);
                    element.textContent = '0:00';
                }
            });
        }

        function sortFiles(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = column === 'name' ? 'asc' : 'desc';
            }
            renderFilesList();
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
        async function checkFileExists(prog) {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            const startStr = formatRadikoTime(new Date(prog.ft));

            try {
                const response = await fetch(`${baseUrl}/check-file`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: prog.title,
                        rss: prog.stationId,
                        start_time: startStr
                    })
                });

                if (!response.ok) {
                    return null;
                }

                const data = await response.json();
                return data;
            } catch (err) {
                console.error('Error checking file:', err);
                return null;
            }
        }

        // cronå¼ã‚’äººé–“ãŒèª­ã‚ã‚‹å½¢å¼ã«å¤‰æ›
        function parseCronExpression(cronLine) {
            // cronã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰cronå¼éƒ¨åˆ†ã‚’æŠ½å‡º
            const parts = cronLine.trim().split(/\s+/);
            if (parts.length < 5) return { description: 'ç„¡åŠ¹ãªcronå¼', parts: null };

            const minute = parts[0];
            const hour = parts[1];
            const dayOfMonth = parts[2];
            const month = parts[3];
            const dayOfWeek = parts[4];

            const daysOfWeekJp = ['æ—¥æ›œæ—¥', 'æœˆæ›œæ—¥', 'ç«æ›œæ—¥', 'æ°´æ›œæ—¥', 'æœ¨æ›œæ—¥', 'é‡‘æ›œæ—¥', 'åœŸæ›œæ—¥'];

            let description = 'å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°: ';

            // æ›œæ—¥ã®è§£æ
            if (dayOfWeek !== '*') {
                const day = parseInt(dayOfWeek);
                description += `æ¯é€±${daysOfWeekJp[day]}ã® `;
            } else if (dayOfMonth !== '*') {
                description += `æ¯æœˆ${dayOfMonth}æ—¥ã® `;
            } else {
                description += 'æ¯æ—¥ ';
            }

            // æ™‚åˆ»ã®è§£æ
            if (hour === '*' && minute === '*') {
                description += 'æ¯æ™‚æ¯åˆ†';
            } else if (hour === '*') {
                description += `æ¯æ™‚${minute}åˆ†`;
            } else if (minute === '*') {
                description += `${hour}æ™‚å°ã®æ¯åˆ†`;
            } else {
                description += `${hour}:${minute.padStart(2, '0')}`;
            }

            return {
                description,
                parts: { minute, hour, dayOfMonth, month, dayOfWeek }
            };
        }

        // cronä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
        async function loadCronJobs() {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            const cronLoading = document.getElementById('cronLoading');
            const cronList = document.getElementById('cronList');

            cronLoading.style.display = 'block';
            cronList.innerHTML = '';

            try {
                // ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§ã‚’å…ˆã«å–å¾—ï¼ˆãƒ•ã‚©ãƒ«ãƒ€åè¡¨ç¤ºã®ãŸã‚ï¼‰
                try {
                    const foldersResponse = await fetch(`${baseUrl}/folders`);
                    if (foldersResponse.ok) {
                        const foldersData = await foldersResponse.json();
                        allFolders = foldersData.folders || [];
                    }
                } catch (err) {
                    console.warn('Failed to load folders:', err);
                }

                const response = await fetch(`${baseUrl}/cron/list`);
                if (!response.ok) {
                    cronLoading.style.display = 'none';
                    cronList.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 40px; font-size: 0.95em;">cronä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
                    return;
                }

                const data = await response.json();
                const cronJobs = data.cron_jobs || [];

                // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
                currentCronJobs = cronJobs;

                cronLoading.style.display = 'none';

                if (cronJobs.length === 0) {
                    cronList.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px;">
                            <div style="font-size: 3em; margin-bottom: 15px;">â°</div>
                            <div style="color: #6c757d; font-size: 1.1em; font-weight: 500;">ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹cronã‚¸ãƒ§ãƒ–ã¯ã‚ã‚Šã¾ã›ã‚“</div>
                            <div style="color: #adb5bd; font-size: 0.9em; margin-top: 8px;">ç•ªçµ„ã®cronã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
                        </div>
                    `;
                    return;
                }

                let html = `
                    <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 0.9em; color: #495057;">
                            <strong>${cronJobs.length}ä»¶</strong>ã®äºˆç´„
                        </div>
                        <button onclick="loadCronLogs()" style="padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; font-size: 0.85em; cursor: pointer;">
                            ğŸ“‹ ãƒ­ã‚°ã‚’è¡¨ç¤º
                        </button>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                `;

                cronJobs.forEach((job, index) => {
                    // cronã®å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°æƒ…å ±ã‚’ä½œæˆ
                    const cronInfo = parseCronExpression(job.raw || job);

                    // ç•ªçµ„æƒ…å ±ã®è¡¨ç¤º
                    const title = job.title || 'ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜ï¼‰';
                    const station = job.station || '';
                    const startTime = job.startTime ? `${job.startTime.slice(0,2)}:${job.startTime.slice(2,4)}` : '';
                    const endTime = job.endTime ? `${job.endTime.slice(0,2)}:${job.endTime.slice(2,4)}` : '';
                    const timeRange = startTime && endTime ? `${startTime}-${endTime}` : '';

                    // ãƒ•ã‚©ãƒ«ãƒ€æƒ…å ±ã‚’å–å¾—
                    let folderInfo = '';
                    if (job.virtual_folder_id) {
                        const folder = allFolders.find(f => f.id === job.virtual_folder_id);
                        if (folder) {
                            const icon = folder.icon || 'ğŸ“';
                            folderInfo = `<span style="color: ${folder.color || '#667eea'};">ğŸ“ ${folder.name}</span>`;
                        }
                    }

                    const isMobile = window.innerWidth <= 768;

                    if (isMobile) {
                        // ã‚¹ãƒãƒ›ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
                        html += `
                            <div style="padding: 12px; background: white; border: 1px solid #dee2e6; border-radius: 6px;">
                                <div style="font-weight: 600; color: #212529; margin-bottom: 8px; font-size: 1em; line-height: 1.4;">
                                    ${title}
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 4px; font-size: 0.85em; color: #495057; margin-bottom: 10px;">
                                    ${station ? `
                                        <div style="display: flex; align-items: center; gap: 4px;">
                                            <span>ğŸ“»</span>
                                            <span>${station}</span>
                                        </div>
                                    ` : ''}
                                    ${timeRange ? `
                                        <div style="display: flex; align-items: center; gap: 4px;">
                                            <span>ğŸ•’</span>
                                            <span>${timeRange}</span>
                                        </div>
                                    ` : ''}
                                    ${folderInfo ? `
                                        <div style="display: flex; align-items: center; gap: 4px;">
                                            ${folderInfo}
                                        </div>
                                    ` : ''}
                                    <div style="display: flex; align-items: center; gap: 4px; color: #6c757d; font-size: 0.8em;">
                                        <span>â°</span>
                                        <span>${cronInfo.description.replace('å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°: ', '')}</span>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                    <button onclick='editCronJob(${index}, ${JSON.stringify(job).replace(/'/g, "\\'").replace(/"/g, "&quot;")})'
                                            class="btn btn-secondary"
                                            style="padding: 8px 12px; font-size: 0.85em; white-space: nowrap;">
                                        âœï¸ ç·¨é›†
                                    </button>
                                    <button onclick='removeCronJobByIndex(${index})'
                                            style="padding: 8px 12px; background: #e74c3c; color: white; border: none; border-radius: 6px; font-size: 0.85em; font-weight: 600; cursor: pointer; white-space: nowrap;">
                                        âœ• å‰Šé™¤
                                    </button>
                                </div>
                            </div>
                        `;
                    } else {
                        // PCãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆå¾“æ¥é€šã‚Šï¼‰
                        html += `
                            <div style="padding: 12px; background: white; border: 1px solid #dee2e6; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; gap: 12px;">
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: 600; color: #212529; margin-bottom: 4px; font-size: 0.95em;">
                                        ${title}
                                    </div>
                                    <div style="display: flex; gap: 12px; flex-wrap: wrap; font-size: 0.8em; color: #6c757d;">
                                        ${station ? `<span>ğŸ¢ ${station}</span>` : ''}
                                        ${timeRange ? `<span>ğŸ“¡ ${timeRange}</span>` : ''}
                                        ${folderInfo ? `<span>${folderInfo}</span>` : ''}
                                        <span>â° ${cronInfo.description.replace('å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°: ', '')}</span>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 6px; flex-shrink: 0;">
                                    <button onclick='editCronJob(${index}, ${JSON.stringify(job).replace(/'/g, "\\'").replace(/"/g, "&quot;")})'
                                            style="padding: 8px 14px; background: #3498db; color: white; border: none; border-radius: 6px; font-size: 0.85em; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);"
                                            onmouseover="this.style.background='#2980b9'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 3px 6px rgba(0, 0, 0, 0.15)'"
                                            onmouseout="this.style.background='#3498db'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0, 0, 0, 0.1)'"
                                            title="ç·¨é›†">
                                        âœï¸ ç·¨é›†
                                    </button>
                                    <button onclick='removeCronJobByIndex(${index})'
                                            style="padding: 8px 14px; background: #e74c3c; color: white; border: none; border-radius: 6px; font-size: 0.85em; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);"
                                            onmouseover="this.style.background='#c0392b'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 3px 6px rgba(0, 0, 0, 0.15)'"
                                            onmouseout="this.style.background='#e74c3c'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0, 0, 0, 0.1)'"
                                            title="å‰Šé™¤">
                                        âœ• å‰Šé™¤
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                });

                html += '</div>';
                cronList.innerHTML = html;

            } catch (err) {
                console.error('Error loading cron jobs:', err);
                cronLoading.style.display = 'none';
                cronList.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 40px; font-size: 0.95em;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
            }
        }

        // cronã‚¸ãƒ§ãƒ–ã‚’è¿½åŠ 
        async function addCronJob(command) {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                const response = await fetch(`${baseUrl}/cron/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ command: command })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('âœ… cronã‚¸ãƒ§ãƒ–ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                    closeModal();
                    // cronç®¡ç†ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆã¦ä¸€è¦§ã‚’æ›´æ–°
                    switchTab('cron');
                } else {
                    alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + (data.error || 'cronã‚¸ãƒ§ãƒ–ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ'));
                }
            } catch (err) {
                console.error('Error adding cron job:', err);
                alert('âŒ cronã‚¸ãƒ§ãƒ–ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«cronã‚¸ãƒ§ãƒ–ã‚’ä¿å­˜
        let currentCronJobs = [];

        // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§cronã‚¸ãƒ§ãƒ–ã‚’å‰Šé™¤
        async function removeCronJobByIndex(index) {
            const job = currentCronJobs[index];
            if (!job) {
                alert('âŒ cronã‚¸ãƒ§ãƒ–ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                return;
            }

            console.log('Removing cron job:', job);
            console.log('Job ID:', job.id);

            const title = job.title || 'ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜';
            if (!confirm(`ã“ã®äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\n${title}`)) {
                return;
            }

            await removeCronJob(job.id);
        }

        // cronã‚¸ãƒ§ãƒ–ã‚’å‰Šé™¤
        async function removeCronJob(jobId) {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            console.log('removeCronJob called with jobId:', jobId);
            console.log('Base URL:', baseUrl);

            if (!jobId) {
                alert('âŒ ã‚¨ãƒ©ãƒ¼: ã‚¸ãƒ§ãƒ–IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                console.error('Job ID is undefined or null');
                return;
            }

            try {
                const payload = { id: jobId };
                console.log('Sending payload:', payload);

                const response = await fetch(`${baseUrl}/cron/remove`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                console.log('Response:', response.status, data);

                if (response.ok) {
                    alert('âœ… äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    loadCronJobs();
                } else {
                    alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + (data.error || 'äºˆç´„ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ'));
                }
            } catch (err) {
                console.error('Error removing cron job:', err);
                alert('âŒ äºˆç´„ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ãƒªãƒãƒ¼ãƒ ç”¨ã®å¤‰æ•°
        let renameFilePath = '';
        let renameFileName = '';

        // ãƒªãƒãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        function showRenameModal(filepath, filename) {
            renameFilePath = filepath;
            renameFileName = filename;

            // æ‹¡å¼µå­ã‚’é™¤ã„ãŸãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¡¨ç¤º
            const nameWithoutExt = filename.replace(/\.[^/.]+$/, '');
            document.getElementById('renameCurrentName').textContent = filename;
            document.getElementById('renameNewName').value = nameWithoutExt;
            document.getElementById('renameModal').classList.add('active');

            // å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
            setTimeout(() => {
                const input = document.getElementById('renameNewName');
                input.focus();
                input.select();
            }, 100);
        }

        // ãƒªãƒãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeRenameModal() {
            document.getElementById('renameModal').classList.remove('active');
            renameFilePath = '';
            renameFileName = '';
        }

        // ãƒªãƒãƒ¼ãƒ ã‚’å®Ÿè¡Œ
        async function executeRename() {
            const newNameInput = document.getElementById('renameNewName').value.trim();

            if (!newNameInput) {
                alert('âš ï¸ æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // æ‹¡å¼µå­ã‚’å–å¾—
            const ext = renameFileName.match(/\.[^/.]+$/);
            const newName = ext ? newNameInput + ext[0] : newNameInput;

            if (newName === renameFileName) {
                alert('âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«åãŒå¤‰æ›´ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            if (!confirm(`ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ\n\n${renameFileName}\nâ†“\n${newName}`)) {
                return;
            }

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                const response = await fetch(`${baseUrl}/rename-file`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        file_path: renameFilePath,
                        new_name: newName
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert(`âœ… ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å¤‰æ›´ã—ã¾ã—ãŸ\n\n${newName}`);
                    closeRenameModal();
                    loadRecordedFiles(); // ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’æ›´æ–°
                } else {
                    alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${data.error || 'ãƒªãƒãƒ¼ãƒ ã«å¤±æ•—ã—ã¾ã—ãŸ'}`);
                }
            } catch (err) {
                console.error('Rename error:', err);
                alert('âŒ ãƒªãƒãƒ¼ãƒ ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
        async function deleteFile(filepath, filename) {
            if (!confirm('ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\n' + filename)) {
                return;
            }

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                const response = await fetch(`${baseUrl}/file/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ path: filepath })
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.file_existed === false) {
                        alert('âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã¯å­˜åœ¨ã—ã¾ã›ã‚“ã§ã—ãŸãŒã€è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    } else {
                        alert('âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    }
                    loadRecordedFiles();
                } else {
                    alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + (data.error || 'ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ'));
                }
            } catch (err) {
                console.error('Error deleting file:', err);
                alert('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ã™ã¹ã¦é¸æŠ/è§£é™¤
        function toggleSelectAll(checked) {
            const checkboxes = document.querySelectorAll('.file-checkbox');
            checkboxes.forEach(cb => cb.checked = checked);
            updateSelectedCount();
        }

        // è¡Œã‚¯ãƒªãƒƒã‚¯ã§ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’åˆ‡ã‚Šæ›¿ãˆ
        function toggleFileMenu(event, idx, filePath, fileName, hasBookmark) {
            event.stopPropagation(); // è¡Œé¸æŠã‚’é˜²ã

            // æ—¢å­˜ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚·ãƒ¼ãƒˆãŒã‚ã‚Œã°é–‰ã˜ã‚‹
            const existingSheet = document.getElementById('fileActionSheet');
            if (existingSheet) {
                closeActionSheet();
                return;
            }

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            // PC/ãƒ¢ãƒã‚¤ãƒ«åˆ¤å®š
            const isMobile = window.innerWidth < 768;

            // èƒŒæ™¯ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’ä½œæˆ
            const overlay = document.createElement('div');
            overlay.id = 'fileActionSheetOverlay';
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9998; opacity: 0; transition: opacity 0.3s ease;';
            overlay.onclick = closeActionSheet;

            // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ
            const sheet = document.createElement('div');
            sheet.id = 'fileActionSheet';

            if (isMobile) {
                // ãƒ¢ãƒã‚¤ãƒ«: ä¸‹ã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³
                sheet.style.cssText = 'position: fixed; left: 0; right: 0; bottom: 0; background: white; border-radius: 20px 20px 0 0; box-shadow: 0 -4px 20px rgba(0,0,0,0.15); z-index: 9999; transform: translateY(100%); transition: transform 0.3s ease; max-width: 100%; margin: 0; padding-bottom: env(safe-area-inset-bottom);';
            } else {
                // PC: ä¸­å¤®ã«ãƒ¢ãƒ¼ãƒ€ãƒ«
                sheet.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 9999; opacity: 0; transition: all 0.3s ease; max-width: 480px; width: 90%;';
            }

            sheet.innerHTML = `
                <div style="padding: 20px 20px 10px 20px; border-bottom: 1px solid #f0f0f0;">
                    ${isMobile ? '<div style="width: 40px; height: 4px; background: #dee2e6; border-radius: 2px; margin: 0 auto 16px auto;"></div>' : ''}
                    <div style="font-weight: 600; font-size: 1.1em; color: #212529; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${fileName}">${fileName.replace(/\.(mp3|m4a|aac|wav)$/i, '')}</div>
                </div>
                <div style="padding: 8px 0; max-height: ${isMobile ? '70vh' : '60vh'}; overflow-y: auto;">
                    <a href="${baseUrl}/download/${filePath}" download="${fileName}" onclick='closeActionSheet();'
                       style="padding: 16px 24px; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; gap: 16px; text-decoration: none; color: inherit;"
                       onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px;">ğŸ’¾</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 500; color: #212529;">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</div>
                            <div style="font-size: 0.85em; color: #6c757d; margin-top: 2px;">ãƒ‡ãƒã‚¤ã‚¹ã«ä¿å­˜</div>
                        </div>
                    </a>
                    <div onclick='showMoveFileModal("${filePath.replace(/'/g, "\\'")}", "${fileName.replace(/'/g, "\\'")}"); closeActionSheet();'
                         style="padding: 16px 24px; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; gap: 16px;"
                         onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px;">ğŸ“</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 500; color: #212529;">ãƒ•ã‚©ãƒ«ãƒ€ã«ç§»å‹•</div>
                            <div style="font-size: 0.85em; color: #6c757d; margin-top: 2px;">åˆ¥ã®ãƒ•ã‚©ãƒ«ãƒ€ã¸ç§»å‹•</div>
                        </div>
                    </div>
                    <div onclick='showArtworkUploadModal("${fileName.replace(/'/g, "\\'")}"); closeActionSheet();'
                         style="padding: 16px 24px; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; gap: 16px;"
                         onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px;">ğŸ¨</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 500; color: #212529;">ã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯</div>
                            <div style="font-size: 0.85em; color: #6c757d; margin-top: 2px;">ã‚¸ãƒ£ã‚±ãƒƒãƒˆç”»åƒã‚’ç™»éŒ²</div>
                        </div>
                    </div>
                    <div onclick='showRenameModal("${filePath.replace(/'/g, "\\'")}", "${fileName.replace(/'/g, "\\'")}"); closeActionSheet();'
                         style="padding: 16px 24px; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; gap: 16px;"
                         onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px;">âœï¸</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 500; color: #212529;">ãƒªãƒãƒ¼ãƒ </div>
                            <div style="font-size: 0.85em; color: #6c757d; margin-top: 2px;">ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å¤‰æ›´</div>
                        </div>
                    </div>
                    <div onclick='deleteFile("${filePath.replace(/'/g, "\\'")}", "${fileName.replace(/'/g, "\\'")}"); closeActionSheet();'
                         style="padding: 16px 24px; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; gap: 16px;"
                         onmouseover="this.style.background='#fff5f5'" onmouseout="this.style.background='white'">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px;">ğŸ—‘ï¸</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 500; color: #dc3545;">å‰Šé™¤</div>
                            <div style="font-size: 0.85em; color: #6c757d; margin-top: 2px;">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Œå…¨ã«å‰Šé™¤</div>
                        </div>
                    </div>
                </div>
                <div style="padding: 12px 20px 20px 20px;">
                    <button onclick='closeActionSheet()' style="width: 100%; padding: 14px; background: #f8f9fa; border: none; border-radius: 12px; font-weight: 600; color: #495057; cursor: pointer; font-size: 1em; transition: background 0.2s;"
                            onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                </div>
            `;

            // DOMã«è¿½åŠ 
            document.body.appendChild(overlay);
            document.body.appendChild(sheet);

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
            requestAnimationFrame(() => {
                overlay.style.opacity = '1';
                if (isMobile) {
                    sheet.style.transform = 'translateY(0)';
                } else {
                    sheet.style.transform = 'translate(-50%, -50%) scale(1)';
                    sheet.style.opacity = '1';
                }
            });
        }

        function closeActionSheet() {
            const overlay = document.getElementById('fileActionSheetOverlay');
            const sheet = document.getElementById('fileActionSheet');

            if (overlay && sheet) {
                const isMobile = window.innerWidth < 768;

                overlay.style.opacity = '0';
                if (isMobile) {
                    sheet.style.transform = 'translateY(100%)';
                } else {
                    sheet.style.transform = 'translate(-50%, -50%) scale(0.9)';
                    sheet.style.opacity = '0';
                }

                setTimeout(() => {
                    overlay.remove();
                    sheet.remove();
                }, 300);
            }
        }

        function toggleFileSelection(path) {
            const checkbox = document.querySelector(`.file-checkbox[value="${path}"]`);
            if (checkbox) {
                checkbox.checked = !checkbox.checked;

                // è¡Œã®èƒŒæ™¯è‰²ã‚’æ›´æ–°
                const row = checkbox.closest('tr');
                if (row) {
                    if (checkbox.checked) {
                        row.classList.add('selected');
                        row.style.background = '#e3f2fd';
                    } else {
                        row.classList.remove('selected');
                        row.style.background = 'white';
                    }
                }

                updateSelectedCount();
            }
        }

        // é¸æŠæ•°ã‚’æ›´æ–°
        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('.file-checkbox:checked');
            const count = checkboxes.length;

            // ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®èƒŒæ™¯è‰²ã‚’æ›´æ–°
            document.querySelectorAll('.file-checkbox').forEach(checkbox => {
                const row = checkbox.closest('tr');
                if (row) {
                    if (checkbox.checked) {
                        row.classList.add('selected');
                        row.style.background = '#e3f2fd';
                    } else {
                        row.classList.remove('selected');
                        row.style.background = 'white';
                    }
                }
            });

            const selectAllCheckbox = document.getElementById('selectAllFiles');
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            const downloadBtn = document.getElementById('downloadSelectedBtn');
            const countDisplay = document.getElementById('selectedCount');
            const countNum = document.getElementById('selectedCountNum');

            // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹åŒ–
            deleteBtn.disabled = count === 0;
            downloadBtn.disabled = count === 0;

            // ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
            if (count === 0) {
                deleteBtn.style.opacity = '0.5';
                deleteBtn.style.cursor = 'not-allowed';
                downloadBtn.style.opacity = '0.5';
                downloadBtn.style.cursor = 'not-allowed';
            } else {
                deleteBtn.style.opacity = '1';
                deleteBtn.style.cursor = 'pointer';
                downloadBtn.style.opacity = '1';
                downloadBtn.style.cursor = 'pointer';
            }

            // é¸æŠæ•°è¡¨ç¤º
            if (count > 0) {
                countDisplay.style.display = 'inline-block';
                countNum.textContent = count;
            } else {
                countDisplay.style.display = 'none';
            }

            // ã™ã¹ã¦é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹æ›´æ–°
            const allCheckboxes = document.querySelectorAll('.file-checkbox');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = allCheckboxes.length > 0 && count === allCheckboxes.length;
            }
        }

        // é¸æŠã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€æ‹¬å‰Šé™¤
        async function deleteSelectedFiles() {
            const checkboxes = document.querySelectorAll('.file-checkbox:checked');
            const paths = Array.from(checkboxes).map(cb => cb.value);

            if (paths.length === 0) {
                alert('å‰Šé™¤ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            if (!confirm(`é¸æŠã—ãŸ${paths.length}ä»¶ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) {
                return;
            }

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                const response = await fetch(`${baseUrl}/files/delete-multiple`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ paths: paths })
                });

                const data = await response.json();

                if (response.ok) {
                    const deletedCount = data.deleted.length;
                    const errorCount = data.errors.length;
                    let message = `âœ… ${deletedCount}ä»¶ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`;

                    if (errorCount > 0) {
                        message += `\n\nâš ï¸ ${errorCount}ä»¶ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ`;
                    }

                    alert(message);

                    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
                    const selectAllCheckbox = document.getElementById('selectAllFiles');
                    if (selectAllCheckbox) selectAllCheckbox.checked = false;

                    loadRecordedFiles();
                } else {
                    alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + (data.error || 'ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ'));
                }
            } catch (err) {
                console.error('Error deleting files:', err);
                alert('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // é¸æŠã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ZIPã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        async function downloadSelectedFiles() {
            const checkboxes = document.querySelectorAll('.file-checkbox:checked');
            const paths = Array.from(checkboxes).map(cb => cb.value);

            if (paths.length === 0) {
                alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                const response = await fetch(`${baseUrl}/files/download-zip`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ paths: paths })
                });

                if (response.ok) {
                    // Blobã¨ã—ã¦ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
                    const blob = await response.blob();

                    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ã®ãƒªãƒ³ã‚¯ã‚’ä½œæˆ
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;

                    // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—ï¼ˆContent-Dispositionãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ï¼‰
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = 'radiko_recordings.zip';
                    if (contentDisposition) {
                        const match = contentDisposition.match(/filename="?(.+)"?/);
                        if (match) filename = match[1];
                    }

                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();

                    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    const data = await response.json();
                    alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + (data.error || 'ZIPãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ'));
                }
            } catch (err) {
                console.error('Error downloading ZIP:', err);
                alert('âŒ ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // cronã‚¸ãƒ§ãƒ–ã‚’ç·¨é›†
        async function editCronJob(index, jobData) {
            console.log('ğŸ“ [editCronJob] jobData:', jobData);

            // jobDataã¯ãƒ‘ãƒ¼ã‚¹ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
            if (typeof jobData === 'string') {
                // æ—§å½¢å¼ã®å ´åˆã¯ãƒ‘ãƒ¼ã‚¹ã™ã‚‹
                const parts = jobData.trim().split(/\s+/);
                if (parts.length < 5) {
                    alert('ç„¡åŠ¹ãªcronå¼ã§ã™');
                    return;
                }
                jobData = {
                    raw: jobData,
                    minute: parts[0],
                    hour: parts[1],
                    dayOfWeek: parts[4],
                    command: parts.slice(5).join(' '),
                    title: '',
                    station: '',
                    startTime: '',
                    endTime: ''
                };
            }

            // ç•ªçµ„æƒ…å ±ã‚’è¡¨ç¤º
            document.getElementById('editProgramTitle').value = jobData.title || '';
            document.getElementById('editProgramStation').textContent = jobData.station ? `æ”¾é€å±€: ${jobData.station}` : '';

            // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã«å€¤ã‚’è¨­å®š
            document.getElementById('editMinute').value = jobData.minute;
            document.getElementById('editHour').value = jobData.hour;
            document.getElementById('editDayOfWeek').value = jobData.dayOfWeek;

            // éŒ²éŸ³æ™‚é–“ã‚’è¨­å®š
            console.log('â° [editCronJob] startTime:', jobData.startTime, 'endTime:', jobData.endTime);
            if (jobData.startTime) {
                const startTimeFormatted = `${jobData.startTime.slice(0,2)}:${jobData.startTime.slice(2,4)}`;
                console.log('â° [editCronJob] Setting startTime input to:', startTimeFormatted);
                document.getElementById('editStartTime').value = startTimeFormatted;
            } else {
                document.getElementById('editStartTime').value = '';
            }
            if (jobData.endTime) {
                const endTimeFormatted = `${jobData.endTime.slice(0,2)}:${jobData.endTime.slice(2,4)}`;
                console.log('â° [editCronJob] Setting endTime input to:', endTimeFormatted);
                document.getElementById('editEndTime').value = endTimeFormatted;
            } else {
                document.getElementById('editEndTime').value = '';
            }

            currentEditingCron.original = jobData.raw;
            currentEditingCron.jobData = jobData;

            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
            updateCronPreview();

            // ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
            await loadFoldersForCronEdit();

            // ãƒ•ã‚©ãƒ«ãƒ€é¸æŠã‚’è¨­å®š
            const folderSelect = document.getElementById('editCronFolder');
            if (folderSelect && jobData.virtual_folder_id) {
                folderSelect.value = jobData.virtual_folder_id;
            } else if (folderSelect) {
                folderSelect.value = '';
            }

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            document.getElementById('cronEditModal').classList.add('active');
        }

        // cronãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
        function updateCronPreview() {
            const minute = document.getElementById('editMinute').value;
            const hour = document.getElementById('editHour').value;
            const dayOfWeek = document.getElementById('editDayOfWeek').value;
            const startTime = document.getElementById('editStartTime').value;
            const endTime = document.getElementById('editEndTime').value;

            const daysOfWeekJp = ['æ—¥æ›œæ—¥', 'æœˆæ›œæ—¥', 'ç«æ›œæ—¥', 'æ°´æ›œæ—¥', 'æœ¨æ›œæ—¥', 'é‡‘æ›œæ—¥', 'åœŸæ›œæ—¥'];

            let description = 'å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°: ';
            if (dayOfWeek !== '*') {
                description += `æ¯é€±${daysOfWeekJp[dayOfWeek]}ã® `;
            } else {
                description += 'æ¯æ—¥ ';
            }
            description += `${hour}:${String(minute).padStart(2, '0')}`;

            document.getElementById('cronPreview').textContent = description;

            // cronã‚³ãƒãƒ³ãƒ‰ã‚’å†æ§‹ç¯‰
            if (currentEditingCron.jobData) {
                const scriptPath = document.getElementById('scriptPath').value;
                const title = document.getElementById('editProgramTitle').value || '';
                const station = currentEditingCron.jobData.station || '';

                // æ™‚åˆ»ã‚’HHMMå½¢å¼ã«å¤‰æ›
                const startHHMM = startTime ? startTime.replace(':', '') : '';
                const endHHMM = endTime ? endTime.replace(':', '') : '';

                // éŒ²éŸ³é–‹å§‹æ™‚åˆ»ã¨cronå®Ÿè¡Œæ™‚åˆ»ã‚’æ¯”è¼ƒ
                // cronå®Ÿè¡Œæ™‚åˆ»ãŒéŒ²éŸ³é–‹å§‹æ™‚åˆ»ã‚ˆã‚Šæ—©ã„å ´åˆã€æ—¥ã‚’ã¾ãŸã„ã§ã„ã‚‹
                const startHour = startTime ? parseInt(startTime.split(':')[0]) : 0;
                const startMin = startTime ? parseInt(startTime.split(':')[1]) : 0;
                const cronExecHour = parseInt(hour);
                const cronExecMin = parseInt(minute);

                // æ™‚åˆ»ã‚’åˆ†å˜ä½ã«å¤‰æ›ã—ã¦æ¯”è¼ƒ
                const startMinutes = startHour * 60 + startMin;
                const cronExecMinutes = cronExecHour * 60 + cronExecMin;
                const needsYesterday = cronExecMinutes < startMinutes;

                // æ—¥ä»˜è¨ˆç®—ã®éƒ¨åˆ†
                let startDateCalc = '';
                if (needsYesterday) {
                    // cronå®Ÿè¡Œæ—¥ã®å‰æ—¥ã‚’éŒ²éŸ³é–‹å§‹æ—¥ã¨ã™ã‚‹
                    startDateCalc = '\`date -d yesterday +\\%Y\\%m\\%d\`';
                } else {
                    // cronå®Ÿè¡Œæ—¥ã¨åŒã˜æ—¥ã‚’éŒ²éŸ³é–‹å§‹æ—¥ã¨ã™ã‚‹
                    startDateCalc = '\`date +\\%Y\\%m\\%d\`';
                }

                const endDateCalc = '\`date +\\%Y\\%m\\%d\`';

                // ãƒ•ã‚©ãƒ«ãƒ€IDã‚’å–å¾—
                const folderSelect = document.getElementById('editCronFolder');
                const folderId = folderSelect ? folderSelect.value : '';

                // cronã‚³ãƒãƒ³ãƒ‰ã‚’ç”Ÿæˆï¼ˆç¬¬7å¼•æ•°ã«ãƒ•ã‚©ãƒ«ãƒ€IDï¼‰
                const fullCommand = `${minute} ${hour} * * ${dayOfWeek} ${scriptPath} "${title}" "${station}" "${station}" "${startDateCalc}${startHHMM}" "${endDateCalc}${endHHMM}" "" "${folderId}" "" >> /tmp/myradiko_output.log 2>&1`;
                document.getElementById('editCommandPreview').value = fullCommand;
            }
        }

        // cronç·¨é›†ã‚’ä¿å­˜
        async function saveCronEdit() {
            // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‹ã‚‰ç›´æ¥ã‚³ãƒãƒ³ãƒ‰ã‚’å–å¾—
            const newCronLine = document.getElementById('editCommandPreview').value.trim();

            if (!newCronLine) {
                alert('ã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // å¤ã„cronã‚’å‰Šé™¤ã—ã¦æ–°ã—ã„cronã‚’è¿½åŠ 
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            // ç·¨é›†ä¸­ã®ã‚¸ãƒ§ãƒ–IDã‚’å–å¾—
            const jobId = currentEditingCron.jobData?.id;
            if (!jobId) {
                alert('âŒ ã‚¨ãƒ©ãƒ¼: ã‚¸ãƒ§ãƒ–IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            try {
                // å‰Šé™¤ï¼ˆIDãƒ™ãƒ¼ã‚¹ï¼‰
                const removeResponse = await fetch(`${baseUrl}/cron/remove`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id: jobId })
                });

                if (!removeResponse.ok) {
                    const removeData = await removeResponse.json();
                    throw new Error('å‰Šé™¤ã«å¤±æ•—: ' + (removeData.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                }

                // è¿½åŠ 
                const response = await fetch(`${baseUrl}/cron/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ command: newCronLine })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('âœ… äºˆç´„ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                    closeCronEditModal();
                    loadCronJobs();
                } else {
                    alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + (data.error || 'äºˆç´„ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ'));
                }
            } catch (err) {
                console.error('Error updating cron job:', err);
                alert('âŒ äºˆç´„ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // cronç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeCronEditModal() {
            document.getElementById('cronEditModal').classList.remove('active');
        }

        // cronãƒ­ã‚°ã‚’èª­ã¿è¾¼ã‚€
        async function loadCronLogs() {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';
            const logContent = document.getElementById('cronLogContent');

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
            document.getElementById('cronLogModal').classList.add('active');
            logContent.innerHTML = '<div style="text-align: center; color: #888;">èª­ã¿è¾¼ã¿ä¸­...</div>';

            try {
                const response = await fetch(`${baseUrl}/cron/logs`);
                if (!response.ok) {
                    logContent.innerHTML = '<div style="color: #ff6b6b;">ãƒ­ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
                    return;
                }

                const data = await response.json();
                const logs = data.logs || [];

                if (logs.length === 0) {
                    logContent.innerHTML = '<div style="color: #888;">ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                    return;
                }

                // ãƒ­ã‚°ã‚’æ•´å½¢ã—ã¦è¡¨ç¤º
                let html = '';
                logs.forEach(log => {
                    // ã‚¨ãƒ©ãƒ¼ã‚„è­¦å‘Šã‚’è‰²åˆ†ã‘
                    let color = '#d4d4d4';
                    if (log.toLowerCase().includes('error') || log.toLowerCase().includes('failed')) {
                        color = '#ff6b6b';
                    } else if (log.toLowerCase().includes('warn')) {
                        color = '#ffd43b';
                    } else if (log.toLowerCase().includes('success')) {
                        color = '#51cf66';
                    }

                    html += `<div style="color: ${color}; margin-bottom: 4px;">${escapeHtml(log)}</div>`;
                });

                logContent.innerHTML = html;
                // æœ€ä¸‹éƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                logContent.scrollTop = logContent.scrollHeight;

            } catch (err) {
                console.error('Error loading cron logs:', err);
                logContent.innerHTML = '<div style="color: #ff6b6b;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
            }
        }

        // cronãƒ­ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeCronLogModal() {
            document.getElementById('cronLogModal').classList.remove('active');
        }

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // æ™‚åˆ»ã®å…¥åŠ›ãŒå¤‰ã‚ã£ãŸã‚‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
        document.addEventListener('DOMContentLoaded', function() {
            const editInputs = ['editProgramTitle', 'editMinute', 'editHour', 'editDayOfWeek', 'editStartTime', 'editEndTime'];
            editInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', updateCronPreview);
                    element.addEventListener('change', updateCronPreview);
                }
            });
        });

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ãªã„ã‚ˆã†ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
        // document.getElementById('modal').addEventListener('click', function(e) {
        //     if (e.target === this) {
        //         closeModal();
        //     }
        // });

        // document.getElementById('cronEditModal').addEventListener('click', function(e) {
        //     if (e.target === this) {
        //         closeCronEditModal();
        //     }
        // });

        // document.getElementById('cronLogModal').addEventListener('click', function(e) {
        //     if (e.target === this) {
        //         closeCronLogModal();
        //     }
        // });

        // atäºˆç´„ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
        async function loadAtJobs() {
            const atLoading = document.getElementById('atLoading');
            const atList = document.getElementById('atList');

            atLoading.style.display = 'block';
            atList.innerHTML = '';

            try {
                const proxyUrl = document.getElementById('proxyUrl').value;
                const baseUrl = proxyUrl.trim() || '';

                const response = await fetch(`${baseUrl}/at/list`);
                const data = await response.json();

                atLoading.style.display = 'none';

                if (!data.jobs || data.jobs.length === 0) {
                    atList.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d; font-size: 0.95em;">atäºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                    return;
                }

                // å„ã‚¸ãƒ§ãƒ–ã®è©³ç´°ã‚’å–å¾—ã—ã¦ç•ªçµ„åã‚’è¡¨ç¤º
                const jobsWithDetails = await Promise.all(data.jobs.map(async (job) => {
                    try {
                        const detailResponse = await fetch(`${baseUrl}/at/detail/${job.id}`);
                        const detailData = await detailResponse.json();

                        // ã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰ç•ªçµ„æƒ…å ±ã‚’æŠ½å‡º
                        let programTitle = 'Unknown';
                        let stationId = '';
                        let startTime = '';
                        let endTime = '';

                        if (detailData.command) {
                            // myradiko "ç•ªçµ„å" "å±€ID" "å±€ID" "é–‹å§‹æ™‚åˆ»" "çµ‚äº†æ™‚åˆ»" ... ã®å½¢å¼ã‹ã‚‰æŠ½å‡º
                            const match = detailData.command.match(/myradiko\s+"([^"]+)"\s+"([^"]+)"\s+"([^"]+)"\s+"(\d+)"\s+"(\d+)"/);
                            if (match) {
                                programTitle = match[1];
                                stationId = match[2];
                                const startStr = match[4]; // YYYYMMDDHHmm
                                const endStr = match[5];

                                // æ™‚åˆ»ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                                if (startStr.length === 12) {
                                    const year = startStr.substring(0, 4);
                                    const month = startStr.substring(4, 6);
                                    const day = startStr.substring(6, 8);
                                    const hour = startStr.substring(8, 10);
                                    const minute = startStr.substring(10, 12);
                                    startTime = `${year}/${month}/${day} ${hour}:${minute}`;
                                }
                                if (endStr.length === 12) {
                                    const hour = endStr.substring(8, 10);
                                    const minute = endStr.substring(10, 12);
                                    endTime = `${hour}:${minute}`;
                                }
                            }
                        }

                        return { ...job, title: programTitle, station: stationId, startTime, endTime };
                    } catch (err) {
                        console.error(`Failed to get detail for job ${job.id}:`, err);
                        return { ...job, title: 'Unknown', station: '', startTime: '', endTime: '' };
                    }
                }));

                let html = '<div style="display: grid; gap: 15px;">';

                jobsWithDetails.forEach(job => {
                    // å®Ÿè¡Œæ™‚åˆ»ã‚’æ•´å½¢ï¼ˆä¾‹: "2025/Oct/27 Mon 23:05:00" â†’ "2025/10/27 (æœˆ) 23:05"ï¼‰
                    let formattedDatetime = job.datetime;
                    try {
                        // atã‚³ãƒãƒ³ãƒ‰ã®æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: "2025/Oct/27 Mon 23:05:00"
                        const match = job.datetime.match(/(\d{4})\/(\w+)\/(\d+)\s+(\w+)\s+(\d+):(\d+):\d+/);

                        if (match) {
                            const year = match[1];
                            const monthName = match[2];
                            const day = match[3].padStart(2, '0');
                            const weekdayEng = match[4];
                            const hour = match[5].padStart(2, '0');
                            const minute = match[6].padStart(2, '0');

                            // æœˆåã‚’æ•°å­—ã«å¤‰æ›
                            const months = {
                                'Jan': '01', 'Feb': '02', 'Mar': '03', 'Apr': '04',
                                'May': '05', 'Jun': '06', 'Jul': '07', 'Aug': '08',
                                'Sep': '09', 'Oct': '10', 'Nov': '11', 'Dec': '12'
                            };
                            const month = months[monthName] || monthName;

                            // æ›œæ—¥ã‚’æ—¥æœ¬èªã«å¤‰æ›
                            const weekdays = {
                                'Sun': 'æ—¥', 'Mon': 'æœˆ', 'Tue': 'ç«', 'Wed': 'æ°´',
                                'Thu': 'æœ¨', 'Fri': 'é‡‘', 'Sat': 'åœŸ'
                            };
                            const weekday = weekdays[weekdayEng] || weekdayEng;

                            formattedDatetime = `${year}/${month}/${day} (${weekday}) ${hour}:${minute}`;
                        }
                    } catch (e) {
                        // ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ãŸå ´åˆã¯å…ƒã®æ–‡å­—åˆ—ã‚’ä½¿ç”¨
                        console.error('æ—¥æ™‚ã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—:', job.datetime, e);
                    }

                    const isMobile = window.innerWidth <= 768;

                    if (isMobile) {
                        // ã‚¹ãƒãƒ›ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
                        html += `
                            <div style="border: 1px solid #dee2e6; border-radius: 8px; padding: 12px; background: white;">
                                <div style="font-weight: 600; color: #212529; margin-bottom: 8px; font-size: 1em; line-height: 1.4;">
                                    ${job.title}
                                </div>
                                ${job.station ? `
                                    <div style="color: #495057; font-size: 0.85em; margin-bottom: 4px; display: flex; align-items: center; gap: 4px;">
                                        <span>ğŸ“»</span>
                                        <span>${job.station}</span>
                                    </div>
                                ` : ''}
                                ${job.startTime && job.endTime ? `
                                    <div style="color: #495057; font-size: 0.85em; margin-bottom: 4px; display: flex; align-items: center; gap: 4px;">
                                        <span>ğŸ•’</span>
                                        <span>${job.startTime} - ${job.endTime}</span>
                                    </div>
                                ` : ''}
                                <div style="color: #6c757d; font-size: 0.8em; margin-bottom: 4px;">
                                    â±ï¸ å®Ÿè¡Œäºˆå®š: ${formattedDatetime}
                                </div>
                                <div style="color: #999; font-size: 0.75em; margin-bottom: 10px;">
                                    Job #${job.id}
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                    <button onclick='editAtJob("${job.id}")'
                                            class="btn btn-secondary"
                                            style="padding: 8px 12px; font-size: 0.85em; white-space: nowrap;">
                                        âœï¸ ç·¨é›†
                                    </button>
                                    <button onclick='cancelAtJob("${job.id}")'
                                            style="padding: 8px 12px; background: #e74c3c; color: white; border: none; border-radius: 6px; font-size: 0.85em; font-weight: 600; cursor: pointer; white-space: nowrap;">
                                        âœ• ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                                    </button>
                                </div>
                            </div>
                        `;
                    } else {
                        // PCãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆå¾“æ¥é€šã‚Šï¼‰
                        html += `
                            <div style="border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; background: white;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #212529; margin-bottom: 8px; font-size: 1.05em;">
                                            ${job.title}
                                        </div>
                                        ${job.station ? `<div style="color: #495057; font-size: 0.9em; margin-bottom: 5px;">ğŸ“» ${job.station}</div>` : ''}
                                        ${job.startTime && job.endTime ? `<div style="color: #495057; font-size: 0.9em; margin-bottom: 5px;">ğŸ•’ ${job.startTime} - ${job.endTime}</div>` : ''}
                                        <div style="color: #6c757d; font-size: 0.85em; margin-bottom: 3px;">
                                            â±ï¸ Job #${job.id}
                                        </div>
                                        <div style="color: #6c757d; font-size: 0.85em;">
                                            å®Ÿè¡Œäºˆå®š: ${formattedDatetime}
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick='editAtJob("${job.id}")'
                                                style="padding: 8px 14px; background: #3498db; color: white; border: none; border-radius: 6px; font-size: 0.85em; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);"
                                                onmouseover="this.style.background='#2980b9'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 3px 6px rgba(0, 0, 0, 0.15)'"
                                                onmouseout="this.style.background='#3498db'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0, 0, 0, 0.1)'"
                                                title="ç·¨é›†">
                                            âœï¸ ç·¨é›†
                                        </button>
                                        <button onclick='cancelAtJob("${job.id}")'
                                                style="padding: 8px 14px; background: #e74c3c; color: white; border: none; border-radius: 6px; font-size: 0.85em; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);"
                                                onmouseover="this.style.background='#c0392b'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 3px 6px rgba(0, 0, 0, 0.15)'"
                                                onmouseout="this.style.background='#e74c3c'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0, 0, 0, 0.1)'"
                                                title="ã‚­ãƒ£ãƒ³ã‚»ãƒ«">
                                            âœ• ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });

                html += '</div>';
                atList.innerHTML = html;

            } catch (err) {
                console.error('Error loading at jobs:', err);
                atLoading.style.display = 'none';
                atList.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 40px; font-size: 0.95em;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
            }
        }

        // atäºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        async function cancelAtJob(jobId) {
            if (!confirm(`atäºˆç´„ #${jobId} ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }

            try {
                const proxyUrl = document.getElementById('proxyUrl').value;
                const baseUrl = proxyUrl.trim() || '';

                const response = await fetch(`${baseUrl}/at/cancel/${jobId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok) {
                    alert(`âœ… ${data.message}`);
                    loadAtJobs(); // ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                } else {
                    alert(`âŒ ${data.error || 'Unknown error'}`);
                }
            } catch (err) {
                console.error('Error cancelling at job:', err);
                alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${err.message}`);
            }
        }

        // atäºˆç´„ã‚’ç·¨é›†
        async function editAtJob(jobId) {
            try {
                const proxyUrl = document.getElementById('proxyUrl').value;
                const baseUrl = proxyUrl.trim() || '';

                // atäºˆç´„ã®è©³ç´°ã‚’å–å¾—
                const response = await fetch(`${baseUrl}/at/detail/${jobId}`);
                const data = await response.json();

                if (!response.ok) {
                    alert(`ã‚¨ãƒ©ãƒ¼: ${data.error || 'Unknown error'}`);
                    return;
                }

                const command = data.command || '';
                const executeTime = data.time || ''; // atå®Ÿè¡Œæ™‚åˆ»

                console.log('å–å¾—ã—ãŸã‚³ãƒãƒ³ãƒ‰:', command);
                console.log('å®Ÿè¡Œæ™‚åˆ»:', executeTime);

                // ã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰æƒ…å ±ã‚’æŠ½å‡º
                // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: myradiko "ç•ªçµ„å" "å±€ID" "å±€ID" "é–‹å§‹æ™‚åˆ»" "çµ‚äº†æ™‚åˆ»" "" "" "" >> /tmp/...
                const match = command.match(/myradiko\s+"([^"]+)"\s+"([^"]+)"\s+"([^"]+)"\s+"(\d+)"\s+"(\d+)"/);

                if (!match) {
                    console.error('ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ãŸã‚³ãƒãƒ³ãƒ‰:', command);
                    alert('âŒ ã‚³ãƒãƒ³ãƒ‰ã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ\n\nã‚³ãƒãƒ³ãƒ‰å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\nã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è©³ç´°ã‚’å‡ºåŠ›ã—ã¾ã—ãŸã€‚');
                    return;
                }

                const title = match[1];
                const stationId = match[2];
                const startTimeStr = match[4]; // YYYYMMDDHHmm
                const endTimeStr = match[5];   // YYYYMMDDHHmm

                // éŒ²éŸ³é–‹å§‹æ™‚åˆ»ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                const startYear = startTimeStr.substring(0, 4);
                const startMonth = startTimeStr.substring(4, 6);
                const startDay = startTimeStr.substring(6, 8);
                const startHour = startTimeStr.substring(8, 10);
                const startMinute = startTimeStr.substring(10, 12);
                const startDatetime = `${startYear}-${startMonth}-${startDay}T${startHour}:${startMinute}`;

                // éŒ²éŸ³çµ‚äº†æ™‚åˆ»ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                const endYear = endTimeStr.substring(0, 4);
                const endMonth = endTimeStr.substring(4, 6);
                const endDay = endTimeStr.substring(6, 8);
                const endHour = endTimeStr.substring(8, 10);
                const endMinute = endTimeStr.substring(10, 12);
                const endDatetime = `${endYear}-${endMonth}-${endDay}T${endHour}:${endMinute}`;

                // ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚åˆ»ã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆä¾‹: "Fri Oct 27 23:50:00 2025"ï¼‰
                let executeDatetime = '';
                if (executeTime) {
                    try {
                        const execDate = new Date(executeTime);
                        const execYear = execDate.getFullYear();
                        const execMonth = String(execDate.getMonth() + 1).padStart(2, '0');
                        const execDay = String(execDate.getDate()).padStart(2, '0');
                        const execHour = String(execDate.getHours()).padStart(2, '0');
                        const execMinute = String(execDate.getMinutes()).padStart(2, '0');
                        executeDatetime = `${execYear}-${execMonth}-${execDay}T${execHour}:${execMinute}`;
                    } catch (e) {
                        console.error('å®Ÿè¡Œæ™‚åˆ»ã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—:', e);
                    }
                }

                // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
                document.getElementById('editAtJobId').value = jobId;
                document.getElementById('editAtTitle').value = title;
                document.getElementById('editAtExecuteTime').value = executeDatetime;
                document.getElementById('editAtStartTime').value = startDatetime;
                document.getElementById('editAtEndTime').value = endDatetime;

                // æ”¾é€å±€IDã‹ã‚‰é©åˆ‡ãªã‚¨ãƒªã‚¢ã‚’æ¤œå‡º
                const detectedArea = await detectAreaFromStation(stationId);
                if (detectedArea) {
                    document.getElementById('editAtArea').value = detectedArea;
                } else {
                    // æ¤œå‡ºã§ããªã„å ´åˆã¯æ±äº¬éƒ½ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                    document.getElementById('editAtArea').value = 'JP13';
                }

                // æ”¾é€å±€ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚“ã§ã‹ã‚‰æ”¾é€å±€ã‚’è¨­å®š
                await updateEditAtStations();
                document.getElementById('editAtStation').value = stationId;

                // ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
                await loadFoldersForAtEdit();

                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                document.getElementById('atEditModal').style.display = 'flex';

            } catch (err) {
                console.error('Error loading at job for edit:', err);
                alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${err.message}`);
            }
        }

        // atäºˆç´„ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeAtEditModal() {
            document.getElementById('atEditModal').style.display = 'none';
        }

        // atäºˆç´„ç·¨é›†ï¼šãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
        async function loadFoldersForAtEdit() {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';
            const folderSelect = document.getElementById('editAtFolder');

            try {
                const response = await fetch(`${baseUrl}/folders`);
                const data = await response.json();

                if (response.ok && data.folders) {
                    folderSelect.innerHTML = '<option value="">ğŸ“ ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ«ãƒ€ï¼ˆãƒ•ã‚©ãƒ«ãƒ€æŒ‡å®šãªã—ï¼‰</option>';
                    data.folders.forEach(folder => {
                        const icon = folder.icon || 'ğŸ“';
                        const option = document.createElement('option');
                        option.value = folder.id;
                        option.textContent = `${icon} ${folder.name}`;
                        if (folder.color) {
                            option.style.color = folder.color;
                        }
                        folderSelect.appendChild(option);
                    });
                }
            } catch (err) {
                console.error('Error loading folders:', err);
            }
        }

        // cronç·¨é›†ï¼šãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
        async function loadFoldersForCronEdit() {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';
            const folderSelect = document.getElementById('editCronFolder');

            try {
                const response = await fetch(`${baseUrl}/folders`);
                const data = await response.json();

                if (response.ok && data.folders) {
                    folderSelect.innerHTML = '<option value="">ğŸ“ ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ«ãƒ€ï¼ˆãƒ•ã‚©ãƒ«ãƒ€æŒ‡å®šãªã—ï¼‰</option>';
                    data.folders.forEach(folder => {
                        const icon = folder.icon || 'ğŸ“';
                        const option = document.createElement('option');
                        option.value = folder.id;
                        option.textContent = `${icon} ${folder.name}`;
                        if (folder.color) {
                            option.style.color = folder.color;
                        }
                        folderSelect.appendChild(option);
                    });
                }
            } catch (err) {
                console.error('Error loading folders:', err);
            }
        }

        // atäºˆç´„ç·¨é›†ï¼šã‚¨ãƒªã‚¢å¤‰æ›´æ™‚ã«æ”¾é€å±€ä¸€è¦§ã‚’æ›´æ–°
        // æ”¾é€å±€IDã‹ã‚‰ã‚¨ãƒªã‚¢ã‚’æ¤œå‡ºã™ã‚‹é–¢æ•°
        async function detectAreaFromStation(stationId) {
            try {
                const proxyUrl = document.getElementById('proxyUrl').value;
                const baseUrl = proxyUrl.trim() || '';

                // å…¨ã‚¨ãƒªã‚¢ãƒªã‚¹ãƒˆ
                const allAreas = [
                    'JP1', 'JP2', 'JP3', 'JP4', 'JP5', 'JP6', 'JP7', 'JP8', 'JP9', 'JP10',
                    'JP11', 'JP12', 'JP13', 'JP14', 'JP15', 'JP16', 'JP17', 'JP18', 'JP19', 'JP20',
                    'JP21', 'JP22', 'JP23', 'JP24', 'JP25', 'JP26', 'JP27', 'JP28', 'JP29', 'JP30',
                    'JP31', 'JP32', 'JP33', 'JP34', 'JP35', 'JP36', 'JP37', 'JP38', 'JP39', 'JP40',
                    'JP41', 'JP42', 'JP43', 'JP44', 'JP45', 'JP46', 'JP47'
                ];

                const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');

                // å„ªå…ˆçš„ã«ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‚¨ãƒªã‚¢ï¼ˆæ±äº¬ã€å¤§é˜ªãªã©ï¼‰
                const priorityAreas = ['JP13', 'JP27', 'JP14', 'JP28', 'JP40', 'JP1'];

                // å„ªå…ˆã‚¨ãƒªã‚¢ã‹ã‚‰æ¤œç´¢
                for (const areaId of priorityAreas) {
                    const response = await fetch(`${baseUrl}/api/programs/area/${areaId}/date/${today}`);
                    const data = await response.json();

                    if (data.programs) {
                        const found = data.programs.find(prog => prog.stationId === stationId);
                        if (found) {
                            return areaId;
                        }
                    }
                }

                // è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°å…¨ã‚¨ãƒªã‚¢ã‚’æ¤œç´¢ï¼ˆå„ªå…ˆã‚¨ãƒªã‚¢ã‚’é™¤ãï¼‰
                for (const areaId of allAreas) {
                    if (priorityAreas.includes(areaId)) continue;

                    const response = await fetch(`${baseUrl}/api/programs/area/${areaId}/date/${today}`);
                    const data = await response.json();

                    if (data.programs) {
                        const found = data.programs.find(prog => prog.stationId === stationId);
                        if (found) {
                            return areaId;
                        }
                    }
                }

                return null; // è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸ
            } catch (err) {
                console.error('Error detecting area:', err);
                return null;
            }
        }

        async function updateEditAtStations() {
            const areaId = document.getElementById('editAtArea').value;
            const stationSelect = document.getElementById('editAtStation');

            if (!areaId) {
                stationSelect.innerHTML = '<option value="">ã¾ãšã‚¨ãƒªã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
                return;
            }

            stationSelect.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ä¸­...</option>';

            try {
                const proxyUrl = document.getElementById('proxyUrl').value;
                const baseUrl = proxyUrl.trim() || '';
                const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');

                const response = await fetch(`${baseUrl}/api/programs/area/${areaId}/date/${today}`);
                const data = await response.json();

                if (!response.ok || !data.programs) {
                    stationSelect.innerHTML = '<option value="">ã‚¨ãƒ©ãƒ¼: æ”¾é€å±€ã‚’å–å¾—ã§ãã¾ã›ã‚“</option>';
                    return;
                }

                // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªæ”¾é€å±€ã‚’æŠ½å‡º
                const stations = {};
                data.programs.forEach(prog => {
                    if (prog.stationId && prog.stationName) {
                        stations[prog.stationId] = prog.stationName;
                    }
                });

                stationSelect.innerHTML = '<option value="">æ”¾é€å±€ã‚’é¸æŠ</option>';
                Object.keys(stations).sort().forEach(stationId => {
                    const option = document.createElement('option');
                    option.value = stationId;
                    option.textContent = `${stationId} - ${stations[stationId]}`;
                    stationSelect.appendChild(option);
                });

            } catch (err) {
                console.error('Error loading stations:', err);
                stationSelect.innerHTML = '<option value="">ã‚¨ãƒ©ãƒ¼: æ”¾é€å±€ã‚’å–å¾—ã§ãã¾ã›ã‚“</option>';
            }
        }

        // ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚åˆ»ã‚’ã€ŒéŒ²éŸ³çµ‚äº†+5åˆ†ã€ã«è¨­å®š
        function setExecuteTimeToEndPlus5() {
            const endDatetime = document.getElementById('editAtEndTime').value;

            if (!endDatetime) {
                alert('å…ˆã«éŒ²éŸ³çµ‚äº†æ—¥æ™‚ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const endDate = new Date(endDatetime);
            endDate.setMinutes(endDate.getMinutes() + 5);

            const year = endDate.getFullYear();
            const month = String(endDate.getMonth() + 1).padStart(2, '0');
            const day = String(endDate.getDate()).padStart(2, '0');
            const hour = String(endDate.getHours()).padStart(2, '0');
            const minute = String(endDate.getMinutes()).padStart(2, '0');

            document.getElementById('editAtExecuteTime').value = `${year}-${month}-${day}T${hour}:${minute}`;
        }

        // atäºˆç´„ã®ç·¨é›†ã‚’ä¿å­˜
        async function saveAtEdit() {
            const jobId = document.getElementById('editAtJobId').value;
            const title = document.getElementById('editAtTitle').value.trim();
            const stationId = document.getElementById('editAtStation').value;
            const executeTime = document.getElementById('editAtExecuteTime').value;
            const startDatetime = document.getElementById('editAtStartTime').value;
            const endDatetime = document.getElementById('editAtEndTime').value;

            if (!title || !stationId || !executeTime || !startDatetime || !endDatetime) {
                alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (!confirm('æ—¢å­˜ã®atäºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦ã€æ–°ã—ã„å†…å®¹ã§å†ç™»éŒ²ã—ã¾ã™ã€‚\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                return;
            }

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                // 1. æ—¢å­˜ã®atäºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                const cancelResponse = await fetch(`${baseUrl}/at/cancel/${jobId}`, {
                    method: 'DELETE'
                });

                if (!cancelResponse.ok) {
                    const cancelData = await cancelResponse.json();
                    throw new Error(`ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¤±æ•—: ${cancelData.error || 'Unknown error'}`);
                }

                // 2. æ–°ã—ã„å†…å®¹ã§å†ç™»éŒ²
                // éŒ²éŸ³é–‹å§‹ãƒ»çµ‚äº†æ™‚åˆ»ã‚’YYYYMMDDHHmmå½¢å¼ã«å¤‰æ›
                const startDate = new Date(startDatetime);
                const startStr = `${startDate.getFullYear()}${String(startDate.getMonth() + 1).padStart(2, '0')}${String(startDate.getDate()).padStart(2, '0')}${String(startDate.getHours()).padStart(2, '0')}${String(startDate.getMinutes()).padStart(2, '0')}`;

                const endDate = new Date(endDatetime);
                const endStr = `${endDate.getFullYear()}${String(endDate.getMonth() + 1).padStart(2, '0')}${String(endDate.getDate()).padStart(2, '0')}${String(endDate.getHours()).padStart(2, '0')}${String(endDate.getMinutes()).padStart(2, '0')}`;

                // å®Ÿè¡Œæ™‚åˆ»ã‚’atå½¢å¼ã«å¤‰æ›ï¼ˆHH:MM YYYY-MM-DDï¼‰
                const execDate = new Date(executeTime);
                const atTime = `${String(execDate.getHours()).padStart(2, '0')}:${String(execDate.getMinutes()).padStart(2, '0')} ${execDate.getFullYear()}-${String(execDate.getMonth() + 1).padStart(2, '0')}-${String(execDate.getDate()).padStart(2, '0')}`;

                // ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ‘ã‚¹ã‚’å–å¾—
                const scriptPath = document.getElementById('scriptPath').value;

                const scheduleResponse = await fetch(`${baseUrl}/schedule-at`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        script_path: scriptPath,
                        title: title,
                        station_id: stationId,
                        at_time: atTime,  // æ­£ã—ã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å
                        start_time: startStr,
                        end_time: endStr
                    })
                });

                const scheduleData = await scheduleResponse.json();

                if (scheduleResponse.ok) {
                    alert(`âœ… atäºˆç´„ã‚’æ›´æ–°ã—ã¾ã—ãŸ\n\nå®Ÿè¡Œæ™‚åˆ»: ${executeTime.replace('T', ' ')}\néŒ²éŸ³é–‹å§‹: ${startDatetime.replace('T', ' ')}\néŒ²éŸ³çµ‚äº†: ${endDatetime.replace('T', ' ')}`);
                    closeAtEditModal();
                    loadAtJobs(); // ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                } else {
                    alert(`âŒ å†ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ\n\n${scheduleData.error || 'Unknown error'}\n\nâ€»æ—¢å­˜ã®äºˆç´„ã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¦ã„ã¾ã™`);
                }

            } catch (err) {
                console.error('Error saving at job edit:', err);
                alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${err.message}`);
            }
        }

        // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†ç”Ÿ
        // ç¾åœ¨å†ç”Ÿä¸­ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ï¼ˆãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ç”¨ï¼‰
        let currentAudioFilePath = '';
        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®å‚ç…§ï¼ˆå‰Šé™¤ç”¨ï¼‰
        let audioKeyboardListener = null;
        // ç¾åœ¨è¡¨ç¤ºä¸­ã®ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ï¼ˆprogram_infoä»˜ãï¼‰
        let currentDisplayedFiles = [];

        // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†ç”Ÿ
        function playAudioByIndex(index) {
            const file = currentDisplayedFiles[index];
            if (file) {
                playAudio(file.path, file.name, file);
            }
        }

        async function playAudio(filepath, filename, fileData = null) {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            // ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ä¿å­˜
            currentAudioFilePath = filepath;

            // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚½ãƒ¼ã‚¹ã‚’è¨­å®š
            const audioPlayer = document.getElementById('audioPlayer');
            const audioSource = document.getElementById('audioSource');

            // æ—¢å­˜ã®å†ç”Ÿã‚’åœæ­¢ã—ã¦ãƒªã‚»ãƒƒãƒˆï¼ˆé‡è¦ï¼ï¼‰
            audioPlayer.pause();
            audioPlayer.currentTime = 0;

            const streamUrl = `${baseUrl}/stream/${filepath}`;

            // ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¡¨ç¤º
            document.getElementById('audioPlayerTitle').textContent = filename;

            // ç•ªçµ„ã‚¿ã‚¤ãƒˆãƒ«ã‚’æŠ½å‡º
            const programTitle = extractProgramTitle(filename);

            // UIã«ã¾ãšãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”»åƒã‚’è¨­å®šï¼ˆå³åº§ã«è¡¨ç¤ºï¼‰
            const artworkImg = document.querySelector('#audioPlayerModal img[alt="Artwork"]');
            if (artworkImg) {
                artworkImg.src = 'img/jacket.png';
            }

            // ã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯URLã‚’ç”Ÿæˆï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒå¿…ãšç”»åƒã‚’è¿”ã™ï¼‰
            const artworkUrl = `${baseUrl}/artwork/${encodeURIComponent(programTitle)}`;
            console.log('ğŸ–¼ï¸ [Artwork] Using backend URL:', artworkUrl);

            // UIã«ã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ã‚’è¨­å®šï¼ˆéåŒæœŸã§èª­ã¿è¾¼ã¾ã‚Œã‚‹ï¼‰
            if (artworkImg) {
                artworkImg.src = artworkUrl;
            }

            // å…ˆã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºï¼ˆUIã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ï¼‰
            document.getElementById('audioPlayerModal').classList.add('active');
            document.body.classList.add('modal-open');

            // fileDataã®ä¸­èº«ã‚’ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
            console.log('ğŸ“¦ [FileData] Full object:', fileData);
            console.log('ğŸ“¦ [FileData] program_info:', fileData?.program_info);

            // å‡ºæ¼”è€…æƒ…å ±ã‚’å–å¾—ï¼ˆç•ªçµ„è¡¨ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ï¼‰
            const performer = fileData?.program_info?.program_performer || fileData?.program_performer || null;
            console.log('ğŸ¤ [Performer] Found:', performer);

            // ç•ªçµ„æƒ…å ±ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
            const stationName = fileData?.station_name || 'radikoéŒ²éŸ³';

            // start_timeã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: YYYYMMDDHHmmss â†’ YYYY/MM/DD
            let formattedDate = 'ãƒ©ã‚¸ã‚ªéŒ²éŸ³';
            if (fileData?.start_time) {
                const st = fileData.start_time;
                // YYYYMMDDã®å½¢å¼ã‹ã‚‰ YYYY/MM/DD ã«å¤‰æ›
                if (st.length >= 8) {
                    formattedDate = `${st.substring(0, 4)}/${st.substring(4, 6)}/${st.substring(6, 8)}æ”¾é€`;
                }
            }

            // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®æ§‹æˆã‚’æ±ºå®š
            // performeræƒ…å ±ãŒã‚ã‚Œã°ä½¿ç”¨
            const artist = performer || stationName;
            const album = performer ? `${stationName} - ${formattedDate}` : formattedDate;

            console.log('ğŸµ [Media Session] Setting up...');
            console.log('ğŸ“ Title:', programTitle || filename);
            console.log('ğŸ¤ Artist:', artist);
            console.log('ğŸ’¿ Album:', album);

            // ã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯é…åˆ—ã‚’ä½œæˆï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰URLã‚’çµ¶å¯¾URLã«å¤‰æ›ï¼‰
            const fullArtworkUrl = artworkUrl.startsWith('http')
                ? artworkUrl
                : new URL(artworkUrl, window.location.href).href;

            console.log('ğŸ–¼ï¸ [Artwork] Full URL for Media Session:', fullArtworkUrl);

            const artworkArray = [{
                src: fullArtworkUrl,
                sizes: '512x512',
                type: 'image/png'
            }];

            // Media Session API ã§ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®šï¼ˆiOS Safariç­‰ã®ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å¯¾å¿œï¼‰
            // é‡è¦: å†ç”Ÿé–‹å§‹"å‰"ã«è¨­å®šã—ã€å†ç”Ÿä¸­ã¯å¤‰æ›´ã—ãªã„
            if ('mediaSession' in navigator) {
                try {
                    // ã¾ãšæ—¢å­˜ã®handlersã‚’ã‚¯ãƒªã‚¢ï¼ˆé‡è¤‡ç™»éŒ²ã‚’é˜²ãï¼‰
                    console.log('ğŸ§¹ [Media Session] Clearing old handlers before setting new ones...');
                    const actions = ['play', 'pause', 'seekbackward', 'seekforward', 'seekto', 'previoustrack', 'nexttrack'];
                    actions.forEach(action => {
                        try {
                            navigator.mediaSession.setActionHandler(action, null);
                        } catch (e) {
                            // ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„actionã¯ã‚¹ã‚­ãƒƒãƒ—
                        }
                    });

                    console.log('ğŸµ [Media Session] Creating MediaMetadata...');
                    console.log('ğŸ“‹ Metadata:', {
                        title: programTitle || filename,
                        artist: artist,
                        album: album,
                        artwork: artworkArray
                    });

                    const metadata = new MediaMetadata({
                        title: programTitle || filename,
                        artist: artist,
                        album: album,
                        artwork: artworkArray
                    });

                    console.log('ğŸµ [Media Session] Setting metadata...');
                    navigator.mediaSession.metadata = metadata;
                    console.log('âœ… [Media Session] Metadata set successfully');

                    // Media Session ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è¨­å®š
                    console.log('ğŸ® [Media Session] Setting action handlers...');
                    navigator.mediaSession.setActionHandler('play', () => {
                        console.log('ğŸ® [Action] play handler called');
                        audioPlayer.play();
                    });
                    navigator.mediaSession.setActionHandler('pause', () => {
                        console.log('ğŸ® [Action] pause handler called');
                        audioPlayer.pause();
                    });
                    navigator.mediaSession.setActionHandler('seekbackward', (details) => {
                        console.log('ğŸ® [Action] seekbackward handler called');
                        skipAudio(-10);
                    });
                    navigator.mediaSession.setActionHandler('seekforward', (details) => {
                        console.log('ğŸ® [Action] seekforward handler called');
                        skipAudio(10);
                    });
                    navigator.mediaSession.setActionHandler('seekto', (details) => {
                        console.log('ğŸ® [Action] seekto handler called:', details.seekTime);
                        if (details.seekTime) {
                            audioPlayer.currentTime = details.seekTime;
                        }
                    });

                    // æ¬¡/å‰ãƒˆãƒ©ãƒƒã‚¯ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆè¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«å†ç”Ÿæ™‚ï¼‰
                    navigator.mediaSession.setActionHandler('nexttrack', () => {
                        console.log('ğŸ® [Action] nexttrack handler called');
                        const currentIndex = currentDisplayedFiles.findIndex(f => f.path === currentAudioFilePath);
                        if (currentIndex >= 0 && currentIndex < currentDisplayedFiles.length - 1) {
                            playAudioByIndex(currentIndex + 1);
                        }
                    });
                    navigator.mediaSession.setActionHandler('previoustrack', () => {
                        console.log('ğŸ® [Action] previoustrack handler called');
                        const currentIndex = currentDisplayedFiles.findIndex(f => f.path === currentAudioFilePath);
                        if (currentIndex > 0) {
                            playAudioByIndex(currentIndex - 1);
                        }
                    });

                    // åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
                    navigator.mediaSession.playbackState = 'none';
                    console.log('âœ… [Media Session] All action handlers set successfully');
                } catch (err) {
                    console.error('âŒ [Media Session] Setup error:', err);
                    console.error('âŒ Error stack:', err.stack);
                }
            } else {
                console.warn('âš ï¸ [Media Session] API not available');
            }

            // ç¾åœ¨ã®éŸ³é‡ã‚’ä¿å­˜ï¼ˆsrcã‚’å¤‰æ›´ã™ã‚‹ã¨ãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹ãŸã‚ï¼‰
            const currentVolume = audioPlayer.volume;
            console.log('ğŸ”Š [Volume] Saving current volume before src change:', currentVolume);

            // ã‚½ãƒ¼ã‚¹ã‚’ç›´æ¥audioè¦ç´ ã«è¨­å®šï¼ˆsourceè¦ç´ ã¯ä½¿ã‚ãªã„ï¼‰
            console.log('ğŸµ [Audio] Setting source:', streamUrl);
            audioPlayer.src = streamUrl;

            // éŸ³é‡ã‚’å³åº§ã«å¾©å…ƒï¼ˆsrcãƒªã‚»ãƒƒãƒˆå¯¾ç­–ï¼‰
            audioPlayer.volume = currentVolume;
            console.log('ğŸ”Š [Volume] Restored volume after src change:', audioPlayer.volume);

            // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚’è¨­å®šï¼ˆå·¦å³çŸ¢å°ã‚­ãƒ¼ï¼‰
            // æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ãŒã‚ã‚Œã°å‰Šé™¤
            if (audioKeyboardListener) {
                document.removeEventListener('keydown', audioKeyboardListener);
            }

            // æ–°ã—ã„ãƒªã‚¹ãƒŠãƒ¼ã‚’ä½œæˆ
            audioKeyboardListener = function(event) {
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ã‚‹æ™‚ã®ã¿å‹•ä½œ
                const modal = document.getElementById('audioPlayerModal');
                if (!modal || !modal.classList.contains('active')) return;

                // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒã‚ã‚‹å ´åˆã¯å‹•ä½œã—ãªã„
                if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') return;

                if (event.key === 'ArrowLeft') {
                    event.preventDefault();
                    skipAudio(-10);
                } else if (event.key === 'ArrowRight') {
                    event.preventDefault();
                    skipAudio(10);
                }
            };

            // ãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            document.addEventListener('keydown', audioKeyboardListener);

            // ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ä½ç½®ã‚’äº‹å‰ã«è¨­å®šï¼ˆplay()ã‚’å‘¼ã¶å‰ã«å®Ÿè¡Œï¼‰
            const savedTime = localStorage.getItem(`bookmark_${currentAudioFilePath}`);
            if (savedTime) {
                const time = parseFloat(savedTime);
                console.log('ğŸ“– [Bookmark] Will restore position:', time);
                // currentTimeã¯play()ã®å¾Œã«è¨­å®šï¼ˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¾Œï¼‰
                audioPlayer.addEventListener('loadedmetadata', function restorePosition() {
                    console.log('ğŸ“– [Bookmark] Restoring position after metadata loaded:', time);
                    audioPlayer.currentTime = time;
                    audioPlayer.removeEventListener('loadedmetadata', restorePosition);
                }, { once: true });
            } else {
                console.log('ğŸ“– [Bookmark] No saved position, starting from beginning');
            }

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ãƒƒãƒ—ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå†…ã§ç›´æ¥play()ã‚’å‘¼ã¶ï¼ˆiOSãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å†ç”Ÿã®ãŸã‚é‡è¦ï¼‰
            console.log('â–¶ï¸ [Audio] Calling play() directly in user gesture context');
            audioPlayer.play().then(() => {
                console.log('âœ… [Audio] Playback started successfully (user-initiated)');
            }).catch(err => {
                console.error('âŒ [Audio] Play failed:', err);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥
            });
        }

        // Media SessionçŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateMediaSessionState(state) {
            if ('mediaSession' in navigator) {
                navigator.mediaSession.playbackState = state;
                console.log('Media Session state updated:', state);
            }
        }

        // ãƒšãƒ¼ã‚¸ãŒãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«å…¥ã£ãŸæ™‚ã®å‡¦ç†
        document.addEventListener('visibilitychange', () => {
            const audioPlayer = document.getElementById('audioPlayer');
            if (document.hidden) {
                // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«å…¥ã£ãŸæ™‚
                console.log('ğŸ“± [Visibility] Page hidden (background)');
                console.log('ğŸ”Š [Audio State] paused:', audioPlayer.paused, 'currentTime:', audioPlayer.currentTime, 'readyState:', audioPlayer.readyState);
                // playbackStateã¯è§¦ã‚‰ãªã„ï¼ˆHTMLå±æ€§ã®onplay/onpauseã«ä»»ã›ã‚‹ï¼‰
                console.log('â„¹ï¸ [Visibility] Letting audio continue naturally');
            } else {
                // ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«æˆ»ã£ãŸæ™‚
                console.log('ğŸ“± [Visibility] Page visible (foreground)');
                console.log('ğŸ”Š [Audio State] paused:', audioPlayer.paused, 'currentTime:', audioPlayer.currentTime, 'readyState:', audioPlayer.readyState);

                // ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«æˆ»ã£ãŸæ™‚ã€readyStateãŒä½ã„å ´åˆã®ã¿å†ç”Ÿã‚’è©¦ã¿ã‚‹
                if (!audioPlayer.paused && audioPlayer.readyState < 3) {
                    console.log('ğŸ”„ [Visibility Recovery] readyState low, attempting to resume...');
                    audioPlayer.play().catch(err => {
                        console.error('âŒ [Visibility Recovery] Play failed:', err);
                    });
                }
            }
        });

        // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é–‰ã˜ã‚‹
        function closeAudioPlayer() {
            const audioPlayer = document.getElementById('audioPlayer');

            console.log('ğŸ”’ [Close] Saving playback position before close...');
            console.log('ğŸ“ Current file:', currentAudioFilePath);
            console.log('â±ï¸ Current time:', audioPlayer.currentTime);
            console.log('â±ï¸ Duration:', audioPlayer.duration);

            // é–‰ã˜ã‚‹å‰ã«æœ€å¾Œã®ä½ç½®ã‚’è‡ªå‹•ä¿å­˜
            if (currentAudioFilePath && audioPlayer.currentTime > 3) {
                const duration = audioPlayer.duration;
                // æœ€å¾Œã¾ã§å†ç”Ÿã—ã¦ã„ãªã‘ã‚Œã°ä¿å­˜
                if (!isNaN(duration) && duration - audioPlayer.currentTime > 3) {
                    localStorage.setItem(`bookmark_${currentAudioFilePath}`, audioPlayer.currentTime.toString());
                    localStorage.setItem(`duration_${currentAudioFilePath}`, duration.toString());
                    console.log('âœ… [Bookmark] Saved:', audioPlayer.currentTime, '/', duration);
                } else if (!isNaN(duration) && duration - audioPlayer.currentTime < 3) {
                    // æœ€å¾Œã¾ã§å†ç”Ÿã—ãŸå ´åˆã¯å‰Šé™¤
                    localStorage.removeItem(`bookmark_${currentAudioFilePath}`);
                    localStorage.removeItem(`duration_${currentAudioFilePath}`);
                    console.log('ğŸ—‘ï¸ [Bookmark] Removed (finished)');
                } else {
                    console.log('â„¹ï¸ [Bookmark] Not saved (duration check failed)');
                }
            } else {
                console.log('â„¹ï¸ [Bookmark] Not saved (time < 3s or no file)');
            }

            // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
            if (audioKeyboardListener) {
                document.removeEventListener('keydown', audioKeyboardListener);
                audioKeyboardListener = null;
            }

            audioPlayer.pause();
            // currentTimeã¯0ã«ã—ãªã„ï¼ˆæ¬¡å›é–‹ã„ãŸæ™‚ã®ãŸã‚ã«ä½ç½®ã‚’ä¿æŒï¼‰
            // audioPlayer.currentTime = 0;

            // Media Sessionã‚’ã‚¯ãƒªã‚¢ï¼ˆé‡è¦ï¼æ¬¡å›ã®å†ç”Ÿã®ãŸã‚ã«å®Œå…¨ã«ãƒªã‚»ãƒƒãƒˆï¼‰
            if ('mediaSession' in navigator) {
                console.log('ğŸ§¹ [Media Session] Clearing all settings...');
                try {
                    // metadataã‚’nullã«
                    navigator.mediaSession.metadata = null;

                    // ã™ã¹ã¦ã®action handlersã‚’ã‚¯ãƒªã‚¢
                    const actions = ['play', 'pause', 'seekbackward', 'seekforward', 'seekto', 'previoustrack', 'nexttrack'];
                    actions.forEach(action => {
                        try {
                            navigator.mediaSession.setActionHandler(action, null);
                        } catch (e) {
                            // ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„actionã¯ã‚¹ã‚­ãƒƒãƒ—
                        }
                    });

                    // playback stateã‚’noneã«
                    navigator.mediaSession.playbackState = 'none';
                    console.log('âœ… [Media Session] Cleared successfully');
                } catch (err) {
                    console.error('âŒ [Media Session] Clear error:', err);
                }
            }

            document.getElementById('audioPlayerModal').classList.remove('active');
            document.body.classList.remove('modal-open');
            // å†ç”Ÿé€Ÿåº¦ã‚’ãƒªã‚»ãƒƒãƒˆ
            setPlaybackRate(1.0);

            // ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’æ›´æ–°ï¼ˆå†ç”Ÿä½ç½®ã®å††ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°ï¼‰
            renderFilesList();
        }

        // ã‚«ãƒƒãƒˆç·¨é›†ç”¨ã®å¤‰æ•°
        let editStartTime = null;
        let editEndTime = null;

        // ç·¨é›†ãƒ‘ãƒãƒ«ã®è¡¨ç¤º/éè¡¨ç¤º
        function toggleEditPanel() {
            const panel = document.getElementById('editPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        // æ™‚é–“ã‚’ mm:ss å½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        // é–‹å§‹ä½ç½®ã‚’ãƒãƒ¼ã‚¯
        function markStartTime() {
            const audioPlayer = document.getElementById('audioPlayer');
            editStartTime = audioPlayer.currentTime;
            document.getElementById('audioEditStartTime').textContent = formatTime(editStartTime);
            updateEditDuration();
        }

        // çµ‚äº†ä½ç½®ã‚’ãƒãƒ¼ã‚¯
        function markEndTime() {
            const audioPlayer = document.getElementById('audioPlayer');
            editEndTime = audioPlayer.currentTime;
            document.getElementById('audioEditEndTime').textContent = formatTime(editEndTime);
            updateEditDuration();
        }

        // ç·¨é›†ç¯„å›²ã®é•·ã•ã‚’æ›´æ–°
        function updateEditDuration() {
            if (editStartTime !== null && editEndTime !== null) {
                const duration = Math.abs(editEndTime - editStartTime);
                document.getElementById('editDuration').textContent = formatTime(duration);
            }
        }

        // ç·¨é›†ã‚’å®Ÿè¡Œ
        async function executeEdit(mode) {
            if (editStartTime === null || editEndTime === null) {
                alert('âš ï¸ é–‹å§‹ä½ç½®ã¨çµ‚äº†ä½ç½®ã®ä¸¡æ–¹ã‚’ãƒãƒ¼ã‚¯ã—ã¦ãã ã•ã„');
                return;
            }

            // é–‹å§‹ã¨çµ‚äº†ãŒé€†ã®å ´åˆã¯å…¥ã‚Œæ›¿ãˆ
            let start = Math.min(editStartTime, editEndTime);
            let end = Math.max(editStartTime, editEndTime);

            const modeText = mode === 'remove' ? 'å‰Šé™¤' : 'æŠ½å‡º';
            const confirmMsg = mode === 'remove'
                ? `${formatTime(start)} ï½ ${formatTime(end)} ã®ç¯„å›²ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\n\nç·¨é›†å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¾ã™ã€‚\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`
                : `${formatTime(start)} ï½ ${formatTime(end)} ã®ç¯„å›²ã‚’æŠ½å‡ºã—ã¾ã™ã€‚\n\næŠ½å‡ºã—ãŸéƒ¨åˆ†ãŒæ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¾ã™ã€‚\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`;

            if (!confirm(confirmMsg)) {
                return;
            }

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                const response = await fetch(`${baseUrl}/api/edit-audio`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        file_path: currentAudioFilePath,
                        start_time: start,
                        end_time: end,
                        mode: mode
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert(`âœ… ç·¨é›†å®Œäº†ï¼\n\næ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«: ${data.output_file}\n\néŒ²éŸ³æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚`);
                    // ç·¨é›†ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
                    editStartTime = null;
                    editEndTime = null;
                    document.getElementById('audioEditStartTime').textContent = 'æœªè¨­å®š';
                    document.getElementById('audioEditEndTime').textContent = 'æœªè¨­å®š';
                    document.getElementById('editDuration').textContent = '--';
                } else {
                    alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${data.error || 'ç·¨é›†ã«å¤±æ•—ã—ã¾ã—ãŸ'}`);
                }
            } catch (err) {
                console.error('Edit error:', err);
                alert('âŒ ç·¨é›†ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // å†ç”Ÿé€Ÿåº¦ã‚’å¤‰æ›´
        function changePlaybackRate(rate) {
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.playbackRate = parseFloat(rate);
            document.getElementById('playbackRateValue').textContent = parseFloat(rate).toFixed(1) + 'x';
            document.getElementById('playbackRate').value = rate;
        }

        // å†ç”Ÿé€Ÿåº¦ã‚’ãƒ—ãƒªã‚»ãƒƒãƒˆå€¤ã«è¨­å®š
        function setPlaybackRate(rate) {
            changePlaybackRate(rate);
        }

        // æ—©é€ã‚Šãƒ»å·»ãæˆ»ã—æ©Ÿèƒ½
        function skipAudio(seconds) {
            const audioPlayer = document.getElementById('audioPlayer');
            if (!audioPlayer) return;

            const newTime = audioPlayer.currentTime + seconds;

            // ç¯„å›²ãƒã‚§ãƒƒã‚¯ï¼ˆ0ç§’æœªæº€ã‚„å‹•ç”»ã®é•·ã•ã‚’è¶…ãˆãªã„ã‚ˆã†ã«ï¼‰
            if (newTime < 0) {
                audioPlayer.currentTime = 0;
            } else if (newTime > audioPlayer.duration) {
                audioPlayer.currentTime = audioPlayer.duration;
            } else {
                audioPlayer.currentTime = newTime;
            }
        }

        // å†ç”Ÿä½ç½®ã‚’æ›´æ–°ï¼ˆè‡ªå‹•ä¿å­˜ç”¨ï¼‰
        function updatePlaybackPosition() {
            if (!currentAudioFilePath) return;

            const audioPlayer = document.getElementById('audioPlayer');
            const currentTime = audioPlayer.currentTime;
            const duration = audioPlayer.duration;

            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã¨æ™‚é–“è¡¨ç¤ºã‚’æ›´æ–°
            const progressBar = document.getElementById('progressBar');
            const currentTimeEl = document.getElementById('currentTime');
            const totalDurationEl = document.getElementById('totalDuration');

            if (progressBar && !isNaN(duration) && duration > 0) {
                const progress = (currentTime / duration) * 100;
                progressBar.value = progress;
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®è‰²ã‚’æ›´æ–°
                progressBar.style.background = `linear-gradient(to right, #667eea 0%, #667eea ${progress}%, #e9ecef ${progress}%, #e9ecef 100%)`;
            }

            if (currentTimeEl) {
                currentTimeEl.textContent = formatTime(currentTime);
            }

            if (totalDurationEl && !isNaN(duration)) {
                totalDurationEl.textContent = formatTime(duration);
            }

            // å†ç”Ÿä¸­ã¯å¸¸ã«ä½ç½®ã‚’è‡ªå‹•ä¿å­˜ï¼ˆé–‹å§‹3ç§’å¾Œã‹ã‚‰ï¼‰
            if (currentTime > 3 && !isNaN(duration)) {
                localStorage.setItem(`bookmark_${currentAudioFilePath}`, currentTime.toString());
                localStorage.setItem(`duration_${currentAudioFilePath}`, duration.toString());

                // æœ€å¾Œã¾ã§å†ç”Ÿã—ãŸå ´åˆã¯ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚’å‰Šé™¤
                if (duration - currentTime < 3) {
                    localStorage.removeItem(`bookmark_${currentAudioFilePath}`);
                    localStorage.removeItem(`duration_${currentAudioFilePath}`);
                }
            }
        }

        // ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚’èª­ã¿è¾¼ã¿
        function loadBookmark() {
            console.log('ğŸ“– [Bookmark] loadBookmark() called');
            console.log('ğŸ“ currentAudioFilePath:', currentAudioFilePath);

            if (!currentAudioFilePath) {
                console.log('âš ï¸ [Bookmark] No currentAudioFilePath, skipping');
                return;
            }

            const savedTime = localStorage.getItem(`bookmark_${currentAudioFilePath}`);
            console.log('ğŸ’¾ [Bookmark] localStorage key:', `bookmark_${currentAudioFilePath}`);
            console.log('ğŸ’¾ [Bookmark] savedTime:', savedTime);

            if (savedTime) {
                const audioPlayer = document.getElementById('audioPlayer');
                const time = parseFloat(savedTime);
                console.log('â±ï¸ [Bookmark] Restoring to:', time);
                // å†ç”Ÿä½ç½®ã‚’å¾©å…ƒ
                audioPlayer.currentTime = time;
                console.log('âœ… [Bookmark] Restored! audioPlayer.currentTime =', audioPlayer.currentTime);
            } else {
                console.log('â„¹ï¸ [Bookmark] No saved time found');
            }
        }

        // éŸ³é‡ã‚’ä¿å­˜
        function saveVolume() {
            const audioPlayer = document.getElementById('audioPlayer');
            if (audioPlayer) {
                localStorage.setItem('audioPlayerVolume', audioPlayer.volume.toString());
            }
        }

        // éŸ³é‡ã‚’èª­ã¿è¾¼ã¿
        function loadVolume() {
            const audioPlayer = document.getElementById('audioPlayer');
            const volumeControl = document.getElementById('volumeControl');
            const volumeValue = document.getElementById('volumeValue');
            const savedVolume = localStorage.getItem('audioPlayerVolume');

            if (savedVolume !== null && audioPlayer) {
                const volume = parseFloat(savedVolume);
                audioPlayer.volume = volume;

                // UIã‚’æ›´æ–°
                if (volumeControl) {
                    volumeControl.value = Math.round(volume * 100);
                }
                if (volumeValue) {
                    volumeValue.textContent = Math.round(volume * 100) + '%';
                }
            } else if (audioPlayer) {
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯100%
                audioPlayer.volume = 1.0;
                if (volumeControl) volumeControl.value = 100;
                if (volumeValue) volumeValue.textContent = '100%';
            }
        }

        // éŸ³é‡ã‚’å¤‰æ›´
        function changeVolume(value) {
            const audioPlayer = document.getElementById('audioPlayer');
            const volumeValue = document.getElementById('volumeValue');

            if (audioPlayer) {
                const volume = value / 100;
                audioPlayer.volume = volume;
                localStorage.setItem('audioPlayerVolume', volume.toString());
            }

            if (volumeValue) {
                volumeValue.textContent = value + '%';
            }
        }

        // æ™‚é–“ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ (ç§’ -> mm:ss)
        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // å†ç”Ÿ/ä¸€æ™‚åœæ­¢ãƒˆã‚°ãƒ«
        function togglePlayPause() {
            const audioPlayer = document.getElementById('audioPlayer');
            if (!audioPlayer) return;

            if (audioPlayer.paused) {
                audioPlayer.play();
            } else {
                audioPlayer.pause();
            }
        }

        // å†ç”Ÿ/ä¸€æ™‚åœæ­¢ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°
        function updatePlayPauseButton() {
            const audioPlayer = document.getElementById('audioPlayer');
            const playPauseImg = document.getElementById('playPauseImg');
            if (!audioPlayer || !playPauseImg) return;

            if (audioPlayer.paused) {
                playPauseImg.src = 'img/palyer_play.png';
                playPauseImg.alt = 'å†ç”Ÿ';
            } else {
                playPauseImg.src = 'img/player_stop.png';
                playPauseImg.alt = 'ä¸€æ™‚åœæ­¢';
            }
        }

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã§ã‚·ãƒ¼ã‚¯
        function seekAudio(value) {
            const audioPlayer = document.getElementById('audioPlayer');
            if (!audioPlayer || isNaN(audioPlayer.duration)) return;

            const newTime = (value / 100) * audioPlayer.duration;
            audioPlayer.currentTime = newTime;
        }

        // ã™ã¹ã¦ã®å†ç”Ÿå±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ
        function clearAllBookmarks() {
            if (!confirm('ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å†ç”Ÿå±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                return;
            }

            // localStorageå†…ã®ã™ã¹ã¦ã®bookmark_ã¨duration_ã§å§‹ã¾ã‚‹ã‚­ãƒ¼ã‚’å‰Šé™¤
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.startsWith('bookmark_') || key.startsWith('duration_'))) {
                    keysToRemove.push(key);
                }
            }

            keysToRemove.forEach(key => localStorage.removeItem(key));

            alert(`ğŸ—‘ï¸ ${keysToRemove.length / 2}ä»¶ã®å†ç”Ÿå±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ`);

            // ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’å†æç”»
            renderFilesList();
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æœ¬æ—¥ã®æ—¥ä»˜ã‚’è¨­å®š
            const today = new Date();
            const dateStr = today.toISOString().slice(0, 10);
            document.getElementById('targetDate').value = dateStr;

            // éŸ³é‡ã‚’localStorageã‹ã‚‰å¾©å…ƒ
            loadVolume();
        });

        // ==================== ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ©Ÿèƒ½ ====================

        const ADMIN_PASSWORD = 'Pal_s1008467';
        let isAdminAuthenticated = false;

        // ç®¡ç†è€…èªè¨¼
        function authenticateAdmin() {
            const password = document.getElementById('adminPassword').value;

            if (password === ADMIN_PASSWORD) {
                isAdminAuthenticated = true;
                document.getElementById('adminAuth').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                document.getElementById('adminPassword').value = '';

                // æ—¥æ™‚å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®åˆ¶é™ã‚’è¨­å®š
                initManualDateTimeLimits();
            } else {
                alert('âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                document.getElementById('adminPassword').value = '';
            }
        }

        // ç®¡ç†è€…ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        function logoutAdmin() {
            isAdminAuthenticated = false;
            document.getElementById('adminAuth').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
        }

        // DBç•ªçµ„è¡¨ä¸€æ‹¬æ›´æ–°
        function updateAllPrograms() {
            if (!confirm('å…¨ã‚¨ãƒªã‚¢ã®ç•ªçµ„è¡¨ã‚’æ›´æ–°ã—ã¾ã™ã€‚\nå‡¦ç†ã«ã¯æ•°åˆ†ã€œåæ•°åˆ†ã‹ã‹ã‚Šã¾ã™ã€‚\nå®Ÿè¡Œã—ã¾ã™ã‹?')) {
                return;
            }

            const days = document.getElementById('updateDays').value;
            const updateLog = document.getElementById('updateLog');
            const updateProgress = document.getElementById('updateProgress');

            updateProgress.style.display = 'block';
            updateLog.innerHTML = '<span style="color: #17a2b8;">ğŸ”„ æ›´æ–°å‡¦ç†ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...</span>\n';

            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼è¦ç´ 
            const progressBar = document.getElementById('updateProgressBar');
            const progressText = document.getElementById('updateProgressText');
            const progressPercent = document.getElementById('updateProgressPercent');
            const progressDetail = document.getElementById('updateProgressDetail');
            const progressBarText = document.getElementById('updateProgressBarText');

            // çµ±è¨ˆã‚«ã‚¦ãƒ³ã‚¿ãƒ¼è¦ç´ 
            const successCount = document.getElementById('updateSuccessCount');
            const errorCount = document.getElementById('updateErrorCount');
            const warningCount = document.getElementById('updateWarningCount');

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            // Server-Sent Events (SSE) ã§é€²æ—ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å—ä¿¡
            const eventSource = new EventSource(`${baseUrl}/admin/update-programs-stream?days=${days}`);

            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);

                    switch(data.type) {
                        case 'start':
                            updateLog.innerHTML += `<span style="color: #17a2b8;">ğŸ“¡ ${data.message}</span>\n`;
                            progressText.textContent = 'æ›´æ–°é–‹å§‹';
                            progressDetail.textContent = data.message;
                            break;

                        case 'info':
                            updateLog.innerHTML += `<span style="color: #17a2b8;">â„¹ï¸ ${data.message}</span>\n`;
                            progressDetail.textContent = data.message;
                            break;

                        case 'progress':
                            updateLog.innerHTML += `\n<span style="color: #6c757d; font-weight: bold;">[${data.current}/${data.total}] ${data.area} ã‚’å‡¦ç†ä¸­...</span>\n`;
                            progressText.textContent = `${data.area} ã‚’å‡¦ç†ä¸­...`;
                            progressDetail.textContent = `ã‚¨ãƒªã‚¢ ${data.current}/${data.total} ã‚’å‡¦ç†ä¸­`;
                            break;

                        case 'success':
                            updateLog.innerHTML += `  <span style="color: #28a745;">âœ… ${data.area} ${data.date}: ${data.programs}ä»¶</span>\n`;
                            updateLog.scrollTop = updateLog.scrollHeight;
                            break;

                        case 'warning':
                            updateLog.innerHTML += `  <span style="color: #ffc107;">âš ï¸ ${data.area} ${data.date}: ${data.message}</span>\n`;
                            break;

                        case 'error':
                            updateLog.innerHTML += `  <span style="color: #dc3545;">âŒ ${data.area} ${data.date}: ${data.message}</span>\n`;
                            break;

                        case 'percent':
                            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’æ›´æ–°
                            progressBar.style.width = `${data.percent}%`;
                            progressPercent.textContent = `${data.percent}%`;
                            progressBarText.textContent = `${data.completed}/${data.total}`;
                            progressDetail.textContent = `${data.completed}/${data.total} ä»¶å®Œäº†`;

                            // çµ±è¨ˆã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’æ›´æ–°
                            successCount.textContent = data.success || 0;
                            errorCount.textContent = data.error || 0;
                            warningCount.textContent = data.warning || 0;

                            updateLog.scrollTop = updateLog.scrollHeight;
                            break;

                        case 'complete':
                            // å®Œäº†æ™‚ã¯100%
                            progressBar.style.width = '100%';
                            progressBar.style.background = 'linear-gradient(90deg, #28a745, #1e7e34)';
                            progressPercent.textContent = '100%';
                            progressText.textContent = 'âœ… å®Œäº†';
                            progressBarText.textContent = 'å®Œäº†';
                            progressDetail.textContent = `ç·ç•ªçµ„æ•°: ${data.total_programs}ä»¶`;

                            // æœ€çµ‚çµ±è¨ˆã‚’æ›´æ–°
                            successCount.textContent = data.success || 0;
                            errorCount.textContent = data.error || 0;
                            warningCount.textContent = data.warning || 0;

                            updateLog.innerHTML += `\n<span style="color: #28a745; font-weight: bold;">âœ… ${data.message}</span>\n`;
                            updateLog.innerHTML += `<span style="color: #17a2b8;">ğŸ“Š ç·ç•ªçµ„æ•°: ${data.total_programs}ä»¶</span>\n`;
                            updateLog.innerHTML += `<span style="color: #28a745;">âœ… æˆåŠŸ: ${data.success}ä»¶</span> / `;
                            updateLog.innerHTML += `<span style="color: #dc3545;">âŒ ã‚¨ãƒ©ãƒ¼: ${data.error}ä»¶</span> / `;
                            updateLog.innerHTML += `<span style="color: #ffc107;">âš ï¸ è­¦å‘Š: ${data.warning}ä»¶</span>\n`;
                            eventSource.close();
                            break;
                    }
                } catch (err) {
                    console.error('Parse error:', err);
                }
            };

            eventSource.onerror = function(err) {
                console.error('EventSource error:', err);
                updateLog.innerHTML += `\nâŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ\n`;
                eventSource.close();
            };
        }

        // ã‚¨ãƒªã‚¢é¸æŠæ™‚ã«æ”¾é€å±€ãƒªã‚¹ãƒˆã‚’æ›´æ–°
        async function updateManualStations() {
            const areaId = document.getElementById('manualArea').value;
            const stationSelect = document.getElementById('manualStation');

            if (!areaId) {
                stationSelect.innerHTML = '<option value="">ã¾ãšã‚¨ãƒªã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
                return;
            }

            stationSelect.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ä¸­...</option>';

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                // ä»Šæ—¥ã®æ—¥ä»˜ã§ç•ªçµ„è¡¨ã‚’å–å¾—
                const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const response = await fetch(`${baseUrl}/api/programs/area/${areaId}/date/${today}`);
                const data = await response.json();

                if (response.ok && data.programs) {
                    // å±€IDã‚’ãƒ¦ãƒ‹ãƒ¼ã‚¯ã«æŠ½å‡º
                    const stations = {};
                    data.programs.forEach(prog => {
                        if (prog.stationId && prog.stationName) {
                            stations[prog.stationId] = prog.stationName;
                        }
                    });

                    // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
                    stationSelect.innerHTML = '<option value="">æ”¾é€å±€ã‚’é¸æŠ</option>';
                    Object.keys(stations).sort().forEach(stationId => {
                        const option = document.createElement('option');
                        option.value = stationId;
                        option.textContent = `${stationId} - ${stations[stationId]}`;
                        stationSelect.appendChild(option);
                    });
                } else {
                    stationSelect.innerHTML = '<option value="">æ”¾é€å±€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</option>';
                }
            } catch (err) {
                console.error('Station list error:', err);
                stationSelect.innerHTML = '<option value="">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</option>';
            }
        }

        // æ—¥æ™‚å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®åˆ¶é™ã‚’è¨­å®šï¼ˆ1é€±é–“å‰ã¾ã§ï¼‰
        function initManualDateTimeLimits() {
            const now = new Date();
            const oneWeekAgo = new Date(now);
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

            // ISOå½¢å¼ã«å¤‰æ›ï¼ˆYYYY-MM-DDTHH:mmï¼‰
            const minDateTime = oneWeekAgo.toISOString().slice(0, 16);

            document.getElementById('manualStart').min = minDateTime;
            document.getElementById('manualEnd').min = minDateTime;
        }

        // æ‰‹å‹•ã‚³ãƒãƒ³ãƒ‰ã®ã‚³ãƒ”ãƒ¼
        function copyManualCommand() {
            const title = document.getElementById('manualTitle').value.trim();
            const station = document.getElementById('manualStation').value;
            const startDatetime = document.getElementById('manualStart').value;
            const endDatetime = document.getElementById('manualEnd').value;

            if (!title || !station || !startDatetime || !endDatetime) {
                alert('ç•ªçµ„åã€æ”¾é€å±€ã€éŒ²éŸ³é–‹å§‹æ—¥æ™‚ã€éŒ²éŸ³çµ‚äº†æ—¥æ™‚ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // datetime-localå½¢å¼ã‚’YYYYMMDDHHmmå½¢å¼ã«å¤‰æ›
            const startDate = new Date(startDatetime);
            const endDate = new Date(endDatetime);

            const startStr = `${startDate.getFullYear()}${String(startDate.getMonth() + 1).padStart(2, '0')}${String(startDate.getDate()).padStart(2, '0')}${String(startDate.getHours()).padStart(2, '0')}${String(startDate.getMinutes()).padStart(2, '0')}`;
            const endStr = `${endDate.getFullYear()}${String(endDate.getMonth() + 1).padStart(2, '0')}${String(endDate.getDate()).padStart(2, '0')}${String(endDate.getHours()).padStart(2, '0')}${String(endDate.getMinutes()).padStart(2, '0')}`;

            const scriptPath = document.getElementById('scriptPath').value;
            const command = `${scriptPath} "${title}" "${station}" "${station}" "${startStr}" "${endStr}" "" "" "" >> /tmp/myradiko_output.log 2>&1`;

            // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
            navigator.clipboard.writeText(command).then(() => {
                // ã‚³ãƒãƒ³ãƒ‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
                const preview = document.getElementById('manualCommandPreview');
                preview.textContent = command;
                preview.style.display = 'block';

                alert('âœ… ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }).catch(err => {
                alert('âŒ ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
            });
        }

        // æ‰‹å‹•ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œï¼ˆå³åº§ã«å®Ÿè¡Œï¼‰
        async function executeManualCommand() {
            const title = document.getElementById('manualTitle').value.trim();
            const station = document.getElementById('manualStation').value;
            const startDatetime = document.getElementById('manualStart').value;
            const endDatetime = document.getElementById('manualEnd').value;

            if (!title || !station || !startDatetime || !endDatetime) {
                alert('ç•ªçµ„åã€æ”¾é€å±€ã€éŒ²éŸ³é–‹å§‹æ—¥æ™‚ã€éŒ²éŸ³çµ‚äº†æ—¥æ™‚ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // datetime-localå½¢å¼ã‚’YYYYMMDDHHmmå½¢å¼ã«å¤‰æ›
            const startDate = new Date(startDatetime);
            const endDate = new Date(endDatetime);

            const startStr = `${startDate.getFullYear()}${String(startDate.getMonth() + 1).padStart(2, '0')}${String(startDate.getDate()).padStart(2, '0')}${String(startDate.getHours()).padStart(2, '0')}${String(startDate.getMinutes()).padStart(2, '0')}`;
            const endStr = `${endDate.getFullYear()}${String(endDate.getMonth() + 1).padStart(2, '0')}${String(endDate.getDate()).padStart(2, '0')}${String(endDate.getHours()).padStart(2, '0')}${String(endDate.getMinutes()).padStart(2, '0')}`;

            if (!confirm(`ä»¥ä¸‹ã®éŒ²éŸ³ã‚’å³åº§ã«å®Ÿè¡Œã—ã¾ã™:\n\nç•ªçµ„å: ${title}\nå±€ID: ${station}\né–‹å§‹: ${startDatetime.replace('T', ' ')}\nçµ‚äº†: ${endDatetime.replace('T', ' ')}\n\nã‚ˆã‚ã—ã„ã§ã™ã‹?`)) {
                return;
            }

            const manualOutput = document.getElementById('manualOutput');
            const manualLog = document.getElementById('manualLog');

            manualOutput.style.display = 'block';
            manualLog.textContent = 'â–¶ï¸ ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œä¸­...\n';

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';
            const scriptPath = document.getElementById('scriptPath').value;

            try {
                const response = await fetch(`${baseUrl}/admin/execute-manual`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        script_path: scriptPath,
                        title: title,
                        station_id: station,
                        start_time: startStr,
                        end_time: endStr
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    manualLog.textContent += `âœ… å®Ÿè¡Œå®Œäº†\n\n${data.output || ''}`;
                } else {
                    manualLog.textContent += `âŒ ã‚¨ãƒ©ãƒ¼: ${data.error}\n`;
                }
            } catch (err) {
                manualLog.textContent += `âŒ ã‚¨ãƒ©ãƒ¼: ${err.message}\n`;
            }
        }

        // æ‰‹å‹•ã‚³ãƒãƒ³ãƒ‰ã®atäºˆç´„å®Ÿè¡Œ
        async function scheduleManualCommand() {
            const title = document.getElementById('manualTitle').value.trim();
            const station = document.getElementById('manualStation').value;
            const executeTime = document.getElementById('manualExecuteTime').value;
            const startDatetime = document.getElementById('manualStart').value;
            const endDatetime = document.getElementById('manualEnd').value;

            if (!title || !station || !executeTime || !startDatetime || !endDatetime) {
                alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // datetime-localå½¢å¼ã‚’YYYYMMDDHHmmå½¢å¼ã«å¤‰æ›
            const executeDate = new Date(executeTime);
            const startDate = new Date(startDatetime);
            const endDate = new Date(endDatetime);

            const executeStr = `${executeDate.getFullYear()}${String(executeDate.getMonth() + 1).padStart(2, '0')}${String(executeDate.getDate()).padStart(2, '0')}${String(executeDate.getHours()).padStart(2, '0')}${String(executeDate.getMinutes()).padStart(2, '0')}`;
            const startStr = `${startDate.getFullYear()}${String(startDate.getMonth() + 1).padStart(2, '0')}${String(startDate.getDate()).padStart(2, '0')}${String(startDate.getHours()).padStart(2, '0')}${String(startDate.getMinutes()).padStart(2, '0')}`;
            const endStr = `${endDate.getFullYear()}${String(endDate.getMonth() + 1).padStart(2, '0')}${String(endDate.getDate()).padStart(2, '0')}${String(endDate.getHours()).padStart(2, '0')}${String(endDate.getMinutes()).padStart(2, '0')}`;

            if (!confirm(`ä»¥ä¸‹ã®éŒ²éŸ³ã‚’atäºˆç´„ã—ã¾ã™:\n\nå®Ÿè¡Œæ™‚åˆ»: ${executeTime.replace('T', ' ')}\nç•ªçµ„å: ${title}\nå±€ID: ${station}\néŒ²éŸ³é–‹å§‹: ${startDatetime.replace('T', ' ')}\néŒ²éŸ³çµ‚äº†: ${endDatetime.replace('T', ' ')}\n\nã‚ˆã‚ã—ã„ã§ã™ã‹?`)) {
                return;
            }

            const manualOutput = document.getElementById('manualOutput');
            const manualLog = document.getElementById('manualLog');

            manualOutput.style.display = 'block';
            manualLog.textContent = 'â° atäºˆç´„ã‚’ç™»éŒ²ä¸­...\n';

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';
            const scriptPath = document.getElementById('scriptPath').value;

            try {
                const response = await fetch(`${baseUrl}/schedule-at`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        script_path: scriptPath,
                        title: title,
                        station_id: station,
                        execute_time: executeStr,
                        start_time: startStr,
                        end_time: endStr
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    manualLog.textContent += `âœ… atäºˆç´„å®Œäº†\n\n${data.at_command || ''}\n\nJob ID: ${data.job_id || 'N/A'}`;
                } else {
                    manualLog.textContent += `âŒ ã‚¨ãƒ©ãƒ¼: ${data.error}\n`;
                }
            } catch (err) {
                manualLog.textContent += `âŒ ã‚¨ãƒ©ãƒ¼: ${err.message}\n`;
            }
        }

        // å¤ã„DBãƒ‡ãƒ¼ã‚¿å‰Šé™¤
        async function cleanupOldData() {
            if (!confirm('15æ—¥ä»¥å‰ã®ç•ªçµ„ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\nã‚ˆã‚ã—ã„ã§ã™ã‹?')) {
                return;
            }

            const maintenanceOutput = document.getElementById('maintenanceOutput');
            const maintenanceLog = document.getElementById('maintenanceLog');

            maintenanceOutput.style.display = 'block';
            maintenanceLog.textContent = 'ğŸ—‘ï¸ å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ä¸­...\n';

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                const response = await fetch(`${baseUrl}/admin/cleanup`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    maintenanceLog.textContent += `âœ… ${data.message}\n`;
                    maintenanceLog.textContent += `å‰Šé™¤ä»¶æ•°: ${data.deleted || 0}ä»¶\n`;
                } else {
                    maintenanceLog.textContent += `âŒ ã‚¨ãƒ©ãƒ¼: ${data.error}\n`;
                }
            } catch (err) {
                maintenanceLog.textContent += `âŒ ã‚¨ãƒ©ãƒ¼: ${err.message}\n`;
            }
        }

        // ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ç¢ºèª
        async function checkDiskSpace() {
            const maintenanceOutput = document.getElementById('maintenanceOutput');
            const maintenanceLog = document.getElementById('maintenanceLog');

            maintenanceOutput.style.display = 'block';
            maintenanceLog.textContent = 'ğŸ’¾ ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ã‚’ç¢ºèªä¸­...\n';

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                const response = await fetch(`${baseUrl}/admin/disk-space`);
                const data = await response.json();

                if (response.ok) {
                    maintenanceLog.textContent += `âœ… ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡æƒ…å ±\n\n`;
                    maintenanceLog.textContent += data.info || '';
                } else {
                    maintenanceLog.textContent += `âŒ ã‚¨ãƒ©ãƒ¼: ${data.error}\n`;
                }
            } catch (err) {
                maintenanceLog.textContent += `âŒ ã‚¨ãƒ©ãƒ¼: ${err.message}\n`;
            }
        }

        // DBçµ±è¨ˆæƒ…å ±
        async function viewDbStatus() {
            const maintenanceOutput = document.getElementById('maintenanceOutput');
            const maintenanceLog = document.getElementById('maintenanceLog');

            maintenanceOutput.style.display = 'block';
            maintenanceLog.textContent = 'ğŸ“ˆ DBçµ±è¨ˆæƒ…å ±ã‚’å–å¾—ä¸­...\n';

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                const response = await fetch(`${baseUrl}/admin/db-status`);
                const data = await response.json();

                if (response.ok) {
                    maintenanceLog.textContent += `âœ… DBçµ±è¨ˆæƒ…å ±\n\n`;
                    maintenanceLog.textContent += `ç·ç•ªçµ„æ•°: ${data.total_programs || 0}ä»¶\n`;
                    maintenanceLog.textContent += `æ›´æ–°å±¥æ­´: ${data.total_updates || 0}ä»¶\n`;
                    maintenanceLog.textContent += `DBå®¹é‡: ${data.db_size || '-'}\n`;
                } else {
                    maintenanceLog.textContent += `âŒ ã‚¨ãƒ©ãƒ¼: ${data.error}\n`;
                }
            } catch (err) {
                maintenanceLog.textContent += `âŒ ã‚¨ãƒ©ãƒ¼: ${err.message}\n`;
            }
        }

        // ========================================
        // DBç®¡ç†æ©Ÿèƒ½
        // ========================================

        async function cleanupOrphanedRecords() {
            if (!confirm('âš ï¸ ç‰©ç†ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„DBãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            const dbOutput = document.getElementById('dbManagementOutput');
            const dbLog = document.getElementById('dbManagementLog');

            dbOutput.style.display = 'block';
            dbLog.textContent = 'ğŸ§¹ å­¤ç«‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­...\n';

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                const response = await fetch(`${baseUrl}/admin/cleanup-orphaned-records`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (response.ok) {
                    dbLog.textContent += `\nâœ… å®Œäº†\n\n`;
                    dbLog.textContent += `å‰Šé™¤ã•ã‚ŒãŸãƒ¬ã‚³ãƒ¼ãƒ‰æ•°: ${data.orphaned_count || 0}ä»¶\n\n`;

                    if (data.cleaned && data.cleaned.length > 0) {
                        dbLog.textContent += `å‰Šé™¤ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹:\n`;
                        data.cleaned.forEach((path, index) => {
                            dbLog.textContent += `${index + 1}. ${path}\n`;
                        });
                    } else {
                        dbLog.textContent += `å­¤ç«‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\n`;
                    }

                    // éŒ²éŸ³ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’æ›´æ–°
                    if (typeof loadRecordedFiles === 'function') {
                        loadRecordedFiles();
                    }
                } else {
                    dbLog.textContent += `\nâŒ ã‚¨ãƒ©ãƒ¼: ${data.error}\n`;
                }
            } catch (err) {
                dbLog.textContent += `\nâŒ ã‚¨ãƒ©ãƒ¼: ${err.message}\n`;
            }
        }

        async function checkOrphanedFiles() {
            const dbOutput = document.getElementById('dbManagementOutput');
            const dbLog = document.getElementById('dbManagementLog');

            dbOutput.style.display = 'block';
            dbLog.textContent = 'ğŸ” å­¤ç«‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­...\n\n';
            dbLog.textContent += 'ã“ã®æ©Ÿèƒ½ã¯ç¾åœ¨é–‹ç™ºä¸­ã§ã™ã€‚\n';
            dbLog.textContent += 'ç‰©ç†ãƒ•ã‚¡ã‚¤ãƒ«ã¯å­˜åœ¨ã™ã‚‹ãŒã€DBãƒ¬ã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨ã—ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œå‡ºã—ã¾ã™ã€‚\n\n';
            dbLog.textContent += 'ğŸ’¡ ãƒ’ãƒ³ãƒˆ: ã€ŒéŒ²éŸ³æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚¿ãƒ–ã®ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ã€ãƒœã‚¿ãƒ³ã§\n';
            dbLog.textContent += 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰DBã«ç™»éŒ²ã§ãã¾ã™ã€‚\n';
        }

        async function showDbRecords() {
            const dbOutput = document.getElementById('dbManagementOutput');
            const dbLog = document.getElementById('dbManagementLog');

            dbOutput.style.display = 'block';
            dbLog.textContent = 'ğŸ“‹ ãƒ¬ã‚³ãƒ¼ãƒ‰ä¸€è¦§ã‚’å–å¾—ä¸­...\n\n';

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                const response = await fetch(`${baseUrl}/files`);
                const data = await response.json();

                if (response.ok && data.files) {
                    dbLog.textContent += `âœ… ç·ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°: ${data.files.length}ä»¶\n\n`;
                    dbLog.textContent += `--- ãƒ¬ã‚³ãƒ¼ãƒ‰ä¸€è¦§ ---\n\n`;

                    if (data.files.length === 0) {
                        dbLog.textContent += 'ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\n';
                    } else {
                        data.files.slice(0, 50).forEach((file, index) => {
                            dbLog.textContent += `${index + 1}. ${file.title || file.filename}\n`;
                            dbLog.textContent += `   ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹: ${file.filepath}\n`;
                            if (file.program_info) {
                                dbLog.textContent += `   æ”¾é€å±€: ${file.program_info.station || '-'}\n`;
                                dbLog.textContent += `   æ”¾é€æ—¥æ™‚: ${file.program_info.start_time || '-'}\n`;
                            }
                            dbLog.textContent += `\n`;
                        });

                        if (data.files.length > 50) {
                            dbLog.textContent += `\n... ä»–${data.files.length - 50}ä»¶\n`;
                            dbLog.textContent += `\nğŸ’¡ ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€ŒéŒ²éŸ³æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚¿ãƒ–ã§ç¢ºèªã§ãã¾ã™ã€‚\n`;
                        }
                    }
                } else {
                    dbLog.textContent += `âŒ ã‚¨ãƒ©ãƒ¼: ${data.error || 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ'}\n`;
                }
            } catch (err) {
                dbLog.textContent += `âŒ ã‚¨ãƒ©ãƒ¼: ${err.message}\n`;
            }
        }

        async function batchUpdateMetadata() {
            if (!confirm('âš ï¸ ã™ã¹ã¦ã®éŒ²éŸ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã€ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã€ã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ï¼‰ã‚’ä¸€æ‹¬æ›´æ–°ã—ã¾ã™ã€‚\n\næ—¢å­˜ã®ãƒ•ã‚¡ã‚¤ãƒ«æ•°ãŒå¤šã„å ´åˆã€å‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚\n\nç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            const dbOutput = document.getElementById('dbManagementOutput');
            const dbLog = document.getElementById('dbManagementLog');

            dbOutput.style.display = 'block';
            dbLog.textContent = 'ğŸµ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬æ›´æ–°ã‚’é–‹å§‹...\n';

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                const response = await fetch(`${baseUrl}/admin/batch-update-metadata`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (response.ok) {
                    dbLog.textContent += `\nâœ… å®Œäº†\n\n`;
                    dbLog.textContent += `å‡¦ç†ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${data.processed || 0}ä»¶\n`;
                    dbLog.textContent += `æ›´æ–°æˆåŠŸ: ${data.success_count || 0}ä»¶\n`;
                    dbLog.textContent += `æ›´æ–°å¤±æ•—: ${data.failed_count || 0}ä»¶\n`;
                    dbLog.textContent += `ã‚¹ã‚­ãƒƒãƒ—: ${data.skipped_count || 0}ä»¶\n\n`;

                    if (data.results && data.results.length > 0) {
                        dbLog.textContent += `\nå‡¦ç†è©³ç´°:\n`;
                        data.results.forEach((result, index) => {
                            const status = result.success ? 'âœ…' : 'âŒ';
                            dbLog.textContent += `${index + 1}. ${status} ${result.file}\n`;
                            if (result.message) {
                                dbLog.textContent += `   ${result.message}\n`;
                            }
                        });
                    }

                    alert(`âœ… ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬æ›´æ–°å®Œäº†\n\nå‡¦ç†: ${data.processed}ä»¶\næˆåŠŸ: ${data.success_count}ä»¶\nå¤±æ•—: ${data.failed_count}ä»¶`);
                } else {
                    dbLog.textContent += `\nâŒ ã‚¨ãƒ©ãƒ¼: ${data.error}\n`;
                    alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${data.error}`);
                }
            } catch (err) {
                console.error('Batch update metadata error:', err);
                dbLog.textContent += `âŒ ã‚¨ãƒ©ãƒ¼: ${err.message}\n`;
                alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${err.message}`);
            }
        }

        // ========================================
        // ã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ç®¡ç†æ©Ÿèƒ½
        // ========================================

        // ãƒˆãƒªãƒŸãƒ³ã‚°ç”¨ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let cropX = 0, cropY = 0, cropSize = 0;
        let isDragging = false;
        let isResizing = false;
        let resizeHandle = null;
        let dragStartX = 0, dragStartY = 0;
        let originalImage = null;
        let currentCropFile = null;
        let displayScale = 1; // Canvasè¡¨ç¤ºæ™‚ã®ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆå…ƒç”»åƒã«å¯¾ã™ã‚‹æ¯”ç‡ï¼‰

        function extractProgramTitle(filename) {
            // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ç•ªçµ„ã‚¿ã‚¤ãƒˆãƒ«ã‚’æŠ½å‡º
            // å½¢å¼: "ç•ªçµ„å(YYYY.MM.DD).mp3" ã¾ãŸã¯ "ç•ªçµ„å_YYYY-MM-DD.mp3"
            if (!filename) return '';

            let title = filename;

            // æ‹¡å¼µå­ã‚’å‰Šé™¤
            title = title.replace(/\.(mp3|m4a|aac|wav)$/i, '');

            // æ—¥ä»˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å‰Šé™¤ (YYYY.MM.DD) ã¾ãŸã¯ (YYYY-MM-DD)
            title = title.replace(/\(?\d{4}[.-]\d{2}[.-]\d{2}\)?$/i, '');
            title = title.replace(/_\d{4}[.-]\d{2}[.-]\d{2}$/i, '');

            // æœ«å°¾ã®ã‚¢ãƒ³ãƒ€ãƒ¼ãƒãƒ¼ã‚„æ‹¬å¼§ã‚’å‰Šé™¤
            title = title.replace(/[_\(\)]+$/, '');

            return title.trim();
        }

        function showArtworkUploadModal(filename) {
            const modal = document.getElementById('artworkUploadModal');
            const titleInput = document.getElementById('artworkTitle');
            const fileInput = document.getElementById('artworkFile');
            const cropArea = document.getElementById('artworkCropArea');
            const canvas = document.getElementById('artworkCanvas');
            const cropBox = document.getElementById('cropBox');

            // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ç•ªçµ„ã‚¿ã‚¤ãƒˆãƒ«ã‚’æŠ½å‡º
            const programTitle = extractProgramTitle(filename);
            titleInput.value = programTitle;

            // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
            fileInput.value = '';
            cropArea.style.display = 'none';
            cropBox.style.display = 'none';

            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    currentCropFile = file;
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const img = new Image();
                        img.onload = function() {
                            originalImage = img;

                            // Canvasã«ç”»åƒã‚’æç”»
                            const maxWidth = 500;
                            displayScale = Math.min(1, maxWidth / img.width, maxWidth / img.height);
                            canvas.width = img.width * displayScale;
                            canvas.height = img.height * displayScale;

                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                            // ãƒˆãƒªãƒŸãƒ³ã‚°ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
                            cropArea.style.display = 'block';

                            // åˆæœŸãƒˆãƒªãƒŸãƒ³ã‚°ç¯„å›²ã‚’ä¸­å¤®ã«é…ç½®ï¼ˆæ­£æ–¹å½¢ï¼‰
                            const minDimension = Math.min(canvas.width, canvas.height);
                            cropSize = minDimension * 0.8; // 80%ã®ã‚µã‚¤ã‚º
                            cropX = (canvas.width - cropSize) / 2;
                            cropY = (canvas.height - cropSize) / 2;

                            updateCropBox();
                            cropBox.style.display = 'block';
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };

            modal.style.display = 'flex';
        }

        function closeArtworkUploadModal() {
            const modal = document.getElementById('artworkUploadModal');
            modal.style.display = 'none';
        }

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’èª­ã¿è¾¼ã‚€
        function loadDefaultArtworkPreview() {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';
            const preview = document.getElementById('defaultArtworkPreview');

            if (preview) {
                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–ã—ã¦èª­ã¿è¾¼ã¿
                preview.src = `${baseUrl}/artwork/__DEFAULT__?t=${Date.now()}`;
            }
        }

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ã®é–¢æ•°
        function openDefaultArtworkUpload() {
            const modal = document.getElementById('artworkUploadModal');
            const titleInput = document.getElementById('artworkTitle');
            const artistInput = document.getElementById('artworkArtist');
            const fileInput = document.getElementById('artworkFile');
            const cropArea = document.getElementById('artworkCropArea');
            const cropBox = document.getElementById('cropBox');

            // ã‚¿ã‚¤ãƒˆãƒ«ã‚’__DEFAULT__ã«å›ºå®š
            titleInput.value = '__DEFAULT__';
            titleInput.readOnly = true;
            titleInput.style.background = '#e9ecef';

            // ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆæ¬„ã‚’éè¡¨ç¤º
            artistInput.parentElement.style.display = 'none';

            // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
            fileInput.value = '';
            cropArea.style.display = 'none';
            cropBox.style.display = 'none';

            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆæ—¢å­˜ã®å‡¦ç†ã‚’æµç”¨ï¼‰
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    currentCropFile = file;
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const img = new Image();
                        img.onload = function() {
                            originalImage = img;

                            // Canvasã«ç”»åƒã‚’æç”»
                            const canvas = document.getElementById('artworkCanvas');
                            const maxWidth = 500;
                            displayScale = Math.min(1, maxWidth / img.width, maxWidth / img.height);
                            canvas.width = img.width * displayScale;
                            canvas.height = img.height * displayScale;

                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                            // ãƒˆãƒªãƒŸãƒ³ã‚°ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
                            cropArea.style.display = 'block';

                            // åˆæœŸãƒˆãƒªãƒŸãƒ³ã‚°ç¯„å›²ã‚’ä¸­å¤®ã«é…ç½®ï¼ˆæ­£æ–¹å½¢ï¼‰
                            const minDimension = Math.min(canvas.width, canvas.height);
                            cropSize = minDimension * 0.8;
                            cropX = (canvas.width - cropSize) / 2;
                            cropY = (canvas.height - cropSize) / 2;

                            updateCropBox();
                            cropBox.style.display = 'block';
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };

            modal.style.display = 'flex';

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹æ™‚ã«ãƒªã‚»ãƒƒãƒˆ
            modal.addEventListener('click', function resetOnClose(e) {
                if (e.target === modal || e.target.classList.contains('modal-close')) {
                    titleInput.readOnly = false;
                    titleInput.style.background = '';
                    artistInput.parentElement.style.display = 'block';
                    modal.removeEventListener('click', resetOnClose);
                }
            }, { once: true });
        }

        // Twitteré¢¨ãƒˆãƒªãƒŸãƒ³ã‚°æ©Ÿèƒ½
        function updateCropBox() {
            const canvas = document.getElementById('artworkCanvas');
            const cropBox = document.getElementById('cropBox');
            const rect = canvas.getBoundingClientRect();

            // Canvasè«–ç†åº§æ¨™ã‚’è¡¨ç¤ºåº§æ¨™ã«å¤‰æ›
            const scaleX = rect.width / canvas.width;
            const scaleY = rect.height / canvas.height;

            const displayX = cropX * scaleX;
            const displayY = cropY * scaleY;
            const displaySize = cropSize * scaleX;

            cropBox.style.left = displayX + 'px';
            cropBox.style.top = displayY + 'px';
            cropBox.style.width = displaySize + 'px';
            cropBox.style.height = displaySize + 'px';
        }

        function initCropHandlers() {
            const canvas = document.getElementById('artworkCanvas');
            const cropBox = document.getElementById('cropBox');

            // ãƒã‚¦ã‚¹ã¨ã‚¿ãƒƒãƒã®åº§æ¨™ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
            function getEventCoords(e) {
                if (e.touches && e.touches.length > 0) {
                    return { clientX: e.touches[0].clientX, clientY: e.touches[0].clientY };
                }
                return { clientX: e.clientX, clientY: e.clientY };
            }

            // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ãƒãƒ³ãƒ‰ãƒ©ï¼ˆãƒã‚¦ã‚¹ã¨ã‚¿ãƒƒãƒå…±é€šï¼‰
            function handleStart(e) {
                // ãƒãƒ³ãƒ‰ãƒ«ã‚¯ãƒªãƒƒã‚¯ã®å ´åˆã¯ãƒªã‚µã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ã«
                if (e.target.hasAttribute('data-handle')) {
                    isResizing = true;
                    resizeHandle = e.target.getAttribute('data-handle');
                    e.stopPropagation();
                } else {
                    // ãƒœãƒƒã‚¯ã‚¹æœ¬ä½“ã®ã‚¯ãƒªãƒƒã‚¯ã¯ç§»å‹•ãƒ¢ãƒ¼ãƒ‰ã«
                    isDragging = true;
                }

                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;

                const coords = getEventCoords(e);
                dragStartX = (coords.clientX - rect.left) * scaleX;
                dragStartY = (coords.clientY - rect.top) * scaleY;

                e.preventDefault();
            }

            // ã‚¯ãƒ­ãƒƒãƒ—ãƒœãƒƒã‚¯ã‚¹ã®ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•ï¼ˆãƒã‚¦ã‚¹ï¼‰
            cropBox.addEventListener('mousedown', handleStart);
            // ã‚¿ãƒƒãƒå¯¾å¿œ
            cropBox.addEventListener('touchstart', handleStart, { passive: false });

            // ç§»å‹•ãƒãƒ³ãƒ‰ãƒ©ï¼ˆãƒã‚¦ã‚¹ã¨ã‚¿ãƒƒãƒå…±é€šï¼‰
            function handleMove(e) {
                if (!isDragging && !isResizing) return;

                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;

                const coords = getEventCoords(e);
                const currentX = (coords.clientX - rect.left) * scaleX;
                const currentY = (coords.clientY - rect.top) * scaleY;

                if (isDragging) {
                    // ãƒœãƒƒã‚¯ã‚¹ç§»å‹•
                    const deltaX = currentX - dragStartX;
                    const deltaY = currentY - dragStartY;

                    let newX = cropX + deltaX;
                    let newY = cropY + deltaY;

                    // Canvaså¢ƒç•Œå†…ã«åˆ¶é™
                    newX = Math.max(0, Math.min(newX, canvas.width - cropSize));
                    newY = Math.max(0, Math.min(newY, canvas.height - cropSize));

                    cropX = newX;
                    cropY = newY;

                    dragStartX = currentX;
                    dragStartY = currentY;

                    updateCropBox();
                } else if (isResizing) {
                    // ãƒªã‚µã‚¤ã‚ºï¼ˆæ­£æ–¹å½¢ã‚’ä¿ã¤ï¼‰
                    let deltaX = currentX - dragStartX;
                    let deltaY = currentY - dragStartY;

                    // ãƒãƒ³ãƒ‰ãƒ«ã®ä½ç½®ã«å¿œã˜ã¦ãƒªã‚µã‚¤ã‚ºæ–¹å‘ã‚’æ±ºå®š
                    if (resizeHandle === 'nw') {
                        // å·¦ä¸Šãƒãƒ³ãƒ‰ãƒ«ï¼šå·¦ä¸Šæ–¹å‘ã«ãƒªã‚µã‚¤ã‚º
                        const delta = Math.min(deltaX, deltaY);
                        const newSize = cropSize - delta;
                        const minSize = 50;

                        if (newSize >= minSize && cropX + delta >= 0 && cropY + delta >= 0) {
                            cropSize = newSize;
                            cropX += delta;
                            cropY += delta;
                            dragStartX = currentX;
                            dragStartY = currentY;
                        }
                    } else if (resizeHandle === 'ne') {
                        // å³ä¸Šãƒãƒ³ãƒ‰ãƒ«ï¼šå³ä¸Šæ–¹å‘ã«ãƒªã‚µã‚¤ã‚º
                        const delta = Math.max(deltaX, -deltaY);
                        const newSize = cropSize + delta;
                        const minSize = 50;

                        if (newSize >= minSize && cropX + newSize <= canvas.width && cropY - delta >= 0) {
                            cropSize = newSize;
                            cropY -= delta;
                            dragStartX = currentX;
                            dragStartY = currentY;
                        }
                    } else if (resizeHandle === 'sw') {
                        // å·¦ä¸‹ãƒãƒ³ãƒ‰ãƒ«ï¼šå·¦ä¸‹æ–¹å‘ã«ãƒªã‚µã‚¤ã‚º
                        const delta = Math.max(-deltaX, deltaY);
                        const newSize = cropSize + delta;
                        const minSize = 50;

                        if (newSize >= minSize && cropX - delta >= 0 && cropY + newSize <= canvas.height) {
                            cropSize = newSize;
                            cropX -= delta;
                            dragStartX = currentX;
                            dragStartY = currentY;
                        }
                    } else if (resizeHandle === 'se') {
                        // å³ä¸‹ãƒãƒ³ãƒ‰ãƒ«ï¼šå³ä¸‹æ–¹å‘ã«ãƒªã‚µã‚¤ã‚º
                        const delta = Math.max(deltaX, deltaY);
                        const newSize = cropSize + delta;
                        const minSize = 50;

                        if (newSize >= minSize && cropX + newSize <= canvas.width && cropY + newSize <= canvas.height) {
                            cropSize = newSize;
                            dragStartX = currentX;
                            dragStartY = currentY;
                        }
                    }

                    updateCropBox();
                }

                e.preventDefault();
            }

            // çµ‚äº†ãƒãƒ³ãƒ‰ãƒ©ï¼ˆãƒã‚¦ã‚¹ã¨ã‚¿ãƒƒãƒå…±é€šï¼‰
            function handleEnd() {
                isDragging = false;
                isResizing = false;
                resizeHandle = null;
            }

            // ãƒã‚¦ã‚¹ç§»å‹•ãƒ»çµ‚äº†ãƒãƒ³ãƒ‰ãƒ©
            document.addEventListener('mousemove', handleMove);
            document.addEventListener('mouseup', handleEnd);

            // ã‚¿ãƒƒãƒç§»å‹•ãƒ»çµ‚äº†ãƒãƒ³ãƒ‰ãƒ©
            document.addEventListener('touchmove', handleMove, { passive: false });
            document.addEventListener('touchend', handleEnd);
            document.addEventListener('touchcancel', handleEnd);
        }

        function applyAndWaitForCrop() {
            return new Promise((resolve) => {
                // ãƒˆãƒªãƒŸãƒ³ã‚°ç¯„å›²ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
                if (cropSize < 10) {
                    resolve();
                    return;
                }

                console.log('applyCrop called');
                console.log('cropX:', cropX, 'cropY:', cropY, 'cropSize:', cropSize);
                console.log('displayScale:', displayScale);
                console.log('originalImage size:', originalImage.width, 'x', originalImage.height);

                // Canvasè«–ç†åº§æ¨™ã‚’å…ƒç”»åƒã®åº§æ¨™ã«å¤‰æ›
                const sourceX = cropX / displayScale;
                const sourceY = cropY / displayScale;
                const sourceSize = cropSize / displayScale;

                console.log('Source crop area:', sourceX, sourceY, sourceSize);

                // æ–°ã—ã„Canvasã«ãƒˆãƒªãƒŸãƒ³ã‚°å¾Œã®ç”»åƒã‚’æç”»
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = sourceSize;
                tempCanvas.height = sourceSize;
                const tempCtx = tempCanvas.getContext('2d');

                tempCtx.drawImage(
                    originalImage,
                    sourceX, sourceY, sourceSize, sourceSize,
                    0, 0, sourceSize, sourceSize
                );

                // ãƒˆãƒªãƒŸãƒ³ã‚°å¾Œã®ç”»åƒã‚’è¡¨ç¤ºç”¨Canvasã«æç”»
                const canvas = document.getElementById('artworkCanvas');
                const maxWidth = 500;
                const newDisplayScale = Math.min(1, maxWidth / sourceSize);
                canvas.width = sourceSize * newDisplayScale;
                canvas.height = sourceSize * newDisplayScale;

                const ctx = canvas.getContext('2d');
                ctx.drawImage(tempCanvas, 0, 0, canvas.width, canvas.height);

                console.log('New canvas size:', canvas.width, 'x', canvas.height);

                // ãƒˆãƒªãƒŸãƒ³ã‚°å¾Œã®ç”»åƒã‚’ä¿å­˜
                tempCanvas.toBlob((blob) => {
                    currentCropFile = new File([blob], 'cropped.jpg', { type: 'image/jpeg' });
                    console.log('Cropped file created:', currentCropFile.size, 'bytes');

                    // ã‚¯ãƒ­ãƒƒãƒ—ãƒœãƒƒã‚¯ã‚¹ã‚’éè¡¨ç¤º
                    const cropBox = document.getElementById('cropBox');
                    cropBox.style.display = 'none';
                    cropX = cropY = cropSize = 0;

                    resolve();
                }, 'image/jpeg', 0.95);
            });
        }

        // éŸ³é‡ãƒ»å†ç”Ÿé€Ÿåº¦ãƒ»ã‚·ãƒ¼ã‚¯ãƒãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’åˆæœŸåŒ–
        function initVolumeAndSpeedControls() {
            const volumeControl = document.getElementById('volumeControl');
            const playbackRateControl = document.getElementById('playbackRate');
            const progressBar = document.getElementById('progressBar');

            // éŸ³é‡èª¿æ•´ãƒãƒ¼ï¼šã‚¹ãƒãƒ›ã®ã‚¿ãƒƒãƒæ“ä½œã«å¯¾å¿œ
            if (volumeControl) {
                // input ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å¤‰æ›´ï¼‰
                volumeControl.addEventListener('input', function(e) {
                    changeVolume(this.value);
                });

                // change ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå¤‰æ›´å®Œäº†æ™‚ï¼‰
                volumeControl.addEventListener('change', function(e) {
                    changeVolume(this.value);
                });

                // touchend ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚¿ãƒƒãƒæ“ä½œçµ‚äº†æ™‚ï¼‰
                volumeControl.addEventListener('touchend', function(e) {
                    changeVolume(this.value);
                });
            }

            // å†ç”Ÿé€Ÿåº¦èª¿æ•´ãƒãƒ¼ï¼šåŒæ§˜ã«ã‚¿ãƒƒãƒæ“ä½œã«å¯¾å¿œ
            if (playbackRateControl) {
                // input ã‚¤ãƒ™ãƒ³ãƒˆ
                playbackRateControl.addEventListener('input', function(e) {
                    changePlaybackRate(this.value);
                });

                // change ã‚¤ãƒ™ãƒ³ãƒˆ
                playbackRateControl.addEventListener('change', function(e) {
                    changePlaybackRate(this.value);
                });

                // touchend ã‚¤ãƒ™ãƒ³ãƒˆ
                playbackRateControl.addEventListener('touchend', function(e) {
                    changePlaybackRate(this.value);
                });
            }

            // ã‚·ãƒ¼ã‚¯ãƒãƒ¼ï¼ˆå†ç”Ÿä½ç½®èª¿æ•´ï¼‰ï¼šåŒæ§˜ã«ã‚¿ãƒƒãƒæ“ä½œã«å¯¾å¿œ
            if (progressBar) {
                // input ã‚¤ãƒ™ãƒ³ãƒˆ
                progressBar.addEventListener('input', function(e) {
                    seekAudio(this.value);
                });

                // change ã‚¤ãƒ™ãƒ³ãƒˆ
                progressBar.addEventListener('change', function(e) {
                    seekAudio(this.value);
                });

                // touchend ã‚¤ãƒ™ãƒ³ãƒˆ
                progressBar.addEventListener('touchend', function(e) {
                    seekAudio(this.value);
                });
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initCropHandlers();
            initVolumeAndSpeedControls();
        });

        async function resizeImage(file, maxWidth = 800, maxHeight = 800, quality = 0.85) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒã—ã¦ãƒªã‚µã‚¤ã‚º
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > maxWidth) {
                                height = Math.round(height * maxWidth / width);
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = Math.round(width * maxHeight / height);
                                height = maxHeight;
                            }
                        }

                        // Canvasã§ãƒªã‚µã‚¤ã‚º
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // Blobã«å¤‰æ›
                        canvas.toBlob(
                            (blob) => {
                                if (blob) {
                                    resolve(blob);
                                } else {
                                    reject(new Error('ç”»åƒã®å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸ'));
                                }
                            },
                            'image/jpeg',
                            quality
                        );
                    };
                    img.onerror = () => reject(new Error('ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'));
                    img.src = e.target.result;
                };
                reader.onerror = () => reject(new Error('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'));
                reader.readAsDataURL(file);
            });
        }

        async function uploadArtwork() {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            const title = document.getElementById('artworkTitle').value.trim();
            const artist = document.getElementById('artworkArtist').value.trim();
            const fileInput = document.getElementById('artworkFile');
            const file = fileInput.files[0];

            if (!title) {
                alert('ç•ªçµ„ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (!file) {
                alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            // ãƒˆãƒªãƒŸãƒ³ã‚°ç¯„å›²ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãƒˆãƒªãƒŸãƒ³ã‚°ã‚’é©ç”¨
            const cropBox = document.getElementById('cropBox');
            if (cropBox.style.display !== 'none' && cropSize > 0) {
                console.log('Applying crop before upload...');
                await applyAndWaitForCrop();
            }

            try {
                // ãƒˆãƒªãƒŸãƒ³ã‚°å¾Œã®ç”»åƒãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨
                const fileToUpload = currentCropFile || file;

                // ç”»åƒã‚’ç¸®å°
                const resizedBlob = await resizeImage(fileToUpload, 800, 800, 0.85);

                // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’MBå˜ä½ã§è¡¨ç¤º
                const originalSizeMB = (file.size / 1024 / 1024).toFixed(2);
                const resizedSizeMB = (resizedBlob.size / 1024 / 1024).toFixed(2);
                console.log(`Image resized: ${originalSizeMB}MB â†’ ${resizedSizeMB}MB`);

                const formData = new FormData();
                formData.append('title', title);
                if (artist) {
                    formData.append('artist', artist);
                }
                formData.append('file', resizedBlob, 'artwork.jpg');

                const response = await fetch(`${baseUrl}/artwork/upload`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    let message = `âœ… ã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç™»éŒ²ã—ã¾ã—ãŸ: ${title}\n(${originalSizeMB}MB â†’ ${resizedSizeMB}MB)`;
                    if (data.embedded > 0) {
                        message += `\n\nğŸ“ ${data.embedded}ä»¶ã®MP3ãƒ•ã‚¡ã‚¤ãƒ«ã«åŸ‹ã‚è¾¼ã¿ã¾ã—ãŸ`;
                    }
                    alert(message);
                    closeArtworkUploadModal();

                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ã®å ´åˆã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
                    if (title === '__DEFAULT__') {
                        const preview = document.getElementById('defaultArtworkPreview');
                        if (preview) {
                            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–ã—ã¦å†èª­ã¿è¾¼ã¿
                            preview.src = `${baseUrl}/artwork/__DEFAULT__?t=${Date.now()}`;
                        }
                    }

                    loadRecordedFiles(); // ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’æ›´æ–°
                } else {
                    alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
                }
            } catch (err) {
                console.error('Upload artwork error:', err);
                alert(`âŒ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${err.message}`);
            }
        }

        async function loadArtworkForTitle(title) {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            console.log('ğŸ¨ [Artwork] Loading artwork for title:', title);

            try {
                const artworkUrl = `${baseUrl}/artwork/${encodeURIComponent(title)}`;
                console.log('ğŸ¨ [Artwork] URL:', artworkUrl);

                // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒå¸¸ã«ç”»åƒã‚’è¿”ã™ï¼ˆã‚«ã‚¹ã‚¿ãƒ ã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ã®ã§ã€URLã‚’ãã®ã¾ã¾è¿”ã™
                const response = await fetch(artworkUrl, { method: 'HEAD' });
                console.log('ğŸ¨ [Artwork] Response status:', response.status);

                if (response.ok) {
                    console.log('âœ… [Artwork] Artwork available:', artworkUrl);
                    return artworkUrl;
                } else {
                    console.warn('âš ï¸ [Artwork] Request failed, using fallback');
                    return 'img/jacket.png';
                }
            } catch (err) {
                console.error('âŒ [Artwork] Load error:', err);
                return 'img/jacket.png';
            }
        }

        // ========================================
        // ä»®æƒ³ãƒ•ã‚©ãƒ«ãƒ€ç®¡ç†
        // ========================================
        let allFolders = [];
        // ç¾åœ¨è¡¨ç¤ºä¸­ã®ãƒ•ã‚©ãƒ«ãƒ€ID (null = ãƒ«ãƒ¼ãƒˆ) - localStorageã‹ã‚‰å¾©å…ƒ
        let currentFolderId = localStorage.getItem('currentFolderId') ? parseInt(localStorage.getItem('currentFolderId')) : null;
        let folderHistory = []; // ãƒ•ã‚©ãƒ«ãƒ€éšå±¤ã®å±¥æ­´
        let editingFolderId = null;

        async function loadFolders() {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                const response = await fetch(`${baseUrl}/folders`);
                const data = await response.json();

                if (data.success) {
                    allFolders = data.folders || [];
                }
            } catch (err) {
                console.error('Load folders error:', err);
            }
        }

        function navigateToFolder(folderId) {
            currentFolderId = folderId;
            // localStorageã«ä¿å­˜
            if (folderId === null) {
                localStorage.removeItem('currentFolderId');
            } else {
                localStorage.setItem('currentFolderId', folderId);
            }
            loadRecordedFiles();
        }

        function navigateUp() {
            // ç¾åœ¨ã®ãƒ•ã‚©ãƒ«ãƒ€ã®è¦ªãƒ•ã‚©ãƒ«ãƒ€ã«æˆ»ã‚‹
            if (currentFolderId === null) return;

            const currentFolder = allFolders.find(f => f.id === currentFolderId);
            currentFolderId = currentFolder ? currentFolder.parent_id : null;
            // localStorageã«ä¿å­˜
            if (currentFolderId === null) {
                localStorage.removeItem('currentFolderId');
            } else {
                localStorage.setItem('currentFolderId', currentFolderId);
            }
            loadRecordedFiles();
        }

        function updateBreadcrumb() {
            const breadcrumb = document.getElementById('breadcrumb');
            const breadcrumbPath = document.getElementById('breadcrumbPath');

            if (currentFolderId === null) {
                breadcrumb.style.display = 'none';
                return;
            }

            breadcrumb.style.display = 'flex';

            // ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
            const path = [];
            let folderId = currentFolderId;
            while (folderId !== null) {
                const folder = allFolders.find(f => f.id === folderId);
                if (!folder) break;
                path.unshift(folder);
                folderId = folder.parent_id;
            }

            let html = '<a href="javascript:navigateToFolder(null)" style="color: #667eea; text-decoration: none;">ğŸ  ãƒ›ãƒ¼ãƒ </a>';
            for (const folder of path) {
                html += ` / <a href="javascript:navigateToFolder(${folder.id})" style="color: #667eea; text-decoration: none;">${folder.name}</a>`;
            }

            breadcrumbPath.innerHTML = html;
        }

        function showCreateFolderModal() {
            editingFolderId = null;
            document.getElementById('folderModalTitle').textContent = 'ğŸ“‚ æ–°è¦ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ';
            document.getElementById('folderName').value = '';
            document.getElementById('selectedFolderColor').value = '';

            // ã‚«ãƒ©ãƒ¼ãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('.folder-color-btn').forEach(btn => {
                btn.style.border = '2px solid #dee2e6';
                btn.style.transform = 'scale(1)';
            });

            document.getElementById('folderModal').style.display = 'block';
        }

        function editFolder(folderId) {
            const folder = allFolders.find(f => f.id === folderId);
            if (!folder) return;

            editingFolderId = folderId;
            document.getElementById('folderModalTitle').textContent = 'ğŸ“‚ ãƒ•ã‚©ãƒ«ãƒ€ç·¨é›†';
            document.getElementById('folderName').value = folder.name;
            document.getElementById('selectedFolderColor').value = folder.color || '';

            // ã‚«ãƒ©ãƒ¼ãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’è¨­å®š
            document.querySelectorAll('.folder-color-btn').forEach(btn => {
                if (btn.dataset.color === folder.color) {
                    btn.style.border = '3px solid #212529';
                    btn.style.transform = 'scale(1.1)';
                } else {
                    btn.style.border = '2px solid #dee2e6';
                    btn.style.transform = 'scale(1)';
                }
            });

            document.getElementById('folderModal').style.display = 'block';
        }

        function closeFolderModal() {
            document.getElementById('folderModal').style.display = 'none';
            editingFolderId = null;
        }

        function selectFolderColor(color) {
            document.getElementById('selectedFolderColor').value = color;

            // ã‚«ãƒ©ãƒ¼ãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.folder-color-btn').forEach(btn => {
                if (btn.dataset.color === color) {
                    btn.style.border = '3px solid #212529';
                    btn.style.transform = 'scale(1.1)';
                } else {
                    btn.style.border = '2px solid #dee2e6';
                    btn.style.transform = 'scale(1)';
                }
            });
        }

        async function saveFolderModal() {
            const name = document.getElementById('folderName').value.trim();
            const color = document.getElementById('selectedFolderColor').value;

            if (!name) {
                alert('ãƒ•ã‚©ãƒ«ãƒ€åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                let response;
                if (editingFolderId) {
                    // æ›´æ–°
                    response = await fetch(`${baseUrl}/folders/${editingFolderId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, color })
                    });
                } else {
                    // ä½œæˆï¼ˆç¾åœ¨ã®ãƒ•ã‚©ãƒ«ãƒ€ã®ä¸­ã«ä½œæˆï¼‰
                    response = await fetch(`${baseUrl}/folders`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, color, parent_id: currentFolderId })
                    });
                }

                const data = await response.json();

                if (data.success) {
                    closeFolderModal();
                    loadRecordedFiles();
                } else {
                    alert(`ã‚¨ãƒ©ãƒ¼: ${data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
                }
            } catch (err) {
                console.error('Save folder error:', err);
                alert(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${err.message}`);
            }
        }

        async function deleteFolder(folderId, folderName) {
            if (!confirm(`ãƒ•ã‚©ãƒ«ãƒ€ã€Œ${folderName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâ€» ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯å‰Šé™¤ã•ã‚Œãšã€ã€Œã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã€ã«ç§»å‹•ã•ã‚Œã¾ã™ã€‚`)) {
                return;
            }

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                const response = await fetch(`${baseUrl}/folders/${folderId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    if (currentFolderId === folderId) {
                        currentFolderId = null;
                    }
                    loadRecordedFiles();
                } else {
                    alert(`ã‚¨ãƒ©ãƒ¼: ${data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
                }
            } catch (err) {
                console.error('Delete folder error:', err);
                alert(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${err.message}`);
            }
        }

        let movingFilePath = null;

        function showMoveFileModal(filePath, fileName) {
            movingFilePath = filePath;
            document.getElementById('moveFileName').textContent = fileName;

            // ãƒ•ã‚©ãƒ«ãƒ€ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
            renderFolderListForMove();

            document.getElementById('moveFileModal').style.display = 'block';
        }

        function closeMoveFileModal() {
            document.getElementById('moveFileModal').style.display = 'none';
            movingFilePath = null;
        }

        function renderFolderListForMove() {
            const folderList = document.getElementById('folderList');

            if (allFolders.length === 0) {
                folderList.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #adb5bd;">
                        <div style="font-size: 2em; margin-bottom: 10px;">ğŸ“‚</div>
                        <div style="font-size: 0.9em;">ãƒ•ã‚©ãƒ«ãƒ€ãŒã‚ã‚Šã¾ã›ã‚“</div>
                        <div style="font-size: 0.8em; margin-top: 5px;">å…ˆã«ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¦ãã ã•ã„</div>
                    </div>
                `;
                return;
            }

            let html = '';

            // ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ«ãƒ€ï¼ˆãƒ•ã‚©ãƒ«ãƒ€ãªã—ï¼‰ã‚ªãƒ—ã‚·ãƒ§ãƒ³
            html += `
                <div onclick="moveToSelectedFolder(null)" style="padding: 12px; border-radius: 6px; cursor: pointer; margin-bottom: 8px; background: #f8f9fa; border: 1px solid #dee2e6; transition: all 0.2s; display: flex; align-items: center; gap: 10px;"
                     onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                    <span style="font-size: 1.5em;">ğŸ </span>
                    <div>
                        <div style="font-weight: 600; color: #495057;">ãƒ«ãƒ¼ãƒˆï¼ˆãƒ•ã‚©ãƒ«ãƒ€ãªã—ï¼‰</div>
                        <div style="font-size: 0.8em; color: #6c757d;">ãƒ•ã‚©ãƒ«ãƒ€ã«å…¥ã‚Œãªã„</div>
                    </div>
                </div>
            `;

            // å…¨ãƒ•ã‚©ãƒ«ãƒ€ã‚’è¡¨ç¤ºï¼ˆéšå±¤æ§‹é€ ã§ï¼‰
            function renderFolder(folder, level = 0) {
                const bgColor = folder.color || '#6c757d';
                const indent = level * 20;

                html += `
                    <div onclick="moveToSelectedFolder(${folder.id})" style="padding: 12px; padding-left: ${12 + indent}px; border-radius: 6px; cursor: pointer; margin-bottom: 8px; background: white; border: 1px solid #e9ecef; transition: all 0.2s; display: flex; align-items: center; gap: 10px;"
                         onmouseover="this.style.background='#f8f9fa'; this.style.borderColor='${bgColor}'" onmouseout="this.style.background='white'; this.style.borderColor='#e9ecef'">
                        <span style="width: 24px; height: 24px; border-radius: 4px; background: ${bgColor}; flex-shrink: 0;"></span>
                        <div style="font-weight: 600; color: #495057;">${folder.name}</div>
                    </div>
                `;

                // å­ãƒ•ã‚©ãƒ«ãƒ€ã‚’è¡¨ç¤º
                const children = allFolders.filter(f => f.parent_id === folder.id);
                children.forEach(child => renderFolder(child, level + 1));
            }

            // ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ«ãƒ€ï¼ˆparent_id === nullï¼‰ã‹ã‚‰è¡¨ç¤º
            allFolders.filter(f => f.parent_id === null).forEach(folder => renderFolder(folder));

            folderList.innerHTML = html;
        }

        async function moveToSelectedFolder(folderId) {
            if (!movingFilePath) return;

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                const response = await fetch(`${baseUrl}/files/move`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ file_path: movingFilePath, folder_id: folderId })
                });

                const data = await response.json();

                if (data.success) {
                    closeMoveFileModal();
                    loadRecordedFiles();
                } else {
                    alert(`ã‚¨ãƒ©ãƒ¼: ${data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
                }
            } catch (err) {
                console.error('Move file error:', err);
                alert(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${err.message}`);
            }
        }
    </script>
</body>
</html>
