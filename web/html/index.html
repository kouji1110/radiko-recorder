<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŒ²éŸ³ãã‚“ - radikoéŒ²éŸ³ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="icon" href="/img/favicon.ico" type="image/x-icon">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 10px;
            margin: 0;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        header {
            background: #667eea;
            color: white;
            padding: 10px 15px;
        }

        header h1 {
            font-size: 1.2em;
            margin: 0;
        }

        header p {
            font-size: 0.75em;
            opacity: 0.9;
            margin: 0;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            padding: 0 15px;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 0.9em;
            font-weight: 600;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #495057;
            background: #e9ecef;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .settings {
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .settings-grid {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .setting-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .setting-group label {
            font-weight: 600;
            color: #495057;
            font-size: 0.75em;
            white-space: nowrap;
        }

        .setting-group input,
        .setting-group select {
            padding: 4px 8px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .setting-group input:focus,
        .setting-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 4px 12px;
            border: none;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .content {
            padding: 10px;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #6c757d;
            font-size: 1.2em;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #f5c6cb;
        }

        .program-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 6px;
        }

        .station-column {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            overflow: hidden;
        }

        .station-header {
            background: #667eea;
            color: white;
            padding: 6px 8px;
            font-weight: 700;
            font-size: 0.85em;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .station-programs {
            max-height: calc(100vh - 140px);
            overflow-y: auto;
        }

        .program-card {
            background: white;
            border-bottom: 1px solid #f0f0f0;
            padding: 4px 6px;
            transition: background 0.1s;
            cursor: pointer;
        }

        .program-card:last-child {
            border-bottom: none;
        }

        .program-card:hover {
            background: #f8f9fa;
        }

        .program-card.now-playing {
            background: #fff9e6;
            border-left: 3px solid #ffc107;
        }

        .program-time {
            color: #667eea;
            font-weight: 700;
            font-size: 0.7em;
            margin-bottom: 2px;
        }

        .program-title {
            color: #212529;
            font-size: 0.8em;
            font-weight: 600;
            margin-bottom: 2px;
            line-height: 1.2;
        }

        .program-detail {
            color: #6c757d;
            font-size: 0.7em;
            margin-bottom: 3px;
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .program-actions {
            display: flex;
            gap: 2px;
            margin-top: 3px;
        }

        .btn-action {
            flex: 1;
            padding: 2px 4px;
            border: none;
            border-radius: 3px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.1s;
            font-size: 0.65em;
            white-space: nowrap;
        }

        .btn-cron {
            background: #28a745;
            color: white;
        }

        .btn-cron:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-download {
            background: #007bff;
            color: white;
        }

        .btn-download:hover {
            background: #0069d9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
        }

        .btn-at {
            background: #ffc107;
            color: #212529;
        }

        .btn-at:hover {
            background: #e0a800;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 193, 7, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-header h2 {
            color: #212529;
            font-size: 1.8em;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: #6c757d;
            padding: 0;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: #f8f9fa;
            color: #212529;
        }

        .command-box {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
            line-height: 1.6;
            word-break: break-all;
            color: #212529;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
        }

        .btn-execute {
            flex: 1;
            background: #28a745;
            color: white;
        }

        .btn-execute:hover {
            background: #218838;
        }

        .btn-copy {
            flex: 1;
            background: #667eea;
            color: white;
        }

        .btn-copy:hover {
            background: #5568d3;
        }

        .btn-close {
            flex: 1;
            background: #6c757d;
            color: white;
        }

        .btn-close:hover {
            background: #5a6268;
        }

        footer {
            background: #f8f9fa;
            padding: 6px;
            text-align: center;
            color: #6c757d;
            font-size: 0.7em;
            border-top: 1px solid #e9ecef;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8em;
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }

            .program-header {
                flex-direction: column;
            }

            .program-actions {
                flex-direction: column;
            }

            .btn-action {
                width: 100%;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“» éŒ²éŸ³ãã‚“</h1>
            <p>å…¨å›½47éƒ½é“åºœçœŒã®ãƒ©ã‚¸ã‚ªç•ªçµ„ã‚’æ¤œç´¢ãƒ»éŒ²éŸ³äºˆç´„</p>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('search')">ğŸ“» ç•ªçµ„æ¤œç´¢</button>
            <button class="tab" onclick="switchTab('files')">ğŸ“ éŒ²éŸ³æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«</button>
            <button class="tab" onclick="switchTab('cron')">â° cronç®¡ç†</button>
            <button class="tab" onclick="switchTab('at')">â±ï¸ atäºˆç´„</button>
        </div>

        <!-- ç•ªçµ„æ¤œç´¢ã‚¿ãƒ– -->
        <div id="searchTab" class="tab-content active">
            <div class="settings">
            <div class="settings-grid">
                <div class="setting-group">
                    <label for="areaId">ã‚¨ãƒªã‚¢ã‚’é¸æŠ:</label>
                    <select id="areaId">
                        <option value="JP1">åŒ—æµ·é“</option>
                        <option value="JP2">é’æ£®çœŒ</option>
                        <option value="JP3">å²©æ‰‹çœŒ</option>
                        <option value="JP4">å®®åŸçœŒ</option>
                        <option value="JP5">ç§‹ç”°çœŒ</option>
                        <option value="JP6">å±±å½¢çœŒ</option>
                        <option value="JP7">ç¦å³¶çœŒ</option>
                        <option value="JP8">èŒ¨åŸçœŒ</option>
                        <option value="JP9">æ ƒæœ¨çœŒ</option>
                        <option value="JP10">ç¾¤é¦¬çœŒ</option>
                        <option value="JP11">åŸ¼ç‰çœŒ</option>
                        <option value="JP12">åƒè‘‰çœŒ</option>
                        <option value="JP13">æ±äº¬éƒ½</option>
                        <option value="JP14">ç¥å¥ˆå·çœŒ</option>
                        <option value="JP15">æ–°æ½ŸçœŒ</option>
                        <option value="JP16">å¯Œå±±çœŒ</option>
                        <option value="JP17">çŸ³å·çœŒ</option>
                        <option value="JP18">ç¦äº•çœŒ</option>
                        <option value="JP19">å±±æ¢¨çœŒ</option>
                        <option value="JP20">é•·é‡çœŒ</option>
                        <option value="JP21">å²é˜œçœŒ</option>
                        <option value="JP22">é™å²¡çœŒ</option>
                        <option value="JP23">æ„›çŸ¥çœŒ</option>
                        <option value="JP24">ä¸‰é‡çœŒ</option>
                        <option value="JP25">æ»‹è³€çœŒ</option>
                        <option value="JP26">äº¬éƒ½åºœ</option>
                        <option value="JP27">å¤§é˜ªåºœ</option>
                        <option value="JP28">å…µåº«çœŒ</option>
                        <option value="JP29">å¥ˆè‰¯çœŒ</option>
                        <option value="JP30">å’Œæ­Œå±±çœŒ</option>
                        <option value="JP31">é³¥å–çœŒ</option>
                        <option value="JP32">å³¶æ ¹çœŒ</option>
                        <option value="JP33">å²¡å±±çœŒ</option>
                        <option value="JP34">åºƒå³¶çœŒ</option>
                        <option value="JP35">å±±å£çœŒ</option>
                        <option value="JP36">å¾³å³¶çœŒ</option>
                        <option value="JP37">é¦™å·çœŒ</option>
                        <option value="JP38">æ„›åª›çœŒ</option>
                        <option value="JP39">é«˜çŸ¥çœŒ</option>
                        <option value="JP40">ç¦å²¡çœŒ</option>
                        <option value="JP41">ä½è³€çœŒ</option>
                        <option value="JP42">é•·å´çœŒ</option>
                        <option value="JP43">ç†Šæœ¬çœŒ</option>
                        <option value="JP44">å¤§åˆ†çœŒ</option>
                        <option value="JP45">å®®å´çœŒ</option>
                        <option value="JP46">é¹¿å…å³¶çœŒ</option>
                        <option value="JP47">æ²–ç¸„çœŒ</option>
                    </select>
                </div>

                <div class="setting-group">
                    <div id="dateButtons" style="display: flex; gap: 4px; flex-wrap: wrap;">
                        <!-- æ—¥ä»˜ãƒœã‚¿ãƒ³ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                    </div>
                    <input type="hidden" id="targetDate" value="">
                </div>

                <div class="setting-group">
                    <label for="searchKeyword">æ¤œç´¢:</label>
                    <input type="text" id="searchKeyword" placeholder="ç•ªçµ„åã§æ¤œç´¢" style="width: 150px;">
                </div>

                <div class="setting-group">
                    <label for="proxyUrl">ãƒ—ãƒ­ã‚­ã‚·URL:</label>
                    <input type="text" id="proxyUrl" value="" placeholder="/api" style="width: 80px;">
                </div>

                <div class="setting-group">
                    <label for="scriptPath">ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ‘ã‚¹:</label>
                    <input type="text" id="scriptPath" value="/home/sites/radiko-recorder/script/myradiko" placeholder="ãƒ‘ã‚¹" style="width: 250px;">
                </div>
            </div>

            <button id="fetchBtn" class="btn btn-primary">ç•ªçµ„è¡¨ã‚’å–å¾—</button>
            <button id="searchAllBtn" class="btn btn-primary" style="margin-left: 8px;">å…¨ã‚¨ãƒªã‚¢ã‹ã‚‰æ¤œç´¢</button>
            <button id="clearCacheBtn" class="btn" style="margin-left: 8px; background: #667eea; color: white;">ğŸ”„ å†å–å¾—</button>
        </div>

            <div class="content">
                <div id="loading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>ç•ªçµ„è¡¨ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
                <div id="error" class="error" style="display: none;"></div>
                <div id="searchInfo" style="padding: 8px; font-size: 0.85em; color: #6c757d; display: none;"></div>
                <div id="programList" class="program-list"></div>
            </div>
        </div>

        <!-- éŒ²éŸ³æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ãƒ– -->
        <div id="filesTab" class="tab-content">
            <div class="content">
                <div style="padding: 15px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e9ecef;">
                        <h2 style="margin: 0; font-size: 1.3em; color: #212529;">ğŸ“ éŒ²éŸ³æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§</h2>
                        <button class="btn btn-primary" onclick="loadRecordedFiles()" style="padding: 6px 16px; font-size: 0.9em;">ğŸ”„ æ›´æ–°</button>
                    </div>
                    <div id="filesLoading" class="loading" style="display: none;">
                        <div class="spinner"></div>
                        <p>ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                    <div id="filesList"></div>
                </div>
            </div>
        </div>

        <!-- cronç®¡ç†ã‚¿ãƒ– -->
        <div id="cronTab" class="tab-content">
            <div class="content">
                <div style="padding: 15px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e9ecef;">
                        <h2 style="margin: 0; font-size: 1.3em; color: #212529;">â° cronç®¡ç†</h2>
                        <button class="btn btn-primary" onclick="loadCronJobs()" style="padding: 6px 16px; font-size: 0.9em;">ğŸ”„ æ›´æ–°</button>
                    </div>
                    <div id="cronLoading" class="loading" style="display: none;">
                        <div class="spinner"></div>
                        <p>cronä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                    <div id="cronList"></div>
                </div>
            </div>
        </div>

        <!-- atäºˆç´„ã‚¿ãƒ– -->
        <div id="atTab" class="tab-content">
            <div class="content">
                <div style="padding: 15px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e9ecef;">
                        <h2 style="margin: 0; font-size: 1.3em; color: #212529;">â±ï¸ atäºˆç´„ç®¡ç†</h2>
                        <button class="btn btn-primary" onclick="loadAtJobs()" style="padding: 6px 16px; font-size: 0.9em;">ğŸ”„ æ›´æ–°</button>
                    </div>
                    <div id="atLoading" class="loading" style="display: none;">
                        <div class="spinner"></div>
                        <p>atäºˆç´„ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                    <div id="atList"></div>
                </div>
            </div>
        </div>

        <footer>
            <p>&copy; 2025 éŒ²éŸ³ãã‚“ | Powered by radiko API</p>
        </footer>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">ã‚³ãƒãƒ³ãƒ‰</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="command-box" id="commandBox"></div>
            <div class="modal-actions">
                <button class="btn btn-action btn-execute" id="executeBtn" onclick="executeCommand()" style="display: none;">å®Ÿè¡Œ</button>
                <button class="btn btn-action" id="registerCronBtn" style="display: none; background: #28a745; color: white;">â° cronç™»éŒ²</button>
                <button class="btn btn-action btn-copy" onclick="copyCommand(event)">ã‚³ãƒ”ãƒ¼</button>
                <button class="btn btn-action btn-close" onclick="closeModal()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- cronãƒ­ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="cronLogModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>ğŸ“‹ cronãƒ­ã‚°</h2>
                <button class="modal-close" onclick="closeCronLogModal()">&times;</button>
            </div>
            <div style="margin-bottom: 15px;">
                <div style="padding: 10px; background: #f8f9fa; border-radius: 4px; font-size: 0.85em; color: #6c757d;">
                    cronã®å®Ÿè¡Œå±¥æ­´ã¨ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚æœ€æ–°100è¡Œã¾ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
                </div>
            </div>
            <div id="cronLogContent" style="max-height: 500px; overflow-y: auto; background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 0.8em; line-height: 1.6;">
                <div style="text-align: center; color: #888;">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-action" onclick="loadCronLogs()" style="background: #6c757d; color: white;">ğŸ”„ æ›´æ–°</button>
                <button class="btn btn-action btn-close" onclick="closeCronLogModal()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="audioPlayerModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="audioPlayerTitle">ğŸµ å†ç”Ÿä¸­</h2>
                <button class="modal-close" onclick="closeAudioPlayer()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <audio id="audioPlayer" controls style="width: 100%; margin-bottom: 15px;">
                    <source id="audioSource" src="" type="audio/mpeg">
                    ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å†ç”Ÿã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚
                </audio>
                <div id="audioInfo" style="padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 0.9em; color: #495057;">
                    <div style="margin-bottom: 8px;"><strong>ãƒ•ã‚¡ã‚¤ãƒ«å:</strong> <span id="audioFileName"></span></div>
                    <div style="color: #6c757d; font-size: 0.85em;">å†ç”Ÿé€Ÿåº¦ã®èª¿æ•´ã‚„ã‚·ãƒ¼ã‚¯ãŒå¯èƒ½ã§ã™</div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-action btn-close" onclick="closeAudioPlayer()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- cronç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="cronEditModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>â° äºˆç´„ã‚’ç·¨é›†</h2>
                <button class="modal-close" onclick="closeCronEditModal()">&times;</button>
            </div>

            <!-- ç•ªçµ„æƒ…å ± -->
            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #495057;">ğŸ“º ç•ªçµ„æƒ…å ±</label>
                <div style="margin-bottom: 10px;">
                    <label style="font-size: 0.85em; color: #6c757d;">ç•ªçµ„å</label>
                    <input type="text" id="editProgramTitle" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                </div>
                <div style="font-size: 0.85em; color: #6c757d;" id="editProgramStation">æ”¾é€å±€</div>
            </div>

            <!-- éŒ²éŸ³æ™‚é–“è¨­å®š -->
            <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #495057;">ğŸ“¡ éŒ²éŸ³æ™‚é–“</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label style="font-size: 0.85em; color: #6c757d;">é–‹å§‹æ™‚åˆ» (HH:MM)</label>
                            <input type="time" id="editStartTime" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="font-size: 0.85em; color: #6c757d;">çµ‚äº†æ™‚åˆ» (HH:MM)</label>
                            <input type="time" id="editEndTime" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°è¨­å®š -->
            <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #495057;">â° å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                        <div>
                            <label style="font-size: 0.85em; color: #6c757d;">åˆ† (0-59)</label>
                            <input type="number" id="editMinute" min="0" max="59" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="font-size: 0.85em; color: #6c757d;">æ™‚ (0-23)</label>
                            <input type="number" id="editHour" min="0" max="23" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="font-size: 0.85em; color: #6c757d;">å®Ÿè¡Œé »åº¦</label>
                            <select id="editDayOfWeek" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                                <option value="*">æ¯æ—¥</option>
                                <option value="0">æ—¥æ›œæ—¥</option>
                                <option value="1">æœˆæ›œæ—¥</option>
                                <option value="2">ç«æ›œæ—¥</option>
                                <option value="3">æ°´æ›œæ—¥</option>
                                <option value="4">æœ¨æ›œæ—¥</option>
                                <option value="5">é‡‘æ›œæ—¥</option>
                                <option value="6">åœŸæ›œæ—¥</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div style="padding: 10px; background: #e7f3ff; border-radius: 4px; border-left: 4px solid #667eea;">
                    <div style="font-size: 0.9em; color: #0056b3; font-weight: 600;" id="cronPreview">
                        å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°: -
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #495057;">ğŸ¯ å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰</label>
                <textarea id="editCommandPreview" style="width: 100%; min-height: 120px; font-family: 'Courier New', monospace; font-size: 0.85em; color: #495057; background: #f8f9fa; padding: 12px; border: 1px solid #dee2e6; border-radius: 4px; resize: vertical; line-height: 1.6;" placeholder="cronã‚³ãƒãƒ³ãƒ‰"></textarea>
                <div style="font-size: 0.8em; color: #6c757d; margin-top: 5px;">
                    ğŸ’¡ ã‚³ãƒãƒ³ãƒ‰ã‚’ç›´æ¥ç·¨é›†ã§ãã¾ã™ã€‚éŒ²éŸ³æ™‚é–“ã‚’ç´°ã‹ãèª¿æ•´ã—ãŸã„å ´åˆãªã©ã«ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-action" onclick="saveCronEdit()" style="background: #28a745; color: white;">ğŸ’¾ ä¿å­˜</button>
                <button class="btn btn-action btn-close" onclick="closeCronEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <script>
        let currentCommand = '';
        let currentProgramData = null;
        let allProgramsData = [];
        let eventSource = null;
        let currentEditingCron = { original: '', commandPart: '' };
        // ç•ªçµ„è¡¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆã‚¨ãƒªã‚¢ID + æ—¥ä»˜ã‚’ã‚­ãƒ¼ã«ã™ã‚‹ï¼‰
        // å„ã‚¨ãƒ³ãƒˆãƒªã¯ { data: [...], timestamp: Date } ã®å½¢å¼
        const programCache = new Map();
        const CACHE_EXPIRE_MS = 30 * 60 * 1000; // 30åˆ†ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœŸé™åˆ‡ã‚Œ

        // localStorageã‹ã‚‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’èª­ã¿è¾¼ã‚€
        function loadCacheFromStorage() {
            try {
                const stored = localStorage.getItem('radikoCache');
                console.log('localStorageèª­ã¿è¾¼ã¿é–‹å§‹');
                if (stored) {
                    const cacheData = JSON.parse(stored);
                    console.log('localStorageå†…ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥:', Object.keys(cacheData));
                    Object.entries(cacheData).forEach(([key, value]) => {
                        // Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å¾©å…ƒ
                        if (value.data) {
                            value.data.forEach(prog => {
                                prog.ft = new Date(prog.ft);
                                prog.to = new Date(prog.to);
                            });
                        }
                        programCache.set(key, value);
                    });
                    console.log(`âœ… localStorageã‹ã‚‰${programCache.size}ä»¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’èª­ã¿è¾¼ã¿`);
                } else {
                    console.log('localStorage: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—');
                }
            } catch (err) {
                console.error('âŒ ã‚­ãƒ£ãƒƒã‚·ãƒ¥èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
            }
        }

        // localStorageã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿å­˜
        function saveCacheToStorage() {
            try {
                const cacheData = {};
                programCache.forEach((value, key) => {
                    cacheData[key] = value;
                });
                localStorage.setItem('radikoCache', JSON.stringify(cacheData));
            } catch (err) {
                console.error('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜ã‚¨ãƒ©ãƒ¼:', err);
            }
        }

        // å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ã™ã‚‹é–¢æ•°
        function clearOldCache() {
            console.log('ğŸ§¹ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–‹å§‹');
            console.log(`ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‰ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ•°: ${programCache.size}ä»¶`);

            const now = new Date();
            const today = new Date(now);

            // æœ5æ™‚æœªæº€ã®å ´åˆã¯å‰æ—¥ã¨ã—ã¦æ‰±ã†
            if (today.getHours() < 5) {
                today.setDate(today.getDate() - 1);
            }

            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            console.log(`åŸºæº–æ—¥: ${todayStr} (æœ5æ™‚åŸºæº–)`);

            // 8æ—¥ä»¥ä¸Šå‰ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ï¼ˆéå»7æ—¥é–“ã¯ä¿æŒï¼‰
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const sevenDaysAgoStr = `${sevenDaysAgo.getFullYear()}-${String(sevenDaysAgo.getMonth() + 1).padStart(2, '0')}-${String(sevenDaysAgo.getDate()).padStart(2, '0')}`;
            console.log(`ä¿æŒæœŸé–“: ${sevenDaysAgoStr} ã€œ ${todayStr}`);

            // å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€ã¾ãŸã¯æœŸé™åˆ‡ã‚Œã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤
            const keysToDelete = [];
            programCache.forEach((value, key) => {
                // ã‚­ãƒ¼ã®å½¢å¼: "JP27_2025-01-23" ã¾ãŸã¯ "JP27_now"
                const parts = key.split('_');
                if (parts.length === 2) {
                    const date = parts[1];

                    // 8æ—¥ä»¥ä¸Šå‰ã®æ—¥ä»˜ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯å‰Šé™¤
                    if (date !== 'now' && date < sevenDaysAgoStr) {
                        console.log(`  å‰Šé™¤ç†ç”±: 8æ—¥ä»¥ä¸Šå‰ - ${key} (${date} < ${sevenDaysAgoStr})`);
                        keysToDelete.push({ key, reason: '8æ—¥ä»¥ä¸Šå‰' });
                        return;
                    }

                    // æœŸé™åˆ‡ã‚Œï¼ˆ30åˆ†ä»¥ä¸ŠçµŒéï¼‰ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚å‰Šé™¤
                    if (!isCacheValid(value)) {
                        const age = Math.floor((Date.now() - value.timestamp) / 60000);
                        console.log(`  å‰Šé™¤ç†ç”±: æœŸé™åˆ‡ã‚Œ - ${key} (${age}åˆ†çµŒé)`);
                        keysToDelete.push({ key, reason: `æœŸé™åˆ‡ã‚Œ(${age}åˆ†)` });
                        return;
                    }

                    // æœ‰åŠ¹ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥
                    const age = Math.floor((Date.now() - value.timestamp) / 60000);
                    console.log(`  ä¿æŒ: ${key} (${age}åˆ†çµŒé, æœ‰åŠ¹æœŸé™å†…)`);
                }
            });

            keysToDelete.forEach(item => {
                programCache.delete(item.key);
                console.log(`âŒ å‰Šé™¤: ${item.key} (${item.reason})`);
            });

            if (keysToDelete.length > 0) {
                console.log(`âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†: ${keysToDelete.length}ä»¶å‰Šé™¤`);
                // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¾Œã«localStorageã‚’æ›´æ–°
                saveCacheToStorage();
            } else {
                console.log('âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—: å‰Šé™¤å¯¾è±¡ãªã—');
            }
            console.log(`ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¾Œã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ•°: ${programCache.size}ä»¶`);
        }

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•°
        function isCacheValid(cacheEntry) {
            if (!cacheEntry || !cacheEntry.timestamp) {
                return false;
            }
            const now = Date.now();
            const age = now - cacheEntry.timestamp;
            return age < CACHE_EXPIRE_MS;
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tabName) {
            // å…¨ã¦ã®ã‚¿ãƒ–ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            if (tabName === 'search') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('searchTab').classList.add('active');
            } else if (tabName === 'files') {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('filesTab').classList.add('active');
                // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ãƒ–ã‚’é–‹ã„ãŸæ™‚ã«è‡ªå‹•èª­ã¿è¾¼ã¿
                loadRecordedFiles();
            } else if (tabName === 'cron') {
                document.querySelectorAll('.tab')[2].classList.add('active');
                document.getElementById('cronTab').classList.add('active');
                // cronã‚¿ãƒ–ã‚’é–‹ã„ãŸæ™‚ã«è‡ªå‹•èª­ã¿è¾¼ã¿
                loadCronJobs();
            } else if (tabName === 'at') {
                document.querySelectorAll('.tab')[3].classList.add('active');
                document.getElementById('atTab').classList.add('active');
                // atäºˆç´„ã‚¿ãƒ–ã‚’é–‹ã„ãŸæ™‚ã«è‡ªå‹•èª­ã¿è¾¼ã¿
                loadAtJobs();
            }
        }

        // ä»Šæ—¥ã®æ—¥ä»˜ã¨ã‚¨ãƒªã‚¢ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’è¨­å®š
        document.addEventListener('DOMContentLoaded', function() {
            // localStorageã‹ã‚‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’èª­ã¿è¾¼ã¿
            loadCacheFromStorage();

            // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
            clearOldCache();

            // æ—¥æœ¬æ™‚é–“ã§ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—ï¼ˆæœ5æ™‚ã‚’æ—¥ä»˜ã®å¤‰ã‚ã‚Šç›®ã¨ã™ã‚‹ï¼‰
            const now = new Date();
            const today = new Date(now);

            // æœ5æ™‚æœªæº€ã®å ´åˆã¯å‰æ—¥ã¨ã—ã¦æ‰±ã†
            if (today.getHours() < 5) {
                today.setDate(today.getDate() - 1);
            }

            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;

            document.getElementById('targetDate').value = dateStr;

            // 1é€±é–“åˆ†ã®æ—¥ä»˜ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
            const dateButtonsContainer = document.getElementById('dateButtons');
            const dayLabels = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];

            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);

                const btnYear = date.getFullYear();
                const btnMonth = String(date.getMonth() + 1).padStart(2, '0');
                const btnDay = String(date.getDate()).padStart(2, '0');
                const btnDateStr = `${btnYear}-${btnMonth}-${btnDay}`;
                const dayOfWeek = dayLabels[date.getDay()];

                const button = document.createElement('button');
                button.type = 'button';
                button.textContent = `${btnMonth}/${btnDay}(${dayOfWeek})`;
                button.dataset.date = btnDateStr;

                // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
                if (i === 0) {
                    button.style.cssText = 'padding: 4px 8px; border: 1px solid #667eea; background: #667eea; color: white; border-radius: 4px; font-size: 0.8em; cursor: pointer; transition: all 0.15s;';
                } else {
                    button.style.cssText = 'padding: 4px 8px; border: 1px solid #ced4da; background: #f8f9fa; color: #6c757d; border-radius: 4px; font-size: 0.8em; cursor: pointer; transition: all 0.15s;';
                }

                button.addEventListener('click', async function() {
                    // ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
                    dateButtonsContainer.querySelectorAll('button').forEach(btn => {
                        btn.style.cssText = 'padding: 4px 8px; border: 1px solid #ced4da; background: #f8f9fa; color: #6c757d; border-radius: 4px; font-size: 0.8em; cursor: pointer; transition: all 0.15s;';
                    });

                    // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
                    this.style.cssText = 'padding: 4px 8px; border: 1px solid #667eea; background: #667eea; color: white; border-radius: 4px; font-size: 0.8em; cursor: pointer; transition: all 0.15s;';

                    // éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«æ—¥ä»˜ã‚’è¨­å®š
                    document.getElementById('targetDate').value = this.dataset.date;

                    // ç•ªçµ„è¡¨ã‚’è‡ªå‹•å–å¾—
                    await fetchPrograms();
                });

                dateButtonsContainer.appendChild(button);

                // æœ€åˆã®ãƒœã‚¿ãƒ³ï¼ˆä»Šæ—¥ï¼‰ã®å ´åˆã€åˆæœŸè¡¨ç¤ºç”¨ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¿å­˜
                if (i === 0) {
                    // DOMContentLoadedå®Œäº†å¾Œã«è‡ªå‹•ã§ç•ªçµ„è¡¨ã‚’å–å¾—
                    setTimeout(() => {
                        button.click();
                    }, 100);
                }
            }

            // ã‚¨ãƒªã‚¢ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’å¤§é˜ªã«è¨­å®š
            document.getElementById('areaId').value = 'JP27';
        });

        // ã€Œç•ªçµ„è¡¨ã‚’å–å¾—ã€ãƒœã‚¿ãƒ³ã¯å¼·åˆ¶æ›´æ–°
        document.getElementById('fetchBtn').addEventListener('click', () => fetchPrograms(true));
        document.getElementById('searchAllBtn').addEventListener('click', searchAllAreas);

        // å†å–å¾—ãƒœã‚¿ãƒ³ï¼ˆãã®æ—¥ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã¿ã‚¯ãƒªã‚¢ï¼‰
        document.getElementById('clearCacheBtn').addEventListener('click', function() {
            const areaId = document.getElementById('areaId').value;
            const targetDate = document.getElementById('targetDate').value;

            if (!areaId || !targetDate) {
                alert('ã‚¨ãƒªã‚¢ã¨æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const cacheKey = `${areaId}_${targetDate}`;

            if (confirm('ã“ã®æ—¥ã®ç•ªçµ„è¡¨ã‚’å†å–å¾—ã—ã¾ã™ã‹ï¼Ÿ')) {
                // ãã®æ—¥ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã¿å‰Šé™¤
                if (programCache.has(cacheKey)) {
                    programCache.delete(cacheKey);
                    console.log(`âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤: ${cacheKey}`);
                    // localStorageã‚‚æ›´æ–°
                    saveCacheToStorage();
                }
                // ç•ªçµ„è¡¨ã‚’å†å–å¾—
                fetchPrograms(true);
            }
        });

        // ã‚¨ãƒªã‚¢é¸æŠå¤‰æ›´æ™‚ã«è‡ªå‹•å–å¾—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ©ç”¨ï¼‰
        document.getElementById('areaId').addEventListener('change', () => fetchPrograms(false));

        // æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›æ™‚ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        document.getElementById('searchKeyword').addEventListener('input', function() {
            if (allProgramsData.length > 0) {
                displayPrograms(allProgramsData);
            }
        });

        async function fetchPrograms(forceRefresh = false) {
            const areaId = document.getElementById('areaId').value;
            const proxyUrl = document.getElementById('proxyUrl').value;
            const targetDate = document.getElementById('targetDate').value;

            if (!areaId) {
                showError('ã‚¨ãƒªã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const programList = document.getElementById('programList');
            const fetchBtn = document.getElementById('fetchBtn');

            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã‚’ç”Ÿæˆï¼ˆã‚¨ãƒªã‚¢ID + æ—¥ä»˜ï¼‰
            const cacheKey = `${areaId}_${targetDate || 'now'}`;

            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã€å¼·åˆ¶æ›´æ–°ã§ãªã„å ´åˆã¯æœ‰åŠ¹æœŸé™ã‚’ãƒã‚§ãƒƒã‚¯
            if (!forceRefresh && programCache.has(cacheKey)) {
                const cacheEntry = programCache.get(cacheKey);
                if (isCacheValid(cacheEntry)) {
                    const age = Math.floor((Date.now() - cacheEntry.timestamp) / 1000);
                    console.log(`ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ç•ªçµ„è¡¨ã‚’èª­ã¿è¾¼ã¿: ${cacheKey} (${age}ç§’å‰ã«å–å¾—)`);
                    displayPrograms(cacheEntry.data);
                    return;
                } else {
                    console.log('ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœŸé™åˆ‡ã‚Œã€å†å–å¾—ã—ã¾ã™:', cacheKey);
                    programCache.delete(cacheKey);
                }
            }

            loading.style.display = 'block';
            error.style.display = 'none';
            programList.innerHTML = '';
            fetchBtn.disabled = true;

            try {
                // ãƒ—ãƒ­ã‚­ã‚·URLãŒç©ºæ¬„ã®å ´åˆã¯ç›´æ¥radikoã«ã‚¢ã‚¯ã‚»ã‚¹
                const baseUrl = proxyUrl.trim() ? `${proxyUrl}/radiko` : 'https://radiko.jp';
                let allPrograms = [];

                if (targetDate) {
                    // æ—¥ä»˜æŒ‡å®šã®å ´åˆ: ã¾ãšæ”¾é€å±€ä¸€è¦§ã‚’å–å¾—
                    const dateStr = targetDate.replace(/-/g, ''); // YYYYMMDDå½¢å¼ã«å¤‰æ›
                    const nowUrl = `${baseUrl}/v3/program/now/${areaId}.xml`;

                    console.log('Fetching station list:', nowUrl);
                    const nowResponse = await fetch(nowUrl);
                    if (!nowResponse.ok) {
                        throw new Error(`æ”¾é€å±€ä¸€è¦§ã®å–å¾—ã«å¤±æ•—: ${nowResponse.status}`);
                    }

                    const nowXmlText = await nowResponse.text();
                    const parser = new DOMParser();
                    const nowXmlDoc = parser.parseFromString(nowXmlText, 'text/xml');
                    const stations = nowXmlDoc.querySelectorAll('station');

                    // å„æ”¾é€å±€ã”ã¨ã«æ—¥ä»˜æŒ‡å®šã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                    const stationPromises = Array.from(stations).map(async (station) => {
                        const stationId = station.getAttribute('id');
                        const stationName = station.querySelector('name')?.textContent || 'Unknown';

                        try {
                            const stationUrl = `${baseUrl}/v3/program/station/date/${dateStr}/${stationId}.xml`;
                            console.log('Fetching:', stationUrl);
                            const response = await fetch(stationUrl);

                            if (!response.ok) {
                                console.warn(`${stationId} ã®ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—: ${response.status}`);
                                return [];
                            }

                            const xmlText = await response.text();
                            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                            const progs = xmlDoc.querySelectorAll('prog');

                            const programs = [];
                            progs.forEach(prog => {
                                const title = prog.querySelector('title')?.textContent || '';
                                const ftString = prog.getAttribute('ft');
                                const toString = prog.getAttribute('to');
                                const desc = prog.querySelector('desc')?.textContent || 'èª¬æ˜ãªã—';
                                const pfm = prog.querySelector('pfm')?.textContent || '';
                                const info = prog.querySelector('info')?.textContent || '';
                                const url = prog.querySelector('url')?.textContent || '';

                                if (ftString && toString) {
                                    programs.push({
                                        stationId,
                                        stationName,
                                        title,
                                        ft: parseRadikoTime(ftString),
                                        to: parseRadikoTime(toString),
                                        desc,
                                        pfm,
                                        info,
                                        url
                                    });
                                }
                            });
                            return programs;
                        } catch (err) {
                            console.warn(`${stationId} ã®å–å¾—ã‚¨ãƒ©ãƒ¼:`, err);
                            return [];
                        }
                    });

                    const results = await Promise.all(stationPromises);
                    allPrograms = results.flat();

                } else {
                    // æ—¥ä»˜æŒ‡å®šãªã—: ç¾åœ¨ã®ç•ªçµ„è¡¨ã‚’å–å¾—
                    const url = `${baseUrl}/v3/program/now/${areaId}.xml`;
                    console.log('Fetching URL:', url);
                    const response = await fetch(url);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const xmlText = await response.text();
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                    const stations = xmlDoc.querySelectorAll('station');

                    stations.forEach(station => {
                        const stationId = station.getAttribute('id');
                        const stationName = station.querySelector('name')?.textContent || 'Unknown';

                        const progs = station.querySelectorAll('prog');
                        progs.forEach(prog => {
                            const title = prog.querySelector('title')?.textContent || '';
                            const ftString = prog.getAttribute('ft');
                            const toString = prog.getAttribute('to');
                            const desc = prog.querySelector('desc')?.textContent || 'èª¬æ˜ãªã—';
                            const pfm = prog.querySelector('pfm')?.textContent || '';
                            const info = prog.querySelector('info')?.textContent || '';
                            const url = prog.querySelector('url')?.textContent || '';

                            if (ftString && toString) {
                                allPrograms.push({
                                    stationId,
                                    stationName,
                                    title,
                                    ft: parseRadikoTime(ftString),
                                    to: parseRadikoTime(toString),
                                    desc,
                                    pfm,
                                    info,
                                    url
                                });
                            }
                        });
                    });
                }

                allPrograms.sort((a, b) => a.ft - b.ft);

                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ãï¼‰
                programCache.set(cacheKey, {
                    data: allPrograms,
                    timestamp: Date.now()
                });
                console.log('ç•ªçµ„è¡¨ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜:', cacheKey, `(${allPrograms.length}ä»¶)`);

                // localStorageã«ã‚‚ä¿å­˜
                saveCacheToStorage();

                displayPrograms(allPrograms);

            } catch (err) {
                showError(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${err.message}`);
            } finally {
                loading.style.display = 'none';
                fetchBtn.disabled = false;
            }
        }

        function parseRadikoTime(timeStr) {
            const year = parseInt(timeStr.substring(0, 4), 10);
            const month = parseInt(timeStr.substring(4, 6), 10) - 1;
            const day = parseInt(timeStr.substring(6, 8), 10);
            const hour = parseInt(timeStr.substring(8, 10), 10);
            const minute = parseInt(timeStr.substring(10, 12), 10);
            const second = parseInt(timeStr.substring(12, 14), 10);
            return new Date(year, month, day, hour, minute, second);
        }

        function formatDateTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hour = String(date.getHours()).padStart(2, '0');
            const minute = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day} ${hour}:${minute}`;
        }

        function displayPrograms(programs) {
            const programList = document.getElementById('programList');
            programList.innerHTML = '';
            allProgramsData = programs;

            if (programs.length === 0) {
                programList.innerHTML = '<p class="loading">ç•ªçµ„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';
                return;
            }

            // æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const searchKeyword = document.getElementById('searchKeyword').value.trim().toLowerCase();
            const searchInfo = document.getElementById('searchInfo');
            let filteredPrograms = programs;

            if (searchKeyword) {
                filteredPrograms = programs.filter(prog =>
                    prog.title.toLowerCase().includes(searchKeyword) ||
                    (prog.pfm && prog.pfm.toLowerCase().includes(searchKeyword)) ||
                    (prog.desc && prog.desc.toLowerCase().includes(searchKeyword))
                );

                searchInfo.textContent = `ã€Œ${searchKeyword}ã€ã®æ¤œç´¢çµæœ: ${filteredPrograms.length}ä»¶ / å…¨${programs.length}ä»¶`;
                searchInfo.style.display = 'block';
            } else {
                searchInfo.style.display = 'none';
            }

            if (filteredPrograms.length === 0) {
                const noResultMsg = document.createElement('p');
                noResultMsg.className = 'loading';
                noResultMsg.style.gridColumn = '1 / -1';
                noResultMsg.textContent = `ã€Œ${searchKeyword}ã€ã«ä¸€è‡´ã™ã‚‹ç•ªçµ„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`;
                programList.appendChild(noResultMsg);
                return;
            }

            // æ—¥ä»˜ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼ˆæœ5æ™‚ã‚’æ—¥ä»˜ã®å¤‰ã‚ã‚Šç›®ã¨ã™ã‚‹ï¼‰
            const dateMap = new Map();
            filteredPrograms.forEach((prog, index) => {
                prog._index = programs.indexOf(prog); // å…ƒã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¿å­˜
                const progDate = new Date(prog.ft);

                // æœ5æ™‚æœªæº€ã®ç•ªçµ„ã¯å‰æ—¥ã¨ã—ã¦æ‰±ã†
                const displayDate = new Date(progDate);
                if (displayDate.getHours() < 5) {
                    displayDate.setDate(displayDate.getDate() - 1);
                }

                const dateKey = `${displayDate.getFullYear()}-${String(displayDate.getMonth() + 1).padStart(2, '0')}-${String(displayDate.getDate()).padStart(2, '0')}`;

                if (!dateMap.has(dateKey)) {
                    dateMap.set(dateKey, {
                        date: displayDate,
                        programs: []
                    });
                }
                dateMap.get(dateKey).programs.push(prog);
            });

            // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
            const sortedDates = Array.from(dateMap.keys()).sort();

            // æ—¥ä»˜ã”ã¨ã«è¡¨ç¤º
            sortedDates.forEach(dateKey => {
                const dateGroup = dateMap.get(dateKey);
                const programDate = dateGroup.date;
                const year = programDate.getFullYear();
                const month = programDate.getMonth() + 1;
                const day = programDate.getDate();
                const dayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][programDate.getDay()];

                // æ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼
                const dateHeaderElement = document.createElement('div');
                dateHeaderElement.style.cssText = 'grid-column: 1 / -1; padding: 15px 20px; margin-bottom: 20px; margin-top: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); text-align: center;';
                dateHeaderElement.innerHTML = `
                    <div style="font-size: 1.3em; font-weight: bold; margin-bottom: 5px;">
                        ğŸ“… ${year}å¹´${month}æœˆ${day}æ—¥ï¼ˆ${dayOfWeek}ï¼‰
                    </div>
                    <div style="font-size: 0.9em; opacity: 0.95;">
                        ${dateGroup.programs.length}ä»¶ã®ç•ªçµ„
                    </div>
                `;
                programList.appendChild(dateHeaderElement);

                // ã“ã®æ—¥ä»˜ã®ç•ªçµ„ã‚’æ”¾é€å±€ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
                const stationMap = new Map();
                dateGroup.programs.forEach(prog => {
                    if (!stationMap.has(prog.stationId)) {
                        stationMap.set(prog.stationId, {
                            name: prog.stationName,
                            id: prog.stationId,
                            programs: []
                        });
                    }
                    stationMap.get(prog.stationId).programs.push(prog);
                });

                displayStations(stationMap, programList);
            });
        }

        function displayStations(stationMap, programList) {

            // å„æ”¾é€å±€ã®åˆ—ã‚’ä½œæˆ
            stationMap.forEach(station => {
                const column = document.createElement('div');
                column.className = 'station-column';

                const header = document.createElement('div');
                header.className = 'station-header';
                header.textContent = `${station.name} (${station.id})`;
                column.appendChild(header);

                const programsContainer = document.createElement('div');
                programsContainer.className = 'station-programs';

                const now = new Date();

                // æ™‚åˆ»é †ã«ã‚½ãƒ¼ãƒˆ
                station.programs.sort((a, b) => a.ft - b.ft);

                station.programs.forEach(prog => {
                    const card = document.createElement('div');
                    card.className = 'program-card';

                    // æ”¾é€ä¸­ã®ç•ªçµ„ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                    if (prog.ft <= now && prog.to > now) {
                        card.classList.add('now-playing');
                    }

                    const startTime = `${String(prog.ft.getHours()).padStart(2, '0')}:${String(prog.ft.getMinutes()).padStart(2, '0')}`;
                    const endTime = `${String(prog.to.getHours()).padStart(2, '0')}:${String(prog.to.getMinutes()).padStart(2, '0')}`;

                    // ç•ªçµ„ãŒçµ‚äº†ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    const isPastProgram = prog.to < now;
                    const isFutureProgram = prog.ft > now;

                    // radikoã®URL
                    const radikoTime = formatRadikoUrl(prog.ft);
                    const radikoUrl = `https://radiko.jp/#!/ts/${prog.stationId}/${radikoTime}`;

                    // ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
                    let buttonsHtml = '';

                    // çµ‚äº†æ¸ˆã¿ç•ªçµ„ï¼šãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
                    if (isPastProgram) {
                        buttonsHtml += `<button class="btn-action btn-download" onclick='showDownloadCommandByIndex(${prog._index})'>DL</button>`;
                    }

                    // æœªæ¥ã®ç•ªçµ„ï¼šäºˆç´„ãƒœã‚¿ãƒ³
                    if (isFutureProgram) {
                        buttonsHtml += `<button class="btn-action btn-at" onclick='showAtCommandByIndex(${prog._index})'>äºˆç´„</button>`;
                    }

                    // å®šæœŸéŒ²éŸ³ãƒœã‚¿ãƒ³ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰
                    buttonsHtml += `<button class="btn-action btn-cron" onclick='showCronCommandByIndex(${prog._index})'>å®šæœŸ</button>`;

                    // radikoãƒœã‚¿ãƒ³ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰
                    buttonsHtml += `<a href="${radikoUrl}" target="_blank" rel="noopener noreferrer" style="background: white; border: 1px solid #ddd; padding: 3px; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; line-height: 1; border-radius: 4px; width: 24px; height: 24px;" title="radikoã§è´ã"><img src="img/radiko.png" alt="radiko" style="width: 18px; height: 18px; display: block;"></a>`;

                    card.innerHTML = `
                        <div class="program-time">${startTime} - ${endTime}</div>
                        <div class="program-title" onclick='showProgramDetailByIndex(${prog._index})' style="cursor: pointer; color: #007bff;">${prog.title}</div>
                        ${prog.pfm ? `<div class="program-detail">${prog.pfm}</div>` : ''}
                        <div class="program-actions">
                            ${buttonsHtml}
                        </div>
                    `;

                    programsContainer.appendChild(card);
                });

                column.appendChild(programsContainer);
                programList.appendChild(column);
            });
        }

        function showCronCommandByIndex(index) {
            showCronCommand(allProgramsData[index]);
        }

        function showDownloadCommandByIndex(index) {
            showDownloadCommand(allProgramsData[index]);
        }

        function showAtCommandByIndex(index) {
            showAtCommand(allProgramsData[index]);
        }

        function showProgramDetailByIndex(index) {
            showProgramDetail(allProgramsData[index]);
        }

        function cleanupDescription(text) {
            if (!text) return '';

            // &nbsp;ã‚’é€šå¸¸ã®ã‚¹ãƒšãƒ¼ã‚¹ã«å¤‰æ›
            let cleaned = text.replace(/&nbsp;/gi, ' ');

            // é€£ç¶šã™ã‚‹<br>ã‚’1ã¤ã®æ”¹è¡Œã«å¤‰æ›
            cleaned = cleaned.replace(/(<br\s*\/?>)+/gi, '\n');

            // é€£ç¶šã™ã‚‹ç©ºè¡Œã‚’1ã¤ã«
            cleaned = cleaned.replace(/\n{3,}/g, '\n\n');

            // é€£ç¶šã™ã‚‹ã‚¹ãƒšãƒ¼ã‚¹ã‚’1ã¤ã«
            cleaned = cleaned.replace(/ {2,}/g, ' ');

            // å‰å¾Œã®ç©ºç™½ã‚’å‰Šé™¤
            cleaned = cleaned.trim();

            return cleaned;
        }

        function showProgramDetail(prog) {
            const startTime = `${String(prog.ft.getHours()).padStart(2, '0')}:${String(prog.ft.getMinutes()).padStart(2, '0')}`;
            const endTime = `${String(prog.to.getHours()).padStart(2, '0')}:${String(prog.to.getMinutes()).padStart(2, '0')}`;
            const dateStr = `${prog.ft.getFullYear()}/${prog.ft.getMonth() + 1}/${prog.ft.getDate()}`;

            // radikoã®ç•ªçµ„ãƒšãƒ¼ã‚¸URLï¼ˆç§’ã¾ã§å«ã‚€14æ¡å½¢å¼ï¼‰
            const radikoTime = formatRadikoUrl(prog.ft);
            const radikoUrl = `https://radiko.jp/#!/ts/${prog.stationId}/${radikoTime}`;

            // ç•ªçµ„èª¬æ˜ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            const cleanDesc = cleanupDescription(prog.desc);

            let detailHtml = `
                <div style="font-size: 14px; line-height: 1.6; color: #333;">
                    <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #ddd;">
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">${prog.title}</div>
                        <div style="color: #666; font-size: 13px; margin-bottom: 8px;">
                            <div>${prog.stationName} (${prog.stationId})</div>
                            <div>${dateStr} ${startTime} - ${endTime}</div>
                        </div>
                        <div>
                            <a href="${radikoUrl}" target="_blank" rel="noopener noreferrer"
                               style="display: inline-block; padding: 8px 16px; background: #667eea; color: white; text-decoration: none; border-radius: 6px; font-size: 13px; font-weight: 600;">
                                ğŸ“» radikoã§è´ã
                            </a>
                        </div>
                    </div>
            `;

            if (prog.pfm) {
                const cleanPfm = cleanupDescription(prog.pfm);
                detailHtml += `
                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: bold; margin-bottom: 4px; font-size: 13px; color: #555;">å‡ºæ¼”è€…</div>
                        <div style="padding: 8px 10px; background: #f5f5f5; border-left: 3px solid #007bff; font-size: 13px; white-space: pre-line;">${cleanPfm}</div>
                    </div>
                `;
            }

            if (cleanDesc && cleanDesc !== 'èª¬æ˜ãªã—') {
                // ãƒ†ãƒ³ãƒãƒ©ãƒªè¦ç´ ã§HTMLã‚’ãƒ‘ãƒ¼ã‚¹
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = cleanDesc;

                detailHtml += `
                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: bold; margin-bottom: 4px; font-size: 13px; color: #555;">ç•ªçµ„èª¬æ˜</div>
                        <div style="padding: 8px 10px; background: #f5f5f5; border-left: 3px solid #007bff; font-size: 13px; line-height: 1.8; white-space: pre-line;">${tempDiv.innerHTML}</div>
                    </div>
                `;
            }

            if (prog.url) {
                detailHtml += `
                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: bold; margin-bottom: 4px; font-size: 13px; color: #555;">URL</div>
                        <div style="padding: 8px 10px; background: #f5f5f5; border-left: 3px solid #007bff; font-size: 13px; word-break: break-all;">
                            <a href="${prog.url}" target="_blank" style="color: #007bff; text-decoration: none;">${prog.url}</a>
                        </div>
                    </div>
                `;
            }

            if (prog.info) {
                const cleanInfo = cleanupDescription(prog.info);
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = cleanInfo;

                detailHtml += `
                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: bold; margin-bottom: 4px; font-size: 13px; color: #555;">ãã®ä»–æƒ…å ±</div>
                        <div style="padding: 8px 10px; background: #f5f5f5; border-left: 3px solid #007bff; font-size: 12px; color: #666; line-height: 1.8; white-space: pre-line;">${tempDiv.innerHTML}</div>
                    </div>
                `;
            }

            detailHtml += '</div>';

            currentCommand = ''; // ã‚³ãƒãƒ³ãƒ‰ã¯ã‚¯ãƒªã‚¢ã™ã‚‹
            document.getElementById('modalTitle').textContent = 'ç•ªçµ„è©³ç´°';
            document.getElementById('commandBox').innerHTML = detailHtml;
            document.getElementById('modal').classList.add('active');
        }

        function showCronCommand(prog) {
            const scriptPath = document.getElementById('scriptPath').value;
            const startTime = new Date(prog.ft);
            const endTime = new Date(prog.to);

            // cronå®Ÿè¡Œæ™‚åˆ»ï¼ˆç•ªçµ„çµ‚äº†ã®5åˆ†å¾Œï¼‰
            const cronExecTime = new Date(prog.to);
            cronExecTime.setMinutes(cronExecTime.getMinutes() + 5);
            const minute = cronExecTime.getMinutes();
            const hour = cronExecTime.getHours();
            const dayOfWeek = cronExecTime.getDay();

            // é–‹å§‹æ™‚åˆ»ã¨çµ‚äº†æ™‚åˆ»ï¼ˆæ™‚åˆ†ã®ã¿ã€ç•ªçµ„è¡¨é€šã‚Šï¼‰
            const startHHMM = `${String(startTime.getHours()).padStart(2, '0')}${String(startTime.getMinutes()).padStart(2, '0')}`;
            const endHHMM = `${String(endTime.getHours()).padStart(2, '0')}${String(endTime.getMinutes()).padStart(2, '0')}`;

            // éŒ²éŸ³é–‹å§‹æ—¥ã¨cronå®Ÿè¡Œæ—¥ã®æ—¥ä»˜ã‚’æ¯”è¼ƒ
            // éŒ²éŸ³é–‹å§‹æ—¥ãŒcronå®Ÿè¡Œæ—¥ã¨ç•°ãªã‚‹å ´åˆã€é–‹å§‹æ—¥ã¯cronå®Ÿè¡Œæ—¥ã®å‰æ—¥
            const startDateStr = `${startTime.getFullYear()}-${String(startTime.getMonth()+1).padStart(2,'0')}-${String(startTime.getDate()).padStart(2,'0')}`;
            const cronExecDateStr = `${cronExecTime.getFullYear()}-${String(cronExecTime.getMonth()+1).padStart(2,'0')}-${String(cronExecTime.getDate()).padStart(2,'0')}`;
            const endDateStr = `${endTime.getFullYear()}-${String(endTime.getMonth()+1).padStart(2,'0')}-${String(endTime.getDate()).padStart(2,'0')}`;

            // é–‹å§‹æ—¥ãŒcronå®Ÿè¡Œæ—¥ã¨ç•°ãªã‚‹å ´åˆ
            const startNeedsYesterday = startDateStr !== cronExecDateStr;
            // çµ‚äº†æ—¥ãŒcronå®Ÿè¡Œæ—¥ã¨ç•°ãªã‚‹å ´åˆ
            const endNeedsYesterday = endDateStr !== cronExecDateStr;

            // æ—¥ä»˜è¨ˆç®—ã®éƒ¨åˆ†
            let startDateCalc = '';
            if (startNeedsYesterday) {
                // cronå®Ÿè¡Œæ—¥ã®å‰æ—¥ã‚’éŒ²éŸ³é–‹å§‹æ—¥ã¨ã™ã‚‹
                startDateCalc = '\`date -d yesterday +\\%Y\\%m\\%d\`';
            } else {
                // cronå®Ÿè¡Œæ—¥ã¨åŒã˜æ—¥ã‚’éŒ²éŸ³é–‹å§‹æ—¥ã¨ã™ã‚‹
                startDateCalc = '\`date +\\%Y\\%m\\%d\`';
            }

            // éŒ²éŸ³çµ‚äº†æ—¥ã®è¨ˆç®—
            let endDateCalc = '';
            if (endNeedsYesterday) {
                // cronå®Ÿè¡Œæ—¥ã®å‰æ—¥ã‚’éŒ²éŸ³çµ‚äº†æ—¥ã¨ã™ã‚‹
                endDateCalc = '\`date -d yesterday +\\%Y\\%m\\%d\`';
            } else {
                // cronå®Ÿè¡Œæ—¥ã¨åŒã˜æ—¥ã‚’éŒ²éŸ³çµ‚äº†æ—¥ã¨ã™ã‚‹
                endDateCalc = '\`date +\\%Y\\%m\\%d\`';
            }

            // cronã‚³ãƒãƒ³ãƒ‰ï¼ˆå‹•çš„ãªæ—¥ä»˜ã‚’ä½¿ç”¨ï¼‰
            const command = `${minute} ${hour} * * ${dayOfWeek} ${scriptPath} "${prog.title}" "${prog.stationId}" "${prog.stationId}" "${startDateCalc}${startHHMM}" "${endDateCalc}${endHHMM}" "" "" "" >> /tmp/myradiko_output.log 2>&1`;

            currentCommand = command;
            currentProgramData = prog; // ãƒ—ãƒ­ã‚°ãƒ©ãƒ æƒ…å ±ã‚’ä¿å­˜
            document.getElementById('modalTitle').textContent = `å®šæœŸéŒ²éŸ³ - ${prog.title}`;

            // å®Ÿè¡Œæ™‚åˆ»ã®èª¬æ˜ã‚’è¿½åŠ 
            const execTimeStr = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
            const daysOfWeekJp = ['æ—¥æ›œæ—¥', 'æœˆæ›œæ—¥', 'ç«æ›œæ—¥', 'æ°´æ›œæ—¥', 'æœ¨æ›œæ—¥', 'é‡‘æ›œæ—¥', 'åœŸæ›œæ—¥'];
            const dayLabel = daysOfWeekJp[dayOfWeek];

            const commandBoxContent = `
                <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 12px; margin-bottom: 15px; border-radius: 4px;">
                    <div style="font-weight: 600; color: #1976d2; margin-bottom: 4px;">â° å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°</div>
                    <div style="color: #555; font-size: 0.95em;">æ¯é€±${dayLabel} ${execTimeStr} ã«å®Ÿè¡Œï¼ˆç•ªçµ„çµ‚äº†ã®5åˆ†å¾Œï¼‰</div>
                </div>
                <div style="font-family: 'Courier New', monospace; background: #f8f9fa; padding: 12px; border-radius: 4px; font-size: 0.9em; white-space: pre-wrap; word-break: break-all;">${command}</div>
            `;

            document.getElementById('commandBox').innerHTML = commandBoxContent;
            document.getElementById('executeBtn').style.display = 'none';

            // cronç™»éŒ²ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            const registerBtn = document.getElementById('registerCronBtn');
            if (registerBtn) {
                registerBtn.style.display = 'inline-block';
                registerBtn.onclick = () => addCronJob(command);
            }

            document.getElementById('modal').classList.add('active');
        }

        async function showDownloadCommand(prog) {
            const scriptPath = document.getElementById('scriptPath').value;
            const endTime = new Date(prog.to);
            endTime.setMinutes(endTime.getMinutes() + 5);

            const startStr = formatRadikoTime(new Date(prog.ft));
            const endStr = formatRadikoTime(endTime);

            const command = `${scriptPath} -s ${startStr} -e ${endStr} -i ${prog.stationId}`;

            currentCommand = command;
            currentProgramData = prog; // å®Ÿè¡Œç”¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            document.getElementById('modalTitle').textContent = `ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ - ${prog.title}`;

            // ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
            const fileCheck = await checkFileExists(prog);

            let commandBoxContent = command;

            if (fileCheck && fileCheck.exists) {
                const proxyUrl = document.getElementById('proxyUrl').value;
                const baseUrl = proxyUrl.trim() ? proxyUrl : 'http://localhost:8080';
                const downloadUrl = `${baseUrl}/download/${fileCheck.path}`;

                commandBoxContent = `
                    <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <div style="color: #856404; font-weight: bold; margin-bottom: 8px; font-size: 1.1em;">âš ï¸ ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ—¢ã«éŒ²éŸ³æ¸ˆã¿ã§ã™</div>
                        <div style="color: #856404; font-size: 0.9em; margin-bottom: 10px;">ãƒ•ã‚¡ã‚¤ãƒ«å: ${fileCheck.filename}</div>
                        <a href="${downloadUrl}" download="${fileCheck.filename}"
                           style="display: inline-block; padding: 8px 16px; background: #667eea; color: white; text-decoration: none; border-radius: 4px; font-weight: 600; font-size: 0.9em;">
                            ğŸ“¥ æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                        </a>
                    </div>
                    <div style="font-family: 'Courier New', monospace; background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 0.9em; color: #6c757d;">
                        ${command}
                    </div>
                    <div style="margin-top: 10px; font-size: 0.85em; color: #856404;">
                        â€» ã€Œå®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™
                    </div>
                `;
            } else {
                commandBoxContent = `<div style="font-family: 'Courier New', monospace; background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 0.9em;">${command}</div>`;
            }

            document.getElementById('commandBox').innerHTML = commandBoxContent;
            document.getElementById('executeBtn').style.display = 'inline-block';
            document.getElementById('modal').classList.add('active');
        }

        async function showAtCommand(prog) {
            const scriptPath = document.getElementById('scriptPath').value;
            const startTime = new Date(prog.ft);
            const endTime = new Date(prog.to);

            // atå®Ÿè¡Œæ™‚åˆ»ï¼ˆç•ªçµ„çµ‚äº†ã®5åˆ†å¾Œï¼‰
            const atExecTime = new Date(prog.to);
            atExecTime.setMinutes(atExecTime.getMinutes() + 5);

            // é–‹å§‹æ™‚åˆ»ã¨çµ‚äº†æ™‚åˆ»ï¼ˆYYYYMMDDHHmmå½¢å¼ï¼‰
            const startStr = formatRadikoTime(startTime);
            const endStr = formatRadikoTime(endTime);

            // atå®Ÿè¡Œæ™‚åˆ»
            const atTime = `${String(atExecTime.getHours()).padStart(2, '0')}:${String(atExecTime.getMinutes()).padStart(2, '0')} ${atExecTime.getFullYear()}-${String(atExecTime.getMonth() + 1).padStart(2, '0')}-${String(atExecTime.getDate()).padStart(2, '0')}`;

            // cronã¨åŒã˜å½¢å¼ã®ã‚³ãƒãƒ³ãƒ‰
            const command = `echo '${scriptPath} "${prog.title}" "${prog.stationId}" "${prog.stationId}" "${startStr}" "${endStr}" "" "" "" >> /tmp/myradiko_output.log 2>&1' | at ${atTime}`;

            currentCommand = command;
            currentProgramData = prog; // å®Ÿè¡Œç”¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            document.getElementById('modalTitle').textContent = `äºˆç´„ - ${prog.title}`;

            // ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
            const fileCheck = await checkFileExists(prog);

            let commandBoxContent = command;

            if (fileCheck && fileCheck.exists) {
                const proxyUrl = document.getElementById('proxyUrl').value;
                const baseUrl = proxyUrl.trim() ? proxyUrl : 'http://localhost:8080';
                const downloadUrl = `${baseUrl}/download/${fileCheck.path}`;

                commandBoxContent = `
                    <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <div style="color: #856404; font-weight: bold; margin-bottom: 8px; font-size: 1.1em;">âš ï¸ ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ—¢ã«éŒ²éŸ³æ¸ˆã¿ã§ã™</div>
                        <div style="color: #856404; font-size: 0.9em; margin-bottom: 10px;">ãƒ•ã‚¡ã‚¤ãƒ«å: ${fileCheck.filename}</div>
                        <a href="${downloadUrl}" download="${fileCheck.filename}"
                           style="display: inline-block; padding: 8px 16px; background: #667eea; color: white; text-decoration: none; border-radius: 4px; font-weight: 600; font-size: 0.9em;">
                            ğŸ“¥ æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                        </a>
                    </div>
                    <div style="font-family: 'Courier New', monospace; background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 0.9em; color: #6c757d;">
                        ${command}
                    </div>
                    <div style="margin-top: 10px; font-size: 0.85em; color: #856404;">
                        â€» ã€Œå®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™
                    </div>
                `;
            } else {
                // å®Ÿè¡Œäºˆå®šæ™‚åˆ»ã‚’è¡¨ç¤º
                const execTimeStr = `${String(atExecTime.getHours()).padStart(2, '0')}:${String(atExecTime.getMinutes()).padStart(2, '0')}`;
                const execDateStr = `${atExecTime.getFullYear()}/${atExecTime.getMonth() + 1}/${atExecTime.getDate()}`;

                commandBoxContent = `
                    <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 12px; margin-bottom: 15px; border-radius: 4px;">
                        <div style="font-weight: 600; color: #1976d2; margin-bottom: 4px;">â° å®Ÿè¡Œäºˆå®šæ™‚åˆ»</div>
                        <div style="color: #555; font-size: 0.95em;">${execDateStr} ${execTimeStr}ï¼ˆç•ªçµ„çµ‚äº†ã®5åˆ†å¾Œï¼‰</div>
                    </div>
                    <div style="font-family: 'Courier New', monospace; background: #f8f9fa; padding: 12px; border-radius: 4px; font-size: 0.9em; white-space: pre-wrap; word-break: break-all;">${command}</div>
                `;
            }

            document.getElementById('commandBox').innerHTML = commandBoxContent;
            document.getElementById('executeBtn').style.display = 'inline-block';
            document.getElementById('modal').classList.add('active');
        }

        function formatRadikoTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hour = String(date.getHours()).padStart(2, '0');
            const minute = String(date.getMinutes()).padStart(2, '0');
            // rec_radiko_ts.shã¯12æ¡ï¼ˆç§’ãªã—ï¼‰ã‚’æœŸå¾…
            return `${year}${month}${day}${hour}${minute}`;
        }

        function formatRadikoUrl(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hour = String(date.getHours()).padStart(2, '0');
            const minute = String(date.getMinutes()).padStart(2, '0');
            const second = String(date.getSeconds()).padStart(2, '0');
            // radikoã®URLã¯14æ¡ï¼ˆç§’ã¾ã§å«ã‚€ï¼‰ã‚’æœŸå¾…
            return `${year}${month}${day}${hour}${minute}${second}`;
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            document.getElementById('registerCronBtn').style.display = 'none';
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
        }

        async function executeCommand() {
            if (!currentProgramData) {
                alert('å®Ÿè¡Œå¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            const prog = currentProgramData;

            // éŒ²éŸ³ã¯ç•ªçµ„é–‹å§‹ã‹ã‚‰çµ‚äº†ã¾ã§
            const startStr = formatRadikoTime(new Date(prog.ft));
            const endStr = formatRadikoTime(new Date(prog.to));

            // atå®Ÿè¡Œæ™‚åˆ»ã¯ç•ªçµ„çµ‚äº†ã®5åˆ†å¾Œ
            const atExecTime = new Date(prog.to);
            atExecTime.setMinutes(atExecTime.getMinutes() + 5);

            // currentCommandã‹ã‚‰atäºˆç´„ã‹ã©ã†ã‹ã‚’åˆ¤å®š
            const isAtCommand = currentCommand.includes('| at ');

            const executeBtn = document.getElementById('executeBtn');
            executeBtn.disabled = true;
            executeBtn.textContent = 'å®Ÿè¡Œä¸­...';

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() ? `${proxyUrl}` : 'http://localhost:8080';

            // atäºˆç´„ã®å ´åˆ
            if (isAtCommand) {
                const scriptPath = document.getElementById('scriptPath').value;
                const atTime = `${String(atExecTime.getHours()).padStart(2, '0')}:${String(atExecTime.getMinutes()).padStart(2, '0')} ${atExecTime.getFullYear()}-${String(atExecTime.getMonth() + 1).padStart(2, '0')}-${String(atExecTime.getDate()).padStart(2, '0')}`;

                try {
                    const response = await fetch(`${baseUrl}/schedule-at`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            script_path: scriptPath,
                            title: prog.title,
                            start_time: startStr,
                            end_time: endStr,
                            station_id: prog.stationId,
                            at_time: atTime
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        alert(`âœ… atäºˆç´„ã‚’ç™»éŒ²ã—ã¾ã—ãŸ\n\nå®Ÿè¡Œäºˆå®š: ${atTime}\n\n${data.output || ''}`);
                        closeModal();
                    } else {
                        alert(`âŒ atäºˆç´„ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ\n\n${data.error || 'Unknown error'}`);
                    }
                } catch (err) {
                    console.error('at schedule error:', err);
                    alert(`âŒ atäºˆç´„ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ\n\n${err.message}`);
                } finally {
                    executeBtn.disabled = false;
                    executeBtn.textContent = 'å®Ÿè¡Œ';
                }
                return;
            }

            // å³æ™‚å®Ÿè¡Œï¼ˆDLï¼‰ã®å ´åˆ
            const commandBox = document.getElementById('commandBox');
            commandBox.innerHTML = `
                <div style="background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 13px; max-height: 400px; overflow-y: auto;" id="logArea">
                    <div style="color: #4ec9b0;">â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</div>
                    <div style="color: #ce9178;">å®Ÿè¡Œãƒ­ã‚°</div>
                    <div style="color: #4ec9b0;">â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</div>
                    <div id="logContent"></div>
                </div>
            `;

            // POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã§å®Ÿè¡Œ
            const response = await fetch(`${baseUrl}/execute`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    title: prog.title,
                    rss: prog.stationId,
                    station: prog.stationId,
                    start_time: startStr,
                    end_time: endStr
                })
            });

            if (!response.ok) {
                addLog('error', `ã‚¨ãƒ©ãƒ¼: ${response.statusText}`);
                executeBtn.disabled = false;
                executeBtn.textContent = 'å®Ÿè¡Œ';
                return;
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = JSON.parse(line.substring(6));
                        addLog(data.type, data.message, data.file);

                        if (data.type === 'success' || data.type === 'error') {
                            executeBtn.disabled = false;
                            executeBtn.textContent = 'å®Ÿè¡Œ';

                            // æˆåŠŸæ™‚ã¯ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’æ›´æ–°
                            if (data.type === 'success') {
                                setTimeout(() => loadRecordedFiles(), 1000);
                            }
                        }
                    }
                }
            }
        }

        function addLog(type, message, file) {
            const logContent = document.getElementById('logContent');
            const logLine = document.createElement('div');
            logLine.style.marginBottom = '4px';

            if (type === 'error') {
                logLine.style.color = '#f48771';
            } else if (type === 'success') {
                logLine.style.color = '#4ec9b0';
            } else {
                logLine.style.color = '#d4d4d4';
            }

            logLine.textContent = message;
            logContent.appendChild(logLine);

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’è¿½åŠ 
            if (file && type === 'success') {
                const proxyUrl = document.getElementById('proxyUrl').value;
                const baseUrl = proxyUrl.trim() ? proxyUrl : 'http://localhost:8080';
                const downloadUrl = `${baseUrl}/download/${file}`;

                const downloadLine = document.createElement('div');
                downloadLine.style.marginTop = '12px';
                downloadLine.style.padding = '12px';
                downloadLine.style.background = '#2d2d2d';
                downloadLine.style.borderRadius = '4px';
                downloadLine.style.border = '1px solid #4ec9b0';

                const downloadBtn = document.createElement('a');
                downloadBtn.href = downloadUrl;
                downloadBtn.download = file.split('/').pop();
                downloadBtn.textContent = 'ğŸ“¥ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰';
                downloadBtn.style.color = '#4ec9b0';
                downloadBtn.style.textDecoration = 'none';
                downloadBtn.style.fontWeight = 'bold';
                downloadBtn.style.display = 'inline-block';
                downloadBtn.style.padding = '8px 16px';
                downloadBtn.style.background = '#1e1e1e';
                downloadBtn.style.border = '1px solid #4ec9b0';
                downloadBtn.style.borderRadius = '4px';
                downloadBtn.style.cursor = 'pointer';

                downloadBtn.onmouseover = function() {
                    this.style.background = '#4ec9b0';
                    this.style.color = '#1e1e1e';
                };
                downloadBtn.onmouseout = function() {
                    this.style.background = '#1e1e1e';
                    this.style.color = '#4ec9b0';
                };

                downloadLine.appendChild(downloadBtn);
                logContent.appendChild(downloadLine);
            }

            // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            const logArea = document.getElementById('logArea');
            logArea.scrollTop = logArea.scrollHeight;
        }

        async function copyCommand(event) {
            try {
                await navigator.clipboard.writeText(currentCommand);
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
                btn.style.background = '#28a745';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            } catch (err) {
                alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
            }
        }

        async function searchAllAreas() {
            const searchKeyword = document.getElementById('searchKeyword').value.trim();
            const proxyUrl = document.getElementById('proxyUrl').value;

            if (!searchKeyword) {
                showError('æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const programList = document.getElementById('programList');
            const fetchBtn = document.getElementById('fetchBtn');
            const searchAllBtn = document.getElementById('searchAllBtn');

            loading.style.display = 'block';
            error.style.display = 'none';
            programList.innerHTML = '';
            fetchBtn.disabled = true;
            searchAllBtn.disabled = true;

            try {
                const baseUrl = proxyUrl.trim() ? `${proxyUrl}/radiko` : 'https://radiko.jp';

                // éå»7æ—¥é–“ã®æ—¥ä»˜ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆï¼ˆæœ5æ™‚ã‚’æ—¥ä»˜ã®å¤‰ã‚ã‚Šç›®ã¨ã™ã‚‹ï¼‰
                const dates = [];
                const now = new Date();
                const today = new Date(now);

                // æœ5æ™‚æœªæº€ã®å ´åˆã¯å‰æ—¥ã¨ã—ã¦æ‰±ã†
                if (today.getHours() < 5) {
                    today.setDate(today.getDate() - 1);
                }

                for (let i = 0; i < 7; i++) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    // ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã§æ—¥ä»˜ã‚’å–å¾—ï¼ˆtoISOStringã¯UTCã«ãªã‚‹ãŸã‚ä½¿ã‚ãªã„ï¼‰
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const dateStr = `${year}${month}${day}`;
                    dates.push(dateStr);
                }

                // å…¨ã‚¨ãƒªã‚¢ã®IDãƒªã‚¹ãƒˆ
                const allAreaIds = [
                    'JP1', 'JP2', 'JP3', 'JP4', 'JP5', 'JP6', 'JP7', 'JP8', 'JP9', 'JP10',
                    'JP11', 'JP12', 'JP13', 'JP14', 'JP15', 'JP16', 'JP17', 'JP18', 'JP19', 'JP20',
                    'JP21', 'JP22', 'JP23', 'JP24', 'JP25', 'JP26', 'JP27', 'JP28', 'JP29', 'JP30',
                    'JP31', 'JP32', 'JP33', 'JP34', 'JP35', 'JP36', 'JP37', 'JP38', 'JP39', 'JP40',
                    'JP41', 'JP42', 'JP43', 'JP44', 'JP45', 'JP46', 'JP47'
                ];

                let allPrograms = [];
                let processedAreas = 0;

                // å„ã‚¨ãƒªã‚¢ã”ã¨ã«å‡¦ç†
                for (const areaId of allAreaIds) {
                    try {
                        // æ”¾é€å±€ä¸€è¦§ã‚’å–å¾—
                        const nowUrl = `${baseUrl}/v3/program/now/${areaId}.xml`;
                        const nowResponse = await fetch(nowUrl);
                        if (!nowResponse.ok) continue;

                        const nowXmlText = await nowResponse.text();
                        const parser = new DOMParser();
                        const nowXmlDoc = parser.parseFromString(nowXmlText, 'text/xml');
                        const stations = nowXmlDoc.querySelectorAll('station');

                        // å„æ”¾é€å±€ã®éå»7æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                        const stationPromises = Array.from(stations).map(async (station) => {
                            const stationId = station.getAttribute('id');
                            const stationName = station.querySelector('name')?.textContent || 'Unknown';

                            const allDatesPrograms = [];

                            // éå»7æ—¥é–“åˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                            for (const dateStr of dates) {
                                try {
                                    const stationUrl = `${baseUrl}/v3/program/station/date/${dateStr}/${stationId}.xml`;
                                    const response = await fetch(stationUrl);
                                    if (!response.ok) continue;

                                    const xmlText = await response.text();
                                    const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                                    const progs = xmlDoc.querySelectorAll('prog');

                                    progs.forEach(prog => {
                                        const title = prog.querySelector('title')?.textContent || '';
                                        const ftString = prog.getAttribute('ft');
                                        const toString = prog.getAttribute('to');
                                        const desc = prog.querySelector('desc')?.textContent || 'èª¬æ˜ãªã—';
                                        const pfm = prog.querySelector('pfm')?.textContent || '';
                                        const info = prog.querySelector('info')?.textContent || '';
                                        const url = prog.querySelector('url')?.textContent || '';

                                        // æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                                        const keyword = searchKeyword.toLowerCase();
                                        if (ftString && toString &&
                                            (title.toLowerCase().includes(keyword) ||
                                             pfm.toLowerCase().includes(keyword) ||
                                             desc.toLowerCase().includes(keyword))) {
                                            allDatesPrograms.push({
                                                stationId,
                                                stationName,
                                                areaId,
                                                title,
                                                ft: parseRadikoTime(ftString),
                                                to: parseRadikoTime(toString),
                                                desc,
                                                pfm,
                                                info,
                                                url
                                            });
                                        }
                                    });
                                } catch (err) {
                                    // æ—¥ä»˜ã”ã¨ã®ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
                                }
                            }
                            return allDatesPrograms;
                        });

                        const results = await Promise.all(stationPromises);
                        allPrograms = allPrograms.concat(results.flat());

                        processedAreas++;
                        loading.querySelector('p').textContent =
                            `æ¤œç´¢ä¸­... ${processedAreas}/${allAreaIds.length} ã‚¨ãƒªã‚¢ (${allPrograms.length}ä»¶è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ)`;

                    } catch (err) {
                        console.warn(`${areaId} ã®å–å¾—ã‚¨ãƒ©ãƒ¼:`, err);
                    }
                }

                if (allPrograms.length === 0) {
                    showError(`ã€Œ${searchKeyword}ã€ã«ä¸€è‡´ã™ã‚‹ç•ªçµ„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`);
                } else {
                    // é‡è¤‡ã‚’é™¤å»ï¼ˆåŒã˜æ”¾é€å±€IDã¨é–‹å§‹æ™‚åˆ»ã®çµ„ã¿åˆã‚ã›ï¼‰
                    const uniquePrograms = [];
                    const seen = new Set();

                    allPrograms.forEach(prog => {
                        const key = `${prog.stationId}_${prog.ft.getTime()}`;
                        if (!seen.has(key)) {
                            seen.add(key);
                            uniquePrograms.push(prog);
                        }
                    });

                    uniquePrograms.sort((a, b) => a.ft - b.ft);
                    displayPrograms(uniquePrograms);
                }

            } catch (err) {
                showError(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${err.message}`);
            } finally {
                loading.style.display = 'none';
                loading.querySelector('p').textContent = 'ç•ªçµ„è¡¨ã‚’èª­ã¿è¾¼ã¿ä¸­...';
                fetchBtn.disabled = false;
                searchAllBtn.disabled = false;
            }
        }

        function showError(message) {
            const error = document.getElementById('error');
            error.textContent = message;
            error.style.display = 'block';
        }

        // éŒ²éŸ³æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
        async function loadRecordedFiles() {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() ? proxyUrl : 'http://localhost:8080';

            const filesLoading = document.getElementById('filesLoading');
            const filesList = document.getElementById('filesList');

            filesLoading.style.display = 'block';
            filesList.innerHTML = '';

            try {
                const response = await fetch(`${baseUrl}/files`);
                if (!response.ok) {
                    console.error('Failed to load recorded files:', response.statusText);
                    filesLoading.style.display = 'none';
                    filesList.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 40px; font-size: 0.95em;">ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
                    return;
                }

                const data = await response.json();
                const files = data.files || [];

                filesLoading.style.display = 'none';

                if (files.length === 0) {
                    filesList.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px;">
                            <div style="font-size: 3em; margin-bottom: 15px;">ğŸ“­</div>
                            <div style="color: #6c757d; font-size: 1.1em; font-weight: 500;">éŒ²éŸ³æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“</div>
                            <div style="color: #adb5bd; font-size: 0.9em; margin-top: 8px;">ç•ªçµ„ã‚’éŒ²éŸ³ã™ã‚‹ã¨ã€ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
                        </div>
                    `;
                    return;
                }

                // ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’è¡¨ç¤º
                let html = `
                    <div style="margin-bottom: 15px; padding: 10px 15px; background: #e7f3ff; border-left: 4px solid #667eea; border-radius: 4px;">
                        <div style="font-size: 0.9em; color: #495057;">
                            <strong>${files.length}ä»¶</strong>ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px;">
                `;

                files.forEach(file => {
                    const fileSize = (file.size / 1024 / 1024).toFixed(2); // MB
                    const modDate = new Date(file.modified * 1000);
                    const dateStr = `${modDate.getFullYear()}/${String(modDate.getMonth() + 1).padStart(2, '0')}/${String(modDate.getDate()).padStart(2, '0')} ${String(modDate.getHours()).padStart(2, '0')}:${String(modDate.getMinutes()).padStart(2, '0')}`;

                    html += `
                        <div style="padding: 15px; background: white; border: 1px solid #dee2e6; border-radius: 8px; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.05);"
                             onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.borderColor='#667eea';"
                             onmouseout="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.05)'; this.style.borderColor='#dee2e6';">
                            <div style="margin-bottom: 12px;">
                                <div style="font-size: 0.95em; font-weight: 600; color: #212529; margin-bottom: 6px; line-height: 1.4;">${file.name}</div>
                                <div style="font-size: 0.8em; color: #6c757d;">
                                    <div style="margin-bottom: 3px;">ğŸ“Š ${fileSize} MB</div>
                                    <div>ğŸ•’ ${dateStr}</div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button onclick='playAudio("${file.path.replace(/'/g, "\\'")}", "${file.name.replace(/'/g, "\\'")}")'
                                        style="flex: 1; min-width: 100px; display: flex; align-items: center; justify-content: center; gap: 6px; padding: 10px 16px; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; border: none; border-radius: 8px; font-size: 0.9em; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);"
                                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(76, 175, 80, 0.5)';"
                                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(76, 175, 80, 0.3)';">
                                    <span style="font-size: 1.2em;">â–¶ï¸</span>
                                    <span>å†ç”Ÿ</span>
                                </button>
                                <a href="${baseUrl}/download/${file.path}" download="${file.name}"
                                   style="flex: 1; min-width: 100px; display: flex; align-items: center; justify-content: center; gap: 6px; padding: 10px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 8px; font-size: 0.9em; font-weight: 600; transition: all 0.3s; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);"
                                   onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.5)';"
                                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(102, 126, 234, 0.3)';">
                                    <span style="font-size: 1.2em;">ğŸ“¥</span>
                                    <span>DL</span>
                                </a>
                                <button onclick='deleteFile("${file.path.replace(/'/g, "\\'")}", "${file.name.replace(/'/g, "\\'")}")'
                                        style="display: flex; align-items: center; justify-content: center; padding: 10px 16px; background: #e57373; color: white; border: none; border-radius: 8px; font-size: 0.9em; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 8px rgba(229, 115, 115, 0.3);"
                                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(229, 115, 115, 0.5)'; this.style.background='#ef5350';"
                                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(229, 115, 115, 0.3)'; this.style.background='#e57373';">
                                    å‰Šé™¤
                                </button>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                filesList.innerHTML = html;

            } catch (err) {
                console.error('Error loading recorded files:', err);
                filesLoading.style.display = 'none';
                filesList.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 40px; font-size: 0.95em;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
        async function checkFileExists(prog) {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() ? proxyUrl : 'http://localhost:8080';

            const startStr = formatRadikoTime(new Date(prog.ft));

            try {
                const response = await fetch(`${baseUrl}/check-file`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: prog.title,
                        rss: prog.stationId,
                        start_time: startStr
                    })
                });

                if (!response.ok) {
                    return null;
                }

                const data = await response.json();
                return data;
            } catch (err) {
                console.error('Error checking file:', err);
                return null;
            }
        }

        // cronå¼ã‚’äººé–“ãŒèª­ã‚ã‚‹å½¢å¼ã«å¤‰æ›
        function parseCronExpression(cronLine) {
            // cronã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰cronå¼éƒ¨åˆ†ã‚’æŠ½å‡º
            const parts = cronLine.trim().split(/\s+/);
            if (parts.length < 5) return { description: 'ç„¡åŠ¹ãªcronå¼', parts: null };

            const minute = parts[0];
            const hour = parts[1];
            const dayOfMonth = parts[2];
            const month = parts[3];
            const dayOfWeek = parts[4];

            const daysOfWeekJp = ['æ—¥æ›œæ—¥', 'æœˆæ›œæ—¥', 'ç«æ›œæ—¥', 'æ°´æ›œæ—¥', 'æœ¨æ›œæ—¥', 'é‡‘æ›œæ—¥', 'åœŸæ›œæ—¥'];

            let description = 'å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°: ';

            // æ›œæ—¥ã®è§£æ
            if (dayOfWeek !== '*') {
                const day = parseInt(dayOfWeek);
                description += `æ¯é€±${daysOfWeekJp[day]}ã® `;
            } else if (dayOfMonth !== '*') {
                description += `æ¯æœˆ${dayOfMonth}æ—¥ã® `;
            } else {
                description += 'æ¯æ—¥ ';
            }

            // æ™‚åˆ»ã®è§£æ
            if (hour === '*' && minute === '*') {
                description += 'æ¯æ™‚æ¯åˆ†';
            } else if (hour === '*') {
                description += `æ¯æ™‚${minute}åˆ†`;
            } else if (minute === '*') {
                description += `${hour}æ™‚å°ã®æ¯åˆ†`;
            } else {
                description += `${hour}:${minute.padStart(2, '0')}`;
            }

            return {
                description,
                parts: { minute, hour, dayOfMonth, month, dayOfWeek }
            };
        }

        // cronä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
        async function loadCronJobs() {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() ? proxyUrl : 'http://localhost:8080';

            const cronLoading = document.getElementById('cronLoading');
            const cronList = document.getElementById('cronList');

            cronLoading.style.display = 'block';
            cronList.innerHTML = '';

            try {
                const response = await fetch(`${baseUrl}/cron/list`);
                if (!response.ok) {
                    cronLoading.style.display = 'none';
                    cronList.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 40px; font-size: 0.95em;">cronä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
                    return;
                }

                const data = await response.json();
                const cronJobs = data.cron_jobs || [];

                // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
                currentCronJobs = cronJobs;

                cronLoading.style.display = 'none';

                if (cronJobs.length === 0) {
                    cronList.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px;">
                            <div style="font-size: 3em; margin-bottom: 15px;">â°</div>
                            <div style="color: #6c757d; font-size: 1.1em; font-weight: 500;">ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹cronã‚¸ãƒ§ãƒ–ã¯ã‚ã‚Šã¾ã›ã‚“</div>
                            <div style="color: #adb5bd; font-size: 0.9em; margin-top: 8px;">ç•ªçµ„ã®cronã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
                        </div>
                    `;
                    return;
                }

                let html = `
                    <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 0.9em; color: #495057;">
                            <strong>${cronJobs.length}ä»¶</strong>ã®äºˆç´„
                        </div>
                        <button onclick="loadCronLogs()" style="padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; font-size: 0.85em; cursor: pointer;">
                            ğŸ“‹ ãƒ­ã‚°ã‚’è¡¨ç¤º
                        </button>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                `;

                cronJobs.forEach((job, index) => {
                    // cronã®å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°æƒ…å ±ã‚’ä½œæˆ
                    const cronInfo = parseCronExpression(job.raw || job);

                    // ç•ªçµ„æƒ…å ±ã®è¡¨ç¤º
                    const title = job.title || 'ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜ï¼‰';
                    const station = job.station || '';
                    const startTime = job.startTime ? `${job.startTime.slice(0,2)}:${job.startTime.slice(2,4)}` : '';
                    const endTime = job.endTime ? `${job.endTime.slice(0,2)}:${job.endTime.slice(2,4)}` : '';
                    const timeRange = startTime && endTime ? `${startTime}-${endTime}` : '';

                    html += `
                        <div style="padding: 12px; background: white; border: 1px solid #dee2e6; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; gap: 12px;">
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 600; color: #212529; margin-bottom: 4px; font-size: 0.95em;">
                                    ${title}
                                </div>
                                <div style="display: flex; gap: 12px; flex-wrap: wrap; font-size: 0.8em; color: #6c757d;">
                                    ${station ? `<span>ğŸ¢ ${station}</span>` : ''}
                                    ${timeRange ? `<span>ğŸ“¡ ${timeRange}</span>` : ''}
                                    <span>â° ${cronInfo.description.replace('å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°: ', '')}</span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 6px; flex-shrink: 0;">
                                <button onclick='editCronJob(${index}, ${JSON.stringify(job).replace(/'/g, "\\'").replace(/"/g, "&quot;")})'
                                        style="padding: 8px 14px; background: #667eea; color: white; border: none; border-radius: 6px; font-size: 0.85em; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                                        onmouseover="this.style.background='#5568d3'"
                                        onmouseout="this.style.background='#667eea'"
                                        title="ç·¨é›†">
                                    ç·¨é›†
                                </button>
                                <button onclick='removeCronJobByIndex(${index})'
                                        style="padding: 8px 14px; background: #e57373; color: white; border: none; border-radius: 6px; font-size: 0.85em; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                                        onmouseover="this.style.background='#ef5350'"
                                        onmouseout="this.style.background='#e57373'"
                                        title="å‰Šé™¤">
                                    å‰Šé™¤
                                </button>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                cronList.innerHTML = html;

            } catch (err) {
                console.error('Error loading cron jobs:', err);
                cronLoading.style.display = 'none';
                cronList.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 40px; font-size: 0.95em;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
            }
        }

        // cronã‚¸ãƒ§ãƒ–ã‚’è¿½åŠ 
        async function addCronJob(command) {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() ? proxyUrl : 'http://localhost:8080';

            try {
                const response = await fetch(`${baseUrl}/cron/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ command: command })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('âœ… cronã‚¸ãƒ§ãƒ–ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                    closeModal();
                    // cronç®¡ç†ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆã¦ä¸€è¦§ã‚’æ›´æ–°
                    switchTab('cron');
                } else {
                    alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + (data.error || 'cronã‚¸ãƒ§ãƒ–ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ'));
                }
            } catch (err) {
                console.error('Error adding cron job:', err);
                alert('âŒ cronã‚¸ãƒ§ãƒ–ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«cronã‚¸ãƒ§ãƒ–ã‚’ä¿å­˜
        let currentCronJobs = [];

        // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§cronã‚¸ãƒ§ãƒ–ã‚’å‰Šé™¤
        async function removeCronJobByIndex(index) {
            const job = currentCronJobs[index];
            if (!job) {
                alert('âŒ cronã‚¸ãƒ§ãƒ–ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                return;
            }

            const title = job.title || 'ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜';
            if (!confirm(`ã“ã®äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\n${title}`)) {
                return;
            }

            await removeCronJob(job.raw);
        }

        // cronã‚¸ãƒ§ãƒ–ã‚’å‰Šé™¤
        async function removeCronJob(command) {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() ? proxyUrl : 'http://localhost:8080';

            try {
                const response = await fetch(`${baseUrl}/cron/remove`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ command: command })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('âœ… äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    loadCronJobs();
                } else {
                    alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + (data.error || 'äºˆç´„ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ'));
                }
            } catch (err) {
                console.error('Error removing cron job:', err);
                alert('âŒ äºˆç´„ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
        async function deleteFile(filepath, filename) {
            if (!confirm('ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\n' + filename)) {
                return;
            }

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() ? proxyUrl : 'http://localhost:8080';

            try {
                const response = await fetch(`${baseUrl}/file/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ path: filepath })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    loadRecordedFiles();
                } else {
                    alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + (data.error || 'ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ'));
                }
            } catch (err) {
                console.error('Error deleting file:', err);
                alert('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // cronã‚¸ãƒ§ãƒ–ã‚’ç·¨é›†
        function editCronJob(index, jobData) {
            // jobDataã¯ãƒ‘ãƒ¼ã‚¹ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
            if (typeof jobData === 'string') {
                // æ—§å½¢å¼ã®å ´åˆã¯ãƒ‘ãƒ¼ã‚¹ã™ã‚‹
                const parts = jobData.trim().split(/\s+/);
                if (parts.length < 5) {
                    alert('ç„¡åŠ¹ãªcronå¼ã§ã™');
                    return;
                }
                jobData = {
                    raw: jobData,
                    minute: parts[0],
                    hour: parts[1],
                    dayOfWeek: parts[4],
                    command: parts.slice(5).join(' '),
                    title: '',
                    station: '',
                    startTime: '',
                    endTime: ''
                };
            }

            // ç•ªçµ„æƒ…å ±ã‚’è¡¨ç¤º
            document.getElementById('editProgramTitle').value = jobData.title || '';
            document.getElementById('editProgramStation').textContent = jobData.station ? `æ”¾é€å±€: ${jobData.station}` : '';

            // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã«å€¤ã‚’è¨­å®š
            document.getElementById('editMinute').value = jobData.minute;
            document.getElementById('editHour').value = jobData.hour;
            document.getElementById('editDayOfWeek').value = jobData.dayOfWeek;

            // éŒ²éŸ³æ™‚é–“ã‚’è¨­å®š
            if (jobData.startTime) {
                document.getElementById('editStartTime').value = `${jobData.startTime.slice(0,2)}:${jobData.startTime.slice(2,4)}`;
            }
            if (jobData.endTime) {
                document.getElementById('editEndTime').value = `${jobData.endTime.slice(0,2)}:${jobData.endTime.slice(2,4)}`;
            }

            currentEditingCron.original = jobData.raw;
            currentEditingCron.jobData = jobData;

            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
            updateCronPreview();

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            document.getElementById('cronEditModal').classList.add('active');
        }

        // cronãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
        function updateCronPreview() {
            const minute = document.getElementById('editMinute').value;
            const hour = document.getElementById('editHour').value;
            const dayOfWeek = document.getElementById('editDayOfWeek').value;
            const startTime = document.getElementById('editStartTime').value;
            const endTime = document.getElementById('editEndTime').value;

            const daysOfWeekJp = ['æ—¥æ›œæ—¥', 'æœˆæ›œæ—¥', 'ç«æ›œæ—¥', 'æ°´æ›œæ—¥', 'æœ¨æ›œæ—¥', 'é‡‘æ›œæ—¥', 'åœŸæ›œæ—¥'];

            let description = 'å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°: ';
            if (dayOfWeek !== '*') {
                description += `æ¯é€±${daysOfWeekJp[dayOfWeek]}ã® `;
            } else {
                description += 'æ¯æ—¥ ';
            }
            description += `${hour}:${String(minute).padStart(2, '0')}`;

            document.getElementById('cronPreview').textContent = description;

            // cronã‚³ãƒãƒ³ãƒ‰ã‚’å†æ§‹ç¯‰
            if (currentEditingCron.jobData) {
                const scriptPath = document.getElementById('scriptPath').value;
                const title = document.getElementById('editProgramTitle').value || '';
                const station = currentEditingCron.jobData.station || '';

                // æ™‚åˆ»ã‚’HHMMå½¢å¼ã«å¤‰æ›
                const startHHMM = startTime ? startTime.replace(':', '') : '';
                const endHHMM = endTime ? endTime.replace(':', '') : '';

                // éŒ²éŸ³é–‹å§‹æ™‚åˆ»ã¨cronå®Ÿè¡Œæ™‚åˆ»ã‚’æ¯”è¼ƒ
                // cronå®Ÿè¡Œæ™‚åˆ»ãŒéŒ²éŸ³é–‹å§‹æ™‚åˆ»ã‚ˆã‚Šæ—©ã„å ´åˆã€æ—¥ã‚’ã¾ãŸã„ã§ã„ã‚‹
                const startHour = startTime ? parseInt(startTime.split(':')[0]) : 0;
                const startMin = startTime ? parseInt(startTime.split(':')[1]) : 0;
                const cronExecHour = parseInt(hour);
                const cronExecMin = parseInt(minute);

                // æ™‚åˆ»ã‚’åˆ†å˜ä½ã«å¤‰æ›ã—ã¦æ¯”è¼ƒ
                const startMinutes = startHour * 60 + startMin;
                const cronExecMinutes = cronExecHour * 60 + cronExecMin;
                const needsYesterday = cronExecMinutes < startMinutes;

                // æ—¥ä»˜è¨ˆç®—ã®éƒ¨åˆ†
                let startDateCalc = '';
                if (needsYesterday) {
                    // cronå®Ÿè¡Œæ—¥ã®å‰æ—¥ã‚’éŒ²éŸ³é–‹å§‹æ—¥ã¨ã™ã‚‹
                    startDateCalc = '\`date -d yesterday +\\%Y\\%m\\%d\`';
                } else {
                    // cronå®Ÿè¡Œæ—¥ã¨åŒã˜æ—¥ã‚’éŒ²éŸ³é–‹å§‹æ—¥ã¨ã™ã‚‹
                    startDateCalc = '\`date +\\%Y\\%m\\%d\`';
                }

                const endDateCalc = '\`date +\\%Y\\%m\\%d\`';

                // cronã‚³ãƒãƒ³ãƒ‰ã‚’ç”Ÿæˆ
                const fullCommand = `${minute} ${hour} * * ${dayOfWeek} ${scriptPath} "${title}" "${station}" "${station}" "${startDateCalc}${startHHMM}" "${endDateCalc}${endHHMM}" "" "" "" >> /tmp/myradiko_output.log 2>&1`;
                document.getElementById('editCommandPreview').value = fullCommand;
            }
        }

        // cronç·¨é›†ã‚’ä¿å­˜
        async function saveCronEdit() {
            // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‹ã‚‰ç›´æ¥ã‚³ãƒãƒ³ãƒ‰ã‚’å–å¾—
            const newCronLine = document.getElementById('editCommandPreview').value.trim();

            if (!newCronLine) {
                alert('ã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // å¤ã„cronã‚’å‰Šé™¤ã—ã¦æ–°ã—ã„cronã‚’è¿½åŠ 
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() ? proxyUrl : 'http://localhost:8080';

            try {
                // å‰Šé™¤
                await fetch(`${baseUrl}/cron/remove`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ command: currentEditingCron.original })
                });

                // è¿½åŠ 
                const response = await fetch(`${baseUrl}/cron/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ command: newCronLine })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('âœ… äºˆç´„ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                    closeCronEditModal();
                    loadCronJobs();
                } else {
                    alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + (data.error || 'äºˆç´„ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ'));
                }
            } catch (err) {
                console.error('Error updating cron job:', err);
                alert('âŒ äºˆç´„ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // cronç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeCronEditModal() {
            document.getElementById('cronEditModal').classList.remove('active');
        }

        // cronãƒ­ã‚°ã‚’èª­ã¿è¾¼ã‚€
        async function loadCronLogs() {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() ? proxyUrl : 'http://localhost:8080';
            const logContent = document.getElementById('cronLogContent');

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
            document.getElementById('cronLogModal').classList.add('active');
            logContent.innerHTML = '<div style="text-align: center; color: #888;">èª­ã¿è¾¼ã¿ä¸­...</div>';

            try {
                const response = await fetch(`${baseUrl}/cron/logs`);
                if (!response.ok) {
                    logContent.innerHTML = '<div style="color: #ff6b6b;">ãƒ­ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
                    return;
                }

                const data = await response.json();
                const logs = data.logs || [];

                if (logs.length === 0) {
                    logContent.innerHTML = '<div style="color: #888;">ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                    return;
                }

                // ãƒ­ã‚°ã‚’æ•´å½¢ã—ã¦è¡¨ç¤º
                let html = '';
                logs.forEach(log => {
                    // ã‚¨ãƒ©ãƒ¼ã‚„è­¦å‘Šã‚’è‰²åˆ†ã‘
                    let color = '#d4d4d4';
                    if (log.toLowerCase().includes('error') || log.toLowerCase().includes('failed')) {
                        color = '#ff6b6b';
                    } else if (log.toLowerCase().includes('warn')) {
                        color = '#ffd43b';
                    } else if (log.toLowerCase().includes('success')) {
                        color = '#51cf66';
                    }

                    html += `<div style="color: ${color}; margin-bottom: 4px;">${escapeHtml(log)}</div>`;
                });

                logContent.innerHTML = html;
                // æœ€ä¸‹éƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                logContent.scrollTop = logContent.scrollHeight;

            } catch (err) {
                console.error('Error loading cron logs:', err);
                logContent.innerHTML = '<div style="color: #ff6b6b;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
            }
        }

        // cronãƒ­ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeCronLogModal() {
            document.getElementById('cronLogModal').classList.remove('active');
        }

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // æ™‚åˆ»ã®å…¥åŠ›ãŒå¤‰ã‚ã£ãŸã‚‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
        document.addEventListener('DOMContentLoaded', function() {
            const editInputs = ['editProgramTitle', 'editMinute', 'editHour', 'editDayOfWeek', 'editStartTime', 'editEndTime'];
            editInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', updateCronPreview);
                    element.addEventListener('change', updateCronPreview);
                }
            });
        });

        document.getElementById('modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        document.getElementById('cronEditModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCronEditModal();
            }
        });

        document.getElementById('cronLogModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCronLogModal();
            }
        });

        // atäºˆç´„ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
        async function loadAtJobs() {
            const atLoading = document.getElementById('atLoading');
            const atList = document.getElementById('atList');

            atLoading.style.display = 'block';
            atList.innerHTML = '';

            try {
                const proxyUrl = document.getElementById('proxyUrl').value;
                const baseUrl = proxyUrl.trim() ? proxyUrl : 'http://localhost:8080';

                const response = await fetch(`${baseUrl}/at/list`);
                const data = await response.json();

                atLoading.style.display = 'none';

                if (!data.jobs || data.jobs.length === 0) {
                    atList.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d; font-size: 0.95em;">atäºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                    return;
                }

                let html = '<div style="display: grid; gap: 15px;">';

                data.jobs.forEach(job => {
                    html += `
                        <div style="border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; background: #f8f9fa;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #212529; margin-bottom: 5px; font-size: 0.95em;">
                                        â±ï¸ Job #${job.id}
                                    </div>
                                    <div style="color: #6c757d; font-size: 0.9em;">
                                        å®Ÿè¡Œäºˆå®š: ${job.datetime}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button onclick='showAtJobDetail("${job.id}")'
                                            style="padding: 8px 14px; background: #667eea; color: white; border: none; border-radius: 6px; font-size: 0.85em; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                                            onmouseover="this.style.background='#5568d3'"
                                            onmouseout="this.style.background='#667eea'"
                                            title="è©³ç´°">
                                        è©³ç´°
                                    </button>
                                    <button onclick='cancelAtJob("${job.id}")'
                                            style="padding: 8px 14px; background: #e57373; color: white; border: none; border-radius: 6px; font-size: 0.85em; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                                            onmouseover="this.style.background='#ef5350'"
                                            onmouseout="this.style.background='#e57373'"
                                            title="ã‚­ãƒ£ãƒ³ã‚»ãƒ«">
                                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                atList.innerHTML = html;

            } catch (err) {
                console.error('Error loading at jobs:', err);
                atLoading.style.display = 'none';
                atList.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 40px; font-size: 0.95em;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
            }
        }

        // atäºˆç´„ã®è©³ç´°ã‚’è¡¨ç¤º
        async function showAtJobDetail(jobId) {
            try {
                const proxyUrl = document.getElementById('proxyUrl').value;
                const baseUrl = proxyUrl.trim() ? proxyUrl : 'http://localhost:8080';

                const response = await fetch(`${baseUrl}/at/detail/${jobId}`);
                const data = await response.json();

                if (response.ok) {
                    alert(`atäºˆç´„ #${jobId} ã®è©³ç´°\n\nã‚³ãƒãƒ³ãƒ‰:\n${data.command || 'ã‚³ãƒãƒ³ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'}`);
                } else {
                    alert(`ã‚¨ãƒ©ãƒ¼: ${data.error || 'Unknown error'}`);
                }
            } catch (err) {
                console.error('Error getting at job detail:', err);
                alert(`ã‚¨ãƒ©ãƒ¼: ${err.message}`);
            }
        }

        // atäºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        async function cancelAtJob(jobId) {
            if (!confirm(`atäºˆç´„ #${jobId} ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }

            try {
                const proxyUrl = document.getElementById('proxyUrl').value;
                const baseUrl = proxyUrl.trim() ? proxyUrl : 'http://localhost:8080';

                const response = await fetch(`${baseUrl}/at/cancel/${jobId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok) {
                    alert(`âœ… ${data.message}`);
                    loadAtJobs(); // ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                } else {
                    alert(`âŒ ${data.error || 'Unknown error'}`);
                }
            } catch (err) {
                console.error('Error cancelling at job:', err);
                alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${err.message}`);
            }
        }

        // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†ç”Ÿ
        function playAudio(filepath, filename) {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() ? proxyUrl : 'http://localhost:8080';

            // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚½ãƒ¼ã‚¹ã‚’è¨­å®š
            const audioPlayer = document.getElementById('audioPlayer');
            const audioSource = document.getElementById('audioSource');
            const streamUrl = `${baseUrl}/stream/${filepath}`;

            // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¡¨ç¤º
            document.getElementById('audioFileName').textContent = filename;
            document.getElementById('audioPlayerTitle').textContent = 'ğŸµ ' + filename;

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            document.getElementById('audioPlayerModal').classList.add('active');

            // ã‚½ãƒ¼ã‚¹ã‚’è¨­å®šã—ã¦èª­ã¿è¾¼ã¿
            audioSource.src = streamUrl;
            audioPlayer.load();

            // loadãŒå®Œäº†ã—ãŸã‚‰è‡ªå‹•å†ç”Ÿ
            audioPlayer.addEventListener('canplay', function playWhenReady() {
                audioPlayer.play().catch(err => {
                    console.error('Auto-play failed:', err);
                    // è‡ªå‹•å†ç”ŸãŒå¤±æ•—ã—ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ã¯è¡¨ç¤ºã—ãªã„ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§å†ç”Ÿã§ãã‚‹ï¼‰
                });
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ï¼ˆä¸€åº¦ã ã‘å®Ÿè¡Œï¼‰
                audioPlayer.removeEventListener('canplay', playWhenReady);
            }, { once: true });
        }

        // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é–‰ã˜ã‚‹
        function closeAudioPlayer() {
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            document.getElementById('audioPlayerModal').classList.remove('active');
        }
    </script>
</body>
</html>
