<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>録音くん - radiko録音管理システム</title>
    <link rel="icon" href="img/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 10px;
            margin: 0;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        header {
            background: #667eea;
            color: white;
            padding: 10px 15px;
        }

        header h1 {
            font-size: 1.2em;
            margin: 0;
        }

        header p {
            font-size: 0.75em;
            opacity: 0.9;
            margin: 0;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            padding: 0 15px;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 0.9em;
            font-weight: 600;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #495057;
            background: #e9ecef;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .settings {
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .settings-grid {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .setting-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .setting-group label {
            font-weight: 600;
            color: #495057;
            font-size: 0.75em;
            white-space: nowrap;
        }

        .setting-group input,
        .setting-group select {
            padding: 4px 8px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .setting-group input:focus,
        .setting-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 4px 12px;
            border: none;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .content {
            padding: 10px;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #6c757d;
            font-size: 1.2em;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #f5c6cb;
        }

        .program-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 6px;
        }

        .station-column {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            overflow: hidden;
        }

        .station-header {
            background: #667eea;
            color: white;
            padding: 6px 8px;
            font-weight: 700;
            font-size: 0.85em;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .station-programs {
            max-height: 600px;
            overflow-y: auto;
        }

        .program-card {
            background: white;
            border-bottom: 1px solid #f0f0f0;
            padding: 4px 6px;
            transition: background 0.1s;
            cursor: pointer;
        }

        .program-card:last-child {
            border-bottom: none;
        }

        .program-card:hover {
            background: #f8f9fa;
        }

        .program-card.now-playing {
            background: #fff9e6;
            border-left: 3px solid #ffc107;
        }

        .program-time {
            color: #667eea;
            font-weight: 700;
            font-size: 0.7em;
            margin-bottom: 2px;
        }

        .program-title {
            color: #212529;
            font-size: 0.8em;
            font-weight: 600;
            margin-bottom: 2px;
            line-height: 1.2;
        }

        .program-detail {
            color: #6c757d;
            font-size: 0.7em;
            margin-bottom: 3px;
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .program-actions {
            display: flex;
            gap: 2px;
            margin-top: 3px;
        }

        .btn-action {
            flex: 1;
            padding: 2px 4px;
            border: none;
            border-radius: 3px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.1s;
            font-size: 0.65em;
            white-space: nowrap;
        }

        .btn-cron {
            background: #28a745;
            color: white;
        }

        .btn-cron:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-download {
            background: #007bff;
            color: white;
        }

        .btn-download:hover {
            background: #0069d9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
        }

        .btn-at {
            background: #ffc107;
            color: #212529;
        }

        .btn-at:hover {
            background: #e0a800;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 193, 7, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-header h2 {
            color: #212529;
            font-size: 1.8em;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: #6c757d;
            padding: 0;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: #f8f9fa;
            color: #212529;
        }

        .command-box {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
            line-height: 1.6;
            word-break: break-all;
            color: #212529;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
        }

        .btn-execute {
            flex: 1;
            background: #28a745;
            color: white;
        }

        .btn-execute:hover {
            background: #218838;
        }

        .btn-copy {
            flex: 1;
            background: #667eea;
            color: white;
        }

        .btn-copy:hover {
            background: #5568d3;
        }

        .btn-close {
            flex: 1;
            background: #6c757d;
            color: white;
        }

        .btn-close:hover {
            background: #5a6268;
        }

        footer {
            background: #f8f9fa;
            padding: 6px;
            text-align: center;
            color: #6c757d;
            font-size: 0.7em;
            border-top: 1px solid #e9ecef;
        }

        /* ハンバーガーメニュー（デフォルトで非表示） */
        .hamburger-menu {
            display: none;
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            padding: 8px;
            z-index: 1001;
        }

        .mobile-menu {
            display: none;
            position: fixed;
            top: 0;
            left: -100%;
            width: 80%;
            max-width: 300px;
            height: 100vh;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.3);
            z-index: 1000;
            transition: left 0.3s ease;
            overflow-y: auto;
        }

        .mobile-menu.active {
            left: 0;
        }

        .mobile-menu-header {
            background: #667eea;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mobile-menu-header h2 {
            margin: 0;
            font-size: 1.2em;
        }

        .mobile-menu-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mobile-menu-items {
            padding: 0;
            margin: 0;
            list-style: none;
        }

        .mobile-menu-item {
            border-bottom: 1px solid #e9ecef;
        }

        .mobile-menu-item button {
            width: 100%;
            padding: 15px 20px;
            background: none;
            border: none;
            text-align: left;
            font-size: 1em;
            cursor: pointer;
            color: #495057;
            transition: background 0.2s;
        }

        .mobile-menu-item button:hover {
            background: #f8f9fa;
        }

        .mobile-menu-item.active button {
            background: #e7f1ff;
            color: #667eea;
            font-weight: 600;
        }

        .menu-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .menu-overlay.active {
            display: block;
        }

        @media (max-width: 768px) {
            body {
                padding: 0;
            }

            .container {
                border-radius: 0;
            }

            header {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            header h1 {
                font-size: 1.2em;
            }

            header p {
                font-size: 0.7em;
            }

            /* タブを非表示にしてハンバーガーメニューを表示 */
            .tabs {
                display: none;
            }

            .menu-toggle {
                display: block;
            }

            .mobile-menu {
                display: block;
            }

            /* 設定エリアのスマホ対応 */
            .settings {
                padding: 10px;
            }

            /* 日付選択のスマホ対応: ボタンを非表示、pickerを表示 */
            #dateButtons {
                display: none !important;
            }

            #datePicker {
                display: block !important;
                width: 100%;
            }

            /* 設定グリッドのスマホ対応 */
            .settings-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            /* エリア選択と日付を1行目に配置 */
            .settings-grid .setting-group:nth-child(1) {
                grid-column: 1;
            }

            .settings-grid .setting-group:nth-child(2) {
                grid-column: 2;
            }

            /* 検索を2行目に配置 */
            .settings-grid .setting-group:nth-child(3) {
                grid-column: 1 / -1;
            }

            /* 詳細設定ボタンを非表示 */
            .settings-grid .setting-group:nth-child(4) {
                display: none !important;
            }

            .setting-group {
                display: flex;
                flex-direction: column;
                gap: 4px;
            }

            .setting-group label {
                font-size: 0.75em;
                font-weight: 600;
                color: #495057;
            }

            .setting-group input,
            .setting-group select {
                width: 100%;
                padding: 8px;
                font-size: 0.9em;
                border: 1px solid #dee2e6;
                border-radius: 4px;
            }

            /* エリア選択のラベルを短く */
            .setting-group:nth-child(1) label::before {
                content: "エリア:";
            }

            .setting-group:nth-child(1) label {
                font-size: 0;
            }

            .setting-group:nth-child(1) label::before {
                font-size: 0.75em;
            }

            /* 検索ボックスをフルワイドに */
            #searchKeyword {
                width: 100% !important;
            }

            .setting-group:nth-child(3) > div {
                width: 100%;
            }

            /* ボタンのスマホ対応 */
            .btn {
                padding: 10px 12px;
                font-size: 0.85em;
            }

            #fetchBtn, #searchAllBtn {
                display: block;
                width: 100%;
                margin: 8px 0 0 0 !important;
            }

            #fetchBtn {
                margin-top: 12px !important;
            }

            /* スマホ用放送局選択を表示 */
            #stationSelector {
                display: block !important;
            }

            /* 番組カードのスマホ対応 */
            .program-list {
                grid-template-columns: 1fr !important;
                gap: 10px;
            }

            /* スマホでは放送局ヘッダーを非表示（選択済みのため） */
            .station-header {
                display: none;
            }

            .program-card {
                font-size: 0.9em;
            }

            .program-header {
                flex-direction: column;
                gap: 8px;
            }

            .program-actions {
                flex-direction: column;
                gap: 6px;
            }

            .btn-action {
                width: 100%;
                padding: 10px;
            }

            /* モーダルのスマホ対応 */
            .modal-content {
                width: 95%;
                max-width: 95%;
                padding: 15px;
                margin: 10px;
            }

            .modal-header h2 {
                font-size: 1.1em;
            }

            .command-box {
                font-size: 0.75em;
                padding: 10px;
            }

            /* テーブルのスマホ対応 */
            table {
                font-size: 0.8em;
            }

            th, td {
                padding: 8px 6px !important;
            }

            /* 録音済みファイル一覧のスマホ対応 */
            #filesTab .content > div {
                padding: 10px !important;
            }

            #filesTab h2 {
                font-size: 1.1em !important;
            }

            #fileFilter {
                font-size: 0.9em !important;
                min-width: 100% !important;
            }

            /* ファイル一覧のボタン群を縦並びに */
            #filesList > div:first-child > div:first-child {
                flex-direction: column !important;
                align-items: stretch !important;
            }

            #filesList > div:first-child > div:first-child > * {
                width: 100% !important;
                margin: 4px 0 !important;
            }

            #filesList > div:first-child > div:nth-child(2) {
                flex-direction: column !important;
                align-items: stretch !important;
            }

            #filesList > div:first-child > div:nth-child(2) > button,
            #filesList > div:first-child > div:nth-child(2) > label {
                width: 100% !important;
                margin: 4px 0 !important;
                justify-content: center;
            }

            /* テーブルをカード形式に */
            #filesList table {
                display: block;
            }

            #filesList thead {
                display: none;
            }

            #filesList tbody {
                display: block;
            }

            #filesList tr {
                display: block;
                margin-bottom: 8px;
                border: 1px solid #dee2e6;
                border-radius: 6px;
                padding: 8px;
                background: white;
            }

            #filesList td {
                display: block;
                padding: 2px 0 !important;
                border: none !important;
                text-align: left !important;
            }

            #filesList td:first-child {
                display: none;
            }

            /* ファイル名を目立たせる */
            #filesList td:nth-child(2) {
                font-weight: 600;
                font-size: 0.9em;
                margin-bottom: 4px;
                word-break: break-all;
            }

            /* 放送日、サイズ、更新日時を1行にまとめて表示 */
            #filesList td:nth-child(3),
            #filesList td:nth-child(4),
            #filesList td:nth-child(5) {
                display: inline-block;
                font-size: 0.75em;
                color: #6c757d;
                margin-right: 8px;
            }

            #filesList td:nth-child(3)::before {
                content: "📅 ";
            }

            #filesList td:nth-child(4)::before {
                content: "💾 ";
            }

            #filesList td:nth-child(5)::before {
                content: "🕐 ";
            }

            /* アクションボタンを横並びに */
            #filesList td:last-child {
                margin-top: 6px;
                text-align: left !important;
            }

            #filesList td:last-child > div {
                display: flex !important;
                flex-direction: row !important;
                gap: 6px !important;
                justify-content: flex-start !important;
                align-items: center !important;
            }

            #filesList td:last-child button,
            #filesList td:last-child a {
                flex: 0 0 auto;
                text-align: center;
                padding: 6px 10px !important;
                font-size: 0.8em !important;
            }

            /* 詳細設定のスマホ対応 */
            #advancedSettings {
                padding: 10px;
            }

            /* 音声プレイヤーのスマホ対応 */
            .speed-btn {
                padding: 6px 10px !important;
                font-size: 0.75em !important;
            }

            /* カット編集パネルのスマホ対応 */
            #audioPlayerModal .modal-content {
                max-width: 95% !important;
            }

            #editPanel > div:first-child {
                flex-direction: column !important;
            }

            #editPanel button {
                font-size: 0.8em !important;
                padding: 10px 8px !important;
            }

            /* フッターのスマホ対応 */
            footer {
                font-size: 0.65em;
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>📻 録音くん</h1>
                <p>全国47都道府県のラジオ番組を検索・録音予約</p>
            </div>
            <button class="menu-toggle" onclick="toggleMobileMenu()">☰</button>
        </header>

        <!-- モバイルメニュー -->
        <div class="menu-overlay" id="menuOverlay" onclick="closeMobileMenu()"></div>
        <nav class="mobile-menu" id="mobileMenu">
            <div class="mobile-menu-header">
                <h2>メニュー</h2>
                <button class="mobile-menu-close" onclick="closeMobileMenu()">×</button>
            </div>
            <ul class="mobile-menu-items">
                <li class="mobile-menu-item active" data-tab="search">
                    <button onclick="switchTabMobile('search')">📻 番組検索</button>
                </li>
                <li class="mobile-menu-item" data-tab="files">
                    <button onclick="switchTabMobile('files')">📁 録音済みファイル</button>
                </li>
                <li class="mobile-menu-item" data-tab="at">
                    <button onclick="switchTabMobile('at')">⏱️ 番組予約管理</button>
                </li>
                <li class="mobile-menu-item" data-tab="cron">
                    <button onclick="switchTabMobile('cron')">⏰ 定期録音管理</button>
                </li>
                <li class="mobile-menu-item" data-tab="admin">
                    <button onclick="switchTabMobile('admin')">🔧 管理メニュー</button>
                </li>
            </ul>
        </nav>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('search')">📻 番組検索</button>
            <button class="tab" onclick="switchTab('files')">📁 録音済みファイル</button>
            <button class="tab" onclick="switchTab('at')">⏱️ 番組予約管理</button>
            <button class="tab" onclick="switchTab('cron')">⏰ 定期録音管理</button>
            <button class="tab" onclick="switchTab('admin')">🔧 管理メニュー</button>
        </div>

        <!-- 番組検索タブ -->
        <div id="searchTab" class="tab-content active">
            <div class="settings">
            <div class="settings-grid">
                <div class="setting-group">
                    <label for="areaId">エリアを選択:</label>
                    <select id="areaId">
                        <option value="JP1">北海道</option>
                        <option value="JP2">青森県</option>
                        <option value="JP3">岩手県</option>
                        <option value="JP4">宮城県</option>
                        <option value="JP5">秋田県</option>
                        <option value="JP6">山形県</option>
                        <option value="JP7">福島県</option>
                        <option value="JP8">茨城県</option>
                        <option value="JP9">栃木県</option>
                        <option value="JP10">群馬県</option>
                        <option value="JP11">埼玉県</option>
                        <option value="JP12">千葉県</option>
                        <option value="JP13">東京都</option>
                        <option value="JP14">神奈川県</option>
                        <option value="JP15">新潟県</option>
                        <option value="JP16">富山県</option>
                        <option value="JP17">石川県</option>
                        <option value="JP18">福井県</option>
                        <option value="JP19">山梨県</option>
                        <option value="JP20">長野県</option>
                        <option value="JP21">岐阜県</option>
                        <option value="JP22">静岡県</option>
                        <option value="JP23">愛知県</option>
                        <option value="JP24">三重県</option>
                        <option value="JP25">滋賀県</option>
                        <option value="JP26">京都府</option>
                        <option value="JP27">大阪府</option>
                        <option value="JP28">兵庫県</option>
                        <option value="JP29">奈良県</option>
                        <option value="JP30">和歌山県</option>
                        <option value="JP31">鳥取県</option>
                        <option value="JP32">島根県</option>
                        <option value="JP33">岡山県</option>
                        <option value="JP34">広島県</option>
                        <option value="JP35">山口県</option>
                        <option value="JP36">徳島県</option>
                        <option value="JP37">香川県</option>
                        <option value="JP38">愛媛県</option>
                        <option value="JP39">高知県</option>
                        <option value="JP40">福岡県</option>
                        <option value="JP41">佐賀県</option>
                        <option value="JP42">長崎県</option>
                        <option value="JP43">熊本県</option>
                        <option value="JP44">大分県</option>
                        <option value="JP45">宮崎県</option>
                        <option value="JP46">鹿児島県</option>
                        <option value="JP47">沖縄県</option>
                    </select>
                </div>

                <div class="setting-group">
                    <div id="dateButtons" style="display: flex; gap: 4px; flex-wrap: wrap;">
                        <!-- 日付ボタンはJavaScriptで動的に生成 -->
                    </div>
                    <!-- スマホ用の日付ピッカー -->
                    <input type="date" id="datePicker" style="display: none; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 0.9em;">
                    <input type="hidden" id="targetDate" value="">
                </div>

                <div class="setting-group">
                    <label for="searchKeyword">検索:</label>
                    <div style="position: relative; display: inline-block;">
                        <input type="text" id="searchKeyword" placeholder="番組名で検索" style="width: 150px; padding-right: 25px;">
                        <button id="clearSearchBtn" onclick="clearSearchKeyword()"
                                style="position: absolute; right: 4px; top: 50%; transform: translateY(-50%); background: transparent; border: none; color: #999; cursor: pointer; padding: 2px 6px; font-size: 1.1em; display: none;"
                                onmouseover="this.style.color='#333'" onmouseout="this.style.color='#999'">
                            ×
                        </button>
                    </div>
                </div>

                <div class="setting-group">
                    <button onclick="toggleAdvancedSettings()"
                            style="padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em; transition: all 0.2s;"
                            onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">
                        ⚙️ <span id="advancedToggleText">詳細設定を表示</span>
                    </button>
                </div>
            </div>

            <div id="advancedSettings" style="display: none; padding: 15px; background: #f8f9fa; border-radius: 8px; margin: 10px 0; border-left: 4px solid #6c757d;">
                <div style="font-weight: 600; color: #495057; margin-bottom: 12px; font-size: 0.95em;">⚙️ 詳細設定</div>
                <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                    <div class="setting-group" style="margin: 0;">
                        <label for="proxyUrl">プロキシURL:</label>
                        <input type="text" id="proxyUrl" value="" placeholder="/api" style="width: 80px;">
                    </div>

                    <div class="setting-group" style="margin: 0;">
                        <label for="scriptPath">スクリプトパス:</label>
                        <input type="text" id="scriptPath" value="/home/sites/radiko-recorder/script/myradiko" placeholder="パス" style="width: 250px;">
                    </div>
                </div>
            </div>

            <button id="fetchBtn" class="btn btn-primary">番組表を更新</button>
            <button id="searchAllBtn" class="btn btn-primary" style="margin-left: 8px;">全エリアから検索</button>
        </div>

            <div class="content">
                <div id="loading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>番組表を読み込み中...</p>
                </div>
                <div id="error" class="error" style="display: none;"></div>
                <div id="searchInfo" style="padding: 8px; font-size: 0.85em; color: #6c757d; display: none;"></div>

                <!-- スマホ用の放送局選択 -->
                <div id="stationSelector" style="display: none; padding: 10px; background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                    <label for="mobileStationSelect" style="font-size: 0.85em; font-weight: 600; color: #495057; display: block; margin-bottom: 6px;">📻 放送局を選択:</label>
                    <select id="mobileStationSelect" style="width: 100%; padding: 10px; font-size: 0.9em; border: 1px solid #dee2e6; border-radius: 4px;">
                        <option value="">-- 放送局を選択してください --</option>
                    </select>
                </div>

                <div id="programList" class="program-list"></div>
            </div>
        </div>

        <!-- 録音済みファイルタブ -->
        <div id="filesTab" class="tab-content">
            <div class="content">
                <div style="padding: 15px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e9ecef;">
                        <h2 style="margin: 0; font-size: 1.3em; color: #212529;">📁 録音済みファイル一覧</h2>
                        <button class="btn btn-primary" onclick="loadRecordedFiles()" style="padding: 6px 16px; font-size: 0.9em;">🔄 更新</button>
                    </div>
                    <div id="filesLoading" class="loading" style="display: none;">
                        <div class="spinner"></div>
                        <p>ファイル一覧を読み込み中...</p>
                    </div>
                    <div id="filesList"></div>
                </div>
            </div>
        </div>

        <!-- cron管理タブ -->
        <div id="cronTab" class="tab-content">
            <div class="content">
                <div style="padding: 15px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e9ecef;">
                        <h2 style="margin: 0; font-size: 1.3em; color: #212529;">⏰ 定期録音管理</h2>
                        <button class="btn btn-primary" onclick="loadCronJobs()" style="padding: 6px 16px; font-size: 0.9em;">🔄 更新</button>
                    </div>
                    <div id="cronLoading" class="loading" style="display: none;">
                        <div class="spinner"></div>
                        <p>cron一覧を読み込み中...</p>
                    </div>
                    <div id="cronList"></div>
                </div>
            </div>
        </div>

        <!-- at予約タブ -->
        <div id="atTab" class="tab-content">
            <div class="content">
                <div style="padding: 15px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e9ecef;">
                        <h2 style="margin: 0; font-size: 1.3em; color: #212529;">⏱️ 番組予約管理</h2>
                        <button class="btn btn-primary" onclick="loadAtJobs()" style="padding: 6px 16px; font-size: 0.9em;">🔄 更新</button>
                    </div>
                    <div id="atLoading" class="loading" style="display: none;">
                        <div class="spinner"></div>
                        <p>at予約一覧を読み込み中...</p>
                    </div>
                    <div id="atList"></div>
                </div>
            </div>
        </div>

        <!-- 管理メニュータブ -->
        <div id="adminTab" class="tab-content">
            <div class="content">
                <!-- パスワード認証画面 -->
                <div id="adminAuth" style="padding: 40px; background: white; text-align: center;">
                    <h2 style="margin-bottom: 20px; color: #212529;">🔐 管理メニュー</h2>
                    <p style="margin-bottom: 20px; color: #6c757d;">管理者パスワードを入力してください</p>
                    <div style="max-width: 300px; margin: 0 auto;">
                        <input type="password" id="adminPassword" placeholder="パスワード"
                               style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; margin-bottom: 15px;"
                               onkeypress="if(event.key==='Enter') authenticateAdmin()">
                        <button onclick="authenticateAdmin()"
                                style="width: 100%; padding: 10px 20px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em;">
                            ログイン
                        </button>
                    </div>
                </div>

                <!-- 管理メニュー本体（認証後に表示） -->
                <div id="adminPanel" style="display: none; padding: 15px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e9ecef;">
                        <h2 style="margin: 0; font-size: 1.3em; color: #212529;">🔧 管理メニュー</h2>
                        <button onclick="logoutAdmin()" style="padding: 6px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">ログアウト</button>
                    </div>

                    <!-- DB番組表一括更新 -->
                    <div style="margin-bottom: 25px; padding: 15px; border: 1px solid #e9ecef; border-radius: 4px;">
                        <h3 style="margin: 0 0 10px 0; font-size: 1.1em; color: #212529;">📊 DB番組表一括更新</h3>
                        <p style="margin: 0 0 10px 0; color: #6c757d; font-size: 0.9em;">全エリアの番組表をデータベースに取得・更新します（深夜バッチ処理相当）</p>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="updateDays" style="padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                <option value="1">今日のみ</option>
                                <option value="2">2日分 (今日+明日)</option>
                                <option value="3" selected>3日分</option>
                                <option value="7">7日分</option>
                            </select>
                            <button onclick="updateAllPrograms()" class="btn btn-primary" style="background: #007bff;">
                                🔄 一括更新開始 (進捗表示)
                            </button>
                        </div>
                        <p style="margin: 10px 0 0 0; color: #6c757d; font-size: 0.85em;">
                            ⚠️ 進捗を表示するにはブラウザを開いたままにしてください。<br>
                            バックグラウンドで実行する場合は、深夜3時の自動実行をお待ちください。
                        </p>
                        <div id="updateProgress" style="margin-top: 10px; display: none;">
                            <!-- プログレスバー -->
                            <div style="margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span id="updateProgressText" style="font-weight: 600; color: #495057; font-size: 0.9em;">準備中...</span>
                                    <span id="updateProgressPercent" style="font-weight: 600; color: #007bff; font-size: 0.9em;">0%</span>
                                </div>
                                <div style="width: 100%; height: 24px; background: #e9ecef; border-radius: 12px; overflow: hidden; position: relative;">
                                    <div id="updateProgressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #007bff, #0056b3); transition: width 0.3s ease; display: flex; align-items: center; justify-content: center;">
                                        <span id="updateProgressBarText" style="color: white; font-size: 0.8em; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.3);"></span>
                                    </div>
                                </div>
                                <div style="margin-top: 5px; font-size: 0.85em; color: #6c757d;" id="updateProgressDetail">待機中...</div>
                            </div>
                            <!-- 統計情報 -->
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px;">
                                <div style="background: #d4edda; padding: 8px; border-radius: 4px; text-align: center; border: 1px solid #c3e6cb;">
                                    <div style="font-size: 0.75em; color: #155724; font-weight: 600;">✅ 成功</div>
                                    <div style="font-size: 1.2em; font-weight: bold; color: #155724;" id="updateSuccessCount">0</div>
                                </div>
                                <div style="background: #f8d7da; padding: 8px; border-radius: 4px; text-align: center; border: 1px solid #f5c6cb;">
                                    <div style="font-size: 0.75em; color: #721c24; font-weight: 600;">❌ エラー</div>
                                    <div style="font-size: 1.2em; font-weight: bold; color: #721c24;" id="updateErrorCount">0</div>
                                </div>
                                <div style="background: #fff3cd; padding: 8px; border-radius: 4px; text-align: center; border: 1px solid #ffeaa7;">
                                    <div style="font-size: 0.75em; color: #856404; font-weight: 600;">⚠️ 警告</div>
                                    <div style="font-size: 1.2em; font-weight: bold; color: #856404;" id="updateWarningCount">0</div>
                                </div>
                            </div>
                            <!-- ログ表示 -->
                            <details open style="margin-bottom: 10px;">
                                <summary style="cursor: pointer; padding: 8px; background: #e9ecef; border-radius: 4px; font-weight: 600; user-select: none;">
                                    📋 詳細ログ
                                </summary>
                                <div style="background: #212529; color: #e9ecef; padding: 12px; border-radius: 4px; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.8em; max-height: 300px; overflow-y: auto; margin-top: 5px; line-height: 1.6;" id="updateLog"></div>
                            </details>
                        </div>
                    </div>

                    <!-- 手動コマンド実行 -->
                    <div style="margin-bottom: 25px; padding: 15px; border: 1px solid #e9ecef; border-radius: 4px;">
                        <h3 style="margin: 0 0 10px 0; font-size: 1.1em; color: #212529;">⚡ 手動myradikoコマンド実行</h3>
                        <p style="margin: 0 0 10px 0; color: #6c757d; font-size: 0.9em;">番組表を経由せずに直接録音コマンドを実行します</p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <div style="grid-column: 1 / -1;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057; font-size: 0.9em;">番組名</label>
                                <input type="text" id="manualTitle" placeholder="例: ラジオニュース" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057; font-size: 0.9em;">エリア</label>
                                <select id="manualArea" onchange="updateManualStations()" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                    <option value="">エリアを選択</option>
                                    <option value="JP13">東京都</option>
                                    <option value="JP14">神奈川県</option>
                                    <option value="JP27">大阪府</option>
                                    <option value="JP1">北海道</option>
                                    <option value="JP2">青森県</option>
                                    <option value="JP3">岩手県</option>
                                    <option value="JP4">宮城県</option>
                                    <option value="JP5">秋田県</option>
                                    <option value="JP6">山形県</option>
                                    <option value="JP7">福島県</option>
                                    <option value="JP8">茨城県</option>
                                    <option value="JP9">栃木県</option>
                                    <option value="JP10">群馬県</option>
                                    <option value="JP11">埼玉県</option>
                                    <option value="JP12">千葉県</option>
                                    <option value="JP15">新潟県</option>
                                    <option value="JP16">富山県</option>
                                    <option value="JP17">石川県</option>
                                    <option value="JP18">福井県</option>
                                    <option value="JP19">山梨県</option>
                                    <option value="JP20">長野県</option>
                                    <option value="JP21">岐阜県</option>
                                    <option value="JP22">静岡県</option>
                                    <option value="JP23">愛知県</option>
                                    <option value="JP24">三重県</option>
                                    <option value="JP25">滋賀県</option>
                                    <option value="JP26">京都府</option>
                                    <option value="JP28">兵庫県</option>
                                    <option value="JP29">奈良県</option>
                                    <option value="JP30">和歌山県</option>
                                    <option value="JP31">鳥取県</option>
                                    <option value="JP32">島根県</option>
                                    <option value="JP33">岡山県</option>
                                    <option value="JP34">広島県</option>
                                    <option value="JP35">山口県</option>
                                    <option value="JP36">徳島県</option>
                                    <option value="JP37">香川県</option>
                                    <option value="JP38">愛媛県</option>
                                    <option value="JP39">高知県</option>
                                    <option value="JP40">福岡県</option>
                                    <option value="JP41">佐賀県</option>
                                    <option value="JP42">長崎県</option>
                                    <option value="JP43">熊本県</option>
                                    <option value="JP44">大分県</option>
                                    <option value="JP45">宮崎県</option>
                                    <option value="JP46">鹿児島県</option>
                                    <option value="JP47">沖縄県</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057; font-size: 0.9em;">放送局</label>
                                <select id="manualStation" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                    <option value="">まずエリアを選択してください</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057; font-size: 0.9em;">コマンド実行時刻（予約実行時間）</label>
                                <input type="datetime-local" id="manualExecuteTime" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                <small style="color: #6c757d; font-size: 0.8em;">at コマンドでこの時刻に実行されます</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057; font-size: 0.9em;">録音開始日時</label>
                                <input type="datetime-local" id="manualStart" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                <small style="color: #6c757d; font-size: 0.8em;">実際に録音が開始される時刻</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057; font-size: 0.9em;">録音終了日時</label>
                                <input type="datetime-local" id="manualEnd" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                <small style="color: #6c757d; font-size: 0.8em;">日付を跨ぐ場合も指定可能</small>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button onclick="executeManualCommand()" class="btn btn-primary" style="background: #dc3545; color: white;">
                                ▶️ 即座に実行
                            </button>
                            <button onclick="scheduleManualCommand()" class="btn" style="background: #007bff; color: white;">
                                ⏰ at予約（コマンド実行時刻に実行）
                            </button>
                            <button onclick="copyManualCommand()" class="btn" style="background: #6c757d; color: white;">
                                📋 コマンドをコピー
                            </button>
                        </div>
                        <div id="manualCommandPreview" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; font-family: monospace; font-size: 0.85em; display: none; white-space: pre-wrap;"></div>
                        <div id="manualOutput" style="margin-top: 10px; display: none;">
                            <div style="background: #212529; color: #0f0; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 0.85em; max-height: 300px; overflow-y: auto; white-space: pre-wrap;" id="manualLog"></div>
                        </div>
                    </div>

                    <!-- その他メニュー -->
                    <div style="margin-bottom: 25px; padding: 15px; border: 1px solid #e9ecef; border-radius: 4px;">
                        <h3 style="margin: 0 0 10px 0; font-size: 1.1em; color: #212529;">🛠️ その他のメンテナンス</h3>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="cleanupOldData()" class="btn" style="background: #ffc107; color: #212529;">
                                🗑️ 古いDB データ削除
                            </button>
                            <button onclick="checkDiskSpace()" class="btn" style="background: #6c757d; color: white;">
                                💾 ディスク容量確認
                            </button>
                            <button onclick="viewDbStatus()" class="btn" style="background: #20c997; color: white;">
                                📈 DB統計情報
                            </button>
                        </div>
                        <div id="maintenanceOutput" style="margin-top: 10px; display: none;">
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 0.85em; max-height: 300px; overflow-y: auto; white-space: pre-wrap;" id="maintenanceLog"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- at予約編集モーダル -->
        <div id="atEditModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3 style="margin: 0; color: #212529;">📝 予約内容の編集</h3>
                    <button onclick="closeAtEditModal()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: #6c757d;">&times;</button>
                </div>
                <div class="modal-body" style="padding: 20px;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">番組名</label>
                        <input type="text" id="editAtTitle" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">エリア</label>
                            <select id="editAtArea" onchange="updateEditAtStations()" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                <option value="">エリアを選択</option>
                                <option value="JP13">東京都</option>
                                <option value="JP14">神奈川県</option>
                                <option value="JP27">大阪府</option>
                                <option value="JP28">兵庫県</option>
                                <option value="JP1">北海道</option>
                                <option value="JP2">青森県</option>
                                <option value="JP3">岩手県</option>
                                <option value="JP4">宮城県</option>
                                <option value="JP5">秋田県</option>
                                <option value="JP6">山形県</option>
                                <option value="JP7">福島県</option>
                                <option value="JP8">茨城県</option>
                                <option value="JP9">栃木県</option>
                                <option value="JP10">群馬県</option>
                                <option value="JP11">埼玉県</option>
                                <option value="JP12">千葉県</option>
                                <option value="JP15">新潟県</option>
                                <option value="JP16">富山県</option>
                                <option value="JP17">石川県</option>
                                <option value="JP18">福井県</option>
                                <option value="JP19">山梨県</option>
                                <option value="JP20">長野県</option>
                                <option value="JP21">岐阜県</option>
                                <option value="JP22">静岡県</option>
                                <option value="JP23">愛知県</option>
                                <option value="JP24">三重県</option>
                                <option value="JP25">滋賀県</option>
                                <option value="JP26">京都府</option>
                                <option value="JP29">奈良県</option>
                                <option value="JP30">和歌山県</option>
                                <option value="JP31">鳥取県</option>
                                <option value="JP32">島根県</option>
                                <option value="JP33">岡山県</option>
                                <option value="JP34">広島県</option>
                                <option value="JP35">山口県</option>
                                <option value="JP36">徳島県</option>
                                <option value="JP37">香川県</option>
                                <option value="JP38">愛媛県</option>
                                <option value="JP39">高知県</option>
                                <option value="JP40">福岡県</option>
                                <option value="JP41">佐賀県</option>
                                <option value="JP42">長崎県</option>
                                <option value="JP43">熊本県</option>
                                <option value="JP44">大分県</option>
                                <option value="JP45">宮崎県</option>
                                <option value="JP46">鹿児島県</option>
                                <option value="JP47">沖縄県</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">放送局</label>
                            <select id="editAtStation" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                <option value="">まずエリアを選択</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">録音開始日時</label>
                        <input type="datetime-local" id="editAtStartTime" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                        <small style="color: #6c757d; font-size: 0.85em;">実際に録音が開始される時刻</small>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">録音終了日時</label>
                        <input type="datetime-local" id="editAtEndTime" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                        <small style="color: #6c757d; font-size: 0.85em;">日付を跨ぐ場合も指定可能</small>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">コマンド実行時刻（予約実行時間）</label>
                        <div style="display: flex; gap: 8px; align-items: flex-start;">
                            <input type="datetime-local" id="editAtExecuteTime" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                            <button onclick="setExecuteTimeToEndPlus5()" style="padding: 8px 12px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; font-size: 0.9em;">
                                終了+5分
                            </button>
                        </div>
                        <small style="color: #6c757d; font-size: 0.85em;">atコマンドでこの時刻に実行されます</small>
                    </div>
                    <input type="hidden" id="editAtJobId">
                </div>
                <div class="modal-footer">
                    <button onclick="closeAtEditModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">キャンセル</button>
                    <button onclick="saveAtEdit()" style="padding: 10px 20px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer;">保存</button>
                </div>
            </div>
        </div>

        <footer>
            <p>&copy; 2025 録音くん | Powered by radiko API</p>
        </footer>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">コマンド</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="command-box" id="commandBox"></div>
            <div class="modal-actions">
                <button class="btn btn-action btn-execute" id="executeBtn" onclick="executeCommand()" style="display: none;">実行</button>
                <button class="btn btn-action" id="registerCronBtn" style="display: none; background: #28a745; color: white;">⏰ cron登録</button>
                <button class="btn btn-action btn-copy" onclick="copyCommand(event)">コピー</button>
                <button class="btn btn-action btn-close" onclick="closeModal()">閉じる</button>
            </div>
        </div>
    </div>

    <!-- cronログモーダル -->
    <div id="cronLogModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>📋 cronログ</h2>
                <button class="modal-close" onclick="closeCronLogModal()">&times;</button>
            </div>
            <div style="margin-bottom: 15px;">
                <div style="padding: 10px; background: #f8f9fa; border-radius: 4px; font-size: 0.85em; color: #6c757d;">
                    cronの実行履歴とエラーログを表示します。最新100行まで表示されます。
                </div>
            </div>
            <div id="cronLogContent" style="max-height: 500px; overflow-y: auto; background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 0.8em; line-height: 1.6;">
                <div style="text-align: center; color: #888;">読み込み中...</div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-action" onclick="loadCronLogs()" style="background: #6c757d; color: white;">🔄 更新</button>
                <button class="btn btn-action btn-close" onclick="closeCronLogModal()">閉じる</button>
            </div>
        </div>
    </div>

    <!-- オーディオプレイヤーモーダル -->
    <div id="audioPlayerModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="audioPlayerTitle">🎵 再生中</h2>
                <button class="modal-close" onclick="closeAudioPlayer()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <audio id="audioPlayer" controls style="width: 100%; margin-bottom: 15px;"
                       ontimeupdate="updatePlaybackPosition()"
                       onloadedmetadata="loadBookmark()"
                       onvolumechange="saveVolume()">
                    <source id="audioSource" src="" type="audio/mpeg">
                    お使いのブラウザは音声再生をサポートしていません。
                </audio>

                <!-- 早送り・巻き戻しコントロール -->
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: linear-gradient(135deg, #667eea15, #764ba215); border-radius: 6px; margin-bottom: 10px;">
                    <button onclick="skipAudio(-10)" style="padding: 5px 10px; background: rgba(102, 126, 234, 0.1); border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em; font-weight: 600; color: #667eea; transition: all 0.15s;" onmouseover="this.style.background='#667eea'; this.style.color='white'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='rgba(102, 126, 234, 0.1)'; this.style.color='#667eea'; this.style.transform='scale(1)'">
                        ← 10s
                    </button>
                    <span style="font-size: 0.7em; color: #6c757d; letter-spacing: 0.5px;">⌨️ ←→</span>
                    <button onclick="skipAudio(10)" style="padding: 5px 10px; background: rgba(118, 75, 162, 0.1); border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em; font-weight: 600; color: #764ba2; transition: all 0.15s;" onmouseover="this.style.background='#764ba2'; this.style.color='white'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='rgba(118, 75, 162, 0.1)'; this.style.color='#764ba2'; this.style.transform='scale(1)'">
                        10s →
                    </button>
                </div>

                <!-- 再生速度コントロール -->
                <div style="padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <label style="font-size: 0.85em; color: #495057; font-weight: 600; min-width: 80px;">⚡ 再生速度:</label>
                        <input type="range" id="playbackRate" min="0.5" max="2.0" step="0.1" value="1.0"
                               oninput="changePlaybackRate(this.value)"
                               style="flex: 1; cursor: pointer;">
                        <span id="playbackRateValue" style="min-width: 50px; font-size: 0.9em; font-weight: 600; color: #667eea;">1.0x</span>
                    </div>
                    <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                        <button onclick="setPlaybackRate(0.5)" class="speed-btn" style="padding: 4px 10px; background: white; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; font-size: 0.8em; transition: all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='white'">0.5x</button>
                        <button onclick="setPlaybackRate(0.75)" class="speed-btn" style="padding: 4px 10px; background: white; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; font-size: 0.8em; transition: all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='white'">0.75x</button>
                        <button onclick="setPlaybackRate(1.0)" class="speed-btn" style="padding: 4px 10px; background: white; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; font-size: 0.8em; transition: all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='white'">1.0x</button>
                        <button onclick="setPlaybackRate(1.25)" class="speed-btn" style="padding: 4px 10px; background: white; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; font-size: 0.8em; transition: all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='white'">1.25x</button>
                        <button onclick="setPlaybackRate(1.5)" class="speed-btn" style="padding: 4px 10px; background: white; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; font-size: 0.8em; transition: all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='white'">1.5x</button>
                        <button onclick="setPlaybackRate(2.0)" class="speed-btn" style="padding: 4px 10px; background: white; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; font-size: 0.8em; transition: all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='white'">2.0x</button>
                    </div>
                </div>

                <!-- カット編集パネル -->
                <div style="padding: 12px; background: linear-gradient(135deg, #ffeaa715, #ff6b6b15); border-radius: 8px; margin-bottom: 10px; border: 2px solid #ffe8e8;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                        <label style="font-size: 0.85em; color: #d63031; font-weight: 600;">✂️ カット編集</label>
                        <button id="toggleEditPanel" onclick="toggleEditPanel()" style="padding: 3px 8px; background: white; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; font-size: 0.75em; color: #6c757d;">
                            表示/非表示
                        </button>
                    </div>
                    <div id="editPanel" style="display: none;">
                        <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                            <button onclick="markStartTime()" style="flex: 1; padding: 8px; background: #00b894; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#00a383'" onmouseout="this.style.background='#00b894'">
                                📍 開始位置
                            </button>
                            <button onclick="markEndTime()" style="flex: 1; padding: 8px; background: #0984e3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#0770c9'" onmouseout="this.style.background='#0984e3'">
                                📍 終了位置
                            </button>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 4px; margin-bottom: 10px; font-size: 0.85em;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="color: #6c757d;">開始:</span>
                                <span id="editStartTime" style="font-weight: 600; color: #00b894;">未設定</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="color: #6c757d;">終了:</span>
                                <span id="editEndTime" style="font-weight: 600; color: #0984e3;">未設定</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #6c757d;">範囲:</span>
                                <span id="editDuration" style="font-weight: 600; color: #d63031;">--</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="executeEdit('remove')" style="flex: 1; padding: 10px; background: #d63031; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#c0251f'" onmouseout="this.style.background='#d63031'">
                                🗑️ 範囲を削除
                            </button>
                            <button onclick="executeEdit('extract')" style="flex: 1; padding: 10px; background: #fdcb6e; color: #2d3436; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#fcbb4b'" onmouseout="this.style.background='#fdcb6e'">
                                📥 範囲を抽出
                            </button>
                        </div>
                        <div style="margin-top: 8px; padding: 8px; background: #fff3cd; border-radius: 4px; font-size: 0.75em; color: #856404;">
                            💡 範囲削除: CMなど不要部分を除去 / 範囲抽出: 指定部分のみ保存
                        </div>
                    </div>
                </div>

                <!-- ブックマーク情報 -->
                <div id="audioInfo" style="padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 0.9em; color: #495057;">
                    <div style="margin-bottom: 8px;"><strong>ファイル名:</strong> <span id="audioFileName"></span></div>
                    <div style="color: #6c757d; font-size: 0.85em; margin-top: 8px;">
                        💡 再生位置は自動的に記憶されます
                    </div>
                    <div id="bookmarkInfo" style="color: #6c757d; font-size: 0.85em; display: none; margin-top: 8px; padding: 8px; background: #e7f3ff; border-left: 3px solid #667eea; border-radius: 4px;">
                        📍 前回の続きから再生します (<span id="bookmarkTime"></span>)
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-action btn-close" onclick="closeAudioPlayer()">閉じる</button>
            </div>
        </div>
    </div>

    <!-- cron編集モーダル -->
    <div id="cronEditModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>⏰ 予約を編集</h2>
                <button class="modal-close" onclick="closeCronEditModal()">&times;</button>
            </div>

            <!-- 番組情報 -->
            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #495057;">📺 番組情報</label>
                <div style="margin-bottom: 10px;">
                    <label style="font-size: 0.85em; color: #6c757d;">番組名</label>
                    <input type="text" id="editProgramTitle" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                </div>
                <div style="font-size: 0.85em; color: #6c757d;" id="editProgramStation">放送局</div>
            </div>

            <!-- 録音時間設定 -->
            <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #495057;">📡 録音時間</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label style="font-size: 0.85em; color: #6c757d;">開始時刻 (HH:MM)</label>
                            <input type="time" id="editStartTime" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="font-size: 0.85em; color: #6c757d;">終了時刻 (HH:MM)</label>
                            <input type="time" id="editEndTime" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 実行タイミング設定 -->
            <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #495057;">⏰ 実行タイミング</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                        <div>
                            <label style="font-size: 0.85em; color: #6c757d;">分 (0-59)</label>
                            <input type="number" id="editMinute" min="0" max="59" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="font-size: 0.85em; color: #6c757d;">時 (0-23)</label>
                            <input type="number" id="editHour" min="0" max="23" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="font-size: 0.85em; color: #6c757d;">実行頻度</label>
                            <select id="editDayOfWeek" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                                <option value="*">毎日</option>
                                <option value="0">日曜日</option>
                                <option value="1">月曜日</option>
                                <option value="2">火曜日</option>
                                <option value="3">水曜日</option>
                                <option value="4">木曜日</option>
                                <option value="5">金曜日</option>
                                <option value="6">土曜日</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div style="padding: 10px; background: #e7f3ff; border-radius: 4px; border-left: 4px solid #667eea;">
                    <div style="font-size: 0.9em; color: #0056b3; font-weight: 600;" id="cronPreview">
                        実行タイミング: -
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #495057;">🎯 実行コマンド</label>
                <textarea id="editCommandPreview" style="width: 100%; min-height: 120px; font-family: 'Courier New', monospace; font-size: 0.85em; color: #495057; background: #f8f9fa; padding: 12px; border: 1px solid #dee2e6; border-radius: 4px; resize: vertical; line-height: 1.6;" placeholder="cronコマンド"></textarea>
                <div style="font-size: 0.8em; color: #6c757d; margin-top: 5px;">
                    💡 コマンドを直接編集できます。録音時間を細かく調整したい場合などに使用してください。
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-action" onclick="saveCronEdit()" style="background: #28a745; color: white;">💾 保存</button>
                <button class="btn btn-action btn-close" onclick="closeCronEditModal()">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- リネームモーダル -->
    <div id="renameModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>✏️ ファイル名を変更</h2>
                <button class="modal-close" onclick="closeRenameModal()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #495057;">現在のファイル名</label>
                    <div id="renameCurrentName" style="padding: 10px; background: #f8f9fa; border-radius: 4px; color: #6c757d; font-size: 0.9em; word-break: break-all;"></div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="renameNewName" style="display: block; font-weight: 600; margin-bottom: 8px; color: #495057;">新しいファイル名</label>
                    <input type="text" id="renameNewName" style="width: 100%; padding: 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 0.9em;">
                    <div style="margin-top: 6px; font-size: 0.8em; color: #6c757d;">
                        💡 拡張子（.mp3など）は自動的に追加されます
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-action" onclick="executeRename()" style="background: #667eea;">✏️ 変更</button>
                <button class="btn btn-action btn-close" onclick="closeRenameModal()">キャンセル</button>
            </div>
        </div>
    </div>

    <script>
        let currentCommand = '';
        let currentProgramData = null;
        let allProgramsData = [];
        let eventSource = null;
        let currentEditingCron = { original: '', commandPart: '' };
        let currentStationMap = null; // スマホ用: 現在の放送局マップを保持
        let currentProgramList = null; // スマホ用: 現在のプログラムリスト要素を保持
        // 番組表キャッシュ（エリアID + 日付をキーにする）
        // 各エントリは { data: [...], timestamp: Date } の形式
        const programCache = new Map();
        const CACHE_EXPIRE_MS = 30 * 60 * 1000; // 30分でキャッシュ期限切れ

        // ファイル名サニタイズ関数（スペースをアンダーバーに、全角記号を半角に）
        function sanitizeFilename(title) {
            if (!title) return title;

            // スペースをアンダーバーに
            let sanitized = title.replace(/ /g, '_').replace(/　/g, '_');

            // 全角括弧・記号を半角に
            const replacements = {
                '（': '(',
                '）': ')',
                '「': '[',
                '」': ']',
                '：': ':',
                '！': '!',
                '？': '?',
                '［': '[',
                '］': ']'
            };

            for (const [oldChar, newChar] of Object.entries(replacements)) {
                sanitized = sanitized.replace(new RegExp(oldChar, 'g'), newChar);
            }

            return sanitized;
        }

        // キャッシュ関連の関数（互換性のため空実装を残す）
        async function loadCacheFromStorage() {
            console.log('ℹ️ キャッシュはサーバー側DBで管理されています');
        }

        async function saveCacheToStorage() {
            console.log('ℹ️ キャッシュはサーバー側DBで管理されています');
        }

        // 古いキャッシュを削除する関数
        function clearOldCache() {
            console.log('🧹 キャッシュクリーンアップ開始');
            console.log(`クリーンアップ前のキャッシュ数: ${programCache.size}件`);

            const now = new Date();
            const today = new Date(now);

            // 朝5時未満の場合は前日として扱う
            if (today.getHours() < 5) {
                today.setDate(today.getDate() - 1);
            }

            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            console.log(`基準日: ${todayStr} (朝5時基準)`);

            // 過去7日間から未来7日間までのキャッシュを保持（計15日間）
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const sevenDaysAgoStr = `${sevenDaysAgo.getFullYear()}-${String(sevenDaysAgo.getMonth() + 1).padStart(2, '0')}-${String(sevenDaysAgo.getDate()).padStart(2, '0')}`;

            const sevenDaysLater = new Date(today);
            sevenDaysLater.setDate(sevenDaysLater.getDate() + 7);
            const sevenDaysLaterStr = `${sevenDaysLater.getFullYear()}-${String(sevenDaysLater.getMonth() + 1).padStart(2, '0')}-${String(sevenDaysLater.getDate()).padStart(2, '0')}`;
            console.log(`保持期間: ${sevenDaysAgoStr} 〜 ${sevenDaysLaterStr}`);

            // 古いキャッシュ、または期限切れのキャッシュを削除
            const keysToDelete = [];
            programCache.forEach((value, key) => {
                // キーの形式: "JP27_2025-01-23" または "JP27_now"
                const parts = key.split('_');
                if (parts.length === 2) {
                    const date = parts[1];

                    // 保持期間外の日付のキャッシュは削除
                    if (date !== 'now' && (date < sevenDaysAgoStr || date > sevenDaysLaterStr)) {
                        console.log(`  削除理由: 保持期間外 - ${key} (保持期間: ${sevenDaysAgoStr} 〜 ${sevenDaysLaterStr})`);
                        keysToDelete.push({ key, reason: '保持期間外' });
                        return;
                    }

                    // 期限切れ（30分以上経過）のキャッシュも削除
                    if (!isCacheValid(value)) {
                        const age = Math.floor((Date.now() - value.timestamp) / 60000);
                        console.log(`  削除理由: 期限切れ - ${key} (${age}分経過)`);
                        keysToDelete.push({ key, reason: `期限切れ(${age}分)` });
                        return;
                    }

                    // 有効なキャッシュ
                    const age = Math.floor((Date.now() - value.timestamp) / 60000);
                    console.log(`  保持: ${key} (${age}分経過, 有効期限内)`);
                }
            });

            keysToDelete.forEach(item => {
                programCache.delete(item.key);
                console.log(`❌ 削除: ${item.key} (${item.reason})`);
            });

            if (keysToDelete.length > 0) {
                console.log(`✅ キャッシュクリーンアップ完了: ${keysToDelete.length}件削除`);
                // クリーンアップ後にlocalStorageを更新
                saveCacheToStorage();
            } else {
                console.log('✅ キャッシュクリーンアップ: 削除対象なし');
            }
            console.log(`クリーンアップ後のキャッシュ数: ${programCache.size}件`);
        }

        // キャッシュが有効かチェックする関数
        function isCacheValid(cacheEntry) {
            if (!cacheEntry || !cacheEntry.timestamp) {
                return false;
            }
            const now = Date.now();
            const age = now - cacheEntry.timestamp;
            return age < CACHE_EXPIRE_MS;
        }

        // 番組検索タブの初期化（本日の現在時刻の番組を表示）
        function initializeSearchTab() {
            // 本日の日付を設定
            const today = new Date();
            const dateStr = today.toISOString().slice(0, 10);
            document.getElementById('targetDate').value = dateStr;

            // デフォルトエリアが選択されていれば番組を取得
            const areaId = document.getElementById('areaId').value;
            if (areaId) {
                fetchPrograms();
            }
        }

        // タブ切り替え
        function switchTab(tabName) {
            // 全てのタブとコンテンツを非アクティブに
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // 現在のタブをlocalStorageに保存
            localStorage.setItem('currentTab', tabName);

            // 選択されたタブをアクティブに
            if (tabName === 'search') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('searchTab').classList.add('active');
                // 番組検索タブを開いた時に本日の番組を自動表示
                initializeSearchTab();
            } else if (tabName === 'files') {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('filesTab').classList.add('active');
                // ファイルタブを開いた時に自動読み込み
                loadRecordedFiles();
            } else if (tabName === 'at') {
                document.querySelectorAll('.tab')[2].classList.add('active');
                document.getElementById('atTab').classList.add('active');
                // at予約タブを開いた時に自動読み込み
                loadAtJobs();
            } else if (tabName === 'cron') {
                document.querySelectorAll('.tab')[3].classList.add('active');
                document.getElementById('cronTab').classList.add('active');
                // cronタブを開いた時に自動読み込み
                loadCronJobs();
            } else if (tabName === 'admin') {
                document.querySelectorAll('.tab')[4].classList.add('active');
                document.getElementById('adminTab').classList.add('active');
            }
        }

        // モバイルメニューを開く
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const overlay = document.getElementById('menuOverlay');
            menu.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        // モバイルメニューを閉じる
        function closeMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const overlay = document.getElementById('menuOverlay');
            menu.classList.remove('active');
            overlay.classList.remove('active');
        }

        // モバイルメニューからタブを切り替え
        function switchTabMobile(tabName) {
            // モバイルメニューのアクティブ状態を更新
            document.querySelectorAll('.mobile-menu-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.mobile-menu-item[data-tab="${tabName}"]`).classList.add('active');

            // 既存のタブ切り替え関数を呼び出し
            switchTab(tabName);

            // メニューを閉じる
            closeMobileMenu();
        }

        // 今日の日付とエリアのデフォルトを設定
        document.addEventListener('DOMContentLoaded', async function() {
            // 旧キャッシュシステムのデータを削除
            if (localStorage.getItem('radikoCache')) {
                console.log('🗑️ 旧キャッシュデータを削除');
                localStorage.removeItem('radikoCache');
            }

            // IndexedDBがあれば削除
            try {
                indexedDB.deleteDatabase('RadikoCacheDB');
                console.log('🗑️ 旧IndexedDBを削除');
            } catch (err) {
                console.log('ℹ️ IndexedDB削除スキップ');
            }

            console.log('✅ キャッシュシステム: サーバー側DB使用')

            // 保存されているタブを復元
            const savedTab = localStorage.getItem('currentTab');
            if (savedTab) {
                switchTab(savedTab);
            }

            // 詳細設定の開閉状態を復元
            const advancedSettingsOpen = localStorage.getItem('advancedSettingsOpen');
            if (advancedSettingsOpen === 'true') {
                toggleAdvancedSettings();
            }

            // 日本時間で今日の日付を取得（朝5時を日付の変わり目とする）
            const now = new Date();
            const today = new Date(now);

            // 朝5時未満の場合は前日として扱う
            if (today.getHours() < 5) {
                today.setDate(today.getDate() - 1);
            }

            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;

            document.getElementById('targetDate').value = dateStr;

            // 過去7日間 + 今日 + 未来7日間の日付ボタンを生成（計15日間）
            const dateButtonsContainer = document.getElementById('dateButtons');
            const dayLabels = ['日', '月', '火', '水', '木', '金', '土'];

            for (let i = -7; i <= 7; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() + i);

                const btnYear = date.getFullYear();
                const btnMonth = String(date.getMonth() + 1).padStart(2, '0');
                const btnDay = String(date.getDate()).padStart(2, '0');
                const btnDateStr = `${btnYear}-${btnMonth}-${btnDay}`;
                const dayOfWeek = dayLabels[date.getDay()];

                const button = document.createElement('button');
                button.type = 'button';

                // 今日の場合は「今日」と表示
                if (i === 0) {
                    button.textContent = `今日 ${btnMonth}/${btnDay}(${dayOfWeek})`;
                } else {
                    button.textContent = `${btnMonth}/${btnDay}(${dayOfWeek})`;
                }

                button.dataset.date = btnDateStr;

                // 今日の日付をデフォルトで選択状態にする
                if (i === 0) {
                    button.style.cssText = 'padding: 4px 8px; border: 1px solid #667eea; background: #667eea; color: white; border-radius: 4px; font-size: 0.8em; cursor: pointer; transition: all 0.15s;';
                } else {
                    button.style.cssText = 'padding: 4px 8px; border: 1px solid #ced4da; background: #f8f9fa; color: #6c757d; border-radius: 4px; font-size: 0.8em; cursor: pointer; transition: all 0.15s;';
                }

                button.addEventListener('click', async function() {
                    // すべてのボタンのスタイルをリセット
                    dateButtonsContainer.querySelectorAll('button').forEach(btn => {
                        btn.style.cssText = 'padding: 4px 8px; border: 1px solid #ced4da; background: #f8f9fa; color: #6c757d; border-radius: 4px; font-size: 0.8em; cursor: pointer; transition: all 0.15s;';
                    });

                    // クリックされたボタンを選択状態にする
                    this.style.cssText = 'padding: 4px 8px; border: 1px solid #667eea; background: #667eea; color: white; border-radius: 4px; font-size: 0.8em; cursor: pointer; transition: all 0.15s;';

                    // 隠しフィールドに日付を設定
                    document.getElementById('targetDate').value = this.dataset.date;

                    // 番組表を自動取得
                    await fetchPrograms();
                });

                dateButtonsContainer.appendChild(button);

                // 今日のボタンの場合、初期表示用にクリックイベントを保存
                if (i === 0) {
                    // DOMContentLoaded完了後に自動で番組表を取得
                    setTimeout(() => {
                        button.click();
                    }, 100);
                }
            }

            // エリアのデフォルトを大阪に設定
            document.getElementById('areaId').value = 'JP27';

            // スマホ用date pickerの初期値と範囲を設定
            const datePicker = document.getElementById('datePicker');
            datePicker.value = dateStr;

            // 選択可能な日付範囲を設定（過去7日～未来7日）
            const minDate = new Date(today);
            minDate.setDate(minDate.getDate() - 7);
            const maxDate = new Date(today);
            maxDate.setDate(maxDate.getDate() + 7);

            const minDateStr = `${minDate.getFullYear()}-${String(minDate.getMonth() + 1).padStart(2, '0')}-${String(minDate.getDate()).padStart(2, '0')}`;
            const maxDateStr = `${maxDate.getFullYear()}-${String(maxDate.getMonth() + 1).padStart(2, '0')}-${String(maxDate.getDate()).padStart(2, '0')}`;

            datePicker.min = minDateStr;
            datePicker.max = maxDateStr;

            datePicker.addEventListener('change', async function() {
                // 選択された日付を隠しフィールドに設定
                document.getElementById('targetDate').value = this.value;

                // 番組表を自動取得
                await fetchPrograms();
            });
        });

        // 「番組表を取得」ボタンは強制更新
        document.getElementById('fetchBtn').addEventListener('click', () => fetchPrograms(true));
        document.getElementById('searchAllBtn').addEventListener('click', searchAllAreas);

        // エリア選択変更時に自動取得（キャッシュ利用）
        document.getElementById('areaId').addEventListener('change', () => fetchPrograms(false));

        // 検索キーワード入力時にリアルタイムフィルタリング
        document.getElementById('searchKeyword').addEventListener('input', function() {
            // クリアボタンの表示/非表示を切り替え
            const clearBtn = document.getElementById('clearSearchBtn');
            if (clearBtn) {
                clearBtn.style.display = this.value ? 'block' : 'none';
            }

            if (allProgramsData.length > 0) {
                displayPrograms(allProgramsData);
            }
        });

        // 検索キーワードをクリア
        function clearSearchKeyword() {
            const searchInput = document.getElementById('searchKeyword');
            const clearBtn = document.getElementById('clearSearchBtn');

            searchInput.value = '';
            if (clearBtn) {
                clearBtn.style.display = 'none';
            }

            // フィルタリングを更新
            if (allProgramsData.length > 0) {
                displayPrograms(allProgramsData);
            }
        }

        async function fetchPrograms(forceRefresh = false) {
            const areaId = document.getElementById('areaId').value;
            const proxyUrl = document.getElementById('proxyUrl').value;
            const targetDate = document.getElementById('targetDate').value;

            if (!areaId) {
                showError('エリアを選択してください');
                return;
            }

            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const programList = document.getElementById('programList');
            const fetchBtn = document.getElementById('fetchBtn');

            loading.style.display = 'block';
            error.style.display = 'none';
            programList.innerHTML = '';
            fetchBtn.disabled = true;

            try {
                // DB APIから番組表を取得
                const baseApiUrl = proxyUrl.trim() || '';
                const dateStr = targetDate ? targetDate.replace(/-/g, '') : new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const forceParam = forceRefresh ? '?force=true' : '';
                const apiUrl = `${baseApiUrl}/api/programs/area/${areaId}/date/${dateStr}${forceParam}`;

                console.log('📡 Fetching from DB API:', apiUrl, forceRefresh ? '(強制更新)' : '');
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || '番組表の取得に失敗しました');
                }

                console.log(`✅ Loaded ${data.count} programs from DB`);

                // DB APIのレスポンスをフロントエンド形式に変換
                const allPrograms = data.programs.map(prog => ({
                    stationId: prog.stationId,
                    stationName: prog.stationName,
                    title: prog.title,
                    ft: new Date(prog.ft),
                    to: new Date(prog.to),
                    desc: prog.desc || '説明なし',
                    pfm: prog.pfm || '',
                    info: prog.info || '',
                    url: prog.url || ''
                }));

                // 時刻順にソート
                allPrograms.sort((a, b) => a.ft - b.ft);

                displayPrograms(allPrograms);

            } catch (err) {
                showError(`エラーが発生しました: ${err.message}`);
            } finally {
                loading.style.display = 'none';
                fetchBtn.disabled = false;
            }
        }

        function parseRadikoTime(timeStr) {
            const year = parseInt(timeStr.substring(0, 4), 10);
            const month = parseInt(timeStr.substring(4, 6), 10) - 1;
            const day = parseInt(timeStr.substring(6, 8), 10);
            const hour = parseInt(timeStr.substring(8, 10), 10);
            const minute = parseInt(timeStr.substring(10, 12), 10);
            const second = parseInt(timeStr.substring(12, 14), 10);
            return new Date(year, month, day, hour, minute, second);
        }

        function formatDateTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hour = String(date.getHours()).padStart(2, '0');
            const minute = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day} ${hour}:${minute}`;
        }

        function displayPrograms(programs) {
            const programList = document.getElementById('programList');
            programList.innerHTML = '';
            allProgramsData = programs;

            if (programs.length === 0) {
                programList.innerHTML = '<p class="loading">番組が見つかりませんでした</p>';
                return;
            }

            // 検索キーワードでフィルタリング
            const searchKeyword = document.getElementById('searchKeyword').value.trim().toLowerCase();
            const searchInfo = document.getElementById('searchInfo');
            let filteredPrograms = programs;

            if (searchKeyword) {
                filteredPrograms = programs.filter(prog =>
                    prog.title.toLowerCase().includes(searchKeyword) ||
                    (prog.pfm && prog.pfm.toLowerCase().includes(searchKeyword)) ||
                    (prog.desc && prog.desc.toLowerCase().includes(searchKeyword))
                );

                searchInfo.textContent = `「${searchKeyword}」の検索結果: ${filteredPrograms.length}件 / 全${programs.length}件`;
                searchInfo.style.display = 'block';
            } else {
                searchInfo.style.display = 'none';
            }

            if (filteredPrograms.length === 0) {
                const noResultMsg = document.createElement('p');
                noResultMsg.className = 'loading';
                noResultMsg.style.gridColumn = '1 / -1';
                noResultMsg.textContent = `「${searchKeyword}」に一致する番組が見つかりませんでした`;
                programList.appendChild(noResultMsg);
                return;
            }

            // 日付ごとにグループ化（朝5時を日付の変わり目とする）
            const dateMap = new Map();
            filteredPrograms.forEach((prog, index) => {
                prog._index = programs.indexOf(prog); // 元のインデックスを保存
                const progDate = new Date(prog.ft);

                // 朝5時未満の番組は前日として扱う
                const displayDate = new Date(progDate);
                if (displayDate.getHours() < 5) {
                    displayDate.setDate(displayDate.getDate() - 1);
                }

                const dateKey = `${displayDate.getFullYear()}-${String(displayDate.getMonth() + 1).padStart(2, '0')}-${String(displayDate.getDate()).padStart(2, '0')}`;

                if (!dateMap.has(dateKey)) {
                    dateMap.set(dateKey, {
                        date: displayDate,
                        programs: []
                    });
                }
                dateMap.get(dateKey).programs.push(prog);
            });

            // 日付順にソート
            const sortedDates = Array.from(dateMap.keys()).sort();

            // 日付ごとに表示
            sortedDates.forEach(dateKey => {
                const dateGroup = dateMap.get(dateKey);
                const programDate = dateGroup.date;
                const year = programDate.getFullYear();
                const month = programDate.getMonth() + 1;
                const day = programDate.getDate();
                const dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'][programDate.getDay()];

                // 日付ヘッダー
                const dateHeaderElement = document.createElement('div');
                dateHeaderElement.style.cssText = 'grid-column: 1 / -1; padding: 15px 20px; margin-bottom: 20px; margin-top: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); text-align: center;';
                dateHeaderElement.innerHTML = `
                    <div style="font-size: 1.3em; font-weight: bold; margin-bottom: 5px;">
                        📅 ${year}年${month}月${day}日（${dayOfWeek}）
                    </div>
                    <div style="font-size: 0.9em; opacity: 0.95;">
                        ${dateGroup.programs.length}件の番組
                    </div>
                `;
                programList.appendChild(dateHeaderElement);

                // この日付の番組を放送局ごとにグループ化
                const stationMap = new Map();
                dateGroup.programs.forEach(prog => {
                    if (!stationMap.has(prog.stationId)) {
                        stationMap.set(prog.stationId, {
                            name: prog.stationName,
                            id: prog.stationId,
                            programs: []
                        });
                    }
                    stationMap.get(prog.stationId).programs.push(prog);
                });

                displayStations(stationMap, programList);
            });
        }

        function displayStations(stationMap, programList) {
            // スマホ用: 放送局選択のオプションを生成
            const isMobile = window.innerWidth <= 768;
            const mobileStationSelect = document.getElementById('mobileStationSelect');

            if (isMobile && mobileStationSelect) {
                // グローバル変数に保存
                currentStationMap = stationMap;
                currentProgramList = programList;

                // オプションをクリア（最初のデフォルトオプション以外）
                while (mobileStationSelect.options.length > 1) {
                    mobileStationSelect.remove(1);
                }

                // 放送局のオプションを追加
                const stationArray = Array.from(stationMap.values());
                stationArray.forEach(station => {
                    const option = document.createElement('option');
                    option.value = station.id;
                    option.textContent = `${station.name} (${station.id})`;
                    mobileStationSelect.appendChild(option);
                });

                // 最初の放送局を自動選択
                if (stationArray.length > 0) {
                    const firstStationId = stationArray[0].id;
                    mobileStationSelect.value = firstStationId;

                    // 変更イベントを追加（初回のみ）
                    if (!mobileStationSelect.dataset.initialized) {
                        mobileStationSelect.addEventListener('change', function() {
                            const selectedStationId = this.value;
                            if (selectedStationId && currentStationMap && currentProgramList) {
                                // 選択された放送局のみを表示
                                displaySelectedStation(currentStationMap, currentProgramList, selectedStationId);
                            }
                        });
                        mobileStationSelect.dataset.initialized = 'true';
                    }

                    // 初回表示: 最初の放送局を表示
                    displaySelectedStation(stationMap, programList, firstStationId);
                    return; // スマホの場合はここで終了
                }
            }

            // PC用: 各放送局の列を作成
            stationMap.forEach((station, stationId) => {
                const column = document.createElement('div');
                column.className = 'station-column';

                const header = document.createElement('div');
                header.className = 'station-header';
                header.textContent = `${station.name} (${station.id})`;
                column.appendChild(header);

                const programsContainer = document.createElement('div');
                programsContainer.className = 'station-programs';

                const now = new Date();
                let nowPlayingCard = null;

                // 時刻順にソート
                station.programs.sort((a, b) => a.ft - b.ft);

                station.programs.forEach(prog => {
                    const card = document.createElement('div');
                    card.className = 'program-card';

                    // 放送中の番組をハイライト
                    if (prog.ft <= now && prog.to > now) {
                        card.classList.add('now-playing');
                        nowPlayingCard = card;
                    }

                    const startTime = `${String(prog.ft.getHours()).padStart(2, '0')}:${String(prog.ft.getMinutes()).padStart(2, '0')}`;
                    const endTime = `${String(prog.to.getHours()).padStart(2, '0')}:${String(prog.to.getMinutes()).padStart(2, '0')}`;

                    // 番組が終了しているかチェック
                    const isPastProgram = prog.to < now;
                    const isFutureProgram = prog.ft > now;

                    // radikoのURL
                    const radikoTime = formatRadikoUrl(prog.ft);
                    const radikoUrl = `https://radiko.jp/#!/ts/${prog.stationId}/${radikoTime}`;

                    // ボタンを生成
                    let buttonsHtml = '';

                    // 終了済み番組：ダウンロードボタン
                    if (isPastProgram) {
                        buttonsHtml += `<button class="btn-action btn-download" onclick='showDownloadCommandByIndex(${prog._index})'>DL</button>`;
                    }

                    // 未来の番組または放送中の番組：予約ボタン
                    if (!isPastProgram) {
                        buttonsHtml += `<button class="btn-action btn-at" onclick='showAtCommandByIndex(${prog._index})'>予約</button>`;
                    }

                    // 定期録音ボタン（常に表示）
                    buttonsHtml += `<button class="btn-action btn-cron" onclick='showCronCommandByIndex(${prog._index})'>定期</button>`;

                    // radikoボタン（常に表示）
                    buttonsHtml += `<a href="${radikoUrl}" target="_blank" rel="noopener noreferrer" style="background: white; border: 1px solid #ddd; padding: 3px; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; line-height: 1; border-radius: 4px; width: 24px; height: 24px;" title="radikoで聴く"><img src="img/radiko.png" alt="radiko" style="width: 18px; height: 18px; display: block;"></a>`;

                    card.innerHTML = `
                        <div class="program-time">${startTime} - ${endTime}</div>
                        <div class="program-title" onclick='showProgramDetailByIndex(${prog._index})' style="cursor: pointer; color: #007bff;">${prog.title}</div>
                        ${prog.pfm ? `<div class="program-detail">${prog.pfm}</div>` : ''}
                        <div class="program-actions">
                            ${buttonsHtml}
                        </div>
                    `;

                    programsContainer.appendChild(card);
                });

                column.appendChild(programsContainer);
                programList.appendChild(column);

                // 各放送局のコンテナ内で放送中の番組にスクロール
                if (nowPlayingCard) {
                    setTimeout(() => {
                        // station-programs コンテナ内での位置を計算
                        const containerTop = programsContainer.offsetTop;
                        const cardTop = nowPlayingCard.offsetTop;
                        const scrollPosition = cardTop - containerTop - 20; // 20pxの余白

                        programsContainer.scrollTop = scrollPosition;
                    }, 100);
                }
            });
        }

        // スマホ用: 選択された放送局のみを表示
        function displaySelectedStation(stationMap, programList, selectedStationId) {
            // 既存の内容をクリア
            programList.innerHTML = '';

            // 選択された放送局を取得
            const selectedStation = stationMap.get(selectedStationId);
            if (!selectedStation) return;

            const column = document.createElement('div');
            column.className = 'station-column';

            const programsContainer = document.createElement('div');
            programsContainer.className = 'station-programs';

            const now = new Date();
            let nowPlayingCard = null;

            // 時刻順にソート
            selectedStation.programs.sort((a, b) => a.ft - b.ft);

            selectedStation.programs.forEach(prog => {
                const card = document.createElement('div');
                card.className = 'program-card';

                // 放送中の番組をハイライト
                if (prog.ft <= now && prog.to > now) {
                    card.classList.add('now-playing');
                    nowPlayingCard = card;
                }

                const startTime = `${String(prog.ft.getHours()).padStart(2, '0')}:${String(prog.ft.getMinutes()).padStart(2, '0')}`;
                const endTime = `${String(prog.to.getHours()).padStart(2, '0')}:${String(prog.to.getMinutes()).padStart(2, '0')}`;

                // 番組が終了しているかチェック
                const isPastProgram = prog.to < now;
                const isFutureProgram = prog.ft > now;

                // radikoのURL
                const radikoTime = formatRadikoUrl(prog.ft);
                const radikoUrl = `https://radiko.jp/#!/ts/${prog.stationId}/${radikoTime}`;

                // ボタンを生成
                let buttonsHtml = '';

                // 終了済み番組：ダウンロードボタン
                if (isPastProgram) {
                    buttonsHtml += `<button class="btn-action btn-download" onclick='showDownloadCommandByIndex(${prog._index})'>DL</button>`;
                }

                // 未来の番組または放送中の番組：予約ボタン
                if (!isPastProgram) {
                    buttonsHtml += `<button class="btn-action btn-at" onclick='showAtCommandByIndex(${prog._index})'>予約</button>`;
                }

                // 定期録音ボタン（常に表示）
                buttonsHtml += `<button class="btn-action btn-cron" onclick='showCronCommandByIndex(${prog._index})'>定期</button>`;

                // radikoボタン（常に表示）
                buttonsHtml += `<a href="${radikoUrl}" target="_blank" rel="noopener noreferrer" style="background: white; border: 1px solid #ddd; padding: 3px; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; line-height: 1; border-radius: 4px; width: 24px; height: 24px;" title="radikoで聴く"><img src="img/radiko.png" alt="radiko" style="width: 18px; height: 18px; display: block;"></a>`;

                card.innerHTML = `
                    <div class="program-time">${startTime} - ${endTime}</div>
                    <div class="program-title" onclick='showProgramDetailByIndex(${prog._index})' style="cursor: pointer; color: #007bff;">${prog.title}</div>
                    ${prog.pfm ? `<div class="program-detail">${prog.pfm}</div>` : ''}
                    <div class="program-actions">
                        ${buttonsHtml}
                    </div>
                `;

                programsContainer.appendChild(card);
            });

            column.appendChild(programsContainer);
            programList.appendChild(column);

            // 放送中の番組にスクロール
            if (nowPlayingCard) {
                setTimeout(() => {
                    nowPlayingCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            }
        }

        function showCronCommandByIndex(index) {
            showCronCommand(allProgramsData[index]);
        }

        function showDownloadCommandByIndex(index) {
            showDownloadCommand(allProgramsData[index]);
        }

        function showAtCommandByIndex(index) {
            showAtCommand(allProgramsData[index]);
        }

        function showProgramDetailByIndex(index) {
            showProgramDetail(allProgramsData[index]);
        }

        function cleanupDescription(text) {
            if (!text) return '';

            // &nbsp;を通常のスペースに変換
            let cleaned = text.replace(/&nbsp;/gi, ' ');

            // 連続する<br>を1つの改行に変換
            cleaned = cleaned.replace(/(<br\s*\/?>)+/gi, '\n');

            // 連続する空行を1つに
            cleaned = cleaned.replace(/\n{3,}/g, '\n\n');

            // 連続するスペースを1つに
            cleaned = cleaned.replace(/ {2,}/g, ' ');

            // 前後の空白を削除
            cleaned = cleaned.trim();

            return cleaned;
        }

        function showProgramDetail(prog) {
            const startTime = `${String(prog.ft.getHours()).padStart(2, '0')}:${String(prog.ft.getMinutes()).padStart(2, '0')}`;
            const endTime = `${String(prog.to.getHours()).padStart(2, '0')}:${String(prog.to.getMinutes()).padStart(2, '0')}`;
            const dateStr = `${prog.ft.getFullYear()}/${prog.ft.getMonth() + 1}/${prog.ft.getDate()}`;

            // radikoの番組ページURL（秒まで含む14桁形式）
            const radikoTime = formatRadikoUrl(prog.ft);
            const radikoUrl = `https://radiko.jp/#!/ts/${prog.stationId}/${radikoTime}`;

            // 番組説明をクリーンアップ
            const cleanDesc = cleanupDescription(prog.desc);

            let detailHtml = `
                <div style="font-size: 14px; line-height: 1.6; color: #333;">
                    <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #ddd;">
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">${prog.title}</div>
                        <div style="color: #666; font-size: 13px; margin-bottom: 8px;">
                            <div>${prog.stationName} (${prog.stationId})</div>
                            <div>${dateStr} ${startTime} - ${endTime}</div>
                        </div>
                        <div>
                            <a href="${radikoUrl}" target="_blank" rel="noopener noreferrer"
                               style="display: inline-block; padding: 8px 16px; background: #667eea; color: white; text-decoration: none; border-radius: 6px; font-size: 13px; font-weight: 600;">
                                📻 radikoで聴く
                            </a>
                        </div>
                    </div>
            `;

            if (prog.pfm) {
                const cleanPfm = cleanupDescription(prog.pfm);
                detailHtml += `
                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: bold; margin-bottom: 4px; font-size: 13px; color: #555;">出演者</div>
                        <div style="padding: 8px 10px; background: #f5f5f5; border-left: 3px solid #007bff; font-size: 13px; white-space: pre-line;">${cleanPfm}</div>
                    </div>
                `;
            }

            if (cleanDesc && cleanDesc !== '説明なし') {
                // テンポラリ要素でHTMLをパース
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = cleanDesc;

                detailHtml += `
                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: bold; margin-bottom: 4px; font-size: 13px; color: #555;">番組説明</div>
                        <div style="padding: 8px 10px; background: #f5f5f5; border-left: 3px solid #007bff; font-size: 13px; line-height: 1.8; white-space: pre-line;">${tempDiv.innerHTML}</div>
                    </div>
                `;
            }

            if (prog.url) {
                detailHtml += `
                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: bold; margin-bottom: 4px; font-size: 13px; color: #555;">URL</div>
                        <div style="padding: 8px 10px; background: #f5f5f5; border-left: 3px solid #007bff; font-size: 13px; word-break: break-all;">
                            <a href="${prog.url}" target="_blank" style="color: #007bff; text-decoration: none;">${prog.url}</a>
                        </div>
                    </div>
                `;
            }

            if (prog.info) {
                const cleanInfo = cleanupDescription(prog.info);
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = cleanInfo;

                detailHtml += `
                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: bold; margin-bottom: 4px; font-size: 13px; color: #555;">その他情報</div>
                        <div style="padding: 8px 10px; background: #f5f5f5; border-left: 3px solid #007bff; font-size: 12px; color: #666; line-height: 1.8; white-space: pre-line;">${tempDiv.innerHTML}</div>
                    </div>
                `;
            }

            detailHtml += '</div>';

            currentCommand = ''; // コマンドはクリアする
            document.getElementById('modalTitle').textContent = '番組詳細';
            document.getElementById('commandBox').innerHTML = detailHtml;
            document.getElementById('modal').classList.add('active');
        }

        function showCronCommand(prog) {
            const scriptPath = document.getElementById('scriptPath').value;
            const startTime = new Date(prog.ft);
            const endTime = new Date(prog.to);

            // cron実行時刻（番組終了の5分後）
            const cronExecTime = new Date(prog.to);
            cronExecTime.setMinutes(cronExecTime.getMinutes() + 5);
            const minute = cronExecTime.getMinutes();
            const hour = cronExecTime.getHours();
            const dayOfWeek = cronExecTime.getDay();

            // 開始時刻と終了時刻（時分のみ、番組表通り）
            const startHHMM = `${String(startTime.getHours()).padStart(2, '0')}${String(startTime.getMinutes()).padStart(2, '0')}`;
            const endHHMM = `${String(endTime.getHours()).padStart(2, '0')}${String(endTime.getMinutes()).padStart(2, '0')}`;

            // 録音開始日とcron実行日の日付を比較
            // 録音開始日がcron実行日と異なる場合、開始日はcron実行日の前日
            const startDateForCron = `${startTime.getFullYear()}-${String(startTime.getMonth()+1).padStart(2,'0')}-${String(startTime.getDate()).padStart(2,'0')}`;
            const cronExecDateStr = `${cronExecTime.getFullYear()}-${String(cronExecTime.getMonth()+1).padStart(2,'0')}-${String(cronExecTime.getDate()).padStart(2,'0')}`;
            const endDateForCron = `${endTime.getFullYear()}-${String(endTime.getMonth()+1).padStart(2,'0')}-${String(endTime.getDate()).padStart(2,'0')}`;

            // 開始日がcron実行日と異なる場合
            const startNeedsYesterday = startDateForCron !== cronExecDateStr;
            // 終了日がcron実行日と異なる場合
            const endNeedsYesterday = endDateForCron !== cronExecDateStr;

            // 日付計算の部分
            let startDateCalc = '';
            if (startNeedsYesterday) {
                // cron実行日の前日を録音開始日とする
                startDateCalc = '\`date -d yesterday +\\%Y\\%m\\%d\`';
            } else {
                // cron実行日と同じ日を録音開始日とする
                startDateCalc = '\`date +\\%Y\\%m\\%d\`';
            }

            // 録音終了日の計算
            let endDateCalc = '';
            if (endNeedsYesterday) {
                // cron実行日の前日を録音終了日とする
                endDateCalc = '\`date -d yesterday +\\%Y\\%m\\%d\`';
            } else {
                // cron実行日と同じ日を録音終了日とする
                endDateCalc = '\`date +\\%Y\\%m\\%d\`';
            }

            // タイトルをサニタイズ（スペースをアンダーバーに、全角記号を半角に）
            const safeTitle = sanitizeFilename(prog.title);

            // cronコマンド（動的な日付を使用、サニタイズしたタイトルを使用）
            const command = `${minute} ${hour} * * ${dayOfWeek} ${scriptPath} "${safeTitle}" "${prog.stationId}" "${prog.stationId}" "${startDateCalc}${startHHMM}" "${endDateCalc}${endHHMM}" "" "" "" >> /tmp/myradiko_output.log 2>&1`;

            currentCommand = command;
            currentProgramData = prog; // プログラム情報を保存
            document.getElementById('modalTitle').textContent = `定期録音 - ${prog.title}`;

            // 番組情報を見やすく表示
            const startDateStr = `${startTime.getFullYear()}/${String(startTime.getMonth() + 1).padStart(2, '0')}/${String(startTime.getDate()).padStart(2, '0')}`;
            const startTimeStr = `${String(startTime.getHours()).padStart(2, '0')}:${String(startTime.getMinutes()).padStart(2, '0')}`;
            const endTimeStr = `${String(endTime.getHours()).padStart(2, '0')}:${String(endTime.getMinutes()).padStart(2, '0')}`;

            const durationMinutes = Math.floor((endTime - startTime) / 60000);
            const durationHours = Math.floor(durationMinutes / 60);
            const durationMins = durationMinutes % 60;
            const durationStr = durationHours > 0 ? `${durationHours}時間${durationMins}分` : `${durationMins}分`;

            // 実行時刻の説明
            const execTimeStr = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
            const daysOfWeekJp = ['日曜日', '月曜日', '火曜日', '水曜日', '木曜日', '金曜日', '土曜日'];
            const daysOfWeekShort = ['日', '月', '火', '水', '木', '金', '土'];
            const dayLabel = daysOfWeekJp[dayOfWeek];
            const dayShort = daysOfWeekShort[dayOfWeek];

            const commandBoxContent = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 20px; margin-bottom: 15px; color: white;">
                    <div style="font-size: 1.3em; font-weight: 700; margin-bottom: 10px; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                        📻 ${prog.title}
                    </div>
                    <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px 15px; font-size: 0.95em; line-height: 1.6;">
                        <div style="opacity: 0.9;">放送局:</div>
                        <div style="font-weight: 600;">${prog.stationName || prog.stationId}</div>

                        <div style="opacity: 0.9;">放送日:</div>
                        <div style="font-weight: 600;">毎週${dayLabel}</div>

                        <div style="opacity: 0.9;">時間:</div>
                        <div style="font-weight: 600;">${startTimeStr} 〜 ${endTimeStr} （${durationStr}）</div>
                    </div>
                </div>

                <div style="background: #e8f5e9; border: 2px solid #4caf50; border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                    <div style="font-size: 1.2em; font-weight: 700; color: #2e7d32; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        🔁 定期実行スケジュール
                    </div>
                    <div style="font-size: 1.4em; font-weight: 700; color: #388e3c; margin-bottom: 8px;">
                        毎週${dayLabel} ${execTimeStr}
                    </div>
                    <div style="color: #2e7d32; font-size: 0.9em;">
                        📝 番組終了の5分後に毎週自動で録音します
                    </div>
                </div>

                <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; border: 1px solid #e9ecef;">
                    <div style="color: #6c757d; font-size: 0.85em; margin-bottom: 8px; font-weight: 600;">📝 cronコマンド</div>
                    <details>
                        <summary style="cursor: pointer; color: #667eea; font-size: 0.9em; user-select: none;">
                            クリックして表示
                        </summary>
                        <div style="font-family: 'Courier New', monospace; background: #ffffff; padding: 12px; border-radius: 4px; font-size: 0.85em; margin-top: 10px; border: 1px solid #dee2e6; word-break: break-all; color: #495057;">
                            ${command}
                        </div>
                    </details>
                </div>

                <div style="background: #fff3e0; border-left: 4px solid #ff9800; padding: 12px; margin-top: 15px; border-radius: 4px;">
                    <div style="color: #e65100; font-size: 0.9em; display: flex; align-items: center; gap: 8px;">
                        <span>💡</span>
                        <span>「cron登録」ボタンを押すと、毎週自動で録音が実行されます</span>
                    </div>
                </div>
            `;

            document.getElementById('commandBox').innerHTML = commandBoxContent;
            document.getElementById('executeBtn').style.display = 'none';

            // cron登録ボタンを表示
            const registerBtn = document.getElementById('registerCronBtn');
            if (registerBtn) {
                registerBtn.style.display = 'inline-block';
                registerBtn.onclick = () => addCronJob(command);
            }

            document.getElementById('modal').classList.add('active');
        }

        async function showDownloadCommand(prog) {
            const scriptPath = document.getElementById('scriptPath').value;
            const endTime = new Date(prog.to);
            endTime.setMinutes(endTime.getMinutes() + 5);

            const startStr = formatRadikoTime(new Date(prog.ft));
            const endStr = formatRadikoTime(endTime);

            const command = `${scriptPath} -s ${startStr} -e ${endStr} -i ${prog.stationId}`;

            currentCommand = command;
            currentProgramData = prog; // 実行用にデータを保存
            document.getElementById('modalTitle').textContent = `ダウンロード - ${prog.title}`;

            // ファイルの存在確認
            const fileCheck = await checkFileExists(prog);

            let commandBoxContent = command;

            if (fileCheck && fileCheck.exists) {
                const proxyUrl = document.getElementById('proxyUrl').value;
                const baseUrl = proxyUrl.trim() || '';
                const downloadUrl = `${baseUrl}/download/${fileCheck.path}`;

                commandBoxContent = `
                    <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <div style="color: #856404; font-weight: bold; margin-bottom: 8px; font-size: 1.1em;">⚠️ このファイルは既に録音済みです</div>
                        <div style="color: #856404; font-size: 0.9em; margin-bottom: 10px;">ファイル名: ${fileCheck.filename}</div>
                        <a href="${downloadUrl}" download="${fileCheck.filename}"
                           style="display: inline-block; padding: 8px 16px; background: #667eea; color: white; text-decoration: none; border-radius: 4px; font-weight: 600; font-size: 0.9em;">
                            📥 既存ファイルをダウンロード
                        </a>
                    </div>
                    <div style="font-family: 'Courier New', monospace; background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 0.9em; color: #6c757d;">
                        ${command}
                    </div>
                    <div style="margin-top: 10px; font-size: 0.85em; color: #856404;">
                        ※ 「実行」ボタンを押すと既存ファイルが上書きされます
                    </div>
                `;
            } else {
                // 番組情報を見やすく表示
                const startTime = new Date(prog.ft);
                const endTime = new Date(prog.to);

                const startDateStr = `${startTime.getFullYear()}/${String(startTime.getMonth() + 1).padStart(2, '0')}/${String(startTime.getDate()).padStart(2, '0')}`;
                const startTimeStr = `${String(startTime.getHours()).padStart(2, '0')}:${String(startTime.getMinutes()).padStart(2, '0')}`;
                const endTimeStr = `${String(endTime.getHours()).padStart(2, '0')}:${String(endTime.getMinutes()).padStart(2, '0')}`;

                const durationMinutes = Math.floor((endTime - startTime) / 60000);
                const durationHours = Math.floor(durationMinutes / 60);
                const durationMins = durationMinutes % 60;
                const durationStr = durationHours > 0 ? `${durationHours}時間${durationMins}分` : `${durationMins}分`;

                commandBoxContent = `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 20px; margin-bottom: 15px; color: white;">
                        <div style="font-size: 1.3em; font-weight: 700; margin-bottom: 10px; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                            📻 ${prog.title}
                        </div>
                        <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px 15px; font-size: 0.95em; line-height: 1.6;">
                            <div style="opacity: 0.9;">放送局:</div>
                            <div style="font-weight: 600;">${prog.stationName || prog.stationId}</div>

                            <div style="opacity: 0.9;">放送日:</div>
                            <div style="font-weight: 600;">${startDateStr}</div>

                            <div style="opacity: 0.9;">時間:</div>
                            <div style="font-weight: 600;">${startTimeStr} 〜 ${endTimeStr} （${durationStr}）</div>
                        </div>
                    </div>

                    <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; border: 1px solid #e9ecef;">
                        <div style="color: #6c757d; font-size: 0.85em; margin-bottom: 8px; font-weight: 600;">📝 録音コマンド</div>
                        <details>
                            <summary style="cursor: pointer; color: #667eea; font-size: 0.9em; user-select: none;">
                                クリックして表示
                            </summary>
                            <div style="font-family: 'Courier New', monospace; background: #ffffff; padding: 12px; border-radius: 4px; font-size: 0.85em; margin-top: 10px; border: 1px solid #dee2e6; word-break: break-all; color: #495057;">
                                ${command}
                            </div>
                        </details>
                    </div>

                    <div style="background: #e7f3ff; border-left: 4px solid #2196f3; padding: 12px; margin-top: 15px; border-radius: 4px;">
                        <div style="color: #1976d2; font-size: 0.9em; display: flex; align-items: center; gap: 8px;">
                            <span>💡</span>
                            <span>「実行」ボタンを押すと、この番組の録音をすぐに開始します</span>
                        </div>
                    </div>
                `;
            }

            document.getElementById('commandBox').innerHTML = commandBoxContent;
            document.getElementById('executeBtn').style.display = 'inline-block';
            document.getElementById('modal').classList.add('active');
        }

        async function showAtCommand(prog) {
            const scriptPath = document.getElementById('scriptPath').value;
            const startTime = new Date(prog.ft);
            const endTime = new Date(prog.to);

            // at実行時刻（番組終了の5分後）
            const atExecTime = new Date(prog.to);
            atExecTime.setMinutes(atExecTime.getMinutes() + 5);

            // 開始時刻と終了時刻（YYYYMMDDHHmm形式）
            const startStr = formatRadikoTime(startTime);
            const endStr = formatRadikoTime(endTime);

            // at実行時刻
            const atTime = `${String(atExecTime.getHours()).padStart(2, '0')}:${String(atExecTime.getMinutes()).padStart(2, '0')} ${atExecTime.getFullYear()}-${String(atExecTime.getMonth() + 1).padStart(2, '0')}-${String(atExecTime.getDate()).padStart(2, '0')}`;

            // タイトルをサニタイズ（スペースをアンダーバーに、全角記号を半角に）
            const safeTitle = sanitizeFilename(prog.title);

            // cronと同じ形式のコマンド（サニタイズしたタイトルを使用）
            const command = `echo '${scriptPath} "${safeTitle}" "${prog.stationId}" "${prog.stationId}" "${startStr}" "${endStr}" "" "" "" >> /tmp/myradiko_output.log 2>&1' | at ${atTime}`;

            currentCommand = command;
            currentProgramData = prog; // 実行用にデータを保存
            document.getElementById('modalTitle').textContent = `予約 - ${prog.title}`;

            // ファイルの存在確認
            const fileCheck = await checkFileExists(prog);

            let commandBoxContent = command;

            if (fileCheck && fileCheck.exists) {
                const proxyUrl = document.getElementById('proxyUrl').value;
                const baseUrl = proxyUrl.trim() || '';
                const downloadUrl = `${baseUrl}/download/${fileCheck.path}`;

                commandBoxContent = `
                    <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <div style="color: #856404; font-weight: bold; margin-bottom: 8px; font-size: 1.1em;">⚠️ このファイルは既に録音済みです</div>
                        <div style="color: #856404; font-size: 0.9em; margin-bottom: 10px;">ファイル名: ${fileCheck.filename}</div>
                        <a href="${downloadUrl}" download="${fileCheck.filename}"
                           style="display: inline-block; padding: 8px 16px; background: #667eea; color: white; text-decoration: none; border-radius: 4px; font-weight: 600; font-size: 0.9em;">
                            📥 既存ファイルをダウンロード
                        </a>
                    </div>
                    <div style="font-family: 'Courier New', monospace; background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 0.9em; color: #6c757d;">
                        ${command}
                    </div>
                    <div style="margin-top: 10px; font-size: 0.85em; color: #856404;">
                        ※ 「実行」ボタンを押すと既存ファイルが上書きされます
                    </div>
                `;
            } else {
                // 番組情報を見やすく表示
                const startDateStr = `${startTime.getFullYear()}/${String(startTime.getMonth() + 1).padStart(2, '0')}/${String(startTime.getDate()).padStart(2, '0')}`;
                const startTimeStr = `${String(startTime.getHours()).padStart(2, '0')}:${String(startTime.getMinutes()).padStart(2, '0')}`;
                const endTimeStr = `${String(endTime.getHours()).padStart(2, '0')}:${String(endTime.getMinutes()).padStart(2, '0')}`;

                const durationMinutes = Math.floor((endTime - startTime) / 60000);
                const durationHours = Math.floor(durationMinutes / 60);
                const durationMins = durationMinutes % 60;
                const durationStr = durationHours > 0 ? `${durationHours}時間${durationMins}分` : `${durationMins}分`;

                // 実行予定時刻
                const execTimeStr = `${String(atExecTime.getHours()).padStart(2, '0')}:${String(atExecTime.getMinutes()).padStart(2, '0')}`;
                const execDateStr = `${atExecTime.getFullYear()}/${String(atExecTime.getMonth() + 1).padStart(2, '0')}/${String(atExecTime.getDate()).padStart(2, '0')}`;

                // 曜日を取得
                const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
                const weekday = weekdays[atExecTime.getDay()];

                commandBoxContent = `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 20px; margin-bottom: 15px; color: white;">
                        <div style="font-size: 1.3em; font-weight: 700; margin-bottom: 10px; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                            📻 ${prog.title}
                        </div>
                        <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px 15px; font-size: 0.95em; line-height: 1.6;">
                            <div style="opacity: 0.9;">放送局:</div>
                            <div style="font-weight: 600;">${prog.stationName || prog.stationId}</div>

                            <div style="opacity: 0.9;">放送日:</div>
                            <div style="font-weight: 600;">${startDateStr}</div>

                            <div style="opacity: 0.9;">時間:</div>
                            <div style="font-weight: 600;">${startTimeStr} 〜 ${endTimeStr} （${durationStr}）</div>
                        </div>
                    </div>

                    <div style="background: #fff3e0; border: 2px solid #ff9800; border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                        <div style="font-size: 1.2em; font-weight: 700; color: #e65100; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            ⏰ 予約実行時刻
                        </div>
                        <div style="font-size: 1.4em; font-weight: 700; color: #f57c00; margin-bottom: 8px;">
                            ${execDateStr} (${weekday}) ${execTimeStr}
                        </div>
                        <div style="color: #e65100; font-size: 0.9em;">
                            📝 番組終了の5分後に録音を開始します
                        </div>
                    </div>

                    <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; border: 1px solid #e9ecef;">
                        <div style="color: #6c757d; font-size: 0.85em; margin-bottom: 8px; font-weight: 600;">📝 予約コマンド</div>
                        <details>
                            <summary style="cursor: pointer; color: #667eea; font-size: 0.9em; user-select: none;">
                                クリックして表示
                            </summary>
                            <div style="font-family: 'Courier New', monospace; background: #ffffff; padding: 12px; border-radius: 4px; font-size: 0.85em; margin-top: 10px; border: 1px solid #dee2e6; word-break: break-all; color: #495057;">
                                ${command}
                            </div>
                        </details>
                    </div>

                    <div style="background: #e7f3ff; border-left: 4px solid #2196f3; padding: 12px; margin-top: 15px; border-radius: 4px;">
                        <div style="color: #1976d2; font-size: 0.9em; display: flex; align-items: center; gap: 8px;">
                            <span>💡</span>
                            <span>「実行」ボタンを押すと、指定時刻に自動で録音が開始されます</span>
                        </div>
                    </div>
                `;
            }

            document.getElementById('commandBox').innerHTML = commandBoxContent;
            document.getElementById('executeBtn').style.display = 'inline-block';
            document.getElementById('modal').classList.add('active');
        }

        function formatRadikoTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hour = String(date.getHours()).padStart(2, '0');
            const minute = String(date.getMinutes()).padStart(2, '0');
            // rec_radiko_ts.shは12桁（秒なし）を期待
            return `${year}${month}${day}${hour}${minute}`;
        }

        function formatRadikoUrl(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hour = String(date.getHours()).padStart(2, '0');
            const minute = String(date.getMinutes()).padStart(2, '0');
            const second = String(date.getSeconds()).padStart(2, '0');
            // radikoのURLは14桁（秒まで含む）を期待
            return `${year}${month}${day}${hour}${minute}${second}`;
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            document.getElementById('registerCronBtn').style.display = 'none';
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
        }

        async function executeCommand() {
            if (!currentProgramData) {
                alert('実行可能なコマンドがありません');
                return;
            }

            const prog = currentProgramData;

            // 録音は番組開始から終了まで
            const startTime = new Date(prog.ft);
            const endTime = new Date(prog.to);
            const startStr = formatRadikoTime(startTime);
            const endStr = formatRadikoTime(endTime);

            // at実行時刻は番組終了の5分後
            const atExecTime = new Date(prog.to);
            atExecTime.setMinutes(atExecTime.getMinutes() + 5);

            // currentCommandからat予約かどうかを判定
            const isAtCommand = currentCommand.includes('| at ');

            const executeBtn = document.getElementById('executeBtn');
            executeBtn.disabled = true;
            executeBtn.textContent = '実行中...';

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            // at予約の場合
            if (isAtCommand) {
                const scriptPath = document.getElementById('scriptPath').value;
                const atTime = `${String(atExecTime.getHours()).padStart(2, '0')}:${String(atExecTime.getMinutes()).padStart(2, '0')} ${atExecTime.getFullYear()}-${String(atExecTime.getMonth() + 1).padStart(2, '0')}-${String(atExecTime.getDate()).padStart(2, '0')}`;

                try {
                    const response = await fetch(`${baseUrl}/schedule-at`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            script_path: scriptPath,
                            title: prog.title,
                            start_time: startStr,
                            end_time: endStr,
                            station_id: prog.stationId,
                            at_time: atTime
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        // 曜日を取得
                        const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
                        const weekday = weekdays[atExecTime.getDay()];
                        const execDateStr = `${atExecTime.getFullYear()}/${String(atExecTime.getMonth() + 1).padStart(2, '0')}/${String(atExecTime.getDate()).padStart(2, '0')}`;
                        const execTimeStr = `${String(atExecTime.getHours()).padStart(2, '0')}:${String(atExecTime.getMinutes()).padStart(2, '0')}`;

                        alert(`🎉 予約が完了しました！\n\n📻 番組: ${prog.title}\n📡 放送局: ${prog.stationName || prog.stationId}\n⏰ 録音開始予定: ${execDateStr} (${weekday}) ${execTimeStr}\n\n指定した時刻に自動で録音が開始されます。\n予約の確認は「予約管理」タブから行えます。`);
                        closeModal();

                        // 予約管理タブを自動的に開く
                        setTimeout(() => {
                            document.querySelector('[onclick*="showAtJobsTab"]')?.click();
                        }, 300);
                    } else {
                        alert(`❌ 予約の登録に失敗しました\n\nエラー内容:\n${data.error || '不明なエラーが発生しました'}\n\n時刻設定を確認してもう一度お試しください。`);
                    }
                } catch (err) {
                    console.error('at schedule error:', err);
                    alert(`❌ 予約の登録に失敗しました\n\nエラー内容:\n${err.message}\n\nネットワーク接続を確認してもう一度お試しください。`);
                } finally {
                    executeBtn.disabled = false;
                    executeBtn.textContent = '実行';
                }
                return;
            }

            // 即時実行（DL）の場合
            const commandBox = document.getElementById('commandBox');
            commandBox.innerHTML = `
                <div style="background: #ffffff; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; margin-top: 15px;">
                    <!-- ステータス表示 -->
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                        <div id="statusIcon" style="font-size: 2em;">⏳</div>
                        <div style="flex: 1;">
                            <div id="statusTitle" style="font-weight: 600; font-size: 1.1em; color: #212529; margin-bottom: 5px;">録音を準備中...</div>
                            <div id="statusMessage" style="color: #6c757d; font-size: 0.9em;">myradikoコマンドを実行しています</div>
                        </div>
                    </div>

                    <!-- プログレスバー -->
                    <div style="background: #e9ecef; height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 15px;">
                        <div id="progressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s;"></div>
                    </div>

                    <!-- 詳細ログ（折りたたみ可能） -->
                    <details style="margin-top: 15px;">
                        <summary style="cursor: pointer; padding: 8px; background: #f8f9fa; border-radius: 4px; font-weight: 600; user-select: none; color: #495057;">
                            📋 詳細ログを表示
                        </summary>
                        <div style="background: #212529; color: #e9ecef; padding: 15px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 0.85em; max-height: 300px; overflow-y: auto; margin-top: 10px; line-height: 1.6;" id="logContent"></div>
                    </details>
                </div>
            `;

            // 録音時間を計算（秒単位）
            const totalDurationSeconds = Math.floor((endTime - startTime) / 1000);
            // グローバル変数として保存
            window.recordingTotalDuration = totalDurationSeconds;

            // POSTリクエストで実行
            const response = await fetch(`${baseUrl}/execute`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    title: prog.title,
                    rss: prog.stationId,
                    station: prog.stationId,
                    start_time: startStr,
                    end_time: endStr
                })
            });

            if (!response.ok) {
                addLog('error', `エラー: ${response.statusText}`);
                executeBtn.disabled = false;
                executeBtn.textContent = '実行';
                return;
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = JSON.parse(line.substring(6));
                        addLog(data.type, data.message, data.file);

                        if (data.type === 'success' || data.type === 'error') {
                            executeBtn.disabled = false;
                            executeBtn.textContent = '実行';

                            // 成功時はファイル一覧を更新
                            if (data.type === 'success') {
                                setTimeout(() => loadRecordedFiles(), 1000);
                            }
                        }
                    }
                }
            }
        }

        function addLog(type, message, file) {
            const logContent = document.getElementById('logContent');
            const statusIcon = document.getElementById('statusIcon');
            const statusTitle = document.getElementById('statusTitle');
            const statusMessage = document.getElementById('statusMessage');
            const progressBar = document.getElementById('progressBar');

            // ffmpegのtime=を解析して進捗を計算
            const timeMatch = message.match(/time=(\d{2}):(\d{2}):(\d{2}\.\d+)/);
            if (timeMatch && window.recordingTotalDuration) {
                const hours = parseInt(timeMatch[1]);
                const minutes = parseInt(timeMatch[2]);
                const seconds = parseFloat(timeMatch[3]);
                const currentSeconds = hours * 3600 + minutes * 60 + seconds;

                // 進捗率を計算（0-100%）
                const progressPercent = Math.min(100, Math.round((currentSeconds / window.recordingTotalDuration) * 100));

                // プログレスバーを更新
                if (progressBar) {
                    progressBar.style.width = `${progressPercent}%`;
                }

                // ステータスメッセージを更新
                if (statusTitle) statusTitle.textContent = '録音中...';
                if (statusMessage) {
                    const remainingSeconds = Math.max(0, window.recordingTotalDuration - currentSeconds);
                    const remainingMinutes = Math.floor(remainingSeconds / 60);
                    const remainingSecondsOnly = Math.floor(remainingSeconds % 60);
                    statusMessage.textContent = `進捗: ${progressPercent}% (残り約${remainingMinutes}分${remainingSecondsOnly}秒)`;
                }
            }

            // 詳細ログに追加
            if (logContent) {
                const logLine = document.createElement('div');
                logLine.style.marginBottom = '4px';

                if (type === 'error') {
                    logLine.style.color = '#f48771';
                } else if (type === 'success') {
                    logLine.style.color = '#4ec9b0';
                } else {
                    logLine.style.color = '#d4d4d4';
                }

                logLine.textContent = message;
                logContent.appendChild(logLine);

                // 自動スクロール
                logContent.scrollTop = logContent.scrollHeight;
            }

            // ステータス表示を更新
            if (type === 'info') {
                if (statusIcon) statusIcon.textContent = '⏳';
                // time=がある場合は上で既に更新されているのでスキップ
                if (!timeMatch) {
                    if (statusTitle) statusTitle.textContent = '録音中...';
                    if (statusMessage) statusMessage.textContent = message;
                    if (progressBar) progressBar.style.width = '10%';
                }
            } else if (type === 'success') {
                if (statusIcon) statusIcon.textContent = '✅';
                if (statusTitle) statusTitle.textContent = '録音完了！';
                if (statusMessage) statusMessage.textContent = 'ファイルが保存されました';
                if (progressBar) {
                    progressBar.style.width = '100%';
                    progressBar.style.background = 'linear-gradient(90deg, #4caf50, #45a049)';
                }
            } else if (type === 'error') {
                if (statusIcon) statusIcon.textContent = '❌';
                if (statusTitle) statusTitle.textContent = 'エラーが発生しました';
                if (statusMessage) statusMessage.textContent = message;
                if (progressBar) {
                    progressBar.style.background = 'linear-gradient(90deg, #e57373, #ef5350)';
                }
            }

            // ダウンロードボタンを追加（成功時）
            if (file && type === 'success') {
                const proxyUrl = document.getElementById('proxyUrl').value;
                const baseUrl = proxyUrl.trim() || '';
                const downloadUrl = `${baseUrl}/download/${file}`;
                const filename = file.split('/').pop();

                // commandBoxの中に大きなダウンロードボタンを追加
                const commandBox = document.getElementById('commandBox');
                const downloadSection = document.createElement('div');
                downloadSection.style.marginTop = '15px';
                downloadSection.style.padding = '20px';
                downloadSection.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                downloadSection.style.borderRadius = '8px';
                downloadSection.style.textAlign = 'center';
                downloadSection.innerHTML = `
                    <div style="color: white; font-size: 1.1em; font-weight: 600; margin-bottom: 10px;">
                        🎉 録音が完了しました！
                    </div>
                    <div style="color: rgba(255,255,255,0.9); font-size: 0.9em; margin-bottom: 15px;">
                        ファイル: ${filename.replace(/\.(mp3|m4a|aac|wav)$/i, '')}
                    </div>
                    <a href="${downloadUrl}" download="${filename}"
                       style="display: inline-block; padding: 12px 24px; background: white; color: #667eea; text-decoration: none; font-weight: 600; border-radius: 6px; font-size: 1em; cursor: pointer; transition: all 0.2s;"
                       onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';"
                       onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                        📥 ダウンロード
                    </a>
                `;
                commandBox.querySelector('div').appendChild(downloadSection);
            }
        }

        async function copyCommand(event) {
            try {
                await navigator.clipboard.writeText(currentCommand);
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'コピーしました！';
                btn.style.background = '#28a745';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            } catch (err) {
                alert('コピーに失敗しました: ' + err.message);
            }
        }

        async function searchAllAreas() {
            const searchKeyword = document.getElementById('searchKeyword').value.trim();
            const proxyUrl = document.getElementById('proxyUrl').value;

            if (!searchKeyword) {
                showError('検索キーワードを入力してください');
                return;
            }

            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const programList = document.getElementById('programList');
            const fetchBtn = document.getElementById('fetchBtn');
            const searchAllBtn = document.getElementById('searchAllBtn');

            loading.style.display = 'block';
            loading.querySelector('p').textContent = '検索中...';
            error.style.display = 'none';
            programList.innerHTML = '';
            fetchBtn.disabled = true;
            searchAllBtn.disabled = true;

            try {
                // サーバー側DB検索APIを呼び出す
                // proxyUrlが'/api'の場合、'/api/programs/search'になる
                // proxyUrlが空の場合、'/api/programs/search'になる
                const baseApiUrl = proxyUrl.trim() || '';
                const searchUrl = `${baseApiUrl}/api/programs/search?keyword=${encodeURIComponent(searchKeyword)}`;

                console.log('🔍 Searching via API:', searchUrl);

                const response = await fetch(searchUrl);

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Unknown error');
                }

                console.log(`✅ Found ${data.count} programs from API`);

                // APIレスポンスの形式をフロントエンド形式に変換
                const allPrograms = data.programs.map(prog => ({
                    areaId: prog.areaId,
                    stationId: prog.stationId,
                    stationName: prog.stationName,
                    title: prog.title,
                    ft: new Date(prog.ft),
                    to: new Date(prog.to),
                    desc: prog.desc || '説明なし',
                    pfm: prog.pfm || '',
                    info: prog.info || '',
                    url: prog.url || ''
                }));

                if (allPrograms.length === 0) {
                    showError(`「${searchKeyword}」に一致する番組が見つかりませんでした`);
                } else {
                    // 重複を除去（同じ放送局IDと開始時刻の組み合わせ）
                    const uniquePrograms = [];
                    const seen = new Set();

                    allPrograms.forEach(prog => {
                        const key = `${prog.stationId}_${prog.ft.getTime()}`;
                        if (!seen.has(key)) {
                            seen.add(key);
                            uniquePrograms.push(prog);
                        }
                    });

                    uniquePrograms.sort((a, b) => a.ft - b.ft);
                    displayPrograms(uniquePrograms);
                }

            } catch (err) {
                showError(`エラーが発生しました: ${err.message}`);
                fetchBtn.disabled = false;
                searchAllBtn.disabled = false;
            } finally {
                loading.style.display = 'none';
                loading.querySelector('p').textContent = '番組表を読み込み中...';
                // 検索結果表示中はfetchBtnを無効化したまま（通常の番組表取得時に有効化される）
                searchAllBtn.disabled = false;
            }
        }

        function showError(message) {
            const error = document.getElementById('error');
            error.textContent = message;
            error.style.display = 'block';
        }

        // 録音済みファイル一覧を読み込む
        let allRecordedFiles = [];
        let currentSort = { column: 'modified', direction: 'desc' };
        let currentPage = 1;
        const itemsPerPage = 50;
        let filterText = '';

        // ファイル名から放送日を抽出する関数
        function extractBroadcastDate(filename) {
            // パターン1: YYYY.MM.DD 形式（例: 2025.10.26）
            let match = filename.match(/(\d{4})\.(\d{2})\.(\d{2})/);
            if (match) {
                return `${match[1]}-${match[2]}-${match[3]}`;
            }

            // パターン2: YYYYMMDD 形式（例: 20251026）
            match = filename.match(/(\d{4})(\d{2})(\d{2})/);
            if (match) {
                return `${match[1]}-${match[2]}-${match[3]}`;
            }

            // パターン3: YYYY-MM-DD 形式（例: 2025-10-26）
            match = filename.match(/(\d{4})-(\d{2})-(\d{2})/);
            if (match) {
                return `${match[1]}-${match[2]}-${match[3]}`;
            }

            return null; // 日付が見つからない場合
        }

        async function loadRecordedFiles() {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            const filesLoading = document.getElementById('filesLoading');
            const filesList = document.getElementById('filesList');

            filesLoading.style.display = 'block';
            filesList.innerHTML = '';

            try {
                const response = await fetch(`${baseUrl}/files`);
                if (!response.ok) {
                    console.error('Failed to load recorded files:', response.statusText);
                    filesLoading.style.display = 'none';
                    filesList.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 40px; font-size: 0.95em;">ファイル一覧の取得に失敗しました</div>';
                    return;
                }

                const data = await response.json();
                allRecordedFiles = data.files || [];

                filesLoading.style.display = 'none';

                if (allRecordedFiles.length === 0) {
                    filesList.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px;">
                            <div style="font-size: 3em; margin-bottom: 15px;">📭</div>
                            <div style="color: #6c757d; font-size: 1.1em; font-weight: 500;">録音済みファイルはありません</div>
                            <div style="color: #adb5bd; font-size: 0.9em; margin-top: 8px;">番組を録音すると、ここに表示されます</div>
                        </div>
                    `;
                    return;
                }

                currentPage = 1;
                renderFilesList();

            } catch (err) {
                console.error('Error loading recorded files:', err);
                filesLoading.style.display = 'none';
                filesList.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 40px; font-size: 0.95em;">エラーが発生しました</div>';
            }
        }

        function renderFilesList() {
            const filesList = document.getElementById('filesList');
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            // 検索入力フィールドのフォーカス状態を保存
            const oldFilterInput = document.getElementById('fileFilter');
            let shouldRestoreFocus = false;
            let savedSelectionStart = 0;
            let savedSelectionEnd = 0;
            if (oldFilterInput && document.activeElement === oldFilterInput) {
                shouldRestoreFocus = true;
                savedSelectionStart = oldFilterInput.selectionStart;
                savedSelectionEnd = oldFilterInput.selectionEnd;
            }

            // フィルタリング
            let filteredFiles = allRecordedFiles.filter(file => {
                if (!filterText) return true;
                return file.name.toLowerCase().includes(filterText.toLowerCase());
            });

            // ソート
            filteredFiles.sort((a, b) => {
                let valA, valB;
                if (currentSort.column === 'name') {
                    valA = a.name;
                    valB = b.name;
                } else if (currentSort.column === 'size') {
                    valA = a.size;
                    valB = b.size;
                } else if (currentSort.column === 'modified') {
                    valA = a.modified;
                    valB = b.modified;
                } else if (currentSort.column === 'broadcast') {
                    // 放送日でソート
                    const dateA = extractBroadcastDate(a.name);
                    const dateB = extractBroadcastDate(b.name);
                    // 日付がない場合は最後にソート
                    if (!dateA && !dateB) return 0;
                    if (!dateA) return 1;
                    if (!dateB) return -1;
                    valA = dateA;
                    valB = dateB;
                }

                if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            // ページネーション
            const totalPages = Math.ceil(filteredFiles.length / itemsPerPage);
            const startIdx = (currentPage - 1) * itemsPerPage;
            const endIdx = startIdx + itemsPerPage;
            const pageFiles = filteredFiles.slice(startIdx, endIdx);

            const totalSize = (filteredFiles.reduce((sum, f) => sum + f.size, 0) / 1024 / 1024 / 1024).toFixed(2);

            let html = `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 10px;">
                        <input type="text" id="fileFilter" placeholder="🔍 ファイル名で検索..." value="${filterText}"
                               style="flex: 1; min-width: 200px; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 0.9em;">
                        <button onclick="clearAllBookmarks()"
                                style="padding: 8px 12px; background: #f57c00; color: white; border: none; border-radius: 6px; font-size: 0.85em; cursor: pointer; transition: all 0.2s; white-space: nowrap;"
                                onmouseover="this.style.background='#ef6c00'" onmouseout="this.style.background='#f57c00'">
                            🗑️ 再生履歴をリセット
                        </button>
                        <div style="padding: 8px 12px; background: #f8f9fa; border-radius: 6px; font-size: 0.85em; color: #495057;">
                            <strong>${filteredFiles.length}</strong>件 / ${totalSize} GB
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 0.9em;">
                            <input type="checkbox" id="selectAllFiles" onchange="toggleSelectAll(this.checked)"
                                   style="width: 16px; height: 16px; cursor: pointer;">
                            <span>すべて選択</span>
                        </label>
                        <button id="deleteSelectedBtn" onclick="deleteSelectedFiles()" disabled
                                style="padding: 8px 16px; background: #e57373; color: white; border: none; border-radius: 6px; font-size: 0.85em; cursor: pointer; transition: all 0.2s; white-space: nowrap;"
                                onmouseover="if(!this.disabled) this.style.background='#ef5350'" onmouseout="if(!this.disabled) this.style.background='#e57373'">
                            🗑️ 選択したファイルを削除
                        </button>
                        <button id="downloadSelectedBtn" onclick="downloadSelectedFiles()" disabled
                                style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; font-size: 0.85em; cursor: pointer; transition: all 0.2s; white-space: nowrap;"
                                onmouseover="if(!this.disabled) this.style.background='#5568d3'" onmouseout="if(!this.disabled) this.style.background='#667eea'">
                            📦 選択したファイルをZIPダウンロード
                        </button>
                        <span id="selectedCount" style="padding: 8px 12px; background: #e3f2fd; border-radius: 6px; font-size: 0.85em; color: #1976d2; display: none;">
                            <strong id="selectedCountNum">0</strong>件選択中
                        </span>
                    </div>
                </div>

                <div style="overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                        <thead>
                            <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                <th style="padding: 12px; text-align: center; width: 40px;"></th>
                                <th onclick="sortFiles('name')" style="padding: 12px; text-align: left; cursor: pointer; user-select: none; white-space: nowrap;"
                                    onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                                    ファイル名 ${currentSort.column === 'name' ? (currentSort.direction === 'asc' ? '▲' : '▼') : ''}
                                </th>
                                <th onclick="sortFiles('broadcast')" style="padding: 12px; text-align: center; cursor: pointer; user-select: none; white-space: nowrap; width: 120px;"
                                    onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                                    放送日 ${currentSort.column === 'broadcast' ? (currentSort.direction === 'asc' ? '▲' : '▼') : ''}
                                </th>
                                <th onclick="sortFiles('size')" style="padding: 12px; text-align: right; cursor: pointer; user-select: none; white-space: nowrap; width: 100px;"
                                    onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                                    サイズ ${currentSort.column === 'size' ? (currentSort.direction === 'asc' ? '▲' : '▼') : ''}
                                </th>
                                <th onclick="sortFiles('modified')" style="padding: 12px; text-align: center; cursor: pointer; user-select: none; white-space: nowrap; width: 140px;"
                                    onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                                    更新日時 ${currentSort.column === 'modified' ? (currentSort.direction === 'asc' ? '▲' : '▼') : ''}
                                </th>
                                <th style="padding: 12px; text-align: center; width: 200px;">操作</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            pageFiles.forEach((file, idx) => {
                const fileSize = (file.size / 1024 / 1024).toFixed(1);
                const modDate = new Date(file.modified * 1000);
                const dateStr = `${modDate.getMonth() + 1}/${modDate.getDate()} ${String(modDate.getHours()).padStart(2, '0')}:${String(modDate.getMinutes()).padStart(2, '0')}`;

                // ブックマークの存在チェック
                const bookmarkKey = `bookmark_${file.path}`;
                const savedTime = localStorage.getItem(bookmarkKey);
                const hasBookmark = savedTime !== null;
                let progressPercent = 0;
                let progressText = '';

                if (hasBookmark) {
                    const time = parseFloat(savedTime);
                    const minutes = Math.floor(time / 60);
                    const seconds = Math.floor(time % 60);
                    progressText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }

                html += `
                    <tr style="border-bottom: 1px solid #f0f0f0; transition: background 0.2s; cursor: pointer; ${hasBookmark ? 'background: #fff8e1;' : ''}"
                        onclick="toggleFileSelection('${file.path.replace(/'/g, "\\'")}')"
                        onmouseover="this.style.background='${hasBookmark ? '#fff3cd' : '#f8f9fa'}'" onmouseout="this.style.background='${hasBookmark ? '#fff8e1' : 'white'}'">
                        <td style="padding: 10px 12px; text-align: center;" onclick="event.stopPropagation()">
                            <input type="checkbox" class="file-checkbox" value="${file.path}" onchange="updateSelectedCount()"
                                   style="width: 16px; height: 16px; cursor: pointer;">
                        </td>
                        <td style="padding: 10px 12px;">
                            <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 800px;" title="${file.name}">
                                ${file.name.replace(/\.(mp3|m4a|aac|wav)$/i, '')}
                            </div>
                            ${hasBookmark ? `<div style="font-size: 0.75em; color: #f57c00; margin-top: 3px;">再生位置: ${progressText}</div>` : ''}
                        </td>
                        <td style="padding: 10px 12px; text-align: center; color: #6c757d; font-size: 0.9em;">
                            ${extractBroadcastDate(file.name) || '<span style="color: #999;">不明</span>'}
                        </td>
                        <td style="padding: 10px 12px; text-align: right; color: #6c757d;">${fileSize} MB</td>
                        <td style="padding: 10px 12px; text-align: center; color: #6c757d; font-size: 0.85em;">${dateStr}</td>
                        <td style="padding: 10px 12px;" onclick="event.stopPropagation()">
                            <div style="display: flex; gap: 8px; justify-content: center; align-items: center;">
                                <button onclick='playAudio("${file.path.replace(/'/g, "\\'")}", "${file.name.replace(/'/g, "\\'")}")'
                                        title="${hasBookmark ? '続きから再生' : '再生'}"
                                        style="padding: 4px; background: transparent; border: none; cursor: pointer; transition: all 0.2s; opacity: 0.8;"
                                        onmouseover="this.style.opacity='1'; this.style.transform='scale(1.1)'" onmouseout="this.style.opacity='0.8'; this.style.transform='scale(1)'">
                                    <img src="img/play.png" alt="再生" style="width: 24px; height: 24px; display: block;">
                                </button>
                                <a href="${baseUrl}/download/${file.path}" download="${file.name}"
                                   title="ダウンロード"
                                   style="padding: 4px; background: transparent; text-decoration: none; display: inline-block; transition: all 0.2s; opacity: 0.8;"
                                   onmouseover="this.style.opacity='1'; this.style.transform='scale(1.1)'" onmouseout="this.style.opacity='0.8'; this.style.transform='scale(1)'">
                                    <img src="img/download.png" alt="ダウンロード" style="width: 24px; height: 24px; display: block;">
                                </a>
                                <button onclick='showRenameModal("${file.path.replace(/'/g, "\\'")}", "${file.name.replace(/'/g, "\\'")}")'
                                        title="リネーム"
                                        style="padding: 4px; background: transparent; border: none; cursor: pointer; transition: all 0.2s; opacity: 0.8;"
                                        onmouseover="this.style.opacity='1'; this.style.transform='scale(1.1)'" onmouseout="this.style.opacity='0.8'; this.style.transform='scale(1)'">
                                    ✏️
                                </button>
                                <button onclick='deleteFile("${file.path.replace(/'/g, "\\'")}", "${file.name.replace(/'/g, "\\'")}")'
                                        title="削除"
                                        style="padding: 4px; background: transparent; border: none; cursor: pointer; transition: all 0.2s; opacity: 0.8;"
                                        onmouseover="this.style.opacity='1'; this.style.transform='scale(1.1)'" onmouseout="this.style.opacity='0.8'; this.style.transform='scale(1)'">
                                    <img src="img/trash.png" alt="削除" style="width: 24px; height: 24px; display: block;">
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            // ページネーション
            if (totalPages > 1) {
                html += `
                    <div style="margin-top: 15px; display: flex; justify-content: center; align-items: center; gap: 8px; flex-wrap: wrap;">
                        <button onclick="currentPage = 1; renderFilesList();" ${currentPage === 1 ? 'disabled' : ''}
                                style="padding: 6px 12px; background: ${currentPage === 1 ? '#e9ecef' : '#667eea'}; color: ${currentPage === 1 ? '#6c757d' : 'white'}; border: none; border-radius: 4px; cursor: ${currentPage === 1 ? 'not-allowed' : 'pointer'};">
                            ≪
                        </button>
                        <button onclick="if(currentPage > 1) { currentPage--; renderFilesList(); }" ${currentPage === 1 ? 'disabled' : ''}
                                style="padding: 6px 12px; background: ${currentPage === 1 ? '#e9ecef' : '#667eea'}; color: ${currentPage === 1 ? '#6c757d' : 'white'}; border: none; border-radius: 4px; cursor: ${currentPage === 1 ? 'not-allowed' : 'pointer'};">
                            ＜
                        </button>
                        <span style="padding: 6px 12px; color: #495057; font-size: 0.9em;">
                            ${currentPage} / ${totalPages}
                        </span>
                        <button onclick="if(currentPage < ${totalPages}) { currentPage++; renderFilesList(); }" ${currentPage === totalPages ? 'disabled' : ''}
                                style="padding: 6px 12px; background: ${currentPage === totalPages ? '#e9ecef' : '#667eea'}; color: ${currentPage === totalPages ? '#6c757d' : 'white'}; border: none; border-radius: 4px; cursor: ${currentPage === totalPages ? 'not-allowed' : 'pointer'};">
                            ＞
                        </button>
                        <button onclick="currentPage = ${totalPages}; renderFilesList();" ${currentPage === totalPages ? 'disabled' : ''}
                                style="padding: 6px 12px; background: ${currentPage === totalPages ? '#e9ecef' : '#667eea'}; color: ${currentPage === totalPages ? '#6c757d' : 'white'}; border: none; border-radius: 4px; cursor: ${currentPage === totalPages ? 'not-allowed' : 'pointer'};">
                            ≫
                        </button>
                    </div>
                `;
            }

            filesList.innerHTML = html;

            // 検索入力フィールドのフォーカスとカーソル位置を復元
            const fileFilterInput = document.getElementById('fileFilter');
            if (fileFilterInput && shouldRestoreFocus) {
                setTimeout(() => {
                    fileFilterInput.focus();
                    fileFilterInput.setSelectionRange(savedSelectionStart, savedSelectionEnd);
                }, 0);
            }

            // 検索入力フィールドにリアルタイムフィルタリングを設定（1回のみ）
            if (fileFilterInput && !fileFilterInput.dataset.listenerAdded) {
                fileFilterInput.dataset.listenerAdded = 'true';

                let isComposing = false;

                // IME変換中フラグを管理
                fileFilterInput.addEventListener('compositionstart', function() {
                    isComposing = true;
                });

                fileFilterInput.addEventListener('compositionend', function(e) {
                    isComposing = false;
                    // IME確定時にフィルタリング実行
                    filterText = e.target.value;
                    currentPage = 1;
                    renderFilesList();
                });

                fileFilterInput.addEventListener('input', function(e) {
                    // IME変換中は処理をスキップ
                    if (isComposing) return;

                    filterText = e.target.value;
                    currentPage = 1;
                    renderFilesList();
                });
            }
        }

        function sortFiles(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = column === 'name' ? 'asc' : 'desc';
            }
            renderFilesList();
        }

        // ファイルの存在確認
        async function checkFileExists(prog) {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            const startStr = formatRadikoTime(new Date(prog.ft));

            try {
                const response = await fetch(`${baseUrl}/check-file`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: prog.title,
                        rss: prog.stationId,
                        start_time: startStr
                    })
                });

                if (!response.ok) {
                    return null;
                }

                const data = await response.json();
                return data;
            } catch (err) {
                console.error('Error checking file:', err);
                return null;
            }
        }

        // cron式を人間が読める形式に変換
        function parseCronExpression(cronLine) {
            // cronコマンドからcron式部分を抽出
            const parts = cronLine.trim().split(/\s+/);
            if (parts.length < 5) return { description: '無効なcron式', parts: null };

            const minute = parts[0];
            const hour = parts[1];
            const dayOfMonth = parts[2];
            const month = parts[3];
            const dayOfWeek = parts[4];

            const daysOfWeekJp = ['日曜日', '月曜日', '火曜日', '水曜日', '木曜日', '金曜日', '土曜日'];

            let description = '実行タイミング: ';

            // 曜日の解析
            if (dayOfWeek !== '*') {
                const day = parseInt(dayOfWeek);
                description += `毎週${daysOfWeekJp[day]}の `;
            } else if (dayOfMonth !== '*') {
                description += `毎月${dayOfMonth}日の `;
            } else {
                description += '毎日 ';
            }

            // 時刻の解析
            if (hour === '*' && minute === '*') {
                description += '毎時毎分';
            } else if (hour === '*') {
                description += `毎時${minute}分`;
            } else if (minute === '*') {
                description += `${hour}時台の毎分`;
            } else {
                description += `${hour}:${minute.padStart(2, '0')}`;
            }

            return {
                description,
                parts: { minute, hour, dayOfMonth, month, dayOfWeek }
            };
        }

        // cron一覧を読み込む
        async function loadCronJobs() {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            const cronLoading = document.getElementById('cronLoading');
            const cronList = document.getElementById('cronList');

            cronLoading.style.display = 'block';
            cronList.innerHTML = '';

            try {
                const response = await fetch(`${baseUrl}/cron/list`);
                if (!response.ok) {
                    cronLoading.style.display = 'none';
                    cronList.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 40px; font-size: 0.95em;">cron一覧の取得に失敗しました</div>';
                    return;
                }

                const data = await response.json();
                const cronJobs = data.cron_jobs || [];

                // グローバル変数に保存
                currentCronJobs = cronJobs;

                cronLoading.style.display = 'none';

                if (cronJobs.length === 0) {
                    cronList.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px;">
                            <div style="font-size: 3em; margin-bottom: 15px;">⏰</div>
                            <div style="color: #6c757d; font-size: 1.1em; font-weight: 500;">登録されているcronジョブはありません</div>
                            <div style="color: #adb5bd; font-size: 0.9em; margin-top: 8px;">番組のcronコマンドを実行すると、ここに表示されます</div>
                        </div>
                    `;
                    return;
                }

                let html = `
                    <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 0.9em; color: #495057;">
                            <strong>${cronJobs.length}件</strong>の予約
                        </div>
                        <button onclick="loadCronLogs()" style="padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; font-size: 0.85em; cursor: pointer;">
                            📋 ログを表示
                        </button>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                `;

                cronJobs.forEach((job, index) => {
                    // cronの実行タイミング情報を作成
                    const cronInfo = parseCronExpression(job.raw || job);

                    // 番組情報の表示
                    const title = job.title || '（タイトル不明）';
                    const station = job.station || '';
                    const startTime = job.startTime ? `${job.startTime.slice(0,2)}:${job.startTime.slice(2,4)}` : '';
                    const endTime = job.endTime ? `${job.endTime.slice(0,2)}:${job.endTime.slice(2,4)}` : '';
                    const timeRange = startTime && endTime ? `${startTime}-${endTime}` : '';

                    html += `
                        <div style="padding: 12px; background: white; border: 1px solid #dee2e6; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; gap: 12px;">
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 600; color: #212529; margin-bottom: 4px; font-size: 0.95em;">
                                    ${title}
                                </div>
                                <div style="display: flex; gap: 12px; flex-wrap: wrap; font-size: 0.8em; color: #6c757d;">
                                    ${station ? `<span>🏢 ${station}</span>` : ''}
                                    ${timeRange ? `<span>📡 ${timeRange}</span>` : ''}
                                    <span>⏰ ${cronInfo.description.replace('実行タイミング: ', '')}</span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 6px; flex-shrink: 0;">
                                <button onclick='editCronJob(${index}, ${JSON.stringify(job).replace(/'/g, "\\'").replace(/"/g, "&quot;")})'
                                        style="padding: 8px 14px; background: #667eea; color: white; border: none; border-radius: 6px; font-size: 0.85em; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                                        onmouseover="this.style.background='#5568d3'"
                                        onmouseout="this.style.background='#667eea'"
                                        title="編集">
                                    編集
                                </button>
                                <button onclick='removeCronJobByIndex(${index})'
                                        style="padding: 8px 14px; background: #e57373; color: white; border: none; border-radius: 6px; font-size: 0.85em; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                                        onmouseover="this.style.background='#ef5350'"
                                        onmouseout="this.style.background='#e57373'"
                                        title="削除">
                                    削除
                                </button>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                cronList.innerHTML = html;

            } catch (err) {
                console.error('Error loading cron jobs:', err);
                cronLoading.style.display = 'none';
                cronList.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 40px; font-size: 0.95em;">エラーが発生しました</div>';
            }
        }

        // cronジョブを追加
        async function addCronJob(command) {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                const response = await fetch(`${baseUrl}/cron/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ command: command })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('✅ cronジョブを登録しました');
                    // モーダルを閉じる
                    closeModal();
                    // cron管理タブに切り替えて一覧を更新
                    switchTab('cron');
                } else {
                    alert('❌ エラー: ' + (data.error || 'cronジョブの登録に失敗しました'));
                }
            } catch (err) {
                console.error('Error adding cron job:', err);
                alert('❌ cronジョブの登録に失敗しました');
            }
        }

        // グローバルにcronジョブを保存
        let currentCronJobs = [];

        // インデックスでcronジョブを削除
        async function removeCronJobByIndex(index) {
            const job = currentCronJobs[index];
            if (!job) {
                alert('❌ cronジョブが見つかりませんでした');
                return;
            }

            const title = job.title || 'タイトル不明';
            if (!confirm(`この予約を削除しますか？\n\n${title}`)) {
                return;
            }

            await removeCronJob(job.raw);
        }

        // cronジョブを削除
        async function removeCronJob(command) {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                const response = await fetch(`${baseUrl}/cron/remove`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ command: command })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('✅ 予約を削除しました');
                    loadCronJobs();
                } else {
                    alert('❌ エラー: ' + (data.error || '予約の削除に失敗しました'));
                }
            } catch (err) {
                console.error('Error removing cron job:', err);
                alert('❌ 予約の削除に失敗しました');
            }
        }

        // リネーム用の変数
        let renameFilePath = '';
        let renameFileName = '';

        // リネームモーダルを表示
        function showRenameModal(filepath, filename) {
            renameFilePath = filepath;
            renameFileName = filename;

            // 拡張子を除いたファイル名を表示
            const nameWithoutExt = filename.replace(/\.[^/.]+$/, '');
            document.getElementById('renameCurrentName').textContent = filename;
            document.getElementById('renameNewName').value = nameWithoutExt;
            document.getElementById('renameModal').classList.add('active');

            // 入力欄にフォーカス
            setTimeout(() => {
                const input = document.getElementById('renameNewName');
                input.focus();
                input.select();
            }, 100);
        }

        // リネームモーダルを閉じる
        function closeRenameModal() {
            document.getElementById('renameModal').classList.remove('active');
            renameFilePath = '';
            renameFileName = '';
        }

        // リネームを実行
        async function executeRename() {
            const newNameInput = document.getElementById('renameNewName').value.trim();

            if (!newNameInput) {
                alert('⚠️ 新しいファイル名を入力してください');
                return;
            }

            // 拡張子を取得
            const ext = renameFileName.match(/\.[^/.]+$/);
            const newName = ext ? newNameInput + ext[0] : newNameInput;

            if (newName === renameFileName) {
                alert('⚠️ ファイル名が変更されていません');
                return;
            }

            if (!confirm(`ファイル名を変更しますか？\n\n${renameFileName}\n↓\n${newName}`)) {
                return;
            }

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                const response = await fetch(`${baseUrl}/api/rename-file`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        file_path: renameFilePath,
                        new_name: newName
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert(`✅ ファイル名を変更しました\n\n${newName}`);
                    closeRenameModal();
                    loadRecordedFiles(); // ファイル一覧を更新
                } else {
                    alert(`❌ エラー: ${data.error || 'リネームに失敗しました'}`);
                }
            } catch (err) {
                console.error('Rename error:', err);
                alert('❌ リネームに失敗しました');
            }
        }

        // ファイルを削除
        async function deleteFile(filepath, filename) {
            if (!confirm('このファイルを削除しますか？\n\n' + filename)) {
                return;
            }

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                const response = await fetch(`${baseUrl}/file/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ path: filepath })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('✅ ファイルを削除しました');
                    loadRecordedFiles();
                } else {
                    alert('❌ エラー: ' + (data.error || 'ファイルの削除に失敗しました'));
                }
            } catch (err) {
                console.error('Error deleting file:', err);
                alert('❌ ファイルの削除に失敗しました');
            }
        }

        // すべて選択/解除
        function toggleSelectAll(checked) {
            const checkboxes = document.querySelectorAll('.file-checkbox');
            checkboxes.forEach(cb => cb.checked = checked);
            updateSelectedCount();
        }

        // 行クリックでチェックボックスを切り替え
        function toggleFileSelection(path) {
            const checkbox = document.querySelector(`.file-checkbox[value="${path}"]`);
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                updateSelectedCount();
            }
        }

        // 選択数を更新
        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('.file-checkbox:checked');
            const count = checkboxes.length;

            const selectAllCheckbox = document.getElementById('selectAllFiles');
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            const downloadBtn = document.getElementById('downloadSelectedBtn');
            const countDisplay = document.getElementById('selectedCount');
            const countNum = document.getElementById('selectedCountNum');

            // ボタンの有効/無効化
            deleteBtn.disabled = count === 0;
            downloadBtn.disabled = count === 0;

            // ボタンのスタイル更新
            if (count === 0) {
                deleteBtn.style.opacity = '0.5';
                deleteBtn.style.cursor = 'not-allowed';
                downloadBtn.style.opacity = '0.5';
                downloadBtn.style.cursor = 'not-allowed';
            } else {
                deleteBtn.style.opacity = '1';
                deleteBtn.style.cursor = 'pointer';
                downloadBtn.style.opacity = '1';
                downloadBtn.style.cursor = 'pointer';
            }

            // 選択数表示
            if (count > 0) {
                countDisplay.style.display = 'inline-block';
                countNum.textContent = count;
            } else {
                countDisplay.style.display = 'none';
            }

            // すべて選択チェックボックスの状態更新
            const allCheckboxes = document.querySelectorAll('.file-checkbox');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = allCheckboxes.length > 0 && count === allCheckboxes.length;
            }
        }

        // 選択したファイルを一括削除
        async function deleteSelectedFiles() {
            const checkboxes = document.querySelectorAll('.file-checkbox:checked');
            const paths = Array.from(checkboxes).map(cb => cb.value);

            if (paths.length === 0) {
                alert('削除するファイルを選択してください');
                return;
            }

            if (!confirm(`選択した${paths.length}件のファイルを削除しますか？\n\nこの操作は元に戻せません。`)) {
                return;
            }

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                const response = await fetch(`${baseUrl}/files/delete-multiple`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ paths: paths })
                });

                const data = await response.json();

                if (response.ok) {
                    const deletedCount = data.deleted.length;
                    const errorCount = data.errors.length;
                    let message = `✅ ${deletedCount}件のファイルを削除しました`;

                    if (errorCount > 0) {
                        message += `\n\n⚠️ ${errorCount}件のファイルで削除に失敗しました`;
                    }

                    alert(message);

                    // チェックボックスをリセット
                    const selectAllCheckbox = document.getElementById('selectAllFiles');
                    if (selectAllCheckbox) selectAllCheckbox.checked = false;

                    loadRecordedFiles();
                } else {
                    alert('❌ エラー: ' + (data.error || 'ファイルの削除に失敗しました'));
                }
            } catch (err) {
                console.error('Error deleting files:', err);
                alert('❌ ファイルの削除に失敗しました');
            }
        }

        // 選択したファイルをZIPでダウンロード
        async function downloadSelectedFiles() {
            const checkboxes = document.querySelectorAll('.file-checkbox:checked');
            const paths = Array.from(checkboxes).map(cb => cb.value);

            if (paths.length === 0) {
                alert('ダウンロードするファイルを選択してください');
                return;
            }

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                const response = await fetch(`${baseUrl}/files/download-zip`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ paths: paths })
                });

                if (response.ok) {
                    // BlobとしてZIPファイルを取得
                    const blob = await response.blob();

                    // ダウンロード用のリンクを作成
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;

                    // ファイル名を取得（Content-Dispositionヘッダーから）
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = 'radiko_recordings.zip';
                    if (contentDisposition) {
                        const match = contentDisposition.match(/filename="?(.+)"?/);
                        if (match) filename = match[1];
                    }

                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();

                    // クリーンアップ
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    const data = await response.json();
                    alert('❌ エラー: ' + (data.error || 'ZIPファイルの作成に失敗しました'));
                }
            } catch (err) {
                console.error('Error downloading ZIP:', err);
                alert('❌ ZIPダウンロードに失敗しました');
            }
        }

        // cronジョブを編集
        function editCronJob(index, jobData) {
            // jobDataはパースされたオブジェクト
            if (typeof jobData === 'string') {
                // 旧形式の場合はパースする
                const parts = jobData.trim().split(/\s+/);
                if (parts.length < 5) {
                    alert('無効なcron式です');
                    return;
                }
                jobData = {
                    raw: jobData,
                    minute: parts[0],
                    hour: parts[1],
                    dayOfWeek: parts[4],
                    command: parts.slice(5).join(' '),
                    title: '',
                    station: '',
                    startTime: '',
                    endTime: ''
                };
            }

            // 番組情報を表示
            document.getElementById('editProgramTitle').value = jobData.title || '';
            document.getElementById('editProgramStation').textContent = jobData.station ? `放送局: ${jobData.station}` : '';

            // 編集モーダルに値を設定
            document.getElementById('editMinute').value = jobData.minute;
            document.getElementById('editHour').value = jobData.hour;
            document.getElementById('editDayOfWeek').value = jobData.dayOfWeek;

            // 録音時間を設定
            if (jobData.startTime) {
                document.getElementById('editStartTime').value = `${jobData.startTime.slice(0,2)}:${jobData.startTime.slice(2,4)}`;
            }
            if (jobData.endTime) {
                document.getElementById('editEndTime').value = `${jobData.endTime.slice(0,2)}:${jobData.endTime.slice(2,4)}`;
            }

            currentEditingCron.original = jobData.raw;
            currentEditingCron.jobData = jobData;

            // プレビューを更新
            updateCronPreview();

            // モーダルを表示
            document.getElementById('cronEditModal').classList.add('active');
        }

        // cronプレビューを更新
        function updateCronPreview() {
            const minute = document.getElementById('editMinute').value;
            const hour = document.getElementById('editHour').value;
            const dayOfWeek = document.getElementById('editDayOfWeek').value;
            const startTime = document.getElementById('editStartTime').value;
            const endTime = document.getElementById('editEndTime').value;

            const daysOfWeekJp = ['日曜日', '月曜日', '火曜日', '水曜日', '木曜日', '金曜日', '土曜日'];

            let description = '実行タイミング: ';
            if (dayOfWeek !== '*') {
                description += `毎週${daysOfWeekJp[dayOfWeek]}の `;
            } else {
                description += '毎日 ';
            }
            description += `${hour}:${String(minute).padStart(2, '0')}`;

            document.getElementById('cronPreview').textContent = description;

            // cronコマンドを再構築
            if (currentEditingCron.jobData) {
                const scriptPath = document.getElementById('scriptPath').value;
                const title = document.getElementById('editProgramTitle').value || '';
                const station = currentEditingCron.jobData.station || '';

                // 時刻をHHMM形式に変換
                const startHHMM = startTime ? startTime.replace(':', '') : '';
                const endHHMM = endTime ? endTime.replace(':', '') : '';

                // 録音開始時刻とcron実行時刻を比較
                // cron実行時刻が録音開始時刻より早い場合、日をまたいでいる
                const startHour = startTime ? parseInt(startTime.split(':')[0]) : 0;
                const startMin = startTime ? parseInt(startTime.split(':')[1]) : 0;
                const cronExecHour = parseInt(hour);
                const cronExecMin = parseInt(minute);

                // 時刻を分単位に変換して比較
                const startMinutes = startHour * 60 + startMin;
                const cronExecMinutes = cronExecHour * 60 + cronExecMin;
                const needsYesterday = cronExecMinutes < startMinutes;

                // 日付計算の部分
                let startDateCalc = '';
                if (needsYesterday) {
                    // cron実行日の前日を録音開始日とする
                    startDateCalc = '\`date -d yesterday +\\%Y\\%m\\%d\`';
                } else {
                    // cron実行日と同じ日を録音開始日とする
                    startDateCalc = '\`date +\\%Y\\%m\\%d\`';
                }

                const endDateCalc = '\`date +\\%Y\\%m\\%d\`';

                // cronコマンドを生成
                const fullCommand = `${minute} ${hour} * * ${dayOfWeek} ${scriptPath} "${title}" "${station}" "${station}" "${startDateCalc}${startHHMM}" "${endDateCalc}${endHHMM}" "" "" "" >> /tmp/myradiko_output.log 2>&1`;
                document.getElementById('editCommandPreview').value = fullCommand;
            }
        }

        // cron編集を保存
        async function saveCronEdit() {
            // テキストエリアから直接コマンドを取得
            const newCronLine = document.getElementById('editCommandPreview').value.trim();

            if (!newCronLine) {
                alert('コマンドを入力してください');
                return;
            }

            // 古いcronを削除して新しいcronを追加
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                // 削除
                await fetch(`${baseUrl}/cron/remove`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ command: currentEditingCron.original })
                });

                // 追加
                const response = await fetch(`${baseUrl}/cron/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ command: newCronLine })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('✅ 予約を更新しました');
                    closeCronEditModal();
                    loadCronJobs();
                } else {
                    alert('❌ エラー: ' + (data.error || '予約の更新に失敗しました'));
                }
            } catch (err) {
                console.error('Error updating cron job:', err);
                alert('❌ 予約の更新に失敗しました');
            }
        }

        // cron編集モーダルを閉じる
        function closeCronEditModal() {
            document.getElementById('cronEditModal').classList.remove('active');
        }

        // cronログを読み込む
        async function loadCronLogs() {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';
            const logContent = document.getElementById('cronLogContent');

            // モーダルを開く
            document.getElementById('cronLogModal').classList.add('active');
            logContent.innerHTML = '<div style="text-align: center; color: #888;">読み込み中...</div>';

            try {
                const response = await fetch(`${baseUrl}/cron/logs`);
                if (!response.ok) {
                    logContent.innerHTML = '<div style="color: #ff6b6b;">ログの取得に失敗しました</div>';
                    return;
                }

                const data = await response.json();
                const logs = data.logs || [];

                if (logs.length === 0) {
                    logContent.innerHTML = '<div style="color: #888;">ログがありません</div>';
                    return;
                }

                // ログを整形して表示
                let html = '';
                logs.forEach(log => {
                    // エラーや警告を色分け
                    let color = '#d4d4d4';
                    if (log.toLowerCase().includes('error') || log.toLowerCase().includes('failed')) {
                        color = '#ff6b6b';
                    } else if (log.toLowerCase().includes('warn')) {
                        color = '#ffd43b';
                    } else if (log.toLowerCase().includes('success')) {
                        color = '#51cf66';
                    }

                    html += `<div style="color: ${color}; margin-bottom: 4px;">${escapeHtml(log)}</div>`;
                });

                logContent.innerHTML = html;
                // 最下部にスクロール
                logContent.scrollTop = logContent.scrollHeight;

            } catch (err) {
                console.error('Error loading cron logs:', err);
                logContent.innerHTML = '<div style="color: #ff6b6b;">エラーが発生しました</div>';
            }
        }

        // cronログモーダルを閉じる
        function closeCronLogModal() {
            document.getElementById('cronLogModal').classList.remove('active');
        }

        // HTMLエスケープ
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // 時刻の入力が変わったらプレビューを更新
        document.addEventListener('DOMContentLoaded', function() {
            const editInputs = ['editProgramTitle', 'editMinute', 'editHour', 'editDayOfWeek', 'editStartTime', 'editEndTime'];
            editInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', updateCronPreview);
                    element.addEventListener('change', updateCronPreview);
                }
            });
        });

        document.getElementById('modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        document.getElementById('cronEditModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCronEditModal();
            }
        });

        document.getElementById('cronLogModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCronLogModal();
            }
        });

        // at予約一覧を読み込む
        async function loadAtJobs() {
            const atLoading = document.getElementById('atLoading');
            const atList = document.getElementById('atList');

            atLoading.style.display = 'block';
            atList.innerHTML = '';

            try {
                const proxyUrl = document.getElementById('proxyUrl').value;
                const baseUrl = proxyUrl.trim() || '';

                const response = await fetch(`${baseUrl}/at/list`);
                const data = await response.json();

                atLoading.style.display = 'none';

                if (!data.jobs || data.jobs.length === 0) {
                    atList.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d; font-size: 0.95em;">at予約はありません</div>';
                    return;
                }

                // 各ジョブの詳細を取得して番組名を表示
                const jobsWithDetails = await Promise.all(data.jobs.map(async (job) => {
                    try {
                        const detailResponse = await fetch(`${baseUrl}/at/detail/${job.id}`);
                        const detailData = await detailResponse.json();

                        // コマンドから番組情報を抽出
                        let programTitle = 'Unknown';
                        let stationId = '';
                        let startTime = '';
                        let endTime = '';

                        if (detailData.command) {
                            // myradiko "番組名" "局ID" "局ID" "開始時刻" "終了時刻" ... の形式から抽出
                            const match = detailData.command.match(/myradiko\s+"([^"]+)"\s+"([^"]+)"\s+"([^"]+)"\s+"(\d+)"\s+"(\d+)"/);
                            if (match) {
                                programTitle = match[1];
                                stationId = match[2];
                                const startStr = match[4]; // YYYYMMDDHHmm
                                const endStr = match[5];

                                // 時刻をフォーマット
                                if (startStr.length === 12) {
                                    const year = startStr.substring(0, 4);
                                    const month = startStr.substring(4, 6);
                                    const day = startStr.substring(6, 8);
                                    const hour = startStr.substring(8, 10);
                                    const minute = startStr.substring(10, 12);
                                    startTime = `${year}/${month}/${day} ${hour}:${minute}`;
                                }
                                if (endStr.length === 12) {
                                    const hour = endStr.substring(8, 10);
                                    const minute = endStr.substring(10, 12);
                                    endTime = `${hour}:${minute}`;
                                }
                            }
                        }

                        return { ...job, title: programTitle, station: stationId, startTime, endTime };
                    } catch (err) {
                        console.error(`Failed to get detail for job ${job.id}:`, err);
                        return { ...job, title: 'Unknown', station: '', startTime: '', endTime: '' };
                    }
                }));

                let html = '<div style="display: grid; gap: 15px;">';

                jobsWithDetails.forEach(job => {
                    // 実行時刻を整形（例: "2025/Oct/27 Mon 23:05:00" → "2025/10/27 (月) 23:05"）
                    let formattedDatetime = job.datetime;
                    try {
                        // atコマンドの日時フォーマット: "2025/Oct/27 Mon 23:05:00"
                        const match = job.datetime.match(/(\d{4})\/(\w+)\/(\d+)\s+(\w+)\s+(\d+):(\d+):\d+/);

                        if (match) {
                            const year = match[1];
                            const monthName = match[2];
                            const day = match[3].padStart(2, '0');
                            const weekdayEng = match[4];
                            const hour = match[5].padStart(2, '0');
                            const minute = match[6].padStart(2, '0');

                            // 月名を数字に変換
                            const months = {
                                'Jan': '01', 'Feb': '02', 'Mar': '03', 'Apr': '04',
                                'May': '05', 'Jun': '06', 'Jul': '07', 'Aug': '08',
                                'Sep': '09', 'Oct': '10', 'Nov': '11', 'Dec': '12'
                            };
                            const month = months[monthName] || monthName;

                            // 曜日を日本語に変換
                            const weekdays = {
                                'Sun': '日', 'Mon': '月', 'Tue': '火', 'Wed': '水',
                                'Thu': '木', 'Fri': '金', 'Sat': '土'
                            };
                            const weekday = weekdays[weekdayEng] || weekdayEng;

                            formattedDatetime = `${year}/${month}/${day} (${weekday}) ${hour}:${minute}`;
                        }
                    } catch (e) {
                        // パースに失敗した場合は元の文字列を使用
                        console.error('日時のパースに失敗:', job.datetime, e);
                    }

                    html += `
                        <div style="border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #212529; margin-bottom: 8px; font-size: 1.05em;">
                                        ${job.title}
                                    </div>
                                    ${job.station ? `<div style="color: #495057; font-size: 0.9em; margin-bottom: 5px;">📻 ${job.station}</div>` : ''}
                                    ${job.startTime && job.endTime ? `<div style="color: #495057; font-size: 0.9em; margin-bottom: 5px;">🕒 ${job.startTime} - ${job.endTime}</div>` : ''}
                                    <div style="color: #6c757d; font-size: 0.85em; margin-bottom: 3px;">
                                        ⏱️ Job #${job.id}
                                    </div>
                                    <div style="color: #6c757d; font-size: 0.85em;">
                                        実行予定: ${formattedDatetime}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button onclick='showAtJobDetail("${job.id}")'
                                            style="padding: 8px 14px; background: #667eea; color: white; border: none; border-radius: 6px; font-size: 0.85em; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                                            onmouseover="this.style.background='#5568d3'"
                                            onmouseout="this.style.background='#667eea'"
                                            title="詳細">
                                        詳細
                                    </button>
                                    <button onclick='editAtJob("${job.id}")'
                                            style="padding: 8px 14px; background: #4caf50; color: white; border: none; border-radius: 6px; font-size: 0.85em; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                                            onmouseover="this.style.background='#45a049'"
                                            onmouseout="this.style.background='#4caf50'"
                                            title="編集">
                                        編集
                                    </button>
                                    <button onclick='cancelAtJob("${job.id}")'
                                            style="padding: 8px 14px; background: #e57373; color: white; border: none; border-radius: 6px; font-size: 0.85em; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                                            onmouseover="this.style.background='#ef5350'"
                                            onmouseout="this.style.background='#e57373'"
                                            title="キャンセル">
                                        キャンセル
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                atList.innerHTML = html;

            } catch (err) {
                console.error('Error loading at jobs:', err);
                atLoading.style.display = 'none';
                atList.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 40px; font-size: 0.95em;">エラーが発生しました</div>';
            }
        }

        // at予約の詳細を表示
        async function showAtJobDetail(jobId) {
            try {
                const proxyUrl = document.getElementById('proxyUrl').value;
                const baseUrl = proxyUrl.trim() || '';

                const response = await fetch(`${baseUrl}/at/detail/${jobId}`);
                const data = await response.json();

                if (response.ok) {
                    alert(`at予約 #${jobId} の詳細\n\nコマンド:\n${data.command || 'コマンドが見つかりませんでした'}`);
                } else {
                    alert(`エラー: ${data.error || 'Unknown error'}`);
                }
            } catch (err) {
                console.error('Error getting at job detail:', err);
                alert(`エラー: ${err.message}`);
            }
        }

        // at予約をキャンセル
        async function cancelAtJob(jobId) {
            if (!confirm(`at予約 #${jobId} をキャンセルしますか？`)) {
                return;
            }

            try {
                const proxyUrl = document.getElementById('proxyUrl').value;
                const baseUrl = proxyUrl.trim() || '';

                const response = await fetch(`${baseUrl}/at/cancel/${jobId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok) {
                    alert(`✅ ${data.message}`);
                    loadAtJobs(); // 一覧を再読み込み
                } else {
                    alert(`❌ ${data.error || 'Unknown error'}`);
                }
            } catch (err) {
                console.error('Error cancelling at job:', err);
                alert(`❌ エラー: ${err.message}`);
            }
        }

        // at予約を編集
        async function editAtJob(jobId) {
            try {
                const proxyUrl = document.getElementById('proxyUrl').value;
                const baseUrl = proxyUrl.trim() || '';

                // at予約の詳細を取得
                const response = await fetch(`${baseUrl}/at/detail/${jobId}`);
                const data = await response.json();

                if (!response.ok) {
                    alert(`エラー: ${data.error || 'Unknown error'}`);
                    return;
                }

                const command = data.command || '';
                const executeTime = data.time || ''; // at実行時刻

                console.log('取得したコマンド:', command);
                console.log('実行時刻:', executeTime);

                // コマンドから情報を抽出
                // フォーマット: myradiko "番組名" "局ID" "局ID" "開始時刻" "終了時刻" "" "" "" >> /tmp/...
                const match = command.match(/myradiko\s+"([^"]+)"\s+"([^"]+)"\s+"([^"]+)"\s+"(\d+)"\s+"(\d+)"/);

                if (!match) {
                    console.error('パースに失敗したコマンド:', command);
                    alert('❌ コマンドのパースに失敗しました\n\nコマンド形式を確認してください。\nコンソールに詳細を出力しました。');
                    return;
                }

                const title = match[1];
                const stationId = match[2];
                const startTimeStr = match[4]; // YYYYMMDDHHmm
                const endTimeStr = match[5];   // YYYYMMDDHHmm

                // 録音開始時刻をフォーマット
                const startYear = startTimeStr.substring(0, 4);
                const startMonth = startTimeStr.substring(4, 6);
                const startDay = startTimeStr.substring(6, 8);
                const startHour = startTimeStr.substring(8, 10);
                const startMinute = startTimeStr.substring(10, 12);
                const startDatetime = `${startYear}-${startMonth}-${startDay}T${startHour}:${startMinute}`;

                // 録音終了時刻をフォーマット
                const endYear = endTimeStr.substring(0, 4);
                const endMonth = endTimeStr.substring(4, 6);
                const endDay = endTimeStr.substring(6, 8);
                const endHour = endTimeStr.substring(8, 10);
                const endMinute = endTimeStr.substring(10, 12);
                const endDatetime = `${endYear}-${endMonth}-${endDay}T${endHour}:${endMinute}`;

                // コマンド実行時刻をパース（例: "Fri Oct 27 23:50:00 2025"）
                let executeDatetime = '';
                if (executeTime) {
                    try {
                        const execDate = new Date(executeTime);
                        const execYear = execDate.getFullYear();
                        const execMonth = String(execDate.getMonth() + 1).padStart(2, '0');
                        const execDay = String(execDate.getDate()).padStart(2, '0');
                        const execHour = String(execDate.getHours()).padStart(2, '0');
                        const execMinute = String(execDate.getMinutes()).padStart(2, '0');
                        executeDatetime = `${execYear}-${execMonth}-${execDay}T${execHour}:${execMinute}`;
                    } catch (e) {
                        console.error('実行時刻のパースに失敗:', e);
                    }
                }

                // フォームに値を設定
                document.getElementById('editAtJobId').value = jobId;
                document.getElementById('editAtTitle').value = title;
                document.getElementById('editAtExecuteTime').value = executeDatetime;
                document.getElementById('editAtStartTime').value = startDatetime;
                document.getElementById('editAtEndTime').value = endDatetime;

                // 放送局IDから適切なエリアを検出
                const detectedArea = await detectAreaFromStation(stationId);
                if (detectedArea) {
                    document.getElementById('editAtArea').value = detectedArea;
                } else {
                    // 検出できない場合は東京都をデフォルト
                    document.getElementById('editAtArea').value = 'JP13';
                }

                // 放送局一覧を読み込んでから放送局を設定
                await updateEditAtStations();
                document.getElementById('editAtStation').value = stationId;

                // モーダルを表示
                document.getElementById('atEditModal').style.display = 'flex';

            } catch (err) {
                console.error('Error loading at job for edit:', err);
                alert(`❌ エラー: ${err.message}`);
            }
        }

        // at予約編集モーダルを閉じる
        function closeAtEditModal() {
            document.getElementById('atEditModal').style.display = 'none';
        }

        // at予約編集：エリア変更時に放送局一覧を更新
        // 放送局IDからエリアを検出する関数
        async function detectAreaFromStation(stationId) {
            try {
                const proxyUrl = document.getElementById('proxyUrl').value;
                const baseUrl = proxyUrl.trim() || '';

                // 全エリアリスト
                const allAreas = [
                    'JP1', 'JP2', 'JP3', 'JP4', 'JP5', 'JP6', 'JP7', 'JP8', 'JP9', 'JP10',
                    'JP11', 'JP12', 'JP13', 'JP14', 'JP15', 'JP16', 'JP17', 'JP18', 'JP19', 'JP20',
                    'JP21', 'JP22', 'JP23', 'JP24', 'JP25', 'JP26', 'JP27', 'JP28', 'JP29', 'JP30',
                    'JP31', 'JP32', 'JP33', 'JP34', 'JP35', 'JP36', 'JP37', 'JP38', 'JP39', 'JP40',
                    'JP41', 'JP42', 'JP43', 'JP44', 'JP45', 'JP46', 'JP47'
                ];

                const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');

                // 優先的にチェックするエリア（東京、大阪など）
                const priorityAreas = ['JP13', 'JP27', 'JP14', 'JP28', 'JP40', 'JP1'];

                // 優先エリアから検索
                for (const areaId of priorityAreas) {
                    const response = await fetch(`${baseUrl}/api/programs/area/${areaId}/date/${today}`);
                    const data = await response.json();

                    if (data.programs) {
                        const found = data.programs.find(prog => prog.stationId === stationId);
                        if (found) {
                            return areaId;
                        }
                    }
                }

                // 見つからなければ全エリアを検索（優先エリアを除く）
                for (const areaId of allAreas) {
                    if (priorityAreas.includes(areaId)) continue;

                    const response = await fetch(`${baseUrl}/api/programs/area/${areaId}/date/${today}`);
                    const data = await response.json();

                    if (data.programs) {
                        const found = data.programs.find(prog => prog.stationId === stationId);
                        if (found) {
                            return areaId;
                        }
                    }
                }

                return null; // 見つからなかった
            } catch (err) {
                console.error('Error detecting area:', err);
                return null;
            }
        }

        async function updateEditAtStations() {
            const areaId = document.getElementById('editAtArea').value;
            const stationSelect = document.getElementById('editAtStation');

            if (!areaId) {
                stationSelect.innerHTML = '<option value="">まずエリアを選択してください</option>';
                return;
            }

            stationSelect.innerHTML = '<option value="">読み込み中...</option>';

            try {
                const proxyUrl = document.getElementById('proxyUrl').value;
                const baseUrl = proxyUrl.trim() || '';
                const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');

                const response = await fetch(`${baseUrl}/api/programs/area/${areaId}/date/${today}`);
                const data = await response.json();

                if (!response.ok || !data.programs) {
                    stationSelect.innerHTML = '<option value="">エラー: 放送局を取得できません</option>';
                    return;
                }

                // ユニークな放送局を抽出
                const stations = {};
                data.programs.forEach(prog => {
                    if (prog.stationId && prog.stationName) {
                        stations[prog.stationId] = prog.stationName;
                    }
                });

                stationSelect.innerHTML = '<option value="">放送局を選択</option>';
                Object.keys(stations).sort().forEach(stationId => {
                    const option = document.createElement('option');
                    option.value = stationId;
                    option.textContent = `${stationId} - ${stations[stationId]}`;
                    stationSelect.appendChild(option);
                });

            } catch (err) {
                console.error('Error loading stations:', err);
                stationSelect.innerHTML = '<option value="">エラー: 放送局を取得できません</option>';
            }
        }

        // コマンド実行時刻を「録音終了+5分」に設定
        function setExecuteTimeToEndPlus5() {
            const endDatetime = document.getElementById('editAtEndTime').value;

            if (!endDatetime) {
                alert('先に録音終了日時を入力してください');
                return;
            }

            const endDate = new Date(endDatetime);
            endDate.setMinutes(endDate.getMinutes() + 5);

            const year = endDate.getFullYear();
            const month = String(endDate.getMonth() + 1).padStart(2, '0');
            const day = String(endDate.getDate()).padStart(2, '0');
            const hour = String(endDate.getHours()).padStart(2, '0');
            const minute = String(endDate.getMinutes()).padStart(2, '0');

            document.getElementById('editAtExecuteTime').value = `${year}-${month}-${day}T${hour}:${minute}`;
        }

        // at予約の編集を保存
        async function saveAtEdit() {
            const jobId = document.getElementById('editAtJobId').value;
            const title = document.getElementById('editAtTitle').value.trim();
            const stationId = document.getElementById('editAtStation').value;
            const executeTime = document.getElementById('editAtExecuteTime').value;
            const startDatetime = document.getElementById('editAtStartTime').value;
            const endDatetime = document.getElementById('editAtEndTime').value;

            if (!title || !stationId || !executeTime || !startDatetime || !endDatetime) {
                alert('すべての項目を入力してください');
                return;
            }

            if (!confirm('既存のat予約をキャンセルして、新しい内容で再登録します。\nよろしいですか？')) {
                return;
            }

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                // 1. 既存のat予約をキャンセル
                const cancelResponse = await fetch(`${baseUrl}/at/cancel/${jobId}`, {
                    method: 'DELETE'
                });

                if (!cancelResponse.ok) {
                    const cancelData = await cancelResponse.json();
                    throw new Error(`キャンセル失敗: ${cancelData.error || 'Unknown error'}`);
                }

                // 2. 新しい内容で再登録
                // 録音開始・終了時刻をYYYYMMDDHHmm形式に変換
                const startDate = new Date(startDatetime);
                const startStr = `${startDate.getFullYear()}${String(startDate.getMonth() + 1).padStart(2, '0')}${String(startDate.getDate()).padStart(2, '0')}${String(startDate.getHours()).padStart(2, '0')}${String(startDate.getMinutes()).padStart(2, '0')}`;

                const endDate = new Date(endDatetime);
                const endStr = `${endDate.getFullYear()}${String(endDate.getMonth() + 1).padStart(2, '0')}${String(endDate.getDate()).padStart(2, '0')}${String(endDate.getHours()).padStart(2, '0')}${String(endDate.getMinutes()).padStart(2, '0')}`;

                // 実行時刻をat形式に変換（HH:MM YYYY-MM-DD）
                const execDate = new Date(executeTime);
                const atTime = `${String(execDate.getHours()).padStart(2, '0')}:${String(execDate.getMinutes()).padStart(2, '0')} ${execDate.getFullYear()}-${String(execDate.getMonth() + 1).padStart(2, '0')}-${String(execDate.getDate()).padStart(2, '0')}`;

                // スクリプトパスを取得
                const scriptPath = document.getElementById('scriptPath').value;

                const scheduleResponse = await fetch(`${baseUrl}/schedule-at`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        script_path: scriptPath,
                        title: title,
                        station_id: stationId,
                        at_time: atTime,  // 正しいパラメータ名
                        start_time: startStr,
                        end_time: endStr
                    })
                });

                const scheduleData = await scheduleResponse.json();

                if (scheduleResponse.ok) {
                    alert(`✅ at予約を更新しました\n\n実行時刻: ${executeTime.replace('T', ' ')}\n録音開始: ${startDatetime.replace('T', ' ')}\n録音終了: ${endDatetime.replace('T', ' ')}`);
                    closeAtEditModal();
                    loadAtJobs(); // 一覧を再読み込み
                } else {
                    alert(`❌ 再登録に失敗しました\n\n${scheduleData.error || 'Unknown error'}\n\n※既存の予約はキャンセルされています`);
                }

            } catch (err) {
                console.error('Error saving at job edit:', err);
                alert(`❌ エラー: ${err.message}`);
            }
        }

        // 音声ファイルを再生
        // 現在再生中のファイルパス（ブックマーク用）
        let currentAudioFilePath = '';
        // キーボードイベントリスナーの参照（削除用）
        let audioKeyboardListener = null;

        function playAudio(filepath, filename) {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            // 現在のファイルパスを保存
            currentAudioFilePath = filepath;

            // オーディオプレイヤーのソースを設定
            const audioPlayer = document.getElementById('audioPlayer');
            const audioSource = document.getElementById('audioSource');
            const streamUrl = `${baseUrl}/stream/${filepath}`;

            // ファイル名を表示
            document.getElementById('audioFileName').textContent = filename;
            document.getElementById('audioPlayerTitle').textContent = '🎵 ' + filename;

            // モーダルを表示
            document.getElementById('audioPlayerModal').classList.add('active');

            // ソースを設定して読み込み
            audioSource.src = streamUrl;
            audioPlayer.load();

            // 音量を復元
            loadVolume();

            // キーボードショートカットを設定（左右矢印キー）
            // 既存のリスナーがあれば削除
            if (audioKeyboardListener) {
                document.removeEventListener('keydown', audioKeyboardListener);
            }

            // 新しいリスナーを作成
            audioKeyboardListener = function(event) {
                // モーダルが開いている時のみ動作
                const modal = document.getElementById('audioPlayerModal');
                if (!modal || !modal.classList.contains('active')) return;

                // 入力フィールドにフォーカスがある場合は動作しない
                if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') return;

                if (event.key === 'ArrowLeft') {
                    event.preventDefault();
                    skipAudio(-10);
                } else if (event.key === 'ArrowRight') {
                    event.preventDefault();
                    skipAudio(10);
                }
            };

            // リスナーを追加
            document.addEventListener('keydown', audioKeyboardListener);

            // loadが完了したら自動再生
            audioPlayer.addEventListener('canplay', function playWhenReady() {
                audioPlayer.play().catch(err => {
                    console.error('Auto-play failed:', err);
                    // 自動再生が失敗してもエラーは表示しない（ユーザーが手動で再生できる）
                });
                // イベントリスナーを削除（一度だけ実行）
                audioPlayer.removeEventListener('canplay', playWhenReady);
            }, { once: true });
        }

        // オーディオプレイヤーを閉じる
        function closeAudioPlayer() {
            const audioPlayer = document.getElementById('audioPlayer');

            // 閉じる前に最後の位置を自動保存
            if (currentAudioFilePath && audioPlayer.currentTime > 3) {
                const duration = audioPlayer.duration;
                // 最後まで再生していなければ保存
                if (!isNaN(duration) && duration - audioPlayer.currentTime > 3) {
                    localStorage.setItem(`bookmark_${currentAudioFilePath}`, audioPlayer.currentTime.toString());
                } else if (!isNaN(duration) && duration - audioPlayer.currentTime < 3) {
                    // 最後まで再生した場合は削除
                    localStorage.removeItem(`bookmark_${currentAudioFilePath}`);
                }
            }

            // キーボードイベントリスナーを削除
            if (audioKeyboardListener) {
                document.removeEventListener('keydown', audioKeyboardListener);
                audioKeyboardListener = null;
            }

            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            document.getElementById('audioPlayerModal').classList.remove('active');
            // 再生速度をリセット
            setPlaybackRate(1.0);
        }

        // カット編集用の変数
        let editStartTime = null;
        let editEndTime = null;

        // 編集パネルの表示/非表示
        function toggleEditPanel() {
            const panel = document.getElementById('editPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        // 時間を mm:ss 形式にフォーマット
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        // 開始位置をマーク
        function markStartTime() {
            const audioPlayer = document.getElementById('audioPlayer');
            editStartTime = audioPlayer.currentTime;
            document.getElementById('editStartTime').textContent = formatTime(editStartTime);
            updateEditDuration();
        }

        // 終了位置をマーク
        function markEndTime() {
            const audioPlayer = document.getElementById('audioPlayer');
            editEndTime = audioPlayer.currentTime;
            document.getElementById('editEndTime').textContent = formatTime(editEndTime);
            updateEditDuration();
        }

        // 編集範囲の長さを更新
        function updateEditDuration() {
            if (editStartTime !== null && editEndTime !== null) {
                const duration = Math.abs(editEndTime - editStartTime);
                document.getElementById('editDuration').textContent = formatTime(duration);
            }
        }

        // 編集を実行
        async function executeEdit(mode) {
            if (editStartTime === null || editEndTime === null) {
                alert('⚠️ 開始位置と終了位置の両方をマークしてください');
                return;
            }

            // 開始と終了が逆の場合は入れ替え
            let start = Math.min(editStartTime, editEndTime);
            let end = Math.max(editStartTime, editEndTime);

            const modeText = mode === 'remove' ? '削除' : '抽出';
            const confirmMsg = mode === 'remove'
                ? `${formatTime(start)} ～ ${formatTime(end)} の範囲を削除します。\n\n編集後のファイルは新しいファイルとして保存されます。\nよろしいですか？`
                : `${formatTime(start)} ～ ${formatTime(end)} の範囲を抽出します。\n\n抽出した部分が新しいファイルとして保存されます。\nよろしいですか？`;

            if (!confirm(confirmMsg)) {
                return;
            }

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                const response = await fetch(`${baseUrl}/api/edit-audio`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        file_path: currentAudioFilePath,
                        start_time: start,
                        end_time: end,
                        mode: mode
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert(`✅ 編集完了！\n\n新しいファイル: ${data.output_file}\n\n録音済みファイル一覧を更新してください。`);
                    // 編集位置をリセット
                    editStartTime = null;
                    editEndTime = null;
                    document.getElementById('editStartTime').textContent = '未設定';
                    document.getElementById('editEndTime').textContent = '未設定';
                    document.getElementById('editDuration').textContent = '--';
                } else {
                    alert(`❌ エラー: ${data.error || '編集に失敗しました'}`);
                }
            } catch (err) {
                console.error('Edit error:', err);
                alert('❌ 編集に失敗しました');
            }
        }

        // 再生速度を変更
        function changePlaybackRate(rate) {
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.playbackRate = parseFloat(rate);
            document.getElementById('playbackRateValue').textContent = parseFloat(rate).toFixed(1) + 'x';
            document.getElementById('playbackRate').value = rate;
        }

        // 再生速度をプリセット値に設定
        function setPlaybackRate(rate) {
            changePlaybackRate(rate);
        }

        // 早送り・巻き戻し機能
        function skipAudio(seconds) {
            const audioPlayer = document.getElementById('audioPlayer');
            if (!audioPlayer) return;

            const newTime = audioPlayer.currentTime + seconds;

            // 範囲チェック（0秒未満や動画の長さを超えないように）
            if (newTime < 0) {
                audioPlayer.currentTime = 0;
            } else if (newTime > audioPlayer.duration) {
                audioPlayer.currentTime = audioPlayer.duration;
            } else {
                audioPlayer.currentTime = newTime;
            }
        }

        // 再生位置を更新（自動保存用）
        function updatePlaybackPosition() {
            if (!currentAudioFilePath) return;

            const audioPlayer = document.getElementById('audioPlayer');
            const currentTime = audioPlayer.currentTime;
            const duration = audioPlayer.duration;

            // 再生中は常に位置を自動保存（開始3秒後から）
            if (currentTime > 3 && !isNaN(duration)) {
                localStorage.setItem(`bookmark_${currentAudioFilePath}`, currentTime.toString());

                // 最後まで再生した場合はブックマークを削除
                if (duration - currentTime < 3) {
                    localStorage.removeItem(`bookmark_${currentAudioFilePath}`);
                }
            }
        }

        // ブックマークを読み込み
        function loadBookmark() {
            if (!currentAudioFilePath) return;

            const savedTime = localStorage.getItem(`bookmark_${currentAudioFilePath}`);
            const bookmarkInfo = document.getElementById('bookmarkInfo');

            if (savedTime) {
                const audioPlayer = document.getElementById('audioPlayer');
                const time = parseFloat(savedTime);

                // ブックマーク情報を表示
                const minutes = Math.floor(time / 60);
                const seconds = Math.floor(time % 60);
                document.getElementById('bookmarkTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                bookmarkInfo.style.display = 'block';

                // 再生位置を復元
                audioPlayer.currentTime = time;
            } else {
                bookmarkInfo.style.display = 'none';
            }
        }

        // 音量を保存
        function saveVolume() {
            const audioPlayer = document.getElementById('audioPlayer');
            if (audioPlayer) {
                localStorage.setItem('audioPlayerVolume', audioPlayer.volume.toString());
            }
        }

        // 音量を読み込み
        function loadVolume() {
            const audioPlayer = document.getElementById('audioPlayer');
            const savedVolume = localStorage.getItem('audioPlayerVolume');

            if (savedVolume !== null && audioPlayer) {
                audioPlayer.volume = parseFloat(savedVolume);
            }
        }

        // すべての再生履歴をリセット
        function clearAllBookmarks() {
            if (!confirm('すべてのファイルの再生履歴をリセットしますか？\nこの操作は取り消せません。')) {
                return;
            }

            // localStorage内のすべてのbookmark_で始まるキーを削除
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('bookmark_')) {
                    keysToRemove.push(key);
                }
            }

            keysToRemove.forEach(key => localStorage.removeItem(key));

            alert(`🗑️ ${keysToRemove.length}件の再生履歴をリセットしました`);

            // ファイル一覧を再描画
            renderFilesList();
        }

        // 詳細設定の表示/非表示切り替え
        function toggleAdvancedSettings() {
            const advancedSettings = document.getElementById('advancedSettings');
            const toggleText = document.getElementById('advancedToggleText');

            if (advancedSettings.style.display === 'none') {
                advancedSettings.style.display = 'block';
                toggleText.textContent = '詳細設定を非表示';
                localStorage.setItem('advancedSettingsOpen', 'true');
            } else {
                advancedSettings.style.display = 'none';
                toggleText.textContent = '詳細設定を表示';
                localStorage.setItem('advancedSettingsOpen', 'false');
            }
        }

        // ページ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', function() {
            // 本日の日付を設定
            const today = new Date();
            const dateStr = today.toISOString().slice(0, 10);
            document.getElementById('targetDate').value = dateStr;
        });

        // ==================== 管理メニュー機能 ====================

        const ADMIN_PASSWORD = 'Pal_s1008467';
        let isAdminAuthenticated = false;

        // 管理者認証
        function authenticateAdmin() {
            const password = document.getElementById('adminPassword').value;

            if (password === ADMIN_PASSWORD) {
                isAdminAuthenticated = true;
                document.getElementById('adminAuth').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                document.getElementById('adminPassword').value = '';

                // 日時入力フィールドの制限を設定
                initManualDateTimeLimits();
            } else {
                alert('❌ パスワードが正しくありません');
                document.getElementById('adminPassword').value = '';
            }
        }

        // 管理者ログアウト
        function logoutAdmin() {
            isAdminAuthenticated = false;
            document.getElementById('adminAuth').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
        }

        // DB番組表一括更新
        function updateAllPrograms() {
            if (!confirm('全エリアの番組表を更新します。\n処理には数分〜十数分かかります。\n実行しますか?')) {
                return;
            }

            const days = document.getElementById('updateDays').value;
            const updateLog = document.getElementById('updateLog');
            const updateProgress = document.getElementById('updateProgress');

            updateProgress.style.display = 'block';
            updateLog.innerHTML = '<span style="color: #17a2b8;">🔄 更新処理を開始しています...</span>\n';

            // プログレスバー要素
            const progressBar = document.getElementById('updateProgressBar');
            const progressText = document.getElementById('updateProgressText');
            const progressPercent = document.getElementById('updateProgressPercent');
            const progressDetail = document.getElementById('updateProgressDetail');
            const progressBarText = document.getElementById('updateProgressBarText');

            // 統計カウンター要素
            const successCount = document.getElementById('updateSuccessCount');
            const errorCount = document.getElementById('updateErrorCount');
            const warningCount = document.getElementById('updateWarningCount');

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            // Server-Sent Events (SSE) で進捗をリアルタイム受信
            const eventSource = new EventSource(`${baseUrl}/admin/update-programs-stream?days=${days}`);

            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);

                    switch(data.type) {
                        case 'start':
                            updateLog.innerHTML += `<span style="color: #17a2b8;">📡 ${data.message}</span>\n`;
                            progressText.textContent = '更新開始';
                            progressDetail.textContent = data.message;
                            break;

                        case 'info':
                            updateLog.innerHTML += `<span style="color: #17a2b8;">ℹ️ ${data.message}</span>\n`;
                            progressDetail.textContent = data.message;
                            break;

                        case 'progress':
                            updateLog.innerHTML += `\n<span style="color: #6c757d; font-weight: bold;">[${data.current}/${data.total}] ${data.area} を処理中...</span>\n`;
                            progressText.textContent = `${data.area} を処理中...`;
                            progressDetail.textContent = `エリア ${data.current}/${data.total} を処理中`;
                            break;

                        case 'success':
                            updateLog.innerHTML += `  <span style="color: #28a745;">✅ ${data.area} ${data.date}: ${data.programs}件</span>\n`;
                            updateLog.scrollTop = updateLog.scrollHeight;
                            break;

                        case 'warning':
                            updateLog.innerHTML += `  <span style="color: #ffc107;">⚠️ ${data.area} ${data.date}: ${data.message}</span>\n`;
                            break;

                        case 'error':
                            updateLog.innerHTML += `  <span style="color: #dc3545;">❌ ${data.area} ${data.date}: ${data.message}</span>\n`;
                            break;

                        case 'percent':
                            // プログレスバーを更新
                            progressBar.style.width = `${data.percent}%`;
                            progressPercent.textContent = `${data.percent}%`;
                            progressBarText.textContent = `${data.completed}/${data.total}`;
                            progressDetail.textContent = `${data.completed}/${data.total} 件完了`;

                            // 統計カウンターを更新
                            successCount.textContent = data.success || 0;
                            errorCount.textContent = data.error || 0;
                            warningCount.textContent = data.warning || 0;

                            updateLog.scrollTop = updateLog.scrollHeight;
                            break;

                        case 'complete':
                            // 完了時は100%
                            progressBar.style.width = '100%';
                            progressBar.style.background = 'linear-gradient(90deg, #28a745, #1e7e34)';
                            progressPercent.textContent = '100%';
                            progressText.textContent = '✅ 完了';
                            progressBarText.textContent = '完了';
                            progressDetail.textContent = `総番組数: ${data.total_programs}件`;

                            // 最終統計を更新
                            successCount.textContent = data.success || 0;
                            errorCount.textContent = data.error || 0;
                            warningCount.textContent = data.warning || 0;

                            updateLog.innerHTML += `\n<span style="color: #28a745; font-weight: bold;">✅ ${data.message}</span>\n`;
                            updateLog.innerHTML += `<span style="color: #17a2b8;">📊 総番組数: ${data.total_programs}件</span>\n`;
                            updateLog.innerHTML += `<span style="color: #28a745;">✅ 成功: ${data.success}件</span> / `;
                            updateLog.innerHTML += `<span style="color: #dc3545;">❌ エラー: ${data.error}件</span> / `;
                            updateLog.innerHTML += `<span style="color: #ffc107;">⚠️ 警告: ${data.warning}件</span>\n`;
                            eventSource.close();
                            break;
                    }
                } catch (err) {
                    console.error('Parse error:', err);
                }
            };

            eventSource.onerror = function(err) {
                console.error('EventSource error:', err);
                updateLog.innerHTML += `\n❌ 接続エラーが発生しました\n`;
                eventSource.close();
            };
        }

        // エリア選択時に放送局リストを更新
        async function updateManualStations() {
            const areaId = document.getElementById('manualArea').value;
            const stationSelect = document.getElementById('manualStation');

            if (!areaId) {
                stationSelect.innerHTML = '<option value="">まずエリアを選択してください</option>';
                return;
            }

            stationSelect.innerHTML = '<option value="">読み込み中...</option>';

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                // 今日の日付で番組表を取得
                const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const response = await fetch(`${baseUrl}/api/programs/area/${areaId}/date/${today}`);
                const data = await response.json();

                if (response.ok && data.programs) {
                    // 局IDをユニークに抽出
                    const stations = {};
                    data.programs.forEach(prog => {
                        if (prog.stationId && prog.stationName) {
                            stations[prog.stationId] = prog.stationName;
                        }
                    });

                    // セレクトボックスを更新
                    stationSelect.innerHTML = '<option value="">放送局を選択</option>';
                    Object.keys(stations).sort().forEach(stationId => {
                        const option = document.createElement('option');
                        option.value = stationId;
                        option.textContent = `${stationId} - ${stations[stationId]}`;
                        stationSelect.appendChild(option);
                    });
                } else {
                    stationSelect.innerHTML = '<option value="">放送局が見つかりません</option>';
                }
            } catch (err) {
                console.error('Station list error:', err);
                stationSelect.innerHTML = '<option value="">エラーが発生しました</option>';
            }
        }

        // 日時入力フィールドの制限を設定（1週間前まで）
        function initManualDateTimeLimits() {
            const now = new Date();
            const oneWeekAgo = new Date(now);
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

            // ISO形式に変換（YYYY-MM-DDTHH:mm）
            const minDateTime = oneWeekAgo.toISOString().slice(0, 16);

            document.getElementById('manualStart').min = minDateTime;
            document.getElementById('manualEnd').min = minDateTime;
        }

        // 手動コマンドのコピー
        function copyManualCommand() {
            const title = document.getElementById('manualTitle').value.trim();
            const station = document.getElementById('manualStation').value;
            const startDatetime = document.getElementById('manualStart').value;
            const endDatetime = document.getElementById('manualEnd').value;

            if (!title || !station || !startDatetime || !endDatetime) {
                alert('番組名、放送局、録音開始日時、録音終了日時を入力してください');
                return;
            }

            // datetime-local形式をYYYYMMDDHHmm形式に変換
            const startDate = new Date(startDatetime);
            const endDate = new Date(endDatetime);

            const startStr = `${startDate.getFullYear()}${String(startDate.getMonth() + 1).padStart(2, '0')}${String(startDate.getDate()).padStart(2, '0')}${String(startDate.getHours()).padStart(2, '0')}${String(startDate.getMinutes()).padStart(2, '0')}`;
            const endStr = `${endDate.getFullYear()}${String(endDate.getMonth() + 1).padStart(2, '0')}${String(endDate.getDate()).padStart(2, '0')}${String(endDate.getHours()).padStart(2, '0')}${String(endDate.getMinutes()).padStart(2, '0')}`;

            const scriptPath = document.getElementById('scriptPath').value;
            const command = `${scriptPath} "${title}" "${station}" "${station}" "${startStr}" "${endStr}" "" "" "" >> /tmp/myradiko_output.log 2>&1`;

            // クリップボードにコピー
            navigator.clipboard.writeText(command).then(() => {
                // コマンドプレビューを表示
                const preview = document.getElementById('manualCommandPreview');
                preview.textContent = command;
                preview.style.display = 'block';

                alert('✅ コマンドをクリップボードにコピーしました');
            }).catch(err => {
                alert('❌ コピーに失敗しました: ' + err.message);
            });
        }

        // 手動コマンド実行（即座に実行）
        async function executeManualCommand() {
            const title = document.getElementById('manualTitle').value.trim();
            const station = document.getElementById('manualStation').value;
            const startDatetime = document.getElementById('manualStart').value;
            const endDatetime = document.getElementById('manualEnd').value;

            if (!title || !station || !startDatetime || !endDatetime) {
                alert('番組名、放送局、録音開始日時、録音終了日時を入力してください');
                return;
            }

            // datetime-local形式をYYYYMMDDHHmm形式に変換
            const startDate = new Date(startDatetime);
            const endDate = new Date(endDatetime);

            const startStr = `${startDate.getFullYear()}${String(startDate.getMonth() + 1).padStart(2, '0')}${String(startDate.getDate()).padStart(2, '0')}${String(startDate.getHours()).padStart(2, '0')}${String(startDate.getMinutes()).padStart(2, '0')}`;
            const endStr = `${endDate.getFullYear()}${String(endDate.getMonth() + 1).padStart(2, '0')}${String(endDate.getDate()).padStart(2, '0')}${String(endDate.getHours()).padStart(2, '0')}${String(endDate.getMinutes()).padStart(2, '0')}`;

            if (!confirm(`以下の録音を即座に実行します:\n\n番組名: ${title}\n局ID: ${station}\n開始: ${startDatetime.replace('T', ' ')}\n終了: ${endDatetime.replace('T', ' ')}\n\nよろしいですか?`)) {
                return;
            }

            const manualOutput = document.getElementById('manualOutput');
            const manualLog = document.getElementById('manualLog');

            manualOutput.style.display = 'block';
            manualLog.textContent = '▶️ コマンドを実行中...\n';

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';
            const scriptPath = document.getElementById('scriptPath').value;

            try {
                const response = await fetch(`${baseUrl}/admin/execute-manual`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        script_path: scriptPath,
                        title: title,
                        station_id: station,
                        start_time: startStr,
                        end_time: endStr
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    manualLog.textContent += `✅ 実行完了\n\n${data.output || ''}`;
                } else {
                    manualLog.textContent += `❌ エラー: ${data.error}\n`;
                }
            } catch (err) {
                manualLog.textContent += `❌ エラー: ${err.message}\n`;
            }
        }

        // 手動コマンドのat予約実行
        async function scheduleManualCommand() {
            const title = document.getElementById('manualTitle').value.trim();
            const station = document.getElementById('manualStation').value;
            const executeTime = document.getElementById('manualExecuteTime').value;
            const startDatetime = document.getElementById('manualStart').value;
            const endDatetime = document.getElementById('manualEnd').value;

            if (!title || !station || !executeTime || !startDatetime || !endDatetime) {
                alert('すべての項目を入力してください');
                return;
            }

            // datetime-local形式をYYYYMMDDHHmm形式に変換
            const executeDate = new Date(executeTime);
            const startDate = new Date(startDatetime);
            const endDate = new Date(endDatetime);

            const executeStr = `${executeDate.getFullYear()}${String(executeDate.getMonth() + 1).padStart(2, '0')}${String(executeDate.getDate()).padStart(2, '0')}${String(executeDate.getHours()).padStart(2, '0')}${String(executeDate.getMinutes()).padStart(2, '0')}`;
            const startStr = `${startDate.getFullYear()}${String(startDate.getMonth() + 1).padStart(2, '0')}${String(startDate.getDate()).padStart(2, '0')}${String(startDate.getHours()).padStart(2, '0')}${String(startDate.getMinutes()).padStart(2, '0')}`;
            const endStr = `${endDate.getFullYear()}${String(endDate.getMonth() + 1).padStart(2, '0')}${String(endDate.getDate()).padStart(2, '0')}${String(endDate.getHours()).padStart(2, '0')}${String(endDate.getMinutes()).padStart(2, '0')}`;

            if (!confirm(`以下の録音をat予約します:\n\n実行時刻: ${executeTime.replace('T', ' ')}\n番組名: ${title}\n局ID: ${station}\n録音開始: ${startDatetime.replace('T', ' ')}\n録音終了: ${endDatetime.replace('T', ' ')}\n\nよろしいですか?`)) {
                return;
            }

            const manualOutput = document.getElementById('manualOutput');
            const manualLog = document.getElementById('manualLog');

            manualOutput.style.display = 'block';
            manualLog.textContent = '⏰ at予約を登録中...\n';

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';
            const scriptPath = document.getElementById('scriptPath').value;

            try {
                const response = await fetch(`${baseUrl}/schedule-at`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        script_path: scriptPath,
                        title: title,
                        station_id: station,
                        execute_time: executeStr,
                        start_time: startStr,
                        end_time: endStr
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    manualLog.textContent += `✅ at予約完了\n\n${data.at_command || ''}\n\nJob ID: ${data.job_id || 'N/A'}`;
                } else {
                    manualLog.textContent += `❌ エラー: ${data.error}\n`;
                }
            } catch (err) {
                manualLog.textContent += `❌ エラー: ${err.message}\n`;
            }
        }

        // 古いDBデータ削除
        async function cleanupOldData() {
            if (!confirm('15日以前の番組データを削除します。\nよろしいですか?')) {
                return;
            }

            const maintenanceOutput = document.getElementById('maintenanceOutput');
            const maintenanceLog = document.getElementById('maintenanceLog');

            maintenanceOutput.style.display = 'block';
            maintenanceLog.textContent = '🗑️ 古いデータを削除中...\n';

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                const response = await fetch(`${baseUrl}/admin/cleanup`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    maintenanceLog.textContent += `✅ ${data.message}\n`;
                    maintenanceLog.textContent += `削除件数: ${data.deleted || 0}件\n`;
                } else {
                    maintenanceLog.textContent += `❌ エラー: ${data.error}\n`;
                }
            } catch (err) {
                maintenanceLog.textContent += `❌ エラー: ${err.message}\n`;
            }
        }

        // ディスク容量確認
        async function checkDiskSpace() {
            const maintenanceOutput = document.getElementById('maintenanceOutput');
            const maintenanceLog = document.getElementById('maintenanceLog');

            maintenanceOutput.style.display = 'block';
            maintenanceLog.textContent = '💾 ディスク容量を確認中...\n';

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                const response = await fetch(`${baseUrl}/admin/disk-space`);
                const data = await response.json();

                if (response.ok) {
                    maintenanceLog.textContent += `✅ ディスク容量情報\n\n`;
                    maintenanceLog.textContent += data.info || '';
                } else {
                    maintenanceLog.textContent += `❌ エラー: ${data.error}\n`;
                }
            } catch (err) {
                maintenanceLog.textContent += `❌ エラー: ${err.message}\n`;
            }
        }

        // DB統計情報
        async function viewDbStatus() {
            const maintenanceOutput = document.getElementById('maintenanceOutput');
            const maintenanceLog = document.getElementById('maintenanceLog');

            maintenanceOutput.style.display = 'block';
            maintenanceLog.textContent = '📈 DB統計情報を取得中...\n';

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                const response = await fetch(`${baseUrl}/admin/db-status`);
                const data = await response.json();

                if (response.ok) {
                    maintenanceLog.textContent += `✅ DB統計情報\n\n`;
                    maintenanceLog.textContent += `総番組数: ${data.total_programs || 0}件\n`;
                    maintenanceLog.textContent += `更新履歴: ${data.total_updates || 0}件\n`;
                    maintenanceLog.textContent += `DB容量: ${data.db_size || '-'}\n`;
                } else {
                    maintenanceLog.textContent += `❌ エラー: ${data.error}\n`;
                }
            } catch (err) {
                maintenanceLog.textContent += `❌ エラー: ${err.message}\n`;
            }
        }
    </script>
</body>
</html>
