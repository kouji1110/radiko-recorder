<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŒ²éŸ³ãã‚“ - radikoéŒ²éŸ³ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="icon" href="img/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 10px;
            margin: 0;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        header {
            background: #667eea;
            color: white;
            padding: 10px 15px;
        }

        header h1 {
            font-size: 1.2em;
            margin: 0;
        }

        header p {
            font-size: 0.75em;
            opacity: 0.9;
            margin: 0;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            padding: 0 15px;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 0.9em;
            font-weight: 600;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #495057;
            background: #e9ecef;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .settings {
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .settings-grid {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .setting-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .setting-group label {
            font-weight: 600;
            color: #495057;
            font-size: 0.75em;
            white-space: nowrap;
        }

        .setting-group input,
        .setting-group select {
            padding: 4px 8px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .setting-group input:focus,
        .setting-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 4px 12px;
            border: none;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .content {
            padding: 10px;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #6c757d;
            font-size: 1.2em;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #f5c6cb;
        }

        .program-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 6px;
        }

        .station-column {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            overflow: hidden;
        }

        .station-header {
            background: #667eea;
            color: white;
            padding: 6px 8px;
            font-weight: 700;
            font-size: 0.85em;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .station-programs {
            max-height: 600px;
            overflow-y: auto;
        }

        .program-card {
            background: white;
            border-bottom: 1px solid #f0f0f0;
            padding: 4px 6px;
            transition: background 0.1s;
            cursor: pointer;
        }

        .program-card:last-child {
            border-bottom: none;
        }

        .program-card:hover {
            background: #f8f9fa;
        }

        .program-card.now-playing {
            background: #fff9e6;
            border-left: 3px solid #ffc107;
        }

        .program-time {
            color: #667eea;
            font-weight: 700;
            font-size: 0.7em;
            margin-bottom: 2px;
        }

        .program-title {
            color: #212529;
            font-size: 0.8em;
            font-weight: 600;
            margin-bottom: 2px;
            line-height: 1.2;
        }

        .program-detail {
            color: #6c757d;
            font-size: 0.7em;
            margin-bottom: 3px;
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .program-actions {
            display: flex;
            gap: 2px;
            margin-top: 3px;
        }

        .btn-action {
            flex: 1;
            padding: 2px 4px;
            border: none;
            border-radius: 3px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.1s;
            font-size: 0.65em;
            white-space: nowrap;
        }

        .btn-cron {
            background: #28a745;
            color: white;
        }

        .btn-cron:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-download {
            background: #007bff;
            color: white;
        }

        .btn-download:hover {
            background: #0069d9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
        }

        .btn-at {
            background: #ffc107;
            color: #212529;
        }

        .btn-at:hover {
            background: #e0a800;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 193, 7, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-header h2 {
            color: #212529;
            font-size: 1.8em;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: #6c757d;
            padding: 0;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: #f8f9fa;
            color: #212529;
        }

        .command-box {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
            line-height: 1.6;
            word-break: break-all;
            color: #212529;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
        }

        .btn-execute {
            flex: 1;
            background: #28a745;
            color: white;
        }

        .btn-execute:hover {
            background: #218838;
        }

        .btn-copy {
            flex: 1;
            background: #667eea;
            color: white;
        }

        .btn-copy:hover {
            background: #5568d3;
        }

        .btn-close {
            flex: 1;
            background: #6c757d;
            color: white;
        }

        .btn-close:hover {
            background: #5a6268;
        }

        footer {
            background: #f8f9fa;
            padding: 6px;
            text-align: center;
            color: #6c757d;
            font-size: 0.7em;
            border-top: 1px solid #e9ecef;
        }

        @media (max-width: 768px) {
            body {
                padding: 0;
            }

            .container {
                border-radius: 0;
            }

            header h1 {
                font-size: 1.2em;
            }

            header p {
                font-size: 0.7em;
            }

            /* ã‚¿ãƒ–ã®ã‚¹ãƒãƒ›å¯¾å¿œ */
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding: 0 10px;
            }

            .tab {
                padding: 10px 16px;
                font-size: 0.85em;
                white-space: nowrap;
            }

            /* è¨­å®šã‚¨ãƒªã‚¢ã®ã‚¹ãƒãƒ›å¯¾å¿œ */
            .settings {
                padding: 10px;
            }

            .settings-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .setting-group {
                flex-direction: column;
                align-items: stretch;
                gap: 4px;
            }

            .setting-group label {
                font-size: 0.8em;
            }

            .setting-group input,
            .setting-group select {
                width: 100%;
                padding: 8px;
                font-size: 0.9em;
            }

            /* ãƒœã‚¿ãƒ³ã®ã‚¹ãƒãƒ›å¯¾å¿œ */
            .btn {
                padding: 10px 16px;
                font-size: 0.9em;
            }

            /* ç•ªçµ„ã‚«ãƒ¼ãƒ‰ã®ã‚¹ãƒãƒ›å¯¾å¿œ */
            .program-list {
                grid-template-columns: 1fr !important;
                gap: 10px;
            }

            .program-card {
                font-size: 0.9em;
            }

            .program-header {
                flex-direction: column;
                gap: 8px;
            }

            .program-actions {
                flex-direction: column;
                gap: 6px;
            }

            .btn-action {
                width: 100%;
                padding: 10px;
            }

            /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ãƒãƒ›å¯¾å¿œ */
            .modal-content {
                width: 95%;
                max-width: 95%;
                padding: 15px;
                margin: 10px;
            }

            .modal-header h2 {
                font-size: 1.1em;
            }

            .command-box {
                font-size: 0.75em;
                padding: 10px;
            }

            /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¹ãƒãƒ›å¯¾å¿œ */
            table {
                font-size: 0.8em;
            }

            th, td {
                padding: 8px 6px !important;
            }

            /* éŒ²éŸ³æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®ã‚¹ãƒãƒ›å¯¾å¿œ */
            #fileFilter {
                font-size: 0.9em !important;
            }

            /* è©³ç´°è¨­å®šã®ã‚¹ãƒãƒ›å¯¾å¿œ */
            #advancedSettings {
                padding: 10px;
            }

            /* éŸ³å£°ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¹ãƒãƒ›å¯¾å¿œ */
            .speed-btn {
                padding: 6px 10px !important;
                font-size: 0.75em !important;
            }

            /* ãƒ•ãƒƒã‚¿ãƒ¼ã®ã‚¹ãƒãƒ›å¯¾å¿œ */
            footer {
                font-size: 0.65em;
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“» éŒ²éŸ³ãã‚“</h1>
            <p>å…¨å›½47éƒ½é“åºœçœŒã®ãƒ©ã‚¸ã‚ªç•ªçµ„ã‚’æ¤œç´¢ãƒ»éŒ²éŸ³äºˆç´„</p>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('search')">ğŸ“» ç•ªçµ„æ¤œç´¢</button>
            <button class="tab" onclick="switchTab('files')">ğŸ“ éŒ²éŸ³æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«</button>
            <button class="tab" onclick="switchTab('at')">â±ï¸ ç•ªçµ„äºˆç´„ç®¡ç†</button>
            <button class="tab" onclick="switchTab('cron')">â° å®šæœŸéŒ²éŸ³ç®¡ç†</button>
            <button class="tab" onclick="switchTab('admin')">ğŸ”§ ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
        </div>

        <!-- ç•ªçµ„æ¤œç´¢ã‚¿ãƒ– -->
        <div id="searchTab" class="tab-content active">
            <div class="settings">
            <div class="settings-grid">
                <div class="setting-group">
                    <label for="areaId">ã‚¨ãƒªã‚¢ã‚’é¸æŠ:</label>
                    <select id="areaId">
                        <option value="JP1">åŒ—æµ·é“</option>
                        <option value="JP2">é’æ£®çœŒ</option>
                        <option value="JP3">å²©æ‰‹çœŒ</option>
                        <option value="JP4">å®®åŸçœŒ</option>
                        <option value="JP5">ç§‹ç”°çœŒ</option>
                        <option value="JP6">å±±å½¢çœŒ</option>
                        <option value="JP7">ç¦å³¶çœŒ</option>
                        <option value="JP8">èŒ¨åŸçœŒ</option>
                        <option value="JP9">æ ƒæœ¨çœŒ</option>
                        <option value="JP10">ç¾¤é¦¬çœŒ</option>
                        <option value="JP11">åŸ¼ç‰çœŒ</option>
                        <option value="JP12">åƒè‘‰çœŒ</option>
                        <option value="JP13">æ±äº¬éƒ½</option>
                        <option value="JP14">ç¥å¥ˆå·çœŒ</option>
                        <option value="JP15">æ–°æ½ŸçœŒ</option>
                        <option value="JP16">å¯Œå±±çœŒ</option>
                        <option value="JP17">çŸ³å·çœŒ</option>
                        <option value="JP18">ç¦äº•çœŒ</option>
                        <option value="JP19">å±±æ¢¨çœŒ</option>
                        <option value="JP20">é•·é‡çœŒ</option>
                        <option value="JP21">å²é˜œçœŒ</option>
                        <option value="JP22">é™å²¡çœŒ</option>
                        <option value="JP23">æ„›çŸ¥çœŒ</option>
                        <option value="JP24">ä¸‰é‡çœŒ</option>
                        <option value="JP25">æ»‹è³€çœŒ</option>
                        <option value="JP26">äº¬éƒ½åºœ</option>
                        <option value="JP27">å¤§é˜ªåºœ</option>
                        <option value="JP28">å…µåº«çœŒ</option>
                        <option value="JP29">å¥ˆè‰¯çœŒ</option>
                        <option value="JP30">å’Œæ­Œå±±çœŒ</option>
                        <option value="JP31">é³¥å–çœŒ</option>
                        <option value="JP32">å³¶æ ¹çœŒ</option>
                        <option value="JP33">å²¡å±±çœŒ</option>
                        <option value="JP34">åºƒå³¶çœŒ</option>
                        <option value="JP35">å±±å£çœŒ</option>
                        <option value="JP36">å¾³å³¶çœŒ</option>
                        <option value="JP37">é¦™å·çœŒ</option>
                        <option value="JP38">æ„›åª›çœŒ</option>
                        <option value="JP39">é«˜çŸ¥çœŒ</option>
                        <option value="JP40">ç¦å²¡çœŒ</option>
                        <option value="JP41">ä½è³€çœŒ</option>
                        <option value="JP42">é•·å´çœŒ</option>
                        <option value="JP43">ç†Šæœ¬çœŒ</option>
                        <option value="JP44">å¤§åˆ†çœŒ</option>
                        <option value="JP45">å®®å´çœŒ</option>
                        <option value="JP46">é¹¿å…å³¶çœŒ</option>
                        <option value="JP47">æ²–ç¸„çœŒ</option>
                    </select>
                </div>

                <div class="setting-group">
                    <div id="dateButtons" style="display: flex; gap: 4px; flex-wrap: wrap;">
                        <!-- æ—¥ä»˜ãƒœã‚¿ãƒ³ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                    </div>
                    <input type="hidden" id="targetDate" value="">
                </div>

                <div class="setting-group">
                    <label for="searchKeyword">æ¤œç´¢:</label>
                    <div style="position: relative; display: inline-block;">
                        <input type="text" id="searchKeyword" placeholder="ç•ªçµ„åã§æ¤œç´¢" style="width: 150px; padding-right: 25px;">
                        <button id="clearSearchBtn" onclick="clearSearchKeyword()"
                                style="position: absolute; right: 4px; top: 50%; transform: translateY(-50%); background: transparent; border: none; color: #999; cursor: pointer; padding: 2px 6px; font-size: 1.1em; display: none;"
                                onmouseover="this.style.color='#333'" onmouseout="this.style.color='#999'">
                            Ã—
                        </button>
                    </div>
                </div>

                <div class="setting-group">
                    <button onclick="toggleAdvancedSettings()"
                            style="padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em; transition: all 0.2s;"
                            onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">
                        âš™ï¸ <span id="advancedToggleText">è©³ç´°è¨­å®šã‚’è¡¨ç¤º</span>
                    </button>
                </div>
            </div>

            <div id="advancedSettings" style="display: none; padding: 15px; background: #f8f9fa; border-radius: 8px; margin: 10px 0; border-left: 4px solid #6c757d;">
                <div style="font-weight: 600; color: #495057; margin-bottom: 12px; font-size: 0.95em;">âš™ï¸ è©³ç´°è¨­å®š</div>
                <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                    <div class="setting-group" style="margin: 0;">
                        <label for="proxyUrl">ãƒ—ãƒ­ã‚­ã‚·URL:</label>
                        <input type="text" id="proxyUrl" value="" placeholder="/api" style="width: 80px;">
                    </div>

                    <div class="setting-group" style="margin: 0;">
                        <label for="scriptPath">ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ‘ã‚¹:</label>
                        <input type="text" id="scriptPath" value="/home/sites/radiko-recorder/script/myradiko" placeholder="ãƒ‘ã‚¹" style="width: 250px;">
                    </div>
                </div>
            </div>

            <button id="fetchBtn" class="btn btn-primary">ç•ªçµ„è¡¨ã‚’æ›´æ–°</button>
            <button id="searchAllBtn" class="btn btn-primary" style="margin-left: 8px;">å…¨ã‚¨ãƒªã‚¢ã‹ã‚‰æ¤œç´¢</button>
        </div>

            <div class="content">
                <div id="loading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>ç•ªçµ„è¡¨ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
                <div id="error" class="error" style="display: none;"></div>
                <div id="searchInfo" style="padding: 8px; font-size: 0.85em; color: #6c757d; display: none;"></div>
                <div id="programList" class="program-list"></div>
            </div>
        </div>

        <!-- éŒ²éŸ³æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ãƒ– -->
        <div id="filesTab" class="tab-content">
            <div class="content">
                <div style="padding: 15px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e9ecef;">
                        <h2 style="margin: 0; font-size: 1.3em; color: #212529;">ğŸ“ éŒ²éŸ³æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§</h2>
                        <button class="btn btn-primary" onclick="loadRecordedFiles()" style="padding: 6px 16px; font-size: 0.9em;">ğŸ”„ æ›´æ–°</button>
                    </div>
                    <div id="filesLoading" class="loading" style="display: none;">
                        <div class="spinner"></div>
                        <p>ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                    <div id="filesList"></div>
                </div>
            </div>
        </div>

        <!-- cronç®¡ç†ã‚¿ãƒ– -->
        <div id="cronTab" class="tab-content">
            <div class="content">
                <div style="padding: 15px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e9ecef;">
                        <h2 style="margin: 0; font-size: 1.3em; color: #212529;">â° å®šæœŸéŒ²éŸ³ç®¡ç†</h2>
                        <button class="btn btn-primary" onclick="loadCronJobs()" style="padding: 6px 16px; font-size: 0.9em;">ğŸ”„ æ›´æ–°</button>
                    </div>
                    <div id="cronLoading" class="loading" style="display: none;">
                        <div class="spinner"></div>
                        <p>cronä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                    <div id="cronList"></div>
                </div>
            </div>
        </div>

        <!-- atäºˆç´„ã‚¿ãƒ– -->
        <div id="atTab" class="tab-content">
            <div class="content">
                <div style="padding: 15px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e9ecef;">
                        <h2 style="margin: 0; font-size: 1.3em; color: #212529;">â±ï¸ ç•ªçµ„äºˆç´„ç®¡ç†</h2>
                        <button class="btn btn-primary" onclick="loadAtJobs()" style="padding: 6px 16px; font-size: 0.9em;">ğŸ”„ æ›´æ–°</button>
                    </div>
                    <div id="atLoading" class="loading" style="display: none;">
                        <div class="spinner"></div>
                        <p>atäºˆç´„ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                    <div id="atList"></div>
                </div>
            </div>
        </div>

        <!-- ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¿ãƒ– -->
        <div id="adminTab" class="tab-content">
            <div class="content">
                <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ç”»é¢ -->
                <div id="adminAuth" style="padding: 40px; background: white; text-align: center;">
                    <h2 style="margin-bottom: 20px; color: #212529;">ğŸ” ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
                    <p style="margin-bottom: 20px; color: #6c757d;">ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                    <div style="max-width: 300px; margin: 0 auto;">
                        <input type="password" id="adminPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
                               style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; margin-bottom: 15px;"
                               onkeypress="if(event.key==='Enter') authenticateAdmin()">
                        <button onclick="authenticateAdmin()"
                                style="width: 100%; padding: 10px 20px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em;">
                            ãƒ­ã‚°ã‚¤ãƒ³
                        </button>
                    </div>
                </div>

                <!-- ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼æœ¬ä½“ï¼ˆèªè¨¼å¾Œã«è¡¨ç¤ºï¼‰ -->
                <div id="adminPanel" style="display: none; padding: 15px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e9ecef;">
                        <h2 style="margin: 0; font-size: 1.3em; color: #212529;">ğŸ”§ ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
                        <button onclick="logoutAdmin()" style="padding: 6px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                    </div>

                    <!-- DBç•ªçµ„è¡¨ä¸€æ‹¬æ›´æ–° -->
                    <div style="margin-bottom: 25px; padding: 15px; border: 1px solid #e9ecef; border-radius: 4px;">
                        <h3 style="margin: 0 0 10px 0; font-size: 1.1em; color: #212529;">ğŸ“Š DBç•ªçµ„è¡¨ä¸€æ‹¬æ›´æ–°</h3>
                        <p style="margin: 0 0 10px 0; color: #6c757d; font-size: 0.9em;">å…¨ã‚¨ãƒªã‚¢ã®ç•ªçµ„è¡¨ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å–å¾—ãƒ»æ›´æ–°ã—ã¾ã™ï¼ˆæ·±å¤œãƒãƒƒãƒå‡¦ç†ç›¸å½“ï¼‰</p>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="updateDays" style="padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                <option value="1">ä»Šæ—¥ã®ã¿</option>
                                <option value="2">2æ—¥åˆ† (ä»Šæ—¥+æ˜æ—¥)</option>
                                <option value="3" selected>3æ—¥åˆ†</option>
                                <option value="7">7æ—¥åˆ†</option>
                            </select>
                            <button onclick="updateAllPrograms()" class="btn btn-primary" style="background: #007bff;">
                                ğŸ”„ ä¸€æ‹¬æ›´æ–°é–‹å§‹ (é€²æ—è¡¨ç¤º)
                            </button>
                        </div>
                        <p style="margin: 10px 0 0 0; color: #6c757d; font-size: 0.85em;">
                            âš ï¸ é€²æ—ã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‹ã„ãŸã¾ã¾ã«ã—ã¦ãã ã•ã„ã€‚<br>
                            ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œã™ã‚‹å ´åˆã¯ã€æ·±å¤œ3æ™‚ã®è‡ªå‹•å®Ÿè¡Œã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚
                        </p>
                        <div id="updateProgress" style="margin-top: 10px; display: none;">
                            <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
                            <div style="margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span id="updateProgressText" style="font-weight: 600; color: #495057; font-size: 0.9em;">æº–å‚™ä¸­...</span>
                                    <span id="updateProgressPercent" style="font-weight: 600; color: #007bff; font-size: 0.9em;">0%</span>
                                </div>
                                <div style="width: 100%; height: 24px; background: #e9ecef; border-radius: 12px; overflow: hidden; position: relative;">
                                    <div id="updateProgressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #007bff, #0056b3); transition: width 0.3s ease; display: flex; align-items: center; justify-content: center;">
                                        <span id="updateProgressBarText" style="color: white; font-size: 0.8em; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.3);"></span>
                                    </div>
                                </div>
                                <div style="margin-top: 5px; font-size: 0.85em; color: #6c757d;" id="updateProgressDetail">å¾…æ©Ÿä¸­...</div>
                            </div>
                            <!-- çµ±è¨ˆæƒ…å ± -->
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px;">
                                <div style="background: #d4edda; padding: 8px; border-radius: 4px; text-align: center; border: 1px solid #c3e6cb;">
                                    <div style="font-size: 0.75em; color: #155724; font-weight: 600;">âœ… æˆåŠŸ</div>
                                    <div style="font-size: 1.2em; font-weight: bold; color: #155724;" id="updateSuccessCount">0</div>
                                </div>
                                <div style="background: #f8d7da; padding: 8px; border-radius: 4px; text-align: center; border: 1px solid #f5c6cb;">
                                    <div style="font-size: 0.75em; color: #721c24; font-weight: 600;">âŒ ã‚¨ãƒ©ãƒ¼</div>
                                    <div style="font-size: 1.2em; font-weight: bold; color: #721c24;" id="updateErrorCount">0</div>
                                </div>
                                <div style="background: #fff3cd; padding: 8px; border-radius: 4px; text-align: center; border: 1px solid #ffeaa7;">
                                    <div style="font-size: 0.75em; color: #856404; font-weight: 600;">âš ï¸ è­¦å‘Š</div>
                                    <div style="font-size: 1.2em; font-weight: bold; color: #856404;" id="updateWarningCount">0</div>
                                </div>
                            </div>
                            <!-- ãƒ­ã‚°è¡¨ç¤º -->
                            <details open style="margin-bottom: 10px;">
                                <summary style="cursor: pointer; padding: 8px; background: #e9ecef; border-radius: 4px; font-weight: 600; user-select: none;">
                                    ğŸ“‹ è©³ç´°ãƒ­ã‚°
                                </summary>
                                <div style="background: #212529; color: #e9ecef; padding: 12px; border-radius: 4px; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.8em; max-height: 300px; overflow-y: auto; margin-top: 5px; line-height: 1.6;" id="updateLog"></div>
                            </details>
                        </div>
                    </div>

                    <!-- æ‰‹å‹•ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ -->
                    <div style="margin-bottom: 25px; padding: 15px; border: 1px solid #e9ecef; border-radius: 4px;">
                        <h3 style="margin: 0 0 10px 0; font-size: 1.1em; color: #212529;">âš¡ æ‰‹å‹•myradikoã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ</h3>
                        <p style="margin: 0 0 10px 0; color: #6c757d; font-size: 0.9em;">ç•ªçµ„è¡¨ã‚’çµŒç”±ã›ãšã«ç›´æ¥éŒ²éŸ³ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™</p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <div style="grid-column: 1 / -1;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057; font-size: 0.9em;">ç•ªçµ„å</label>
                                <input type="text" id="manualTitle" placeholder="ä¾‹: ãƒ©ã‚¸ã‚ªãƒ‹ãƒ¥ãƒ¼ã‚¹" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057; font-size: 0.9em;">ã‚¨ãƒªã‚¢</label>
                                <select id="manualArea" onchange="updateManualStations()" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                    <option value="">ã‚¨ãƒªã‚¢ã‚’é¸æŠ</option>
                                    <option value="JP13">æ±äº¬éƒ½</option>
                                    <option value="JP14">ç¥å¥ˆå·çœŒ</option>
                                    <option value="JP27">å¤§é˜ªåºœ</option>
                                    <option value="JP1">åŒ—æµ·é“</option>
                                    <option value="JP2">é’æ£®çœŒ</option>
                                    <option value="JP3">å²©æ‰‹çœŒ</option>
                                    <option value="JP4">å®®åŸçœŒ</option>
                                    <option value="JP5">ç§‹ç”°çœŒ</option>
                                    <option value="JP6">å±±å½¢çœŒ</option>
                                    <option value="JP7">ç¦å³¶çœŒ</option>
                                    <option value="JP8">èŒ¨åŸçœŒ</option>
                                    <option value="JP9">æ ƒæœ¨çœŒ</option>
                                    <option value="JP10">ç¾¤é¦¬çœŒ</option>
                                    <option value="JP11">åŸ¼ç‰çœŒ</option>
                                    <option value="JP12">åƒè‘‰çœŒ</option>
                                    <option value="JP15">æ–°æ½ŸçœŒ</option>
                                    <option value="JP16">å¯Œå±±çœŒ</option>
                                    <option value="JP17">çŸ³å·çœŒ</option>
                                    <option value="JP18">ç¦äº•çœŒ</option>
                                    <option value="JP19">å±±æ¢¨çœŒ</option>
                                    <option value="JP20">é•·é‡çœŒ</option>
                                    <option value="JP21">å²é˜œçœŒ</option>
                                    <option value="JP22">é™å²¡çœŒ</option>
                                    <option value="JP23">æ„›çŸ¥çœŒ</option>
                                    <option value="JP24">ä¸‰é‡çœŒ</option>
                                    <option value="JP25">æ»‹è³€çœŒ</option>
                                    <option value="JP26">äº¬éƒ½åºœ</option>
                                    <option value="JP28">å…µåº«çœŒ</option>
                                    <option value="JP29">å¥ˆè‰¯çœŒ</option>
                                    <option value="JP30">å’Œæ­Œå±±çœŒ</option>
                                    <option value="JP31">é³¥å–çœŒ</option>
                                    <option value="JP32">å³¶æ ¹çœŒ</option>
                                    <option value="JP33">å²¡å±±çœŒ</option>
                                    <option value="JP34">åºƒå³¶çœŒ</option>
                                    <option value="JP35">å±±å£çœŒ</option>
                                    <option value="JP36">å¾³å³¶çœŒ</option>
                                    <option value="JP37">é¦™å·çœŒ</option>
                                    <option value="JP38">æ„›åª›çœŒ</option>
                                    <option value="JP39">é«˜çŸ¥çœŒ</option>
                                    <option value="JP40">ç¦å²¡çœŒ</option>
                                    <option value="JP41">ä½è³€çœŒ</option>
                                    <option value="JP42">é•·å´çœŒ</option>
                                    <option value="JP43">ç†Šæœ¬çœŒ</option>
                                    <option value="JP44">å¤§åˆ†çœŒ</option>
                                    <option value="JP45">å®®å´çœŒ</option>
                                    <option value="JP46">é¹¿å…å³¶çœŒ</option>
                                    <option value="JP47">æ²–ç¸„çœŒ</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057; font-size: 0.9em;">æ”¾é€å±€</label>
                                <select id="manualStation" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                    <option value="">ã¾ãšã‚¨ãƒªã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057; font-size: 0.9em;">ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚åˆ»ï¼ˆäºˆç´„å®Ÿè¡Œæ™‚é–“ï¼‰</label>
                                <input type="datetime-local" id="manualExecuteTime" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                <small style="color: #6c757d; font-size: 0.8em;">at ã‚³ãƒãƒ³ãƒ‰ã§ã“ã®æ™‚åˆ»ã«å®Ÿè¡Œã•ã‚Œã¾ã™</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057; font-size: 0.9em;">éŒ²éŸ³é–‹å§‹æ—¥æ™‚</label>
                                <input type="datetime-local" id="manualStart" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                <small style="color: #6c757d; font-size: 0.8em;">å®Ÿéš›ã«éŒ²éŸ³ãŒé–‹å§‹ã•ã‚Œã‚‹æ™‚åˆ»</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057; font-size: 0.9em;">éŒ²éŸ³çµ‚äº†æ—¥æ™‚</label>
                                <input type="datetime-local" id="manualEnd" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                <small style="color: #6c757d; font-size: 0.8em;">æ—¥ä»˜ã‚’è·¨ãå ´åˆã‚‚æŒ‡å®šå¯èƒ½</small>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button onclick="executeManualCommand()" class="btn btn-primary" style="background: #dc3545; color: white;">
                                â–¶ï¸ å³åº§ã«å®Ÿè¡Œ
                            </button>
                            <button onclick="scheduleManualCommand()" class="btn" style="background: #007bff; color: white;">
                                â° atäºˆç´„ï¼ˆã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚åˆ»ã«å®Ÿè¡Œï¼‰
                            </button>
                            <button onclick="copyManualCommand()" class="btn" style="background: #6c757d; color: white;">
                                ğŸ“‹ ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
                            </button>
                        </div>
                        <div id="manualCommandPreview" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; font-family: monospace; font-size: 0.85em; display: none; white-space: pre-wrap;"></div>
                        <div id="manualOutput" style="margin-top: 10px; display: none;">
                            <div style="background: #212529; color: #0f0; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 0.85em; max-height: 300px; overflow-y: auto; white-space: pre-wrap;" id="manualLog"></div>
                        </div>
                    </div>

                    <!-- ãã®ä»–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
                    <div style="margin-bottom: 25px; padding: 15px; border: 1px solid #e9ecef; border-radius: 4px;">
                        <h3 style="margin: 0 0 10px 0; font-size: 1.1em; color: #212529;">ğŸ› ï¸ ãã®ä»–ã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹</h3>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="cleanupOldData()" class="btn" style="background: #ffc107; color: #212529;">
                                ğŸ—‘ï¸ å¤ã„DB ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
                            </button>
                            <button onclick="checkDiskSpace()" class="btn" style="background: #6c757d; color: white;">
                                ğŸ’¾ ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ç¢ºèª
                            </button>
                            <button onclick="viewDbStatus()" class="btn" style="background: #20c997; color: white;">
                                ğŸ“ˆ DBçµ±è¨ˆæƒ…å ±
                            </button>
                        </div>
                        <div id="maintenanceOutput" style="margin-top: 10px; display: none;">
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 0.85em; max-height: 300px; overflow-y: auto; white-space: pre-wrap;" id="maintenanceLog"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- atäºˆç´„ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="atEditModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3 style="margin: 0; color: #212529;">â±ï¸ atäºˆç´„ã®ç·¨é›†</h3>
                    <button onclick="closeAtEditModal()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: #6c757d;">&times;</button>
                </div>
                <div class="modal-body" style="padding: 20px;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">ç•ªçµ„å</label>
                        <input type="text" id="editAtTitle" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">ã‚¨ãƒªã‚¢</label>
                            <select id="editAtArea" onchange="updateEditAtStations()" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                <option value="">ã‚¨ãƒªã‚¢ã‚’é¸æŠ</option>
                                <option value="JP13">æ±äº¬éƒ½</option>
                                <option value="JP14">ç¥å¥ˆå·çœŒ</option>
                                <option value="JP27">å¤§é˜ªåºœ</option>
                                <option value="JP28">å…µåº«çœŒ</option>
                                <option value="JP1">åŒ—æµ·é“</option>
                                <option value="JP2">é’æ£®çœŒ</option>
                                <option value="JP3">å²©æ‰‹çœŒ</option>
                                <option value="JP4">å®®åŸçœŒ</option>
                                <option value="JP5">ç§‹ç”°çœŒ</option>
                                <option value="JP6">å±±å½¢çœŒ</option>
                                <option value="JP7">ç¦å³¶çœŒ</option>
                                <option value="JP8">èŒ¨åŸçœŒ</option>
                                <option value="JP9">æ ƒæœ¨çœŒ</option>
                                <option value="JP10">ç¾¤é¦¬çœŒ</option>
                                <option value="JP11">åŸ¼ç‰çœŒ</option>
                                <option value="JP12">åƒè‘‰çœŒ</option>
                                <option value="JP15">æ–°æ½ŸçœŒ</option>
                                <option value="JP16">å¯Œå±±çœŒ</option>
                                <option value="JP17">çŸ³å·çœŒ</option>
                                <option value="JP18">ç¦äº•çœŒ</option>
                                <option value="JP19">å±±æ¢¨çœŒ</option>
                                <option value="JP20">é•·é‡çœŒ</option>
                                <option value="JP21">å²é˜œçœŒ</option>
                                <option value="JP22">é™å²¡çœŒ</option>
                                <option value="JP23">æ„›çŸ¥çœŒ</option>
                                <option value="JP24">ä¸‰é‡çœŒ</option>
                                <option value="JP25">æ»‹è³€çœŒ</option>
                                <option value="JP26">äº¬éƒ½åºœ</option>
                                <option value="JP29">å¥ˆè‰¯çœŒ</option>
                                <option value="JP30">å’Œæ­Œå±±çœŒ</option>
                                <option value="JP31">é³¥å–çœŒ</option>
                                <option value="JP32">å³¶æ ¹çœŒ</option>
                                <option value="JP33">å²¡å±±çœŒ</option>
                                <option value="JP34">åºƒå³¶çœŒ</option>
                                <option value="JP35">å±±å£çœŒ</option>
                                <option value="JP36">å¾³å³¶çœŒ</option>
                                <option value="JP37">é¦™å·çœŒ</option>
                                <option value="JP38">æ„›åª›çœŒ</option>
                                <option value="JP39">é«˜çŸ¥çœŒ</option>
                                <option value="JP40">ç¦å²¡çœŒ</option>
                                <option value="JP41">ä½è³€çœŒ</option>
                                <option value="JP42">é•·å´çœŒ</option>
                                <option value="JP43">ç†Šæœ¬çœŒ</option>
                                <option value="JP44">å¤§åˆ†çœŒ</option>
                                <option value="JP45">å®®å´çœŒ</option>
                                <option value="JP46">é¹¿å…å³¶çœŒ</option>
                                <option value="JP47">æ²–ç¸„çœŒ</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">æ”¾é€å±€</label>
                            <select id="editAtStation" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                <option value="">ã¾ãšã‚¨ãƒªã‚¢ã‚’é¸æŠ</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">éŒ²éŸ³é–‹å§‹æ—¥æ™‚</label>
                        <input type="datetime-local" id="editAtStartTime" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                        <small style="color: #6c757d; font-size: 0.85em;">å®Ÿéš›ã«éŒ²éŸ³ãŒé–‹å§‹ã•ã‚Œã‚‹æ™‚åˆ»</small>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">éŒ²éŸ³çµ‚äº†æ—¥æ™‚</label>
                        <input type="datetime-local" id="editAtEndTime" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                        <small style="color: #6c757d; font-size: 0.85em;">æ—¥ä»˜ã‚’è·¨ãå ´åˆã‚‚æŒ‡å®šå¯èƒ½</small>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚åˆ»ï¼ˆäºˆç´„å®Ÿè¡Œæ™‚é–“ï¼‰</label>
                        <div style="display: flex; gap: 8px; align-items: flex-start;">
                            <input type="datetime-local" id="editAtExecuteTime" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                            <button onclick="setExecuteTimeToEndPlus5()" style="padding: 8px 12px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; font-size: 0.9em;">
                                çµ‚äº†+5åˆ†
                            </button>
                        </div>
                        <small style="color: #6c757d; font-size: 0.85em;">atã‚³ãƒãƒ³ãƒ‰ã§ã“ã®æ™‚åˆ»ã«å®Ÿè¡Œã•ã‚Œã¾ã™</small>
                    </div>
                    <input type="hidden" id="editAtJobId">
                </div>
                <div class="modal-footer">
                    <button onclick="closeAtEditModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button onclick="saveAtEdit()" style="padding: 10px 20px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer;">ä¿å­˜</button>
                </div>
            </div>
        </div>

        <footer>
            <p>&copy; 2025 éŒ²éŸ³ãã‚“ | Powered by radiko API</p>
        </footer>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">ã‚³ãƒãƒ³ãƒ‰</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="command-box" id="commandBox"></div>
            <div class="modal-actions">
                <button class="btn btn-action btn-execute" id="executeBtn" onclick="executeCommand()" style="display: none;">å®Ÿè¡Œ</button>
                <button class="btn btn-action" id="registerCronBtn" style="display: none; background: #28a745; color: white;">â° cronç™»éŒ²</button>
                <button class="btn btn-action btn-copy" onclick="copyCommand(event)">ã‚³ãƒ”ãƒ¼</button>
                <button class="btn btn-action btn-close" onclick="closeModal()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- cronãƒ­ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="cronLogModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>ğŸ“‹ cronãƒ­ã‚°</h2>
                <button class="modal-close" onclick="closeCronLogModal()">&times;</button>
            </div>
            <div style="margin-bottom: 15px;">
                <div style="padding: 10px; background: #f8f9fa; border-radius: 4px; font-size: 0.85em; color: #6c757d;">
                    cronã®å®Ÿè¡Œå±¥æ­´ã¨ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚æœ€æ–°100è¡Œã¾ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
                </div>
            </div>
            <div id="cronLogContent" style="max-height: 500px; overflow-y: auto; background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 0.8em; line-height: 1.6;">
                <div style="text-align: center; color: #888;">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-action" onclick="loadCronLogs()" style="background: #6c757d; color: white;">ğŸ”„ æ›´æ–°</button>
                <button class="btn btn-action btn-close" onclick="closeCronLogModal()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="audioPlayerModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="audioPlayerTitle">ğŸµ å†ç”Ÿä¸­</h2>
                <button class="modal-close" onclick="closeAudioPlayer()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <audio id="audioPlayer" controls style="width: 100%; margin-bottom: 15px;"
                       ontimeupdate="updatePlaybackPosition()"
                       onloadedmetadata="loadBookmark()">
                    <source id="audioSource" src="" type="audio/mpeg">
                    ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å†ç”Ÿã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚
                </audio>

                <!-- å†ç”Ÿé€Ÿåº¦ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
                <div style="padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <label style="font-size: 0.85em; color: #495057; font-weight: 600; min-width: 80px;">âš¡ å†ç”Ÿé€Ÿåº¦:</label>
                        <input type="range" id="playbackRate" min="0.5" max="2.0" step="0.1" value="1.0"
                               oninput="changePlaybackRate(this.value)"
                               style="flex: 1; cursor: pointer;">
                        <span id="playbackRateValue" style="min-width: 50px; font-size: 0.9em; font-weight: 600; color: #667eea;">1.0x</span>
                    </div>
                    <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                        <button onclick="setPlaybackRate(0.5)" class="speed-btn" style="padding: 4px 10px; background: white; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; font-size: 0.8em; transition: all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='white'">0.5x</button>
                        <button onclick="setPlaybackRate(0.75)" class="speed-btn" style="padding: 4px 10px; background: white; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; font-size: 0.8em; transition: all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='white'">0.75x</button>
                        <button onclick="setPlaybackRate(1.0)" class="speed-btn" style="padding: 4px 10px; background: white; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; font-size: 0.8em; transition: all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='white'">1.0x</button>
                        <button onclick="setPlaybackRate(1.25)" class="speed-btn" style="padding: 4px 10px; background: white; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; font-size: 0.8em; transition: all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='white'">1.25x</button>
                        <button onclick="setPlaybackRate(1.5)" class="speed-btn" style="padding: 4px 10px; background: white; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; font-size: 0.8em; transition: all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='white'">1.5x</button>
                        <button onclick="setPlaybackRate(2.0)" class="speed-btn" style="padding: 4px 10px; background: white; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; font-size: 0.8em; transition: all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='white'">2.0x</button>
                    </div>
                </div>

                <!-- ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯æƒ…å ± -->
                <div id="audioInfo" style="padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 0.9em; color: #495057;">
                    <div style="margin-bottom: 8px;"><strong>ãƒ•ã‚¡ã‚¤ãƒ«å:</strong> <span id="audioFileName"></span></div>
                    <div style="color: #6c757d; font-size: 0.85em; margin-top: 8px;">
                        ğŸ’¡ å†ç”Ÿä½ç½®ã¯è‡ªå‹•çš„ã«è¨˜æ†¶ã•ã‚Œã¾ã™
                    </div>
                    <div id="bookmarkInfo" style="color: #6c757d; font-size: 0.85em; display: none; margin-top: 8px; padding: 8px; background: #e7f3ff; border-left: 3px solid #667eea; border-radius: 4px;">
                        ğŸ“ å‰å›ã®ç¶šãã‹ã‚‰å†ç”Ÿã—ã¾ã™ (<span id="bookmarkTime"></span>)
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-action" onclick="saveBookmark()" style="background: #667eea; color: white;">ğŸ“ ä½ç½®ã‚’è¨˜æ†¶</button>
                <button class="btn btn-action" onclick="clearBookmark()" style="background: #6c757d; color: white;">ğŸ—‘ï¸ è¨˜æ†¶ã‚’å‰Šé™¤</button>
                <button class="btn btn-action btn-close" onclick="closeAudioPlayer()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- cronç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="cronEditModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>â° äºˆç´„ã‚’ç·¨é›†</h2>
                <button class="modal-close" onclick="closeCronEditModal()">&times;</button>
            </div>

            <!-- ç•ªçµ„æƒ…å ± -->
            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #495057;">ğŸ“º ç•ªçµ„æƒ…å ±</label>
                <div style="margin-bottom: 10px;">
                    <label style="font-size: 0.85em; color: #6c757d;">ç•ªçµ„å</label>
                    <input type="text" id="editProgramTitle" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                </div>
                <div style="font-size: 0.85em; color: #6c757d;" id="editProgramStation">æ”¾é€å±€</div>
            </div>

            <!-- éŒ²éŸ³æ™‚é–“è¨­å®š -->
            <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #495057;">ğŸ“¡ éŒ²éŸ³æ™‚é–“</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label style="font-size: 0.85em; color: #6c757d;">é–‹å§‹æ™‚åˆ» (HH:MM)</label>
                            <input type="time" id="editStartTime" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="font-size: 0.85em; color: #6c757d;">çµ‚äº†æ™‚åˆ» (HH:MM)</label>
                            <input type="time" id="editEndTime" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°è¨­å®š -->
            <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #495057;">â° å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                        <div>
                            <label style="font-size: 0.85em; color: #6c757d;">åˆ† (0-59)</label>
                            <input type="number" id="editMinute" min="0" max="59" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="font-size: 0.85em; color: #6c757d;">æ™‚ (0-23)</label>
                            <input type="number" id="editHour" min="0" max="23" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="font-size: 0.85em; color: #6c757d;">å®Ÿè¡Œé »åº¦</label>
                            <select id="editDayOfWeek" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                                <option value="*">æ¯æ—¥</option>
                                <option value="0">æ—¥æ›œæ—¥</option>
                                <option value="1">æœˆæ›œæ—¥</option>
                                <option value="2">ç«æ›œæ—¥</option>
                                <option value="3">æ°´æ›œæ—¥</option>
                                <option value="4">æœ¨æ›œæ—¥</option>
                                <option value="5">é‡‘æ›œæ—¥</option>
                                <option value="6">åœŸæ›œæ—¥</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div style="padding: 10px; background: #e7f3ff; border-radius: 4px; border-left: 4px solid #667eea;">
                    <div style="font-size: 0.9em; color: #0056b3; font-weight: 600;" id="cronPreview">
                        å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°: -
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #495057;">ğŸ¯ å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰</label>
                <textarea id="editCommandPreview" style="width: 100%; min-height: 120px; font-family: 'Courier New', monospace; font-size: 0.85em; color: #495057; background: #f8f9fa; padding: 12px; border: 1px solid #dee2e6; border-radius: 4px; resize: vertical; line-height: 1.6;" placeholder="cronã‚³ãƒãƒ³ãƒ‰"></textarea>
                <div style="font-size: 0.8em; color: #6c757d; margin-top: 5px;">
                    ğŸ’¡ ã‚³ãƒãƒ³ãƒ‰ã‚’ç›´æ¥ç·¨é›†ã§ãã¾ã™ã€‚éŒ²éŸ³æ™‚é–“ã‚’ç´°ã‹ãèª¿æ•´ã—ãŸã„å ´åˆãªã©ã«ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-action" onclick="saveCronEdit()" style="background: #28a745; color: white;">ğŸ’¾ ä¿å­˜</button>
                <button class="btn btn-action btn-close" onclick="closeCronEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <script>
        let currentCommand = '';
        let currentProgramData = null;
        let allProgramsData = [];
        let eventSource = null;
        let currentEditingCron = { original: '', commandPart: '' };
        // ç•ªçµ„è¡¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆã‚¨ãƒªã‚¢ID + æ—¥ä»˜ã‚’ã‚­ãƒ¼ã«ã™ã‚‹ï¼‰
        // å„ã‚¨ãƒ³ãƒˆãƒªã¯ { data: [...], timestamp: Date } ã®å½¢å¼
        const programCache = new Map();
        const CACHE_EXPIRE_MS = 30 * 60 * 1000; // 30åˆ†ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœŸé™åˆ‡ã‚Œ

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥é–¢é€£ã®é–¢æ•°ï¼ˆäº’æ›æ€§ã®ãŸã‚ç©ºå®Ÿè£…ã‚’æ®‹ã™ï¼‰
        async function loadCacheFromStorage() {
            console.log('â„¹ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯ã‚µãƒ¼ãƒãƒ¼å´DBã§ç®¡ç†ã•ã‚Œã¦ã„ã¾ã™');
        }

        async function saveCacheToStorage() {
            console.log('â„¹ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯ã‚µãƒ¼ãƒãƒ¼å´DBã§ç®¡ç†ã•ã‚Œã¦ã„ã¾ã™');
        }

        // å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ã™ã‚‹é–¢æ•°
        function clearOldCache() {
            console.log('ğŸ§¹ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–‹å§‹');
            console.log(`ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‰ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ•°: ${programCache.size}ä»¶`);

            const now = new Date();
            const today = new Date(now);

            // æœ5æ™‚æœªæº€ã®å ´åˆã¯å‰æ—¥ã¨ã—ã¦æ‰±ã†
            if (today.getHours() < 5) {
                today.setDate(today.getDate() - 1);
            }

            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            console.log(`åŸºæº–æ—¥: ${todayStr} (æœ5æ™‚åŸºæº–)`);

            // éå»7æ—¥é–“ã‹ã‚‰æœªæ¥7æ—¥é–“ã¾ã§ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿æŒï¼ˆè¨ˆ15æ—¥é–“ï¼‰
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const sevenDaysAgoStr = `${sevenDaysAgo.getFullYear()}-${String(sevenDaysAgo.getMonth() + 1).padStart(2, '0')}-${String(sevenDaysAgo.getDate()).padStart(2, '0')}`;

            const sevenDaysLater = new Date(today);
            sevenDaysLater.setDate(sevenDaysLater.getDate() + 7);
            const sevenDaysLaterStr = `${sevenDaysLater.getFullYear()}-${String(sevenDaysLater.getMonth() + 1).padStart(2, '0')}-${String(sevenDaysLater.getDate()).padStart(2, '0')}`;
            console.log(`ä¿æŒæœŸé–“: ${sevenDaysAgoStr} ã€œ ${sevenDaysLaterStr}`);

            // å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€ã¾ãŸã¯æœŸé™åˆ‡ã‚Œã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤
            const keysToDelete = [];
            programCache.forEach((value, key) => {
                // ã‚­ãƒ¼ã®å½¢å¼: "JP27_2025-01-23" ã¾ãŸã¯ "JP27_now"
                const parts = key.split('_');
                if (parts.length === 2) {
                    const date = parts[1];

                    // ä¿æŒæœŸé–“å¤–ã®æ—¥ä»˜ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯å‰Šé™¤
                    if (date !== 'now' && (date < sevenDaysAgoStr || date > sevenDaysLaterStr)) {
                        console.log(`  å‰Šé™¤ç†ç”±: ä¿æŒæœŸé–“å¤– - ${key} (ä¿æŒæœŸé–“: ${sevenDaysAgoStr} ã€œ ${sevenDaysLaterStr})`);
                        keysToDelete.push({ key, reason: 'ä¿æŒæœŸé–“å¤–' });
                        return;
                    }

                    // æœŸé™åˆ‡ã‚Œï¼ˆ30åˆ†ä»¥ä¸ŠçµŒéï¼‰ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚å‰Šé™¤
                    if (!isCacheValid(value)) {
                        const age = Math.floor((Date.now() - value.timestamp) / 60000);
                        console.log(`  å‰Šé™¤ç†ç”±: æœŸé™åˆ‡ã‚Œ - ${key} (${age}åˆ†çµŒé)`);
                        keysToDelete.push({ key, reason: `æœŸé™åˆ‡ã‚Œ(${age}åˆ†)` });
                        return;
                    }

                    // æœ‰åŠ¹ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥
                    const age = Math.floor((Date.now() - value.timestamp) / 60000);
                    console.log(`  ä¿æŒ: ${key} (${age}åˆ†çµŒé, æœ‰åŠ¹æœŸé™å†…)`);
                }
            });

            keysToDelete.forEach(item => {
                programCache.delete(item.key);
                console.log(`âŒ å‰Šé™¤: ${item.key} (${item.reason})`);
            });

            if (keysToDelete.length > 0) {
                console.log(`âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†: ${keysToDelete.length}ä»¶å‰Šé™¤`);
                // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¾Œã«localStorageã‚’æ›´æ–°
                saveCacheToStorage();
            } else {
                console.log('âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—: å‰Šé™¤å¯¾è±¡ãªã—');
            }
            console.log(`ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¾Œã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ•°: ${programCache.size}ä»¶`);
        }

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•°
        function isCacheValid(cacheEntry) {
            if (!cacheEntry || !cacheEntry.timestamp) {
                return false;
            }
            const now = Date.now();
            const age = now - cacheEntry.timestamp;
            return age < CACHE_EXPIRE_MS;
        }

        // ç•ªçµ„æ¤œç´¢ã‚¿ãƒ–ã®åˆæœŸåŒ–ï¼ˆæœ¬æ—¥ã®ç¾åœ¨æ™‚åˆ»ã®ç•ªçµ„ã‚’è¡¨ç¤ºï¼‰
        function initializeSearchTab() {
            // æœ¬æ—¥ã®æ—¥ä»˜ã‚’è¨­å®š
            const today = new Date();
            const dateStr = today.toISOString().slice(0, 10);
            document.getElementById('targetDate').value = dateStr;

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¨ãƒªã‚¢ãŒé¸æŠã•ã‚Œã¦ã„ã‚Œã°ç•ªçµ„ã‚’å–å¾—
            const areaId = document.getElementById('areaId').value;
            if (areaId) {
                fetchPrograms();
            }
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tabName) {
            // å…¨ã¦ã®ã‚¿ãƒ–ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // ç¾åœ¨ã®ã‚¿ãƒ–ã‚’localStorageã«ä¿å­˜
            localStorage.setItem('currentTab', tabName);

            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            if (tabName === 'search') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('searchTab').classList.add('active');
                // ç•ªçµ„æ¤œç´¢ã‚¿ãƒ–ã‚’é–‹ã„ãŸæ™‚ã«æœ¬æ—¥ã®ç•ªçµ„ã‚’è‡ªå‹•è¡¨ç¤º
                initializeSearchTab();
            } else if (tabName === 'files') {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('filesTab').classList.add('active');
                // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ãƒ–ã‚’é–‹ã„ãŸæ™‚ã«è‡ªå‹•èª­ã¿è¾¼ã¿
                loadRecordedFiles();
            } else if (tabName === 'at') {
                document.querySelectorAll('.tab')[2].classList.add('active');
                document.getElementById('atTab').classList.add('active');
                // atäºˆç´„ã‚¿ãƒ–ã‚’é–‹ã„ãŸæ™‚ã«è‡ªå‹•èª­ã¿è¾¼ã¿
                loadAtJobs();
            } else if (tabName === 'cron') {
                document.querySelectorAll('.tab')[3].classList.add('active');
                document.getElementById('cronTab').classList.add('active');
                // cronã‚¿ãƒ–ã‚’é–‹ã„ãŸæ™‚ã«è‡ªå‹•èª­ã¿è¾¼ã¿
                loadCronJobs();
            } else if (tabName === 'admin') {
                document.querySelectorAll('.tab')[4].classList.add('active');
                document.getElementById('adminTab').classList.add('active');
            }
        }

        // ä»Šæ—¥ã®æ—¥ä»˜ã¨ã‚¨ãƒªã‚¢ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’è¨­å®š
        document.addEventListener('DOMContentLoaded', async function() {
            // æ—§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
            if (localStorage.getItem('radikoCache')) {
                console.log('ğŸ—‘ï¸ æ—§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤');
                localStorage.removeItem('radikoCache');
            }

            // IndexedDBãŒã‚ã‚Œã°å‰Šé™¤
            try {
                indexedDB.deleteDatabase('RadikoCacheDB');
                console.log('ğŸ—‘ï¸ æ—§IndexedDBã‚’å‰Šé™¤');
            } catch (err) {
                console.log('â„¹ï¸ IndexedDBå‰Šé™¤ã‚¹ã‚­ãƒƒãƒ—');
            }

            console.log('âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚·ã‚¹ãƒ†ãƒ : ã‚µãƒ¼ãƒãƒ¼å´DBä½¿ç”¨')

            // ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‚¿ãƒ–ã‚’å¾©å…ƒ
            const savedTab = localStorage.getItem('currentTab');
            if (savedTab) {
                switchTab(savedTab);
            }

            // è©³ç´°è¨­å®šã®é–‹é–‰çŠ¶æ…‹ã‚’å¾©å…ƒ
            const advancedSettingsOpen = localStorage.getItem('advancedSettingsOpen');
            if (advancedSettingsOpen === 'true') {
                toggleAdvancedSettings();
            }

            // æ—¥æœ¬æ™‚é–“ã§ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—ï¼ˆæœ5æ™‚ã‚’æ—¥ä»˜ã®å¤‰ã‚ã‚Šç›®ã¨ã™ã‚‹ï¼‰
            const now = new Date();
            const today = new Date(now);

            // æœ5æ™‚æœªæº€ã®å ´åˆã¯å‰æ—¥ã¨ã—ã¦æ‰±ã†
            if (today.getHours() < 5) {
                today.setDate(today.getDate() - 1);
            }

            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;

            document.getElementById('targetDate').value = dateStr;

            // éå»7æ—¥é–“ + ä»Šæ—¥ + æœªæ¥7æ—¥é–“ã®æ—¥ä»˜ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆï¼ˆè¨ˆ15æ—¥é–“ï¼‰
            const dateButtonsContainer = document.getElementById('dateButtons');
            const dayLabels = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];

            for (let i = -7; i <= 7; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() + i);

                const btnYear = date.getFullYear();
                const btnMonth = String(date.getMonth() + 1).padStart(2, '0');
                const btnDay = String(date.getDate()).padStart(2, '0');
                const btnDateStr = `${btnYear}-${btnMonth}-${btnDay}`;
                const dayOfWeek = dayLabels[date.getDay()];

                const button = document.createElement('button');
                button.type = 'button';

                // ä»Šæ—¥ã®å ´åˆã¯ã€Œä»Šæ—¥ã€ã¨è¡¨ç¤º
                if (i === 0) {
                    button.textContent = `ä»Šæ—¥ ${btnMonth}/${btnDay}(${dayOfWeek})`;
                } else {
                    button.textContent = `${btnMonth}/${btnDay}(${dayOfWeek})`;
                }

                button.dataset.date = btnDateStr;

                // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
                if (i === 0) {
                    button.style.cssText = 'padding: 4px 8px; border: 1px solid #667eea; background: #667eea; color: white; border-radius: 4px; font-size: 0.8em; cursor: pointer; transition: all 0.15s;';
                } else {
                    button.style.cssText = 'padding: 4px 8px; border: 1px solid #ced4da; background: #f8f9fa; color: #6c757d; border-radius: 4px; font-size: 0.8em; cursor: pointer; transition: all 0.15s;';
                }

                button.addEventListener('click', async function() {
                    // ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
                    dateButtonsContainer.querySelectorAll('button').forEach(btn => {
                        btn.style.cssText = 'padding: 4px 8px; border: 1px solid #ced4da; background: #f8f9fa; color: #6c757d; border-radius: 4px; font-size: 0.8em; cursor: pointer; transition: all 0.15s;';
                    });

                    // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
                    this.style.cssText = 'padding: 4px 8px; border: 1px solid #667eea; background: #667eea; color: white; border-radius: 4px; font-size: 0.8em; cursor: pointer; transition: all 0.15s;';

                    // éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«æ—¥ä»˜ã‚’è¨­å®š
                    document.getElementById('targetDate').value = this.dataset.date;

                    // ç•ªçµ„è¡¨ã‚’è‡ªå‹•å–å¾—
                    await fetchPrograms();
                });

                dateButtonsContainer.appendChild(button);

                // ä»Šæ—¥ã®ãƒœã‚¿ãƒ³ã®å ´åˆã€åˆæœŸè¡¨ç¤ºç”¨ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¿å­˜
                if (i === 0) {
                    // DOMContentLoadedå®Œäº†å¾Œã«è‡ªå‹•ã§ç•ªçµ„è¡¨ã‚’å–å¾—
                    setTimeout(() => {
                        button.click();
                    }, 100);
                }
            }

            // ã‚¨ãƒªã‚¢ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’å¤§é˜ªã«è¨­å®š
            document.getElementById('areaId').value = 'JP27';
        });

        // ã€Œç•ªçµ„è¡¨ã‚’å–å¾—ã€ãƒœã‚¿ãƒ³ã¯å¼·åˆ¶æ›´æ–°
        document.getElementById('fetchBtn').addEventListener('click', () => fetchPrograms(true));
        document.getElementById('searchAllBtn').addEventListener('click', searchAllAreas);

        // ã‚¨ãƒªã‚¢é¸æŠå¤‰æ›´æ™‚ã«è‡ªå‹•å–å¾—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ©ç”¨ï¼‰
        document.getElementById('areaId').addEventListener('change', () => fetchPrograms(false));

        // æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›æ™‚ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        document.getElementById('searchKeyword').addEventListener('input', function() {
            // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
            const clearBtn = document.getElementById('clearSearchBtn');
            if (clearBtn) {
                clearBtn.style.display = this.value ? 'block' : 'none';
            }

            if (allProgramsData.length > 0) {
                displayPrograms(allProgramsData);
            }
        });

        // æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªã‚¢
        function clearSearchKeyword() {
            const searchInput = document.getElementById('searchKeyword');
            const clearBtn = document.getElementById('clearSearchBtn');

            searchInput.value = '';
            if (clearBtn) {
                clearBtn.style.display = 'none';
            }

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’æ›´æ–°
            if (allProgramsData.length > 0) {
                displayPrograms(allProgramsData);
            }
        }

        async function fetchPrograms(forceRefresh = false) {
            const areaId = document.getElementById('areaId').value;
            const proxyUrl = document.getElementById('proxyUrl').value;
            const targetDate = document.getElementById('targetDate').value;

            if (!areaId) {
                showError('ã‚¨ãƒªã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const programList = document.getElementById('programList');
            const fetchBtn = document.getElementById('fetchBtn');

            loading.style.display = 'block';
            error.style.display = 'none';
            programList.innerHTML = '';
            fetchBtn.disabled = true;

            try {
                // DB APIã‹ã‚‰ç•ªçµ„è¡¨ã‚’å–å¾—
                const baseApiUrl = proxyUrl.trim() || '';
                const dateStr = targetDate ? targetDate.replace(/-/g, '') : new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const forceParam = forceRefresh ? '?force=true' : '';
                const apiUrl = `${baseApiUrl}/api/programs/area/${areaId}/date/${dateStr}${forceParam}`;

                console.log('ğŸ“¡ Fetching from DB API:', apiUrl, forceRefresh ? '(å¼·åˆ¶æ›´æ–°)' : '');
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'ç•ªçµ„è¡¨ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                console.log(`âœ… Loaded ${data.count} programs from DB`);

                // DB APIã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å½¢å¼ã«å¤‰æ›
                const allPrograms = data.programs.map(prog => ({
                    stationId: prog.stationId,
                    stationName: prog.stationName,
                    title: prog.title,
                    ft: new Date(prog.ft),
                    to: new Date(prog.to),
                    desc: prog.desc || 'èª¬æ˜ãªã—',
                    pfm: prog.pfm || '',
                    info: prog.info || '',
                    url: prog.url || ''
                }));

                // æ™‚åˆ»é †ã«ã‚½ãƒ¼ãƒˆ
                allPrograms.sort((a, b) => a.ft - b.ft);

                displayPrograms(allPrograms);

            } catch (err) {
                showError(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${err.message}`);
            } finally {
                loading.style.display = 'none';
                fetchBtn.disabled = false;
            }
        }

        function parseRadikoTime(timeStr) {
            const year = parseInt(timeStr.substring(0, 4), 10);
            const month = parseInt(timeStr.substring(4, 6), 10) - 1;
            const day = parseInt(timeStr.substring(6, 8), 10);
            const hour = parseInt(timeStr.substring(8, 10), 10);
            const minute = parseInt(timeStr.substring(10, 12), 10);
            const second = parseInt(timeStr.substring(12, 14), 10);
            return new Date(year, month, day, hour, minute, second);
        }

        function formatDateTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hour = String(date.getHours()).padStart(2, '0');
            const minute = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day} ${hour}:${minute}`;
        }

        function displayPrograms(programs) {
            const programList = document.getElementById('programList');
            programList.innerHTML = '';
            allProgramsData = programs;

            if (programs.length === 0) {
                programList.innerHTML = '<p class="loading">ç•ªçµ„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';
                return;
            }

            // æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const searchKeyword = document.getElementById('searchKeyword').value.trim().toLowerCase();
            const searchInfo = document.getElementById('searchInfo');
            let filteredPrograms = programs;

            if (searchKeyword) {
                filteredPrograms = programs.filter(prog =>
                    prog.title.toLowerCase().includes(searchKeyword) ||
                    (prog.pfm && prog.pfm.toLowerCase().includes(searchKeyword)) ||
                    (prog.desc && prog.desc.toLowerCase().includes(searchKeyword))
                );

                searchInfo.textContent = `ã€Œ${searchKeyword}ã€ã®æ¤œç´¢çµæœ: ${filteredPrograms.length}ä»¶ / å…¨${programs.length}ä»¶`;
                searchInfo.style.display = 'block';
            } else {
                searchInfo.style.display = 'none';
            }

            if (filteredPrograms.length === 0) {
                const noResultMsg = document.createElement('p');
                noResultMsg.className = 'loading';
                noResultMsg.style.gridColumn = '1 / -1';
                noResultMsg.textContent = `ã€Œ${searchKeyword}ã€ã«ä¸€è‡´ã™ã‚‹ç•ªçµ„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`;
                programList.appendChild(noResultMsg);
                return;
            }

            // æ—¥ä»˜ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼ˆæœ5æ™‚ã‚’æ—¥ä»˜ã®å¤‰ã‚ã‚Šç›®ã¨ã™ã‚‹ï¼‰
            const dateMap = new Map();
            filteredPrograms.forEach((prog, index) => {
                prog._index = programs.indexOf(prog); // å…ƒã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¿å­˜
                const progDate = new Date(prog.ft);

                // æœ5æ™‚æœªæº€ã®ç•ªçµ„ã¯å‰æ—¥ã¨ã—ã¦æ‰±ã†
                const displayDate = new Date(progDate);
                if (displayDate.getHours() < 5) {
                    displayDate.setDate(displayDate.getDate() - 1);
                }

                const dateKey = `${displayDate.getFullYear()}-${String(displayDate.getMonth() + 1).padStart(2, '0')}-${String(displayDate.getDate()).padStart(2, '0')}`;

                if (!dateMap.has(dateKey)) {
                    dateMap.set(dateKey, {
                        date: displayDate,
                        programs: []
                    });
                }
                dateMap.get(dateKey).programs.push(prog);
            });

            // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
            const sortedDates = Array.from(dateMap.keys()).sort();

            // æ—¥ä»˜ã”ã¨ã«è¡¨ç¤º
            sortedDates.forEach(dateKey => {
                const dateGroup = dateMap.get(dateKey);
                const programDate = dateGroup.date;
                const year = programDate.getFullYear();
                const month = programDate.getMonth() + 1;
                const day = programDate.getDate();
                const dayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][programDate.getDay()];

                // æ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼
                const dateHeaderElement = document.createElement('div');
                dateHeaderElement.style.cssText = 'grid-column: 1 / -1; padding: 15px 20px; margin-bottom: 20px; margin-top: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); text-align: center;';
                dateHeaderElement.innerHTML = `
                    <div style="font-size: 1.3em; font-weight: bold; margin-bottom: 5px;">
                        ğŸ“… ${year}å¹´${month}æœˆ${day}æ—¥ï¼ˆ${dayOfWeek}ï¼‰
                    </div>
                    <div style="font-size: 0.9em; opacity: 0.95;">
                        ${dateGroup.programs.length}ä»¶ã®ç•ªçµ„
                    </div>
                `;
                programList.appendChild(dateHeaderElement);

                // ã“ã®æ—¥ä»˜ã®ç•ªçµ„ã‚’æ”¾é€å±€ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
                const stationMap = new Map();
                dateGroup.programs.forEach(prog => {
                    if (!stationMap.has(prog.stationId)) {
                        stationMap.set(prog.stationId, {
                            name: prog.stationName,
                            id: prog.stationId,
                            programs: []
                        });
                    }
                    stationMap.get(prog.stationId).programs.push(prog);
                });

                displayStations(stationMap, programList);
            });
        }

        function displayStations(stationMap, programList) {

            // å„æ”¾é€å±€ã®åˆ—ã‚’ä½œæˆ
            stationMap.forEach(station => {
                const column = document.createElement('div');
                column.className = 'station-column';

                const header = document.createElement('div');
                header.className = 'station-header';
                header.textContent = `${station.name} (${station.id})`;
                column.appendChild(header);

                const programsContainer = document.createElement('div');
                programsContainer.className = 'station-programs';

                const now = new Date();
                let nowPlayingCard = null;

                // æ™‚åˆ»é †ã«ã‚½ãƒ¼ãƒˆ
                station.programs.sort((a, b) => a.ft - b.ft);

                station.programs.forEach(prog => {
                    const card = document.createElement('div');
                    card.className = 'program-card';

                    // æ”¾é€ä¸­ã®ç•ªçµ„ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                    if (prog.ft <= now && prog.to > now) {
                        card.classList.add('now-playing');
                        nowPlayingCard = card;
                    }

                    const startTime = `${String(prog.ft.getHours()).padStart(2, '0')}:${String(prog.ft.getMinutes()).padStart(2, '0')}`;
                    const endTime = `${String(prog.to.getHours()).padStart(2, '0')}:${String(prog.to.getMinutes()).padStart(2, '0')}`;

                    // ç•ªçµ„ãŒçµ‚äº†ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    const isPastProgram = prog.to < now;
                    const isFutureProgram = prog.ft > now;

                    // radikoã®URL
                    const radikoTime = formatRadikoUrl(prog.ft);
                    const radikoUrl = `https://radiko.jp/#!/ts/${prog.stationId}/${radikoTime}`;

                    // ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
                    let buttonsHtml = '';

                    // çµ‚äº†æ¸ˆã¿ç•ªçµ„ï¼šãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
                    if (isPastProgram) {
                        buttonsHtml += `<button class="btn-action btn-download" onclick='showDownloadCommandByIndex(${prog._index})'>DL</button>`;
                    }

                    // æœªæ¥ã®ç•ªçµ„ã¾ãŸã¯æ”¾é€ä¸­ã®ç•ªçµ„ï¼šäºˆç´„ãƒœã‚¿ãƒ³
                    if (!isPastProgram) {
                        buttonsHtml += `<button class="btn-action btn-at" onclick='showAtCommandByIndex(${prog._index})'>äºˆç´„</button>`;
                    }

                    // å®šæœŸéŒ²éŸ³ãƒœã‚¿ãƒ³ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰
                    buttonsHtml += `<button class="btn-action btn-cron" onclick='showCronCommandByIndex(${prog._index})'>å®šæœŸ</button>`;

                    // radikoãƒœã‚¿ãƒ³ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰
                    buttonsHtml += `<a href="${radikoUrl}" target="_blank" rel="noopener noreferrer" style="background: white; border: 1px solid #ddd; padding: 3px; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; line-height: 1; border-radius: 4px; width: 24px; height: 24px;" title="radikoã§è´ã"><img src="img/radiko.png" alt="radiko" style="width: 18px; height: 18px; display: block;"></a>`;

                    card.innerHTML = `
                        <div class="program-time">${startTime} - ${endTime}</div>
                        <div class="program-title" onclick='showProgramDetailByIndex(${prog._index})' style="cursor: pointer; color: #007bff;">${prog.title}</div>
                        ${prog.pfm ? `<div class="program-detail">${prog.pfm}</div>` : ''}
                        <div class="program-actions">
                            ${buttonsHtml}
                        </div>
                    `;

                    programsContainer.appendChild(card);
                });

                column.appendChild(programsContainer);
                programList.appendChild(column);

                // å„æ”¾é€å±€ã®ã‚³ãƒ³ãƒ†ãƒŠå†…ã§æ”¾é€ä¸­ã®ç•ªçµ„ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                if (nowPlayingCard) {
                    setTimeout(() => {
                        // station-programs ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ã®ä½ç½®ã‚’è¨ˆç®—
                        const containerTop = programsContainer.offsetTop;
                        const cardTop = nowPlayingCard.offsetTop;
                        const scrollPosition = cardTop - containerTop - 20; // 20pxã®ä½™ç™½

                        programsContainer.scrollTop = scrollPosition;
                    }, 100);
                }
            });
        }

        function showCronCommandByIndex(index) {
            showCronCommand(allProgramsData[index]);
        }

        function showDownloadCommandByIndex(index) {
            showDownloadCommand(allProgramsData[index]);
        }

        function showAtCommandByIndex(index) {
            showAtCommand(allProgramsData[index]);
        }

        function showProgramDetailByIndex(index) {
            showProgramDetail(allProgramsData[index]);
        }

        function cleanupDescription(text) {
            if (!text) return '';

            // &nbsp;ã‚’é€šå¸¸ã®ã‚¹ãƒšãƒ¼ã‚¹ã«å¤‰æ›
            let cleaned = text.replace(/&nbsp;/gi, ' ');

            // é€£ç¶šã™ã‚‹<br>ã‚’1ã¤ã®æ”¹è¡Œã«å¤‰æ›
            cleaned = cleaned.replace(/(<br\s*\/?>)+/gi, '\n');

            // é€£ç¶šã™ã‚‹ç©ºè¡Œã‚’1ã¤ã«
            cleaned = cleaned.replace(/\n{3,}/g, '\n\n');

            // é€£ç¶šã™ã‚‹ã‚¹ãƒšãƒ¼ã‚¹ã‚’1ã¤ã«
            cleaned = cleaned.replace(/ {2,}/g, ' ');

            // å‰å¾Œã®ç©ºç™½ã‚’å‰Šé™¤
            cleaned = cleaned.trim();

            return cleaned;
        }

        function showProgramDetail(prog) {
            const startTime = `${String(prog.ft.getHours()).padStart(2, '0')}:${String(prog.ft.getMinutes()).padStart(2, '0')}`;
            const endTime = `${String(prog.to.getHours()).padStart(2, '0')}:${String(prog.to.getMinutes()).padStart(2, '0')}`;
            const dateStr = `${prog.ft.getFullYear()}/${prog.ft.getMonth() + 1}/${prog.ft.getDate()}`;

            // radikoã®ç•ªçµ„ãƒšãƒ¼ã‚¸URLï¼ˆç§’ã¾ã§å«ã‚€14æ¡å½¢å¼ï¼‰
            const radikoTime = formatRadikoUrl(prog.ft);
            const radikoUrl = `https://radiko.jp/#!/ts/${prog.stationId}/${radikoTime}`;

            // ç•ªçµ„èª¬æ˜ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            const cleanDesc = cleanupDescription(prog.desc);

            let detailHtml = `
                <div style="font-size: 14px; line-height: 1.6; color: #333;">
                    <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #ddd;">
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">${prog.title}</div>
                        <div style="color: #666; font-size: 13px; margin-bottom: 8px;">
                            <div>${prog.stationName} (${prog.stationId})</div>
                            <div>${dateStr} ${startTime} - ${endTime}</div>
                        </div>
                        <div>
                            <a href="${radikoUrl}" target="_blank" rel="noopener noreferrer"
                               style="display: inline-block; padding: 8px 16px; background: #667eea; color: white; text-decoration: none; border-radius: 6px; font-size: 13px; font-weight: 600;">
                                ğŸ“» radikoã§è´ã
                            </a>
                        </div>
                    </div>
            `;

            if (prog.pfm) {
                const cleanPfm = cleanupDescription(prog.pfm);
                detailHtml += `
                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: bold; margin-bottom: 4px; font-size: 13px; color: #555;">å‡ºæ¼”è€…</div>
                        <div style="padding: 8px 10px; background: #f5f5f5; border-left: 3px solid #007bff; font-size: 13px; white-space: pre-line;">${cleanPfm}</div>
                    </div>
                `;
            }

            if (cleanDesc && cleanDesc !== 'èª¬æ˜ãªã—') {
                // ãƒ†ãƒ³ãƒãƒ©ãƒªè¦ç´ ã§HTMLã‚’ãƒ‘ãƒ¼ã‚¹
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = cleanDesc;

                detailHtml += `
                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: bold; margin-bottom: 4px; font-size: 13px; color: #555;">ç•ªçµ„èª¬æ˜</div>
                        <div style="padding: 8px 10px; background: #f5f5f5; border-left: 3px solid #007bff; font-size: 13px; line-height: 1.8; white-space: pre-line;">${tempDiv.innerHTML}</div>
                    </div>
                `;
            }

            if (prog.url) {
                detailHtml += `
                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: bold; margin-bottom: 4px; font-size: 13px; color: #555;">URL</div>
                        <div style="padding: 8px 10px; background: #f5f5f5; border-left: 3px solid #007bff; font-size: 13px; word-break: break-all;">
                            <a href="${prog.url}" target="_blank" style="color: #007bff; text-decoration: none;">${prog.url}</a>
                        </div>
                    </div>
                `;
            }

            if (prog.info) {
                const cleanInfo = cleanupDescription(prog.info);
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = cleanInfo;

                detailHtml += `
                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: bold; margin-bottom: 4px; font-size: 13px; color: #555;">ãã®ä»–æƒ…å ±</div>
                        <div style="padding: 8px 10px; background: #f5f5f5; border-left: 3px solid #007bff; font-size: 12px; color: #666; line-height: 1.8; white-space: pre-line;">${tempDiv.innerHTML}</div>
                    </div>
                `;
            }

            detailHtml += '</div>';

            currentCommand = ''; // ã‚³ãƒãƒ³ãƒ‰ã¯ã‚¯ãƒªã‚¢ã™ã‚‹
            document.getElementById('modalTitle').textContent = 'ç•ªçµ„è©³ç´°';
            document.getElementById('commandBox').innerHTML = detailHtml;
            document.getElementById('modal').classList.add('active');
        }

        function showCronCommand(prog) {
            const scriptPath = document.getElementById('scriptPath').value;
            const startTime = new Date(prog.ft);
            const endTime = new Date(prog.to);

            // cronå®Ÿè¡Œæ™‚åˆ»ï¼ˆç•ªçµ„çµ‚äº†ã®5åˆ†å¾Œï¼‰
            const cronExecTime = new Date(prog.to);
            cronExecTime.setMinutes(cronExecTime.getMinutes() + 5);
            const minute = cronExecTime.getMinutes();
            const hour = cronExecTime.getHours();
            const dayOfWeek = cronExecTime.getDay();

            // é–‹å§‹æ™‚åˆ»ã¨çµ‚äº†æ™‚åˆ»ï¼ˆæ™‚åˆ†ã®ã¿ã€ç•ªçµ„è¡¨é€šã‚Šï¼‰
            const startHHMM = `${String(startTime.getHours()).padStart(2, '0')}${String(startTime.getMinutes()).padStart(2, '0')}`;
            const endHHMM = `${String(endTime.getHours()).padStart(2, '0')}${String(endTime.getMinutes()).padStart(2, '0')}`;

            // éŒ²éŸ³é–‹å§‹æ—¥ã¨cronå®Ÿè¡Œæ—¥ã®æ—¥ä»˜ã‚’æ¯”è¼ƒ
            // éŒ²éŸ³é–‹å§‹æ—¥ãŒcronå®Ÿè¡Œæ—¥ã¨ç•°ãªã‚‹å ´åˆã€é–‹å§‹æ—¥ã¯cronå®Ÿè¡Œæ—¥ã®å‰æ—¥
            const startDateStr = `${startTime.getFullYear()}-${String(startTime.getMonth()+1).padStart(2,'0')}-${String(startTime.getDate()).padStart(2,'0')}`;
            const cronExecDateStr = `${cronExecTime.getFullYear()}-${String(cronExecTime.getMonth()+1).padStart(2,'0')}-${String(cronExecTime.getDate()).padStart(2,'0')}`;
            const endDateStr = `${endTime.getFullYear()}-${String(endTime.getMonth()+1).padStart(2,'0')}-${String(endTime.getDate()).padStart(2,'0')}`;

            // é–‹å§‹æ—¥ãŒcronå®Ÿè¡Œæ—¥ã¨ç•°ãªã‚‹å ´åˆ
            const startNeedsYesterday = startDateStr !== cronExecDateStr;
            // çµ‚äº†æ—¥ãŒcronå®Ÿè¡Œæ—¥ã¨ç•°ãªã‚‹å ´åˆ
            const endNeedsYesterday = endDateStr !== cronExecDateStr;

            // æ—¥ä»˜è¨ˆç®—ã®éƒ¨åˆ†
            let startDateCalc = '';
            if (startNeedsYesterday) {
                // cronå®Ÿè¡Œæ—¥ã®å‰æ—¥ã‚’éŒ²éŸ³é–‹å§‹æ—¥ã¨ã™ã‚‹
                startDateCalc = '\`date -d yesterday +\\%Y\\%m\\%d\`';
            } else {
                // cronå®Ÿè¡Œæ—¥ã¨åŒã˜æ—¥ã‚’éŒ²éŸ³é–‹å§‹æ—¥ã¨ã™ã‚‹
                startDateCalc = '\`date +\\%Y\\%m\\%d\`';
            }

            // éŒ²éŸ³çµ‚äº†æ—¥ã®è¨ˆç®—
            let endDateCalc = '';
            if (endNeedsYesterday) {
                // cronå®Ÿè¡Œæ—¥ã®å‰æ—¥ã‚’éŒ²éŸ³çµ‚äº†æ—¥ã¨ã™ã‚‹
                endDateCalc = '\`date -d yesterday +\\%Y\\%m\\%d\`';
            } else {
                // cronå®Ÿè¡Œæ—¥ã¨åŒã˜æ—¥ã‚’éŒ²éŸ³çµ‚äº†æ—¥ã¨ã™ã‚‹
                endDateCalc = '\`date +\\%Y\\%m\\%d\`';
            }

            // cronã‚³ãƒãƒ³ãƒ‰ï¼ˆå‹•çš„ãªæ—¥ä»˜ã‚’ä½¿ç”¨ï¼‰
            const command = `${minute} ${hour} * * ${dayOfWeek} ${scriptPath} "${prog.title}" "${prog.stationId}" "${prog.stationId}" "${startDateCalc}${startHHMM}" "${endDateCalc}${endHHMM}" "" "" "" >> /tmp/myradiko_output.log 2>&1`;

            currentCommand = command;
            currentProgramData = prog; // ãƒ—ãƒ­ã‚°ãƒ©ãƒ æƒ…å ±ã‚’ä¿å­˜
            document.getElementById('modalTitle').textContent = `å®šæœŸéŒ²éŸ³ - ${prog.title}`;

            // å®Ÿè¡Œæ™‚åˆ»ã®èª¬æ˜ã‚’è¿½åŠ 
            const execTimeStr = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
            const daysOfWeekJp = ['æ—¥æ›œæ—¥', 'æœˆæ›œæ—¥', 'ç«æ›œæ—¥', 'æ°´æ›œæ—¥', 'æœ¨æ›œæ—¥', 'é‡‘æ›œæ—¥', 'åœŸæ›œæ—¥'];
            const dayLabel = daysOfWeekJp[dayOfWeek];

            const commandBoxContent = `
                <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 12px; margin-bottom: 15px; border-radius: 4px;">
                    <div style="font-weight: 600; color: #1976d2; margin-bottom: 4px;">â° å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°</div>
                    <div style="color: #555; font-size: 0.95em;">æ¯é€±${dayLabel} ${execTimeStr} ã«å®Ÿè¡Œï¼ˆç•ªçµ„çµ‚äº†ã®5åˆ†å¾Œï¼‰</div>
                </div>
                <div style="font-family: 'Courier New', monospace; background: #f8f9fa; padding: 12px; border-radius: 4px; font-size: 0.9em; white-space: pre-wrap; word-break: break-all;">${command}</div>
            `;

            document.getElementById('commandBox').innerHTML = commandBoxContent;
            document.getElementById('executeBtn').style.display = 'none';

            // cronç™»éŒ²ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            const registerBtn = document.getElementById('registerCronBtn');
            if (registerBtn) {
                registerBtn.style.display = 'inline-block';
                registerBtn.onclick = () => addCronJob(command);
            }

            document.getElementById('modal').classList.add('active');
        }

        async function showDownloadCommand(prog) {
            const scriptPath = document.getElementById('scriptPath').value;
            const endTime = new Date(prog.to);
            endTime.setMinutes(endTime.getMinutes() + 5);

            const startStr = formatRadikoTime(new Date(prog.ft));
            const endStr = formatRadikoTime(endTime);

            const command = `${scriptPath} -s ${startStr} -e ${endStr} -i ${prog.stationId}`;

            currentCommand = command;
            currentProgramData = prog; // å®Ÿè¡Œç”¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            document.getElementById('modalTitle').textContent = `ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ - ${prog.title}`;

            // ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
            const fileCheck = await checkFileExists(prog);

            let commandBoxContent = command;

            if (fileCheck && fileCheck.exists) {
                const proxyUrl = document.getElementById('proxyUrl').value;
                const baseUrl = proxyUrl.trim() || '';
                const downloadUrl = `${baseUrl}/download/${fileCheck.path}`;

                commandBoxContent = `
                    <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <div style="color: #856404; font-weight: bold; margin-bottom: 8px; font-size: 1.1em;">âš ï¸ ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ—¢ã«éŒ²éŸ³æ¸ˆã¿ã§ã™</div>
                        <div style="color: #856404; font-size: 0.9em; margin-bottom: 10px;">ãƒ•ã‚¡ã‚¤ãƒ«å: ${fileCheck.filename}</div>
                        <a href="${downloadUrl}" download="${fileCheck.filename}"
                           style="display: inline-block; padding: 8px 16px; background: #667eea; color: white; text-decoration: none; border-radius: 4px; font-weight: 600; font-size: 0.9em;">
                            ğŸ“¥ æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                        </a>
                    </div>
                    <div style="font-family: 'Courier New', monospace; background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 0.9em; color: #6c757d;">
                        ${command}
                    </div>
                    <div style="margin-top: 10px; font-size: 0.85em; color: #856404;">
                        â€» ã€Œå®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™
                    </div>
                `;
            } else {
                // ç•ªçµ„æƒ…å ±ã‚’è¦‹ã‚„ã™ãè¡¨ç¤º
                const startTime = new Date(prog.ft);
                const endTime = new Date(prog.to);

                const startDateStr = `${startTime.getFullYear()}/${String(startTime.getMonth() + 1).padStart(2, '0')}/${String(startTime.getDate()).padStart(2, '0')}`;
                const startTimeStr = `${String(startTime.getHours()).padStart(2, '0')}:${String(startTime.getMinutes()).padStart(2, '0')}`;
                const endTimeStr = `${String(endTime.getHours()).padStart(2, '0')}:${String(endTime.getMinutes()).padStart(2, '0')}`;

                const durationMinutes = Math.floor((endTime - startTime) / 60000);
                const durationHours = Math.floor(durationMinutes / 60);
                const durationMins = durationMinutes % 60;
                const durationStr = durationHours > 0 ? `${durationHours}æ™‚é–“${durationMins}åˆ†` : `${durationMins}åˆ†`;

                commandBoxContent = `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 20px; margin-bottom: 15px; color: white;">
                        <div style="font-size: 1.3em; font-weight: 700; margin-bottom: 10px; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                            ğŸ“» ${prog.title}
                        </div>
                        <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px 15px; font-size: 0.95em; line-height: 1.6;">
                            <div style="opacity: 0.9;">æ”¾é€å±€:</div>
                            <div style="font-weight: 600;">${prog.stationName || prog.stationId}</div>

                            <div style="opacity: 0.9;">æ”¾é€æ—¥:</div>
                            <div style="font-weight: 600;">${startDateStr}</div>

                            <div style="opacity: 0.9;">æ™‚é–“:</div>
                            <div style="font-weight: 600;">${startTimeStr} ã€œ ${endTimeStr} ï¼ˆ${durationStr}ï¼‰</div>
                        </div>
                    </div>

                    <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; border: 1px solid #e9ecef;">
                        <div style="color: #6c757d; font-size: 0.85em; margin-bottom: 8px; font-weight: 600;">ğŸ“ éŒ²éŸ³ã‚³ãƒãƒ³ãƒ‰</div>
                        <details>
                            <summary style="cursor: pointer; color: #667eea; font-size: 0.9em; user-select: none;">
                                ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¡¨ç¤º
                            </summary>
                            <div style="font-family: 'Courier New', monospace; background: #ffffff; padding: 12px; border-radius: 4px; font-size: 0.85em; margin-top: 10px; border: 1px solid #dee2e6; word-break: break-all; color: #495057;">
                                ${command}
                            </div>
                        </details>
                    </div>

                    <div style="background: #e7f3ff; border-left: 4px solid #2196f3; padding: 12px; margin-top: 15px; border-radius: 4px;">
                        <div style="color: #1976d2; font-size: 0.9em; display: flex; align-items: center; gap: 8px;">
                            <span>ğŸ’¡</span>
                            <span>ã€Œå®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ã“ã®ç•ªçµ„ã®éŒ²éŸ³ã‚’ã™ãã«é–‹å§‹ã—ã¾ã™</span>
                        </div>
                    </div>
                `;
            }

            document.getElementById('commandBox').innerHTML = commandBoxContent;
            document.getElementById('executeBtn').style.display = 'inline-block';
            document.getElementById('modal').classList.add('active');
        }

        async function showAtCommand(prog) {
            const scriptPath = document.getElementById('scriptPath').value;
            const startTime = new Date(prog.ft);
            const endTime = new Date(prog.to);

            // atå®Ÿè¡Œæ™‚åˆ»ï¼ˆç•ªçµ„çµ‚äº†ã®5åˆ†å¾Œï¼‰
            const atExecTime = new Date(prog.to);
            atExecTime.setMinutes(atExecTime.getMinutes() + 5);

            // é–‹å§‹æ™‚åˆ»ã¨çµ‚äº†æ™‚åˆ»ï¼ˆYYYYMMDDHHmmå½¢å¼ï¼‰
            const startStr = formatRadikoTime(startTime);
            const endStr = formatRadikoTime(endTime);

            // atå®Ÿè¡Œæ™‚åˆ»
            const atTime = `${String(atExecTime.getHours()).padStart(2, '0')}:${String(atExecTime.getMinutes()).padStart(2, '0')} ${atExecTime.getFullYear()}-${String(atExecTime.getMonth() + 1).padStart(2, '0')}-${String(atExecTime.getDate()).padStart(2, '0')}`;

            // cronã¨åŒã˜å½¢å¼ã®ã‚³ãƒãƒ³ãƒ‰
            const command = `echo '${scriptPath} "${prog.title}" "${prog.stationId}" "${prog.stationId}" "${startStr}" "${endStr}" "" "" "" >> /tmp/myradiko_output.log 2>&1' | at ${atTime}`;

            currentCommand = command;
            currentProgramData = prog; // å®Ÿè¡Œç”¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            document.getElementById('modalTitle').textContent = `äºˆç´„ - ${prog.title}`;

            // ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
            const fileCheck = await checkFileExists(prog);

            let commandBoxContent = command;

            if (fileCheck && fileCheck.exists) {
                const proxyUrl = document.getElementById('proxyUrl').value;
                const baseUrl = proxyUrl.trim() || '';
                const downloadUrl = `${baseUrl}/download/${fileCheck.path}`;

                commandBoxContent = `
                    <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <div style="color: #856404; font-weight: bold; margin-bottom: 8px; font-size: 1.1em;">âš ï¸ ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ—¢ã«éŒ²éŸ³æ¸ˆã¿ã§ã™</div>
                        <div style="color: #856404; font-size: 0.9em; margin-bottom: 10px;">ãƒ•ã‚¡ã‚¤ãƒ«å: ${fileCheck.filename}</div>
                        <a href="${downloadUrl}" download="${fileCheck.filename}"
                           style="display: inline-block; padding: 8px 16px; background: #667eea; color: white; text-decoration: none; border-radius: 4px; font-weight: 600; font-size: 0.9em;">
                            ğŸ“¥ æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                        </a>
                    </div>
                    <div style="font-family: 'Courier New', monospace; background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 0.9em; color: #6c757d;">
                        ${command}
                    </div>
                    <div style="margin-top: 10px; font-size: 0.85em; color: #856404;">
                        â€» ã€Œå®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™
                    </div>
                `;
            } else {
                // å®Ÿè¡Œäºˆå®šæ™‚åˆ»ã‚’è¡¨ç¤º
                const execTimeStr = `${String(atExecTime.getHours()).padStart(2, '0')}:${String(atExecTime.getMinutes()).padStart(2, '0')}`;
                const execDateStr = `${atExecTime.getFullYear()}/${atExecTime.getMonth() + 1}/${atExecTime.getDate()}`;

                commandBoxContent = `
                    <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 12px; margin-bottom: 15px; border-radius: 4px;">
                        <div style="font-weight: 600; color: #1976d2; margin-bottom: 4px;">â° å®Ÿè¡Œäºˆå®šæ™‚åˆ»</div>
                        <div style="color: #555; font-size: 0.95em;">${execDateStr} ${execTimeStr}ï¼ˆç•ªçµ„çµ‚äº†ã®5åˆ†å¾Œï¼‰</div>
                    </div>
                    <div style="font-family: 'Courier New', monospace; background: #f8f9fa; padding: 12px; border-radius: 4px; font-size: 0.9em; white-space: pre-wrap; word-break: break-all;">${command}</div>
                `;
            }

            document.getElementById('commandBox').innerHTML = commandBoxContent;
            document.getElementById('executeBtn').style.display = 'inline-block';
            document.getElementById('modal').classList.add('active');
        }

        function formatRadikoTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hour = String(date.getHours()).padStart(2, '0');
            const minute = String(date.getMinutes()).padStart(2, '0');
            // rec_radiko_ts.shã¯12æ¡ï¼ˆç§’ãªã—ï¼‰ã‚’æœŸå¾…
            return `${year}${month}${day}${hour}${minute}`;
        }

        function formatRadikoUrl(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hour = String(date.getHours()).padStart(2, '0');
            const minute = String(date.getMinutes()).padStart(2, '0');
            const second = String(date.getSeconds()).padStart(2, '0');
            // radikoã®URLã¯14æ¡ï¼ˆç§’ã¾ã§å«ã‚€ï¼‰ã‚’æœŸå¾…
            return `${year}${month}${day}${hour}${minute}${second}`;
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            document.getElementById('registerCronBtn').style.display = 'none';
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
        }

        async function executeCommand() {
            if (!currentProgramData) {
                alert('å®Ÿè¡Œå¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            const prog = currentProgramData;

            // éŒ²éŸ³ã¯ç•ªçµ„é–‹å§‹ã‹ã‚‰çµ‚äº†ã¾ã§
            const startTime = new Date(prog.ft);
            const endTime = new Date(prog.to);
            const startStr = formatRadikoTime(startTime);
            const endStr = formatRadikoTime(endTime);

            // atå®Ÿè¡Œæ™‚åˆ»ã¯ç•ªçµ„çµ‚äº†ã®5åˆ†å¾Œ
            const atExecTime = new Date(prog.to);
            atExecTime.setMinutes(atExecTime.getMinutes() + 5);

            // currentCommandã‹ã‚‰atäºˆç´„ã‹ã©ã†ã‹ã‚’åˆ¤å®š
            const isAtCommand = currentCommand.includes('| at ');

            const executeBtn = document.getElementById('executeBtn');
            executeBtn.disabled = true;
            executeBtn.textContent = 'å®Ÿè¡Œä¸­...';

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            // atäºˆç´„ã®å ´åˆ
            if (isAtCommand) {
                const scriptPath = document.getElementById('scriptPath').value;
                const atTime = `${String(atExecTime.getHours()).padStart(2, '0')}:${String(atExecTime.getMinutes()).padStart(2, '0')} ${atExecTime.getFullYear()}-${String(atExecTime.getMonth() + 1).padStart(2, '0')}-${String(atExecTime.getDate()).padStart(2, '0')}`;

                try {
                    const response = await fetch(`${baseUrl}/schedule-at`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            script_path: scriptPath,
                            title: prog.title,
                            start_time: startStr,
                            end_time: endStr,
                            station_id: prog.stationId,
                            at_time: atTime
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        alert(`âœ… atäºˆç´„ã‚’ç™»éŒ²ã—ã¾ã—ãŸ\n\nå®Ÿè¡Œäºˆå®š: ${atTime}\n\n${data.output || ''}`);
                        closeModal();
                    } else {
                        alert(`âŒ atäºˆç´„ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ\n\n${data.error || 'Unknown error'}`);
                    }
                } catch (err) {
                    console.error('at schedule error:', err);
                    alert(`âŒ atäºˆç´„ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ\n\n${err.message}`);
                } finally {
                    executeBtn.disabled = false;
                    executeBtn.textContent = 'å®Ÿè¡Œ';
                }
                return;
            }

            // å³æ™‚å®Ÿè¡Œï¼ˆDLï¼‰ã®å ´åˆ
            const commandBox = document.getElementById('commandBox');
            commandBox.innerHTML = `
                <div style="background: #ffffff; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; margin-top: 15px;">
                    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                        <div id="statusIcon" style="font-size: 2em;">â³</div>
                        <div style="flex: 1;">
                            <div id="statusTitle" style="font-weight: 600; font-size: 1.1em; color: #212529; margin-bottom: 5px;">éŒ²éŸ³ã‚’æº–å‚™ä¸­...</div>
                            <div id="statusMessage" style="color: #6c757d; font-size: 0.9em;">myradikoã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™</div>
                        </div>
                    </div>

                    <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
                    <div style="background: #e9ecef; height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 15px;">
                        <div id="progressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s;"></div>
                    </div>

                    <!-- è©³ç´°ãƒ­ã‚°ï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¯èƒ½ï¼‰ -->
                    <details style="margin-top: 15px;">
                        <summary style="cursor: pointer; padding: 8px; background: #f8f9fa; border-radius: 4px; font-weight: 600; user-select: none; color: #495057;">
                            ğŸ“‹ è©³ç´°ãƒ­ã‚°ã‚’è¡¨ç¤º
                        </summary>
                        <div style="background: #212529; color: #e9ecef; padding: 15px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 0.85em; max-height: 300px; overflow-y: auto; margin-top: 10px; line-height: 1.6;" id="logContent"></div>
                    </details>
                </div>
            `;

            // éŒ²éŸ³æ™‚é–“ã‚’è¨ˆç®—ï¼ˆç§’å˜ä½ï¼‰
            const totalDurationSeconds = Math.floor((endTime - startTime) / 1000);
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦ä¿å­˜
            window.recordingTotalDuration = totalDurationSeconds;

            // POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã§å®Ÿè¡Œ
            const response = await fetch(`${baseUrl}/execute`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    title: prog.title,
                    rss: prog.stationId,
                    station: prog.stationId,
                    start_time: startStr,
                    end_time: endStr
                })
            });

            if (!response.ok) {
                addLog('error', `ã‚¨ãƒ©ãƒ¼: ${response.statusText}`);
                executeBtn.disabled = false;
                executeBtn.textContent = 'å®Ÿè¡Œ';
                return;
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = JSON.parse(line.substring(6));
                        addLog(data.type, data.message, data.file);

                        if (data.type === 'success' || data.type === 'error') {
                            executeBtn.disabled = false;
                            executeBtn.textContent = 'å®Ÿè¡Œ';

                            // æˆåŠŸæ™‚ã¯ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’æ›´æ–°
                            if (data.type === 'success') {
                                setTimeout(() => loadRecordedFiles(), 1000);
                            }
                        }
                    }
                }
            }
        }

        function addLog(type, message, file) {
            const logContent = document.getElementById('logContent');
            const statusIcon = document.getElementById('statusIcon');
            const statusTitle = document.getElementById('statusTitle');
            const statusMessage = document.getElementById('statusMessage');
            const progressBar = document.getElementById('progressBar');

            // ffmpegã®time=ã‚’è§£æã—ã¦é€²æ—ã‚’è¨ˆç®—
            const timeMatch = message.match(/time=(\d{2}):(\d{2}):(\d{2}\.\d+)/);
            if (timeMatch && window.recordingTotalDuration) {
                const hours = parseInt(timeMatch[1]);
                const minutes = parseInt(timeMatch[2]);
                const seconds = parseFloat(timeMatch[3]);
                const currentSeconds = hours * 3600 + minutes * 60 + seconds;

                // é€²æ—ç‡ã‚’è¨ˆç®—ï¼ˆ0-100%ï¼‰
                const progressPercent = Math.min(100, Math.round((currentSeconds / window.recordingTotalDuration) * 100));

                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’æ›´æ–°
                if (progressBar) {
                    progressBar.style.width = `${progressPercent}%`;
                }

                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
                if (statusTitle) statusTitle.textContent = 'éŒ²éŸ³ä¸­...';
                if (statusMessage) {
                    const remainingSeconds = Math.max(0, window.recordingTotalDuration - currentSeconds);
                    const remainingMinutes = Math.floor(remainingSeconds / 60);
                    const remainingSecondsOnly = Math.floor(remainingSeconds % 60);
                    statusMessage.textContent = `é€²æ—: ${progressPercent}% (æ®‹ã‚Šç´„${remainingMinutes}åˆ†${remainingSecondsOnly}ç§’)`;
                }
            }

            // è©³ç´°ãƒ­ã‚°ã«è¿½åŠ 
            if (logContent) {
                const logLine = document.createElement('div');
                logLine.style.marginBottom = '4px';

                if (type === 'error') {
                    logLine.style.color = '#f48771';
                } else if (type === 'success') {
                    logLine.style.color = '#4ec9b0';
                } else {
                    logLine.style.color = '#d4d4d4';
                }

                logLine.textContent = message;
                logContent.appendChild(logLine);

                // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                logContent.scrollTop = logContent.scrollHeight;
            }

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’æ›´æ–°
            if (type === 'info') {
                if (statusIcon) statusIcon.textContent = 'â³';
                // time=ãŒã‚ã‚‹å ´åˆã¯ä¸Šã§æ—¢ã«æ›´æ–°ã•ã‚Œã¦ã„ã‚‹ã®ã§ã‚¹ã‚­ãƒƒãƒ—
                if (!timeMatch) {
                    if (statusTitle) statusTitle.textContent = 'éŒ²éŸ³ä¸­...';
                    if (statusMessage) statusMessage.textContent = message;
                    if (progressBar) progressBar.style.width = '10%';
                }
            } else if (type === 'success') {
                if (statusIcon) statusIcon.textContent = 'âœ…';
                if (statusTitle) statusTitle.textContent = 'éŒ²éŸ³å®Œäº†ï¼';
                if (statusMessage) statusMessage.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸ';
                if (progressBar) {
                    progressBar.style.width = '100%';
                    progressBar.style.background = 'linear-gradient(90deg, #4caf50, #45a049)';
                }
            } else if (type === 'error') {
                if (statusIcon) statusIcon.textContent = 'âŒ';
                if (statusTitle) statusTitle.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                if (statusMessage) statusMessage.textContent = message;
                if (progressBar) {
                    progressBar.style.background = 'linear-gradient(90deg, #e57373, #ef5350)';
                }
            }

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ï¼ˆæˆåŠŸæ™‚ï¼‰
            if (file && type === 'success') {
                const proxyUrl = document.getElementById('proxyUrl').value;
                const baseUrl = proxyUrl.trim() || '';
                const downloadUrl = `${baseUrl}/download/${file}`;
                const filename = file.split('/').pop();

                // commandBoxã®ä¸­ã«å¤§ããªãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
                const commandBox = document.getElementById('commandBox');
                const downloadSection = document.createElement('div');
                downloadSection.style.marginTop = '15px';
                downloadSection.style.padding = '20px';
                downloadSection.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                downloadSection.style.borderRadius = '8px';
                downloadSection.style.textAlign = 'center';
                downloadSection.innerHTML = `
                    <div style="color: white; font-size: 1.1em; font-weight: 600; margin-bottom: 10px;">
                        ğŸ‰ éŒ²éŸ³ãŒå®Œäº†ã—ã¾ã—ãŸï¼
                    </div>
                    <div style="color: rgba(255,255,255,0.9); font-size: 0.9em; margin-bottom: 15px;">
                        ãƒ•ã‚¡ã‚¤ãƒ«: ${filename.replace(/\.(mp3|m4a|aac|wav)$/i, '')}
                    </div>
                    <a href="${downloadUrl}" download="${filename}"
                       style="display: inline-block; padding: 12px 24px; background: white; color: #667eea; text-decoration: none; font-weight: 600; border-radius: 6px; font-size: 1em; cursor: pointer; transition: all 0.2s;"
                       onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';"
                       onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                        ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </a>
                `;
                commandBox.querySelector('div').appendChild(downloadSection);
            }
        }

        async function copyCommand(event) {
            try {
                await navigator.clipboard.writeText(currentCommand);
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
                btn.style.background = '#28a745';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            } catch (err) {
                alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
            }
        }

        async function searchAllAreas() {
            const searchKeyword = document.getElementById('searchKeyword').value.trim();
            const proxyUrl = document.getElementById('proxyUrl').value;

            if (!searchKeyword) {
                showError('æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const programList = document.getElementById('programList');
            const fetchBtn = document.getElementById('fetchBtn');
            const searchAllBtn = document.getElementById('searchAllBtn');

            loading.style.display = 'block';
            loading.querySelector('p').textContent = 'æ¤œç´¢ä¸­...';
            error.style.display = 'none';
            programList.innerHTML = '';
            fetchBtn.disabled = true;
            searchAllBtn.disabled = true;

            try {
                // ã‚µãƒ¼ãƒãƒ¼å´DBæ¤œç´¢APIã‚’å‘¼ã³å‡ºã™
                // proxyUrlãŒ'/api'ã®å ´åˆã€'/api/programs/search'ã«ãªã‚‹
                // proxyUrlãŒç©ºã®å ´åˆã€'/api/programs/search'ã«ãªã‚‹
                const baseApiUrl = proxyUrl.trim() || '';
                const searchUrl = `${baseApiUrl}/api/programs/search?keyword=${encodeURIComponent(searchKeyword)}`;

                console.log('ğŸ” Searching via API:', searchUrl);

                const response = await fetch(searchUrl);

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Unknown error');
                }

                console.log(`âœ… Found ${data.count} programs from API`);

                // APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å½¢å¼ã‚’ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å½¢å¼ã«å¤‰æ›
                const allPrograms = data.programs.map(prog => ({
                    areaId: prog.areaId,
                    stationId: prog.stationId,
                    stationName: prog.stationName,
                    title: prog.title,
                    ft: new Date(prog.ft),
                    to: new Date(prog.to),
                    desc: prog.desc || 'èª¬æ˜ãªã—',
                    pfm: prog.pfm || '',
                    info: prog.info || '',
                    url: prog.url || ''
                }));

                if (allPrograms.length === 0) {
                    showError(`ã€Œ${searchKeyword}ã€ã«ä¸€è‡´ã™ã‚‹ç•ªçµ„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`);
                } else {
                    // é‡è¤‡ã‚’é™¤å»ï¼ˆåŒã˜æ”¾é€å±€IDã¨é–‹å§‹æ™‚åˆ»ã®çµ„ã¿åˆã‚ã›ï¼‰
                    const uniquePrograms = [];
                    const seen = new Set();

                    allPrograms.forEach(prog => {
                        const key = `${prog.stationId}_${prog.ft.getTime()}`;
                        if (!seen.has(key)) {
                            seen.add(key);
                            uniquePrograms.push(prog);
                        }
                    });

                    uniquePrograms.sort((a, b) => a.ft - b.ft);
                    displayPrograms(uniquePrograms);
                }

            } catch (err) {
                showError(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${err.message}`);
                fetchBtn.disabled = false;
                searchAllBtn.disabled = false;
            } finally {
                loading.style.display = 'none';
                loading.querySelector('p').textContent = 'ç•ªçµ„è¡¨ã‚’èª­ã¿è¾¼ã¿ä¸­...';
                // æ¤œç´¢çµæœè¡¨ç¤ºä¸­ã¯fetchBtnã‚’ç„¡åŠ¹åŒ–ã—ãŸã¾ã¾ï¼ˆé€šå¸¸ã®ç•ªçµ„è¡¨å–å¾—æ™‚ã«æœ‰åŠ¹åŒ–ã•ã‚Œã‚‹ï¼‰
                searchAllBtn.disabled = false;
            }
        }

        function showError(message) {
            const error = document.getElementById('error');
            error.textContent = message;
            error.style.display = 'block';
        }

        // éŒ²éŸ³æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
        let allRecordedFiles = [];
        let currentSort = { column: 'modified', direction: 'desc' };
        let currentPage = 1;
        const itemsPerPage = 50;
        let filterText = '';

        // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰æ”¾é€æ—¥ã‚’æŠ½å‡ºã™ã‚‹é–¢æ•°
        function extractBroadcastDate(filename) {
            // ãƒ‘ã‚¿ãƒ¼ãƒ³1: YYYY.MM.DD å½¢å¼ï¼ˆä¾‹: 2025.10.26ï¼‰
            let match = filename.match(/(\d{4})\.(\d{2})\.(\d{2})/);
            if (match) {
                return `${match[1]}-${match[2]}-${match[3]}`;
            }

            // ãƒ‘ã‚¿ãƒ¼ãƒ³2: YYYYMMDD å½¢å¼ï¼ˆä¾‹: 20251026ï¼‰
            match = filename.match(/(\d{4})(\d{2})(\d{2})/);
            if (match) {
                return `${match[1]}-${match[2]}-${match[3]}`;
            }

            // ãƒ‘ã‚¿ãƒ¼ãƒ³3: YYYY-MM-DD å½¢å¼ï¼ˆä¾‹: 2025-10-26ï¼‰
            match = filename.match(/(\d{4})-(\d{2})-(\d{2})/);
            if (match) {
                return `${match[1]}-${match[2]}-${match[3]}`;
            }

            return null; // æ—¥ä»˜ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
        }

        async function loadRecordedFiles() {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            const filesLoading = document.getElementById('filesLoading');
            const filesList = document.getElementById('filesList');

            filesLoading.style.display = 'block';
            filesList.innerHTML = '';

            try {
                const response = await fetch(`${baseUrl}/files`);
                if (!response.ok) {
                    console.error('Failed to load recorded files:', response.statusText);
                    filesLoading.style.display = 'none';
                    filesList.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 40px; font-size: 0.95em;">ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
                    return;
                }

                const data = await response.json();
                allRecordedFiles = data.files || [];

                filesLoading.style.display = 'none';

                if (allRecordedFiles.length === 0) {
                    filesList.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px;">
                            <div style="font-size: 3em; margin-bottom: 15px;">ğŸ“­</div>
                            <div style="color: #6c757d; font-size: 1.1em; font-weight: 500;">éŒ²éŸ³æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“</div>
                            <div style="color: #adb5bd; font-size: 0.9em; margin-top: 8px;">ç•ªçµ„ã‚’éŒ²éŸ³ã™ã‚‹ã¨ã€ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
                        </div>
                    `;
                    return;
                }

                currentPage = 1;
                renderFilesList();

            } catch (err) {
                console.error('Error loading recorded files:', err);
                filesLoading.style.display = 'none';
                filesList.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 40px; font-size: 0.95em;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
            }
        }

        function renderFilesList() {
            const filesList = document.getElementById('filesList');
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let filteredFiles = allRecordedFiles.filter(file => {
                if (!filterText) return true;
                return file.name.toLowerCase().includes(filterText.toLowerCase());
            });

            // ã‚½ãƒ¼ãƒˆ
            filteredFiles.sort((a, b) => {
                let valA, valB;
                if (currentSort.column === 'name') {
                    valA = a.name;
                    valB = b.name;
                } else if (currentSort.column === 'size') {
                    valA = a.size;
                    valB = b.size;
                } else if (currentSort.column === 'modified') {
                    valA = a.modified;
                    valB = b.modified;
                } else if (currentSort.column === 'broadcast') {
                    // æ”¾é€æ—¥ã§ã‚½ãƒ¼ãƒˆ
                    const dateA = extractBroadcastDate(a.name);
                    const dateB = extractBroadcastDate(b.name);
                    // æ—¥ä»˜ãŒãªã„å ´åˆã¯æœ€å¾Œã«ã‚½ãƒ¼ãƒˆ
                    if (!dateA && !dateB) return 0;
                    if (!dateA) return 1;
                    if (!dateB) return -1;
                    valA = dateA;
                    valB = dateB;
                }

                if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
            const totalPages = Math.ceil(filteredFiles.length / itemsPerPage);
            const startIdx = (currentPage - 1) * itemsPerPage;
            const endIdx = startIdx + itemsPerPage;
            const pageFiles = filteredFiles.slice(startIdx, endIdx);

            const totalSize = (filteredFiles.reduce((sum, f) => sum + f.size, 0) / 1024 / 1024 / 1024).toFixed(2);

            let html = `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 10px;">
                        <input type="text" id="fileFilter" placeholder="ğŸ” ãƒ•ã‚¡ã‚¤ãƒ«åã§æ¤œç´¢..." value="${filterText}"
                               oninput="filterText = this.value; currentPage = 1; renderFilesList();"
                               style="flex: 1; min-width: 200px; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 0.9em;">
                        <button onclick="clearAllBookmarks()"
                                style="padding: 8px 12px; background: #f57c00; color: white; border: none; border-radius: 6px; font-size: 0.85em; cursor: pointer; transition: all 0.2s; white-space: nowrap;"
                                onmouseover="this.style.background='#ef6c00'" onmouseout="this.style.background='#f57c00'">
                            ğŸ—‘ï¸ å†ç”Ÿå±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ
                        </button>
                        <div style="padding: 8px 12px; background: #f8f9fa; border-radius: 6px; font-size: 0.85em; color: #495057;">
                            <strong>${filteredFiles.length}</strong>ä»¶ / ${totalSize} GB
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 0.9em;">
                            <input type="checkbox" id="selectAllFiles" onchange="toggleSelectAll(this.checked)"
                                   style="width: 16px; height: 16px; cursor: pointer;">
                            <span>ã™ã¹ã¦é¸æŠ</span>
                        </label>
                        <button id="deleteSelectedBtn" onclick="deleteSelectedFiles()" disabled
                                style="padding: 8px 16px; background: #e57373; color: white; border: none; border-radius: 6px; font-size: 0.85em; cursor: pointer; transition: all 0.2s; white-space: nowrap;"
                                onmouseover="if(!this.disabled) this.style.background='#ef5350'" onmouseout="if(!this.disabled) this.style.background='#e57373'">
                            ğŸ—‘ï¸ é¸æŠã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
                        </button>
                        <button id="downloadSelectedBtn" onclick="downloadSelectedFiles()" disabled
                                style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; font-size: 0.85em; cursor: pointer; transition: all 0.2s; white-space: nowrap;"
                                onmouseover="if(!this.disabled) this.style.background='#5568d3'" onmouseout="if(!this.disabled) this.style.background='#667eea'">
                            ğŸ“¦ é¸æŠã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                        </button>
                        <span id="selectedCount" style="padding: 8px 12px; background: #e3f2fd; border-radius: 6px; font-size: 0.85em; color: #1976d2; display: none;">
                            <strong id="selectedCountNum">0</strong>ä»¶é¸æŠä¸­
                        </span>
                    </div>
                </div>

                <div style="overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                        <thead>
                            <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                <th style="padding: 12px; text-align: center; width: 40px;"></th>
                                <th onclick="sortFiles('name')" style="padding: 12px; text-align: left; cursor: pointer; user-select: none; white-space: nowrap;"
                                    onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                                    ãƒ•ã‚¡ã‚¤ãƒ«å ${currentSort.column === 'name' ? (currentSort.direction === 'asc' ? 'â–²' : 'â–¼') : ''}
                                </th>
                                <th onclick="sortFiles('broadcast')" style="padding: 12px; text-align: center; cursor: pointer; user-select: none; white-space: nowrap; width: 120px;"
                                    onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                                    æ”¾é€æ—¥ ${currentSort.column === 'broadcast' ? (currentSort.direction === 'asc' ? 'â–²' : 'â–¼') : ''}
                                </th>
                                <th onclick="sortFiles('size')" style="padding: 12px; text-align: right; cursor: pointer; user-select: none; white-space: nowrap; width: 100px;"
                                    onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                                    ã‚µã‚¤ã‚º ${currentSort.column === 'size' ? (currentSort.direction === 'asc' ? 'â–²' : 'â–¼') : ''}
                                </th>
                                <th onclick="sortFiles('modified')" style="padding: 12px; text-align: center; cursor: pointer; user-select: none; white-space: nowrap; width: 140px;"
                                    onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                                    æ›´æ–°æ—¥æ™‚ ${currentSort.column === 'modified' ? (currentSort.direction === 'asc' ? 'â–²' : 'â–¼') : ''}
                                </th>
                                <th style="padding: 12px; text-align: center; width: 200px;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            pageFiles.forEach((file, idx) => {
                const fileSize = (file.size / 1024 / 1024).toFixed(1);
                const modDate = new Date(file.modified * 1000);
                const dateStr = `${modDate.getMonth() + 1}/${modDate.getDate()} ${String(modDate.getHours()).padStart(2, '0')}:${String(modDate.getMinutes()).padStart(2, '0')}`;

                // ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
                const bookmarkKey = `bookmark_${file.path}`;
                const savedTime = localStorage.getItem(bookmarkKey);
                const hasBookmark = savedTime !== null;
                let progressPercent = 0;
                let progressText = '';

                if (hasBookmark) {
                    const time = parseFloat(savedTime);
                    const minutes = Math.floor(time / 60);
                    const seconds = Math.floor(time % 60);
                    progressText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }

                html += `
                    <tr style="border-bottom: 1px solid #f0f0f0; transition: background 0.2s; cursor: pointer; ${hasBookmark ? 'background: #fff8e1;' : ''}"
                        onclick="toggleFileSelection('${file.path.replace(/'/g, "\\'")}')"
                        onmouseover="this.style.background='${hasBookmark ? '#fff3cd' : '#f8f9fa'}'" onmouseout="this.style.background='${hasBookmark ? '#fff8e1' : 'white'}'">
                        <td style="padding: 10px 12px; text-align: center;" onclick="event.stopPropagation()">
                            <input type="checkbox" class="file-checkbox" value="${file.path}" onchange="updateSelectedCount()"
                                   style="width: 16px; height: 16px; cursor: pointer;">
                        </td>
                        <td style="padding: 10px 12px;">
                            <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 800px;" title="${file.name}">
                                ${file.name.replace(/\.(mp3|m4a|aac|wav)$/i, '')}
                            </div>
                            ${hasBookmark ? `<div style="font-size: 0.75em; color: #f57c00; margin-top: 3px;">å†ç”Ÿä½ç½®: ${progressText}</div>` : ''}
                        </td>
                        <td style="padding: 10px 12px; text-align: center; color: #6c757d; font-size: 0.9em;">
                            ${extractBroadcastDate(file.name) || '<span style="color: #999;">ä¸æ˜</span>'}
                        </td>
                        <td style="padding: 10px 12px; text-align: right; color: #6c757d;">${fileSize} MB</td>
                        <td style="padding: 10px 12px; text-align: center; color: #6c757d; font-size: 0.85em;">${dateStr}</td>
                        <td style="padding: 10px 12px;" onclick="event.stopPropagation()">
                            <div style="display: flex; gap: 8px; justify-content: center; align-items: center;">
                                <button onclick='playAudio("${file.path.replace(/'/g, "\\'")}", "${file.name.replace(/'/g, "\\'")}")'
                                        title="${hasBookmark ? 'ç¶šãã‹ã‚‰å†ç”Ÿ' : 'å†ç”Ÿ'}"
                                        style="padding: 4px; background: transparent; border: none; cursor: pointer; transition: all 0.2s; opacity: 0.8;"
                                        onmouseover="this.style.opacity='1'; this.style.transform='scale(1.1)'" onmouseout="this.style.opacity='0.8'; this.style.transform='scale(1)'">
                                    <img src="img/play.png" alt="å†ç”Ÿ" style="width: 24px; height: 24px; display: block;">
                                </button>
                                <a href="${baseUrl}/download/${file.path}" download="${file.name}"
                                   title="ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"
                                   style="padding: 4px; background: transparent; text-decoration: none; display: inline-block; transition: all 0.2s; opacity: 0.8;"
                                   onmouseover="this.style.opacity='1'; this.style.transform='scale(1.1)'" onmouseout="this.style.opacity='0.8'; this.style.transform='scale(1)'">
                                    <img src="img/download.png" alt="ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰" style="width: 24px; height: 24px; display: block;">
                                </a>
                                <button onclick='deleteFile("${file.path.replace(/'/g, "\\'")}", "${file.name.replace(/'/g, "\\'")}")'
                                        title="å‰Šé™¤"
                                        style="padding: 4px; background: transparent; border: none; cursor: pointer; transition: all 0.2s; opacity: 0.8;"
                                        onmouseover="this.style.opacity='1'; this.style.transform='scale(1.1)'" onmouseout="this.style.opacity='0.8'; this.style.transform='scale(1)'">
                                    <img src="img/trash.png" alt="å‰Šé™¤" style="width: 24px; height: 24px; display: block;">
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
            if (totalPages > 1) {
                html += `
                    <div style="margin-top: 15px; display: flex; justify-content: center; align-items: center; gap: 8px; flex-wrap: wrap;">
                        <button onclick="currentPage = 1; renderFilesList();" ${currentPage === 1 ? 'disabled' : ''}
                                style="padding: 6px 12px; background: ${currentPage === 1 ? '#e9ecef' : '#667eea'}; color: ${currentPage === 1 ? '#6c757d' : 'white'}; border: none; border-radius: 4px; cursor: ${currentPage === 1 ? 'not-allowed' : 'pointer'};">
                            â‰ª
                        </button>
                        <button onclick="if(currentPage > 1) { currentPage--; renderFilesList(); }" ${currentPage === 1 ? 'disabled' : ''}
                                style="padding: 6px 12px; background: ${currentPage === 1 ? '#e9ecef' : '#667eea'}; color: ${currentPage === 1 ? '#6c757d' : 'white'}; border: none; border-radius: 4px; cursor: ${currentPage === 1 ? 'not-allowed' : 'pointer'};">
                            ï¼œ
                        </button>
                        <span style="padding: 6px 12px; color: #495057; font-size: 0.9em;">
                            ${currentPage} / ${totalPages}
                        </span>
                        <button onclick="if(currentPage < ${totalPages}) { currentPage++; renderFilesList(); }" ${currentPage === totalPages ? 'disabled' : ''}
                                style="padding: 6px 12px; background: ${currentPage === totalPages ? '#e9ecef' : '#667eea'}; color: ${currentPage === totalPages ? '#6c757d' : 'white'}; border: none; border-radius: 4px; cursor: ${currentPage === totalPages ? 'not-allowed' : 'pointer'};">
                            ï¼
                        </button>
                        <button onclick="currentPage = ${totalPages}; renderFilesList();" ${currentPage === totalPages ? 'disabled' : ''}
                                style="padding: 6px 12px; background: ${currentPage === totalPages ? '#e9ecef' : '#667eea'}; color: ${currentPage === totalPages ? '#6c757d' : 'white'}; border: none; border-radius: 4px; cursor: ${currentPage === totalPages ? 'not-allowed' : 'pointer'};">
                            â‰«
                        </button>
                    </div>
                `;
            }

            filesList.innerHTML = html;
        }

        function sortFiles(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = column === 'name' ? 'asc' : 'desc';
            }
            renderFilesList();
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
        async function checkFileExists(prog) {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            const startStr = formatRadikoTime(new Date(prog.ft));

            try {
                const response = await fetch(`${baseUrl}/check-file`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: prog.title,
                        rss: prog.stationId,
                        start_time: startStr
                    })
                });

                if (!response.ok) {
                    return null;
                }

                const data = await response.json();
                return data;
            } catch (err) {
                console.error('Error checking file:', err);
                return null;
            }
        }

        // cronå¼ã‚’äººé–“ãŒèª­ã‚ã‚‹å½¢å¼ã«å¤‰æ›
        function parseCronExpression(cronLine) {
            // cronã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰cronå¼éƒ¨åˆ†ã‚’æŠ½å‡º
            const parts = cronLine.trim().split(/\s+/);
            if (parts.length < 5) return { description: 'ç„¡åŠ¹ãªcronå¼', parts: null };

            const minute = parts[0];
            const hour = parts[1];
            const dayOfMonth = parts[2];
            const month = parts[3];
            const dayOfWeek = parts[4];

            const daysOfWeekJp = ['æ—¥æ›œæ—¥', 'æœˆæ›œæ—¥', 'ç«æ›œæ—¥', 'æ°´æ›œæ—¥', 'æœ¨æ›œæ—¥', 'é‡‘æ›œæ—¥', 'åœŸæ›œæ—¥'];

            let description = 'å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°: ';

            // æ›œæ—¥ã®è§£æ
            if (dayOfWeek !== '*') {
                const day = parseInt(dayOfWeek);
                description += `æ¯é€±${daysOfWeekJp[day]}ã® `;
            } else if (dayOfMonth !== '*') {
                description += `æ¯æœˆ${dayOfMonth}æ—¥ã® `;
            } else {
                description += 'æ¯æ—¥ ';
            }

            // æ™‚åˆ»ã®è§£æ
            if (hour === '*' && minute === '*') {
                description += 'æ¯æ™‚æ¯åˆ†';
            } else if (hour === '*') {
                description += `æ¯æ™‚${minute}åˆ†`;
            } else if (minute === '*') {
                description += `${hour}æ™‚å°ã®æ¯åˆ†`;
            } else {
                description += `${hour}:${minute.padStart(2, '0')}`;
            }

            return {
                description,
                parts: { minute, hour, dayOfMonth, month, dayOfWeek }
            };
        }

        // cronä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
        async function loadCronJobs() {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            const cronLoading = document.getElementById('cronLoading');
            const cronList = document.getElementById('cronList');

            cronLoading.style.display = 'block';
            cronList.innerHTML = '';

            try {
                const response = await fetch(`${baseUrl}/cron/list`);
                if (!response.ok) {
                    cronLoading.style.display = 'none';
                    cronList.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 40px; font-size: 0.95em;">cronä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
                    return;
                }

                const data = await response.json();
                const cronJobs = data.cron_jobs || [];

                // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
                currentCronJobs = cronJobs;

                cronLoading.style.display = 'none';

                if (cronJobs.length === 0) {
                    cronList.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px;">
                            <div style="font-size: 3em; margin-bottom: 15px;">â°</div>
                            <div style="color: #6c757d; font-size: 1.1em; font-weight: 500;">ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹cronã‚¸ãƒ§ãƒ–ã¯ã‚ã‚Šã¾ã›ã‚“</div>
                            <div style="color: #adb5bd; font-size: 0.9em; margin-top: 8px;">ç•ªçµ„ã®cronã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
                        </div>
                    `;
                    return;
                }

                let html = `
                    <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 0.9em; color: #495057;">
                            <strong>${cronJobs.length}ä»¶</strong>ã®äºˆç´„
                        </div>
                        <button onclick="loadCronLogs()" style="padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; font-size: 0.85em; cursor: pointer;">
                            ğŸ“‹ ãƒ­ã‚°ã‚’è¡¨ç¤º
                        </button>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                `;

                cronJobs.forEach((job, index) => {
                    // cronã®å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°æƒ…å ±ã‚’ä½œæˆ
                    const cronInfo = parseCronExpression(job.raw || job);

                    // ç•ªçµ„æƒ…å ±ã®è¡¨ç¤º
                    const title = job.title || 'ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜ï¼‰';
                    const station = job.station || '';
                    const startTime = job.startTime ? `${job.startTime.slice(0,2)}:${job.startTime.slice(2,4)}` : '';
                    const endTime = job.endTime ? `${job.endTime.slice(0,2)}:${job.endTime.slice(2,4)}` : '';
                    const timeRange = startTime && endTime ? `${startTime}-${endTime}` : '';

                    html += `
                        <div style="padding: 12px; background: white; border: 1px solid #dee2e6; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; gap: 12px;">
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 600; color: #212529; margin-bottom: 4px; font-size: 0.95em;">
                                    ${title}
                                </div>
                                <div style="display: flex; gap: 12px; flex-wrap: wrap; font-size: 0.8em; color: #6c757d;">
                                    ${station ? `<span>ğŸ¢ ${station}</span>` : ''}
                                    ${timeRange ? `<span>ğŸ“¡ ${timeRange}</span>` : ''}
                                    <span>â° ${cronInfo.description.replace('å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°: ', '')}</span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 6px; flex-shrink: 0;">
                                <button onclick='editCronJob(${index}, ${JSON.stringify(job).replace(/'/g, "\\'").replace(/"/g, "&quot;")})'
                                        style="padding: 8px 14px; background: #667eea; color: white; border: none; border-radius: 6px; font-size: 0.85em; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                                        onmouseover="this.style.background='#5568d3'"
                                        onmouseout="this.style.background='#667eea'"
                                        title="ç·¨é›†">
                                    ç·¨é›†
                                </button>
                                <button onclick='removeCronJobByIndex(${index})'
                                        style="padding: 8px 14px; background: #e57373; color: white; border: none; border-radius: 6px; font-size: 0.85em; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                                        onmouseover="this.style.background='#ef5350'"
                                        onmouseout="this.style.background='#e57373'"
                                        title="å‰Šé™¤">
                                    å‰Šé™¤
                                </button>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                cronList.innerHTML = html;

            } catch (err) {
                console.error('Error loading cron jobs:', err);
                cronLoading.style.display = 'none';
                cronList.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 40px; font-size: 0.95em;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
            }
        }

        // cronã‚¸ãƒ§ãƒ–ã‚’è¿½åŠ 
        async function addCronJob(command) {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                const response = await fetch(`${baseUrl}/cron/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ command: command })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('âœ… cronã‚¸ãƒ§ãƒ–ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                    closeModal();
                    // cronç®¡ç†ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆã¦ä¸€è¦§ã‚’æ›´æ–°
                    switchTab('cron');
                } else {
                    alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + (data.error || 'cronã‚¸ãƒ§ãƒ–ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ'));
                }
            } catch (err) {
                console.error('Error adding cron job:', err);
                alert('âŒ cronã‚¸ãƒ§ãƒ–ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«cronã‚¸ãƒ§ãƒ–ã‚’ä¿å­˜
        let currentCronJobs = [];

        // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§cronã‚¸ãƒ§ãƒ–ã‚’å‰Šé™¤
        async function removeCronJobByIndex(index) {
            const job = currentCronJobs[index];
            if (!job) {
                alert('âŒ cronã‚¸ãƒ§ãƒ–ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                return;
            }

            const title = job.title || 'ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜';
            if (!confirm(`ã“ã®äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\n${title}`)) {
                return;
            }

            await removeCronJob(job.raw);
        }

        // cronã‚¸ãƒ§ãƒ–ã‚’å‰Šé™¤
        async function removeCronJob(command) {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                const response = await fetch(`${baseUrl}/cron/remove`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ command: command })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('âœ… äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    loadCronJobs();
                } else {
                    alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + (data.error || 'äºˆç´„ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ'));
                }
            } catch (err) {
                console.error('Error removing cron job:', err);
                alert('âŒ äºˆç´„ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
        async function deleteFile(filepath, filename) {
            if (!confirm('ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\n' + filename)) {
                return;
            }

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                const response = await fetch(`${baseUrl}/file/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ path: filepath })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    loadRecordedFiles();
                } else {
                    alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + (data.error || 'ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ'));
                }
            } catch (err) {
                console.error('Error deleting file:', err);
                alert('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ã™ã¹ã¦é¸æŠ/è§£é™¤
        function toggleSelectAll(checked) {
            const checkboxes = document.querySelectorAll('.file-checkbox');
            checkboxes.forEach(cb => cb.checked = checked);
            updateSelectedCount();
        }

        // è¡Œã‚¯ãƒªãƒƒã‚¯ã§ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’åˆ‡ã‚Šæ›¿ãˆ
        function toggleFileSelection(path) {
            const checkbox = document.querySelector(`.file-checkbox[value="${path}"]`);
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                updateSelectedCount();
            }
        }

        // é¸æŠæ•°ã‚’æ›´æ–°
        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('.file-checkbox:checked');
            const count = checkboxes.length;

            const selectAllCheckbox = document.getElementById('selectAllFiles');
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            const downloadBtn = document.getElementById('downloadSelectedBtn');
            const countDisplay = document.getElementById('selectedCount');
            const countNum = document.getElementById('selectedCountNum');

            // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹åŒ–
            deleteBtn.disabled = count === 0;
            downloadBtn.disabled = count === 0;

            // ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
            if (count === 0) {
                deleteBtn.style.opacity = '0.5';
                deleteBtn.style.cursor = 'not-allowed';
                downloadBtn.style.opacity = '0.5';
                downloadBtn.style.cursor = 'not-allowed';
            } else {
                deleteBtn.style.opacity = '1';
                deleteBtn.style.cursor = 'pointer';
                downloadBtn.style.opacity = '1';
                downloadBtn.style.cursor = 'pointer';
            }

            // é¸æŠæ•°è¡¨ç¤º
            if (count > 0) {
                countDisplay.style.display = 'inline-block';
                countNum.textContent = count;
            } else {
                countDisplay.style.display = 'none';
            }

            // ã™ã¹ã¦é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹æ›´æ–°
            const allCheckboxes = document.querySelectorAll('.file-checkbox');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = allCheckboxes.length > 0 && count === allCheckboxes.length;
            }
        }

        // é¸æŠã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€æ‹¬å‰Šé™¤
        async function deleteSelectedFiles() {
            const checkboxes = document.querySelectorAll('.file-checkbox:checked');
            const paths = Array.from(checkboxes).map(cb => cb.value);

            if (paths.length === 0) {
                alert('å‰Šé™¤ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            if (!confirm(`é¸æŠã—ãŸ${paths.length}ä»¶ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) {
                return;
            }

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                const response = await fetch(`${baseUrl}/files/delete-multiple`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ paths: paths })
                });

                const data = await response.json();

                if (response.ok) {
                    const deletedCount = data.deleted.length;
                    const errorCount = data.errors.length;
                    let message = `âœ… ${deletedCount}ä»¶ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`;

                    if (errorCount > 0) {
                        message += `\n\nâš ï¸ ${errorCount}ä»¶ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ`;
                    }

                    alert(message);

                    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
                    const selectAllCheckbox = document.getElementById('selectAllFiles');
                    if (selectAllCheckbox) selectAllCheckbox.checked = false;

                    loadRecordedFiles();
                } else {
                    alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + (data.error || 'ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ'));
                }
            } catch (err) {
                console.error('Error deleting files:', err);
                alert('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // é¸æŠã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ZIPã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        async function downloadSelectedFiles() {
            const checkboxes = document.querySelectorAll('.file-checkbox:checked');
            const paths = Array.from(checkboxes).map(cb => cb.value);

            if (paths.length === 0) {
                alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                const response = await fetch(`${baseUrl}/files/download-zip`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ paths: paths })
                });

                if (response.ok) {
                    // Blobã¨ã—ã¦ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
                    const blob = await response.blob();

                    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ã®ãƒªãƒ³ã‚¯ã‚’ä½œæˆ
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;

                    // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—ï¼ˆContent-Dispositionãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ï¼‰
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = 'radiko_recordings.zip';
                    if (contentDisposition) {
                        const match = contentDisposition.match(/filename="?(.+)"?/);
                        if (match) filename = match[1];
                    }

                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();

                    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    const data = await response.json();
                    alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + (data.error || 'ZIPãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ'));
                }
            } catch (err) {
                console.error('Error downloading ZIP:', err);
                alert('âŒ ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // cronã‚¸ãƒ§ãƒ–ã‚’ç·¨é›†
        function editCronJob(index, jobData) {
            // jobDataã¯ãƒ‘ãƒ¼ã‚¹ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
            if (typeof jobData === 'string') {
                // æ—§å½¢å¼ã®å ´åˆã¯ãƒ‘ãƒ¼ã‚¹ã™ã‚‹
                const parts = jobData.trim().split(/\s+/);
                if (parts.length < 5) {
                    alert('ç„¡åŠ¹ãªcronå¼ã§ã™');
                    return;
                }
                jobData = {
                    raw: jobData,
                    minute: parts[0],
                    hour: parts[1],
                    dayOfWeek: parts[4],
                    command: parts.slice(5).join(' '),
                    title: '',
                    station: '',
                    startTime: '',
                    endTime: ''
                };
            }

            // ç•ªçµ„æƒ…å ±ã‚’è¡¨ç¤º
            document.getElementById('editProgramTitle').value = jobData.title || '';
            document.getElementById('editProgramStation').textContent = jobData.station ? `æ”¾é€å±€: ${jobData.station}` : '';

            // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã«å€¤ã‚’è¨­å®š
            document.getElementById('editMinute').value = jobData.minute;
            document.getElementById('editHour').value = jobData.hour;
            document.getElementById('editDayOfWeek').value = jobData.dayOfWeek;

            // éŒ²éŸ³æ™‚é–“ã‚’è¨­å®š
            if (jobData.startTime) {
                document.getElementById('editStartTime').value = `${jobData.startTime.slice(0,2)}:${jobData.startTime.slice(2,4)}`;
            }
            if (jobData.endTime) {
                document.getElementById('editEndTime').value = `${jobData.endTime.slice(0,2)}:${jobData.endTime.slice(2,4)}`;
            }

            currentEditingCron.original = jobData.raw;
            currentEditingCron.jobData = jobData;

            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
            updateCronPreview();

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            document.getElementById('cronEditModal').classList.add('active');
        }

        // cronãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
        function updateCronPreview() {
            const minute = document.getElementById('editMinute').value;
            const hour = document.getElementById('editHour').value;
            const dayOfWeek = document.getElementById('editDayOfWeek').value;
            const startTime = document.getElementById('editStartTime').value;
            const endTime = document.getElementById('editEndTime').value;

            const daysOfWeekJp = ['æ—¥æ›œæ—¥', 'æœˆæ›œæ—¥', 'ç«æ›œæ—¥', 'æ°´æ›œæ—¥', 'æœ¨æ›œæ—¥', 'é‡‘æ›œæ—¥', 'åœŸæ›œæ—¥'];

            let description = 'å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°: ';
            if (dayOfWeek !== '*') {
                description += `æ¯é€±${daysOfWeekJp[dayOfWeek]}ã® `;
            } else {
                description += 'æ¯æ—¥ ';
            }
            description += `${hour}:${String(minute).padStart(2, '0')}`;

            document.getElementById('cronPreview').textContent = description;

            // cronã‚³ãƒãƒ³ãƒ‰ã‚’å†æ§‹ç¯‰
            if (currentEditingCron.jobData) {
                const scriptPath = document.getElementById('scriptPath').value;
                const title = document.getElementById('editProgramTitle').value || '';
                const station = currentEditingCron.jobData.station || '';

                // æ™‚åˆ»ã‚’HHMMå½¢å¼ã«å¤‰æ›
                const startHHMM = startTime ? startTime.replace(':', '') : '';
                const endHHMM = endTime ? endTime.replace(':', '') : '';

                // éŒ²éŸ³é–‹å§‹æ™‚åˆ»ã¨cronå®Ÿè¡Œæ™‚åˆ»ã‚’æ¯”è¼ƒ
                // cronå®Ÿè¡Œæ™‚åˆ»ãŒéŒ²éŸ³é–‹å§‹æ™‚åˆ»ã‚ˆã‚Šæ—©ã„å ´åˆã€æ—¥ã‚’ã¾ãŸã„ã§ã„ã‚‹
                const startHour = startTime ? parseInt(startTime.split(':')[0]) : 0;
                const startMin = startTime ? parseInt(startTime.split(':')[1]) : 0;
                const cronExecHour = parseInt(hour);
                const cronExecMin = parseInt(minute);

                // æ™‚åˆ»ã‚’åˆ†å˜ä½ã«å¤‰æ›ã—ã¦æ¯”è¼ƒ
                const startMinutes = startHour * 60 + startMin;
                const cronExecMinutes = cronExecHour * 60 + cronExecMin;
                const needsYesterday = cronExecMinutes < startMinutes;

                // æ—¥ä»˜è¨ˆç®—ã®éƒ¨åˆ†
                let startDateCalc = '';
                if (needsYesterday) {
                    // cronå®Ÿè¡Œæ—¥ã®å‰æ—¥ã‚’éŒ²éŸ³é–‹å§‹æ—¥ã¨ã™ã‚‹
                    startDateCalc = '\`date -d yesterday +\\%Y\\%m\\%d\`';
                } else {
                    // cronå®Ÿè¡Œæ—¥ã¨åŒã˜æ—¥ã‚’éŒ²éŸ³é–‹å§‹æ—¥ã¨ã™ã‚‹
                    startDateCalc = '\`date +\\%Y\\%m\\%d\`';
                }

                const endDateCalc = '\`date +\\%Y\\%m\\%d\`';

                // cronã‚³ãƒãƒ³ãƒ‰ã‚’ç”Ÿæˆ
                const fullCommand = `${minute} ${hour} * * ${dayOfWeek} ${scriptPath} "${title}" "${station}" "${station}" "${startDateCalc}${startHHMM}" "${endDateCalc}${endHHMM}" "" "" "" >> /tmp/myradiko_output.log 2>&1`;
                document.getElementById('editCommandPreview').value = fullCommand;
            }
        }

        // cronç·¨é›†ã‚’ä¿å­˜
        async function saveCronEdit() {
            // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‹ã‚‰ç›´æ¥ã‚³ãƒãƒ³ãƒ‰ã‚’å–å¾—
            const newCronLine = document.getElementById('editCommandPreview').value.trim();

            if (!newCronLine) {
                alert('ã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // å¤ã„cronã‚’å‰Šé™¤ã—ã¦æ–°ã—ã„cronã‚’è¿½åŠ 
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                // å‰Šé™¤
                await fetch(`${baseUrl}/cron/remove`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ command: currentEditingCron.original })
                });

                // è¿½åŠ 
                const response = await fetch(`${baseUrl}/cron/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ command: newCronLine })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('âœ… äºˆç´„ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                    closeCronEditModal();
                    loadCronJobs();
                } else {
                    alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + (data.error || 'äºˆç´„ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ'));
                }
            } catch (err) {
                console.error('Error updating cron job:', err);
                alert('âŒ äºˆç´„ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // cronç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeCronEditModal() {
            document.getElementById('cronEditModal').classList.remove('active');
        }

        // cronãƒ­ã‚°ã‚’èª­ã¿è¾¼ã‚€
        async function loadCronLogs() {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';
            const logContent = document.getElementById('cronLogContent');

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
            document.getElementById('cronLogModal').classList.add('active');
            logContent.innerHTML = '<div style="text-align: center; color: #888;">èª­ã¿è¾¼ã¿ä¸­...</div>';

            try {
                const response = await fetch(`${baseUrl}/cron/logs`);
                if (!response.ok) {
                    logContent.innerHTML = '<div style="color: #ff6b6b;">ãƒ­ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
                    return;
                }

                const data = await response.json();
                const logs = data.logs || [];

                if (logs.length === 0) {
                    logContent.innerHTML = '<div style="color: #888;">ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                    return;
                }

                // ãƒ­ã‚°ã‚’æ•´å½¢ã—ã¦è¡¨ç¤º
                let html = '';
                logs.forEach(log => {
                    // ã‚¨ãƒ©ãƒ¼ã‚„è­¦å‘Šã‚’è‰²åˆ†ã‘
                    let color = '#d4d4d4';
                    if (log.toLowerCase().includes('error') || log.toLowerCase().includes('failed')) {
                        color = '#ff6b6b';
                    } else if (log.toLowerCase().includes('warn')) {
                        color = '#ffd43b';
                    } else if (log.toLowerCase().includes('success')) {
                        color = '#51cf66';
                    }

                    html += `<div style="color: ${color}; margin-bottom: 4px;">${escapeHtml(log)}</div>`;
                });

                logContent.innerHTML = html;
                // æœ€ä¸‹éƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                logContent.scrollTop = logContent.scrollHeight;

            } catch (err) {
                console.error('Error loading cron logs:', err);
                logContent.innerHTML = '<div style="color: #ff6b6b;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
            }
        }

        // cronãƒ­ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeCronLogModal() {
            document.getElementById('cronLogModal').classList.remove('active');
        }

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // æ™‚åˆ»ã®å…¥åŠ›ãŒå¤‰ã‚ã£ãŸã‚‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
        document.addEventListener('DOMContentLoaded', function() {
            const editInputs = ['editProgramTitle', 'editMinute', 'editHour', 'editDayOfWeek', 'editStartTime', 'editEndTime'];
            editInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', updateCronPreview);
                    element.addEventListener('change', updateCronPreview);
                }
            });
        });

        document.getElementById('modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        document.getElementById('cronEditModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCronEditModal();
            }
        });

        document.getElementById('cronLogModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCronLogModal();
            }
        });

        // atäºˆç´„ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
        async function loadAtJobs() {
            const atLoading = document.getElementById('atLoading');
            const atList = document.getElementById('atList');

            atLoading.style.display = 'block';
            atList.innerHTML = '';

            try {
                const proxyUrl = document.getElementById('proxyUrl').value;
                const baseUrl = proxyUrl.trim() || '';

                const response = await fetch(`${baseUrl}/at/list`);
                const data = await response.json();

                atLoading.style.display = 'none';

                if (!data.jobs || data.jobs.length === 0) {
                    atList.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d; font-size: 0.95em;">atäºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                    return;
                }

                // å„ã‚¸ãƒ§ãƒ–ã®è©³ç´°ã‚’å–å¾—ã—ã¦ç•ªçµ„åã‚’è¡¨ç¤º
                const jobsWithDetails = await Promise.all(data.jobs.map(async (job) => {
                    try {
                        const detailResponse = await fetch(`${baseUrl}/at/detail/${job.id}`);
                        const detailData = await detailResponse.json();

                        // ã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰ç•ªçµ„æƒ…å ±ã‚’æŠ½å‡º
                        let programTitle = 'Unknown';
                        let stationId = '';
                        let startTime = '';
                        let endTime = '';

                        if (detailData.command) {
                            // myradiko "ç•ªçµ„å" "å±€ID" "å±€ID" "é–‹å§‹æ™‚åˆ»" "çµ‚äº†æ™‚åˆ»" ... ã®å½¢å¼ã‹ã‚‰æŠ½å‡º
                            const match = detailData.command.match(/myradiko\s+"([^"]+)"\s+"([^"]+)"\s+"([^"]+)"\s+"(\d+)"\s+"(\d+)"/);
                            if (match) {
                                programTitle = match[1];
                                stationId = match[2];
                                const startStr = match[4]; // YYYYMMDDHHmm
                                const endStr = match[5];

                                // æ™‚åˆ»ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                                if (startStr.length === 12) {
                                    const year = startStr.substring(0, 4);
                                    const month = startStr.substring(4, 6);
                                    const day = startStr.substring(6, 8);
                                    const hour = startStr.substring(8, 10);
                                    const minute = startStr.substring(10, 12);
                                    startTime = `${year}/${month}/${day} ${hour}:${minute}`;
                                }
                                if (endStr.length === 12) {
                                    const hour = endStr.substring(8, 10);
                                    const minute = endStr.substring(10, 12);
                                    endTime = `${hour}:${minute}`;
                                }
                            }
                        }

                        return { ...job, title: programTitle, station: stationId, startTime, endTime };
                    } catch (err) {
                        console.error(`Failed to get detail for job ${job.id}:`, err);
                        return { ...job, title: 'Unknown', station: '', startTime: '', endTime: '' };
                    }
                }));

                let html = '<div style="display: grid; gap: 15px;">';

                jobsWithDetails.forEach(job => {
                    // å®Ÿè¡Œæ™‚åˆ»ã‚’æ•´å½¢ï¼ˆä¾‹: "2025/Oct/27 Mon 23:05:00" â†’ "2025/10/27 (æœˆ) 23:05"ï¼‰
                    let formattedDatetime = job.datetime;
                    try {
                        // atã‚³ãƒãƒ³ãƒ‰ã®æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: "2025/Oct/27 Mon 23:05:00"
                        const match = job.datetime.match(/(\d{4})\/(\w+)\/(\d+)\s+(\w+)\s+(\d+):(\d+):\d+/);

                        if (match) {
                            const year = match[1];
                            const monthName = match[2];
                            const day = match[3].padStart(2, '0');
                            const weekdayEng = match[4];
                            const hour = match[5].padStart(2, '0');
                            const minute = match[6].padStart(2, '0');

                            // æœˆåã‚’æ•°å­—ã«å¤‰æ›
                            const months = {
                                'Jan': '01', 'Feb': '02', 'Mar': '03', 'Apr': '04',
                                'May': '05', 'Jun': '06', 'Jul': '07', 'Aug': '08',
                                'Sep': '09', 'Oct': '10', 'Nov': '11', 'Dec': '12'
                            };
                            const month = months[monthName] || monthName;

                            // æ›œæ—¥ã‚’æ—¥æœ¬èªã«å¤‰æ›
                            const weekdays = {
                                'Sun': 'æ—¥', 'Mon': 'æœˆ', 'Tue': 'ç«', 'Wed': 'æ°´',
                                'Thu': 'æœ¨', 'Fri': 'é‡‘', 'Sat': 'åœŸ'
                            };
                            const weekday = weekdays[weekdayEng] || weekdayEng;

                            formattedDatetime = `${year}/${month}/${day} (${weekday}) ${hour}:${minute}`;
                        }
                    } catch (e) {
                        // ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ãŸå ´åˆã¯å…ƒã®æ–‡å­—åˆ—ã‚’ä½¿ç”¨
                        console.error('æ—¥æ™‚ã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—:', job.datetime, e);
                    }

                    html += `
                        <div style="border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #212529; margin-bottom: 8px; font-size: 1.05em;">
                                        ${job.title}
                                    </div>
                                    ${job.station ? `<div style="color: #495057; font-size: 0.9em; margin-bottom: 5px;">ğŸ“» ${job.station}</div>` : ''}
                                    ${job.startTime && job.endTime ? `<div style="color: #495057; font-size: 0.9em; margin-bottom: 5px;">ğŸ•’ ${job.startTime} - ${job.endTime}</div>` : ''}
                                    <div style="color: #6c757d; font-size: 0.85em; margin-bottom: 3px;">
                                        â±ï¸ Job #${job.id}
                                    </div>
                                    <div style="color: #6c757d; font-size: 0.85em;">
                                        å®Ÿè¡Œäºˆå®š: ${formattedDatetime}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button onclick='showAtJobDetail("${job.id}")'
                                            style="padding: 8px 14px; background: #667eea; color: white; border: none; border-radius: 6px; font-size: 0.85em; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                                            onmouseover="this.style.background='#5568d3'"
                                            onmouseout="this.style.background='#667eea'"
                                            title="è©³ç´°">
                                        è©³ç´°
                                    </button>
                                    <button onclick='editAtJob("${job.id}")'
                                            style="padding: 8px 14px; background: #4caf50; color: white; border: none; border-radius: 6px; font-size: 0.85em; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                                            onmouseover="this.style.background='#45a049'"
                                            onmouseout="this.style.background='#4caf50'"
                                            title="ç·¨é›†">
                                        ç·¨é›†
                                    </button>
                                    <button onclick='cancelAtJob("${job.id}")'
                                            style="padding: 8px 14px; background: #e57373; color: white; border: none; border-radius: 6px; font-size: 0.85em; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                                            onmouseover="this.style.background='#ef5350'"
                                            onmouseout="this.style.background='#e57373'"
                                            title="ã‚­ãƒ£ãƒ³ã‚»ãƒ«">
                                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                atList.innerHTML = html;

            } catch (err) {
                console.error('Error loading at jobs:', err);
                atLoading.style.display = 'none';
                atList.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 40px; font-size: 0.95em;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
            }
        }

        // atäºˆç´„ã®è©³ç´°ã‚’è¡¨ç¤º
        async function showAtJobDetail(jobId) {
            try {
                const proxyUrl = document.getElementById('proxyUrl').value;
                const baseUrl = proxyUrl.trim() || '';

                const response = await fetch(`${baseUrl}/at/detail/${jobId}`);
                const data = await response.json();

                if (response.ok) {
                    alert(`atäºˆç´„ #${jobId} ã®è©³ç´°\n\nã‚³ãƒãƒ³ãƒ‰:\n${data.command || 'ã‚³ãƒãƒ³ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'}`);
                } else {
                    alert(`ã‚¨ãƒ©ãƒ¼: ${data.error || 'Unknown error'}`);
                }
            } catch (err) {
                console.error('Error getting at job detail:', err);
                alert(`ã‚¨ãƒ©ãƒ¼: ${err.message}`);
            }
        }

        // atäºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        async function cancelAtJob(jobId) {
            if (!confirm(`atäºˆç´„ #${jobId} ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }

            try {
                const proxyUrl = document.getElementById('proxyUrl').value;
                const baseUrl = proxyUrl.trim() || '';

                const response = await fetch(`${baseUrl}/at/cancel/${jobId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok) {
                    alert(`âœ… ${data.message}`);
                    loadAtJobs(); // ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                } else {
                    alert(`âŒ ${data.error || 'Unknown error'}`);
                }
            } catch (err) {
                console.error('Error cancelling at job:', err);
                alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${err.message}`);
            }
        }

        // atäºˆç´„ã‚’ç·¨é›†
        async function editAtJob(jobId) {
            try {
                const proxyUrl = document.getElementById('proxyUrl').value;
                const baseUrl = proxyUrl.trim() || '';

                // atäºˆç´„ã®è©³ç´°ã‚’å–å¾—
                const response = await fetch(`${baseUrl}/at/detail/${jobId}`);
                const data = await response.json();

                if (!response.ok) {
                    alert(`ã‚¨ãƒ©ãƒ¼: ${data.error || 'Unknown error'}`);
                    return;
                }

                const command = data.command || '';
                const executeTime = data.time || ''; // atå®Ÿè¡Œæ™‚åˆ»

                console.log('å–å¾—ã—ãŸã‚³ãƒãƒ³ãƒ‰:', command);
                console.log('å®Ÿè¡Œæ™‚åˆ»:', executeTime);

                // ã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰æƒ…å ±ã‚’æŠ½å‡º
                // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: myradiko "ç•ªçµ„å" "å±€ID" "å±€ID" "é–‹å§‹æ™‚åˆ»" "çµ‚äº†æ™‚åˆ»" "" "" "" >> /tmp/...
                const match = command.match(/myradiko\s+"([^"]+)"\s+"([^"]+)"\s+"([^"]+)"\s+"(\d+)"\s+"(\d+)"/);

                if (!match) {
                    console.error('ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ãŸã‚³ãƒãƒ³ãƒ‰:', command);
                    alert('âŒ ã‚³ãƒãƒ³ãƒ‰ã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ\n\nã‚³ãƒãƒ³ãƒ‰å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\nã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è©³ç´°ã‚’å‡ºåŠ›ã—ã¾ã—ãŸã€‚');
                    return;
                }

                const title = match[1];
                const stationId = match[2];
                const startTimeStr = match[4]; // YYYYMMDDHHmm
                const endTimeStr = match[5];   // YYYYMMDDHHmm

                // éŒ²éŸ³é–‹å§‹æ™‚åˆ»ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                const startYear = startTimeStr.substring(0, 4);
                const startMonth = startTimeStr.substring(4, 6);
                const startDay = startTimeStr.substring(6, 8);
                const startHour = startTimeStr.substring(8, 10);
                const startMinute = startTimeStr.substring(10, 12);
                const startDatetime = `${startYear}-${startMonth}-${startDay}T${startHour}:${startMinute}`;

                // éŒ²éŸ³çµ‚äº†æ™‚åˆ»ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                const endYear = endTimeStr.substring(0, 4);
                const endMonth = endTimeStr.substring(4, 6);
                const endDay = endTimeStr.substring(6, 8);
                const endHour = endTimeStr.substring(8, 10);
                const endMinute = endTimeStr.substring(10, 12);
                const endDatetime = `${endYear}-${endMonth}-${endDay}T${endHour}:${endMinute}`;

                // ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚åˆ»ã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆä¾‹: "Fri Oct 27 23:50:00 2025"ï¼‰
                let executeDatetime = '';
                if (executeTime) {
                    try {
                        const execDate = new Date(executeTime);
                        const execYear = execDate.getFullYear();
                        const execMonth = String(execDate.getMonth() + 1).padStart(2, '0');
                        const execDay = String(execDate.getDate()).padStart(2, '0');
                        const execHour = String(execDate.getHours()).padStart(2, '0');
                        const execMinute = String(execDate.getMinutes()).padStart(2, '0');
                        executeDatetime = `${execYear}-${execMonth}-${execDay}T${execHour}:${execMinute}`;
                    } catch (e) {
                        console.error('å®Ÿè¡Œæ™‚åˆ»ã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—:', e);
                    }
                }

                // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
                document.getElementById('editAtJobId').value = jobId;
                document.getElementById('editAtTitle').value = title;
                document.getElementById('editAtExecuteTime').value = executeDatetime;
                document.getElementById('editAtStartTime').value = startDatetime;
                document.getElementById('editAtEndTime').value = endDatetime;

                // æ”¾é€å±€IDã‹ã‚‰é©åˆ‡ãªã‚¨ãƒªã‚¢ã‚’è¨­å®šï¼ˆæ±äº¬éƒ½ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
                document.getElementById('editAtArea').value = 'JP13';

                // æ”¾é€å±€ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚“ã§ã‹ã‚‰æ”¾é€å±€ã‚’è¨­å®š
                await updateEditAtStations();
                document.getElementById('editAtStation').value = stationId;

                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                document.getElementById('atEditModal').style.display = 'flex';

            } catch (err) {
                console.error('Error loading at job for edit:', err);
                alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${err.message}`);
            }
        }

        // atäºˆç´„ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeAtEditModal() {
            document.getElementById('atEditModal').style.display = 'none';
        }

        // atäºˆç´„ç·¨é›†ï¼šã‚¨ãƒªã‚¢å¤‰æ›´æ™‚ã«æ”¾é€å±€ä¸€è¦§ã‚’æ›´æ–°
        async function updateEditAtStations() {
            const areaId = document.getElementById('editAtArea').value;
            const stationSelect = document.getElementById('editAtStation');

            if (!areaId) {
                stationSelect.innerHTML = '<option value="">ã¾ãšã‚¨ãƒªã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
                return;
            }

            stationSelect.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ä¸­...</option>';

            try {
                const proxyUrl = document.getElementById('proxyUrl').value;
                const baseUrl = proxyUrl.trim() || '';
                const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');

                const response = await fetch(`${baseUrl}/api/programs/area/${areaId}/date/${today}`);
                const data = await response.json();

                if (!response.ok || !data.programs) {
                    stationSelect.innerHTML = '<option value="">ã‚¨ãƒ©ãƒ¼: æ”¾é€å±€ã‚’å–å¾—ã§ãã¾ã›ã‚“</option>';
                    return;
                }

                // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªæ”¾é€å±€ã‚’æŠ½å‡º
                const stations = {};
                data.programs.forEach(prog => {
                    if (prog.stationId && prog.stationName) {
                        stations[prog.stationId] = prog.stationName;
                    }
                });

                stationSelect.innerHTML = '<option value="">æ”¾é€å±€ã‚’é¸æŠ</option>';
                Object.keys(stations).sort().forEach(stationId => {
                    const option = document.createElement('option');
                    option.value = stationId;
                    option.textContent = `${stationId} - ${stations[stationId]}`;
                    stationSelect.appendChild(option);
                });

            } catch (err) {
                console.error('Error loading stations:', err);
                stationSelect.innerHTML = '<option value="">ã‚¨ãƒ©ãƒ¼: æ”¾é€å±€ã‚’å–å¾—ã§ãã¾ã›ã‚“</option>';
            }
        }

        // ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚åˆ»ã‚’ã€ŒéŒ²éŸ³çµ‚äº†+5åˆ†ã€ã«è¨­å®š
        function setExecuteTimeToEndPlus5() {
            const endDatetime = document.getElementById('editAtEndTime').value;

            if (!endDatetime) {
                alert('å…ˆã«éŒ²éŸ³çµ‚äº†æ—¥æ™‚ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const endDate = new Date(endDatetime);
            endDate.setMinutes(endDate.getMinutes() + 5);

            const year = endDate.getFullYear();
            const month = String(endDate.getMonth() + 1).padStart(2, '0');
            const day = String(endDate.getDate()).padStart(2, '0');
            const hour = String(endDate.getHours()).padStart(2, '0');
            const minute = String(endDate.getMinutes()).padStart(2, '0');

            document.getElementById('editAtExecuteTime').value = `${year}-${month}-${day}T${hour}:${minute}`;
        }

        // atäºˆç´„ã®ç·¨é›†ã‚’ä¿å­˜
        async function saveAtEdit() {
            const jobId = document.getElementById('editAtJobId').value;
            const title = document.getElementById('editAtTitle').value.trim();
            const stationId = document.getElementById('editAtStation').value;
            const executeTime = document.getElementById('editAtExecuteTime').value;
            const startDatetime = document.getElementById('editAtStartTime').value;
            const endDatetime = document.getElementById('editAtEndTime').value;

            if (!title || !stationId || !executeTime || !startDatetime || !endDatetime) {
                alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (!confirm('æ—¢å­˜ã®atäºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦ã€æ–°ã—ã„å†…å®¹ã§å†ç™»éŒ²ã—ã¾ã™ã€‚\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                return;
            }

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                // 1. æ—¢å­˜ã®atäºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                const cancelResponse = await fetch(`${baseUrl}/at/cancel/${jobId}`, {
                    method: 'DELETE'
                });

                if (!cancelResponse.ok) {
                    const cancelData = await cancelResponse.json();
                    throw new Error(`ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¤±æ•—: ${cancelData.error || 'Unknown error'}`);
                }

                // 2. æ–°ã—ã„å†…å®¹ã§å†ç™»éŒ²
                // å„æ™‚åˆ»ã‚’YYYYMMDDHHmmå½¢å¼ã«å¤‰æ›
                const execDate = new Date(executeTime);
                const executeStr = `${execDate.getFullYear()}${String(execDate.getMonth() + 1).padStart(2, '0')}${String(execDate.getDate()).padStart(2, '0')}${String(execDate.getHours()).padStart(2, '0')}${String(execDate.getMinutes()).padStart(2, '0')}`;

                const startDate = new Date(startDatetime);
                const startStr = `${startDate.getFullYear()}${String(startDate.getMonth() + 1).padStart(2, '0')}${String(startDate.getDate()).padStart(2, '0')}${String(startDate.getHours()).padStart(2, '0')}${String(startDate.getMinutes()).padStart(2, '0')}`;

                const endDate = new Date(endDatetime);
                const endStr = `${endDate.getFullYear()}${String(endDate.getMonth() + 1).padStart(2, '0')}${String(endDate.getDate()).padStart(2, '0')}${String(endDate.getHours()).padStart(2, '0')}${String(endDate.getMinutes()).padStart(2, '0')}`;

                // ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ‘ã‚¹ã‚’å–å¾—
                const scriptPath = document.getElementById('scriptPath').value;

                const scheduleResponse = await fetch(`${baseUrl}/schedule-at`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        script_path: scriptPath,
                        title: title,
                        station_id: stationId,
                        execute_time: executeStr,
                        start_time: startStr,
                        end_time: endStr
                    })
                });

                const scheduleData = await scheduleResponse.json();

                if (scheduleResponse.ok) {
                    alert(`âœ… atäºˆç´„ã‚’æ›´æ–°ã—ã¾ã—ãŸ\n\nå®Ÿè¡Œæ™‚åˆ»: ${executeTime.replace('T', ' ')}\néŒ²éŸ³é–‹å§‹: ${startDatetime.replace('T', ' ')}\néŒ²éŸ³çµ‚äº†: ${endDatetime.replace('T', ' ')}`);
                    closeAtEditModal();
                    loadAtJobs(); // ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                } else {
                    alert(`âŒ å†ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ\n\n${scheduleData.error || 'Unknown error'}\n\nâ€»æ—¢å­˜ã®äºˆç´„ã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¦ã„ã¾ã™`);
                }

            } catch (err) {
                console.error('Error saving at job edit:', err);
                alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${err.message}`);
            }
        }

        // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†ç”Ÿ
        // ç¾åœ¨å†ç”Ÿä¸­ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ï¼ˆãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ç”¨ï¼‰
        let currentAudioFilePath = '';

        function playAudio(filepath, filename) {
            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            // ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ä¿å­˜
            currentAudioFilePath = filepath;

            // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚½ãƒ¼ã‚¹ã‚’è¨­å®š
            const audioPlayer = document.getElementById('audioPlayer');
            const audioSource = document.getElementById('audioSource');
            const streamUrl = `${baseUrl}/stream/${filepath}`;

            // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¡¨ç¤º
            document.getElementById('audioFileName').textContent = filename;
            document.getElementById('audioPlayerTitle').textContent = 'ğŸµ ' + filename;

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            document.getElementById('audioPlayerModal').classList.add('active');

            // ã‚½ãƒ¼ã‚¹ã‚’è¨­å®šã—ã¦èª­ã¿è¾¼ã¿
            audioSource.src = streamUrl;
            audioPlayer.load();

            // loadãŒå®Œäº†ã—ãŸã‚‰è‡ªå‹•å†ç”Ÿ
            audioPlayer.addEventListener('canplay', function playWhenReady() {
                audioPlayer.play().catch(err => {
                    console.error('Auto-play failed:', err);
                    // è‡ªå‹•å†ç”ŸãŒå¤±æ•—ã—ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ã¯è¡¨ç¤ºã—ãªã„ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§å†ç”Ÿã§ãã‚‹ï¼‰
                });
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ï¼ˆä¸€åº¦ã ã‘å®Ÿè¡Œï¼‰
                audioPlayer.removeEventListener('canplay', playWhenReady);
            }, { once: true });
        }

        // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é–‰ã˜ã‚‹
        function closeAudioPlayer() {
            const audioPlayer = document.getElementById('audioPlayer');

            // é–‰ã˜ã‚‹å‰ã«æœ€å¾Œã®ä½ç½®ã‚’è‡ªå‹•ä¿å­˜
            if (currentAudioFilePath && audioPlayer.currentTime > 3) {
                const duration = audioPlayer.duration;
                // æœ€å¾Œã¾ã§å†ç”Ÿã—ã¦ã„ãªã‘ã‚Œã°ä¿å­˜
                if (!isNaN(duration) && duration - audioPlayer.currentTime > 3) {
                    localStorage.setItem(`bookmark_${currentAudioFilePath}`, audioPlayer.currentTime.toString());
                } else if (!isNaN(duration) && duration - audioPlayer.currentTime < 3) {
                    // æœ€å¾Œã¾ã§å†ç”Ÿã—ãŸå ´åˆã¯å‰Šé™¤
                    localStorage.removeItem(`bookmark_${currentAudioFilePath}`);
                }
            }

            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            document.getElementById('audioPlayerModal').classList.remove('active');
            // å†ç”Ÿé€Ÿåº¦ã‚’ãƒªã‚»ãƒƒãƒˆ
            setPlaybackRate(1.0);
        }

        // å†ç”Ÿé€Ÿåº¦ã‚’å¤‰æ›´
        function changePlaybackRate(rate) {
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.playbackRate = parseFloat(rate);
            document.getElementById('playbackRateValue').textContent = parseFloat(rate).toFixed(1) + 'x';
            document.getElementById('playbackRate').value = rate;
        }

        // å†ç”Ÿé€Ÿåº¦ã‚’ãƒ—ãƒªã‚»ãƒƒãƒˆå€¤ã«è¨­å®š
        function setPlaybackRate(rate) {
            changePlaybackRate(rate);
        }

        // å†ç”Ÿä½ç½®ã‚’æ›´æ–°ï¼ˆè‡ªå‹•ä¿å­˜ç”¨ï¼‰
        function updatePlaybackPosition() {
            if (!currentAudioFilePath) return;

            const audioPlayer = document.getElementById('audioPlayer');
            const currentTime = audioPlayer.currentTime;
            const duration = audioPlayer.duration;

            // å†ç”Ÿä¸­ã¯å¸¸ã«ä½ç½®ã‚’è‡ªå‹•ä¿å­˜ï¼ˆé–‹å§‹3ç§’å¾Œã‹ã‚‰ï¼‰
            if (currentTime > 3 && !isNaN(duration)) {
                localStorage.setItem(`bookmark_${currentAudioFilePath}`, currentTime.toString());

                // æœ€å¾Œã¾ã§å†ç”Ÿã—ãŸå ´åˆã¯ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚’å‰Šé™¤
                if (duration - currentTime < 3) {
                    localStorage.removeItem(`bookmark_${currentAudioFilePath}`);
                }
            }
        }

        // ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚’èª­ã¿è¾¼ã¿
        function loadBookmark() {
            if (!currentAudioFilePath) return;

            const savedTime = localStorage.getItem(`bookmark_${currentAudioFilePath}`);
            const bookmarkInfo = document.getElementById('bookmarkInfo');

            if (savedTime) {
                const audioPlayer = document.getElementById('audioPlayer');
                const time = parseFloat(savedTime);

                // ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯æƒ…å ±ã‚’è¡¨ç¤º
                const minutes = Math.floor(time / 60);
                const seconds = Math.floor(time % 60);
                document.getElementById('bookmarkTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                bookmarkInfo.style.display = 'block';

                // å†ç”Ÿä½ç½®ã‚’å¾©å…ƒ
                audioPlayer.currentTime = time;
            } else {
                bookmarkInfo.style.display = 'none';
            }
        }

        // ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚’æ‰‹å‹•ä¿å­˜
        function saveBookmark() {
            if (!currentAudioFilePath) return;

            const audioPlayer = document.getElementById('audioPlayer');
            const currentTime = audioPlayer.currentTime;

            localStorage.setItem(`bookmark_${currentAudioFilePath}`, currentTime.toString());

            const minutes = Math.floor(currentTime / 60);
            const seconds = Math.floor(currentTime % 60);

            alert(`ğŸ“ å†ç”Ÿä½ç½®ã‚’è¨˜æ†¶ã—ã¾ã—ãŸ (${minutes}:${seconds.toString().padStart(2, '0')})`);
        }

        // ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚’å‰Šé™¤
        function clearBookmark() {
            if (!currentAudioFilePath) return;

            localStorage.removeItem(`bookmark_${currentAudioFilePath}`);
            document.getElementById('bookmarkInfo').style.display = 'none';

            alert('ğŸ—‘ï¸ è¨˜æ†¶ã—ãŸä½ç½®ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }

        // ã™ã¹ã¦ã®å†ç”Ÿå±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ
        function clearAllBookmarks() {
            if (!confirm('ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å†ç”Ÿå±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                return;
            }

            // localStorageå†…ã®ã™ã¹ã¦ã®bookmark_ã§å§‹ã¾ã‚‹ã‚­ãƒ¼ã‚’å‰Šé™¤
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('bookmark_')) {
                    keysToRemove.push(key);
                }
            }

            keysToRemove.forEach(key => localStorage.removeItem(key));

            alert(`ğŸ—‘ï¸ ${keysToRemove.length}ä»¶ã®å†ç”Ÿå±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ`);

            // ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’å†æç”»
            renderFilesList();
        }

        // è©³ç´°è¨­å®šã®è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function toggleAdvancedSettings() {
            const advancedSettings = document.getElementById('advancedSettings');
            const toggleText = document.getElementById('advancedToggleText');

            if (advancedSettings.style.display === 'none') {
                advancedSettings.style.display = 'block';
                toggleText.textContent = 'è©³ç´°è¨­å®šã‚’éè¡¨ç¤º';
                localStorage.setItem('advancedSettingsOpen', 'true');
            } else {
                advancedSettings.style.display = 'none';
                toggleText.textContent = 'è©³ç´°è¨­å®šã‚’è¡¨ç¤º';
                localStorage.setItem('advancedSettingsOpen', 'false');
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æœ¬æ—¥ã®æ—¥ä»˜ã‚’è¨­å®š
            const today = new Date();
            const dateStr = today.toISOString().slice(0, 10);
            document.getElementById('targetDate').value = dateStr;
        });

        // ==================== ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ©Ÿèƒ½ ====================

        const ADMIN_PASSWORD = 'Pal_s1008467';
        let isAdminAuthenticated = false;

        // ç®¡ç†è€…èªè¨¼
        function authenticateAdmin() {
            const password = document.getElementById('adminPassword').value;

            if (password === ADMIN_PASSWORD) {
                isAdminAuthenticated = true;
                document.getElementById('adminAuth').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                document.getElementById('adminPassword').value = '';

                // æ—¥æ™‚å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®åˆ¶é™ã‚’è¨­å®š
                initManualDateTimeLimits();
            } else {
                alert('âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                document.getElementById('adminPassword').value = '';
            }
        }

        // ç®¡ç†è€…ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        function logoutAdmin() {
            isAdminAuthenticated = false;
            document.getElementById('adminAuth').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
        }

        // DBç•ªçµ„è¡¨ä¸€æ‹¬æ›´æ–°
        function updateAllPrograms() {
            if (!confirm('å…¨ã‚¨ãƒªã‚¢ã®ç•ªçµ„è¡¨ã‚’æ›´æ–°ã—ã¾ã™ã€‚\nå‡¦ç†ã«ã¯æ•°åˆ†ã€œåæ•°åˆ†ã‹ã‹ã‚Šã¾ã™ã€‚\nå®Ÿè¡Œã—ã¾ã™ã‹?')) {
                return;
            }

            const days = document.getElementById('updateDays').value;
            const updateLog = document.getElementById('updateLog');
            const updateProgress = document.getElementById('updateProgress');

            updateProgress.style.display = 'block';
            updateLog.innerHTML = '<span style="color: #17a2b8;">ğŸ”„ æ›´æ–°å‡¦ç†ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...</span>\n';

            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼è¦ç´ 
            const progressBar = document.getElementById('updateProgressBar');
            const progressText = document.getElementById('updateProgressText');
            const progressPercent = document.getElementById('updateProgressPercent');
            const progressDetail = document.getElementById('updateProgressDetail');
            const progressBarText = document.getElementById('updateProgressBarText');

            // çµ±è¨ˆã‚«ã‚¦ãƒ³ã‚¿ãƒ¼è¦ç´ 
            const successCount = document.getElementById('updateSuccessCount');
            const errorCount = document.getElementById('updateErrorCount');
            const warningCount = document.getElementById('updateWarningCount');

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            // Server-Sent Events (SSE) ã§é€²æ—ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å—ä¿¡
            const eventSource = new EventSource(`${baseUrl}/admin/update-programs-stream?days=${days}`);

            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);

                    switch(data.type) {
                        case 'start':
                            updateLog.innerHTML += `<span style="color: #17a2b8;">ğŸ“¡ ${data.message}</span>\n`;
                            progressText.textContent = 'æ›´æ–°é–‹å§‹';
                            progressDetail.textContent = data.message;
                            break;

                        case 'info':
                            updateLog.innerHTML += `<span style="color: #17a2b8;">â„¹ï¸ ${data.message}</span>\n`;
                            progressDetail.textContent = data.message;
                            break;

                        case 'progress':
                            updateLog.innerHTML += `\n<span style="color: #6c757d; font-weight: bold;">[${data.current}/${data.total}] ${data.area} ã‚’å‡¦ç†ä¸­...</span>\n`;
                            progressText.textContent = `${data.area} ã‚’å‡¦ç†ä¸­...`;
                            progressDetail.textContent = `ã‚¨ãƒªã‚¢ ${data.current}/${data.total} ã‚’å‡¦ç†ä¸­`;
                            break;

                        case 'success':
                            updateLog.innerHTML += `  <span style="color: #28a745;">âœ… ${data.area} ${data.date}: ${data.programs}ä»¶</span>\n`;
                            updateLog.scrollTop = updateLog.scrollHeight;
                            break;

                        case 'warning':
                            updateLog.innerHTML += `  <span style="color: #ffc107;">âš ï¸ ${data.area} ${data.date}: ${data.message}</span>\n`;
                            break;

                        case 'error':
                            updateLog.innerHTML += `  <span style="color: #dc3545;">âŒ ${data.area} ${data.date}: ${data.message}</span>\n`;
                            break;

                        case 'percent':
                            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’æ›´æ–°
                            progressBar.style.width = `${data.percent}%`;
                            progressPercent.textContent = `${data.percent}%`;
                            progressBarText.textContent = `${data.completed}/${data.total}`;
                            progressDetail.textContent = `${data.completed}/${data.total} ä»¶å®Œäº†`;

                            // çµ±è¨ˆã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’æ›´æ–°
                            successCount.textContent = data.success || 0;
                            errorCount.textContent = data.error || 0;
                            warningCount.textContent = data.warning || 0;

                            updateLog.scrollTop = updateLog.scrollHeight;
                            break;

                        case 'complete':
                            // å®Œäº†æ™‚ã¯100%
                            progressBar.style.width = '100%';
                            progressBar.style.background = 'linear-gradient(90deg, #28a745, #1e7e34)';
                            progressPercent.textContent = '100%';
                            progressText.textContent = 'âœ… å®Œäº†';
                            progressBarText.textContent = 'å®Œäº†';
                            progressDetail.textContent = `ç·ç•ªçµ„æ•°: ${data.total_programs}ä»¶`;

                            // æœ€çµ‚çµ±è¨ˆã‚’æ›´æ–°
                            successCount.textContent = data.success || 0;
                            errorCount.textContent = data.error || 0;
                            warningCount.textContent = data.warning || 0;

                            updateLog.innerHTML += `\n<span style="color: #28a745; font-weight: bold;">âœ… ${data.message}</span>\n`;
                            updateLog.innerHTML += `<span style="color: #17a2b8;">ğŸ“Š ç·ç•ªçµ„æ•°: ${data.total_programs}ä»¶</span>\n`;
                            updateLog.innerHTML += `<span style="color: #28a745;">âœ… æˆåŠŸ: ${data.success}ä»¶</span> / `;
                            updateLog.innerHTML += `<span style="color: #dc3545;">âŒ ã‚¨ãƒ©ãƒ¼: ${data.error}ä»¶</span> / `;
                            updateLog.innerHTML += `<span style="color: #ffc107;">âš ï¸ è­¦å‘Š: ${data.warning}ä»¶</span>\n`;
                            eventSource.close();
                            break;
                    }
                } catch (err) {
                    console.error('Parse error:', err);
                }
            };

            eventSource.onerror = function(err) {
                console.error('EventSource error:', err);
                updateLog.innerHTML += `\nâŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ\n`;
                eventSource.close();
            };
        }

        // ã‚¨ãƒªã‚¢é¸æŠæ™‚ã«æ”¾é€å±€ãƒªã‚¹ãƒˆã‚’æ›´æ–°
        async function updateManualStations() {
            const areaId = document.getElementById('manualArea').value;
            const stationSelect = document.getElementById('manualStation');

            if (!areaId) {
                stationSelect.innerHTML = '<option value="">ã¾ãšã‚¨ãƒªã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
                return;
            }

            stationSelect.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ä¸­...</option>';

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                // ä»Šæ—¥ã®æ—¥ä»˜ã§ç•ªçµ„è¡¨ã‚’å–å¾—
                const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const response = await fetch(`${baseUrl}/api/programs/area/${areaId}/date/${today}`);
                const data = await response.json();

                if (response.ok && data.programs) {
                    // å±€IDã‚’ãƒ¦ãƒ‹ãƒ¼ã‚¯ã«æŠ½å‡º
                    const stations = {};
                    data.programs.forEach(prog => {
                        if (prog.stationId && prog.stationName) {
                            stations[prog.stationId] = prog.stationName;
                        }
                    });

                    // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
                    stationSelect.innerHTML = '<option value="">æ”¾é€å±€ã‚’é¸æŠ</option>';
                    Object.keys(stations).sort().forEach(stationId => {
                        const option = document.createElement('option');
                        option.value = stationId;
                        option.textContent = `${stationId} - ${stations[stationId]}`;
                        stationSelect.appendChild(option);
                    });
                } else {
                    stationSelect.innerHTML = '<option value="">æ”¾é€å±€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</option>';
                }
            } catch (err) {
                console.error('Station list error:', err);
                stationSelect.innerHTML = '<option value="">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</option>';
            }
        }

        // æ—¥æ™‚å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®åˆ¶é™ã‚’è¨­å®šï¼ˆ1é€±é–“å‰ã¾ã§ï¼‰
        function initManualDateTimeLimits() {
            const now = new Date();
            const oneWeekAgo = new Date(now);
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

            // ISOå½¢å¼ã«å¤‰æ›ï¼ˆYYYY-MM-DDTHH:mmï¼‰
            const minDateTime = oneWeekAgo.toISOString().slice(0, 16);

            document.getElementById('manualStart').min = minDateTime;
            document.getElementById('manualEnd').min = minDateTime;
        }

        // æ‰‹å‹•ã‚³ãƒãƒ³ãƒ‰ã®ã‚³ãƒ”ãƒ¼
        function copyManualCommand() {
            const title = document.getElementById('manualTitle').value.trim();
            const station = document.getElementById('manualStation').value;
            const startDatetime = document.getElementById('manualStart').value;
            const endDatetime = document.getElementById('manualEnd').value;

            if (!title || !station || !startDatetime || !endDatetime) {
                alert('ç•ªçµ„åã€æ”¾é€å±€ã€éŒ²éŸ³é–‹å§‹æ—¥æ™‚ã€éŒ²éŸ³çµ‚äº†æ—¥æ™‚ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // datetime-localå½¢å¼ã‚’YYYYMMDDHHmmå½¢å¼ã«å¤‰æ›
            const startDate = new Date(startDatetime);
            const endDate = new Date(endDatetime);

            const startStr = `${startDate.getFullYear()}${String(startDate.getMonth() + 1).padStart(2, '0')}${String(startDate.getDate()).padStart(2, '0')}${String(startDate.getHours()).padStart(2, '0')}${String(startDate.getMinutes()).padStart(2, '0')}`;
            const endStr = `${endDate.getFullYear()}${String(endDate.getMonth() + 1).padStart(2, '0')}${String(endDate.getDate()).padStart(2, '0')}${String(endDate.getHours()).padStart(2, '0')}${String(endDate.getMinutes()).padStart(2, '0')}`;

            const scriptPath = document.getElementById('scriptPath').value;
            const command = `${scriptPath} "${title}" "${station}" "${station}" "${startStr}" "${endStr}" "" "" "" >> /tmp/myradiko_output.log 2>&1`;

            // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
            navigator.clipboard.writeText(command).then(() => {
                // ã‚³ãƒãƒ³ãƒ‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
                const preview = document.getElementById('manualCommandPreview');
                preview.textContent = command;
                preview.style.display = 'block';

                alert('âœ… ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }).catch(err => {
                alert('âŒ ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
            });
        }

        // æ‰‹å‹•ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œï¼ˆå³åº§ã«å®Ÿè¡Œï¼‰
        async function executeManualCommand() {
            const title = document.getElementById('manualTitle').value.trim();
            const station = document.getElementById('manualStation').value;
            const startDatetime = document.getElementById('manualStart').value;
            const endDatetime = document.getElementById('manualEnd').value;

            if (!title || !station || !startDatetime || !endDatetime) {
                alert('ç•ªçµ„åã€æ”¾é€å±€ã€éŒ²éŸ³é–‹å§‹æ—¥æ™‚ã€éŒ²éŸ³çµ‚äº†æ—¥æ™‚ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // datetime-localå½¢å¼ã‚’YYYYMMDDHHmmå½¢å¼ã«å¤‰æ›
            const startDate = new Date(startDatetime);
            const endDate = new Date(endDatetime);

            const startStr = `${startDate.getFullYear()}${String(startDate.getMonth() + 1).padStart(2, '0')}${String(startDate.getDate()).padStart(2, '0')}${String(startDate.getHours()).padStart(2, '0')}${String(startDate.getMinutes()).padStart(2, '0')}`;
            const endStr = `${endDate.getFullYear()}${String(endDate.getMonth() + 1).padStart(2, '0')}${String(endDate.getDate()).padStart(2, '0')}${String(endDate.getHours()).padStart(2, '0')}${String(endDate.getMinutes()).padStart(2, '0')}`;

            if (!confirm(`ä»¥ä¸‹ã®éŒ²éŸ³ã‚’å³åº§ã«å®Ÿè¡Œã—ã¾ã™:\n\nç•ªçµ„å: ${title}\nå±€ID: ${station}\né–‹å§‹: ${startDatetime.replace('T', ' ')}\nçµ‚äº†: ${endDatetime.replace('T', ' ')}\n\nã‚ˆã‚ã—ã„ã§ã™ã‹?`)) {
                return;
            }

            const manualOutput = document.getElementById('manualOutput');
            const manualLog = document.getElementById('manualLog');

            manualOutput.style.display = 'block';
            manualLog.textContent = 'â–¶ï¸ ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œä¸­...\n';

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';
            const scriptPath = document.getElementById('scriptPath').value;

            try {
                const response = await fetch(`${baseUrl}/admin/execute-manual`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        script_path: scriptPath,
                        title: title,
                        station_id: station,
                        start_time: startStr,
                        end_time: endStr
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    manualLog.textContent += `âœ… å®Ÿè¡Œå®Œäº†\n\n${data.output || ''}`;
                } else {
                    manualLog.textContent += `âŒ ã‚¨ãƒ©ãƒ¼: ${data.error}\n`;
                }
            } catch (err) {
                manualLog.textContent += `âŒ ã‚¨ãƒ©ãƒ¼: ${err.message}\n`;
            }
        }

        // æ‰‹å‹•ã‚³ãƒãƒ³ãƒ‰ã®atäºˆç´„å®Ÿè¡Œ
        async function scheduleManualCommand() {
            const title = document.getElementById('manualTitle').value.trim();
            const station = document.getElementById('manualStation').value;
            const executeTime = document.getElementById('manualExecuteTime').value;
            const startDatetime = document.getElementById('manualStart').value;
            const endDatetime = document.getElementById('manualEnd').value;

            if (!title || !station || !executeTime || !startDatetime || !endDatetime) {
                alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // datetime-localå½¢å¼ã‚’YYYYMMDDHHmmå½¢å¼ã«å¤‰æ›
            const executeDate = new Date(executeTime);
            const startDate = new Date(startDatetime);
            const endDate = new Date(endDatetime);

            const executeStr = `${executeDate.getFullYear()}${String(executeDate.getMonth() + 1).padStart(2, '0')}${String(executeDate.getDate()).padStart(2, '0')}${String(executeDate.getHours()).padStart(2, '0')}${String(executeDate.getMinutes()).padStart(2, '0')}`;
            const startStr = `${startDate.getFullYear()}${String(startDate.getMonth() + 1).padStart(2, '0')}${String(startDate.getDate()).padStart(2, '0')}${String(startDate.getHours()).padStart(2, '0')}${String(startDate.getMinutes()).padStart(2, '0')}`;
            const endStr = `${endDate.getFullYear()}${String(endDate.getMonth() + 1).padStart(2, '0')}${String(endDate.getDate()).padStart(2, '0')}${String(endDate.getHours()).padStart(2, '0')}${String(endDate.getMinutes()).padStart(2, '0')}`;

            if (!confirm(`ä»¥ä¸‹ã®éŒ²éŸ³ã‚’atäºˆç´„ã—ã¾ã™:\n\nå®Ÿè¡Œæ™‚åˆ»: ${executeTime.replace('T', ' ')}\nç•ªçµ„å: ${title}\nå±€ID: ${station}\néŒ²éŸ³é–‹å§‹: ${startDatetime.replace('T', ' ')}\néŒ²éŸ³çµ‚äº†: ${endDatetime.replace('T', ' ')}\n\nã‚ˆã‚ã—ã„ã§ã™ã‹?`)) {
                return;
            }

            const manualOutput = document.getElementById('manualOutput');
            const manualLog = document.getElementById('manualLog');

            manualOutput.style.display = 'block';
            manualLog.textContent = 'â° atäºˆç´„ã‚’ç™»éŒ²ä¸­...\n';

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';
            const scriptPath = document.getElementById('scriptPath').value;

            try {
                const response = await fetch(`${baseUrl}/schedule-at`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        script_path: scriptPath,
                        title: title,
                        station_id: station,
                        execute_time: executeStr,
                        start_time: startStr,
                        end_time: endStr
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    manualLog.textContent += `âœ… atäºˆç´„å®Œäº†\n\n${data.at_command || ''}\n\nJob ID: ${data.job_id || 'N/A'}`;
                } else {
                    manualLog.textContent += `âŒ ã‚¨ãƒ©ãƒ¼: ${data.error}\n`;
                }
            } catch (err) {
                manualLog.textContent += `âŒ ã‚¨ãƒ©ãƒ¼: ${err.message}\n`;
            }
        }

        // å¤ã„DBãƒ‡ãƒ¼ã‚¿å‰Šé™¤
        async function cleanupOldData() {
            if (!confirm('15æ—¥ä»¥å‰ã®ç•ªçµ„ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\nã‚ˆã‚ã—ã„ã§ã™ã‹?')) {
                return;
            }

            const maintenanceOutput = document.getElementById('maintenanceOutput');
            const maintenanceLog = document.getElementById('maintenanceLog');

            maintenanceOutput.style.display = 'block';
            maintenanceLog.textContent = 'ğŸ—‘ï¸ å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ä¸­...\n';

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                const response = await fetch(`${baseUrl}/admin/cleanup`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    maintenanceLog.textContent += `âœ… ${data.message}\n`;
                    maintenanceLog.textContent += `å‰Šé™¤ä»¶æ•°: ${data.deleted || 0}ä»¶\n`;
                } else {
                    maintenanceLog.textContent += `âŒ ã‚¨ãƒ©ãƒ¼: ${data.error}\n`;
                }
            } catch (err) {
                maintenanceLog.textContent += `âŒ ã‚¨ãƒ©ãƒ¼: ${err.message}\n`;
            }
        }

        // ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ç¢ºèª
        async function checkDiskSpace() {
            const maintenanceOutput = document.getElementById('maintenanceOutput');
            const maintenanceLog = document.getElementById('maintenanceLog');

            maintenanceOutput.style.display = 'block';
            maintenanceLog.textContent = 'ğŸ’¾ ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ã‚’ç¢ºèªä¸­...\n';

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                const response = await fetch(`${baseUrl}/admin/disk-space`);
                const data = await response.json();

                if (response.ok) {
                    maintenanceLog.textContent += `âœ… ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡æƒ…å ±\n\n`;
                    maintenanceLog.textContent += data.info || '';
                } else {
                    maintenanceLog.textContent += `âŒ ã‚¨ãƒ©ãƒ¼: ${data.error}\n`;
                }
            } catch (err) {
                maintenanceLog.textContent += `âŒ ã‚¨ãƒ©ãƒ¼: ${err.message}\n`;
            }
        }

        // DBçµ±è¨ˆæƒ…å ±
        async function viewDbStatus() {
            const maintenanceOutput = document.getElementById('maintenanceOutput');
            const maintenanceLog = document.getElementById('maintenanceLog');

            maintenanceOutput.style.display = 'block';
            maintenanceLog.textContent = 'ğŸ“ˆ DBçµ±è¨ˆæƒ…å ±ã‚’å–å¾—ä¸­...\n';

            const proxyUrl = document.getElementById('proxyUrl').value;
            const baseUrl = proxyUrl.trim() || '';

            try {
                const response = await fetch(`${baseUrl}/admin/db-status`);
                const data = await response.json();

                if (response.ok) {
                    maintenanceLog.textContent += `âœ… DBçµ±è¨ˆæƒ…å ±\n\n`;
                    maintenanceLog.textContent += `ç·ç•ªçµ„æ•°: ${data.total_programs || 0}ä»¶\n`;
                    maintenanceLog.textContent += `æ›´æ–°å±¥æ­´: ${data.total_updates || 0}ä»¶\n`;
                    maintenanceLog.textContent += `DBå®¹é‡: ${data.db_size || '-'}\n`;
                } else {
                    maintenanceLog.textContent += `âŒ ã‚¨ãƒ©ãƒ¼: ${data.error}\n`;
                }
            } catch (err) {
                maintenanceLog.textContent += `âŒ ã‚¨ãƒ©ãƒ¼: ${err.message}\n`;
            }
        }
    </script>
</body>
</html>
